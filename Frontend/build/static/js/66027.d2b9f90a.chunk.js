"use strict";(self.webpackChunknorthwind=self.webpackChunknorthwind||[]).push([[66027],{18277:(e,t,r)=>{r.d(t,{$6:()=>g,$z:()=>s,F7:()=>n,Ow:()=>l,S0:()=>a,d1:()=>u,dm:()=>d,ir:()=>o});const i=[["binary","application/octet-stream","bin",""]];function n(e,t){var r;return null!=h(t.name,null!==(r=null===e||void 0===e?void 0:e.supportedFormats)&&void 0!==r?r:[])}function s(e,t){var r;if(!e)return!1;const i=d(t,null!==(r=e.supportedFormats)&&void 0!==r?r:[]);return null!=i&&e.editFormats.includes(i)}function o(e){var t;return c(null!==(t=null===e||void 0===e?void 0:e.supportedFormats)&&void 0!==t?t:[]).flatMap(m).map((e=>".".concat(e)))}function a(e,t){return v(function(e,t){const r=e.toLowerCase();return c(t).find((e=>p(e)===r))}(e,t))}function l(e,t){return v(h(e,t))}function u(e,t){return p(function(e,t){return c(t).find((t=>v(t)===e))}(e,t))}function d(e,t){var r;return null!==(r=l(e.name,t))&&void 0!==r?r:a(e.type,t)}function c(e){return[...i,...e]}function h(e,t){const r=e.toLowerCase();return c(t).find((e=>m(e).some((e=>r.endsWith(e)))))}function v(e){return null===e||void 0===e?void 0:e[0]}function p(e){return null===e||void 0===e?void 0:e[1].toLowerCase()}function m(e){var t;return null!==(t=null===e||void 0===e?void 0:e[2].split(",").map((e=>e.toLowerCase())))&&void 0!==t?t:[]}function g(e){var t;return null===(t=e.tables)||void 0===t?void 0:t.find((e=>"assetMaps"===e.role))}},57858:(e,t,r)=>{r.d(t,{Q:()=>o,q:()=>s});var i=r(19545),n=r(76200);async function s(e,t,r){var s;if(!(null===i.id||void 0===i.id?void 0:i.id.findCredential(e.restUrl)))return null;if("loaded"===e.loadStatus&&""===t&&null!==(s=e.user)&&void 0!==s&&s.sourceJSON&&!1===r)return e.user.sourceJSON;const o={responseType:"json",query:{f:"json"}};if(r&&(o.query.returnUserLicenseTypeExtensions=!0),""===t){const t=await(0,n.Z)(e.restUrl+"/community/self",o);if(t.data){const e=t.data;if(null!==e&&void 0!==e&&e.username)return e}return null}const a=await(0,n.Z)(e.restUrl+"/community/users/"+t,o);if(a.data){const e=a.data;return e.error?null:e}return null}async function o(e,t,r){var i,n;const o=await s(e,t,!0);return null!==(i=null===o||void 0===o||null===(n=o.userLicenseTypeExtensions)||void 0===n?void 0:n.includes(r))&&void 0!==i&&i}},39812:(e,t,r)=>{r.r(t),r.d(t,{default:()=>ve});var i=r(27366),n=r(7138),s=r(80987),o=r(10064),a=r(32718),l=r(94172),u=r(35995),d=r(49861),c=(r(93169),r(84936),r(69912)),h=r(46634),v=r(37933),p=r(7575),m=r(57858),g=r(42265),f=r(19545),y=r(76200),w=r(63780),_=r(79056),V=r(46784),S=r(84652),b=r(54472),E=r(66978),I=r(38511),k=r(78952),L=r(91836),M=r(29887),C=r(56601),U=r(62594),x=r(94582),R=r(98995),O=r(73117),P=r(23084),T=r(62204),F=r(26760),N=r(54789);function D(e,t){const r=t.id;return{id:r,name:t.name,url:"".concat(e,"/").concat(r),type:t.type||"Table"}}function H(e){return{isDataVersioned:(0,F.ud)(e,"hasVersionedData",!1)}}function Z(e,t){const r=e?e.toLowerCase().split(",").map((e=>e.trim())):[],i=r.includes("query"),n=r.includes("editing")&&!t.datesInUnknownTimezone;let s=n&&r.includes("create"),o=n&&r.includes("delete"),a=n&&r.includes("update");return n&&!(s||o||a)&&(s=o=a=!0),{supportsAdd:s,supportsDelete:o,supportsEditing:n,supportsChangeTracking:r.includes("changetracking"),supportsQuery:i,supportsQueryDataElements:(0,F.ud)(t,"supportsQueryDataElements",!1),supportsQueryDomains:(0,F.ud)(t,"supportsQueryDomains",!1),supportsQueryContingentValues:(0,F.ud)(t,"supportsQueryContingentValues",!1),supportsSync:r.includes("sync"),supportsUpdate:a}}function A(e){return{maxRecordCountFactor:(0,F.Dq)(e,"maxRecordCountFactor",void 0),maxRecordCount:(0,F.Dq)(e,"maxRecordCount",void 0)}}function j(e){const t=null===e||void 0===e?void 0:e.advancedEditingCapabilities;return{supportsGlobalId:(0,F.ud)(e,"supportsApplyEditsWithGlobalIds",!1),supportsReturnServiceEditsInSourceSpatialReference:(0,F.ud)(t,"supportsReturnServiceEditsInSourceSR",!1),supportsSplit:(0,F.ud)(t,"supportsSplit",!1),supportsAsyncApplyEdits:(0,F.ud)(t,"supportsAsyncApplyEdits",!1)}}function J(e){const t=null===e||void 0===e?void 0:e.syncCapabilities,r=null===t||void 0===t?void 0:t.supportedSyncDataOptions;return{supportsAsync:(0,F.ud)(t,"supportsAsync",!1),supportedSyncDataOptions:{annotations:!(1&~r),dimensions:!(2&~r),contingentValues:!(4&~r),attributeRules:!(8&~r),utilityNetworkSystem:!(16&~r),annotationFullModel:!(32&~r),include3DObjects:!(64&~r),utilityNetworkMissingLayers:!(128&~r),preserveTrueCurves:!(256&~r)}}}let W=class extends((0,V.eC)((0,_.IG)(b.Z))){constructor(e){super(e),this.url=null,this.sourceJSON=null,this.userHasFullEditingPrivileges=!1,this.userHasUpdateItemPrivileges=!1,this.userTypeExtensions=[],this.layerInfos=null,this.tableInfos=null,this.capabilities=null}read(e,t){this.sourceJSON=e,super.read(e,t)}get utilityNetworkUrl(){if(this.sourceJSON)for(const e of this.sourceJSON.layers)if("Utility Network Layer"===e.type)return"".concat(this.url,"/").concat(e.id);return null}get versionManagementServiceUrl(){var e;return null!==(e=this.sourceJSON)&&void 0!==e&&e.hasBranchVersionedData?this.url.replace(/\/FeatureServer/i,"/VersionManagementServer"):null}readLayerInfos(e,t){return(t.layers||[]).map((e=>{const{type:t,geometryType:r}=e;return{...D(this.url,e),type:t||"Feature Layer",geometryType:r}}))}readTableInfos(e,t){return(t.tables||[]).map((e=>D(this.url,e)))}readCapabilities(e,t){return function(e){return{data:H(e),sync:J(e),operations:Z(e.capabilities,e),query:A(e),editing:j(e)}}(t)}get effectiveCapabilities(){const e=this.capabilities;if(!e)return null;const t=(0,S.d9)(e),{operations:r}=t;return this.userHasUpdateItemPrivileges?(r.supportsAdd=r.supportsDelete=r.supportsEditing=r.supportsQuery=r.supportsUpdate=!0,t):(this.userHasFullEditingPrivileges&&r.supportsEditing&&(r.supportsAdd=r.supportsDelete=r.supportsUpdate=!0),t)}load(e){return this.addResolvingPromise(this._fetchService(this.url,e).then((()=>this._setUserPrivileges(e)))),Promise.resolve(this)}async fetchAllLayersAndTables(e){return await this.load(e),this._fetchLayersAndTablesPromise||(this._fetchLayersAndTablesPromise=this._fetchLayersAndTables(this.url)),(0,E.k_)(e),this._fetchLayersAndTablesPromise}async applyEdits(e,t){let r=null;try{const{results:i,edits:n,editedFeatures:s}=await this._internalApplyEdits(e,t),o=e=>e.filter((e=>!e.error)).map(S.d9);let a=0;return i.map((e=>{r=(0,C.jF)(this.url,e.id,null===t||void 0===t?void 0:t.gdbVersion,!0);const i={edits:n[a],addedFeatures:o(e.addFeatureResults),updatedFeatures:o(e.updateFeatureResults),deletedFeatures:o(e.deleteFeatureResults),addedAttachments:o(e.addAttachmentResults),updatedAttachments:o(e.updateAttachmentResults),deletedAttachments:o(e.deleteAttachmentResults),exceededTransferLimit:!1,historicMoment:e.editMoment?new Date(e.editMoment):null};a+=1,s.length>0&&(i.editedFeatures=s),r.resolve(i),r=null})),i}catch(i){throw r&&r.reject(i),i}}async _setUserPrivileges(e){if(g.default.userPrivilegesApplied)try{const{features:{fullEdit:t},content:{updateItem:r}}=await this._fetchUserPrivileges(this.sourceJSON.serviceItemId,e);this._set("userHasFullEditingPrivileges",t),this._set("userHasUpdateItemPrivileges",r)}catch($){(0,E.r9)($)}}async _fetchUserPrivileges(e,t){const r=!0,i=!1,n=!1;if(!e)return{features:{edit:r,fullEdit:i},content:{updateItem:n}};let s,o,a;try{s=await(0,v.oP)(this.url,t)}catch(X){(0,E.r9)(X)}try{const e=null!=t?t.signal:null;o=await(null===f.id||void 0===f.id?void 0:f.id.getCredential("".concat(s,"/sharing"),{prompt:!1,signal:e}))}catch(X){(0,E.r9)(X)}if(!o)return{features:{edit:r,fullEdit:i},content:{updateItem:n}};try{if(a=new R.default({id:e,portal:{url:s}}),await a.load(t),a.portal.user)return(0,O.Ss)(a)}catch(X){(0,E.r9)(X)}return{features:{edit:r,fullEdit:i},content:{updateItem:n}}}async _internalApplyEdits(e,t){var r;await(0,U.fK)(this.url);const i=null!==(r=null===t||void 0===t?void 0:t.globalIdUsed)&&void 0!==r&&r,n=k.Z.fromJSON(this.sourceJSON.spatialReference),{edits:s,options:o}=await this._processApplyEditsParams(e,t),a=await Promise.all(s.map((async e=>{var t,r,s,o;const a=null!==(t=null===(r=e.addFeatures)||void 0===r?void 0:r.map((e=>(0,L.mh)({spatialReference:n},e,null))))&&void 0!==t?t:[],l=(await Promise.all(a)).filter(w.pC),u=l.length>0?l:null,d=null!==(s=null===(o=e.updateFeatures)||void 0===o?void 0:o.map((e=>(0,L.mh)({spatialReference:n},e,null))))&&void 0!==s?s:[],c=(await Promise.all(d)).filter(w.pC),h=c.length>0?c:null,v=(0,L.CJ)(e.identifierFields,e.deleteFeatures,i),p=v.length>0?v:null;(0,T.P)(u,h,n);const m=await(0,L.hw)(e.identifierFields,e);let g=null;return m&&(g={adds:m.adds.length>0?m.adds:void 0,updates:m.updates.length>0?m.updates:void 0,deletes:m.deletes.length>0?m.deletes:void 0}),{id:e.id,adds:u,updates:h,deletes:p,attachments:g}}))),l={gdbVersion:null===o||void 0===o?void 0:o.gdbVersion,rollbackOnFailure:!0,useGlobalIds:i,returnEditMoment:!0,honorSequenceOfEdits:null===o||void 0===o?void 0:o.honorSequenceOfEdits,usePreviousEditMoment:null===o||void 0===o?void 0:o.usePreviousEditMoment,returnServiceEditsInSourceSR:!1,returnServiceEditsOption:"originalAndCurrentFeatures",async:!1};await(0,N.Px)(this.url,null===t||void 0===t?void 0:t.gdbVersion,!0);const u=(0,N.JV)(this.url,(null===t||void 0===t?void 0:t.gdbVersion)||null);l.edits=JSON.stringify(a);const d=(0,P.en)(this.url),c=(0,P.lA)(d.query,{query:(0,P.cv)({...l,f:"json"}),method:"post"});let h;u&&(c.authMode="immediate",c.query.sessionId=N.U8);try{h=await(0,y.Z)(this.url+"/applyEdits",c)}catch(v){if(!(0,L.JK)(v))throw v;c.authMode="immediate",h=await(0,y.Z)(this.url+"/applyEdits",c)}return{...Y(h),edits:s}}async _processApplyEditsParams(e,t){const r={...t};return{edits:await Promise.all(e.map((async e=>{const r=this.effectiveCapabilities,i=e&&(e.addFeatures||e.updateFeatures||e.deleteFeatures),n=e&&(e.addAttachments||e.updateAttachments||e.deleteAttachments);if((0,M.w4)(e,r,t,!!i,!!n,"feature-service"),!r.data.isDataVersioned&&null!==t&&void 0!==t&&t.gdbVersion)throw new o.Z("feature-service:invalid-parameter","'gdbVersion' is applicable only if the layer supports versioned data. See: 'capabilities.data.isVersioned'");const s=(0,M.X2)(e,r,"feature-service");return{...await(0,M.EE)(s),id:e.id,identifierFields:e.identifierFields}}))),options:r}}async _fetchService(e,t){if(this.sourceJSON)return void this.read(this.sourceJSON,{url:(0,P.en)(e)});const r=await(0,y.Z)(e,{responseType:"json",query:{f:"json"},...t});this.read(r.data,{url:(0,P.en)(e)})}async _fetchLayersAndTables(e){const t="".concat(e,"/layers"),r=await(0,y.Z)(t,{responseType:"json",query:{f:"json"}});return{layers:r.data.layers.map((e=>{const{type:t,geometryType:r}=e,i=D(this.url,e),n=(0,x.h)(e,i.url);return{...i,type:t||"Feature Layer",geometryType:r,capabilities:n}})),tables:r.data.tables.map((e=>{const t=D(this.url,e),r=(0,x.h)(e,t.url);return{...t,capabilities:r}}))}}};function Y(e){const t=e.data,r=[];return{results:t.map((e=>{var t,i,n;const s={addResults:null!==(t=e.addResults)&&void 0!==t?t:[],updateResults:null!==(i=e.updateResults)&&void 0!==i?i:[],deleteResults:null!==(n=e.deleteResults)&&void 0!==n?n:[],attachments:e.attachments,editMoment:e.editMoment},o=(0,L.RZ)(s),a=e.editedFeatures,l=null!==a&&void 0!==a&&a.spatialReference?new k.Z({wkid:null===a||void 0===a?void 0:a.spatialReference.wkid,wkt:null===a||void 0===a?void 0:a.spatialReference.wkt,latestWkid:null===a||void 0===a?void 0:a.spatialReference.latestWkid,latestVcsWkid:null===a||void 0===a?void 0:a.spatialReference.latestVcsWkid,vcsWkid:null===a||void 0===a?void 0:a.spatialReference.vcsWkid}):null,u=a?(0,L.JX)(a,l):null;return u&&r.push({layerId:e.id,editedFeatures:u}),{id:e.id,editedFeatures:u,...o}})),editedFeatures:r}}(0,i._)([(0,d.Cb)()],W.prototype,"url",void 0),(0,i._)([(0,d.Cb)()],W.prototype,"sourceJSON",void 0),(0,i._)([(0,d.Cb)()],W.prototype,"userHasFullEditingPrivileges",void 0),(0,i._)([(0,d.Cb)()],W.prototype,"userHasUpdateItemPrivileges",void 0),(0,i._)([(0,d.Cb)({readOnly:!0})],W.prototype,"utilityNetworkUrl",null),(0,i._)([(0,d.Cb)({readOnly:!0})],W.prototype,"versionManagementServiceUrl",null),(0,i._)([(0,d.Cb)()],W.prototype,"userTypeExtensions",void 0),(0,i._)([(0,d.Cb)({json:{read:{source:["layers"]}}})],W.prototype,"layerInfos",void 0),(0,i._)([(0,I.r)("layerInfos",["layers"])],W.prototype,"readLayerInfos",null),(0,i._)([(0,d.Cb)({json:{read:{source:["tables"]}}})],W.prototype,"tableInfos",void 0),(0,i._)([(0,I.r)("tableInfos",["tables"])],W.prototype,"readTableInfos",null),(0,i._)([(0,d.Cb)({readOnly:!0,json:{read:{source:["hasVersionedData","capabilities","supportsQueryDataElements","supportsQueryDomains","supportsQueryContingentValues","maxRecordCountFactor","maxRecordCount","advancedEditingCapabilities","supportsApplyEditsWithGlobalIds","syncCapabilities","datesInUnknownTimezone"]}}})],W.prototype,"capabilities",void 0),(0,i._)([(0,I.r)("capabilities",["hasVersionedData","capabilities","supportsQueryDataElements","supportsQueryDomains","supportsQueryContingentValues","maxRecordCountFactor","maxRecordCount","advancedEditingCapabilities","supportsApplyEditsWithGlobalIds","syncCapabilities","datesInUnknownTimezone"])],W.prototype,"readCapabilities",null),(0,i._)([(0,d.Cb)({readOnly:!0})],W.prototype,"effectiveCapabilities",null),W=(0,i._)([(0,c.j)("esri.rest.featureService.FeatureService")],W);const q=W;var Q=r(25899);const G=(e,t)=>{for(const r of e)if("feature"===r.type||"subtype-group"===r.type){if(!r.url)continue;const e=(0,Q.Qc)(r.url).url.path,i=t.get(e);if(i)i.layers.push(r);else{const i=new q({url:e}),n=[r];t.set(e,{featureService:i,layers:n})}}else"group"===r.type&&G(r.layers,t)};function $(e){const t=new Map;return G(e,t),t}var z=r(42537),B=r(77427);let K=class extends((0,V.eC)(b.Z)){constructor(e){super(e),this.versionManagementService=null,this.featureServiceUrl=null,this.url=null,this.currentVersion=null,this.currentVersionInfo=null,this.versionInfos=[],this.versionableItems=new s.Z,this.usePersistentReadSessions=!1,this.state="lock-none"}initialize(){this.url=this.versionManagementService.url,this.featureServiceUrl=this.url.replace(/\/VersionManagementServer/i,"/FeatureServer"),this.addHandles([this.versionableItems.on("before-add",(e=>{if(e.item.featureServiceUrl.toLowerCase()!==this.featureServiceUrl.toLowerCase())return e.preventDefault(),void a.Z.getLogger(this).error("#add()","Cannot add versionAdapter, feature service urls do not match.")})),this.versionableItems.on("before-remove",(e=>{if(0===this.versionableItems.items.length&&this.currentVersion&&"name"in this.currentVersion&&"none"!==this.versionManagementService.getLockType(this.currentVersion))return e.preventDefault(),void a.Z.getLogger(this).error("#remove()","Cannot remove last versionAdapter.")}))])}load(e){return this.addResolvingPromise(this._setUpState(e)),Promise.resolve(this)}get defaultVersionIdentifier(){return this.versionManagementService.defaultVersionIdentifier}get isDefault(){return!this.currentVersion||!!this.currentVersion&&"name"in this.currentVersion&&this.currentVersion.name===this.defaultVersionIdentifier.name}async getVersionInfos(){return arguments.length>0&&void 0!==arguments[0]&&arguments[0]&&(this.versionInfos=await this.versionManagementService.getVersionInfos()),this.versionInfos}async alterVersion(e,t){if(this.currentVersion&&"guid"in this.currentVersion&&e.guid===this.currentVersion.guid)return!1;const r=await this.versionManagementService.alterVersion(e,t);return r&&await this.getVersionInfos(!0),r}async deleteVersion(e){if(this.currentVersion&&"guid"in this.currentVersion&&e.guid===this.currentVersion.guid)return!1;const t=await this.versionManagementService.deleteVersion(e);return t&&await this.getVersionInfos(!0),t}async getVersionInfoExtended(){return this.currentVersion&&"name"in this.currentVersion?this.versionManagementService.getVersionInfoExtended(this.currentVersion):this.versionManagementService.getVersionInfoExtended(this.defaultVersionIdentifier)}async startEditing(){if(this._isDefaultOrHistoricVersion())return{success:!1};if(!this.usePersistentReadSessions){const e=await this.versionManagementService.startReadingWithResult(this.currentVersion);if(!e.success)return e;this.state="lock-read"}const e=await this.versionManagementService.startEditingWithResult(this.currentVersion);return e.success&&(this.state="lock-write"),e}async stopEditing(e){if(this._isDefaultOrHistoricVersion())return{success:!1};const t=await this.versionManagementService.stopEditingWithResult(this.currentVersion,e);if(!t.success)return t;if(this.state="lock-read",!this.usePersistentReadSessions){const e=await this.versionManagementService.stopReadingWithResult(this.currentVersion);return e.success&&(this.state="lock-none"),e}return t}async changeVersion(e){var t;let r=null;if(this.usePersistentReadSessions){var i;if(this._isDefaultOrHistoricVersion(e))e&&"name"in e?(r=await this.versionManagementService.getVersionInfoExtended(e),this.state="public"===(null===(i=r)||void 0===i?void 0:i.access)?"lock-none":"lock-read"):this.state="lock-read";else if(!await this.versionManagementService.startReading(e))throw new o.Z("Failed to acquire read lock for version: "+e);this._isDefaultOrHistoricVersion(this.currentVersion)||await this.versionManagementService.stopReading(this.currentVersion)}const n=await this.versionManagementService.changeVersionWithResult(this.versionableItems,this.currentVersion,e);let s=!1;return n.forEach(((e,t)=>{s=s||e.success})),s&&(this.currentVersion=e,this.currentVersionInfo=r||await this.getVersionInfoExtended(),this._isDefaultOrHistoricVersion()?this.currentVersion&&"name"in this.currentVersion?this.state="public"===(null===(t=this.currentVersionInfo)||void 0===t?void 0:t.access)?"lock-none":"lock-read":this.state="lock-read":this.state="read"!==this.versionManagementService.getLockType(this.currentVersion)?"lock-none":"lock-read"),n}async undo(){return this._isDefaultOrHistoricVersion()?{success:!1}:(this.versionManagementService.undo(this.currentVersion),{success:!0})}async redo(){return this._isDefaultOrHistoricVersion()?{success:!1}:(this.versionManagementService.redo(this.currentVersion),{success:!0})}async _setUpState(e){var t;await this.versionManagementService.load(e),this.state="lock-none",this.currentVersionInfo=await this.getVersionInfoExtended(),this.versionableItems.forEach((e=>{this.currentVersion?"name"in this.currentVersion?(e.gdbVersion=this.currentVersion.name,e.historicMoment=null):(e.historicMoment=this.currentVersion,e.gdbVersion=null):(e.gdbVersion=null,e.historicMoment=null)})),this.usePersistentReadSessions&&(this._isDefaultOrHistoricVersion()?this.currentVersion&&"name"in this.currentVersion?this.state="public"===(null===(t=this.currentVersionInfo)||void 0===t?void 0:t.access)?"lock-none":"lock-read":this.state="lock-read":await this.versionManagementService.startReading(this.currentVersion)&&(this.state="lock-read"))}_isDefaultOrHistoricVersion(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:this.currentVersion;return!(e&&"name"in e)||e.name===this.versionManagementService.defaultVersionIdentifier.name}};(0,i._)([(0,d.Cb)()],K.prototype,"versionManagementService",void 0),(0,i._)([(0,d.Cb)()],K.prototype,"featureServiceUrl",void 0),(0,i._)([(0,d.Cb)()],K.prototype,"url",void 0),(0,i._)([(0,d.Cb)()],K.prototype,"currentVersion",void 0),(0,i._)([(0,d.Cb)()],K.prototype,"currentVersionInfo",void 0),(0,i._)([(0,d.Cb)()],K.prototype,"versionInfos",void 0),(0,i._)([(0,d.Cb)()],K.prototype,"versionableItems",void 0),(0,i._)([(0,d.Cb)()],K.prototype,"usePersistentReadSessions",void 0),(0,i._)([(0,d.Cb)()],K.prototype,"state",void 0),(0,i._)([(0,d.Cb)({readOnly:!0})],K.prototype,"defaultVersionIdentifier",null),(0,i._)([(0,d.Cb)({readOnly:!0})],K.prototype,"isDefault",null),K=(0,i._)([(0,c.j)("esri.versionManagement.VersioningState")],K);const X=K;var ee=r(31201);class te{constructor(e){this.moments=[],this.forwardMoments=[],this.moments.push(e)}push(e){return this.forwardMoments.length,this.moments.push(e)}pop(){if(!(this.forwardMoments.length>0))return this.moments.pop()}undo(){if(!this.canUndo())return;const e=this.moments.pop();return this.forwardMoments.push(e),e}peek(){return this.moments.at(-1)}canUndo(){return this.moments.length>1}canRedo(){return this.hasForwardEdits()}redo(){if(!this.canRedo())return;const e=this.forwardMoments.pop();return this.moments.push(e),e}size(){return this.moments.length+this.forwardMoments.length}hasForwardEdits(){return this.forwardMoments.length>0}clearForwardEdits(){this.forwardMoments=[]}}var re=r(22751);r(75505),r(86741),r(51370);class ie{constructor(e){this.versionableItem=e,this.type="featureLayer"}get gdbVersion(){return this.versionableItem.gdbVersion}set gdbVersion(e){this.versionableItem.gdbVersion=e}get historicMoment(){return this.versionableItem.historicMoment}set historicMoment(e){this.versionableItem.historicMoment=e}get featureServiceUrl(){return this.versionableItem.url.replace(/^(.*\/FeatureServer)\/\d+$/,"$1")}}(0,i._)([(0,d.Cb)({readOnly:!0})],ie.prototype,"type",void 0),(0,i._)([(0,d.Cb)()],ie.prototype,"gdbVersion",null),(0,i._)([(0,d.Cb)({type:Date})],ie.prototype,"historicMoment",null),(0,i._)([(0,d.Cb)({readOnly:!0})],ie.prototype,"featureServiceUrl",null);class ne{constructor(e){this.versionableItem=e,this.type="network"}get gdbVersion(){return this.versionableItem.gdbVersion}set gdbVersion(e){this.versionableItem.gdbVersion=e}get historicMoment(){return this.versionableItem.historicMoment}set historicMoment(e){this.versionableItem.historicMoment=e}get featureServiceUrl(){return this.versionableItem.featureServiceUrl}}(0,i._)([(0,d.Cb)({readOnly:!0})],ne.prototype,"type",void 0),(0,i._)([(0,d.Cb)()],ne.prototype,"gdbVersion",null),(0,i._)([(0,d.Cb)({type:Date})],ne.prototype,"historicMoment",null),(0,i._)([(0,d.Cb)({readOnly:!0})],ne.prototype,"featureServiceUrl",null);class se{constructor(e){this.versionableItem=e,this.type="subtypeGroupLayer"}get gdbVersion(){return this.versionableItem.gdbVersion}set gdbVersion(e){this.versionableItem.gdbVersion=e}get historicMoment(){return this.versionableItem.historicMoment}set historicMoment(e){this.versionableItem.historicMoment=e}get featureServiceUrl(){return this.versionableItem.url.replace(/^(.*\/FeatureServer)\/\d+$/,"$1")}}function oe(e){return"networkServiceUrl"in e?new ne(e):"feature"!==e.type||(0,re.x)(e)?"subtype-group"!==e.type||(0,re.x)(e)?null:new se(e):new ie(e)}function ae(e){const t=[];for(const r of e)if("group"===r.type){const e=r,i=e.allTables.concat(e.allLayers);for(const r of i)if("feature"===r.type||"subtype-group"===r.type){const e=oe(r);e&&t.push(e)}}else{const e=oe(r);e&&t.push(e)}return t}(0,i._)([(0,d.Cb)({readOnly:!0})],se.prototype,"type",void 0),(0,i._)([(0,d.Cb)()],se.prototype,"gdbVersion",null),(0,i._)([(0,d.Cb)({type:Date})],se.prototype,"historicMoment",null),(0,i._)([(0,d.Cb)({readOnly:!0})],se.prototype,"featureServiceUrl",null);let le=class extends((0,V.eC)(b.Z)){constructor(e){super(e),this.url=null,this.sourceJSON=null,this.name=null,this.defaultVersionIdentifier=null,this.capabilities=null,this._isDefault=e=>!e||e===this.defaultVersionIdentifier.name,this._dateEquals=(e,t)=>!e&&!t||!(!e||!t)&&e.toISOString()===t.toISOString(),this._applyEditsHandler=e=>{const{serviceUrl:t,gdbVersion:r,result:i}=e;t===this._featureServiceUrl&&i.then((e=>{const t=e.historicMoment;t&&this._addMomentToVersionItem(r,t)}))}}initialize(){var e;this.url=(0,u.Qj)(this.url),this._featureServiceUrl=this.url.replace(/\/VersionManagementServer/i,"/FeatureServer"),N.YO.has(this.url)||N.YO.set(this.url,new Map);const t=(null!==(e=N.rj.get(this.url))&&void 0!==e?e:0)+1;N.rj.set(this.url,t),this.when().then((()=>this.addHandles((0,C.qH)(this._applyEditsHandler))),(()=>{}))}destroy(){var e;const t=(null!==(e=N.rj.get(this.url))&&void 0!==e?e:1)-1;N.rj.set(this.url,t),0===t&&N.YO.delete(this.url),N.Jp.delete(this._featureServiceUrl)}read(e,t){this.sourceJSON=e,super.read(e,t)}readDefaultVersionIdentifier(e,t){return{name:t.defaultVersionName,guid:t.defaultVersionGuid}}writeDefaultVersionIdentifier(e,t){t.defaultVersionName=e.name,t.defaultVersionGuid=e.guid}load(e){return this.addResolvingPromise(this._fetchService(this.url,e)),Promise.resolve(this)}async createVersion(e){const[{createVersion:t},{default:i}]=await Promise.all([r.e(25939).then(r.bind(r,25939)),r.e(43147).then(r.bind(r,43147))]),n=i.from(e);return t(this.url,n)}async deleteVersion(e){var t;const[{deleteVersion:i},{default:n}]=await Promise.all([r.e(59658).then(r.bind(r,59658)),r.e(87774).then(r.bind(r,87774))]);let s;e.guid&&(null===(t=N.YO.get(this.url))||void 0===t?void 0:t.has(e.guid))&&(s=null!==N.U8&&void 0!==N.U8?N.U8:void 0);const o=new n({versionName:e.name,sessionId:s});return i(this.url,o)}async getVersionInfoExtended(e){const{getVersion:t}=await r.e(29780).then(r.bind(r,29780));return t(this.url,e.guid)}async getVersionInfos(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};const[{getVersionInfos:t},{default:i}]=await Promise.all([r.e(85215).then(r.bind(r,85215)),r.e(74790).then(r.bind(r,74790))]),n=i.from(e);return t(this.url,n)}async reconcile(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};const[{reconcile:i},{default:n}]=await Promise.all([r.e(63893).then(r.bind(r,63893)),r.e(2364).then(r.bind(r,2364))]),s=n.from(t);return s.sessionId=N.U8,i(this.url,e.guid,s)}async post(e){const[{post:t},{default:i}]=await Promise.all([r.e(54841).then(r.bind(r,54841)),r.e(82196).then(r.bind(r,82196))]),n=i.from({sessionId:N.U8});return t(this.url,e.guid,n)}async alterVersion(e,t){const[{alterVersion:i},{default:n}]=await Promise.all([r.e(50098).then(r.bind(r,50098)),r.e(52112).then(r.bind(r,52112))]),s=n.from(t);return i(this.url,e.guid,s)}async startReading(e){return(await this.startReadingWithResult(e)).success}async startReadingWithResult(e){const{startReading:t}=await r.e(50880).then(r.bind(r,50880)),i=await t(this.url,e.guid,N.U8);if(i.success){const t=await this.getVersionInfoExtended(e),r=new Date(t.modifiedDate),i={name:t.versionIdentifier.name,moment:r,lockType:"read"};this._addOrUpdateItem(e.guid,i),(0,C.SY)(this._featureServiceUrl,null,e.name,r)}return i}async stopReading(e){return(await this.stopReadingWithResult(e)).success}async stopReadingWithResult(e){var t;const{stopReading:i}=await r.e(32673).then(r.bind(r,32673)),n=await i(this.url,e.guid,N.U8);return n.success&&(null!==(t=N.YO.get(this.url))&&void 0!==t&&t.delete(e.guid),(0,C.SY)(this._featureServiceUrl,null,e.name,null)),n}async startEditing(e){return(await this.startEditingWithResult(e)).success}async startEditingWithResult(e){const{startEditing:t}=await r.e(90114).then(r.bind(r,90114)),i=await t(this.url,e.guid,N.U8);if(i.success){const t=await this.getVersionInfoExtended(e),r=new Date(t.modifiedDate),i=new te(r),n={name:e.name,moment:r,lockType:"edit",stack:i};this._addOrUpdateItem(e.guid,n),(0,C.SY)(this._featureServiceUrl,null,e.name,r)}return i}async stopEditing(e,t){return(await this.stopEditingWithResult(e,t)).success}async stopEditingWithResult(e,t){if(t){var i,n;const t=null===(i=N.YO.get(this.url))||void 0===i?void 0:i.get(e.guid);if(null!==t&&void 0!==t&&null!==(n=t.stack)&&void 0!==n&&n.canRedo()){const[{deleteForwardEdits:i},{default:n}]=await Promise.all([r.e(2106).then(r.bind(r,2106)),r.e(70519).then(r.bind(r,70519))]),s=await i(this.url,e.guid,new n({sessionId:N.U8,moment:t.moment}));if(!s.success)return s}}const{stopEditing:s}=await r.e(62856).then(r.bind(r,62856)),o=await s(this.url,e.guid,N.U8,t);if(o.success){const t=await this.getVersionInfoExtended(e),r=new Date(t.modifiedDate);this._addOrUpdateItem(e.guid,{name:e.name,moment:r,lockType:"read",editMomentStack:void 0}),(0,C.SY)(this._featureServiceUrl,null,e.name,r)}return o}getLockType(e){var t;const r=null===(t=N.YO.get(this.url))||void 0===t||null===(t=t.get(e.guid))||void 0===t?void 0:t.lockType;return null!==r&&void 0!==r?r:"none"}async changeVersion(e,t,r){if(r&&"name"in r&&!await this.getVersionInfoExtended(r))throw new o.Z("version-management-service:invalid-version","version does not exist");if("networkServiceUrl"in e){if(this._featureServiceUrl.toLowerCase()===e.featureServiceUrl.toLowerCase())return this._changeVersionInternal(e,t,r)}else{let i;"layers"in e?(i=e.allTables.concat(e.allLayers),e.utilityNetworks&&e.utilityNetworks.forEach((e=>{this._featureServiceUrl.toLowerCase()===e.featureServiceUrl.toLowerCase()&&this._changeVersionInternal(e,t,r)}))):i=e;for(const e of i)if("feature"===e.type||"subtype-group"===e.type){const i=/^(.*\/FeatureServer)\/\d+$/,n=e.url.replace(i,"$1");if(this._featureServiceUrl.toLowerCase()===n.toLowerCase()&&!this._changeVersionInternal(e,t,r))return!1}else if("group"===e.type){const i=e.allTables.concat(e.allLayers);for(const e of i)if("feature"===e.type||"subtype-group"===e.type){const i=/^(.*\/FeatureServer)\/\d+$/,n=e.url.replace(i,"$1");if(this._featureServiceUrl.toLowerCase()===n.toLowerCase()&&!this._changeVersionInternal(e,t,r))return!1}}}return!0}async changeVersionWithResult(e,t,r){let i;if("layers"in e){const t=ae(e.allTables.concat(e.allLayers).filter((e=>"group"!==e.type)).toArray());e.utilityNetworks&&e.utilityNetworks.forEach((e=>{const r=ae([e]);t.push(...r)})),i=t}else i=e;if(r&&"name"in r&&!await this.getVersionInfoExtended(r)){const e=new Map;for(const t of i)e.set(t,{success:!1});return e}if(t&&"name"in t&&"none"!==this.getLockType(t)){const e=new Map;for(const t of i)e.set(t,{success:!1});return e}const n=new Map;for(const s of i)if(s)if(s.featureServiceUrl.toLowerCase()===this._featureServiceUrl.toLowerCase()){const e=this._changeVersionInternalWithResult(s,t,r);n.set(s,e)}else n.set(s,{success:!1});return n}async getVersionIdentifierFromName(e){try{var t;return(null===(t=(await this.getVersionInfos({includeHidden:!0})).find((t=>t.versionIdentifier.name===e)))||void 0===t?void 0:t.versionIdentifier)||null}catch{return null}}async getVersionIdentifierFromGuid(e){const{getVersion:t}=await r.e(29780).then(r.bind(r,29780));try{return(await t(this.url,e)).versionIdentifier}catch{return null}}canUndo(e){var t,r;const i=null===(t=N.YO.get(this.url))||void 0===t?void 0:t.get(e.guid);return!(null===i||void 0===i||null===(r=i.stack)||void 0===r||!r.canUndo())}canRedo(e){var t,r;const i=null===(t=N.YO.get(this.url))||void 0===t?void 0:t.get(e.guid);return!(null===i||void 0===i||null===(r=i.stack)||void 0===r||!r.canRedo())}undo(e){var t,r;const i=null===(t=N.YO.get(this.url))||void 0===t?void 0:t.get(e.guid),n=(null===i||void 0===i||null===(r=i.stack)||void 0===r?void 0:r.undo())||void 0;if(i&&n){var s;const t=i.stack.peek();(0,C.SY)(this._featureServiceUrl,null,e.name,t),null===(s=N.YO.get(this.url))||void 0===s||s.set(e.guid,{...i,moment:t})}}redo(e){var t,r,i;const n=null===(t=N.YO.get(this.url))||void 0===t?void 0:t.get(e.guid),s=(null===n||void 0===n||null===(r=n.stack)||void 0===r?void 0:r.redo())||void 0;n&&s&&((0,C.SY)(this._featureServiceUrl,null,e.name,s),null===(i=N.YO.get(this.url))||void 0===i||i.set(e.guid,{...n,moment:s}))}_setUpData(e,t){let r=null,i=null,n=null,s=null;const a=e=>{var t,r;const i=null===N.YO||void 0===N.YO||null===(t=N.YO.get(this.url))||void 0===t?void 0:t.get(e.guid);n=e.name,s=null!==(r=null===i||void 0===i?void 0:i.moment)&&void 0!==r?r:null};if(e&&"name"in e){if("none"!==this.getLockType(e))throw new o.Z("version-management-service:version-locked","version is locked");r=e.name,i=null,t&&"name"in t?a(t):(n=this.defaultVersionIdentifier.name,s=t)}else r=this.defaultVersionIdentifier.name,i=e,t&&"name"in t?a(t):(n=this.defaultVersionIdentifier.name,s=t);return{fromVersionName:r,fromMoment:i,toVersionName:n,toMoment:s}}_changeVersionInternal(e,t,r){try{const{fromVersionName:i,fromMoment:n,toVersionName:s,toMoment:o}=this._setUpData(t,r);(this._isDefault(i)&&this._isDefault(e.gdbVersion)&&this._dateEquals(e.historicMoment,n)||i===e.gdbVersion&&this._dateEquals(e.historicMoment,n))&&(e.gdbVersion=s,e.historicMoment=o)}catch($){return!1}return!0}_changeVersionInternalWithResult(e,t,r){try{const{fromVersionName:i,fromMoment:n,toVersionName:s,toMoment:o}=this._setUpData(t,r);return this._isDefault(i)&&this._isDefault(e.gdbVersion)&&this._dateEquals(e.historicMoment,n)||i===e.gdbVersion&&this._dateEquals(e.historicMoment,n)?(e.gdbVersion=s,e.historicMoment=o,{success:!0}):{success:!1}}catch($){return{success:!1}}}_addMomentToVersionItem(e,t){const r=N.YO.get(this.url);if(r)for(const[i,n]of r)n.name===e&&this._addToStack(i,t)}_addToStack(e,t){const r=N.YO.get(this.url),i=null===r||void 0===r?void 0:r.get(e);return!(null===i||void 0===i||!i.stack)&&(function(e,t){if(e)return e.getTime()<t.getTime();return!0}(i.stack.peek(),t)&&i.stack.push(t),r.set(e,{...i,moment:t}),!0)}_addOrUpdateItem(e,t){const r=N.YO.get(this.url),i=null===r||void 0===r?void 0:r.get(e);return i?(r.set(e,{...i,...t}),!0):!(!t.name||!t.lockType)&&(null!==r&&void 0!==r&&r.set(e,{...t,lockType:t.lockType}),!0)}async _fetchService(e,t){if(this.sourceJSON){this.read(this.sourceJSON,{origin:"service",url:(0,P.en)(e)});const t=new u.R9(this.url).host;return void N.Jp.set(t,this.defaultVersionIdentifier.name)}const r=await(0,y.Z)(e,{responseType:"json",query:{f:"json"},...t});this.read(r.data)}};(0,i._)([(0,d.Cb)()],le.prototype,"url",void 0),(0,i._)([(0,d.Cb)()],le.prototype,"sourceJSON",void 0),(0,i._)([(0,d.Cb)({type:String,json:{write:!0}})],le.prototype,"name",void 0),(0,i._)([(0,d.Cb)({json:{write:{target:{defaultVersionName:{type:String},defaultVersionGuid:{type:String}}},read:{source:["defaultVersionName","defaultVersionGuid"]}}})],le.prototype,"defaultVersionIdentifier",void 0),(0,i._)([(0,I.r)("defaultVersionIdentifier",["defaultVersionName","defaultVersionGuid"])],le.prototype,"readDefaultVersionIdentifier",null),(0,i._)([(0,ee.c)("defaultVersionIdentifier",{defaultVersionName:{type:String},defaultVersionGuid:{type:String}})],le.prototype,"writeDefaultVersionIdentifier",null),(0,i._)([(0,d.Cb)({json:{write:!0}})],le.prototype,"capabilities",void 0),le=(0,i._)([(0,c.j)("esri.versionManagement.VersionManagementService")],le);const ue=le;const de=new Map;async function ce(e){let t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];const r=await async function(e,t){let r;if("layers"in e){const t=ae(e.allTables.concat(e.allLayers).filter((e=>"group"!==e.type)).toArray());e.utilityNetworks&&e.utilityNetworks.forEach((e=>{const r=ae([e]);t.push(...r)})),r=t}else r=new s.Z(e);const i=new Map;for(const o of r){const e=i.get(o.featureServiceUrl);e?e.push(o):i.set(o.featureServiceUrl,new s.Z([o]))}const n=new s.Z;for(const[s,o]of i){const e=new q({url:s});if(await e.load(),!e.versionManagementServiceUrl)continue;const r=new ue({url:e.versionManagementServiceUrl});n.push(new X({versionManagementService:r,versionableItems:o,usePersistentReadSessions:t}))}return n}(e.map,t);return(0,B.s1)(de,e,(()=>(e.addHandles((0,z.kB)((()=>{de.delete(e),r.forEach((e=>e.destroy()))}))),r.forEach((e=>e.load().catch((e=>{a.Z.getLogger("esri.versionManagement.VersioningState").error("Failed to load Versioning State",e)})))),r)))}let he=class extends n.default{constructor(e){super(e),this._portalLookup=new Map,this._updatingHandlesLoad=new h.R,this._updatingHandlesExecute=new h.R,this.advancedEditingUserTypeExtensionLookup=new Map,this.executionError=void 0,this.featureServiceLookup=new Map,this.loadError=void 0,this.serverVersionLookup=new Map,this.serviceNameLookup=new Map,this.userLookup=new Map,this.versionIdentifierLookup=new Map,this.versionInfoLookup=new Map,this.versionManagementServiceLookup=new Map,this.versioningStateLookup=new Map,this.view=null,this.versioningStates=null}initialize(){this._viewChangeHandle(),this.addHandles([(0,l.watch)((()=>this.view),(()=>{this._resetAllLookupProperties(),this._viewChangeHandle()})),(0,l.watch)((()=>this.versioningStates),(()=>{this._resetVersioningLookupProperties(),this._setVersioningStatesLookups()}))])}destroy(){this._updatingHandlesLoad.destroy(),this._updatingHandlesExecute.destroy()}get state(){return this._updatingHandlesLoad.updating?"loading":this.loadError?"disabled":this._updatingHandlesExecute.updating?"executing":this.executionError?"failed":"ready"}async alterVersion(e){return this._updatingHandlesExecute.addPromise(this._alterVersionInternal(e))}async changeVersion(e,t,r){return this._updatingHandlesExecute.addPromise(this._changeVersionInternal(e,t,r))}async createVersion(e){return this._updatingHandlesExecute.addPromise(this._createVersionInternal(e))}async deleteVersion(e,t,r){return this._updatingHandlesExecute.addPromise(this._deleteVersionInternal(e,t,r))}async getVersionInfos(e){return this._updatingHandlesExecute.addPromise(this._getVersionInfosInternal(e))}async _alterVersionInternal(e){if("disabled"===this.state)throw this._logError("version-management-view-model:load-error",this.loadError),new o.Z("version-management-view-model:load-error",this.loadError);this._setExecutionError();const t=this.versioningStateLookup.get(e.featureServerUrl);if(!t)throw this._logError("version-management-view-model:execution-error","no-versioning-state-found"),new o.Z("version-management-view-model:execution-error",this.executionError);if(!this.serverVersionLookup.has(e.featureServerUrl)||this.serverVersionLookup.get(e.featureServerUrl)<=11.1)throw this._logError("version-management-view-model:execution-error","no-valid-enterprise-version"),new o.Z("version-management-view-model:execution-error",this.executionError);if(!this.advancedEditingUserTypeExtensionLookup.get(e.featureServerUrl))throw this._logError("version-management-view-model:execution-error","no-advanced-editing-user-type-extension"),new o.Z("version-management-view-model:execution-error",this.executionError);const{featureServerUrl:r,versionIdentifier:i,...n}=e,s=await t.alterVersion(i,n).catch((e=>{throw this._logExecutionError(e),e}));return await this.getVersionInfos(r),s}async _changeVersionInternal(e,t,r){if("disabled"===this.state)throw this._logError("version-management-view-model:load-error",this.loadError),new o.Z("version-management-view-model:load-error",this.loadError);this._setExecutionError();const i=this.versioningStateLookup.get(e);if(!i)throw this._logError("version-management-view-model:execution-error","no-versioning-state-found"),new o.Z("version-management-view-model:execution-error",this.executionError);const n={name:t,guid:r};return await i.changeVersion(n).catch((e=>{throw this._logExecutionError(e),e}))}_updateVersionableItems(e){this._updatingHandlesLoad.addPromise((async()=>{ae(e.added).forEach((e=>{const t=e.featureServiceUrl,r=this.versioningStateLookup.get(t);r&&(r.versionableItems.find((t=>t.versionableItem===e.versionableItem))||r.versionableItems.add(e))})),ae(e.removed).forEach((e=>{const t=e.featureServiceUrl,r=this.versioningStateLookup.get(t);if(!r)return void this._logError("version-management-view-model:execution-error","no-version-management-service-found");const i=r.versionableItems.find((t=>t.versionableItem===e.versionableItem));i&&r.versionableItems.remove(i)}))})())}async _createVersionInternal(e){var t,r,i,n,s;if("disabled"===this.state)throw this._logError("version-management-view-model:load-error",this.loadError),new o.Z("version-management-view-model:load-error",this.loadError);this._setExecutionError();const a=e.featureServerUrl,l=this.versioningStateLookup.get(a);if(!l)throw this._logError("version-management-view-model:execution-error","no-versioning-state-found"),new o.Z("version-management-view-model:execution-error",this.executionError);const u=this.advancedEditingUserTypeExtensionLookup.get(e.featureServerUrl),d=this.userLookup.get(a).toUpperCase(),c=this._isEmptyString(e.ownerName)?d:null===(t=e.ownerName)||void 0===t?void 0:t.trim().toUpperCase();if(c!==d){if(this.serverVersionLookup.get(a)<=11.1)throw this._logError("version-management-view-model:execution-error","versioning-api-error"),new o.Z("version-management-view-model:execution-error",this.executionError);if(!u)throw this._logError("version-management-view-model:execution-error","no-advanced-editing-user-type-extension"),new o.Z("version-management-view-model:execution-error",this.executionError)}let h=await(null===(r=this.versioningStateLookup.get(a))||void 0===r?void 0:r.getVersionInfos());if("SDE"===(null===c||void 0===c?void 0:c.toUpperCase())&&"DEFAULT"===e.versionName.toUpperCase()||null!==(i=h)&&void 0!==i&&i.find((t=>t.versionIdentifier.name.toUpperCase()===(c+"."+e.versionName).toUpperCase()||t.versionIdentifier.name.toUpperCase()===(d+"."+e.versionName).toUpperCase())))throw this._logError("version-management-view-model:execution-error","no-valid-version-name"),new o.Z("version-management-view-model:execution-error",this.executionError);const v=await l.versionManagementService.createVersion({versionName:e.versionName,access:c!==d?"public":e.access,description:e.description}).catch((e=>{throw this._logExecutionError(e),e}));if(c!==d){const{guid:t,name:r}=v.versionIdentifier,i={featureServerUrl:a,versionIdentifier:{guid:t,name:r},access:e.access,ownerName:c};await this.alterVersion(i)||this.deleteVersion(a,d+"."+e.versionName,v.versionIdentifier.guid)}return await this.getVersionInfos(a),h=await(null===(n=this.versioningStateLookup.get(a))||void 0===n?void 0:n.getVersionInfos()),null===(s=h)||void 0===s?void 0:s.find((e=>e.versionIdentifier.guid===v.versionIdentifier.guid))}async _deleteVersionInternal(e,t,r){if("disabled"===this.state)throw this._logError("version-management-view-model:load-error",this.loadError),new o.Z("version-management-view-model:load-error",this.loadError);this._setExecutionError();const i=this.versioningStateLookup.get(e);if(!i)throw this._logError("version-management-view-model:execution-error","no-versioning-state-found"),new o.Z("version-management-view-model:execution-error",this.executionError);if(this.serverVersionLookup.get(e)<=11.1)throw this._logError("version-management-view-model:execution-error","versioning-api-error"),new o.Z("version-management-view-model:execution-error",this.executionError);if(!this.advancedEditingUserTypeExtensionLookup.get(e))throw this._logError("version-management-view-model:execution-error","no-advanced-editing-user-type-extension"),new o.Z("version-management-view-model:execution-error",this.executionError);const n={name:t,guid:r};return await i.deleteVersion(n).catch((e=>{throw this._logExecutionError(e),new o.Z("version-management-view-model:execution-error",this.executionError)}))}async _getVersionInfosInternal(e){var t,r,i;if("disabled"===this.state)throw this._logError("version-management-view-model:load-error",this.loadError),new o.Z("version-management-view-model:load-error",this.loadError);this._setExecutionError();const n=null===(t=this.featureServiceLookup.get(e))||void 0===t?void 0:t.featureService;if(!n)throw this._logError("version-management-view-model:execution-error","no-feature-service-found"),new o.Z("version-management-view-model:execution-error",this.executionError);n.loaded||await n.load().catch((e=>{throw this._logExecutionError(e),e}));const s=n.url;this.serverVersionLookup.set(s,null!==(r=null===(i=n.sourceJSON)||void 0===i?void 0:i.currentVersion)&&void 0!==r?r:0),this.serverVersionLookup.get(s)<=11.1&&this.advancedEditingUserTypeExtensionLookup.set(s,!1);const a=this.userLookup.get(e);this._portalLookup.get(e)&&a?this.advancedEditingUserTypeExtensionLookup.set(s,await(0,m.Q)(this._portalLookup.get(e),a,"advediting")):this.advancedEditingUserTypeExtensionLookup.set(s,!1);const l=this.versioningStateLookup.get(e);if(!l)throw this._logError("version-management-view-model:execution-error","no-versioning-state-found"),new o.Z("version-management-view-model:execution-error",this.executionError);return l.loaded||await l.load().catch((e=>{throw this._logExecutionError(e),e})),await l.getVersionInfos(!0).catch((e=>{throw this._logExecutionError(e),e}))}_isEmptyString(e){return!e||0===e.trim().length}_logError(e,t){switch(a.Z.getLogger(this).error(new o.Z(e,t)),e){case"version-management-view-model:load-error":this._setLoadError(t);break;case"version-management-view-model:execution-error":this._setExecutionError(t)}}_logExecutionError(e){this._logError("version-management-view-model:execution-error",e.message)}async _viewChangeHandle(){this._updatingHandlesLoad.addPromise((async()=>{if(this._setLoadError(),!this.view)return void this._setLoadError("no-view-property");if(this.view&&"2d"!==this.view.type)return void this._logError("version-management-view-model:load-error","sceneView-not-supported");this.removeHandles("map-change-handle"),this.addHandles([(0,l.watch)((()=>{var e;return null===(e=this.view)||void 0===e?void 0:e.map}),(()=>{this._resetAllLookupProperties(),this._mapChangeHandle(this.versioningStates)}))],"map-change-handle");const e=await this._getVersioningStates();await this._mapChangeHandle(e)})())}async _mapChangeHandle(e){this._updatingHandlesLoad.addPromise((async()=>{this._setLoadError(),this.removeHandles("map-layers-tables-change-handle"),this.addHandles([(0,l.on)((()=>{var e;return null===(e=this.view)||void 0===e?void 0:e.map.allLayers}),"change",(e=>{(e.added.some((e=>{let{type:t}=e;return"feature"===t}))||e.removed.some((e=>{let{type:t}=e;return"feature"===t}))||e.added.some((e=>{let{type:t}=e;return"subtype-group"===t}))||e.removed.some((e=>{let{type:t}=e;return"subtype-group"===t})))&&(this._resetServiceRelatedLookupProperties(),this._propertiesChangeInternal(this.versioningStates),this._updateVersionableItems(e))})),(0,l.on)((()=>{var e;return null===(e=this.view)||void 0===e?void 0:e.map.allTables}),"change",(e=>{(e.added.some((e=>{let{type:t}=e;return"feature"===t}))||e.removed.some((e=>{let{type:t}=e;return"feature"===t}))||e.added.some((e=>{let{type:t}=e;return"subtype-group"===t}))||e.removed.some((e=>{let{type:t}=e;return"subtype-group"===t})))&&(this._resetServiceRelatedLookupProperties(),this._propertiesChangeInternal(this.versioningStates),this._updateVersionableItems(e))}))],"map-layers-tables-change-handle"),await this._propertiesChangeInternal(e)})())}async _propertiesChangeInternal(e){this._updatingHandlesLoad.addPromise((async()=>{const t=e=>"feature"===e.type,{allLayers:r,allTables:i}=this.view.map;if(this._setLoadError(),this.featureServiceLookup=$([...r.filter(t),...i.filter(t)]),this.featureServiceLookup.size){this._updateFeatureServiceLookup(e),this.serviceNameLookup=new Map;for(const e of this.featureServiceLookup.values()){const{featureService:t,featureService:{url:r}}=e;if(!this.serviceNameLookup.has(r)){var n;if(t.loaded||await t.load().catch((e=>{a.Z.getLogger(this).error(e)})),!t.versionManagementServiceUrl){this.featureServiceLookup.delete(r);continue}const e=await(0,v.oP)(r),i=new p.Z({authMode:"immediate",url:e});await i.load().catch((e=>{a.Z.getLogger(this).error(e)}));const s=null===(n=i.user)||void 0===n?void 0:n.username;if(!t.loaded||!i.loaded||!s)continue;this.serviceNameLookup.set((0,u.Qj)(r),r.split("/").at(-2)),this.userLookup.set(r,s),this._portalLookup.set(r,i)}}this.removeHandles("versioning-states-change-handle"),e.forEach((e=>this._handleVersioningStateLookupUpdate(e))),await this._updateVersioningStates(e),this.versioningStates=e}else this._logError("version-management-view-model:load-error","no-feature-services")})())}_updateFeatureServiceLookup(e){for(const t of e){const e=t.featureServiceUrl;if(!this.featureServiceLookup.has(e)){const r=new q({url:e}),i=t.versionableItems.toArray().flatMap((e=>"network"===e.type?null:e.versionableItem));this.featureServiceLookup.set(e,{featureService:r,layers:i})}}}async _updateVersioningStates(e){for(const t of this.featureServiceLookup.values()){const r=t.featureService;if(r.versionManagementServiceUrl){if(!e.find((e=>e.featureServiceUrl===r.url))&&r.versionManagementServiceUrl){const i=new s.Z(ae(t.layers)),n=new X({versionManagementService:new ue({url:r.versionManagementServiceUrl}),versionableItems:i});e.add(n),this._handleVersioningStateLookupUpdate(n)}await this.getVersionInfos(r.url)}}}async _getVersioningStates(){return this.versioningStates&&this.versioningStates.length?this.versioningStates:this.view?await ce(this.view,!1):(this._logError("version-management-view-model:load-error","no-view-property"),new s.Z)}_handleVersioningStateLookupUpdate(e){var t;this.versioningStateLookup.set(e.featureServiceUrl,e),this._addHandlesToVersioningState(e),this.versionIdentifierLookup.set(e.featureServiceUrl,null===(t=e.currentVersionInfo)||void 0===t?void 0:t.versionIdentifier),this.versionManagementServiceLookup.set(e.featureServiceUrl,e.versionManagementService)}async _setVersioningStatesLookups(){this._updatingHandlesLoad.addPromise((async()=>{this.versioningStates&&(this.removeHandles("versioning-states-change-handle"),this._updateFeatureServiceLookup(this.versioningStates),this.versioningStates.forEach((e=>this._handleVersioningStateLookupUpdate(e))),await this._updateVersioningStates(this.versioningStates))})())}_addHandlesToVersioningState(e){this.addHandles([(0,l.watch)((()=>e.versionInfos),(()=>{this.versionInfoLookup.set(e.featureServiceUrl,e.versionInfos)})),(0,l.watch)((()=>{var t;return null===(t=e.currentVersionInfo)||void 0===t?void 0:t.versionIdentifier}),(()=>{var t;this.versionIdentifierLookup.set(e.featureServiceUrl,null===(t=e.currentVersionInfo)||void 0===t?void 0:t.versionIdentifier)}))],"versioning-states-change-handle")}_resetVersioningLookupProperties(){this.versionIdentifierLookup=new Map,this.versionInfoLookup=new Map,this.versionManagementServiceLookup=new Map,this.versioningStateLookup=new Map}_resetAllLookupProperties(){this._portalLookup=new Map,this.advancedEditingUserTypeExtensionLookup=new Map,this.serverVersionLookup=new Map,this.userLookup=new Map,this.versioningStates=new s.Z,this._resetVersioningLookupProperties(),this._resetServiceRelatedLookupProperties()}_resetServiceRelatedLookupProperties(){this.featureServiceLookup=new Map,this.serviceNameLookup=new Map}_setExecutionError(e){this._set("executionError",e)}_setLoadError(e){this._set("loadError",e)}};(0,i._)([(0,d.Cb)()],he.prototype,"_portalLookup",void 0),(0,i._)([(0,d.Cb)()],he.prototype,"advancedEditingUserTypeExtensionLookup",void 0),(0,i._)([(0,d.Cb)({readOnly:!0})],he.prototype,"executionError",void 0),(0,i._)([(0,d.Cb)()],he.prototype,"featureServiceLookup",void 0),(0,i._)([(0,d.Cb)({readOnly:!0})],he.prototype,"loadError",void 0),(0,i._)([(0,d.Cb)()],he.prototype,"serverVersionLookup",void 0),(0,i._)([(0,d.Cb)()],he.prototype,"serviceNameLookup",void 0),(0,i._)([(0,d.Cb)({readOnly:!0})],he.prototype,"state",null),(0,i._)([(0,d.Cb)()],he.prototype,"userLookup",void 0),(0,i._)([(0,d.Cb)()],he.prototype,"versionIdentifierLookup",void 0),(0,i._)([(0,d.Cb)()],he.prototype,"versionInfoLookup",void 0),(0,i._)([(0,d.Cb)()],he.prototype,"versionManagementServiceLookup",void 0),(0,i._)([(0,d.Cb)()],he.prototype,"versioningStateLookup",void 0),(0,i._)([(0,d.Cb)()],he.prototype,"view",void 0),(0,i._)([(0,d.Cb)()],he.prototype,"versioningStates",void 0),he=(0,i._)([(0,c.j)("esri.widgets.VersionManagement.VersionManagementViewModel")],he);const ve=he}}]);
//# sourceMappingURL=66027.d2b9f90a.chunk.js.map