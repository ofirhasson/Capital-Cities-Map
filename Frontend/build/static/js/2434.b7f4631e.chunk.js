"use strict";(self.webpackChunknorthwind=self.webpackChunknorthwind||[]).push([[2434],{50690:(e,t,i)=>{i.d(t,{A:()=>d,a:()=>p,b:()=>u});var n,r,s,a=i(30168),o=i(24967),l=i(98634),h=i(64201),c=i(19253);class d extends l.K{}function u(e){const t=new h.kG;t.include(o.k),t.fragment.uniforms.add(new c.A("colorTexture",(e=>e.color)),new c.A("depthTexture",(e=>e.depth)));const i=e.haze;return t.fragment.code.add((0,l.H)(n||(n=(0,a.Z)(["\n    void main() {\n      float depthSample = texture(depthTexture, uv).r;\n      if (depthSample "," ) {\n          fragColor = vec4(0);\n          return;\n      }\n      fragColor = texture(colorTexture, uv);\n    }\n    "])),i?(0,l.H)(r||(r=(0,a.Z)(["== 1.0"]))):(0,l.H)(s||(s=(0,a.Z)(["!= 1.0"]))))),t}const p=Object.freeze(Object.defineProperty({__proto__:null,AtmosphereCompositingPassParameters:d,build:u},Symbol.toStringTag,{value:"Module"}))},86868:(e,t,i)=>{i.d(t,{B:()=>y,a:()=>o,b:()=>v});var n,r,s,a,o,l=i(30168),h=i(91835),c=i(8966),d=i(63434),u=i(32426),p=i(49450),_=i(58406),m=i(98634),g=i(64201),f=i(19253);function v(e){const t=new g.kG,i=t.fragment;if(t.include(u.T),e.background===o.Only){const a=e.output===c.l.ColorComposite;return a?i.uniforms.add(new p.J("backgroundColor",(e=>e.backgroundColor))):i.include(h.H),i.code.add((0,m.H)(n||(n=(0,l.Z)(["\n      void main() {\n        fragColor = vec4(",", 1.0);\n      }\n    "])),a?(0,m.H)(r||(r=(0,l.Z)(["backgroundColor"]))):(0,m.H)(s||(s=(0,l.Z)(["gridColor(uv)"]))))),t}return t.include(d.J,e),i.uniforms.add(new f.A("tex",(e=>e.texture)),new _.p("opacity",(e=>e.opacity))).code.add((0,m.H)(a||(a=(0,l.Z)(["void main() {\nfragColor = blendLayers(uv, texture(tex, uv), opacity);\n}"])))),t}!function(e){e[e.BelowLayer=0]="BelowLayer",e[e.Only=1]="Only",e[e.COUNT=2]="COUNT"}(o||(o={}));const y=Object.freeze(Object.defineProperty({__proto__:null,get BackgroundMode(){return o},build:v},Symbol.toStringTag,{value:"Module"}))},98757:(e,t,i)=>{i.d(t,{B:()=>d,b:()=>c});var n,r=i(30168),s=i(24967),a=i(98634),o=i(64201),l=i(19253);const h={maxSearchSteps:8,maxDistanceAreaTex:16};function c(){const e=new o.kG;return e.include(s.k),e.fragment.uniforms.add(new l.A("edgesTexture",(e=>e.inputTexture)),new l.A("areaTexture",(e=>e.areaTexture)),new l.A("searchTexture",(e=>e.searchTexture))),e.fragment.code.add((0,a.H)(n||(n=(0,r.Z)(["\n    #define SMAA_AREATEX_PIXEL_SIZE ( 1.0 / vec2( 160.0, 560.0 ) )\n    #define SMAA_AREATEX_SUBTEX_SIZE ( 1.0 / 7.0 )\n\n    vec4 sampleLevelZeroOffset(sampler2D tex, vec2 coord, vec2 offset, vec2 resolution) {\n      return texture(tex, coord + offset.x * resolution, 0.0);\n    }\n\n    float searchLength(sampler2D searchTex, vec2 e, float bias, float scale) {\n      e.r = bias + e.r * scale;\n      return 255.0 * texture( searchTex, e, 0.0 ).r;\n    }\n\n    float searchLeft( sampler2D edgesTex, sampler2D searchTex, vec2 texcoord, float end, vec2 resolution ) {\n      vec2 e = vec2( 0.0, 1.0 );\n      for ( int i = 0; i < ","; i ++ ) {\n        e = texture( edgesTex, texcoord, 0.0 ).rg;\n        texcoord -= vec2( 2.0, 0.0 ) * resolution;\n        if ( ! ( texcoord.x > end && e.g > 0.8281 && e.r == 0.0 ) ) break;\n      }\n      texcoord.x += 0.25 * resolution.x;\n      texcoord.x += resolution.x;\n      texcoord.x += 2.0 * resolution.x;\n      texcoord.x -= resolution.x * searchLength(searchTex, e, 0.0, 0.5);\n      return texcoord.x;\n    }\n\n    float searchRight( sampler2D edgesTex, sampler2D searchTex, vec2 texcoord, float end, vec2 resolution ) {\n      vec2 e = vec2( 0.0, 1.0 );\n      for ( int i = 0; i < ","; i ++ ) {\n        e = texture( edgesTex, texcoord, 0.0 ).rg;\n        texcoord += vec2( 2.0, 0.0 ) * resolution;\n        if ( ! ( texcoord.x < end && e.g > 0.8281 && e.r == 0.0 ) ) break;\n      }\n      texcoord.x -= 0.25 * resolution.x;\n      texcoord.x -= resolution.x;\n      texcoord.x -= 2.0 * resolution.x;\n      texcoord.x += resolution.x * searchLength( searchTex, e, 0.5, 0.5 );\n      return texcoord.x;\n    }\n\n    float searchUp( sampler2D edgesTex, sampler2D searchTex, vec2 texcoord, float end, vec2 resolution ) {\n      vec2 e = vec2( 1.0, 0.0 );\n      for ( int i = 0; i < ","; i ++ ) {\n        e = texture( edgesTex, texcoord, 0.0 ).rg;\n        texcoord += vec2( 0.0, 2.0 ) * resolution;\n        if ( ! ( texcoord.y > end && e.r > 0.8281 && e.g == 0.0 ) ) break;\n      }\n      texcoord.y -= 0.25 * resolution.y;\n      texcoord.y -= resolution.y;\n      texcoord.y -= 2.0 * resolution.y;\n      texcoord.y += resolution.y * searchLength( searchTex, e.gr, 0.0, 0.5 );\n      return texcoord.y;\n    }\n\n    float searchYDown( sampler2D edgesTex, sampler2D searchTex, vec2 texcoord, float end, vec2 resolution ) {\n      vec2 e = vec2( 1.0, 0.0 );\n      for ( int i = 0; i < ","; i ++ ) {\n        e = texture( edgesTex, texcoord, 0.0 ).rg;\n        texcoord -= vec2( 0.0, 2.0 ) * resolution;\n        if ( ! ( texcoord.y < end && e.r > 0.8281 && e.g == 0.0 ) ) break;\n      }\n      texcoord.y += 0.25 * resolution.y;\n      texcoord.y += resolution.y;\n      texcoord.y += 2.0 * resolution.y;\n      texcoord.y -= resolution.y * searchLength( searchTex, e.gr, 0.5, 0.5 );\n      return texcoord.y;\n    }\n\n    vec2 getArea( sampler2D areaTex, vec2 dist, float e1, float e2, float offset ) {\n      vec2 texcoord = float( "," ) * round( 4.0 * vec2( e1, e2 ) ) + dist;\n      texcoord = SMAA_AREATEX_PIXEL_SIZE * texcoord + ( 0.5 * SMAA_AREATEX_PIXEL_SIZE );\n      texcoord.y += SMAA_AREATEX_SUBTEX_SIZE * offset;\n      return texture( areaTex, texcoord, 0.0 ).rg;\n    }\n\n    void main() {\n      vec2 size = vec2(textureSize(edgesTexture, 0));\n      vec2 resolution = 1.0 / size;\n      vec2 pixelCoord = uv * size;\n      vec4 offsets[2];\n      offsets[0] = uv.xyxy + resolution.xyxy * vec4( -0.25, 0.125, 1.25, 0.125 );\n      offsets[1] = uv.xyxy + resolution.xyxy * vec4( -0.125, 0.25, -0.125, -1.25 );\n      vec4 maxOffset = vec4( offsets[0].xz, offsets[1].yw ) + vec4( -2.0, 2.0, -2.0, 2.0 ) * resolution.xxyy * float( "," );\n\n      ivec4 subsampleIndices = ivec4(0.0);\n      vec4 weights = vec4(0.0);\n      vec2 e = texture( edgesTexture, uv ).rg;\n      if ( e.g > 0.0 ) {\n        vec2 d;\n        vec2 coords;\n        coords.x = searchLeft( edgesTexture, searchTexture, offsets[0].xy, maxOffset.x, resolution );\n        coords.y = offsets[1].y;\n        d.x = coords.x;\n        float e1 = texture( edgesTexture, coords, 0.0 ).r;\n        coords.x = searchRight( edgesTexture, searchTexture, offsets[0].zw, maxOffset.y, resolution );\n        d.y = coords.x;\n        d = d * size.x - pixelCoord.x;\n        vec2 sqrt_d = sqrt( abs(d) );\n        coords.y -= 1.0 * resolution.y;\n        float e2 = sampleLevelZeroOffset( edgesTexture, coords, vec2( 1.0, 0.0 ), resolution).r;\n        weights.rg = getArea( areaTexture, sqrt_d, e1, e2, float( subsampleIndices.y ) );\n      }\n\n      if ( e.r > 0.0 ) {\n        vec2 d;\n        vec2 coords;\n        coords.y = searchUp( edgesTexture, searchTexture, offsets[1].xy, maxOffset.z, resolution );\n        coords.x = offsets[0].x;\n        d.x = coords.y;\n        float e1 = texture( edgesTexture, coords, 0.0 ).g;\n        coords.y = searchYDown( edgesTexture, searchTexture, offsets[1].zw, maxOffset.w, resolution );\n        d.y = coords.y;\n        d = d * size.y - pixelCoord.y;\n        vec2 sqrt_d = sqrt(abs(d));\n        coords.y -= 1.0 * resolution.y;\n        float e2 = sampleLevelZeroOffset( edgesTexture, coords, vec2(0.0, 1.0), resolution).g;\n        weights.ba = getArea( areaTexture, sqrt_d, e1, e2, float( subsampleIndices.x ) );\n\n        // for some reason the following lines are necessary to prevent\n        // texture lookup precision issues on some Intel integrated graphics chips\n        vec4 dbg = (offsets[0] + offsets[1] + maxOffset + coords.xyyx);\n        weights.r += 0.00000001 * dot(vec4(0, 1, 0, 1), dbg);\n      }\n      fragColor = weights;\n    }"])),a.H.int(h.maxSearchSteps),a.H.int(h.maxSearchSteps),a.H.int(h.maxSearchSteps),a.H.int(h.maxSearchSteps),a.H.int(h.maxDistanceAreaTex),a.H.int(h.maxSearchSteps))),e}const d=Object.freeze(Object.defineProperty({__proto__:null,build:c},Symbol.toStringTag,{value:"Module"}))},40051:(e,t,i)=>{i.d(t,{B:()=>c,b:()=>h});var n,r=i(30168),s=i(24967),a=i(98634),o=i(64201),l=i(19253);function h(){const e=new o.kG;return e.include(s.k),e.fragment.uniforms.add(new l.A("blendWeightsTexture",(e=>e.inputTexture)),new l.A("colorTexture",(e=>e.color))),e.fragment.code.add((0,a.H)(n||(n=(0,r.Z)(["void main() {\nvec2 resolution = 1.0 / vec2(textureSize(colorTexture, 0));\nvec4 offsets = vec4(uv.x + resolution.x, uv.y, uv.x, uv.y - resolution.y);\nvec4 a;\na.rb = texture(blendWeightsTexture, uv).rb;\na.g = texture(blendWeightsTexture, offsets.zw).g;\na.a = texture(blendWeightsTexture, offsets.xy).a;\nif ( dot(a, vec4(1.0)) < 1e-5 ) {\nfragColor = texture( colorTexture, uv, 0.0 );\n} else {\nvec2 offset;\noffset.x = a.a > a.b ? a.a : -a.b;\noffset.y = a.g > a.r ? -a.g : a.r;\nif ( abs( offset.x ) > abs( offset.y )) {\noffset.y = 0.0;\n} else {\noffset.x = 0.0;\n}\nvec4 C = texture( colorTexture, uv, 0.0 );\nvec4 Cop = texture( colorTexture, uv + sign( offset ) * resolution.xy, 0.0 );\nfloat s = abs( offset.x ) > abs( offset.y ) ? abs( offset.x ) : abs( offset.y );\nfragColor = mix(C, Cop, s);\n}\n}"])))),e}const c=Object.freeze(Object.defineProperty({__proto__:null,build:h},Symbol.toStringTag,{value:"Module"}))},39073:(e,t,i)=>{i.d(t,{C:()=>W,a:()=>Z,b:()=>z});var n,r,s,a,o,l,h,c,d,u,p,_,m,g,f,v,y,b,w,C,x=i(30168),T=i(29134),S=i(7025),P=i(12400),M=i(5461),R=i(60113),A=i(54943),O=i(29202),E=i(92395),D=i(82999),I=i(49450),L=i(95276),N=i(58406),U=i(98634),H=i(8654),F=i(64201),V=i(19253),q=i(4760);const z=(0,P.al)(parseFloat(Number(5802e-9).toFixed(6)),parseFloat(Number(13558e-9).toFixed(6)),parseFloat(Number(331e-7).toFixed(6))),B=(0,P.al)(3*parseFloat(Number(65e-8).toFixed(6)),3*parseFloat(Number(1881e-9).toFixed(6)),3*parseFloat(Number(85e-9).toFixed(6))),G=3996e-9,k=(0,P.al)(parseFloat(Number(z[0]+B[0]).toFixed(6)),parseFloat(Number(z[1]+B[1]).toFixed(6)),parseFloat(Number(z[2]+B[2]).toFixed(6)));function Z(e){const t=new F.kG;t.attributes.add(q.T.POSITION,"vec2"),t.include(R.D,{textureCoordinateType:R.N.Default}),t.varyings.add("worldRay","vec3"),t.varyings.add("eyeDir","vec3");const{vertex:i,fragment:S}=t;return i.uniforms.add(new H.g("inverseProjectionMatrix",((e,t)=>t.camera.inverseProjectionMatrix)),new H.g("inverseViewMatrix",((e,t)=>(0,T.iS)(j,t.camera.viewMatrix)))),i.code.add((0,U.H)(n||(n=(0,x.Z)(["void main(void) {\nvec3 posViewNear = (inverseProjectionMatrix * vec4(position, -1, 1)).xyz;\neyeDir = posViewNear;\nworldRay = (inverseViewMatrix * vec4(posViewNear, 0)).xyz;\nforwardTextureCoordinates();\ngl_Position = vec4(position, 1, 1);\n}"])))),S.uniforms.add(new I.J("backgroundColor",(e=>e.backgroundColor)),new D.A("radii",(e=>e.radii)),new I.J("cameraPosition",((e,t)=>t.camera.eye)),new L.N("heightParameters",(e=>e.heightParameters)),new N.p("innerFadeDistance",(e=>e.innerFadeDistance)),new N.p("altitudeFade",(e=>e.altitudeFade)),new V.A("depthTexture",(e=>e.depthTexture)),new N.p("hazeStrength",(e=>e.hazeStrength))),S.constants.add("betaRayleigh","vec3",z),S.constants.add("betaCombined","vec3",k),S.constants.add("betaMie","float",G),S.constants.add("scaleHeight","float",M.TR*M.k8),(0,E.Pe)(S),t.include(O.D),e.haze&&S.include(A.K),S.code.add((0,U.H)(r||(r=(0,x.Z)(["vec2 sphereIntersect(vec3 start, vec3 dir, float radius, bool planet) {\nfloat a = dot(dir, dir);\nfloat b = 2.0 * dot(dir, start);\nfloat c = planet ? heightParameters[1] - radius * radius : heightParameters[2];\nfloat d = (b * b) - 4.0 * a * c;\nif (d < 0.0) {\nreturn vec2(1e5, -1e5);\n}\nreturn vec2((-b - sqrt(d)) / (2.0 * a), (-b + sqrt(d)) / (2.0 * a));\n}"])))),S.code.add((0,U.H)(s||(s=(0,x.Z)(["float chapmanApproximation(float X, float h, float cosZenith) {\nfloat c = sqrt(X + h);\nfloat cExpH = c * exp(-h);\nif (cosZenith >= 0.0) {\nreturn cExpH / (c * cosZenith + 1.0);\n} else {\nfloat x0 = sqrt(1.0 - cosZenith * cosZenith) * (X + h);\nfloat c0 = sqrt(x0);\nreturn 2.0 * c0 * exp(X - x0) - cExpH / (1.0 - c * cosZenith);\n}\n}"])))),S.code.add((0,U.H)(a||(a=(0,x.Z)(["float getOpticalDepth(vec3 position, vec3 dir, float h) {\nreturn scaleHeight * chapmanApproximation(radii[0] / scaleHeight, h, dot(normalize(position), dir));\n}"])))),S.code.add((0,U.H)(o||(o=(0,x.Z)(["\n    const int STEPS = 6;\n\n    vec3 getAtmosphereColour(vec3 cameraPos, vec3 rayDir, vec3 lightDir, float terrainDepth) {\n      float reducedPlanetRadius = radii[0] - 20000.0;\n      vec2 rayPlanetIntersect = sphereIntersect(cameraPos, rayDir, reducedPlanetRadius, true);\n      vec2 rayAtmosphereIntersect = sphereIntersect(cameraPos, rayDir, radii[1], false);\n      bool hitsAtmosphere = (rayAtmosphereIntersect.x <= rayAtmosphereIntersect.y) && rayAtmosphereIntersect.x > 0.0;\n      bool insideAtmosphere = heightParameters[0] < radii[1];\n\n      if (!(hitsAtmosphere || insideAtmosphere)) {\n        return vec3(0);\n      }\n\n      bool hitsPlanet = (rayPlanetIntersect.x <= rayPlanetIntersect.y) && rayPlanetIntersect.x > 0.0;\n\n      float start = insideAtmosphere ? 0.0 : rayAtmosphereIntersect.x;\n\n      if (heightParameters[0] < reducedPlanetRadius) {\n        // Long light rays from the night side of the planet lead to numerical instability\n        // Do not render the atmosphere in such cases\n        if (dot(rayDir, normalize(cameraPos)) < -0.025) {\n          return vec3(0);\n        }\n        start = rayPlanetIntersect.y;\n      }\n\n      float end = hitsPlanet ? rayPlanetIntersect.x : rayAtmosphereIntersect.y;\n      float maxEnd = end;\n\n      ","\n\n      vec3 samplePoint = cameraPos + rayDir * end;\n      float multiplier = hitsPlanet ? -1.0 : 1.0;\n\n      vec3 scattering = vec3(0);\n      float scaleFract = (length(samplePoint) - radii[0]) / scaleHeight;\n      float lastOpticalDepth = getOpticalDepth(samplePoint, rayDir, scaleFract);\n      float stepSize = (end - start) / float(STEPS);\n      for (int i = 0; i < STEPS; i++) {\n        samplePoint -= stepSize * rayDir;\n        scaleFract = (length(samplePoint) - radii[0]) / scaleHeight;\n        float opticalDepth = multiplier * getOpticalDepth(samplePoint, rayDir * multiplier, scaleFract);\n\n        if (i > 0) {\n          scattering *= "," exp(-(mix(betaCombined, betaRayleigh, 0.5) + betaMie) * max(0.0, (opticalDepth - lastOpticalDepth)));\n        }\n\n        if (dot(normalize(samplePoint), lightDir) > -0.3) {\n\n          float scale = exp(-scaleFract);\n          float lightDepth = getOpticalDepth(samplePoint, lightDir, scaleFract);\n\n          scattering += scale * exp(-(betaCombined + betaMie) * lightDepth);\n          ","\n        }\n\n        lastOpticalDepth = opticalDepth;\n\n      }\n\n      float mu = dot(rayDir, lightDir);\n      float mumu = 1.0 + mu * mu;\n\n      float phaseRayleigh = 0.0596831 * mumu;\n\n      ","\n    }\n\n    ","\n\n    ","\n\n    vec3 tonemapACES(vec3 x) {\n      return clamp((x * (2.51 * x + 0.03)) / (x * (2.43 * x + 0.59) + 0.14), 0.0, 1.0);\n    }\n\n    void main() {\n      vec3 rayDir = normalize(worldRay);\n      float terrainDepth = -1.0;\n      ","\n\n      ","\n\n      col = tonemapACES(col);\n      fragColor = delinearizeGamma(vec4(col, alpha));\n      ","\n    }\n  "])),e.haze?(0,U.H)(l||(l=(0,x.Z)(["if (terrainDepth != -1.0) { end = terrainDepth; }"]))):"",e.haze?"":(0,U.H)(h||(h=(0,x.Z)(["mix(2.5, 1.0, clamp((length(cameraPos) - radii[0]) / 50e3, 0.0, 1.0)) * "]))),e.haze?"":(0,U.H)(c||(c=(0,x.Z)(["scattering += scale * exp(-(0.25 * betaCombined ) * lightDepth);"]))),e.haze?(0,U.H)(d||(d=(0,x.Z)(["return 3.0 * scattering * stepSize * phaseRayleigh * betaRayleigh;"]))):(0,U.H)(u||(u=(0,x.Z)(["\n            const float g = 0.8;\n            const float gg = g * g;\n            float phaseMie = end == maxEnd ? 0.1193662 * ((1.0 - gg) * mumu) / (pow(1.0 + gg - 2.0 * mu * g, 1.5) * (2.0 + gg)) : 0.0;\n            phaseMie = clamp(phaseMie, 0.0, 128.0);\n            return 3.0 * scattering * stepSize * (phaseRayleigh * betaRayleigh + 0.025 * phaseMie * betaMie);"]))),e.haze?"":(0,U.H)(p||(p=(0,x.Z)(["\n            vec4 applyUndergroundAtmosphere(vec3 rayDir, vec3 lightDirection, vec4 fragColor) {\n              vec2 rayPlanetIntersect = sphereIntersect(cameraPosition, rayDir, radii[0], true);\n              if (!((rayPlanetIntersect.x <= rayPlanetIntersect.y) && rayPlanetIntersect.y > 0.0)) {\n                return fragColor;\n              }\n\n              float lightAngle = dot(lightDirection, normalize(cameraPosition + rayDir * max(0.0, rayPlanetIntersect.x)));\n              vec4 surfaceColor = vec4(vec3(max(0.0, (smoothstep(-1.0, 0.8, 2.0 * lightAngle)))), 1.0 - altitudeFade);\n              float relDist = (rayPlanetIntersect.y - max(0.0, rayPlanetIntersect.x)) / innerFadeDistance;\n              if (relDist > 1.0) {\n                return surfaceColor;\n              }\n\n              return mix(fragColor, surfaceColor, smoothstep(0.0, 1.0, relDist * relDist));\n            }\n\n            float getGlow(float dist, float radius, float intensity) {\n              return pow(radius / max(dist, 1e-6), intensity);\n            }\n\n            vec3 getSun(vec3 cameraPos, vec3 rayDir, vec3 lightDir){\n\n              // Get the amount of atmosphere between camera and the Sun along the view ray\n              float scaleFract = (length(cameraPos) - radii[0]) / scaleHeight;\n              float sunOpticalDepth = getOpticalDepth(cameraPos, rayDir, max(scaleFract, 0.0));\n\n              // Find the amount of light that remains after travelling through the atmosphere from the Sun along the view ray\n              // This will make the colour of the Sun reddish on the horizon and white from space\n              vec3 sunTransmittance = exp(-(mix(betaCombined, betaRayleigh, 0.5)) * max(0.0, sunOpticalDepth));\n\n              // Alignment of light direction and view ray\n              float mu = clamp(dot(rayDir, lightDir), 0.0, 1.0);\n              // Draw the Sun as a bright disc\n              float sunDisc = 256.0 * smoothstep(0.0, 128.0, clamp(getGlow(1.0 - mu, 3e-5, 3.0), 0.0, 128.0));\n\n              return normalize(sunTransmittance) * sunDisc;\n            }"]))),e.haze&&e.reduced?(0,U.H)(_||(_=(0,x.Z)(["\n        float getDepth(vec2 uv){\n          return linearDepthFromTexture(depthTexture, uv);\n        }\n\n        float textureBilinear(vec2 uv) {\n          // Information about the high-resolution depth texture\n          vec2 depthTextureSize = vec2(textureSize(depthTexture, 0));\n          vec2 texelSize = 1.0 / depthTextureSize;\n\n          // The uv inside the upper right pixel - of the tile of 4 pixels -\n          // that the atmosphere uv maps to in the depth texture\n          vec2 depthUV = (uv * depthTextureSize) - vec2(0.5);\n\n          // Relative distance of the uv coordinates inside the depth texture pixel\n          vec2 f = fract(depthUV);\n\n          // Snap to the centre of the depth texture pixel\n          vec2 snapUV = (floor(depthUV) + vec2(0.5)) / depthTextureSize;\n\n          // Read the depth texture pixel and its three neighbours\n          float d0 = getDepth(snapUV);\n          float d1 = getDepth(snapUV + vec2(texelSize.x, 0.0));\n          float d2 = getDepth(snapUV + vec2(0.0, texelSize.y));\n          float d3 = getDepth(snapUV + texelSize);\n\n          // Return the bilinearly interpolated value of the neighbouring pixels based\n          // on the sample position in the depth texture pixel\n          return mix(mix(d0, d1, f.x), mix(d2, d3, f.x), f.y);\n        }\n        "]))):"",e.haze?(0,U.H)(m||(m=(0,x.Z)(["\n          float depthSample = texture(depthTexture, vuv0).r;\n          if (depthSample != 1.0) {\n            vec3 cameraSpaceRay = normalize(eyeDir);\n            cameraSpaceRay /= cameraSpaceRay.z;\n\n              ","\n\n            terrainDepth = max(0.0, length(cameraSpaceRay));\n          }else{\n            discard;\n          }\n          "])),e.reduced?(0,U.H)(g||(g=(0,x.Z)(["cameraSpaceRay *= -textureBilinear(vuv0);"]))):(0,U.H)(f||(f=(0,x.Z)(["cameraSpaceRay *= -linearDepthFromTexture(depthTexture, vuv0);"])))):(0,U.H)(v||(v=(0,x.Z)(["",""])),e.reduced?"":(0,U.H)(y||(y=(0,x.Z)(["\n                float depthSample = texture(depthTexture, vuv0).r;\n                if (depthSample != 1.0) {\n                  fragColor = vec4(0);\n                  return;\n                }"])))),e.haze?(0,U.H)(b||(b=(0,x.Z)(["\n            vec3 col = vec3(0);\n            float fadeOut = smoothstep(-10000.0, -15000.0, heightParameters[0] - radii[0]);\n            if(depthSample != 1.0){\n              col = (1.0 - fadeOut) * hazeStrength * getAtmosphereColour(cameraPosition, rayDir, mainLightDirection, terrainDepth);\n            }\n            // Alpha is ignored for haze blending\n            float alpha = 1.0;\n            "]))):(0,U.H)(w||(w=(0,x.Z)(["\n            vec3 col = linearizeGamma(backgroundColor);\n            col += getAtmosphereColour(cameraPosition, rayDir, mainLightDirection, terrainDepth);\n            col += getSun(cameraPosition, rayDir, mainLightDirection);\n            float alpha = smoothstep(0.0, mix(0.15, 0.01, heightParameters[3]), length(col));"]))),e.haze?"":(0,U.H)(C||(C=(0,x.Z)(["fragColor = applyUndergroundAtmosphere(rayDir, mainLightDirection, fragColor);"]))))),t}const j=(0,S.Ue)(),W=Object.freeze(Object.defineProperty({__proto__:null,betaRayleigh:z,build:Z},Symbol.toStringTag,{value:"Module"}))},50703:(e,t,i)=>{i.d(t,{C:()=>R,a:()=>E,b:()=>A});var n,r,s,a,o,l,h,c,d,u,p=i(30168),_=i(16889),m=i(21389),g=i(13611),f=i(6644),v=i(12658),y=i(20460),b=i(68820),w=i(24967),C=i(82999),x=i(58406),T=i(98634),S=i(35522),P=i(64201),M=i(19253);class R extends T.K{constructor(){super(...arguments),this.cloudRadius=0,this.cloudSize=0,this.detailSize=0,this.absorption=0,this.density=0,this.smoothness=0,this.cloudHeight=0,this.coverage=0,this.raymarchingSteps=v.L.default.raymarchingSteps,this.weatherTile=(0,f.Ue)(),this.viewMatrix=(0,m.Ue)()}}function A(e){const t=new P.kG;t.include(w.k,!1);const i=t.fragment;return i.uniforms.add(new x.p("cloudRadius",(e=>e.cloudRadius)),new x.p("power",(e=>(0,_.t7)(35,120,e.absorption))),new x.p("sigmaE",(e=>1+e.absorption)),new x.p("density",(e=>(0,_.t7)(0,.3,e.density))),new x.p("cloudSize",(e=>(0,_.t7)(0,.02,Math.max(.01,1-e.cloudSize)))),new x.p("detailSize",(e=>(0,_.t7)(0,.2,Math.max(.01,1-e.detailSize)))),new x.p("smoothness",(e=>(0,_.t7)(0,.5,1-e.smoothness))),new x.p("cloudHeight",(e=>(0,_.t7)(0,1500,e.cloudHeight))),new x.p("coverage",(e=>e.coverage)),new S.c("view",(e=>e.viewMatrix)),new M.A("cloudShapeTexture",(e=>null!=e.noiseTexture?e.noiseTexture.textureAtlas:null)),new C.A("cloudVariables",(e=>(0,g.t8)(O,e.coverage,e.absorption)))),i.constants.add("halfCubeMapSize","float",.5*e.cubeMapSize),i.code.add((0,T.H)(n||(n=(0,p.Z)(["\n    const int STEPS = ",";\n    const int STEPS_LIGHT = 6;\n    const float stepL = 300.0 / float(STEPS_LIGHT);\n    const float cloudStart = 1500.0;\n\n    vec3 rayDirection(vec2 fragCoord) {\n      vec2 xy = fragCoord - halfCubeMapSize;\n      return normalize(vec3(-xy, -halfCubeMapSize));\n    }\n\n    float remap(float x, float low1, float high1, float low2, float high2) {\n      return low2 + (x - low1) * (high2 - low2) / (high1 - low1);\n    }\n\n    float saturate(float x) {\n      return clamp(x, 0.0, 1.0);\n    }"])),e.steps===y.p.SIXTEEN?(0,T.H)(r||(r=(0,p.Z)(["16"]))):e.steps===y.p.HUNDRED?(0,T.H)(s||(s=(0,p.Z)(["100"]))):(0,T.H)(a||(a=(0,p.Z)(["200"]))))),i.code.add((0,T.H)(o||(o=(0,p.Z)(["\n    float getCloudShape(vec3 pos, float pOffset) {\n      const float textureWidth = ",";\n      const float dataWidth = ",";\n      const float tileRows = ",";\n      const vec3 atlasDimensions = vec3(",", ",", tileRows * tileRows);\n\n      //Change from Y being height to Z being height\n      vec3 p = float(",") * pos.xzy;\n\n      //Pixel coordinates of point in the 3D data\n      vec3 coord = vec3(mod(p - pOffset * atlasDimensions, atlasDimensions));\n      float f = fract(coord.z);\n      float level = floor(coord.z);\n      float tileY = floor(level / tileRows);\n      float tileX = level - tileY * tileRows;\n\n      //The data coordinates are offset by the x and y tile, the two boundary cells between each tile pair and the initial boundary cell on the first row/column\n      vec2 offset = atlasDimensions.x * vec2(tileX, tileY) + 2.0 * vec2(tileX, tileY) + 1.0;\n      vec2 pixel = coord.xy + offset;\n      vec2 data = texture(cloudShapeTexture, mod(pixel, dataWidth) / textureWidth).xy;\n\n      return 1.0 - mix(data.x, data.y, f);\n    }\n\n    float getCloudMap(vec2 p){\n      // Shift the texture center to origin to avoid seam artifacts\n      vec2 uv = ("," * p) / "," + 0.5;\n\n      return texture(cloudShapeTexture, uv).a;\n    }\n    "])),T.H.float(b.a5),T.H.float(b.a5),T.H.float(b.CB),T.H.float(b.i9),T.H.float(b.i9),T.H.float(b.Mw),T.H.float(b.H6),T.H.float(b.a5))),i.code.add((0,T.H)(l||(l=(0,p.Z)(["float clouds(vec3 p) {\nfloat cloud = saturate(0.5 * mix(0.0, 1.0, min(2.0 * coverage, 1.0)));\nif (cloud <= 0.0) {\nreturn 0.0;\n}\nfloat cloudMap = getCloudMap(cloudSize * p.xy);\ncloud = mix(cloud, min(2.0 * (coverage), 1.0) * cloudMap, min(2.0 * (1.0 - coverage), 1.0));\nif (cloud <= 0.0) {\nreturn 0.0;\n}\nfloat shape = getCloudShape(8.0 * cloudSize * p, 0.0);\ncloud = saturate(remap(cloud, smoothness * shape, 1.0, 0.0, 1.0));\nif (cloud <= 0.0) {\nreturn 0.0;\n}\nfloat heightFraction = saturate((length(p) - cloudRadius - cloudStart) / cloudHeight);\ncloud *= saturate(remap(heightFraction, 0.0, 0.25, 0.0, 1.0)) * smoothstep(1.0, 0.25, heightFraction);\nif (cloud <= 0.0) {\nreturn 0.0;\n}\nreturn density * saturate(remap(cloud, 0.35 * smoothness * getCloudShape(detailSize * p, 0.0), 1.0, 0.0, 1.0));\n}"])))),i.code.add((0,T.H)(h||(h=(0,p.Z)(["vec2 sphereIntersections(vec3 start, vec3 dir, float radius) {\nfloat a = dot(dir, dir);\nfloat b = 2.0 * dot(dir, start);\nfloat c = dot(start, start) - (radius * radius);\nfloat d = (b * b) - 4.0 * a * c;\nif (d < 0.0) {\nreturn vec2(1e5, -1e5);\n}\nreturn vec2((-b - sqrt(d)) / (2.0 * a), (-b + sqrt(d)) / (2.0 * a));\n}\nfloat HenyeyGreenstein(float g, float costh) {\nreturn (1.0 / (4.0 * 3.1415))  * ((1.0 - g * g) / pow(1.0 + g * g - 2.0 * g * costh, 1.5));\n}"])))),i.code.add("\n    float multipleOctaves(float extinction, float mu, float stepL) {\n      float attenuation = 1.0;\n      float contribution = 1.0;\n      float phaseAttenuation = 1.0;\n      float luminance = 0.0;\n\n      for (int i = 0; i < 4; i++) {\n        float phase = mix(HenyeyGreenstein(0.0, mu), HenyeyGreenstein(0.3 * phaseAttenuation, mu), 0.7);\n        luminance += contribution * phase * exp(-stepL * extinction * sigmaE * attenuation);\n        attenuation *= 0.2;\n        contribution *= 0.6;\n        phaseAttenuation *= 0.5;\n      }\n\n      return luminance;\n    }"),i.code.add((0,T.H)(c||(c=(0,p.Z)(["float lightRay(vec3 org, vec3 p, float phaseFunction, float mu, vec3 sunDirection) {\nfloat lightRayDensity = clouds(p);\nlightRayDensity += clouds(p + sunDirection * 1.0 * stepL);\nlightRayDensity += clouds(p + sunDirection * 2.0 * stepL);\nlightRayDensity += clouds(p + sunDirection * 3.0 * stepL);\nlightRayDensity += clouds(p + sunDirection * 4.0 * stepL);\nlightRayDensity += clouds(p + sunDirection * 5.0 * stepL);\nfloat beersLaw = multipleOctaves(lightRayDensity, mu, stepL);\nreturn mix(beersLaw * 2.0 * (1.0 - (exp(-stepL * lightRayDensity * 2.0 * sigmaE ))), beersLaw, 0.5 + 0.5 * mu);\n}"])))),i.code.add((0,T.H)(d||(d=(0,p.Z)(["float mainRay(vec3 org, vec3 dir, vec3 sunDirection, float distToStart, float totalDistance, out float totalTransmittance) {\nif (dir.z < 0.0) {\nreturn 0.0;\n}\ntotalTransmittance = 1.0;\nfloat stepS = totalDistance / float(STEPS);\nfloat cameraHeight = length(org);\nfloat mu = 0.5 + 0.5 * dot(sunDirection, dir);\nfloat phaseFunction = mix(HenyeyGreenstein(-0.3, mu), HenyeyGreenstein(0.3, mu), 0.7);\nvec3 p = org + distToStart  * dir;\nfloat dist = distToStart;\nfloat shading = 0.0;\nfor (int i = 0; i < STEPS; i++) {\nfloat sampleDensity = clouds(p);\nfloat sampleSigmaE = sampleDensity * sigmaE;\nif (sampleDensity > 0.0 ) {\nfloat ambient = mix((1.2), (1.6), saturate((length(p) - cloudRadius - cloudStart) / cloudHeight));\nfloat luminance = sampleDensity * (ambient + power * phaseFunction * lightRay(org, p, phaseFunction, mu, sunDirection));\nfloat transmittance = exp(-sampleSigmaE * stepS);\nshading += totalTransmittance * (luminance - luminance * transmittance) / sampleSigmaE;\ntotalTransmittance *= transmittance;\nif (totalTransmittance <= 0.001) {\ntotalTransmittance = 0.0;\nbreak;\n}\n}\ndist += stepS;\np = org + dir * dist;\n}\nreturn shading;\n}"])))),i.code.add((0,T.H)(u||(u=(0,p.Z)(["void main() {\nif (coverage ==  0.0) {\nfragColor = vec4(0.0, 1.0, 0.0, 1.0);\nreturn;\n}\nvec3 rayDir = rayDirection(gl_FragCoord.xy);\nrayDir = normalize(view * rayDir);\nvec3 viewPos = vec3(0, 0, cloudRadius + 1.0);\nbool hitsPlanet = rayDir.z < 0.0;\nfloat hazeFactor = smoothstep(-0.01, mix(0.0, 0.075, cloudVariables.x), abs(dot(rayDir, vec3(0, 0, 1))));\nfloat totalTransmittance = 1.0;\nfloat shading = 0.0;\nif (hitsPlanet) {\nshading = clamp(1.0 - cloudVariables.y, 0.6, 1.0) * (1.0 - hazeFactor);\ntotalTransmittance = hazeFactor;\nfragColor = vec4(shading, totalTransmittance, shading, totalTransmittance);\nreturn;\n}\nvec2 rayStartIntersect = sphereIntersections(viewPos, rayDir, cloudRadius + cloudStart);\nvec2 rayEndIntersect = sphereIntersections(viewPos, rayDir, cloudRadius + cloudStart + cloudHeight);\nfloat distToStart = rayStartIntersect.y;\nfloat totalDistance = rayEndIntersect.y - distToStart;\nvec3 sunDirection = normalize(vec3(0, 0, 1));\nshading = 0.5 * mainRay(viewPos, rayDir, sunDirection, distToStart, totalDistance, totalTransmittance);\nshading = mix(clamp(1.0 - cloudVariables.y, 0.6, 1.0), shading, hazeFactor);\ntotalTransmittance = mix(0.0, totalTransmittance, hazeFactor);\nfragColor = vec4(shading, totalTransmittance, shading, totalTransmittance);\n}"])))),t}const O=(0,f.Ue)(),E=Object.freeze(Object.defineProperty({__proto__:null,CloudsPassParameters:R,build:A},Symbol.toStringTag,{value:"Module"}))},4685:(e,t,i)=>{i.d(t,{C:()=>x,b:()=>w});var n,r,s=i(30168),a=i(29134),o=i(7025),l=i(60750),h=i(29202),c=i(92395),d=i(41481),u=i(85586),p=i(73619),_=i(116),m=i(78980),g=i(49450),f=i(98634),v=i(8654),y=i(64201),b=i(4760);function w(){const e=new y.kG,{attributes:t,varyings:i,vertex:o,fragment:w}=e;return t.add(b.T.POSITION,"vec2"),i.add("worldRay","vec3"),o.uniforms.add(new v.g("inverseProjectionMatrix",((e,t)=>t.camera.inverseProjectionMatrix)),new v.g("inverseViewMatrix",((e,t)=>(0,a.iS)(C,t.camera.viewMatrix)))),o.code.add((0,f.H)(n||(n=(0,s.Z)(["void main(void) {\nvec3 posViewNear = (inverseProjectionMatrix * vec4(position, -1.0, 1.0)).xyz;\nworldRay = (inverseViewMatrix * vec4(posViewNear, 0.0)).xyz;\ngl_Position = vec4(position, 1.0, 1.0);\n}"])))),w.include(_.Y),w.include(m.n),e.include(l._,{pbrMode:d.f7.Disabled,lightingSphericalHarmonicsOrder:2}),e.include(u.e),e.include(h.D),e.include(c.kR),e.include(p.j),w.uniforms.add(new g.J("cameraPosition",((e,t)=>t.camera.eye))),w.code.add((0,f.H)(r||(r=(0,s.Z)(["void main() {\nvec4 cloudsColor = renderClouds(normalize(worldRay), cameraPosition);\nfragColor = vec4((1.0 - totalFadeInOut) * cloudsColor.rgb, cloudsColor.a);\n}"])))),e}const C=(0,o.Ue)(),x=Object.freeze(Object.defineProperty({__proto__:null,build:w},Symbol.toStringTag,{value:"Module"}))},34659:(e,t,i)=>{i.d(t,{C:()=>Se,b:()=>Te});var n,r,s,a,o,l,h,c,d,u,p,_,m,g,f,v,y,b,w,C,x,T,S,P,M,R,A,O,E,D,I,L,N,U,H,F,V,q,z,B,G,k=i(30168),Z=i(22186),j=i(92015),W=i(7564),X=i(37107),Q=i(91871),Y=i(22357),J=i(37081),K=i(33280),$=i(16010),ee=i(60113),te=i(48655),ie=i(85380),ne=i(74058),re=i(16574),se=i(137),ae=i(54943),oe=i(98864),le=i(38171),he=i(48051),ce=i(34975),de=i(92395),ue=i(15226),pe=i(41481),_e=i(51612),me=i(93511),ge=i(22702),fe=i(26461),ve=i(10763),ye=i(86097),be=i(98634),we=i(64201),Ce=i(19253),xe=i(25920);function Te(e){const t=new we.kG;t.include(ne.up,e),t.include(ie.Bb,e),t.include(te.c,e),t.include(ee.D,e),t.include(Y.qj,e),t.include(X.AD,e),t.include(ve.o,e),t.include(K.P_,e),t.include(_e.s,e),t.include(Q.z,e);const{vertex:i,fragment:Te}=t;e.pbrMode!==pe.f7.Normal&&e.pbrMode!==pe.f7.Schematic||(t.include(pe.jV,e),e.hasNormalTexture&&t.include(le.Q,e));const Se=e.output===J.H_.Shadow||e.output===J.H_.ShadowHighlight||e.output===J.H_.ShadowExcludeHighlight;Se&&e.componentData===X._N.Varying?i.code.add((0,be.H)(n||(n=(0,k.Z)(["#define discardShadows(castShadows) { if(!castShadows) { gl_Position = vec4(1e38, 1e38, 1e38, 1.0); return; } }"])))):i.code.add((0,be.H)(r||(r=(0,k.Z)(["#define discardShadows(castShadows) {}"]))));const Pe=e.integratedMeshMode===W.O.ColorOverlay||e.integratedMeshMode===W.O.ColorOverlayWithWater,Me=Pe&&e.output===J.H_.Color&&e.pbrMode===pe.f7.WaterOnIntegratedMesh;Pe&&(t.include(ce.XP,e),t.include(ge.WB,e),e.spherical?i.code.add((0,be.H)(s||(s=(0,k.Z)(["\n      const float invEllipsoidRadius = ",";\n      vec2 projectOverlay(vec3 pos) {\n        return pos.xy / (1.0 + invEllipsoidRadius * pos.z);\n      }\n      "])),be.H.float(1/(e.ellipsoidMode===ye.U.Earth?Z.sv.radius:e.ellipsoidMode===ye.U.Mars?Z.yr.radius:Z.Z1.radius)))):i.code.add((0,be.H)(a||(a=(0,k.Z)(["vec2 projectOverlay(vec3 pos) { return pos.xy; }"]))))),Me&&(t.varyings.add("tbnTangent","vec3"),t.varyings.add("tbnBiTangent","vec3"),t.varyings.add("groundNormal","vec3")),i.code.add((0,be.H)(o||(o=(0,k.Z)(["\n    void main() {\n      bool castShadows;\n      vec4 externalColor = forwardExternalColor(castShadows);\n      discardShadows(castShadows);\n\n      vertexDiscardByOpacity(externalColor.a);\n\n      ","\n\n      if (externalColor.a < ",") {\n        // Discard this vertex\n        gl_Position = vec4(1e38, 1e38, 1e38, 1.0);\n        return;\n      }\n\n      forwardPosition(readElevationOffset());\n      forwardNormal();\n      forwardTextureCoordinates();\n      forwardVertexColor();\n      forwardLinearDepth();\n      ","\n      ","\n      ","\n    }\n  "])),e.output===J.H_.ObjectAndLayerIdColor?(0,be.H)(l||(l=(0,k.Z)(["externalColor.a = 1.0;"]))):"",be.H.float(fe.b),e.output===J.H_.ObjectAndLayerIdColor?(0,be.H)(h||(h=(0,k.Z)(["forwardObjectAndLayerIdColor();"]))):"",Me?e.spherical?(0,be.H)(c||(c=(0,k.Z)(["\n                groundNormal = normalize(positionWorld());\n                tbnTangent = normalize(cross(vec3(0.0, 0.0, 1.0), groundNormal));\n                tbnBiTangent = normalize(cross(groundNormal, tbnTangent));"]))):(0,be.H)(d||(d=(0,k.Z)(["\n                groundNormal = vec3(0.0, 0.0, 1.0);\n                tbnTangent = vec3(1.0, 0.0, 0.0);\n                tbnBiTangent = vec3(0.0, 1.0, 0.0);"]))):"",Pe?(0,be.H)(u||(u=(0,k.Z)(["setOverlayVTC(projectOverlay(position));"]))):"")),e.output===J.H_.Color&&(Te.include(ae.S),t.include(ue.l,e),t.include(oe.P,e),t.include(he.B,e),t.include(ce.XP,e),e.transparencyPassType===xe.A.ColorAlpha&&(t.outputs.add("fragColor","vec4",0),t.outputs.add("fragAlpha","float",1)),e.receiveShadows?(t.include(me.hb,e),Te.code.add((0,be.H)(p||(p=(0,k.Z)(["float evaluateShadow() {\nreturn readShadowMap(vPositionWorldCameraRelative, linearDepth);\n}"]))))):Te.code.add((0,be.H)(_||(_=(0,k.Z)(["float evaluateShadow() { return 0.0; }"])))),Pe&&Te.uniforms.add(new Ce.A("ovColorTex",((e,t)=>(0,ge.WE)(e,t)))),Te.code.add((0,be.H)(m||(m=(0,k.Z)(["\n      void main() {\n        discardBySlice(vPositionWorldCameraRelative);\n        ","\n\n        vec4 textureColor = readBaseColorTexture();\n        discardOrAdjustAlpha(textureColor);\n\n        vec4 externalColor;\n        int externalColorMixMode;\n        readExternalColor(externalColor, externalColorMixMode);\n\n        vec4 materialColor = computeMaterialColor(\n          textureColor,\n          externalColor,\n          externalColorMixMode\n        );\n        ","\n    "])),e.multipassEnabled?(0,be.H)(g||(g=(0,k.Z)(["terrainDepthTest(vPosition_view.z);"]))):"",Pe?(0,be.H)(f||(f=(0,k.Z)(["vec4 overlayColor = getOverlayColor(ovColorTex, vtcOverlay);"]))):"")),e.pbrMode===pe.f7.Normal||e.pbrMode===pe.f7.Schematic?((0,de.F1)(Te),Te.code.add((0,be.H)(v||(v=(0,k.Z)(["\n        ","\n        vec3 normalVertex = shadingNormalWorld();\n        float additionalIrradiance = 0.02 * mainLightIntensity[2];\n      "])),e.pbrMode===pe.f7.Normal?(0,be.H)(y||(y=(0,k.Z)(["\n                applyPBRFactors();\n                if (int(externalColorMixMode) == 3) {\n                  mrr = vec3(0.0, 0.6, 0.2);\n                }"]))):"")),e.hasNormalTexture?Te.code.add((0,be.H)(b||(b=(0,k.Z)(["mat3 tangentSpace = computeTangentSpace(normalVertex, vPositionWorldCameraRelative, vuv0);\nvec3 shadingNormal = computeTextureNormal(tangentSpace, vuv0);"])))):Te.code.add((0,be.H)(w||(w=(0,k.Z)(["vec3 shadingNormal = normalVertex;"])))),Te.code.add((0,be.H)(C||(C=(0,k.Z)(["","\n      "])),e.spherical?(0,be.H)(x||(x=(0,k.Z)(["vec3 normalGround = normalize(positionWorld());"]))):(0,be.H)(T||(T=(0,k.Z)(["vec3 normalGround = vec3(0.0, 0.0, 1.0);"]))))),Te.code.add((0,be.H)(S||(S=(0,k.Z)(["\n        vec3 viewDir = normalize(vPositionWorldCameraRelative);\n        float ssao = 1.0 - occlusion * evaluateAmbientOcclusionInverse();\n        ","\n\n        ","\n\n        vec3 additionalLight = evaluateAdditionalLighting(ssao, positionWorld());\n        vec4 shadedColor = vec4(evaluateSceneLightingPBR(shadingNormal, materialColor.rgb, evaluateShadow(), ssao, additionalLight, viewDir, normalGround, mrr, emission, additionalIrradiance), materialColor.a);\n        "])),e.snowCover?(0,be.H)(P||(P=(0,k.Z)(["\n                vec3 surfaceNormal = normalize(shadingNormalWorld());\n                float snow = smoothstep(0.5, 0.55, dot(surfaceNormal, normalize(positionWorld())));\n                materialColor.rgb = mix(materialColor.rgb, vec3(1.1), snow);\n                ssao = mix(ssao, 0.5 * ssao, snow);\n                shadingNormal = mix(shadingNormal, surfaceNormal, snow);"]))):"",Pe?(0,be.H)(M||(M=(0,k.Z)([" materialColor = materialColor * (1.0 - overlayColor.a) + overlayColor;"]))):""))):(e.receiveShadows?Te.code.add((0,be.H)(R||(R=(0,k.Z)(["float shadow = evaluateShadow();"])))):e.spherical?((0,ce.sC)(Te),Te.code.add((0,be.H)(A||(A=(0,k.Z)(["float additionalAmbientScale = additionalDirectedAmbientLight(positionWorld());\nfloat shadow = lightingGlobalFactor * (1.0 - additionalAmbientScale);"]))))):Te.code.add((0,be.H)(O||(O=(0,k.Z)(["float shadow = 0.0;"])))),Me&&Te.uniforms.add(new Ce.A("ovNormalTex",((e,t)=>{var i;return null===(i=t.overlay)||void 0===i?void 0:i.getTexture(j.D.WaterNormal)}))),e.snowCover&&Te.code.add((0,be.H)(E||(E=(0,k.Z)(["vec3 surfaceNormal = normalize(cross(dFdx(vPositionWorldCameraRelative), dFdy(vPositionWorldCameraRelative)));\nfloat snow = smoothstep(0.5, 0.55, dot(surfaceNormal, normalize(positionWorld())));\nmaterialColor.rgb = mix(materialColor.rgb, vec3(1), snow);"])))),Te.code.add((0,be.H)(D||(D=(0,k.Z)(["\n        float ambientOcclusion = evaluateAmbientOcclusion();\n        vec3 additionalLight = evaluateAdditionalLighting(ambientOcclusion, positionWorld());\n\n        ","\n\n        vec4 shadedColor = vec4(evaluateSceneLighting(shadingNormalWorld(), materialColor.rgb, shadow, ambientOcclusion, additionalLight), materialColor.a);\n      ","\n      "])),Pe?(0,be.H)(I||(I=(0,k.Z)([" materialColor = materialColor * (1.0 - overlayColor.a) + overlayColor;"]))):"",Me?(0,be.H)(L||(L=(0,k.Z)(["\n              vec4 overlayWaterMask = getOverlayColor(ovNormalTex, vtcOverlay);\n              float waterNormalLength = length(overlayWaterMask);\n              if (waterNormalLength > 0.95) {\n                mat3 tbnMatrix = mat3(tbnTangent, tbnBiTangent, groundNormal);\n                vec4 waterColorLinear = getOverlayWaterColor(overlayWaterMask, overlayColor, -normalize(vPositionWorldCameraRelative), shadow, groundNormal, tbnMatrix, vPosition_view, positionWorld());\n                vec4 waterColorNonLinear = delinearizeGamma(vec4(waterColorLinear.xyz, 1.0));\n                // un-gamma the ground color to mix in linear space\n                shadedColor = mix(shadedColor, waterColorNonLinear, waterColorLinear.w);\n              }"]))):""))),Te.code.add((0,be.H)(N||(N=(0,k.Z)(["\n        fragColor = highlightSlice(shadedColor, vPositionWorldCameraRelative);\n        ","\n      }\n    "])),e.transparencyPassType===xe.A.ColorAlpha?(0,be.H)(U||(U=(0,k.Z)(["\n                fragColor = premultiplyAlpha(fragColor);\n                fragAlpha = fragColor.a;"]))):"")));const Re=e.output===J.H_.Depth;return(Re||Se||e.output===J.H_.ViewshedShadow)&&(Re||t.include(re.F,e),Te.code.add((0,be.H)(H||(H=(0,k.Z)(["\n      void main() {\n        discardBySlice(vPositionWorldCameraRelative);\n\n        vec4 textureColor = readBaseColorTexture();\n        discardOrAdjustAlpha(textureColor);\n\n        ","\n      }\n    "])),Re?"":(0,be.H)(F||(F=(0,k.Z)(["outputDepth(linearDepth);"])))))),e.output===J.H_.Normal&&(t.include(he.B,e),Te.code.add((0,be.H)(V||(V=(0,k.Z)(["\n      void main() {\n        discardBySlice(vPositionWorldCameraRelative);\n\n        vec4 textureColor = readBaseColorTexture();\n        discardOrAdjustAlpha(textureColor);\n\n        // note: the alpha component needs to be 1.0 in order for this material to influence ambient occlusion,\n        // see the ssao fragment shader\n        float alpha = ",";\n        fragColor = vec4(vec3(.5) + .5 * shadingNormal_view(), alpha);\n      }\n    "])),e.normalType===$.r.Ground?"0.0":"1.0"))),e.output===J.H_.ObjectAndLayerIdColor&&t.fragment.code.add((0,be.H)(q||(q=(0,k.Z)(["\n      void main() {\n        discardBySlice(vPositionWorldCameraRelative);\n\n        vec4 textureColor = readBaseColorTexture();\n        discardOrAdjustAlpha(textureColor);\n\n        ","\n      }\n    "])),Pe?(0,be.H)(z||(z=(0,k.Z)(["fragColor = getOverlayColorTexel(vtcOverlay);"]))):"outputObjectAndLayerIdColor();")),e.output===J.H_.Highlight&&(t.include(se.bA),Te.code.add((0,be.H)(B||(B=(0,k.Z)(["\n      void main() {\n        discardBySlice(vPositionWorldCameraRelative);\n\n        vec4 textureColor = readBaseColorTexture();\n        discardOrAdjustAlpha(textureColor);\n\n        ","\n\n        outputHighlight();\n      }\n    "])),Pe?(0,be.H)(G||(G=(0,k.Z)(["\n                vec4 overlayColor = getCombinedOverlayColor();\n                if (overlayColor.a == 0.0) {\n                  fragColor = vec4(0.0);\n                  return;\n                }"]))):""))),t}const Se=Object.freeze(Object.defineProperty({__proto__:null,build:Te},Symbol.toStringTag,{value:"Module"}))},4170:(e,t,i)=>{i.d(t,{C:()=>m,a:()=>f,b:()=>g});var n,r,s,a=i(30168),o=i(24967),l=i(54943),h=i(78980),c=i(82999),d=i(58406),u=i(98634),p=i(64201),_=i(19253);class m extends u.K{constructor(){super(...arguments),this.opacity=1}}function g(e){const t=new p.kG;return t.include(o.k),t.fragment.uniforms.add(new _.A("tex",(e=>e.texture))),e.hasOpacityFactor&&t.fragment.uniforms.add(new d.p("opacity",(e=>e.opacity))),e.isDepthBlit&&(t.fragment.uniforms.add(new c.A("nearFar",((e,t)=>t.camera.nearFar))),t.fragment.include(l.K),t.fragment.include(h.n)),t.fragment.code.add((0,u.H)(n||(n=(0,a.Z)(["\n    void main() {\n      ","\n    }"])),e.isDepthBlit?(0,u.H)(r||(r=(0,a.Z)(["\n              float normalizedLinearDepth = (-linearDepthFromTexture(tex, uv) - nearFar[0]) / (nearFar[1] - nearFar[0]);\n              fragColor = float2rgba(normalizedLinearDepth);"]))):(0,u.H)(s||(s=(0,a.Z)(["\n              fragColor = texture(tex, uv) ",";"])),e.hasOpacityFactor?"* opacity":""))),t}const f=Object.freeze(Object.defineProperty({__proto__:null,CompositingPassParameters:m,build:g},Symbol.toStringTag,{value:"Module"}))},82396:(e,t,i)=>{i.d(t,{E:()=>d,b:()=>c});var n,r=i(30168),s=i(24967),a=i(98634),o=i(64201),l=i(19253);const h={threshold:.05,localConstrastAdaption:2};function c(){const e=new o.kG;return e.include(s.k),e.fragment.uniforms.add(new l.A("colorTexture",(e=>e.color))),e.outputs.add("fragEdges","vec2"),e.fragment.code.add((0,a.H)(n||(n=(0,r.Z)(["\n    float absMax3(vec3 v) {\n      vec3 t = abs(v);\n      return max(max(t.r, t.g), t.b);\n    }\n\n    void main() {\n      vec2 resolution = 1.0 / vec2(textureSize(colorTexture, 0));\n      vec4 offsets[3];\n      offsets[0] = vec4(uv.x - resolution.x, uv.y, uv.x, uv.y + resolution.y);\n      offsets[1] = vec4(uv.x + resolution.x, uv.y, uv.x, uv.y - resolution.y);\n      offsets[2] = vec4(uv.x - 2.0 * resolution.x, uv.y, uv.x, uv.y + 2.0 * resolution.y);\n\n      // Calculate color deltas:\n      vec4 delta;\n      vec3 C = texture(colorTexture, uv).rgb;\n\n      vec3 Cleft = texture(colorTexture, offsets[0].xy).rgb;\n      delta.x = absMax3(C - Cleft);\n\n      vec3 Ctop = texture(colorTexture, offsets[0].zw).rgb;\n      delta.y = absMax3(C - Ctop);\n\n      vec2 edges = step(vec2(","), delta.xy);\n\n      // discard if there is no edge:\n      if (dot(edges, vec2(1.0)) == 0.0) {\n        discard;\n      }\n\n      // Calculate right and bottom deltas:\n      vec3 Cright = texture(colorTexture, offsets[1].xy).rgb;\n      delta.z = absMax3(C - Cright);\n\n      vec3 Cbottom  = texture(colorTexture, offsets[1].zw).rgb;\n      delta.w = absMax3(C - Cbottom);\n\n      // Calculate the maximum delta in the direct neighborhood:\n      float maxDelta = max(max(max(delta.x, delta.y), delta.z), delta.w);\n\n      // Calculate left-left and top-top deltas:\n      vec3 Cleftleft  = texture(colorTexture, offsets[2].xy).rgb;\n      delta.z = absMax3(C - Cleftleft);\n\n      vec3 Ctoptop = texture(colorTexture, offsets[2].zw).rgb;\n      delta.w = absMax3(C - Ctoptop);\n\n      // Calculate the final maximum delta:\n      maxDelta = max(max(maxDelta, delta.z), delta.w);\n\n      // Local contrast adaptation in action:\n      edges *= step(maxDelta, float(",") * delta.xy);\n\n      fragEdges = edges;\n    }\n  "])),a.H.float(h.threshold),a.H.float(h.localConstrastAdaption))),e}const d=Object.freeze(Object.defineProperty({__proto__:null,build:c},Symbol.toStringTag,{value:"Module"}))},43223:(e,t,i)=>{i.d(t,{F:()=>C,a:()=>S,b:()=>x});var n,r,s,a,o=i(30168),l=i(29134),h=i(7025),c=i(12400),d=i(60113),u=i(54943),p=i(29202),_=i(82999),m=i(49450),g=i(58406),f=i(98634),v=i(8654),y=i(64201),b=i(19253),w=i(4760);class C extends f.K{constructor(){super(...arguments),this.fogColor=(0,c.Ue)(),this.fogStrength=4e-6,this.atmosphereC=1,this.fogAmount=0}}function x(){const e=new y.kG;e.attributes.add(w.T.POSITION,"vec2"),e.include(d.D,{textureCoordinateType:d.N.Default}),e.varyings.add("worldRay","vec3"),e.varyings.add("eyeDir","vec3");const{vertex:t,fragment:i}=e;return t.uniforms.add(new v.g("inverseProjectionMatrix",((e,t)=>t.camera.inverseProjectionMatrix)),new v.g("inverseViewMatrix",((e,t)=>(0,l.iS)(T,t.camera.viewMatrix)))),t.code.add((0,f.H)(n||(n=(0,o.Z)(["void main(void) {\nvec3 posViewNear = (inverseProjectionMatrix * vec4(position, -1, 1)).xyz;\neyeDir = posViewNear;\nworldRay = (inverseViewMatrix * vec4(posViewNear, 0)).xyz;\nforwardTextureCoordinates();\ngl_Position = vec4(position, 1, 1);\n}"])))),i.uniforms.add(new g.p("atmosphereC",(e=>e.atmosphereC)),new m.J("cameraPosition",((e,t)=>t.camera.eye)),new _.A("nearFar",((e,t)=>t.camera.nearFar)),new b.A("depthTexture",(e=>e.depthTexture)),new g.p("fogStrength",(e=>e.fogStrength)),new g.p("fogAmount",(e=>e.fogAmount)),new m.J("fogColor",(e=>e.fogColor))),e.include(p.D),i.include(u.S),i.code.add((0,f.H)(r||(r=(0,o.Z)(["vec2 sphereIntersect(vec3 start, vec3 dir) {\nfloat a = dot(dir, dir);\nfloat b = 2.0 * dot(dir, start);\nfloat d = (b * b) - 4.0 * a * atmosphereC;\nif (d < 0.0) {\nreturn vec2(1e5, -1e5);\n}\nreturn vec2((-b - sqrt(d)) / (2.0 * a), (-b + sqrt(d)) / (2.0 * a));\n}"])))),i.code.add((0,f.H)(s||(s=(0,o.Z)(["vec4 applyFog(float dist, vec3 rayDir){\nif(dist == -1.0){\nvec2 rayAtmosphereIntersect = sphereIntersect(cameraPosition, rayDir);\ndist = 0.055 * rayAtmosphereIntersect.y;\n}\nfloat fogAmount = fogAmount * (1.0 - exp(-dist * fogStrength));\nreturn vec4(fogAmount * fogColor, fogAmount);\n}"])))),i.code.add((0,f.H)(a||(a=(0,o.Z)(["vec3 tonemapACES(vec3 x) {\nreturn clamp((x * (2.51 * x + 0.03)) / (x * (2.43 * x + 0.59) + 0.14), 0.0, 1.0);\n}\nvoid main() {\nvec3 rayDir = normalize(worldRay);\nfloat terrainDepth = -1.0;\nfloat depthSample = texture(depthTexture, vuv0).r;\nfloat zNorm = 2.0 * depthSample - 1.0;\nfloat linDepth = 2.0 * nearFar[0] * nearFar[1] / (nearFar[1] + nearFar[0] - zNorm * (nearFar[1] - nearFar[0]));\nif(depthSample < 1.0 && depthSample > 0.0){\nvec3 cameraSpaceRay = normalize(eyeDir);\ncameraSpaceRay /= cameraSpaceRay.z;\ncameraSpaceRay *= linDepth;\nterrainDepth = max(0.0, length(cameraSpaceRay));\n}\nvec4 fog = applyFog(terrainDepth, rayDir);\nfragColor = delinearizeGamma(vec4(tonemapACES(fog.rgb), fog.a));\n}"])))),e}const T=(0,h.Ue)(),S=Object.freeze(Object.defineProperty({__proto__:null,FogPassParameters:C,build:x},Symbol.toStringTag,{value:"Module"}))},67273:(e,t,i)=>{i.d(t,{H:()=>h,a:()=>d,b:()=>c});var n,r=i(30168),s=i(24967),a=i(98634),o=i(64201),l=i(19253);class h extends a.K{}function c(){const e=new o.kG;return e.include(s.k),e.fragment.uniforms.add(new l.A("tex",(e=>e.texture))),e.fragment.code.add((0,a.H)(n||(n=(0,r.Z)(["void main() {\nfragColor = vec4(1.0 - texture(tex, uv).a);\n}"])))),e}const d=Object.freeze(Object.defineProperty({__proto__:null,HUDCompositingPassParameters:h,build:c},Symbol.toStringTag,{value:"Module"}))},90765:(e,t,i)=>{i.d(t,{H:()=>f,b:()=>m});var n,r,s=i(30168),a=i(19093),o=i(86361),l=i(82999),h=i(95276),c=i(98634),d=i(64201),u=i(19253),p=i(4760),_=i(69012);function m(){const e=new d.kG,{vertex:t,fragment:i}=e,o=t.code,m=i.code;return e.attributes.add(p.T.POSITION,"vec2"),e.varyings.add("uv","vec2"),e.attributes.add(p.T.UV0,"vec2"),t.uniforms.add(new u.A("coverageTex",(e=>e.coverageTexture)),new l.A("coverageRounding",(e=>e.coverageRounding))),o.add((0,c.H)(n||(n=(0,s.Z)(["void main() {\nvec4 cov = texture(coverageTex, uv0 * coverageRounding);\nif (cov.r == 0.0) {\ngl_Position = vec4(0.0);\nreturn;\n}\ngl_Position = vec4(position, 0.0, 1.0);\nuv = position.xy * 0.5 + vec2(0.5);\n}"])))),i.uniforms.add(new u.A("tex",(e=>e.blurTexture)),new u.A("highlightTexture",(e=>e.highlightTexture)),new h.N("uColor",(e=>e.color)),new h.N("haloColor",(e=>e.haloColor)),new h.N("opacities",(e=>(0,a.s)(g,e.haloOpacity,e.haloOpacityOccluded,e.fillOpacity,e.fillOpacityOccluded)))),i.constants.add("inner","float",1-(_.o-_.b)/_.o),m.add((0,c.H)(r||(r=(0,s.Z)(["void main() {\nvec4 blurredHighlightValue = texture(tex, uv);\nfloat highlightIntensity = blurredHighlightValue.a;\nif (highlightIntensity == 0.0) {\ndiscard;\n}\nvec4 origin_color = texture(highlightTexture, uv);\nfloat outlineIntensity;\nfloat fillIntensity;\nif (blurredHighlightValue.g > blurredHighlightValue.b) {\noutlineIntensity = haloColor.w * opacities[1];\nfillIntensity = uColor.w * opacities[3];\n}\nelse {\noutlineIntensity = haloColor.w * opacities[0];\nfillIntensity = uColor.w * opacities[2];\n}\nfloat outlineFactor = smoothstep(0.0, inner, highlightIntensity);\nfloat fillFactor = any(notEqual(origin_color, vec4(0.0, 0.0, 0.0, 0.0))) ? 1.0 : 0.0;\nfloat intensity = outlineIntensity * outlineFactor * (1.0 - fillFactor) + fillIntensity * fillFactor;\nfragColor = vec4(mix(haloColor.rgb, uColor.rgb, fillFactor), intensity);\n}"])))),e}const g=(0,o.Ue)(),f=Object.freeze(Object.defineProperty({__proto__:null,build:m},Symbol.toStringTag,{value:"Module"}))},56384:(e,t,i)=>{i.d(t,{H:()=>_,a:()=>g,b:()=>m});var n,r,s=i(30168),a=i(6644),o=i(22527),l=i(82999),h=i(98634),c=i(64201),d=i(78050),u=i(19253),p=i(4760);class _ extends h.K{constructor(){super(...arguments),this.blurSize=(0,a.Ue)()}}function m(){const e=new c.kG,{attributes:t,varyings:i,vertex:a,fragment:_}=e;return t.add(p.T.POSITION,"vec2"),t.add(p.T.UV0,"vec2"),i.add("blurCoordinate","vec3"),a.uniforms.add(new u.A("coverageTex",(e=>e.coverageTexture)),new l.A("coverageRounding",(e=>e.coverageRounding))),a.code.add((0,h.H)(n||(n=(0,s.Z)(["void main() {\ngl_Position = vec4(position, 0.0, 1.0);\nvec4 cov = texture(coverageTex, uv0 * coverageRounding);\nif (cov.r == 0.0) {\ngl_Position = vec4(0.0);\n}\nblurCoordinate = vec3(gl_Position.xy * 0.5 + vec2(0.5), cov.g);\n}"])))),_.uniforms.add(new o.q("blurSize",(e=>e.blurSize)),new d.R("tex",(e=>e.blurInputTexture))),_.code.add((0,h.H)(r||(r=(0,s.Z)(["void main() {\nvec2 uv = blurCoordinate.xy;\nvec4 center = texture(tex, uv);\nif (blurCoordinate.z == 1.0) {\nfragColor = center;\n} else {\nvec4 sum = center * 0.204164;\nsum += texture(tex, uv + blurSize * 1.407333) * 0.304005;\nsum += texture(tex, uv - blurSize * 1.407333) * 0.304005;\nsum += texture(tex, uv + blurSize * 3.294215) * 0.093913;\nsum += texture(tex, uv - blurSize * 3.294215) * 0.093913;\nfragColor = sum;\n}\n}"])))),e}const g=Object.freeze(Object.defineProperty({__proto__:null,HighlightBlurDrawParameters:_,build:m},Symbol.toStringTag,{value:"Module"}))},69012:(e,t,i)=>{i.d(t,{H:()=>h,a:()=>_,b:()=>p,c:()=>c,g:()=>d,o:()=>u});var n,r=i(30168),s=i(24967),a=i(98634),o=i(64201),l=i(78050);class h extends a.K{}function c(){const e=new o.kG,{outputs:t,fragment:i}=e;return e.include(s.k),i.uniforms.add(new l.R("textureInput",(e=>e.input))),i.constants.add("sampleArea","int",Math.ceil(u/2)),t.add("fragGrid","vec2"),i.code.add((0,a.H)(n||(n=(0,r.Z)(["\n    void main() {\n      float red = 0.0;\n      float green = 1.0;\n      int cellSize = ",";\n      vec2 texelSize = 1.0 / vec2(textureSize(textureInput, 0));\n      vec2 offset = floor(gl_FragCoord.xy) * vec2(float(cellSize));\n\n      for(int x = -sampleArea; x < cellSize + sampleArea; x += 2) {\n        for(int y = -sampleArea; y < cellSize + sampleArea; y += 2) {\n          vec2 coord = (offset + vec2(float(x), float(y))) * texelSize;\n          vec4 value = texture(textureInput, coord);\n          float mx = floor(max(value.g, value.b));\n\n          red = max(red, ceil(value.r));\n          green = min(green, mx);\n          if(red == 1.0 && green == 0.0) {\n            fragGrid = vec2(red, green);\n            return;\n          }\n        }\n      }\n      fragGrid = vec2(red, green);\n    }"])),a.H.int(d))),e}const d=32,u=9,p=.4,_=Object.freeze(Object.defineProperty({__proto__:null,HighlightDownsampleDrawParameters:h,blurSize:p,build:c,gridCellPixelSize:d,outlineSize:u},Symbol.toStringTag,{value:"Module"}))},19388:(e,t,i)=>{i.d(t,{M:()=>m,a:()=>b,b:()=>g});var n,r,s=i(30168),a=i(17842),o=i(19093),l=i(86361),h=i(13773),c=i(95276),d=i(98634),u=i(64201),p=i(19253),_=i(4760);class m extends d.K{constructor(){super(...arguments),this.mask=null,this.overlay=null,this.input=null,this.size=0}}function g(){const e=new u.kG;return e.attributes.add(_.T.POSITION,"vec2"),e.vertex.uniforms.add(new c.N("drawPosition",((e,t)=>function(e,t){const i=t.camera.pixelRatio,n=e.magnifier.offset.x*i,r=e.magnifier.offset.y*i;(0,a.md)(e.magnifier.position,f);const s=t.camera.screenToRender(f,v),l=Math.ceil(i*e.magnifier.size),h=t.camera.fullWidth,c=t.camera.fullHeight;return(0,o.s)(y,(s[0]+n)/h*2-1,(s[1]-r)/c*2-1,l/h*2,l/c*2)}(e,t)))),e.varyings.add("vUV","vec2"),e.vertex.code.add((0,d.H)(n||(n=(0,s.Z)(["void main(void) {\nvUV = position;\ngl_Position = vec4(drawPosition.xy + vec2(position - 0.5) * drawPosition.zw, 0.0, 1.0);\n}"])))),e.fragment.uniforms.add(new p.A("textureInput",(e=>e.input))),e.fragment.uniforms.add(new p.A("textureMask",(e=>e.mask))),e.fragment.uniforms.add(new p.A("textureOverlay",(e=>e.overlay))),e.fragment.uniforms.add(new h.U("maskEnabled",(e=>e.magnifier.maskEnabled))),e.fragment.uniforms.add(new h.U("overlayEnabled",(e=>e.magnifier.overlayEnabled))),e.fragment.code.add((0,d.H)(r||(r=(0,s.Z)(["const float barrelFactor = 1.1;\nvec2 barrel(vec2 uv) {\nvec2 uvn = uv * 2.0 - 1.0;\nif (uvn.x == 0.0 && uvn.y == 0.0) {\nreturn vec2(0.5, 0.5);\n}\nfloat theta = atan(uvn.y, uvn.x);\nfloat r = pow(length(uvn), barrelFactor);\nreturn r * vec2(cos(theta), sin(theta)) * 0.5 + 0.5;\n}\nvoid main() {\nfloat mask = maskEnabled ? texture(textureMask, vUV).a : 1.0;\nvec4 inputColor = texture(textureInput, barrel(vUV)) * mask;\nvec4 overlayColor = overlayEnabled ? texture(textureOverlay, vUV) : vec4(0);\nfragColor = overlayColor + (1.0 - overlayColor.a) * inputColor;\n}"])))),e}const f=(0,a.s1)(),v=(0,a.gX)(),y=(0,l.Ue)(),b=Object.freeze(Object.defineProperty({__proto__:null,MagnifierPassParameters:m,build:g},Symbol.toStringTag,{value:"Module"}))},50214:(e,t,i)=>{i.d(t,{N:()=>y,a:()=>w,b:()=>b});var n,r,s,a,o,l,h,c,d=i(30168),u=i(6644),p=i(84819),_=i(68820),m=i(24967),g=i(82999),f=i(98634),v=i(64201);class y extends f.K{constructor(){super(...arguments),this.weatherTile=(0,u.al)(0,0)}}function b(e){const t=new v.kG;if(t.include(m.k,!1),t.fragment.code.add((0,f.H)(n||(n=(0,d.Z)(["float remap(float x, float low1, float high1, float low2, float high2) {\nreturn low2 + (x - low1) * (high2 - low2) / (high1 - low1);\n}"])))),e.mode===p.u.Full){const e=2,i=8;t.fragment.code.add((0,f.H)(r||(r=(0,d.Z)(["\n    float saturate(float x) {\n      return clamp(x, 0.0, 1.0);\n    }\n\n    // Safer modulo for positive and negative values\n    vec3 modulo(vec3 m, float n){\n      return mod(mod(m, n) + n, n);\n    }\n\n    vec3 hash(vec3 p3, float frequency){\n      p3 = modulo(p3, frequency);\n      p3 = fract(p3 * vec3(0.1031, 0.1030, 0.0973));\n      p3 += dot(p3, p3.yxz + 33.33);\n      return -1.0 + 2.0 * fract((p3.xxy + p3.yxx) * p3.zyx);\n    }\n\n    // 5th order polynomial interpolation\n    vec3 fade(vec3 t){\n      return (t * t * t) * (t * (t * 6.0 - 15.0) + 10.0);\n    }\n\n    float gradientNoise(vec3 p, float frequency){\n      // Cell point is in\n      vec3 i = floor(p);\n\n      // Position in the cell in [0, 1]\n      vec3 f = fract(p);\n\n      // Interpolation value for gradient mixing\n      vec3 u = fade(f);\n\n      // Trilinear interpolation of gradients at cube vertices around point\n      return mix( mix( mix( dot( hash( i + vec3(0.0,0.0,0.0), frequency), f - vec3(0.0,0.0,0.0) ),\n                            dot( hash( i + vec3(1.0,0.0,0.0), frequency), f - vec3(1.0,0.0,0.0) ), u.x),\n                       mix( dot( hash( i + vec3(0.0,1.0,0.0), frequency), f - vec3(0.0,1.0,0.0) ),\n                            dot( hash( i + vec3(1.0,1.0,0.0), frequency), f - vec3(1.0,1.0,0.0) ), u.x), u.y),\n                  mix( mix( dot( hash( i + vec3(0.0,0.0,1.0), frequency), f - vec3(0.0,0.0,1.0) ),\n                            dot( hash( i + vec3(1.0,0.0,1.0), frequency), f - vec3(1.0,0.0,1.0) ), u.x),\n                       mix( dot( hash( i + vec3(0.0,1.0,1.0), frequency), f - vec3(0.0,1.0,1.0) ),\n                            dot( hash( i + vec3(1.0,1.0,1.0), frequency), f - vec3(1.0,1.0,1.0) ), u.x), u.y), u.z );\n    }\n\n    float getPerlinNoise(vec3 pos, float frequency) {\n      float octaveFrequencyFactor = 2.0;\n      float sum = 0.0;\n      float weightSum = 0.0;\n      float weight = 1.0;\n\n      for (int oct = 0; oct < 3; oct++) {\n        vec3 p = pos * frequency;\n        float val = 0.5 + 0.5 * gradientNoise(p, frequency);\n        sum += val * weight;\n        weightSum += weight;\n        weight *= 0.5;\n        frequency *= octaveFrequencyFactor;\n      }\n\n      float noise = (sum / weightSum);\n      noise = saturate(noise);\n      return noise;\n    }\n\n    float worley(vec3 pos, float numCells) {\n      vec3 p = pos * numCells;\n      float d = 1.0e10;\n\n      for (int x = -1; x <= 1; x++) {\n        for (int y = -1; y <= 1; y++) {\n          for (int z = -1; z <= 1; z++) {\n            vec3 tp = floor(p) + vec3(x, y, z);\n            tp = p - tp - (hash(tp, numCells) * 0.5 + 0.5);\n            d = min(d, dot(tp, tp));\n          }\n        }\n      }\n\n      return 1.0 - clamp(d, 0.0, 1.0);\n    }\n\n    vec3 get3Dfrom2D(vec2 uv) {\n      vec2 tile = floor(uv);\n      float z = floor("," * tile.y + tile.x);\n      return vec3(fract(uv), z);\n    }\n\n    float getTextureForPointPerlinWorley(vec3 p) {\n      float perlinNoise = getPerlinNoise(p, ",");\n\n      float worley0 = worley(p, "," * 2.0);\n      float worley1 = worley(p, "," * 8.0);\n      float worley2 = worley(p, "," * 14.0);\n\n      float worleyFBM = worley0 * 0.625 + worley1 * 0.25 + worley2 * 0.125;\n      return remap(perlinNoise, 0.0, 1.0, worleyFBM, 1.0);\n    }\n\n    float getTextureForPointWorley(vec3 p) {\n      float worley0 = worley(p, ",");\n      float worley1 = worley(p, "," * 2.0);\n      float worley2 = worley(p, "," * 4.0);\n      float worley3 = worley(p, "," * 8.0);\n\n      float FBM0 = worley0 * 0.625 + worley1 * 0.25 + worley2 * 0.125;\n      float FBM1 = worley1 * 0.625 + worley2 * 0.25 + worley3 * 0.125;\n      float FBM2 = worley2 * 0.75 + worley3 * 0.25;\n\n      return FBM0 * 0.625 + FBM1 * 0.25 + FBM2 * 0.125;\n    }\n  "])),f.H.float(_.CB),f.H.float(i),f.H.float(e),f.H.float(e),f.H.float(e),f.H.float(e),f.H.float(e),f.H.float(e),f.H.float(e)))}return t.fragment.uniforms.add(new g.A("weatherTile",(e=>e.weatherTile))),t.fragment.code.add((0,f.H)(s||(s=(0,d.Z)(["\n    vec2 modulo(vec2 m, float n){\n      return mod(mod(m, n) + n, n);\n    }\n\n    vec2 hash(vec2 p){\n      // Get position of p in weather tile\n      p = modulo(p, ",");\n\n      // Get global coordinates of p\n      p += weatherTile * ",";\n\n      // Limit position to avoid numerical instability\n      p = modulo(p, ",");\n\n      vec3 p3 = fract(vec3(p.xyx) * vec3(0.1031, 0.1030, 0.0973));\n      p3 += dot(p3, p3.yzx + 33.33);\n      return 2.0 * fract((p3.xx + p3.yz) * p3.zy) - 1.0;\n    }\n\n    vec2 fade(vec2 t){\n      return (t * t * t) * (t * (t * 6.0 - 15.0) + 10.0);\n    }\n\n    float gradientNoise(vec2 p){\n      vec2 i = floor( p );\n      vec2 f = fract( p );\n\n      vec2 u = fade(f);\n\n      // Bilinear interpolation of gradients at cell vertices around point\n      return  mix(\n                mix(dot( hash( i + vec2(0.0,0.0) ), f - vec2(0.0,0.0) ),\n                    dot( hash( i + vec2(1.0,0.0) ), f - vec2(1.0,0.0) ), u.x),\n                mix(dot( hash( i + vec2(0.0,1.0) ), f - vec2(0.0,1.0) ),\n                    dot( hash( i + vec2(1.0,1.0) ), f - vec2(1.0,1.0) ), u.x),\n                u.y);\n    }\n\n    float worley(vec2 p){\n      float d = 1.0e10;\n      for (int x = -1; x <= 1; x++){\n        for (int y = -1; y <= 1; y++){\n                vec2 tp = floor(p) + vec2(x, y);\n                tp = p - tp - (0.5 + 0.5 * hash(tp));\n                d = min(d, dot(tp, tp));\n            }\n        }\n      return 1.0 - clamp(d, 0.0, 1.0);\n    }\n  "])),f.H.float(_.JK),f.H.float(_.JK),f.H.float(_.r7))),t.fragment.code.add((0,f.H)(a||(a=(0,d.Z)(["void main() {"])))),e.mode===p.u.Full&&t.fragment.code.add((0,f.H)(o||(o=(0,d.Z)(["\n        float padWidth = 1.0;\n        float paddedSize = "," + 2.0 * padWidth;\n        float tileCount = "," * ",";\n        vec2 tile = floor((gl_FragCoord.xy - 0.5) / paddedSize);\n\n        bool padCell = false;\n        if (mod(gl_FragCoord.x, paddedSize) == 0.5 || mod(gl_FragCoord.x, paddedSize) == paddedSize - 0.5) {\n          padCell = true;\n        }\n\n        if (mod(gl_FragCoord.y, paddedSize) == 0.5 || mod(gl_FragCoord.y, paddedSize) == paddedSize - 0.5) {\n          padCell = true;\n        }\n\n        bool startPadX = false;\n        bool startPadY = false;\n        bool endPadX = false;\n        bool endPadY = false;\n\n        if (gl_FragCoord.x == tile.x * paddedSize + 0.5) {\n          startPadX = true;\n        }\n\n        if (gl_FragCoord.y == tile.y * paddedSize + 0.5) {\n          startPadY = true;\n        }\n\n        if (gl_FragCoord.x == (tile.x + 1.0) * paddedSize - 0.5) {\n          endPadX = true;\n        }\n\n        if (gl_FragCoord.y == (tile.y + 1.0) * paddedSize - 0.5) {\n          endPadY = true;\n        }\n\n        vec2 padding = vec2(2.0 * padWidth) * tile;\n        vec2 uv;\n\n        if (padCell) {\n          vec2 pixel = gl_FragCoord.xy - padWidth - padding;\n\n          if (startPadX) {\n            pixel.x += ",";\n          }\n\n          if (startPadY) {\n            pixel.y += ",";\n          }\n\n          if (endPadX) {\n            pixel.x -= ",";\n          }\n\n          if (endPadY) {\n            pixel.y -= ",";\n          }\n\n          uv = vec2(pixel.xy / ",");\n        } else {\n          vec2 pixel = gl_FragCoord.xy - padWidth - padding;\n          uv = vec2(pixel.xy / ",");\n        }\n\n        vec3 p_ = get3Dfrom2D(uv);\n        vec3 p = p_;\n        p.z /= ("," * ",");\n\n        float worleyPerlinNoise = getTextureForPointPerlinWorley(p);\n        float worleyNoise = getTextureForPointWorley(p);\n\n        fragColor.r = saturate(remap(worleyPerlinNoise, worleyNoise, 1.0, 0.0, 1.0));\n\n        p_ = mod(p_ + 1.0, "," * ",");\n        p = p_;\n        p.z /= ("," * ",");\n\n        worleyPerlinNoise = getTextureForPointPerlinWorley(p);\n        worleyNoise = getTextureForPointWorley(p);\n\n        fragColor.g = saturate(remap(worleyPerlinNoise, worleyNoise, 1.0, 0.0, 1.0));\n      "])),f.H.float(_.i9),f.H.float(_.CB),f.H.float(_.CB),f.H.float(_.i9),f.H.float(_.i9),f.H.float(_.i9),f.H.float(_.i9),f.H.float(_.i9),f.H.float(_.i9),f.H.float(_.CB),f.H.float(_.CB),f.H.float(_.CB),f.H.float(_.CB),f.H.float(_.CB),f.H.float(_.CB))),t.fragment.code.add((0,f.H)(l||(l=(0,d.Z)(["\n      vec2 mapUV = "," * (gl_FragCoord.xy / ",");\n      float map = abs(gradientNoise(mapUV));\n      map = remap(map, 0.25 * (1.0 - worley(8.0 * mapUV)), 1.0, 0.0, 1.0);\n\n      ",";\n    }\n  "])),f.H.float(_.JK),f.H.float(_.a5),e.mode===p.u.Full?(0,f.H)(h||(h=(0,d.Z)(["fragColor.ba = vec2(0.0, map);"]))):(0,f.H)(c||(c=(0,d.Z)(["fragColor = vec4(map);"]))))),t}const w=Object.freeze(Object.defineProperty({__proto__:null,NoiseTextureAtlasPassParameters:y,build:b},Symbol.toStringTag,{value:"Module"}))},90829:(e,t,i)=>{i.d(t,{O:()=>h,a:()=>d,b:()=>c});var n,r=i(30168),s=i(24967),a=i(98634),o=i(64201),l=i(19253);class h extends a.K{}function c(){const e=new o.kG;return e.include(s.k),e.fragment.uniforms.add(new l.A("colorTexture",(e=>e.colorTexture)),new l.A("alphaTexture",(e=>e.alphaTexture)),new l.A("frontFaceTexture",(e=>e.frontFaceTexture))),e.fragment.code.add((0,a.H)(n||(n=(0,r.Z)(["void main() {\nfloat srcAlpha = texture(alphaTexture, uv).r;\nif(srcAlpha <= 1e-5){\ndiscard;\n}\nvec4 srcColor = texture(colorTexture, uv);\nvec4 frontFace = texture(frontFaceTexture, uv);\nfragColor = vec4(mix(srcColor.rgb / srcAlpha, frontFace.rgb, frontFace.a), 1.0 - srcColor.a);\n}"])))),e}const d=Object.freeze(Object.defineProperty({__proto__:null,OITCompositingPassParameters:h,build:c},Symbol.toStringTag,{value:"Module"}))},19159:(e,t,i)=>{i.d(t,{P:()=>S,b:()=>y});var n,r,s,a,o,l,h=i(30168),c=i(32035),d=i(12400),u=i(96916),p=i(49450),_=i(58406),m=i(98634),g=i(8654),f=i(64201),v=i(4760);function y(e){const t=new f.kG;return t.attributes.add(v.T.POSITION,"vec3"),t.attributes.add(v.T.INSTANCEFEATUREATTRIBUTE,"float"),t.vertex.uniforms.add(new p.J("cameraPosition",((e,t)=>t.camera.eye))),t.vertex.uniforms.add(new p.J("offset",((e,t)=>function(e,t){const i=t.camera.eye,n=.5*e.width,r=1/e.width,s=(0,c.J)(b,(0,c.s)(b,(i[0]+n)*r,(i[1]+n)*r,(i[2]+n)*r));return(0,c.z)(s,i,(0,c.j)(s,s,e.width))}(e,t)))),t.vertex.uniforms.add(new _.p("width",(e=>e.width))),t.vertex.uniforms.add(new g.g("proj",((e,t)=>t.camera.projectionMatrix))),t.vertex.uniforms.add(new g.g("view",((e,t)=>t.camera.viewMatrix))),t.vertex.uniforms.add(new _.p("time",(e=>e.time))),t.varyings.add("vUv","vec2"),t.vertex.code.add((0,m.H)(n||(n=(0,h.Z)(["\n    vec3 hash31(float p){\n      vec3 p3 = fract(vec3(p) * vec3(0.1031, 0.1030, 0.0973));\n      p3 += dot(p3, p3.yzx + 33.33);\n      return fract((p3.xxy + p3.yzz) * p3.zyx);\n    }\n\n    float hash11(float p){\n      p = fract(p * 0.1031);\n      p *= p + 33.33;\n      p *= p + p;\n      return fract(p);\n    }\n\n    //https://www.geeks3d.com/20141201/how-to-rotate-a-vertex-by-a-quaternion-in-glsl/\n    vec3 rotateVectorByQuaternion(vec3 v, vec4 q){\n      return 2.0 * cross(q.xyz, v * q.w + cross(q.xyz, v)) + v;\n    }\n\n    void main(void) {\n\n      vUv = position.xz;\n\n      vec3 rand = hash31(instanceFeatureAttribute);\n\n      // Set random position for all particles\n      // The hash function space is not high resolution so offset particles by an additional random value\n      // This creates grids of 1000 particles which are shifted by random hundreths of the tile width\n      // overlaying multiple identical but offset grids\n      vec3 randomPosition = 2.0 * (rand + (0.01 + 0.01 * rand) * floor(0.001 * instanceFeatureAttribute)) - 1.0;\n\n      // Random orientation of rain drops\n      float angle = 3.1415 * hash11(instanceFeatureAttribute);\n\n      vec3 up = vec3(0, 0, 1);\n\n      // Gravity and wind direction\n      vec3 direction = normalize(cameraPosition);\n\n      vec3 tangent = normalize(cross(direction, up));\n\n      // Gravity\n      vec3 animatedPos = randomPosition + direction * -time;\n\n      // Rain particles fall straight down and are randomly oriented\n      // Snow particles have random sinusoid trajectories and are rotated to face the camera\n      ","\n    }\n  "])),e.type===u.H.Rain?(0,m.H)(r||(r=(0,h.Z)(["\n            // Random rotation for particle\n            vec3 rotationAxis = up;\n            vec4 quat = vec4(rotationAxis * sin(angle), cos(angle));\n            vec3 transformedPos = rotateVectorByQuaternion(vec3(0.2, 0.2, 4.0) * (position - vec3(0.5, 0.0, 0.5)), quat);\n\n            // Rotate particle to planetary position\n            rotationAxis = tangent;\n            angle = 0.5 * -acos(dot(direction, up));\n            quat = vec4(rotationAxis * sin(angle), cos(angle));\n            transformedPos = rotateVectorByQuaternion(transformedPos, quat);\n\n            vec4 pos = mat4(mat3(view)) * vec4(transformedPos + (mod(width * animatedPos - offset, width) - 0.5 * width), 1.0);\n            gl_Position = proj * pos;\n      "]))):(0,m.H)(s||(s=(0,h.Z)(["\n            vec3 rotationAxis = direction;\n            vec4 quat = vec4(rotationAxis * sin(angle), cos(angle));\n\n            tangent = rotateVectorByQuaternion(tangent, quat);\n            // Random sinusoid from friction\n            animatedPos += tangent * 0.25 * sin(dot(animatedPos, direction));\n            vec4 pos = mat4(mat3(view)) * vec4((mod(width * animatedPos - offset, width) - 0.5 * width), 1.0);\n            gl_Position = proj * (0.5 * vec4(position.xzy, 0.0) + pos);\n      "]))))),t.fragment.uniforms.add(new _.p("opacity",(e=>e.opacity)),new p.J("particleColor",((t,i)=>function(e,t){const i=t.type===u.H.Rain?x:C,n=(0,c.j)(b,i,T),r=e.camera.eye;(0,c.n)(w,r);const s=Math.max(0,(0,c.m)(w,e.lighting.mainLight.direction));return(0,c.o)(n,n,i,s)}(i,e)))),t.fragment.code.add((0,m.H)(a||(a=(0,h.Z)(["\n    void main() {\n\n      // Cut off corners of the triangle\n      if(vUv.x < 0.0 || vUv.y < 0.0){\n        discard;\n      }\n\n      float d = length(vUv - vec2(0.5));\n\n      ","\n      fragColor = opacity * vec4(particleColor * d, d);\n    }\n  "])),e.type===u.H.Rain?(0,m.H)(o||(o=(0,h.Z)(["d = 0.35 * smoothstep(0.5, 0.0, d);"]))):(0,m.H)(l||(l=(0,h.Z)(["d = smoothstep(0.5, 0.1, d);"]))))),t}const b=(0,d.Ue)(),w=(0,d.Ue)(),C=(0,d.al)(1,1,1),x=(0,d.al)(.85,.85,.85),T=.7,S=Object.freeze(Object.defineProperty({__proto__:null,build:y},Symbol.toStringTag,{value:"Module"}))},87016:(e,t,i)=>{i.d(t,{C:()=>D,R:()=>U,a:()=>I,b:()=>L,c:()=>N});var n,r,s,a,o,l,h,c,d,u,p,_,m,g=i(30168),f=i(12400),v=i(39395),y=i(54786),b=i(9386),w=i(63434),C=i(32426),x=i(116),T=i(13773),S=i(82999),P=i(58406),M=i(699),R=i(99339),A=i(98634),O=i(64201),E=i(19253);class D extends b.J{constructor(e,t,i,n,r,s){super(e,n,r),this.colormap=t,this.symbolizer=i,this.u_colormap=s,this.backgroundColor=f.AG,this.fboTexture=null,this.baseOpacity=1}}class I extends D{}class L extends D{}function N(e){const t=new O.kG;return t.include(C.T),t.include(b.G,e),t.include(y.i,e),t.include(w.J,e),t.fragment.code.add((0,A.H)(n||(n=(0,g.Z)(["vec4 applyBackgroundBlend(vec4 layerColor) {\nreturn blendLayers(vuv, layerColor, u_opacity);\n}"])))),e.colorizerType===v.U.Stretch?function(e,t){e.fragment.uniforms.add(new R._("u_bandCount",(e=>e.symbolizer.u_bandCount)),new M.O("u_minCutOff",(e=>e.symbolizer.u_minCutOff),3),new M.O("u_maxCutOff",(e=>e.symbolizer.u_maxCutOff),3),new M.O("u_factor",(e=>e.symbolizer.u_factor),3),new P.p("u_minOutput",(e=>e.symbolizer.u_minOutput)),new P.p("u_maxOutput",(e=>e.symbolizer.u_maxOutput)),new T.U("u_useGamma",(e=>e.symbolizer.u_useGamma)),new M.O("u_gamma",(e=>e.symbolizer.u_gamma),3),new M.O("u_gammaCorrection",(e=>e.symbolizer.u_gammaCorrection),3),new P.p("u_opacity",(e=>e.common.u_opacity))),e.fragment.code.add((0,A.H)(s||(s=(0,g.Z)(["float stretchOneValue(float val, float minCutOff, float maxCutOff, float minOutput, float maxOutput, float factor, bool useGamma, float gamma, float gammaCorrection) {\nif (val >= maxCutOff) {\nreturn maxOutput;\n} else if (val <= minCutOff) {\nreturn minOutput;\n}\nfloat stretchedVal;\nif (useGamma) {\nfloat tempf = 1.0;\nfloat outRange = maxOutput - minOutput;\nfloat relativeVal = (val - minCutOff) / (maxCutOff - minCutOff);\nif (gamma > 1.0) {\ntempf -= pow(1.0 / outRange, relativeVal * gammaCorrection);\n}\nstretchedVal = (tempf * outRange * pow(relativeVal, 1.0 / gamma) + minOutput) / 255.0;\n} else {\nstretchedVal = minOutput + (val - minCutOff) * factor;\n}\nreturn stretchedVal;\n}"]))));const i=t.applyColormap?(0,A.H)(a||(a=(0,g.Z)(["fragColor = applyBackgroundBlend(colormap(vec4(grayVal, grayVal, grayVal, currentPixel.a), !u_useGamma));"]))):(0,A.H)(o||(o=(0,g.Z)(["fragColor = applyBackgroundBlend(vec4(grayVal, grayVal, grayVal, currentPixel.a));"])));e.fragment.code.add((0,A.H)(l||(l=(0,g.Z)(["\n      void main() {\n        vec2 pixelLocation = getPixelLocation(uv);\n        if (isOutside(pixelLocation)) {\n          fragColor = applyBackgroundBlend(vec4(0.0, 0.0, 0.0, 0.0));\n          return;\n        }\n\n        vec4 currentPixel = getPixel(pixelLocation);\n        ","\n      }"])),t.stretchType===v.H.Noop?(0,A.H)(h||(h=(0,g.Z)(["\n        fragColor = applyBackgroundBlend(currentPixel);"]))):(0,A.H)(c||(c=(0,g.Z)(["\n        if (currentPixel.a == 0.0) {\n          fragColor = applyBackgroundBlend(vec4(0.0, 0.0, 0.0, 0.0));\n          return;\n        }\n        if (u_bandCount == 1) {\n          float grayVal = stretchOneValue(currentPixel.r, u_minCutOff[0], u_maxCutOff[0], u_minOutput, u_maxOutput, u_factor[0], u_useGamma, u_gamma[0], u_gammaCorrection[0]);\n          ","\n        } else {\n          float redVal = stretchOneValue(currentPixel.r, u_minCutOff[0], u_maxCutOff[0], u_minOutput, u_maxOutput, u_factor[0], u_useGamma, u_gamma[0], u_gammaCorrection[0]);\n          float greenVal = stretchOneValue(currentPixel.g, u_minCutOff[1], u_maxCutOff[1], u_minOutput, u_maxOutput, u_factor[1], u_useGamma, u_gamma[1], u_gammaCorrection[1]);\n          float blueVal = stretchOneValue(currentPixel.b, u_minCutOff[2], u_maxCutOff[2], u_minOutput, u_maxOutput, u_factor[2], u_useGamma, u_gamma[2], u_gammaCorrection[2]);\n          fragColor = applyBackgroundBlend(vec4(redVal, greenVal, blueVal, currentPixel.a));\n        }"])),i)))}(t,e):e.colorizerType===v.U.Lut?function(e){e.fragment.code.add((0,A.H)(r||(r=(0,g.Z)(["void main() {\nvec2 pixelLocation = getPixelLocation(uv);\nif (isOutside(pixelLocation)) {\nfragColor = applyBackgroundBlend(vec4(0.0, 0.0, 0.0, 0.0));\nreturn;\n}\nvec4 currentPixel = getPixel(pixelLocation);\nfragColor = applyBackgroundBlend(colormap(currentPixel, true));\n}"]))))}(t):e.colorizerType===v.U.Hillshade&&function(e,t){const i=e.fragment;i.uniforms.add(new E.A("u_image",(e=>e.u_image)),new R._("u_hillshadeType",(e=>e.symbolizer.u_hillshadeType)),new M.O("u_sinZcosAs",(e=>e.symbolizer.u_sinZcosAs),6),new M.O("u_sinZsinAs",(e=>e.symbolizer.u_sinZsinAs),6),new M.O("u_cosZs",(e=>e.symbolizer.u_cosZs),6),new M.O("u_weights",(e=>e.symbolizer.u_weights),6),new S.A("u_factor",(e=>e.symbolizer.u_factor)),new P.p("u_minValue",(e=>e.symbolizer.u_minValue)),new P.p("u_maxValue",(e=>e.symbolizer.u_maxValue)),new S.A("u_srcImageSize",(e=>e.common.u_srcImageSize))),i.include(x.Y),i.code.add((0,A.H)(d||(d=(0,g.Z)(["vec4 overlay(float val, float minValue, float maxValue, float hillshade, float alpha) {\nval = clamp((val - minValue) / (maxValue - minValue), 0.0, 1.0);\nvec4 color = colormap(vec4(val, val, val, 1.0), false);\nvec3 hsv = rgb2hsv(color.rgb);\nhsv.z = hillshade;\nreturn vec4(hsv2rgb(hsv), 1.0) * alpha * color.a;\n}"])))),i.code.add((0,A.H)(u||(u=(0,g.Z)(["float getNeighborHoodAlpha(float a, float b, float c, float d, float e, float f, float g, float h, float i){\nif (a == 0.0 || a == 0.0 || a==0.0 || a == 0.0 || a == 0.0 || a==0.0 || a == 0.0 || a == 0.0 || a==0.0) {\nreturn 0.0;\n}  else {\nreturn e;\n}\n}"]))));const n=t.applyColormap?(0,A.H)(p||(p=(0,g.Z)(["fragColor = applyBackgroundBlend(overlay(ve.r, u_minValue, u_maxValue, hillshade, alpha));"]))):(0,A.H)(_||(_=(0,g.Z)(["hillshade *= alpha;\nfragColor = applyBackgroundBlend(vec4(hillshade, hillshade, hillshade, alpha));"])));i.code.add((0,A.H)(m||(m=(0,g.Z)(["\n    void main() {\n      vec2 pixelLocation = getPixelLocation(uv);\n      if (isOutside(pixelLocation)) {\n        fragColor = applyBackgroundBlend(vec4(0.0, 0.0, 0.0, 0.0));\n        return;\n      }\n\n      vec4 currentPixel = getPixel(pixelLocation);\n      if (currentPixel.a == 0.0) {\n        fragColor = applyBackgroundBlend(vec4(0.0, 0.0, 0.0, 0.0));\n        return;\n      }\n\n      //mirror edge pixels\n      vec2 axy = vec2(-1.0, -1.0);\n      vec2 bxy = vec2(0.0, -1.0);\n      vec2 cxy = vec2(1.0, -1.0);\n      vec2 dxy = vec2(-1.0, 0.0);\n      vec2 fxy = vec2(1.0, 0.0);\n      vec2 gxy = vec2(-1.0, 1.0);\n      vec2 hxy = vec2(0.0, 1.0);\n      vec2 ixy = vec2(1.0, 1.0);\n      vec2 onePixel = 1.0 / u_srcImageSize;\n      if (pixelLocation.s < onePixel.s) {\n        axy[0] = 1.0;\n        dxy[0] = 1.0;\n        gxy[0] = 1.0;\n      }\n      if (pixelLocation.t < onePixel.t) {\n        axy[1] = 1.0;\n        bxy[1] = 1.0;\n        cxy[1] = 1.0;\n      }\n      if (pixelLocation.s > 1.0 - onePixel.s) {\n        cxy[0] = -1.0;\n        fxy[0] = -1.0;\n        ixy[0] = -1.0;\n      }\n      if (pixelLocation.t > 1.0 - onePixel.t) {\n        gxy[1] = -1.0;\n        hxy[1] = -1.0;\n        ixy[1] = -1.0;\n      }\n\n      // calculate hillshade\n      vec4 va = texture(u_image, pixelLocation + onePixel * axy);\n      vec4 vb = texture(u_image, pixelLocation + onePixel * bxy);\n      vec4 vc = texture(u_image, pixelLocation + onePixel * cxy);\n      vec4 vd = texture(u_image, pixelLocation + onePixel * dxy);\n      vec4 ve = texture(u_image, pixelLocation);\n      vec4 vf = texture(u_image, pixelLocation + onePixel * fxy);\n      vec4 vg = texture(u_image, pixelLocation + onePixel * gxy);\n      vec4 vh = texture(u_image, pixelLocation + onePixel * hxy);\n      vec4 vi = texture(u_image, pixelLocation + onePixel * ixy);\n\n      // calculate the rate of z change along the x, y, and diagonal direction\n      float dzx = (vc + 2.0 * vf + vi - va - 2.0 * vd - vg).r * u_factor.s;\n      float dzy = (vg + 2.0 * vh + vi - va - 2.0 * vb - vc).r * u_factor.t;\n      float dzd = sqrt(1.0 + dzx * dzx + dzy * dzy);\n      float hillshade = 0.0;\n\n      // traditional single light source\n      if (u_hillshadeType == 0){\n        float cosDelta = u_sinZsinAs[0] * dzy - u_sinZcosAs[0] * dzx;\n        float z = (u_cosZs[0] + cosDelta) / dzd;\n        if (z < 0.0)  z = 0.0;\n        hillshade = z;\n      } else {\n        // multi-directional with 6 light sources\n        for (int k = 0; k < 6; k++) {\n        float cosDelta = u_sinZsinAs[k] * dzy - u_sinZcosAs[k] * dzx;\n        float z = (u_cosZs[k] + cosDelta) / dzd;\n        if (z < 0.0) z = 0.0;\n        hillshade = hillshade + z * u_weights[k];\n        if (k == 5) break;\n        }\n      }\n\n      // set color\n      float alpha = getNeighborHoodAlpha(va.a, vb.a, vc.a, vd.a, ve.a, vf.a, vg.a, vh.a, vi.a);\n      alpha *= u_opacity;\n      ","\n    }\n  "])),n))}(t,e),t}const U=Object.freeze(Object.defineProperty({__proto__:null,ColorizerHillshadeUniforms:L,ColorizerStretchUniforms:I,ColorizerUniforms:D,build:N},Symbol.toStringTag,{value:"Module"}))},13378:(e,t,i)=>{i.d(t,{S:()=>g,a:()=>b,b:()=>v});var n,r=i(30168),s=i(29134),a=i(7025),o=i(24967),l=i(54943),h=i(93511),c=i(96415),d=i(78980),u=i(98634),p=i(8654),_=i(64201),m=i(19253);const g=255,f=1/g;function v(e){const t=new _.kG,i=t.fragment;return i.include(d.n),i.include(l.K),t.include(c.GZ),t.include(o.k),t.include(h.hb,e),i.uniforms.add(new m.A("shadowMap",((e,t)=>t.shadowMap.depthTexture)),new m.A("depthMap",((e,t)=>{var i;return null===(i=t.depth)||void 0===i?void 0:i.attachment})),new p.g("inverseViewMatrix",((e,t)=>(0,s.U_)(y,(0,s.Iu)(y,t.camera.viewMatrix,t.camera.center))))),i.constants.add("sampleValue","float",f),t.outputs.add("sampleCount","float"),i.code.add((0,u.H)(n||(n=(0,r.Z)(["void main(void) {\nfloat depth = depthFromTexture(depthMap, uv);\nif (depth >= 1.0 || depth <= 0.0) {\ndiscard;\n}\nfloat currentPixelDepth = linearizeDepth(depth);\nvec4 currentPixelPos = vec4(reconstructPosition(gl_FragCoord.xy, currentPixelDepth), 1.0);\nvec4 worldSpacePos = inverseViewMatrix * currentPixelPos;\nmat4 shadowMatrix;\nfloat linearDepth = -currentPixelDepth;\nint i = chooseCascade(linearDepth, shadowMatrix);\nif (i >= numCascades) {\ndiscard;\n}\nvec3 lvpos = lightSpacePosition(worldSpacePos.xyz, shadowMatrix);\nif (lvpos.z >= 1.0 || lvpos.x < 0.0 || lvpos.x > 1.0 || lvpos.y < 0.0 || lvpos.y > 1.0) {\ndiscard;\n}\nivec2 texSize = textureSize(shadowMap, 0);\nivec2 uvShadow = ivec2(cascadeCoordinates(i, texSize, lvpos) * vec2(texSize));\nfloat depthShadow = readShadowMapDepth(uvShadow, shadowMap);\nbool shadow = depthShadow < lvpos.z;\nif (!shadow) {\ndiscard;\n}\nsampleCount = sampleValue;\n}"])))),t}const y=(0,a.Ue)(),b=Object.freeze(Object.defineProperty({__proto__:null,ShadowCastMaxSamples:g,build:v},Symbol.toStringTag,{value:"Module"}))},89822:(e,t,i)=>{i.d(t,{S:()=>b,a:()=>x,b:()=>C});var n,r,s,a,o=i(30168),l=i(86361),h=i(24967),c=i(54943),d=i(96415),u=i(78980),p=i(95276),_=i(58406),m=i(98634),g=i(64201),f=i(19253),v=i(13378),y=i(79485);class b extends m.K{constructor(e){super(),this._data=e,this.sampleScale=0,this.opacityFromElevation=1,this.color=(0,l.d9)(w),this.bandSize=.1,this.threshold=.5}get shadowCastMap(){return this._data.shadowCastTexture}}const w=(0,l.al)(.01,0,.25,1);function C(e){const t=new g.kG,i=t.fragment;i.include(u.n),i.include(c.S),t.include(d.GZ),t.include(h.k);const{visualization:l,bandsEnabled:b}=e;i.constants.add("inverseSampleValue","float",v.S),i.uniforms.add(new f.A("shadowCastMap",(e=>e.shadowCastMap)),new _.p("sampleScale",(e=>e.sampleScale)),new _.p("opacityFromElevation",(e=>e.opacityFromElevation)),new p.N("uColor",(e=>e.color)));const w=l===y.w.Gradient,C=l===y.w.Threshold;return w&&b?i.uniforms.add(new _.p("bandSize",(e=>e.bandSize))):C&&i.uniforms.add(new _.p("threshold",(e=>e.threshold))),i.code.add((0,m.H)(n||(n=(0,o.Z)(["\n    void main(void) {\n      float record = texture(shadowCastMap, uv).r;\n      float pixelSamples = record * inverseSampleValue;\n      if (pixelSamples < 1.0) {\n        discard;\n      }\n\n      float strength = pixelSamples * sampleScale;\n\n      ","\n\n      ","\n\n      fragColor = vec4(uColor.xyz, uColor.a * opacityFromElevation ",");\n    }\n  "])),C?(0,m.H)(r||(r=(0,o.Z)(["\n          if (strength <= threshold) {\n            discard;\n          }"]))):"",w&&b?(0,m.H)(s||(s=(0,o.Z)(["strength = ceil(strength / bandSize) * bandSize;"]))):"",w?(0,m.H)(a||(a=(0,o.Z)(["* strength"]))):"")),t}const x=Object.freeze(Object.defineProperty({__proto__:null,ShadowCastVisualizePassParameters:b,build:C},Symbol.toStringTag,{value:"Module"}))},38727:(e,t,i)=>{i.d(t,{S:()=>M,b:()=>T});var n,r=i(30168),s=i(29134),a=i(7025),o=i(32035),l=i(12400),h=i(75831),c=i(24967),d=i(137),u=i(93511),p=i(78980),_=i(49450),m=i(95276),g=i(58406),f=i(98634),v=i(8654),y=i(64201),b=i(19253),w=i(471);const C=.99999,x=.025;function T(e){const t=new y.kG;t.include(u.hb,e),t.include(c.k),t.include(h.R);const i=t.fragment;return i.include(p.n),i.uniforms.add(new b.A("defaultDepthTex",((e,t)=>t.shadowMap.getSnapshot(w.i.ExcludeHighlight))),new b.A("highlightDepthTex",((e,t)=>t.shadowMap.getSnapshot(w.i.Highlight))),new b.A("depthMap",((e,t)=>{var i;return null===(i=t.depth)||void 0===i?void 0:i.attachment})),new b.A("highlightTexture",(e=>e.highlight)),new m.N("uColor",(e=>e.shadowColor)),new g.p("opacity",(e=>e.shadowOpacity)),new g.p("occludedOpacity",(e=>e.occludedShadowOpacity)),new g.p("terminationFactor",(e=>e.opacityElevation*e.dayNightTerminator)),new _.J("lightingMainDirectionView",((e,t)=>(0,o.n)(P,(0,o.h)(P,t.lighting.mainLight.direction,t.camera.viewInverseTransposeMatrix)))),new v.g("inverseViewMatrix",((e,t)=>(0,s.U_)(S,(0,s.Iu)(S,t.camera.viewMatrix,t.camera.center))))),i.constants.add("unoccludedHighlightFlag","vec4",d.ck),i.code.add((0,f.H)(n||(n=(0,r.Z)(["\n    void main(void) {\n      vec4 highlightInfo = texture(highlightTexture, uv);\n      float visiblyHighlighted = (1.0 - clamp(distance(unoccludedHighlightFlag, highlightInfo), 0.0, 1.0)) * highlightInfo.a;\n      if (visiblyHighlighted > ",") {\n        discard;\n      }\n\n      float depth = depthFromTexture(depthMap, uv);\n\n      // 1.0 is the clear value of depthMap, which means nothing has been drawn there and we should discard\n      if (depth >= 1.0 || depth <= 0.0) {\n        discard;\n      }\n\n      float currentPixelDepth = linearizeDepth(depth);\n      vec4 currentPixelPos = vec4(reconstructPosition(gl_FragCoord.xy, currentPixelDepth), 1.0);\n      vec4 worldSpacePos = inverseViewMatrix * currentPixelPos;\n\n      mat4 shadowMatrix;\n      float linearDepth = -currentPixelDepth;\n      int i = chooseCascade(linearDepth, shadowMatrix);\n      if (i >= numCascades) {\n        discard;\n      }\n\n      vec3 lvpos = lightSpacePosition(worldSpacePos.xyz, shadowMatrix);\n\n      // vertex completely outside? -> no shadow\n      if (lvpos.z >= 1.0 || lvpos.x < 0.0 || lvpos.x > 1.0 || lvpos.y < 0.0 || lvpos.y > 1.0) {\n        discard;\n      }\n\n      ivec2 texSize = textureSize(highlightDepthTex, 0);\n      ivec2 uvShadow = ivec2(cascadeCoordinates(i, texSize, lvpos) * vec2(texSize));\n\n      float depthHighlight = readShadowMapDepth(uvShadow, highlightDepthTex);\n      bool shadowHighlight = depthHighlight < lvpos.z;\n      if (!shadowHighlight) {\n        discard;\n      }\n\n      float depthDefault = readShadowMapDepth(uvShadow, defaultDepthTex);\n      bool shadowDefault = depthDefault < lvpos.z;\n\n      vec3 normal = normalFromDepth(depthMap, currentPixelPos.xyz, gl_FragCoord.xy, uv);\n      bool shaded = dot(normal, lightingMainDirectionView) < ",";\n\n      float fragOpacity = (shadowDefault || shaded) ? occludedOpacity : opacity;\n      fragColor = vec4(uColor.rgb, uColor.a * fragOpacity * terminationFactor);\n    }\n  "])),f.H.float(C),f.H.float(x))),t}const S=(0,a.Ue)(),P=(0,l.Ue)(),M=Object.freeze(Object.defineProperty({__proto__:null,build:T},Symbol.toStringTag,{value:"Module"}))},92014:(e,t,i)=>{i.d(t,{S:()=>S,a:()=>R,b:()=>P,c:()=>M});var n,r,s,a,o,l,h,c,d=i(30168),u=i(6644),p=i(12400),_=i(69362),m=i(94951),g=i(92395),f=i(82999),v=i(49450),y=i(58406),b=i(98634),w=i(8654),C=i(64201),x=i(19253),T=i(4760);class S extends b.K{constructor(){super(...arguments),this.texV=(0,u.Ue)(),this.altitudeFade=0,this.innerScale=0,this.undergroundFadeAlpha=0,this.silhouette=new P}}class P{constructor(){this.center=(0,p.Ue)(),this.v1=(0,p.Ue)(),this.v2=(0,p.Ue)()}}function M(e){const t=new C.kG,{vertex:i,fragment:u}=t;if((0,g.Pe)(i),e.geometry===_.n.Underground)t.attributes.add(T.T.POSITION,"vec2"),t.varyings.add("color","vec4"),i.uniforms.add(new v.J("cameraPosition",((e,t)=>t.camera.eye)),new y.p("undergroundFadeAlpha",(e=>e.undergroundFadeAlpha))),i.code.add((0,b.H)(n||(n=(0,d.Z)(["void main(void) {\nfloat ndotl = dot(normalize(cameraPosition), mainLightDirection);\nfloat lighting = max(0.0, smoothstep(-1.0, 0.8, 2.0 * ndotl));\ncolor = vec4(vec3(lighting), undergroundFadeAlpha);\ngl_Position = vec4(position.xy, 1.0, 1.0);\n}"])))),u.code.add((0,b.H)(r||(r=(0,d.Z)(["void main() {\nfragColor = color;\n}"]))));else{t.include(m.w,e),t.attributes.add(T.T.POSITION,"vec3"),t.varyings.add("vtc","vec2"),t.varyings.add("falloff","float");const n=e.geometry===_.n.Cylinder;i.uniforms.add(new w.g("proj",((e,t)=>t.camera.projectionMatrix)),new w.g("view",((e,t)=>t.camera.viewMatrix))),n||(t.varyings.add("innerFactor","float"),i.uniforms.add(new v.J("silCircleCenter",(e=>e.silhouette.center))),i.uniforms.add(new v.J("silCircleV1",(e=>e.silhouette.v1))),i.uniforms.add(new v.J("silCircleV2",(e=>e.silhouette.v2))),i.uniforms.add(new f.A("texV",(e=>e.texV))),i.uniforms.add(new y.p("innerScale",(e=>e.innerScale))));const r=6.2831853,p=1/128;i.code.add((0,b.H)(s||(s=(0,d.Z)(["\n\t\tvoid main(void) {\n      ","\n      falloff = max(0.0, smoothstep(-1.0, 0.8, 2.0 * ndotl));\n\n\t\t  gl_Position = transformPosition(proj, view, pos);\n\t\t  gl_Position.z = gl_Position.w; // project atmosphere onto the far plane\n    }\n\t  "])),n?(0,b.H)(a||(a=(0,d.Z)(["\n      vec3 pos = position;\n      float ndotl = mainLightDirection.z;\n      vtc = vec2(0.0, position.z + 0.05);"]))):(0,b.H)(o||(o=(0,d.Z)(["\n      innerFactor = clamp(-position.z, 0.0, 1.0);\n      float scale = position.y * (1.0 + innerFactor * innerScale);\n      float phi = position.x * "," + 1.0;\n      vec3 pos =  (silCircleCenter + sin(phi) * silCircleV1 + cos(phi) * silCircleV2) * scale;\n      float ndotl = dot(normalize(position.y > 0.0 ? pos: silCircleCenter), mainLightDirection);\n      vtc.x = position.x  * ",";\n      vtc.y = texV.x * (1.0 - position.z) + texV.y * position.z;\n      "])),b.H.float(r*p),b.H.float(p)))),u.uniforms.add(new x.A("tex",(e=>e.texture))),n||u.uniforms.add(new y.p("altitudeFade",(e=>e.altitudeFade))),u.code.add((0,b.H)(l||(l=(0,d.Z)(["\n\t\tvoid main() {\n\t\t\tvec4 atmosphereColor = texture(tex, vtc) * falloff;\n      ","\n    }"])),n?(0,b.H)(h||(h=(0,d.Z)(["fragColor = atmosphereColor;"]))):(0,b.H)(c||(c=(0,d.Z)(["\n\t\t\tvec4 innerColor = vec4(atmosphereColor.rgb, 1.0 - altitudeFade);\n\t\t\tfragColor = mix(atmosphereColor, innerColor, smoothstep(0.0, 1.0, innerFactor));\n      "])))))}return t}const R=Object.freeze(Object.defineProperty({__proto__:null,SilhouetteCircle:P,SimpleAtmospherePassParameters:S,build:M},Symbol.toStringTag,{value:"Module"}))},96894:(e,t,i)=>{i.d(t,{S:()=>g,b:()=>_});var n,r,s=i(30168),a=i(29134),o=i(7025),l=i(95276),h=i(58406),c=i(98634),d=i(8654),u=i(64201),p=i(4760);function _(){const e=new u.kG;return e.attributes.add(p.T.POSITION,"vec3"),e.attributes.add(p.T.COLOR,"vec4"),e.attributes.add(p.T.SIZE,"float"),e.varyings.add("vcolor","vec4"),e.varyings.add("vsize","float"),e.vertex.uniforms.add(new d.g("transform",((e,t)=>function(e,t){const i=24e-8;return(0,a.JG)(m,t.camera.projectionMatrix),m[10]=i-1,m[11]=-1,m[14]=(i-2)*t.camera.near,(0,a.Jp)(m,m,t.camera.viewMatrix),(0,a.Jp)(m,m,e.modelMatrix)}(e,t))),new l.N("viewport",((e,t)=>t.camera.fullViewport)),new h.p("pixelRatio",((e,t)=>t.camera.pixelRatio))),e.vertex.code.add((0,c.H)(n||(n=(0,s.Z)(["void main(void) {\ngl_Position = transform * vec4(position, 0);\nvcolor = color / 1.2;\nvsize = size * 5.0 * pixelRatio;\ngl_PointSize = vsize;\n}"])))),e.fragment.code.add((0,c.H)(r||(r=(0,s.Z)(["void main() {\nfloat cap = 0.7;\nfloat scale = 1.0 / cap;\nfloat helper = clamp(length(abs(gl_PointCoord - vec2(0.5))), 0.0, cap);\nfloat alpha = clamp((cap - helper) * scale, 0.0, 1.0);\nfloat intensity = alpha * alpha * alpha;\nif (vsize < 3.0) {\nintensity *= 0.5;\n}\nfragColor = vec4(vcolor.xyz, intensity);\n}"])))),e}const m=(0,o.Ue)(),g=Object.freeze(Object.defineProperty({__proto__:null,build:_},Symbol.toStringTag,{value:"Module"}))},73401:(e,t,i)=>{i.d(t,{S:()=>l});var n,r,s,a=i(84397),o={exports:{}};n=o,r=function(){var e=Math.PI,t=Math.sin,i=Math.cos,n=Math.tan,r=Math.asin,s=Math.atan2,a=Math.acos,o=e/180,l=864e5,h=2440588,c=2451545,d={dec:0,ra:0};function u(e){return new Date((e+.5-h)*l)}function p(e){return function(e){return e.valueOf()/l-.5+h}(e)-c}var _=23.4397*o;function m(e,r){return s(t(e)*i(_)-n(r)*t(_),i(e))}function g(e,n){return r(t(n)*i(_)+i(n)*t(_)*t(e))}function f(e,r,a){return s(t(e),i(e)*t(r)-n(a)*i(r))}function v(e,n,s){return r(t(n)*t(s)+i(n)*i(s)*i(e))}function y(e,t){return o*(280.16+360.9856235*e)-t}function b(e){return o*(357.5291+.98560028*e)}function w(e){return o*(1.9148*t(e)+.02*t(2*e)+3e-4*t(3*e))}function C(t,i){return t+i+102.9372*o+e}function x(e,t){var i=b(e),n=C(i,w(i));return t||(t={dec:0,ra:0}),t.dec=g(n,0),t.ra=m(n,0),t}var T={PolarException:{NORMAL:0,MIDNIGHT_SUN:1,POLAR_NIGHT:2},getPosition:function(e,t,i,n){var r=o*-i,s=o*t,a=p(e),l=x(a,d),h=y(a,r)-l.ra;return n||(n={azimuth:0,altitude:0}),n.azimuth=f(h,s,l.dec),n.altitude=v(h,s,l.dec),n}},S=[[-.83,"sunrise","sunset"]];T.addTime=function(e,t,i){S.push([e,t,i])};var P=9e-4;function M(t,i){return Math.round(t-P-i/(2*e))}function R(t,i,n){return P+(t+i)/(2*e)+n}function A(e,i,n){return c+e+.0053*t(i)-.0069*t(2*n)}function O(e,n,r){return a((t(e)-t(n)*t(r))/(i(n)*i(r)))}function E(e){var n=o*(134.963+13.064993*e),r=o*(93.272+13.22935*e),s=o*(218.316+13.176396*e)+6.289*o*t(n),a=5.128*o*t(r),l=385001-20905*i(n);return{ra:m(s,a),dec:g(s,a),dist:l}}return T.getTimes=function(e,n,r){var s=o*-r,a=o*n,l=M(p(e),s),h=R(0,s,l),c=b(h),d=w(c),_=C(c,d),m=g(_,0),f=A(h,c,_);function v(e){return A(R(O(e,a,m),s,l),c,_)}var y,x,P,E,D,I={solarNoon:u(f),nadir:u(f-.5),polarException:T.PolarException.NORMAL};for(y=0,x=S.length;y<x;y+=1)D=f-((E=v((P=S[y])[0]*o))-f),I[P[1]]=u(D),I[P[2]]=u(E);return I.polarException=function(e){var n=(t(e)-t(a)*t(m))/(i(a)*i(m));return n<-1?T.PolarException.MIDNIGHT_SUN:n>1?T.PolarException.POLAR_NIGHT:T.PolarException.NORMAL}(S[0][0]*o),I},T.getMoonPosition=function(e,t,i){var r=o*-i,s=o*t,a=p(e),l=E(a),h=y(a,r)-l.ra,c=v(h,s,l.dec);return c+=.017*o/n(c+10.26*o/(c+5.1*o)),{azimuth:f(h,s,l.dec),altitude:c,distance:l.dist}},T.getMoonFraction=function(e){var n=p(e),r=x(n),o=E(n),l=149598e3,h=a(t(r.dec)*t(o.dec)+i(r.dec)*i(o.dec)*i(r.ra-o.ra)),c=s(l*t(h),o.dist-l*i(h));return(1+i(c))/2},T},void 0!==(s=r())&&(n.exports=s);const l=(0,a.g)(o.exports)},89438:(e,t,i)=>{i.d(t,{T:()=>fe,a:()=>we,b:()=>ve});var n,r,s,a,o,l,h,c,d,u,p,_,m,g,f,v,y,b,w,C,x,T,S,P,M,R,A,O,E,D,I,L,N,U,H,F,V,q,z=i(30168),B=i(29134),G=i(7025),k=i(32035),Z=i(12400),j=i(92015),W=i(22357),X=i(37081),Q=i(33280),Y=i(94951),J=i(16010),K=i(52276),$=i(60113),ee=i(97397),te=i(16574),ie=i(137),ne=i(30694),re=i(34975),se=i(92395),ae=i(8555),oe=i(41481),le=i(93511),he=i(22702),ce=i(28288),de=i(41012),ue=i(49450),pe=i(98634),_e=i(76028),me=i(64201),ge=i(19253);class fe extends ce.uS{}function ve(e){const t=new me.kG,{vertex:i,fragment:G,varyings:Z}=t;t.include(K.f),t.include(J.O,e),t.include($.D,e);const fe=()=>{t.include(ae.n,e),i.code.add((0,pe.H)(n||(n=(0,z.Z)(["vec3 getNormal() {\nfloat z = 1.0 - abs(normalCompressed.x) - abs(normalCompressed.y);\nvec3 n = vec3(normalCompressed + vec2(normalCompressed.x >= 0.0 ? 1.0 : -1.0,\nnormalCompressed.y >= 0.0 ? 1.0 : -1.0) * min(z, 0.0), z);\nreturn normalize(n);\n}"]))))};(0,de.Sv)(i,e),t.include(Y.w,e);const ve=e.overlayMode!==he.gT.Disabled,we=ve&&e.invisible;switch(e.output){case X.H_.Color:{t.include(ce.EK,e),t.include(re.XP,e),ve&&t.include(he.yl,{...e,pbrMode:e.pbrMode===oe.f7.Simplified?oe.f7.TerrainWithWater:oe.f7.Water});const n=e.overlayMode===he.gT.EnabledWithWater;n&&t.include(ee.M,e),Z.add("vnormal","vec3"),Z.add("vpos","vec3"),Z.add("vup","vec3"),fe(),e.screenSizePerspective&&(0,de._8)(i);const C=e.receiveShadows&&!e.renderOccluded;C&&t.include(W.qj,e),e.screenSizePerspective&&(Z.add("screenSizeDistanceToCamera","float"),Z.add("screenSizeCosAngle","float")),i.code.add((0,pe.H)(r||(r=(0,z.Z)(["\n        void main(void) {\n          //Position\n          vpos = position;\n          vec3 positionWorld = position + localOrigin;\n          gl_Position = transformPosition(proj, view, vpos);\n\n          //Normal\n          vnormal = getNormal();\n\n          //Up\n          vup = getLocalUp(position, localOrigin);\n\n          ","\n\n          //Texture UV\n          vec2 uv = getUV0();\n          forwardTextureCoordinatesWithTransform(uv);\n          ","\n          ","\n\n          ","\n\n          ","\n\n        }\n      "])),n?(0,pe.H)(s||(s=(0,z.Z)(["forwardVertexTangent(vnormal);"]))):(0,pe.H)(a||(a=(0,z.Z)([""]))),ve?(0,pe.H)(o||(o=(0,z.Z)(["setOverlayVTC(uv);"]))):"",e.tileBorders?(0,pe.H)(l||(l=(0,z.Z)(["forwardTextureCoordinates();"]))):"",e.screenSizePerspective?(0,pe.H)(h||(h=(0,z.Z)(["\n          vec3 viewPos = (view * vec4(vpos, 1.0)).xyz;\n          screenSizeDistanceToCamera = length(viewPos);\n          vec3 viewSpaceNormal = (viewNormal * vec4(normalize(positionWorld), 1.0)).xyz;\n          screenSizeCosAngle = abs(viewSpaceNormal.z);"]))):"",C?(0,pe.H)(c||(c=(0,z.Z)(["forwardLinearDepth();"]))):"")),t.include(Q.f5,e),t.include(re.XP,e),t.include(ne.K,e),t.include(le.XE,e),(0,de.hY)(G,e),(0,re.PN)(G),(0,re.sC)(G),G.uniforms.add(i.uniforms.get("localOrigin"),new ue.J("viewDirection",((e,t)=>(0,k.n)(be,(0,k.s)(be,t.camera.viewMatrix[12],t.camera.viewMatrix[13],t.camera.viewMatrix[14]))))),n&&G.uniforms.add(new ge.A("ovWaterTex",((e,t)=>{var i;return null===(i=t.overlay)||void 0===i?void 0:i.getTexture(j.D.WaterNormal)})),new _e.K("view",((e,t)=>(0,B.Iu)(ye,t.camera.viewMatrix,e.origin)))),G.code.add((0,pe.H)(d||(d=(0,z.Z)(["const float sliceOpacity = 0.2;\nfloat lum(vec3 c) {\nreturn (min(min(c.r, c.g), c.b) + max(max(c.r, c.g), c.b)) * 0.5;\n}"])))),(0,se.Pe)(G),(0,se.F1)(G),G.code.add((0,pe.H)(u||(u=(0,z.Z)(["\n        void main() {\n          vec3 normal = normalize(vnormal);\n          float vndl = dot(normal, mainLightDirection);\n\n          float additionalAmbientScale = smoothstep(0.0, 1.0, clamp(vndl*2.5, 0.0, 1.0));\n          float shadow = ",";\n\n          float ssao = evaluateAmbientOcclusionInverse();\n          vec4 tileColor = getTileColor();\n\n          ","\n\n          // If combined alpha is 0 we can discard pixel. The performance impact by having a discard here\n          // is neglectable because terrain typically renders first into the framebuffer.\n          if(tileColor.a <= 0.0) {\n            discard;\n          }\n\n          bool sliced = rejectBySlice(vpos);\n          if (sliced) {\n            tileColor *= sliceOpacity;\n          }\n\n          vec3 albedo = tileColor.rgb;\n\n          // heuristic shading function used in the old terrain, now used to add ambient lighting\n\n          vec3 additionalLight = ssao * mainLightIntensity * additionalAmbientScale * ambientBoostFactor * lightingGlobalFactor;\n\n          ","\n          ","\n          ","\n          ","\n          ","\n          fragColor = highlightSlice(fragColor, vpos);\n        }\n      "])),e.receiveShadows&&!e.renderOccluded?"readShadowMap(vpos, linearDepth)":e.spherical?"lightingGlobalFactor * (1.0 - additionalAmbientScale)":"0.0",ve?(0,pe.H)(p||(p=(0,z.Z)(["\n              vec4 overlayColorOpaque = getOverlayColor(ovColorTex, vtcOverlay);\n              vec4 overlayColor = overlayOpacity * overlayColorOpaque;\n              ","\n              vec4 groundColor = tileColor;\n              tileColor = tileColor * (1.0 - overlayColor.a) + overlayColor;"])),e.invisible?(0,pe.H)(_||(_=(0,z.Z)(["if (overlayColor.a == 0.0) { discard; }"]))):""):"",e.pbrMode===oe.f7.Simplified||e.pbrMode===oe.f7.TerrainWithWater?(0,pe.H)(m||(m=(0,z.Z)(["fragColor = vec4(evaluatePBRSimplifiedLighting(normal, albedo, shadow, 1.0 - ssao, additionalLight, normalize(vpos - cameraPosition), vup), tileColor.a);"]))):(0,pe.H)(g||(g=(0,z.Z)(["fragColor = vec4(evaluateSceneLighting(normal, albedo, shadow, 1.0 - ssao, additionalLight), tileColor.a);"]))),n?(0,pe.H)(f||(f=(0,z.Z)(["\n              vec4 overlayWaterMask = getOverlayColor(ovWaterTex, vtcOverlay);\n              float waterNormalLength = length(overlayWaterMask);\n              if (waterNormalLength > 0.95) {\n                mat3 tbnMatrix = mat3(tbnTangent, tbnBiTangent, vnormal);\n                vec4 waterOverlayColor = vec4(overlayColor.w > 0.0 ? overlayColorOpaque.xyz/overlayColor.w : vec3(1.0), overlayColor.w);\n                vec4 viewPosition = view*vec4(vpos, 1.0);\n                vec4 waterColorLinear = getOverlayWaterColor(overlayWaterMask, waterOverlayColor, -normalize(vpos - cameraPosition), shadow, vnormal, tbnMatrix, viewPosition.xyz,  vpos + localOrigin);\n                vec4 waterColorNonLinear = delinearizeGamma(vec4(waterColorLinear.xyz, 1.0));\n                float opacity = sliced ? sliceOpacity : 1.0;\n                // un-gamma the ground color to mix in linear space\n                fragColor = mix(groundColor, waterColorNonLinear, waterColorLinear.w) * opacity;\n              }"]))):"",e.screenSizePerspective?(0,pe.H)(v||(v=(0,z.Z)(["\n            float perspectiveScale = screenSizePerspectiveScaleFloat(1.0, screenSizeCosAngle, screenSizeDistanceToCamera, vec4(0.0, 0.0, 0.0, 0.0));\n            if (perspectiveScale <= 0.25) {\n              fragColor = mix(fragColor, vec4(1.0, 0.0, 0.0, 1.0), perspectiveScale * 4.0);\n            }\n            else if (perspectiveScale <= 0.5) {\n              fragColor = mix(fragColor, vec4(0.0, 0.0, 1.0, 1.0), (perspectiveScale - 0.25) * 4.0);\n            }\n            else if (perspectiveScale >= 0.99) {\n              fragColor = mix(fragColor, vec4(0.0, 1.0, 0.0, 1.0), 0.2);\n            }\n            else {\n              fragColor = mix(fragColor, vec4(1.0, 0.0, 1.0, 1.0), (perspectiveScale - 0.5) * 2.0);\n            }"]))):"",e.visualizeNormals?e.spherical?(0,pe.H)(y||(y=(0,z.Z)(["\n                  vec3 localUp = normalize(vpos + localOrigin);\n                  vec3 right = normalize(cross(vec3(0.0, 0.0, 1.0), localUp));\n                  vec3 forward = normalize(cross(localUp, right));\n                  mat3 tbn = mat3(right, forward, localUp);\n                  vec3 tNormal = normalize(normal * tbn);\n                  fragColor = vec4(vec3(0.5) + 0.5 * tNormal, 0.0);\n              "]))):(0,pe.H)(b||(b=(0,z.Z)(["\n                  vec3 tNormal = normalize(normal);\n                  fragColor = vec4(vec3(0.5) + 0.5 * tNormal, 0.0);\n              "]))):"",e.tileBorders?(0,pe.H)(w||(w=(0,z.Z)(["\n              vec2 dVuv = fwidth(vuv0);\n              vec2 edgeFactors = smoothstep(vec2(0.0), 1.5 * dVuv, min(vuv0, 1.0 - vuv0));\n              float edgeFactor = 1.0 - min(edgeFactors.x, edgeFactors.y);\n              fragColor = mix(fragColor, vec4(1.0, 0.0, 0.0, 1.0), edgeFactor);"]))):""))}break;case X.H_.Depth:we&&t.include(he.yl,e),i.code.add((0,pe.H)(C||(C=(0,z.Z)(["\n              void main(void) {\n                ","\n                gl_Position = transformPosition(proj, view, position);\n              }\n          "])),we?(0,pe.H)(x||(x=(0,z.Z)(["setOverlayVTC(getUV0());"]))):"")),G.code.add((0,pe.H)(T||(T=(0,z.Z)(["\n              void main() {\n                ","\n              }\n          "])),we?(0,pe.H)(S||(S=(0,z.Z)(["if (getCombinedOverlayColor().a == 0.0) { discard; }"]))):""));break;case X.H_.Shadow:case X.H_.ShadowHighlight:case X.H_.ShadowExcludeHighlight:case X.H_.ViewshedShadow:t.include(te.F,e),(0,W.Lm)(t),(0,W.Zu)(t),i.code.add((0,pe.H)(P||(P=(0,z.Z)(["void main(void) {\ngl_Position = transformPositionWithDepth(proj, view, position, nearFar, linearDepth);\n}"])))),G.code.add((0,pe.H)(M||(M=(0,z.Z)(["void main() {\noutputDepth(linearDepth);\n}"]))));break;case X.H_.Normal:we&&t.include(he.yl,e),Z.add("vnormal","vec3"),(0,de._8)(i),fe(),i.code.add((0,pe.H)(R||(R=(0,z.Z)(["\n        void main(void) {\n          ","\n          gl_Position = transformPosition(proj, view, position);\n          vnormal = normalize((viewNormal * vec4(getNormal(), 1.0)).xyz);\n        }\n      "])),we?(0,pe.H)(A||(A=(0,z.Z)(["setOverlayVTC(getUV0());"]))):"")),G.code.add((0,pe.H)(O||(O=(0,z.Z)(["\n        void main() {\n          ","\n          vec3 normal = normalize(vnormal);\n          if (gl_FrontFacing == false) {\n            normal = -normal;\n          }\n          fragColor = vec4(vec3(0.5) + 0.5 * normal, 1.0);\n        }\n      "])),we?(0,pe.H)(E||(E=(0,z.Z)(["if (getCombinedOverlayColor().a == 0.0) { discard; }"]))):""));break;case X.H_.Highlight:ve&&t.include(he.yl,e),i.code.add((0,pe.H)(D||(D=(0,z.Z)(["\n          void main() {\n            ","\n            gl_Position = transformPosition(proj, view, position);\n          }\n        "])),ve?(0,pe.H)(I||(I=(0,z.Z)(["setOverlayVTC(getUV0());"]))):"")),t.include(ie.bA,e),G.code.add((0,pe.H)(L||(L=(0,z.Z)(["\n          void main() {\n            ","\n            outputHighlight();\n          }\n        "])),ve?(0,pe.H)(N||(N=(0,z.Z)(["if (getCombinedOverlayColor().a == 0.0) { discard; }"]))):""))}return e.output===X.H_.ObjectAndLayerIdColor&&(ve?(t.include(he.yl,{...e,pbrMode:oe.f7.Disabled}),i.code.add((0,pe.H)(U||(U=(0,z.Z)(["void main(void) {\ngl_Position = transformPosition(proj, view, position);\nsetOverlayVTC(getUV0());\n}"])))),G.code.add((0,pe.H)(H||(H=(0,z.Z)(["void main() {\nfragColor = getOverlayColorTexel(vtcOverlay);\n}"]))))):(i.code.add((0,pe.H)(F||(F=(0,z.Z)(["void main(void) {\n        ","\n      }"])),e.opaque?(0,pe.H)(V||(V=(0,z.Z)([" gl_Position = transformPosition(proj, view, position);"]))):"")),G.code.add((0,pe.H)(q||(q=(0,z.Z)(["void main() {\nfragColor = vec4(0.0);\n}"])))))),t}const ye=(0,G.Ue)(),be=(0,Z.Ue)(),we=Object.freeze(Object.defineProperty({__proto__:null,TerrainPassParameters:fe,build:ve},Symbol.toStringTag,{value:"Module"}))},95720:(e,t,i)=>{i.d(t,{V:()=>S,a:()=>R,b:()=>P});var n,r,s,a,o=i(30168),l=i(29134),h=i(7025),c=i(75831),d=i(24967),u=i(54943),p=i(76284),_=i(24842),m=i(27193),g=i(82999),f=i(49450),v=i(699),y=i(99339),b=i(98634),w=i(8654),C=i(78928),x=i(64201),T=i(19253);class S extends p.c{constructor(){super(...arguments),this.targetVector=[1,0,0],this.upVector=[0,0,1],this.fovs=[45,45],this.headingAndTilt=[0,0],this.shadowMap={depthTexture:null,nearFar:[1,100],numActiveFaces:1,atlasRegions:[[0,0,1,1]]},this.projectionMatrices=h.Wd.flat(),this.viewMatrices=h.Wd.flat()}}function P(e){const t=new x.kG,i=t.fragment;t.include(d.k),t.include(p.C),t.include(m.r),i.include(u.K),i.include(_.f),i.uniforms.add(new T.A("depthTexture",((e,t)=>{var i;return null===(i=t.depth)||void 0===i?void 0:i.attachment}))),i.uniforms.add(new w.g("inverseProjectionMatrix",((e,t)=>t.camera.inverseProjectionMatrix)),new w.g("inverseViewNormalMatrix",((e,t)=>(0,l.iS)(M,t.camera.viewInverseTransposeMatrix)))),i.uniforms.add(new f.J("viewshedTargetVector",((e,t)=>e.targetVector)),new f.J("viewshedUpVector",((e,t)=>e.upVector)),new g.A("viewshedFOVs",((e,t)=>e.fovs)),new g.A("viewshedHeadingAndTilt",((e,t)=>e.headingAndTilt)),new g.A("viewshedNearFar",((e,t)=>{var i;return null!==(i=e.shadowMap.nearFar)&&void 0!==i?i:[1,100]}))),i.uniforms.add(new T.A("viewshedShadowMap",(e=>e.shadowMap.depthTexture)),new C.G("viewshedProjectionMatrices",((e,t)=>e.projectionMatrices),6),new C.G("viewshedViewMatrices",((e,t)=>e.viewMatrices),6),new y._("viewshedNumFaces",((e,t)=>e.shadowMap.numActiveFaces)),new v.O("viewshedAtlasRegions",((e,t)=>e.shadowMap.atlasRegions.flat()),24)),i.constants.add("visibleColor","vec4",[0,1,0,.5]),i.constants.add("occludedColor","vec4",[1,0,0,.5]);const h=e.useNormalMap;return h?(i.uniforms.add(new T.A("normalMap",((e,t)=>e.normalTexture))),i.code.add((0,b.H)(n||(n=(0,o.Z)(["vec3 normalFromTexture() {\nvec4 norm4 = texture(normalMap, uv);\nvec3 nNormal = vec3(-1.0) + 2.0 * norm4.xyz;\nreturn normalize((inverseViewNormalMatrix * vec4(nNormal, 1.0)).xyz);\n}"]))))):t.include(c.R),i.code.add((0,b.H)(r||(r=(0,o.Z)(["\n    // UV coordinates of point projected onto viewshed shadow map\n    vec2 getViewshedUv(vec4 worldPosition, int face) {\n      mat4 viewshedMatrix = viewshedProjectionMatrices[face];\n      vec4 viewshedUv4 = viewshedMatrix * worldPosition;\n      vec3 viewshedUv = viewshedUv4.xyz / viewshedUv4.w;\n      return viewshedUv.xy;\n    }\n\n    float viewshedDepthToFloat(float depth) {\n      return (depth - viewshedNearFar[0]) / (viewshedNearFar[1] - viewshedNearFar[0]);\n    }\n\n    // Orthographic depth to viewshed of given point and given cube map face in range [0, 1].\n    float getOrthographicDepthToViewshed(vec4 worldPosition, int face) {\n      mat4 viewshedViewMatrix = viewshedViewMatrices[face];\n      vec4 viewshedUv4 = viewshedViewMatrix * worldPosition;\n      vec3 viewshedUv = viewshedUv4.xyz / viewshedUv4.w;\n      float depth = -viewshedUv.z;\n      return viewshedDepthToFloat(depth);\n    }\n\n    // Read depth from shadow map given uv and cube map face\n    float getDepthFromShadowMap(vec2 uv, int face) {\n      int index = 4 * face;\n\n      float umin = viewshedAtlasRegions[index];\n      float umax = viewshedAtlasRegions[index + 1];\n      float vmin = viewshedAtlasRegions[index + 2];\n      float vmax = viewshedAtlasRegions[index + 3];\n\n      vec4 atlasRegion = vec4(umin, vmin, umax, vmax);\n      return rgba4ToFloat(textureAtlasLookup(viewshedShadowMap, uv, atlasRegion));\n    }\n\n    struct ViewshedPoint {\n      int face;\n      vec2 uv;\n      bool isWithin;\n      float orthographicDepth;\n    };\n\n    // Find cube map face the given position lies in and return relevant information about it\n    bool getViewshedPoint(vec4 worldPosition, out ViewshedPoint point) {\n      vec3 nUp = normalize(viewshedUpVector);\n\n      // Try with all active cube map faces\n      for(int i=0; i < viewshedNumFaces; i++) {\n\n        // Check if when projected, point lies within shadow map texture\n        vec2 viewshedUv = getViewshedUv(worldPosition, i);\n        if (viewshedUv.x > 0.0 && viewshedUv.x < 1.0 && viewshedUv.y > 0.0 && viewshedUv.y < 1.0) {\n          float orthoDepth = getOrthographicDepthToViewshed(worldPosition, i);\n          if (orthoDepth >= 0.0) { // found a cube map face\n\n            // Check whether point is really inside viewshed geometry, not just within the camera frustum\n\n            // outside farDistance\n            vec3 position = worldPosition.xyz;\n            bool isWithin = length(position) <= viewshedNearFar[1];\n\n            // horizontally outside fov\n            float t = dot(nUp, position);\n            bool isBottomHalf = t > 0.0;\n            vec3 nProjVector = normalize(position - t * nUp);\n            if (isWithin) {\n              float angle = acos(dot(normalize(viewshedTargetVector), nProjVector));\n              if (angle > viewshedFOVs[0] / 2.0) {\n                isWithin = false;\n              }\n            }\n\n            // vertically outside fov\n            if (isWithin) {\n              float angle = acos(dot(nProjVector, normalize(position)));\n              if (!isBottomHalf) {\n                angle = -angle;\n              }\n              float tilt = viewshedHeadingAndTilt[1];\n              float limit = viewshedFOVs[1] / 2.0;\n              if (angle > limit || angle < -limit) {\n                isWithin = false;\n              }\n            }\n\n            point = ViewshedPoint(i, viewshedUv, isWithin, orthoDepth);\n            return true;\n          }\n        }\n      }\n\n      // no cube face matches\n      return false;\n    }\n\n    float normalCosAngle(float linearDepth, vec3 localPosition) {\n      ",";\n\n      vec3 viewingDir = normalize(localPosition);\n      return dot(normal, viewingDir);\n    }\n\n    void main() {\n      float depth = depthFromTexture(depthTexture, uv);\n\n      // Outside camera planes\n      if (depth >= 1.0 || depth <= 0.0) {\n        return;\n      }\n\n      float linearDepth = linearizeDepth(depth);\n\n      // Relative to viewshed position\n      vec4 localPosition = reconstructLocalPosition(gl_FragCoord.xy, linearDepth);\n\n      ViewshedPoint point;\n      bool foundFace = getViewshedPoint(localPosition, point);\n\n      // Outside every viewshed\n      if (!foundFace || !point.isWithin) {\n        return;\n      }\n\n      float viewshedDepth = getDepthFromShadowMap(point.uv, point.face);\n      float distance = point.orthographicDepth;\n\n      bool visible = distance < viewshedDepth;\n      fragColor = visible ? visibleColor : occludedColor;\n\n      float cosAngle = normalCosAngle(linearDepth, localPosition.xyz);\n\n      // Everything facing away, and close to parallel is considered occluded.\n      // Theshold corresponds to around 0.6 degrees, tuned empirically.\n      if (cosAngle > -0.01) {\n        fragColor = occludedColor;\n      }\n    }"])),h?(0,b.H)(s||(s=(0,o.Z)(["vec3 normal = normalFromTexture();"]))):(0,b.H)(a||(a=(0,o.Z)(["\n        vec3 cameraSpacePosition = reconstructPosition(gl_FragCoord.xy, linearDepth);\n        vec3 normal = normalFromDepth(depthTexture, cameraSpacePosition, gl_FragCoord.xy, uv);\n        normal = (inverseViewNormalMatrix * vec4(normal, 1.0)).xyz;\n        "]))))),t}const M=(0,h.Ue)(),R=Object.freeze(Object.defineProperty({__proto__:null,ViewshedPassParameters:S,build:P},Symbol.toStringTag,{value:"Module"}))},85305:(e,t,i)=>{i.d(t,{BR:()=>b,E2:()=>A,Is:()=>x,Kf:()=>y,NE:()=>S,P0:()=>v,Tz:()=>R,Ue:()=>u,ej:()=>w,id:()=>C,pb:()=>f,pt:()=>m,qf:()=>p,rF:()=>T,yS:()=>M});var n=i(29134),r=i(32035),s=i(12400),a=i(83448),o=i(78952),l=i(29691),h=i(14320),c=i(82218),d=i(23470);function u(e){const{value:t,operations:i}=e;return{operations:i,value:i.create(t)}}function p(e,t,i){return e.operations.setExtent(e.value,t,i.value),i}function _(e,t){let i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:function(e){return{operations:e,value:e.create()}}(e);return i.operations=e,e.copy(t,i.value),i}function m(e){return _(d.s,(0,d.f)(0,0,0,(0,a.Iu)(e).radius))}const g=2**50;function f(){return _(c.b,(0,c.f)([0,0,0],[g,0,0],[0,g,0]))}function v(e,t,i){return e.operations.axisAt(e.value,t,h.R.Z,i)}function y(e,t,i,n){return e.operations.axisAt(e.value,t,i,n)}function b(e,t,i){return e.operations.intersectRay(e.value,t,i)}function w(e,t,i){return e.operations.intersectRayClosestSilhouette(e.value,t,i)}function C(e,t){return e.operations.altitudeAt(e.value,t)}function x(e,t,i,n){return e.operations.setAltitudeAt(e.value,t,i,n)}function T(e,t,i,s){return t!==s&&(0,n.JG)(s,t),(0,r.s)(P,s[12],s[13],s[14]),x(e,P,i,P),s[12]=P[0],s[13]=P[1],s[14]=P[2],s}function S(e,t,i){return e.operations.elevate(e.value,t,i.value)}const P=(0,s.Ue)();function M(e,t,i,n,s){return s[0]=(0,r.m)(e,t),s[1]=(0,r.m)(e,i),s[2]=(0,r.m)(e,n),s}function R(e,t,i,n,s){(0,r.c)(i,e),(0,r.c)(O,t),(0,r.n)(O,O),(0,r.b)(n,O,i),(0,r.b)(s,n,i)}function A(e,t){return e?(0,l.rS)(t):t.isGeographic?o.Z.PlateCarree:t}const O=(0,s.Ue)()},16553:(e,t,i)=>{i.d(t,{B:()=>g,J:()=>m});var n=i(10064),r=i(32718),s=i(76672),a=i(76969),o=i(6291),l=i(39638),h=i(37270),c=i(93253),d=i(819);const u=()=>r.Z.getLogger("esri.layers.support.labelFormatUtils"),p={type:"simple",evaluate:()=>null},_={getAttribute:(e,t)=>e.field(t)};async function m(e,t,i){if(!e||!e.symbol||!t)return p;const r=e.where,a=(0,c.hV)(e);let o;if("arcade"===a.type){const e=await(0,d.WW)(a.expression,i,t);if(null==e)return p;o={type:"arcade",evaluate(t,r){try{const i="attributes"in t?e.repurposeFeature(t):t;i.contextTimeZone=null!==r&&void 0!==r?r:null;const n=e.evaluate({$view:{timeZone:r},$feature:i},e.services);if(null!=n)return n.toString()}catch(i){u().error(new n.Z("arcade-expression-error","Encountered an error when evaluating label expression for feature",{error:i,feature:t,expression:a}))}return null},needsHydrationToEvaluate:()=>null==(0,c.el)(a.expression)}}else o={type:"simple",evaluate:e=>a.expression.replaceAll(/{[^}]*}/g,(i=>{const n=i.slice(1,-1),r=t.get(n);if(!r)return i;let s=null;return"attributes"in e?e&&e.attributes&&(s=e.attributes[r.name]):s=e.field(r.name),null==s?"":g(s,r)}))};if(r){let e;try{e=await(0,s.E)(r,t)}catch(l){return u().error(new n.Z("bad-where-clause","Encountered an error when evaluating where clause, ignoring",{where:r,error:l})),p}const i=o.evaluate;o.evaluate=(t,s)=>{const a="attributes"in t?void 0:_;try{if(e.testFeature(t,a))return i(t,s)}catch(l){u().error(new n.Z("bad-where-clause","Encountered an error when evaluating where clause for feature",{where:r,feature:t,error:l}))}return null}}return o}function g(e,t){if(null==e)return"";const i=t.domain;if(i)if("codedValue"===i.type||"coded-value"===i.type){const t=e;for(const e of i.codedValues)if(e.code===t)return e.name}else if("range"===i.type){const{max:n,min:r}=(0,l.D3)(t),s=+e;if(null!=r&&null!=n&&r<=s&&s<=n)return i.name}let n=e;return(0,h.y2)(t)?n=(0,a.p6)(n,(0,a.Ze)("short-date")):(0,h.H7)(t)&&(n=(0,o.uf)(+n)),n||""}},74509:(e,t,i)=>{i.d(t,{AA:()=>_,Jn:()=>h,LR:()=>M,Lt:()=>u,O3:()=>w,Ou:()=>v,RL:()=>d,Uy:()=>T,VW:()=>l,W_:()=>x,Wb:()=>S,XH:()=>m,Zz:()=>a,ap:()=>f,fl:()=>p,fm:()=>R,jG:()=>A,kf:()=>P,mF:()=>o,tR:()=>O,tq:()=>C,vQ:()=>y,vu:()=>c,zx:()=>b});var n=i(68860),r=i(88152);function s(e){return e?A:O}function a(e,t){return null!==t&&void 0!==t&&t.mode?t.mode:s(e).mode}function o(e,t){return null!=t?t:s(e)}function l(e,t){return a(null!=e&&e.hasZ,t)}function h(e,t){return o(null!=e&&!!e.hasZ,t)}function c(e){const t=g(e);return l(e.geometry,t)}function d(e){const t=g(e),i=l(e.geometry,t);return{mode:i,offset:null!=t&&"on-the-ground"!==i?R(t):0,featureExpressionInfo:null===t||void 0===t?void 0:t.featureExpressionInfo}}function u(e){return m(d(e))}function p(e){return m(e)||_(e)}function _(e){var t;return"0"===(null===e||void 0===e||null===(t=e.featureExpressionInfo)||void 0===t?void 0:t.expression)}function m(e){if(!e)return!1;if("on-the-ground"===e.mode)return!1;const t=null!==e&&void 0!==e&&e.featureExpressionInfo?e.featureExpressionInfo.expression:null;return!(!t||"0"===t)}function g(e){return e.layer&&"elevationInfo"in e.layer?e.layer.elevationInfo:null}function f(e,t){if(null===e||void 0===e||!e.offset)return 0;const{offset:i,unit:r}=e;if("decimal-degrees"===r)return 0;const s="unknown"!==r&&r?r:"meters",a=(0,n.y)(t);return a?(0,n.En)(i,s,a):0}function v(e,t,i){var n,r;if(null===i||void 0===i||!i.mode)return;const s=e.hasZ?e.z:0,a=f(i,e.spatialReference);switch(i.mode){case"absolute-height":return s-a;case"on-the-ground":return 0;case"relative-to-ground":return s-((null!==(n=t.elevationProvider.getElevation(e.x,e.y,s,e.spatialReference,"ground"))&&void 0!==n?n:0)+a);case"relative-to-scene":return s-((null!==(r=t.elevationProvider.getElevation(e.x,e.y,s,e.spatialReference,"scene"))&&void 0!==r?r:0)+a)}}function y(e,t,i){let n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null;return w(e,t.x,t.y,t.hasZ?t.z:0,t.spatialReference,i,n)}function b(e,t,i,n){let r=arguments.length>4&&void 0!==arguments[4]?arguments[4]:null;return w(e,t[0],t[1],t.length>2?t[2]:0,i,n,r)}function w(e,t,i,n,r,s){let a=arguments.length>6&&void 0!==arguments[6]?arguments[6]:null;if(null==s)return;const o=null!=a?a.mode:"absolute-height";if("on-the-ground"===o)return 0;const{absoluteZ:l}=C(t,i,n,r,e,s);return function(e,t,i,n,r,s,a,o){var l,h;const c=f(a,r);switch(o){case"absolute-height":return e-c;case"relative-to-ground":return e-((null!==(l=s.elevationProvider.getElevation(t,i,n,r,"ground"))&&void 0!==l?l:0)+c);case"relative-to-scene":return e-((null!==(h=s.elevationProvider.getElevation(t,i,n,r,"scene"))&&void 0!==h?h:0)+c)}}(l,t,i,n,r,e,a,o)}function C(e,t,i,n,r,s){const a=f(s,n);switch(s.mode){case"absolute-height":return{absoluteZ:i+a,elevation:0};case"on-the-ground":{var o;const i=null!==(o=r.elevationProvider.getElevation(e,t,0,n,"ground"))&&void 0!==o?o:0;return{absoluteZ:i,elevation:i}}case"relative-to-ground":{var l;const s=null!==(l=r.elevationProvider.getElevation(e,t,i,n,"ground"))&&void 0!==l?l:0;return{absoluteZ:i+s+a,elevation:s}}case"relative-to-scene":{var h;const s=null!==(h=r.elevationProvider.getElevation(e,t,i,n,"scene"))&&void 0!==h?h:0;return{absoluteZ:i+s+a,elevation:s}}}}function x(e,t){if(null==t)return!1;const{mode:i}=t;return null!=i&&("scene"===e&&"relative-to-scene"===i||"ground"===e&&"absolute-height"!==i)}function T(e,t,i){return i&&i.mode!==t?"".concat(e," only support ").concat(t," elevation mode"):null}function S(e,t,i){return(null===i||void 0===i?void 0:i.mode)===t?"".concat(e," do not support ").concat(t," elevation mode"):null}function P(e,t){return null!=(null===t||void 0===t?void 0:t.featureExpressionInfo)&&"0"!==t.featureExpressionInfo.expression?"".concat(e," do not support featureExpressionInfo"):null}function M(e,t){t&&e.warn(".elevationInfo=",t)}function R(e){var t;return(null!==(t=null===e||void 0===e?void 0:e.offset)&&void 0!==t?t:0)*(0,r.Z7)(null===e||void 0===e?void 0:e.unit)}const A={mode:"absolute-height",offset:0},O={mode:"on-the-ground",offset:null}},87422:(e,t,i)=>{i.d(t,{s:()=>a});var n=i(91505),r=i(93169),s=i(66978);class a extends n.Z{constructor(){super(...arguments),this._fadeOutResolver=null,this._fadeInResolver=null,this._clips=null,this.computedVisible=!0,this.computedOpacity=1,this.fadeTransitionEnabled=!1,this.inFadeTransition=!1,this._isReady=!1,this._opacity=1,this.parent=null,this._stage=null,this._visible=!0}get clips(){return this._clips}set clips(e){this._clips=e,this.requestRender()}get isReady(){return this._isReady}get opacity(){return this._opacity}set opacity(e){this._opacity!==e&&(this._opacity=Math.min(1,Math.max(e,0)),this.requestRender())}get stage(){return this._stage}set stage(e){var t;if(this._stage===e)return;const i=this._stage;this._stage=e,e?(null===(t=this._stage)||void 0===t?void 0:t.untrashDisplayObject(this))||(this.onAttach(),this.emit("attach")):null===i||void 0===i||i.trashDisplayObject(this)}get transforms(){return this._getTransforms()}_getTransforms(){return null==this._transforms&&(this._transforms=this._createTransforms()),this._transforms}get visible(){return this._visible}set visible(e){this._visible!==e&&(this._visible=e,this.requestRender())}get hasLabels(){return!1}get hasHighlight(){return!1}get hasBlending(){return!1}fadeIn(){return this._fadeInResolver||(this._fadeOutResolver&&(this._fadeOutResolver(),this._fadeOutResolver=null),this.opacity=1,this.computedOpacity=0,this.fadeTransitionEnabled=!0,this._fadeInResolver=(0,s.hh)(),this.requestRender()),this._fadeInResolver.promise}fadeOut(){return this._fadeOutResolver||(this.opacity=0,this._fadeInResolver&&(this._fadeInResolver(),this._fadeInResolver=null),this.fadeTransitionEnabled=!0,this._fadeOutResolver=(0,s.hh)(),this.requestRender()),this._fadeOutResolver.promise}endTransitions(){var e,t;null!==(e=this._fadeInResolver)&&void 0!==e&&e.call(this),this._fadeInResolver=null,null!==(t=this._fadeOutResolver)&&void 0!==t&&t.call(this),this._fadeOutResolver=null,this.computedOpacity=this.visible?this.opacity:0,this.requestRender()}beforeRender(e){this.updateTransitionProperties(e.deltaTime,e.state.scale),this.setTransform(e.state)}afterRender(e){this._fadeInResolver&&this.computedOpacity===this.opacity?(this._fadeInResolver(),this._fadeInResolver=null):this._fadeOutResolver&&0===this.computedOpacity&&(this._fadeOutResolver(),this._fadeOutResolver=null)}remove(){var e;null===(e=this.parent)||void 0===e||e.removeChild(this)}setTransform(e){}processRender(e){this.stage&&this.computedVisible&&this.doRender(e)}requestRender(){this.stage&&this.stage.requestRender()}processDetach(){this._fadeInResolver&&(this._fadeInResolver(),this._fadeInResolver=null),this._fadeOutResolver&&(this._fadeOutResolver(),this._fadeOutResolver=null),this.onDetach(),this.emit("detach")}updateTransitionProperties(e,t){const i=0===(0,r.Z)("mapview-transitions-duration")?0:1/(0,r.Z)("mapview-transitions-duration");if(this.fadeTransitionEnabled&&0!==i){const t=this._fadeOutResolver||!this.visible?0:this.opacity,n=this.computedOpacity;if(n===t)this.computedVisible=this.visible;else{const r=e*i;this.computedOpacity=n>t?Math.max(t,n-r):Math.min(t,n+r),this.computedVisible=this.computedOpacity>0;const s=t===this.computedOpacity;this.inFadeTransition=!s,s||this.requestRender()}}else this.computedOpacity=this.opacity,this.computedVisible=this.visible}onAttach(){}onDetach(){}doRender(e){}ready(){this._isReady||(this._isReady=!0,this.emit("isReady"),this.requestRender())}}},39395:(e,t,i)=>{var n,r;i.d(t,{H:()=>r,U:()=>n}),function(e){e[e.Stretch=0]="Stretch",e[e.Lut=1]="Lut",e[e.Hillshade=2]="Hillshade",e[e.COUNT=3]="COUNT"}(n||(n={})),function(e){e[e.Noop=0]="Noop",e[e.PerBand=1]="PerBand",e[e.COUNT=2]="COUNT"}(r||(r={}))},61441:(e,t,i)=>{i.d(t,{As:()=>a,cD:()=>o,sy:()=>s});var n=i(8548),r=i(61109);const s={geometry:[new r.G("a_pos",2,n.g.BYTE,0,2)]},a={geometry:[new r.G("a_pos",2,n.g.BYTE,0,4),new r.G("a_tex",2,n.g.BYTE,2,4)]},o={geometry:[new r.G("a_pos",2,n.g.UNSIGNED_SHORT,0,4)]}},47566:(e,t,i)=>{i.d(t,{y:()=>n});class n{constructor(){this._candidateTiles=[]}schedule(e){this._candidateTiles.includes(e)||this._candidateTiles.push(e)}reshuffle(e){const t=[];for(const i of this._candidateTiles)e>0?(i.reshuffle(),e--):t.push(i);this._candidateTiles=t}}},72900:(e,t,i)=>{i.d(t,{I:()=>a});var n=i(29303),r=i(87422),s=i(73828);class a extends r.s{constructor(e,t,i,n,r,a){let o=arguments.length>6&&void 0!==arguments[6]?arguments[6]:r,l=arguments.length>7&&void 0!==arguments[7]?arguments[7]:a;super(),this.tileDebugInfoTexture=null,this.debugInfo={display:{length:0,minOrderedLength:0,minUnorderedLength:0,triangleCount:0},memory:{bytesUsed:0,bytesReserved:0}},this._destroyed=!1,this.key=new s.Z(e),this.resolution=t,this.x=i,this.y=n,this.width=r,this.height=a,this.rangeX=o,this.rangeY=l}destroy(){this.tileDebugInfoTexture&&(this.tileDebugInfoTexture.dispose(),this.tileDebugInfoTexture=null),this._destroyed=!0}get debugSlot(){let e=this;for(;e.parent!==this._stage;){if(!e.parent)return 0;e=e.parent}return this._stage.children.indexOf(e)}setTransform(e){const t=this.resolution/(e.resolution*e.pixelRatio),i=this.transforms.tileMat3,[r,s]=e.toScreenNoRotation([0,0],[this.x,this.y]),a=this.width/this.rangeX*t,o=this.height/this.rangeY*t;(0,n.t8)(i,a,0,0,0,o,0,r,s,1),(0,n.Jp)(this.transforms.displayViewScreenMat3,e.displayViewMat3,i)}get destroyed(){return this._destroyed}}},12658:(e,t,i)=>{i.d(t,{L:()=>a});var n=i(20460);class r{constructor(e,t,i,n,r,s,a,o){let l=arguments.length>8&&void 0!==arguments[8]?arguments[8]:.5;this.coverage=e,this.density=t,this.absorption=i,this.cloudSize=n,this.detailSize=r,this.smoothness=s,this.cloudHeight=a,this.raymarchingSteps=o,this.median=l}}const s=new r([0,.6],[.03,.03],[0,0],[.9,.9],[.8,.8],[.7,.7],[.05,.05],n.p.SIXTEEN),a={sunny:s,cloudy:new r([.3,.65],[.2,.4],[0,0],[.85,.85],[.75,.75],[.3,.4],[1,1],n.p.TWOHUNDRED,.6),rainy:new r([.6,.8],[.5,.8],[.1,.5],[.9,.9],[.75,.75],[.5,.5],[1,1],n.p.TWOHUNDRED,.4),snowy:new r([.25,.75],[.3,.3],[0,0],[.95,.95],[.7,.7],[.69,.75],[.3,1],n.p.HUNDRED,.65),foggy:new r([.8,.8],[.5,.5],[0,0],[.95,.95],[.9,.9],[.55,.55],[.3,.3],n.p.SIXTEEN),default:s}},20460:(e,t,i)=>{i.d(t,{p:()=>n,t:()=>l});var n,r=i(27366),s=i(93169),a=i(46208),o=i(33559);!function(e){e[e.SIXTEEN=0]="SIXTEEN",e[e.HUNDRED=1]="HUNDRED",e[e.TWOHUNDRED=2]="TWOHUNDRED",e[e.COUNT=3]="COUNT"}(n||(n={}));class l extends o.m{constructor(){super(...arguments),this.steps=n.SIXTEEN,this.writeTextureChannels=a.uz.RG}}(0,r._)([(0,o.o)({count:n.COUNT})],l.prototype,"steps",void 0),(0,r._)([(0,o.o)({constValue:(0,s.Z)("esri-mobile")?1024:2048})],l.prototype,"cubeMapSize",void 0),(0,r._)([(0,o.o)()],l.prototype,"writeTextureChannels",void 0)},84819:(e,t,i)=>{i.d(t,{i:()=>a,u:()=>n});var n,r=i(27366),s=i(33559);!function(e){e[e.Full=0]="Full",e[e.WeatherMap=1]="WeatherMap",e[e.COUNT=2]="COUNT"}(n||(n={}));class a extends s.m{constructor(){super(...arguments),this.mode=n.Full}}(0,r._)([(0,s.o)({count:n.COUNT})],a.prototype,"mode",void 0)},68820:(e,t,i)=>{i.d(t,{CB:()=>s,H6:()=>h,JK:()=>l,Mw:()=>r,a5:()=>a,i9:()=>n,r7:()=>o});const n=(0,i(93169).Z)("esri-mobile")?64:128,r=n/128,s=Math.ceil(Math.sqrt(n)),a=(n+2)*s,o=1e5,l=128,h=a/1560},96916:(e,t,i)=>{i.d(t,{H:()=>n,Y:()=>a});var n,r=i(27366),s=i(33559);!function(e){e[e.Rain=0]="Rain",e[e.Snow=1]="Snow",e[e.COUNT=2]="COUNT"}(n||(n={}));class a extends s.m{constructor(){super(...arguments),this.type=n.Rain}}(0,r._)([(0,s.o)({count:n.COUNT})],a.prototype,"type",void 0)},69362:(e,t,i)=>{i.d(t,{f:()=>o,n:()=>n});var n,r=i(27366),s=i(33559),a=i(8883);!function(e){e[e.Cone=0]="Cone",e[e.Cylinder=1]="Cylinder",e[e.Underground=2]="Underground",e[e.COUNT=3]="COUNT"}(n||(n={}));class o extends a.W{constructor(){super(...arguments),this.geometry=n.Cone}}(0,r._)([(0,s.o)({count:n.COUNT})],o.prototype,"geometry",void 0)},13086:(e,t,i)=>{i.d(t,{Z:()=>d});var n,r=i(27366),s=i(91505),a=i(49861),o=(i(93169),i(32718),i(84936),i(69912)),l=i(18814);let h=n=class extends(s.Z.EventedMixin(l.Z)){constructor(e){super(e),this.cameraTrackingEnabled=!0,this.positionTimezoneInfo={hours:0,minutes:0,seconds:0,autoUpdated:!0};const t=(new Date).getFullYear(),i=new Date("March 15, "+t+" 12:00:00 UTC");this._set("defaultDate",i),this._set("date",i)}get defaultDate(){return new Date(this._get("defaultDate").getTime())}static fromWebsceneLighting(e){return new n(e.cloneConstructProperties())}set defaultDate(e){const t=this._get("date")===this._get("defaultDate");e=new Date(e.getTime()),this._set("defaultDate",e),t&&this._set("date",e)}set date(e){null!=e&&(this.positionTimezoneInfo.autoUpdated=!1,this._set("date",new Date(e.getTime())))}autoUpdate(e,t){const i=n.calculateTimezoneOffset(this.positionTimezoneInfo);this.positionTimezoneInfo.hours=t.hours,this.positionTimezoneInfo.minutes=t.minutes,this.positionTimezoneInfo.seconds=t.seconds;let r=null;null!=e&&(this.positionTimezoneInfo.autoUpdated=!0,isNaN(e.getTime())?(r=this.defaultDate.getTime(),this._set("date",this.defaultDate)):(r=this.date&&this.date.getTime(),this._set("date",new Date(e.getTime()))));const s=n.calculateTimezoneOffset(this.positionTimezoneInfo);if(i!==s&&(c.target=this,c.timezoneOffset=s,this.emit("timezone-will-change",c),c.target=null),null!=e)return isNaN(e.getTime())||r!==e.getTime()}clone(){const e=this._get("date")===this._get("defaultDate"),t=new n({...this.cloneConstructProperties(),defaultDate:this.defaultDate,cameraTrackingEnabled:this.cameraTrackingEnabled});return e&&t._set("date",t._get("defaultDate")),t.positionTimezoneInfo.autoUpdated=this.positionTimezoneInfo.autoUpdated,t.positionTimezoneInfo.hours=this.positionTimezoneInfo.hours,t.positionTimezoneInfo.minutes=this.positionTimezoneInfo.minutes,t.positionTimezoneInfo.seconds=this.positionTimezoneInfo.seconds,t}cloneWithWebsceneLighting(e){const t=this.clone();return null!=e.date&&(t.date=e.date),t.directShadowsEnabled=e.directShadowsEnabled,t.displayUTCOffset=e.displayUTCOffset,t}cloneNonPersistentConstructProperties(){return{cameraTrackingEnabled:this.cameraTrackingEnabled}}};(0,r._)([(0,a.Cb)({type:Boolean})],h.prototype,"cameraTrackingEnabled",void 0),(0,r._)([(0,a.Cb)({type:Date})],h.prototype,"defaultDate",null),(0,r._)([(0,a.Cb)({type:Date})],h.prototype,"date",null),h=n=(0,r._)([(0,o.j)("esri.views.3d.environment.SunLighting")],h),function(e){e.calculateTimezoneOffset=function(e){let{hours:t,minutes:i,seconds:n}=e;return Math.round(t+i/60+n/3600)}}(h||(h={}));const c={target:null,timezoneOffset:0},d=h},12040:(e,t,i)=>{i.d(t,{Z:()=>c});var n,r=i(27366),s=i(91505),a=i(49861),o=(i(93169),i(32718),i(84936),i(69912)),l=i(67808);let h=n=class extends(s.Z.EventedMixin(l.Z)){constructor(e){super(e),this.cameraTrackingEnabled=!0}clone(){return new n({...this.cloneConstructProperties(),cameraTrackingEnabled:this.cameraTrackingEnabled})}static fromWebsceneLighting(e){return new n(e.cloneConstructProperties())}cloneWithWebsceneLighting(e){const t=this.clone();return t.directShadowsEnabled=e.directShadowsEnabled,t}cloneNonPersistentConstructProperties(){return{cameraTrackingEnabled:this.cameraTrackingEnabled}}};(0,r._)([(0,a.Cb)({type:Boolean})],h.prototype,"cameraTrackingEnabled",void 0),h=n=(0,r._)([(0,o.j)("esri.views.3d.environment.VirtualLighting")],h);const c=h},5461:(e,t,i)=>{i.d(t,{TR:()=>a,Tk:()=>s,k8:()=>o,yx:()=>r});var n=i(16889);function r(e){const t=1e5;return(0,n.uZ)((e-t)/9e5,0,1)}const s=1e4,a=.085,o=1e5},39261:(e,t,i)=>{i.d(t,{$L:()=>o,JF:()=>a,mq:()=>l});let n,r=null;const s=new Map;async function a(e){null==r&&(null==n&&(n=i.e(7199).then(i.bind(i,7199))),r=await n);const t=e.view;let a=s.get(t);return a||(a=new r.default({view:t}),s.set(t,a)),a.addVoxelLayer(e)}function o(e){return s.get(e)}function l(e){const t=e.view,i=s.get(t);i&&i.removeVoxelLayer(e)<1&&(s.delete(t),0===s.size&&(n=null,r=null))}},31901:(e,t,i)=>{i.d(t,{S:()=>J,C:()=>ee});var n=i(27366),r=i(7138),s=i(14921),a=(i(93169),i(32718)),o=i(77427),l=i(92026),h=i(66978),c=i(94172),d=i(49861),u=(i(84936),i(69912)),p=i(6644),_=i(37818),m=i(16553),g=i(29481),f=i(70446),v=i(67166),y=i(95437),b=i(24168),w=i(19477);function C(e){return e instanceof w.l?e.graphics3DSymbol:e instanceof b.q?e:null}var x=i(3250),T=i(32035),S=i(12400),P=i(41414),M=i(61310),R=i(5008),A=i(21400);const O=()=>a.Z.getLogger("esri.views.3d.layers.graphics.labelPlacement");class E{constructor(e,t,i){let n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null;this.graphics3DGraphic=e,this.labelSymbol=t,this.labelClass=i,this.disablePlacement=n}}function D(e){const t=function(e){const t=e.labelClass.labelPlacement,{labelSymbol:i,graphics3DGraphic:n}=e,r=C(n.graphics3DSymbol),s="point-3d"===(null===r||void 0===r?void 0:r.symbol.type)?r.symbol:null,a=H[t]||N(e);return null!=s&&s.supportsCallout()&&s.hasVisibleVerticalOffset()&&!n.isDraped?{placement:null,hasLabelVerticalOffset:!1,verticalOffset:s.verticalOffset.clone(),anchor:null,normalizedOffset:null}:!i||!i.hasVisibleVerticalOffset()||null!=s&&s.supportsCallout()&&s.verticalOffset&&!n.isDraped?{placement:null,verticalOffset:null,anchor:null,normalizedOffset:null,hasLabelVerticalOffset:!1}:a&&function(e){return"above-center"===e}(a.placement)?{placement:"above-center",verticalOffset:i.verticalOffset.clone(),anchor:"bottom",normalizedOffset:[0,a.normalizedOffset[1],0],hasLabelVerticalOffset:!0}:(O().errorOncePerTick("Callouts and vertical offset on labels are currently only supported with 'above-center' label placement (not with "+t+" placement)"),null)}(e);if(null==t)return null;const i=function(e,t){if(t.anchor)return t;const i=e.labelClass.labelPlacement,n=H[i],r=n||N(e);return i&&!n&&O().warnOncePerTick("the requested label placement '".concat(i,"' is currently unsupported in SceneView.")),function(e,t){const i=t.graphics3DGraphic.graphic.geometry;if(null==i)return null;if(null!=t.disablePlacement)return t.labelClass.labelPlacement?(O().warnOncePerTick(L(null===e||void 0===e?void 0:e.placement,t.disablePlacement.logEntityDescription)),N(t)):e;const n=i.type;switch(n){case"polyline":case"polygon":case"extent":case"multipoint":if(t.labelClass.labelPlacement)return O().warnOncePerTick(L(null===e||void 0===e?void 0:e.placement,"'".concat(n,"' geometries"))),N(t);break;case"point":case"mesh":return e}return e}(r,e)}(e,t);if(null==i)return null;const n=i.anchor,r=!!t.hasLabelVerticalOffset,s=t.verticalOffset;return function(e,t,i){const n=i.graphics3DGraphic.graphic.geometry;if(null==n)return null;switch(n.type){case"point":case"mesh":!function(e,t,i){const n=I(i);if(null==n)return;const r=i.graphics3DGraphic.layers[0];switch(null!=r?r.getCenterObjectSpace(e.translation):(0,T.s)(e.translation,0,0,0),n.type){case"icon":case"text":!function(e,t,i,n){const{graphics3DGraphic:r}=i,s=null!=n?n.getScreenSize():null;if(r.isDraped||null==s)e.hasLabelVerticalOffset||"center"===e.anchor||(H[i.labelClass.labelPlacement]&&O().warnOncePerTick("the requested placement '".concat(t.placement,"' is currently unsupported for draped graphics")),e.anchor="center");else{const n=function(e){var t;let i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:V;const{graphics3DGraphic:n}=e,r=n.layers[0],s=null!==(t=null===r||void 0===r?void 0:r.stageObject.geometries[0].material)&&void 0!==t?t:null;if(s&&s instanceof A.A){const e=s.parameters.anchorPosition;i[0]=2*(e[0]-.5),i[1]=2*(e[1]-.5)}else i[0]=0,i[1]=0;return i}(i);e.screenOffset[0]=s[0]/2*(t.normalizedOffset[0]-n[0]);const r=s[1]/2*(t.normalizedOffset[1]-n[1]);e.hasLabelVerticalOffset?(e.centerOffset[1]=r,e.centerOffsetUnits="screen"):e.screenOffset[1]=r}}(e,t,i,r);break;case"object":case"fill":U(e,t,r)}}(e,t,i);break;case"polygon":!function(e,t,i){const n=I(i);if(null!=n)switch(n.type){case"extrude":{const n=i.graphics3DGraphic.layers[0];null!=n?(n.getBoundingBoxObjectSpace(q),(0,P.be)(q,e.translation),e.translation[2]=(0,P.Cb)(q)/2):(0,T.s)(e.translation,0,0,0),U(e,t,n);break}}}(e,t,i)}const r=M.aT-R.Wg;return e.screenOffset[0]+=r*t.normalizedOffset[0],e.screenOffset[1]+=r*t.normalizedOffset[1],e}(new x.a(s,n,r),i,e)}function I(e){const t=C(e.graphics3DGraphic.graphics3DSymbol);return null!=t?t.symbol.symbolLayers.at(0):null}function L(e,t){return"the requested label placement '".concat(e,"' is currently unsupported for ").concat(t," in SceneView.")}function N(e){const t=e.graphics3DGraphic.graphic.geometry;if(null==t)return null;switch(t.type){case"polyline":case"extent":case"multipoint":return{placement:"center-center",normalizedOffset:S.AG,anchor:"center"};case"polygon":{const t=I(e);return null!=t&&"extrude"===t.type?H["above-center"]:{placement:"center-center",normalizedOffset:S.AG,anchor:"center"}}case"point":case"mesh":return H["above-center"];default:return}}function U(e,t,i){const n=null!=i?i.getBoundingBoxObjectSpace(q):q,r=(0,S.al)(n[3]-n[0],n[4]-n[1],n[5]-n[2]),s=Math.sqrt(r[0]*r[0]+r[1]*r[1]);e.centerOffset[0]=s/2*t.normalizedOffset[0];const a=e.translation[2],o=r[2]/2*t.normalizedOffset[1];e.translation[2]=0,e.elevationOffset=a+o;const l=(0,T.l)(r);e.centerOffset[2]=l/2*t.normalizedOffset[2]}const H={"above-center":{placement:"above-center",normalizedOffset:[0,1,0],anchor:"bottom"},"above-left":{placement:"above-left",normalizedOffset:[-1,1,0],anchor:"bottom-right"},"above-right":{placement:"above-right",normalizedOffset:[1,1,0],anchor:"bottom-left"},"below-center":{placement:"below-center",normalizedOffset:[0,-1,2],anchor:"top"},"below-left":{placement:"below-left",normalizedOffset:[-1,-1,0],anchor:"top-right"},"below-right":{placement:"below-right",normalizedOffset:[1,-1,0],anchor:"top-left"},"center-center":{placement:"center-center",normalizedOffset:[0,0,1],anchor:"center"},"center-left":{placement:"center-left",normalizedOffset:[-1,0,0],anchor:"right"},"center-right":{placement:"center-right",normalizedOffset:[1,0,0],anchor:"left"}},F={"above-center":["default","esriServerPointLabelPlacementAboveCenter"],"above-left":["esriServerPointLabelPlacementAboveLeft"],"above-right":["esriServerPointLabelPlacementAboveRight"],"below-center":["esriServerPointLabelPlacementBelowCenter"],"below-left":["esriServerPointLabelPlacementBelowLeft"],"below-right":["esriServerPointLabelPlacementBelowRight"],"center-center":["esriServerPointLabelPlacementCenterCenter"],"center-left":["esriServerPointLabelPlacementCenterLeft"],"center-right":["esriServerPointLabelPlacementCenterRight"]};for(const ie in F){const e=F[ie],t=H[ie];e.forEach((e=>{H[e]=t}))}Object.freeze&&(Object.freeze(H),Object.keys(H).forEach((e=>{var t;Object.freeze(H[e]),Object.freeze(null===(t=H[e])||void 0===t?void 0:t.normalizedOffset)})));const V=[0,0],q=(0,P.Ue)();var z=i(31908);class B{constructor(e){this._stage=e,this._materials=new Map}get(e){return this._materials.get(e)}add(e,t){this._materials.set(e,t),this._stage.add(t)}dispose(){this._stage.removeMany(Array.from(this._materials.values())),this._materials.clear()}}var G=i(43164),k=i(29473),Z=i(97882),j=i(93463),W=i(73553);class X{constructor(e,t){this.labelingContext=e,this.graphics3DGraphic=t,this.hasGraphics3DResources=!1,this.visible=!1,this.addedToTextureAtlas=!1,this.textInitialized=!1,this.textRenderers=new Array,this.textLabelPlacements=new Array}}class Q{constructor(e,t,i,n,r){this.labelClass=e,this.graphics3DSymbol=t,this.graphics3DCalloutSymbolLayer=i,this.textRenderParameters=n,this.labelFunction=r,this.calloutSymbolLayerIndex=0}}class Y{constructor(e,t,i,n,r,s,a,o){this.layer=t,this.graphics3DCore=i,this.scaleVisibility=n,this.emptySymbolLabelSupported=r,this.elevationInfoOverride=s,this.disablePlacement=a,this.active=o,this.labelClassAbortController=new AbortController,this.labelClassContexts=new Array,this.graphics=new Map,this.labelsToInitialize=new Map,this.stageLayer=new Z.F(e,{pickable:!0,disableOctree:!0},t.uid)}destroy(){this.stageLayer.destroy()}}let J=class extends r.default{constructor(e){super(e),this._dirty=!1,this._labels=new Map,this._labelingContexts=new Array}setup(){this.dispose(),this.addHandles([(0,c.watch)((()=>{var e;return null===(e=this.view.state)||void 0===e?void 0:e.camera}),(()=>this.setDirty())),(0,c.watch)((()=>{var e;return null===(e=this.view.state)||void 0===e?void 0:e.rasterPixelRatio}),(()=>this._resetAllLabels())),this.view.resourceController.scheduler.registerTask(j.T8.LABELER,this)]),this._textTextureAtlas=new k.U({view:this.view}),this._hudMaterialCollection=new B(this.view._stage),this._calloutMaterialCollection=new B(this.view._stage)}dispose(){this.removeAllHandles(),this._textTextureAtlas=(0,l.M2)(this._textTextureAtlas),this._hudMaterialCollection=(0,l.M2)(this._hudMaterialCollection),this._calloutMaterialCollection=(0,l.M2)(this._calloutMaterialCollection),this._labelingContexts.length=0,this._labels.clear()}destroy(){this.dispose(),te.graphic=null,te.renderingInfo=null,te.layer=null}_activateLabelingContext(e){e.graphics.forEach(((t,i)=>{const n=new X(e,t);this._labels.set(i,n),e.labelsToInitialize.set(i,n),t.setVisibilityFlag(f.E.LABEL,f.P.USER,!0)})),e.active=!0}_deactivateLabelingContext(e){e.graphics.forEach(((e,t)=>{e.setVisibilityFlag(f.E.LABEL,f.P.USER,!1),this.setLabelGraphicVisibility(e,!1),e.clearLabelGraphics(),this._labels.delete(t)})),e.active=!1}_addLabelTextureToAtlas(e){for(const t of e.graphics3DGraphic.labelLayers){if(!t._labelClass)continue;const i=e.textRenderers[t._labelIndex];i&&(this._textTextureAtlas.addTextTexture(i,t.stageObject),e.addedToTextureAtlas=!0)}}_removeLabelTextureFromAtlas(e){for(const t of e.graphics3DGraphic.labelLayers){if(!t._labelClass)continue;const i=e.textRenderers[t._labelIndex];null!=i&&(this._textTextureAtlas.removeTextTexture(i,t.stageObject),e.addedToTextureAtlas=!1)}}get running(){return this.view.ready&&(this._dirty||this.deconflictor.running)}runTask(e){return this._updateLabels(e),!this._dirty&&this.deconflictor.running&&this.deconflictor.runTask(e),W.J}_updateLabels(e){if(this._dirty){this._dirty=!1;for(const t of this._labelingContexts)if(t.active)if(K(t))this._dirty=!0;else if($(t.labelClassContexts)){if(null===t.labelClassContexts){this._deactivateLabelingContext(t);continue}this._createLabelClassContext(t),this._dirty=!0}else(0,o.oE)(t.labelsToInitialize,((i,n)=>(this._ensureGraphics3DResources(i)&&(this._labels.set(n,i),this.deconflictor.setDirty(),e.madeProgress()),(i.visible&&i.textInitialized||!i.visible&&i.hasGraphics3DResources)&&(t.labelsToInitialize.delete(n),e.madeProgress()),e.done)))&&(this._dirty=!0);this._dirty||this.notifyChange("updating")}}async _createLabelClassContextAsync(e){var t,i,n;const r=null===(t=e.labelClassAbortController)||void 0===t?void 0:t.signal;e.layer.when&&await e.layer.when(),(0,h.k_)(r),null===(i=e.scaleVisibility)||void 0===i||i.updateScaleRangeActive();const o=e.graphics3DCore,l=null===(n=o.layer.labelingInfo)||void 0===n?void 0:n.filter((e=>!!e.symbol));if(!l||0===l.length)return;let c=!1;await(0,s.Ed)(l,(async(t,i)=>{const n=t.symbol,l=C(o.getOrCreateGraphics3DSymbol(n));if(null==l)return void a.Z.getLogger(this).error("Failed to create Graphics3DSymbol for label");await l.load(),(0,h.k_)(r);let d=null;(0,g.Pd)(n)&&n.hasVisibleCallout()&&(d=(0,v.S)(n,o.symbolCreationContext),await d.load(),(0,h.k_)(r));const u=await(0,s.q6)((0,m.J)(t,e.layer.fieldsIndex,this.view.spatialReference));if((0,h.k_)(r),!0===u.ok){const n=await this._createTextRenderParameters(l.symbol);(0,h.k_)(r),e.labelClassContexts[i]=new Q(t,l,d,n,u.value)}else a.Z.getLogger(this).error("Label expression failed to evaluate: ".concat(u.error)),c=!0})),(0,h.k_)(r)}async _createLabelClassContext(e){return null==e.labelClassPromise&&(e.labelClassPromise=this._createLabelClassContextAsync(e).catch((t=>{if((0,h.D_)(t))throw t;e.labelClassContexts.length=0})).then((()=>{e.labelClassAbortController=null,this.notifyChange("updating")})).catch((()=>{})),this.notifyChange("updating")),e.labelClassPromise}async _createTextRenderParameters(e){const t=e.symbolLayers.at(0);return"text"!==(null===t||void 0===t?void 0:t.type)?null:G.V.fromSymbol(t,this.view.state.rasterPixelRatio)}_destroyLabelClassContext(e){for(const i of e.labelClassContexts)--i.graphics3DSymbol.referenced;const t=e.labelClassAbortController;e.labelClassAbortController=new AbortController,(0,l.IM)(t),e.labelClassContexts.length=0,e.labelClassPromise=null,this.notifyChange("updating")}_createTextSymbolGraphic(e,t,i,n,r,s){const a=new x.U(i,(0,z.zi)(i.anchor),(0,z.EP)(i.anchor),e.text,(0,p.al)(e.displayWidth,e.displayHeight));return te.graphic=t,te.renderingInfo=null,te.layer=n,r.createLabel(te,a,this._hudMaterialCollection,this._textTextureAtlas,(()=>{const e=D(s);return e?e.elevationOffset:null}))}_createLineCalloutGraphic(e,t,i,n,r){te.graphic=e,te.layer=r;const s=n.screenOffset[0];return te.renderingInfo=new y.Ly(null,t,n.translation,n.centerOffset,s,n.centerOffsetUnits,n.elevationOffset,this._calloutMaterialCollection),i.createGraphics3DGraphic(te)}_ensureGraphics3DResources(e){var t;if(e.hasGraphics3DResources)return!1;const i=e.graphics3DGraphic;if(i.destroyed)return!1;this._ensureTextTextureResources(e);const n=e.labelingContext,r=n.labelClassContexts;if($(r)||!n.emptySymbolLabelSupported&&0===i.layers.length)return!1;let s=!1;const a=i.graphic,o=n.layer,l=ee(n.layer);for(let d=0;d<r.length;d++){var h,c;const t=e.textRenderers[d],u=e.textLabelPlacements[d];if(null==t||null==u)continue;const p=r[d],_=p.graphics3DSymbol,m=_.symbol&&"label-3d"===_.symbol.type?_.symbol:null,g=_.symbolLayers[0];if(!g)continue;g.setElevationInfoOverride(n.elevationInfoOverride);const v=new E(i,m,p.labelClass),y=this._createTextSymbolGraphic(t,a,u,o,g,v);if(null==y)return!1;y._labelClass=p.labelClass,y._labelIndex=d,i.addLabelGraphic(y,n.stageLayer),i.deconflictionPriority=null!==(h=null===(c=p.textRenderParameters)||void 0===c?void 0:c.definition.size)&&void 0!==h?h:0,i.setVisibilityFlag(f.E.LABEL,f.P.USER,l),i.setVisibilityFlag(f.E.LABEL,f.P.SCALE_RANGE,!0),i.setVisibilityFlag(f.E.LABEL,f.P.DECONFLICTION,!1),s=!0;const b=p.graphics3DCalloutSymbolLayer;if(b&&u.hasLabelVerticalOffset){b.setElevationInfoOverride(n.elevationInfoOverride);const e=this._createLineCalloutGraphic(a,m,b,u,o);null!=e&&(p.calloutSymbolLayerIndex=i.labelLayers.length,i.addLabelGraphic(e,n.stageLayer))}break}return s&&null!==(t=n.scaleVisibility)&&void 0!==t&&t.updateGraphicLabelScaleVisibility(i),e.hasGraphics3DResources=!0,!0}_destroyGraphics3DResources(e){const t=e.labelingContext.labelClassContexts;for(const i of e.graphics3DGraphic.labelLayers){if(null==i._labelClass)continue;const e=t[i._labelIndex].graphics3DSymbol.symbolLayers[0];null===e||void 0===e||e.onRemoveGraphic(i)}e.graphics3DGraphic.deconflictionPriority=0,e.graphics3DGraphic.clearLabelGraphics(),e.hasGraphics3DResources=!1}_ensureTextTextureResources(e){if(e.textInitialized)return;const t=e.labelingContext,i=t.labelClassContexts;if($(i))return;const n=e.graphics3DGraphic.graphic;for(let a=0;a<i.length;a++){var r;const o=i[a];if(e.textRenderers[a]=null,e.textLabelPlacements[a]=null,null==(null===o||void 0===o?void 0:o.textRenderParameters))continue;const l=o.labelFunction;let h;if("arcade"===l.type)try{const e=l.needsHydrationToEvaluate()?(0,_.mW)(n,t.layer):n;h=l.evaluate(e)}catch(s){h=null}else h=l.evaluate(n);if(null==h||""===h||/^\s+$/.test(h))continue;const c=o.graphics3DSymbol,d="label-3d"===(null===(r=c.symbol)||void 0===r?void 0:r.type)?c.symbol:null;if(!c.symbolLayers[0])continue;const u=D({graphics3DGraphic:e.graphics3DGraphic,labelSymbol:d,labelClass:o.labelClass,disablePlacement:t.disablePlacement});if(null==u)continue;const p=(0,z.zi)(u.anchor),m=(0,z.mq)(p);e.textRenderers[a]=new R.tV(h,m,o.textRenderParameters,k.U.maxSize),e.textLabelPlacements[a]=u}e.textInitialized=!0}_destroyTextTextureResources(e){e.textInitialized=!1,e.textRenderers.length=0,e.textLabelPlacements.length=0}_addGraphic(e,t){const i=t.graphic.uid;if(e.graphics.set(i,t),e.active){const n=new X(e,t);this._labels.set(i,n),e.labelsToInitialize.set(i,n)}this.setDirty(),this.deconflictor.setDirty()}_updateGraphicGeometry(e,t){const i=t.graphic.uid,n=this._labels.get(i);if(!n)return!0;for(const r of n.graphics3DGraphic.labelLayers)if(null!=r._labelClass&&!e.labelClassContexts[r._labelIndex].graphics3DSymbol.symbolLayers[0].updateGeometry(r,t.graphic.geometry))return!1;return this.setDirty(),this.deconflictor.setDirty(),!0}_removeGraphic(e,t){const i=t.graphic.uid,n=this._labels.get(i);e.graphics.delete(i),n&&(this._destroyGraphic(n,i),e.labelsToInitialize.delete(i),this.setDirty(),this.deconflictor.setDirty())}_destroyGraphic(e,t){this._labels.delete(t),e.addedToTextureAtlas&&this._removeLabelTextureFromAtlas(e),this._destroyTextTextureResources(e),e.hasGraphics3DResources&&this._destroyGraphics3DResources(e)}async _labelingInfoChange(e,t){if(!t)return this._visibilityInfoChange(e),this._resetLabels(e),this._createLabelClassContext(e);for(const i of t){const t=e.graphics.get(i);t&&(this._removeGraphic(e,t),this._addGraphic(e,t))}}_globalPropertyChanged(e,t){for(const i of t.labelClassContexts){const n=new Map;t.graphics.forEach((e=>n.set(e.graphic.uid,e)));const r=e=>e.labelLayers[0];if(i.graphics3DSymbol.symbolLayers[0].globalPropertyChanged(e,n,r),i.graphics3DCalloutSymbolLayer){const t=e=>e.labelLayers[i.calloutSymbolLayerIndex];i.graphics3DCalloutSymbolLayer.globalPropertyChanged(e,n,t)}}}_visibilityInfoChange(e){const t=ee(e.layer);t&&!e.active&&this._activateLabelingContext(e),!t&&e.active&&this._deactivateLabelingContext(e),this.setDirty()}_resetAllLabels(){for(const e of this._labelingContexts)this._resetLabels(e)}_resetLabels(e){e.graphics.forEach(((t,i)=>{const n=this._labels.get(i);n&&(this._destroyGraphic(n,i),n.visible=!1,e.labelsToInitialize.set(i,n))})),this._destroyLabelClassContext(e),this.setDirty(),this.deconflictor.setDirty()}_findLabelingContext(e){for(const t of this._labelingContexts)if(t.graphics3DCore===e)return t;return null}addGraphicsOwner(e,t,i){const n=(null===i||void 0===i?void 0:i.emptySymbolLabelSupported)||!1,r=(null===i||void 0===i?void 0:i.elevationInfoOverride)||null,s=(null===i||void 0===i?void 0:i.disablePlacement)||null;if(this._findLabelingContext(e))return;const a=e.layer,o=new Y(this.view._stage,a,e,t,n,r,s,ee(a));return this._labelingContexts.push(o),this.setDirty(),{addGraphic:e=>this._addGraphic(o,e),removeGraphic:e=>this._removeGraphic(o,e),updateGraphicGeometry:e=>this._updateGraphicGeometry(o,e),layerLabelsEnabled:()=>ee(o.layer),labelingInfoChange:e=>this._labelingInfoChange(o,e),elevationInfoChange:()=>this._globalPropertyChanged("elevationInfo",o),slicePlaneEnabledChange:()=>this._globalPropertyChanged("slicePlaneEnabled",o),visibilityInfoChange:()=>this._visibilityInfoChange(o),reset:()=>this._resetLabels(o),remove:()=>this._removeGraphicsOwner(e),setDirty:()=>this.setDirty()}}_removeGraphicsOwner(e){const t=this._findLabelingContext(e);if(!t)return;const i=this._labelingContexts.indexOf(t);this._labelingContexts.splice(i,1),t.graphics.forEach((e=>this._removeGraphic(t,e))),t.destroy(),this.setDirty()}setLabelGraphicVisibility(e,t){const i=e.graphic.uid,n=this._labels.get(i);n&&n.visible!==t&&(t&&!n.addedToTextureAtlas?(this._addLabelTextureToAtlas(n),n.textInitialized||n.labelingContext.labelsToInitialize.set(i,n)):!t&&n.addedToTextureAtlas&&this._removeLabelTextureFromAtlas(n),n.visible=t,this.setDirty())}setDirty(){!this._dirty&&this._labelingContexts.length>0&&(this._dirty=!0,this.notifyChange("updating"))}get updating(){var e;return this._dirty||(null===(e=this._textTextureAtlas)||void 0===e?void 0:e.updating)||this.deconflictor.updating||this._labelingContexts.some((e=>K(e)))}get updatingProgress(){if(!this.updating||!this._textTextureAtlas)return 1;const e=this._labelingContexts.length>0?this._labelingContexts.reduce(((e,t)=>e+(K(t)?0:1)),0)/this._labelingContexts.length:1;return(this._dirty?0:.3)+(this._textTextureAtlas.updating?0:.1)+.1*e+.5*this.deconflictor.updatingProgress}get test(){}};function K(e){return!!e.labelClassPromise&&!!e.labelClassAbortController}function $(e){return!e||0===e.length}function ee(e){var t;return!0===e.labelsVisible&&!(null===(t=e.labelingInfo)||void 0===t||!t.some((e=>!!e.symbol)))}(0,n._)([(0,d.Cb)({constructOnly:!0})],J.prototype,"view",void 0),(0,n._)([(0,d.Cb)({constructOnly:!0})],J.prototype,"deconflictor",void 0),(0,n._)([(0,d.Cb)()],J.prototype,"_textTextureAtlas",void 0),(0,n._)([(0,d.Cb)({type:Boolean,readOnly:!0})],J.prototype,"updating",null),J=(0,n._)([(0,u.j)("esri.views.3d.layers.graphics.Labeler")],J);const te=new y._D(null,null,null)},13470:(e,t,i)=>{i.d(t,{C:()=>a,E:()=>n});var n,r,s=i(65156);class a{constructor(e,t,i){let r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null;this.lij=[0,0,0],this.extent=(0,s.Ue)(),this.resolution=0,this.loadPriority=0,this.measures={visibility:n.VISIBLE_ON_SURFACE,screenRect:(0,s.Ue)(),distance:0,shouldSplit:!1},this.used=!1,r&&this.acquire(e,t,i,r)}acquire(e,t,i,n){this.tilingScheme=n,this.id=a.id(e,t,i),this.lij[0]=e,this.lij[1]=t,this.lij[2]=i,n.getExtent(e,t,i,this.extent),this.resolution=n.resolutionAtLevel(e)}release(){this.tilingScheme=null}getChildren(e){const t=this.lij[0]+1,i=2*this.lij[1],n=2*this.lij[2];return e?(e[0].acquire(t,i,n,this.tilingScheme),e[1].acquire(t,i+1,n,this.tilingScheme),e[2].acquire(t,i,n+1,this.tilingScheme),e[3].acquire(t,i+1,n+1,this.tilingScheme),e):[new a(t,i,n,this.tilingScheme),new a(t,i+1,n,this.tilingScheme),new a(t,i,n+1,this.tilingScheme),new a(t,i+1,n+1,this.tilingScheme)]}copyMeasurementsFrom(e){this.measures.visibility=e.measures.visibility,this.measures.shouldSplit=e.measures.shouldSplit,this.measures.distance=e.measures.distance,(0,s.JG)(e.measures.screenRect,this.measures.screenRect)}static id(e,t,i){return"".concat(e,"/").concat(t,"/").concat(i)}}(r=n||(n={}))[r.INVISIBLE=0]="INVISIBLE",r[r.VISIBLE_WHEN_EXTENDED=1]="VISIBLE_WHEN_EXTENDED",r[r.VISIBLE_ON_SURFACE=2]="VISIBLE_ON_SURFACE"},38161:(e,t,i)=>{i.d(t,{i:()=>a});var n=i(32035),r=i(12400),s=i(95773);class a{get planes(){return this.frustum}get points(){return this._points}get mutablePoints(){return this._points}get direction(){return this._direction}get origin(){return this._origin}constructor(e){this.renderCoordsHelper=e,this.frustum=(0,s.Ue)(),this._points=(0,s.Hf)(),this.lines=new Array(12),this._origin=(0,r.Ue)(),this._direction=(0,r.Ue)(),this._altitude=null;for(let t=0;t<12;t++)this.lines[t]={origin:null,direction:(0,r.Ue)(),endpoint:null}}update(e){(0,s.q_)(e.viewMatrix,e.projectionMatrix,this.frustum,this._points),(0,n.c)(this._origin,e.eye),(0,n.c)(this._direction,e.viewForward),this._altitude=this.renderCoordsHelper.getAltitude(this._origin),this._updateLines()}updatePoints(e){for(let t=0;t<this._points.length;t++)(0,n.c)(this._points[t],e[t]);(0,s.Jp)(this.frustum,this._points),this._updateLines()}get altitude(){return this._altitude}intersectsSphere(e){return(0,s.hr)(this.frustum,e)}intersectsRay(e){return(0,s.Zr)(this.frustum,e)}intersectsLineSegment(e,t){return(0,s.rN)(this.frustum,e,t)}intersectsPoint(e){return(0,s.g8)(this.frustum,e)}_updateLines(){const e=this._points;for(let t=0;t<4;t++){const i=t+4;o(this.lines[t],e[t],e[i]),o(this.lines[t+4],e[t],3===t?e[0]:e[t+1]),o(this.lines[t+8],e[i],3===t?e[4]:e[i+1])}}}function o(e,t,i){e.origin=t,e.endpoint=i,(0,n.E)(e.direction,t,i)}a.planePointIndices=s.xu,a.nearFarLineIndices=[[s.NQ.NEAR_BOTTOM_LEFT,s.NQ.FAR_BOTTOM_LEFT],[s.NQ.NEAR_BOTTOM_RIGHT,s.NQ.FAR_BOTTOM_RIGHT],[s.NQ.NEAR_TOP_RIGHT,s.NQ.FAR_TOP_RIGHT],[s.NQ.NEAR_TOP_LEFT,s.NQ.FAR_TOP_LEFT]]},2985:(e,t,i)=>{i.d(t,{r:()=>n});class n{constructor(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:1/0,t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:-1/0;this.elevationRangeMin=e,this.elevationRangeMax=t}get elevationRangeValid(){return!Number.isNaN(this.elevationRangeMin)}invalidateElevationRange(){this.elevationRangeMin=NaN}expandElevationRangeValues(e,t){this.elevationRangeMin=Math.min(this.elevationRangeMin,e),this.elevationRangeMax=Math.max(this.elevationRangeMax,t)}expandElevationRange(e){this.elevationRangeMin=Math.min(this.elevationRangeMin,e.elevationRangeMin),this.elevationRangeMax=Math.max(this.elevationRangeMax,e.elevationRangeMax)}setElevationRange(e){this.elevationRangeMin=e.elevationRangeMin,this.elevationRangeMax=e.elevationRangeMax}}},31195:(e,t,i)=>{i.d(t,{d:()=>d,c:()=>c});var n=i(27366),r=i(7138),s=(i(93169),i(32718)),a=i(18759),o=i(99346),l=i(49861),h=(i(84936),i(69912));function c(e){return new u({view:e})}const d=.1;let u=class extends r.default{constructor(e){super(e),this._quality=1,this._usedMemory=0,this._updating=!1,this._stableQuality=0,this._downscaleMemoryUsed=0,this._canFastRecover=!1,this._memoryPredicted=0,this._cacheStorage=new a.WJ,this._warnMemoryUsage=null,this._numQualityChanges=0,this._maxMemory=750,this._additionalCacheMemory=0,this.addHandles((0,o.A)({prepare:()=>this._updateMemory()}))}destroy(){this._cacheStorage.destroy()}get maxMemory(){return this._maxMemory}set maxMemory(e){null==e||e<=0||(this._stableQuality=0,this._canFastRecover=!1,this._maxMemory<e&&this._updateQuality(1),this._maxMemory=e)}get additionalCacheMemory(){return this._additionalCacheMemory}set additionalCacheMemory(e){null!=e&&(this._additionalCacheMemory=e)}get memoryFactor(){return this._quality}get updating(){return this._updating}get usedMemory(){return this._usedMemory}get usedCacheMemory(){return this._cacheStorage.size}newCache(e,t){return new a.Xq(e,this._cacheStorage,t)}resetStableQuality(){this._stableQuality=0}disableMemCache(){this.additionalCacheMemory=-4096}update(){if(this._memoryPredicted<=0&&!this._updating)return;let e=this._layersUpdating();if(this._memoryPredicted<.6&&this._canFastRecover)this._downscaleMemoryUsed=0,this._stableQuality=0,this._canFastRecover=!1,this._updateQuality(1);else if(e)(this._memoryPredicted>1.1||this._usedMemory>1)&&(this._stableQuality>0?(this._downscaleMemoryUsed=0,this._updateQuality(this._stableQuality)):this._quality>d&&this._downscaleMemoryUsed<this._usedMemory&&(this._updateQuality(this._quality/1.3),this._downscaleMemoryUsed=this._usedMemory,this._canFastRecover=!1));else if(this._downscaleMemoryUsed=0,this._usedMemory>1)this._stableQuality=0,this._canFastRecover=!1,e=this._updateQuality(this._quality/1.3),this._downscaleMemoryUsed=this._memoryPredicted;else if(this._stableQuality!==this._quality)if(this._usedMemory<.75&&this._quality<1){this._stableQuality=this._quality;const t=.05;e=this._updateQuality(this._quality+t)}else this._quality<1&&(this._canFastRecover=!0);this._updating=e}_updateQuality(e){return(e=Math.min(Math.max(e,d),1))!==this._quality&&(this._quality=e,++this._numQualityChanges,!0)}_layersUpdating(){return this.view.allLayerViews.some((e=>!!e.updating))}_updateMemory(){var e,t,i,n;if(!this.view)return;null===(e=this.view._stage)||void 0===e||null===(e=e.renderer)||void 0===e||e.tick();const r=null===(t=this.view._stage)||void 0===t||null===(t=t.renderer)||void 0===t?void 0:t.usedMemory;let a=(null!==(i=null===(n=this.view.basemapTerrain)||void 0===n?void 0:n.usedMemory)&&void 0!==i?i:0)+(r?r.fbos+r.edges+r.plugins:0),o=0;this.view.allLayerViews&&this.view.allLayerViews.forEach((e=>{if(function(e){return"usedMemory"in e&&"unloadedMemory"in e&&"ignoresMemoryFactor"in e}(e)){const t=e.ignoresMemoryFactor?this._quality:1;a+=e.usedMemory*t,o+=e.unloadedMemory*t}}));const l=null==this._warnMemoryUsage||Math.round(10*a)!==Math.round(10*this._warnMemoryUsage),h=1048576*this.maxMemory;if(a>h&&l){this._warnMemoryUsage=a;const e=e=>(e/1048576).toLocaleString(void 0,{maximumFractionDigits:1})+" MB",t=Math.round(100*this._quality);s.Z.getLogger(this).warn("Memory Limit exceeded! Limit: ".concat(e(h)," Current: ").concat(e(a)," Projected: ").concat(e(a+o)," Quality: ").concat(t,"%"))}this._usedMemory=a/h,this._memoryPredicted=(a+o)/h;const c=h-a;this._cacheStorage.maxSize=Math.max(0,c+1048576*this.additionalCacheMemory)}get test(){}};(0,n._)([(0,l.Cb)({constructOnly:!0})],u.prototype,"view",void 0),(0,n._)([(0,l.Cb)()],u.prototype,"maxMemory",null),(0,n._)([(0,l.Cb)()],u.prototype,"additionalCacheMemory",null),(0,n._)([(0,l.Cb)({readOnly:!0})],u.prototype,"memoryFactor",null),(0,n._)([(0,l.Cb)({readOnly:!0})],u.prototype,"updating",null),(0,n._)([(0,l.Cb)({readOnly:!0})],u.prototype,"usedMemory",null),(0,n._)([(0,l.Cb)({readOnly:!0})],u.prototype,"usedCacheMemory",null),(0,n._)([(0,l.Cb)()],u.prototype,"_quality",void 0),(0,n._)([(0,l.Cb)()],u.prototype,"_usedMemory",void 0),(0,n._)([(0,l.Cb)()],u.prototype,"_updating",void 0),(0,n._)([(0,l.Cb)()],u.prototype,"_stableQuality",void 0),(0,n._)([(0,l.Cb)()],u.prototype,"_maxMemory",void 0),(0,n._)([(0,l.Cb)()],u.prototype,"_additionalCacheMemory",void 0),u=(0,n._)([(0,h.j)("esri.views.3d.support.MemoryController")],u)},91643:(e,t,i)=>{i.d(t,{Z:()=>y});var n=i(16889),r=i(68860),s=i(29134),a=i(32035),o=i(83448),l=i(29691),h=i(68859),c=i(5629),d=i(5986),u=i(14320),p=i(85305),_=i(55652),m=i(40927),g=i(51378),f=i(81020),v=i(50951);class y{constructor(e,t,i,n){this.viewingMode=e,this.spatialReference=t,this.unitInMeters=i,this._coordinateSystem=n,this._tmpCoordinateSystem=(0,p.Ue)(n),this.referenceEllipsoid=(0,o.Iu)(t),this.sphericalPCPF=(0,l.rS)(t)}set extent(e){e&&(0,p.qf)(this._coordinateSystem,e,this._coordinateSystem)}getAltitude(e){return(0,p.id)(this._coordinateSystem,e)}setAltitude(e,t){let i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:e;return(0,p.Is)(this._coordinateSystem,i,t,e)}setAltitudeOfTransformation(e,t){(0,p.rF)(this._coordinateSystem,t,e,t)}worldUpAtPosition(e,t){return(0,p.P0)(this._coordinateSystem,e,t)}worldBasisAtPosition(e,t,i){return(0,p.Kf)(this._coordinateSystem,e,t,i)}basisMatrixAtPosition(e,t){const i=this.worldBasisAtPosition(e,u.R.X,g.WM.get()),n=this.worldBasisAtPosition(e,u.R.Y,g.WM.get()),r=this.worldBasisAtPosition(e,u.R.Z,g.WM.get());return(0,s.t8)(t,i[0],i[1],i[2],0,n[0],n[1],n[2],0,r[0],r[1],r[2],0,0,0,0,1),t}headingAtPosition(e,t){const i=this.worldUpAtPosition(e,g.WM.get()),r=this.worldBasisAtPosition(e,u.R.Y,g.WM.get()),s=(0,m.cp)(t,r,i);return(0,n.BV)(s)}intersectManifoldClosestSilhouette(e,t,i){return(0,p.NE)(this._coordinateSystem,t,this._tmpCoordinateSystem),(0,p.ej)(this._tmpCoordinateSystem,e,i),i}intersectManifold(e,t,i){(0,p.NE)(this._coordinateSystem,t,this._tmpCoordinateSystem);const n=g.WM.get();return(0,p.BR)(this._tmpCoordinateSystem,e,n)?(0,a.c)(i,n):null}intersectInfiniteManifold(e,t,i){if(this.viewingMode===v.JY.Global)return this.intersectManifold(e,t,i);(0,p.NE)(this._coordinateSystem,t,this._tmpCoordinateSystem);const n=this._tmpCoordinateSystem.value,r=g.WM.get();return(0,_.BR)(n.plane,e,r)?(0,a.c)(i,r):null}toRenderCoords(e,t,i){return(0,f.f)(e)?(0,h.K)(e,t,this.spatialReference):(0,d.S)(e,t,i,this.spatialReference)}fromRenderCoords(e,t){let i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null;return(0,f.f)(t)?(null!=i&&(t.spatialReference=i),(0,c.f)(e,this.spatialReference,t)?t:null):(0,d.S)(e,this.spatialReference,t,i)?t:null}static create(e,t){switch(e){case v.JY.Local:return new y(v.JY.Local,t,(0,r.c9)(t),(0,p.pb)());case v.JY.Global:return new y(v.JY.Global,t,1,(0,p.pt)(t))}}static renderUnitScaleFactor(e,t){return(0,r.r6)(e)/(0,r.r6)(t)}}},81703:(e,t,i)=>{i.d(t,{Bh:()=>c,eW:()=>u,iE:()=>d,j$:()=>l,u4:()=>h});var n=i(17842),r=i(13611),s=i(32035),a=i(40885),o=i(51378);function l(e,t){let i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:(0,a.Ue)();return h(e,(0,n.md)(t),i),(0,s.n)(i.direction,i.direction),i}function h(e,t,i){return c(e,e.screenToRender(t,(0,n.Wv)(o.WM.get())),i)}function c(e,t,i){const a=(0,n.Wv)((0,r.JG)(o.WM.get(),t));if(a[2]=0,!e.unprojectFromRenderScreen(a,i.origin))return null;const l=(0,n.Wv)((0,r.JG)(o.WM.get(),t));l[2]=1;const h=e.unprojectFromRenderScreen(l,o.WM.get());return null==h?null:((0,s.f)(i.direction,h,i.origin),i)}function d(e,t,i){return u(e,e.screenToRender(t,(0,n.Wv)(o.WM.get())),i)}function u(e,t,i){(0,s.c)(i.origin,e.eye);const n=(0,s.s)(o.WM.get(),t[0],t[1],1),r=e.unprojectFromRenderScreen(n,o.WM.get());return null==r?null:((0,s.f)(i.direction,r,i.origin),i)}},45888:(e,t,i)=>{var n;i.d(t,{Bh:()=>n,NT:()=>s,Ty:()=>r}),function(e){e[e.ELEVATION=0]="ELEVATION",e[e.BASEMAP=1]="BASEMAP",e[e.I3S_INDEX=2]="I3S_INDEX",e[e.I3S_DATA=3]="I3S_DATA",e[e.SYMBOLOGY=4]="SYMBOLOGY"}(n||(n={}));const r=(()=>{const e=new Array;return e[n.ELEVATION]=10,e[n.BASEMAP]=10,e[n.I3S_INDEX]=10,e[n.I3S_DATA]=10,e[n.SYMBOLOGY]=5,e})(),s=30},28961:(e,t,i)=>{i.d(t,{GD:()=>w,H3:()=>g,WA:()=>m,XO:()=>v,d5:()=>y});var n=i(16889),r=i(29134),s=i(7025),a=i(13611),o=i(6644),l=i(32035),h=i(12400),c=i(50951),d=i(73401),u=i(80064);const p={local:{altitude:1500,ambientAtNight:.1,ambientAtNoon:.45,ambientAtTwilight:.2,directAtNoon:.65,directAtTwilight:.7},global:{altitude:8e5,ambient:.015,direct:.75},planarDirection:{localAltitude:1e4,globalAltitude:1e6,globalAngles:{azimuth:1.3*Math.PI,altitude:.6*Math.PI}}};class _{constructor(e,t){this.direct=e,this.ambient=t}}function m(e,t,i,r,s,c){(0,l.s)(c.ambient.color,1,1,1),c.ambient.intensity=p.global.ambient,(0,l.s)(c.direct.color,1,1,1),c.direct.intensity=p.global.direct;const u=t[2],_=(0,n.uZ)((Math.abs(u)-p.local.altitude)/(p.global.altitude-p.local.altitude),0,1);let m;if(c.globalFactor=_,null!=e&&(m=d.S.getTimes(e,t[1],t[0])),_<1){let t;if(null!=e)t=function(e,t,i){const n=e.valueOf();let r,s;t.polarException===d.S.PolarException.MIDNIGHT_SUN?(r=n-60*(e.getHours()+48)*60*1e3-60*e.getMinutes()*1e3,s=r+432e6):t.polarException===d.S.PolarException.POLAR_NIGHT?(r=n-2,s=n-1):(r=t.sunrise.valueOf(),s=t.sunset.valueOf());const c=s-r,u=r+c/2,p=c/4,_=u-p,m=u+p,g=.06*c,f=r-g/2,v=r+g/2,y=s-g/2,b=s+g/2,w=(0,o.Ue)(),C=(0,h.Ue)(),x=(0,h.Ue)();let k="";if(n<f||n>b)(0,a.JG)(w,L),(0,l.c)(C,P),(0,l.c)(x,O),k="night";else if(n<v){const e=(n-f)/(v-f);(0,a.t7)(w,L,N,e),(0,l.o)(C,P,M,e),(0,l.o)(x,O,E,e),k="sun rising"}else if(n<_){const e=(n-v)/(_-v);(0,a.t7)(w,N,U,e),(0,l.o)(C,M,R,e),(0,l.o)(x,E,D,e),k="early morning"}else if(n<u){const e=(n-_)/(u-_);(0,a.t7)(w,U,H,e),(0,l.o)(C,R,A,e),(0,l.o)(x,D,I,e),k="late morning"}else if(n<m){const e=(n-u)/(m-u);(0,a.t7)(w,H,F,e),(0,l.o)(C,A,V,e),(0,l.o)(x,I,q,e),k="early afternoon"}else if(n<y){const e=(n-m)/(y-m);(0,a.t7)(w,F,z,e),(0,l.o)(C,V,B,e),(0,l.o)(x,q,G,e),k="late afternoon"}else if(n<b){const e=(n-y)/(b-y);(0,a.t7)(w,z,L,e),(0,l.o)(C,B,P,e),(0,l.o)(x,G,O,e),k="sun setting"}let Z=0;switch(i){case"rainy":case"foggy":Z=.8;break;case"snowy":Z=.5}Z>0&&(S(C,Z),S(x,Z));const j=T(i);return{direct:{intensity:w[0]*j.direct,color:C},ambient:{intensity:w[1]*j.ambient,color:x},timeOfDay:k}}(e,m,r);else{const e=T(r);t={direct:{intensity:p.local.directAtNoon*e.direct,color:(0,h.al)(1,1,1)},ambient:{intensity:p.local.ambientAtNoon*e.ambient,color:(0,h.al)(1,1,1)},timeOfDay:"early afternoon"}}(0,l.o)(c.ambient.color,t.ambient.color,c.ambient.color,_),c.ambient.intensity=(0,n.t7)(t.ambient.intensity,c.ambient.intensity,_),(0,l.o)(c.direct.color,t.direct.color,c.direct.color,_),c.direct.intensity=(0,n.t7)(t.direct.intensity,c.direct.intensity,_),c.specularStrength="rainy"===r||"snowy"===r||"foggy"===r?0:1,c.environmentStrength="rainy"===r?.7:"snowy"===r||"foggy"===r?.75:1}c.noonFactor=null!=e?function(e,t){const i=e.valueOf();let r,s;t.polarException===d.S.PolarException.MIDNIGHT_SUN?(r=i-60*(e.getHours()+48)*60*1e3-60*e.getMinutes()*1e3,s=r+432e6):t.polarException===d.S.PolarException.POLAR_NIGHT?(r=i-2,s=i-1):(r=t.sunrise.valueOf(),s=t.sunset.valueOf());const a=r+(s-r)/2;return 1-(0,n.uZ)(Math.abs(i-a)/432e5,0,1)}(e,m):1,null!=e?f(e,t,i,c.direct.directionToLightSource):g(s,i,c.direct.directionToLightSource)}function g(e,t,i){t===c.JY.Global?(0,l.n)(j,e.eye):(0,l.s)(j,0,0,1),(0,l.j)(W,e.viewForward,-1);const n=(0,u.EU)(W,j),s=Math.max(n-2*Q,0),a=.85*s/(s+1),o=Math.max(Q,n-Q-a);(0,r.Us)(Z,-o,e.viewRight),(0,l.h)(i,W,Z),(0,l.g)(i,i,(0,l.j)(X,e.viewRight,Y)),(0,l.n)(i,i)}function f(e,t,i,s){const a=x,o=(0,r.yR)(C);if(i===c.JY.Global)d.S.getPosition(e,0,0,a),(0,l.s)(s,0,0,-1),(0,r.lM)(o,o,-a.azimuth),(0,r.uD)(o,o,-a.altitude),(0,l.h)(s,s,o);else{const i=p.planarDirection,h=i.globalAngles,c=t[2];let u=(Math.abs(c)-i.localAltitude)/(i.globalAltitude-i.localAltitude);u=(0,n.uZ)(u,0,1),u<1?(d.S.getPosition(e,t[1],t[0],a),a.azimuth=(1-u)*a.azimuth+u*h.azimuth,a.altitude=(1-u)*a.altitude+u*h.altitude):(a.azimuth=h.azimuth,a.altitude=h.altitude),(0,l.s)(s,0,-1,0),(0,r.jI)(o,o,-a.azimuth),(0,r.lM)(o,o,-a.altitude),(0,l.h)(s,s,o)}}function v(e,t){if(t===c.JY.Global)return!0;const i=p.planarDirection;return Math.abs(e)<i.localAltitude}function y(e,t,i,n,r){const s=e.getTime(),a=t.getTime()-s,o=Math.floor(a/i)+1,l=new Array(o);for(let c=0;c<o;++c)k.setTime(s+i*c),l[c]=(0,h.Ue)(),f(k,n,r,l[c]);return l}const b=(0,h.al)(.5773502691896258,-.5773502691896258,.5773502691896258);class w{constructor(){this.ambient={color:(0,h.al)(1,1,1),intensity:.55},this.direct={color:(0,h.al)(1,1,1),intensity:.55,directionToLightSource:(0,h.d9)(b)},this.noonFactor=.5,this.globalFactor=0,this.specularStrength=1,this.environmentStrength=1}}const C=(0,s.Ue)(),x={azimuth:0,altitude:0};function T(e){switch(e){case"disabled":case"sunny":case"cloudy":return new _(1,1);case"rainy":return new _(.4,1.2);case"snowy":return new _(.5,1.3);case"foggy":return new _(.2,1.6)}}function S(e,t){const i=(e[0]+e[1]+e[2])/3;e[0]+=(i-e[0])*t,e[1]+=(i-e[1])*t,e[2]+=(i-e[2])*t}const P=(0,h.al)(.01,.01,.01),M=(0,h.al)(1,.6,.5),R=(0,h.al)(1,.98,.98),A=(0,h.al)(1,1,1),O=(0,h.al)(.8,.8,1),E=(0,h.al)(.8,.8,1),D=(0,h.al)(.98,.98,1),I=(0,h.al)(1,1,1),L=(0,o.al)(.01,p.local.ambientAtNight),N=(0,o.al)(p.local.directAtTwilight,p.local.ambientAtTwilight),U=(0,o.al)(.9*p.local.directAtNoon,p.local.ambientAtNoon),H=(0,o.al)(p.local.directAtNoon,p.local.ambientAtNoon),F=U,V=R,q=D,z=N,B=M,G=E;const k=new Date(0),Z=(0,s.Ue)(),j=(0,h.Ue)(),W=(0,h.Ue)(),X=(0,h.Ue)(),Q=.25,Y=.2},58890:(e,t,i)=>{i.d(t,{V:()=>n,q:()=>r});const n={value:.5,readOnly:!0},r={readOnly:!0,value:.5,get(){return this.updating?this.updatingProgressValue:1}}},82394:(e,t,i)=>{var n;i.d(t,{z:()=>n}),function(e){e[e.BACK_TO_FRONT=-1]="BACK_TO_FRONT",e[e.NONE=0]="NONE",e[e.FRONT_TO_BACK=1]="FRONT_TO_BACK"}(n||(n={}))},36734:(e,t,i)=>{i.d(t,{AA:()=>s,E9:()=>v,QT:()=>g,b:()=>m,dF:()=>u,gl:()=>l,rv:()=>a,t8:()=>f,yf:()=>o,zW:()=>h});var n=i(27546),r=i(82394);class s{constructor(){this._queue=new n.Z,this.remove=()=>{}}get done(){return 0===this._queue.length&&(!this._last||this._last.isLeaf)}resetOne(e){this._queue.clear(),this._queue.push(e),this._last=void 0}reset(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null;this._queue.clear(),null!=e&&this._queue.pushArray(e),this._last=void 0}skipSubtree(){this._last=void 0}next(){var e;const t=null===(e=this._last)||void 0===e?void 0:e.children;return null!==t&&void 0!==t&&t[0]&&this._queue.pushArray(t),this._last=this._queue.pop(),this._last}}class a{constructor(){this._q=new n.Z}get done(){return 0===this._q.length}reset(e){if(this._q.clear(),null!=e){this._q.pushArray(e);for(let e=0;e<this._q.length;++e){const t=this._q.data[e];t.isLeaf||this._q.pushArray(t.children)}}}next(){return this._q.pop()}}function o(e,t,i){if(null==(null===t||void 0===t?void 0:t.fullExtent))return!1;const n=t.fullExtent,r=e.extent;if(i){if(r[0]<n.xmin||r[1]<n.ymin||r[2]>n.xmax||r[3]>n.ymax)return!1}else if(n.xmin>r[2]||n.ymin>r[3]||n.xmax<r[0]||n.ymax<r[1])return!1;const s=e.surface.tilingScheme.levels[e.level].scale,a=t.minScale;if(a>0&&s>1.00000001*a)return!1;const o=t.maxScale;return!(o>0&&s<.99999999*o)}function l(e,t){const i=e.lij,n=t.lij;return i[0]-n[0]||i[1]-n[1]||i[2]-n[2]}function h(e,t){let i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null;null==i||0===i.length?e===r.z.BACK_TO_FRONT?t.sort(c):t.sort(d):t.sort(((t,n)=>function(e,t,i,n){return p(e,n)===p(t,n)?u(e,t,i):e?i:-i}(t,n,e,i)))}function c(e,t){const i=t.screenDepth-e.screenDepth;if(0!==i)return i;const n=e.lij,r=t.lij;return n[0]-r[0]||n[1]-r[1]||n[2]-r[2]}function d(e,t){const i=e.screenDepth-t.screenDepth;if(0!==i)return i;const n=e.lij,r=t.lij;return n[0]-r[0]||n[1]-r[1]||n[2]-r[2]}function u(e,t,i){const n=e.screenDepth,r=t.screenDepth;return n<r?-i:n>r?i:l(e,t)}function p(e,t){for(const i of t)if(e.intersectsExtent(i))return!0;return!1}function _(e,t){const i=e.distanceToPOI-t.distanceToPOI;if(0!==i)return i;const n=e.lij,r=t.lij;return n[0]-r[0]||n[1]-r[1]||n[2]-r[2]}function m(e,t){const i=e.length;for(let n=0;n<i;++n)e.at(n).updateDistanceToPOI(t);e.sort(_)}function g(e,t,i){let n=1,r=0,s=0;for(;e!==t;)if(n*=.5,r*=.5,s*=.5,1&e.lij[2]&&(r+=.5),1&e.lij[1]||(s+=.5),null==(e=e.parent))throw new Error("tile was not a descendant of upsampleTile");i.init(t,r,s,n)}function f(e){for(let t=0;t<e.length;t++){const i=e[t],n=i.parent;if(n)for(let e=0;e<4;e++){const t=n.children[e];if(t&&t!==i)return!0}}return!1}function v(e,t){if(!e||!t||e[0]===t[0])return!1;const i=e[0]<t[0],n=i?e:t,r=i?t:e,s=1<<r[0]-n[0];return Math.floor(r[1]/s)===n[1]&&Math.floor(r[2]/s)===n[2]}},46987:(e,t,i)=>{i.d(t,{Un:()=>N,ws:()=>x,zO:()=>H,Qu:()=>F});var n=i(27366),r=i(92026),s=i(29303),a=i(21389),o=i(32035),l=i(12400),h=i(19093),c=i(86361),d=i(49420),u=i(92015),p=i(9028),_=i(7564),m=i(37107),g=i(91871),f=i(98634);class v extends f.K{constructor(){super(...arguments),this._dirty=!0}_setDirty(){this._dirty=!0}_setClean(){if(this._dirty=!1,null!=this._parameterBlocks)for(const e of this._parameterBlocks)this[e]._setClean()}get dirty(){return this._dirty||this._checkParameterBlocksDirty()}_checkParameterBlocksDirty(){if(null==this._parameterBlocks)return!1;for(const e of this._parameterBlocks)if(this[e].dirty)return!0;return!1}}class y{constructor(){this._dirty=!0}_setDirty(){this._dirty=!0}_setClean(){this._dirty=!1}get dirty(){return this._dirty}}function b(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};return(t,i)=>{var n;const r=null!==(n=t._parameterCount)&&void 0!==n?n:0;if(t._parameterCount=r+1,e.vectorOps){const n=e.vectorOps;Object.defineProperty(t,i,{get(){return this[r]},set(e){const t=this[r];if(null==t)this[r]=e;else{if(n.equals(t,e))return;n.copy(t,e)}this._setDirty()}})}else Object.defineProperty(t,i,{get(){return this[r]},set(t){this[r]!==t&&(e.dispose&&this[r]&&this[r].dispose(),this[r]=t,this._setDirty())}})}}function w(){return(e,t)=>{var i;const n=null!==(i=e._parameterCount)&&void 0!==i?i:0;e._parameterCount=n+1,e._parameterBlocks=e._parameterBlocks||[],e._parameterBlocks.push(n),Object.defineProperty(e,t,{get(){return this[n]},set(e){this[n]!==e&&(this[n]=e,this._setDirty())}})}}var C,x,T=i(74779),S=i(37081),P=i(16010),M=i(96658),R=i(41481),A=i(26461),O=i(86097),E=i(75104),D=i(68401),I=i(25920),L=i(45856);class N extends v{constructor(e,t){super(),this.toMapSpace=t,this.baseColor=(0,c.al)(1,1,1,1),this.usePBR=!1,this.hasParametersFromSource=!1,this.mrrFactors=(0,l.nI)(L.ml),this.emissiveFactor=(0,l.al)(0,0,0),this.baseColorTexture=null,this.metallicRoughnessTexture=null,this.emissionTexture=null,this.occlusionTexture=null,this.normalTexture=null,this.objectOpacity=1,this.commonMaterialParameters=new U,this.componentParameters=new H,this.textureAlphaCutoff=A.F,this.alphaDiscardMode=D.JJ.Opaque,this.isIntegratedMesh=!1,this.polygonOffsetEnabled=!1,this.ellipsoidMode=O.U.Earth,this.hasOccludees=!1,this._techniqueConfiguration=new _._;const i=new E.I(e.position),n=(0,a.d9)(e.rotationScale);(0,s.U_)(n,n),(0,s.p4)(n,n),this.transformNormalGlobalFromModel=n,this.transformWorldFromModelTL=i.low,this.transformWorldFromModelTH=i.high,this.transformWorldFromModelRS=e.rotationScale}dispose(){this._technique=(0,r.RY)(this._technique),this.baseColorTexture=null,this.metallicRoughnessTexture=null,this.emissionTexture=null,this.occlusionTexture=null,this.normalTexture=null}get texture(){return null!=this.baseColorTexture?this.baseColorTexture.glTexture:null}get textureMetallicRoughness(){return null!=this.metallicRoughnessTexture?this.metallicRoughnessTexture.glTexture:null}get textureEmissive(){return null!=this.emissionTexture?this.emissionTexture.glTexture:null}get textureOcclusion(){return null!=this.occlusionTexture?this.occlusionTexture.glTexture:null}get textureNormal(){return null!=this.normalTexture?this.normalTexture.glTexture:null}prepareTechnique(e,t,i,n){const r=this._techniqueConfiguration;r.hasVertexColors=n.colors,r.hasNormals=n.hasNormals,r.textureCoordinateType=n.textureCoordinates,r.hasMetallicRoughnessTexture=null!=this.metallicRoughnessTexture,r.hasEmissionTexture=null!=this.emissionTexture,r.hasOcclusionTexture=null!=this.occlusionTexture,r.hasNormalTexture=null!=this.normalTexture,r.transparencyPassType=t.identifier===T.o9.Material&&null!=i.transparencyPassType?i.transparencyPassType:I.A.NONE,r.multipassEnabled=t.identifier===T.o9.Material&&i.multipassEnabled,r.cullAboveGround=t.identifier===T.o9.Material&&i.multipassTerrain.cullAboveGround,r.ellipsoidMode=this.ellipsoidMode,r.componentData=this.componentParameters.type,r.cullFace=this.commonMaterialParameters.cullFace,r.doubleSidedMode=this.commonMaterialParameters.doubleSided?M.q.View:M.q.None,r.hasColorTexture=null!=this.baseColorTexture;const s=this._computeWhichMaterialPass();if(r.blendingEnabled=s===C.Transparent||s===C.OpaqueAndTransparent,r.alphaDiscardMode=this.alphaDiscardMode,r.integratedMeshMode=this.isIntegratedMesh?function(e){var t;return null!=(null===(t=e.overlay)||void 0===t?void 0:t.getTexture(u.D.ColorNoRasterImage))}(i)?function(e){var t;return null!=(null===(t=e.overlay)||void 0===t?void 0:t.getTexture(u.D.WaterNormal))}(i)?_.O.ColorOverlayWithWater:_.O.ColorOverlay:_.O.NoOverlay:_.O.None,r.hasPolygonOffset=this.polygonOffsetEnabled,r.pbrMode=r.integratedMeshMode===_.O.ColorOverlayWithWater?R.f7.WaterOnIntegratedMesh:this.usePBR?this.hasParametersFromSource?n.needsNormals&&this.isIntegratedMesh?R.f7.Disabled:R.f7.Schematic:R.f7.Normal:R.f7.Disabled,r.normalType=n.needsNormals?r.hasNormals?P.r.Compressed:P.r.ScreenDerivative:P.r.Ground,r.hasSlicePlane=null!=i.slicePlane&&this.commonMaterialParameters.hasSlicePlane,t.identifier===T.o9.ShadowMap)r.output=S.H_.Shadow,r.vertexDiscardMode=g.a.None;else if(t.identifier===T.o9.ViewshedShadowMap)r.output=S.H_.ViewshedShadow,r.vertexDiscardMode=g.a.None;else if(t.identifier===T.o9.Highlight)r.output=S.H_.Highlight,r.vertexDiscardMode=g.a.None;else{switch(s===C.OpaqueAndTransparent?r.vertexDiscardMode=t.transparent?g.a.Opaque:g.a.Transparent:r.vertexDiscardMode=g.a.None,r.output=t.output,r.receiveAmbientOcclusion=!1,r.receiveShadows=!1,t.output){case S.H_.Color:r.receiveAmbientOcclusion=null!=i.ssao,r.hasOccludees=i.hasOccludees,r.receiveShadows=i.shadowMap.ready,r.hasScreenSpaceReflections=null!=i.ssr.lastFrameColor,r.hasCloudsReflections=null!=i.cloudsFade.data;break;case S.H_.ObjectAndLayerIdColor:r.objectAndLayerIdColor=!0}r.snowCover=this.hasSnowCover(i)}return this._technique=e.releaseAndAcquire(p.h,r,this._technique),this._setClean(),this._technique}hasSnowCover(e){return null!=e.weather&&e.weatherVisible&&"snowy"===e.weather.type&&"enabled"===e.weather.snowCover}submit(e,t,i){if(0===this.objectOpacity)return;const n=i.renderable.geometry,r=i.components,s=i.renderable.meta.cameraDepthSquared,a=r.geometryRanges,o=r.highlightRanges,l=r.defaultShadowMapRanges;switch(this._computeWhichMaterialPass()){case C.Opaque:e.materialOpaque.submitDraw(this,n,a,s);break;case C.Transparent:e.materialTransparent.submitDraw(this,n,a,s);break;case C.OpaqueAndTransparent:e.materialOpaque.submitDraw(this,n,a,s),e.materialTransparent.submitDraw(this,n,a,s);break;case C.IntegratedMesh:e.materialIntegratedMesh.submitDraw(this,n,a,s),function(e){var t;return null!=(null===(t=e.overlay)||void 0===t?void 0:t.getTexture(u.D.Highlight))}(t)&&e.highlightIntegratedMesh.submitDraw(this,n,a,s)}const h=this.componentParameters.castShadows!==x.None;h&&e.shadowMap.submitDraw(this,n,a,s),null!=o&&(e.highlight.submitDraw(this,n,o,s),h&&e.highlightShadowMap.submitDraw(this,n,o,s)),t.viewshedEnabled&&e.viewshedShadowMap.submitDraw(this,n,a,s),h&&null!=l&&e.defaultShadowMap.submitDraw(this,n,l,s)}_computeWhichMaterialPass(){return this.isIntegratedMesh?C.IntegratedMesh:this.objectOpacity<1?C.Transparent:this.componentParameters.opaqueOverride===x.All?C.Opaque:this.baseColor[3]<1||this.alphaDiscardMode===D.JJ.Blend||this.alphaDiscardMode===D.JJ.MaskBlend?C.Transparent:this.componentParameters.transparent===x.None?C.Opaque:this.componentParameters.transparent===x.All?C.Transparent:C.OpaqueAndTransparent}}(0,n._)([b({vectorOps:h.v})],N.prototype,"baseColor",void 0),(0,n._)([b()],N.prototype,"usePBR",void 0),(0,n._)([b()],N.prototype,"hasParametersFromSource",void 0),(0,n._)([b({vectorOps:o.I})],N.prototype,"mrrFactors",void 0),(0,n._)([b({vectorOps:o.I})],N.prototype,"emissiveFactor",void 0),(0,n._)([b({dispose:!0})],N.prototype,"baseColorTexture",void 0),(0,n._)([b({dispose:!0})],N.prototype,"metallicRoughnessTexture",void 0),(0,n._)([b({dispose:!0})],N.prototype,"emissionTexture",void 0),(0,n._)([b({dispose:!0})],N.prototype,"occlusionTexture",void 0),(0,n._)([b({dispose:!0})],N.prototype,"normalTexture",void 0),(0,n._)([b()],N.prototype,"objectOpacity",void 0),(0,n._)([w()],N.prototype,"commonMaterialParameters",void 0),(0,n._)([w()],N.prototype,"componentParameters",void 0),(0,n._)([b()],N.prototype,"textureAlphaCutoff",void 0),(0,n._)([b()],N.prototype,"alphaDiscardMode",void 0),(0,n._)([b()],N.prototype,"isIntegratedMesh",void 0),(0,n._)([b()],N.prototype,"polygonOffsetEnabled",void 0),(0,n._)([b()],N.prototype,"ellipsoidMode",void 0),(0,n._)([b()],N.prototype,"hasOccludees",void 0),function(e){e[e.Opaque=0]="Opaque",e[e.Transparent=1]="Transparent",e[e.OpaqueAndTransparent=2]="OpaqueAndTransparent",e[e.IntegratedMesh=3]="IntegratedMesh"}(C||(C={}));class U extends y{constructor(){super(...arguments),this.doubleSided=!1,this.cullFace=D.Vr.Back,this.hasSlicePlane=!0}}(0,n._)([b()],U.prototype,"doubleSided",void 0),(0,n._)([b()],U.prototype,"cullFace",void 0),(0,n._)([b()],U.prototype,"hasSlicePlane",void 0);class H extends y{constructor(){super(...arguments),this.externalColor=(0,c.al)(1,1,1,1),this.externalColorMixMode=d.a9.Multiply,this.castShadows=x.All}get transparent(){return this.externalColor[3]<1?x.All:x.None}get opaqueOverride(){return this.externalColorMixMode===d.a9.Replace&&1===this.externalColor[3]?x.All:x.None}get visible(){return this.externalColor[3]>0?x.All:x.None}get type(){return m._N.Uniform}}(0,n._)([b({vectorOps:h.v})],H.prototype,"externalColor",void 0),(0,n._)([b()],H.prototype,"externalColorMixMode",void 0),(0,n._)([b()],H.prototype,"castShadows",void 0),function(e){e[e.All=0]="All",e[e.Some=1]="Some",e[e.None=2]="None"}(x||(x={}));class F extends y{constructor(){super(...arguments),this.texture=null,this.transparent=x.None,this.opaqueOverride=x.None,this.castShadows=x.None}get type(){return m._N.Varying}}(0,n._)([b()],F.prototype,"texture",void 0),(0,n._)([b()],F.prototype,"transparent",void 0),(0,n._)([b()],F.prototype,"opaqueOverride",void 0),(0,n._)([b()],F.prototype,"castShadows",void 0)},9028:(e,t,i)=>{i.d(t,{V:()=>v,h:()=>f});var n=i(50951),r=i(7564),s=i(34659),a=i(37081),o=i(82144),l=i(31132),h=i(68401),c=i(78041),d=i(27627),u=i(50411),p=i(25920),_=i(4760),m=i(8548),g=i(36207);class f extends l.A{initializeConfiguration(e,t){t.spherical=e.viewingMode===n.JY.Global,t.doublePrecisionRequiresObfuscation=e.rctx.driverTest.doublePrecisionRequiresObfuscation.result}initializeProgram(e){return new d.$(e.rctx,f.shader.get().build(this.configuration),v)}_setPipelineState(e){const t=this.configuration,i=t.integratedMeshMode!==r.O.None,n=e===p.A.NONE,s=e===p.A.FrontFace;return(0,g.sm)({blending:t.output===a.H_.Color&&t.blendingEnabled?n?c.wu:(0,c.j7)(e):null,culling:(0,g.zp)(t.cullFace),depthTest:{func:(0,c.Bh)(e)},depthWrite:n||s?g.LZ:null,drawBuffers:t.output===a.H_.Depth?{buffers:[m.Xg.NONE]}:(0,c.V7)(e),colorWrite:g.BK,stencilWrite:i||t.hasOccludees?u.s3:null,stencilTest:i?(0,u.ec)(h.hU.IntegratedMeshMaskExcluded):t.hasOccludees?u.RY:null,polygonOffset:n||s?t.hasPolygonOffset?{factor:2,units:2}:null:c.E0})}initializePipeline(){return this._setPipelineState(this.configuration.transparencyPassType)}}f.shader=new o.J(s.C,(()=>i.e(86940).then(i.bind(i,86940))));const v=new Map([[_.T.POSITION,0],[_.T.NORMAL,1],[_.T.NORMALCOMPRESSED,1],[_.T.COLOR,2],[_.T.UV0,3],[_.T.UVREGION,4],[_.T.COMPONENTINDEX,5]])},7564:(e,t,i)=>{i.d(t,{O:()=>n,_:()=>f});var n,r=i(27366),s=i(37107),a=i(91871),o=i(37081),l=i(16010),h=i(60113),c=i(96658),d=i(41481),u=i(86097),p=i(99340),_=i(33559),m=i(68401),g=i(25920);!function(e){e[e.None=0]="None",e[e.NoOverlay=1]="NoOverlay",e[e.ColorOverlay=2]="ColorOverlay",e[e.ColorOverlayWithWater=3]="ColorOverlayWithWater",e[e.COUNT=4]="COUNT"}(n||(n={}));class f extends _.m{constructor(){super(...arguments),this.output=o.H_.Color,this.textureCoordinateType=h.N.None,this.componentData=s._N.Uniform,this.cullFace=m.Vr.Back,this.vertexDiscardMode=a.a.None,this.doubleSidedMode=c.q.WindingOrder,this.alphaDiscardMode=m.JJ.Opaque,this.integratedMeshMode=n.None,this.transparencyPassType=g.A.NONE,this.ellipsoidMode=u.U.Earth,this.pbrMode=d.f7.Disabled,this.normalType=l.r.Attribute,this.spherical=!1,this.doublePrecisionRequiresObfuscation=!1,this.hasVertexColors=!1,this.hasNormals=!1,this.hasSlicePlane=!1,this.hasColorTexture=!1,this.receiveAmbientOcclusion=!0,this.receiveShadows=!0,this.blendingEnabled=!0,this.hasScreenSpaceReflections=!1,this.hasPolygonOffset=!1,this.hasMetallicRoughnessTexture=!1,this.hasEmissionTexture=!1,this.hasOcclusionTexture=!1,this.hasNormalTexture=!1,this.hasOccludees=!1,this.multipassEnabled=!1,this.cullAboveGround=!1,this.hasNormalTextureTransform=!1,this.hasCloudsReflections=!0,this.snowCover=!1,this.objectAndLayerIdColor=!1}}(0,r._)([(0,_.o)({count:o.H_.COUNT})],f.prototype,"output",void 0),(0,r._)([(0,_.o)({count:h.N.COUNT})],f.prototype,"textureCoordinateType",void 0),(0,r._)([(0,_.o)({count:s._N.COUNT})],f.prototype,"componentData",void 0),(0,r._)([(0,_.o)({count:m.Vr.COUNT})],f.prototype,"cullFace",void 0),(0,r._)([(0,_.o)({count:a.a.COUNT})],f.prototype,"vertexDiscardMode",void 0),(0,r._)([(0,_.o)({count:c.q.COUNT})],f.prototype,"doubleSidedMode",void 0),(0,r._)([(0,_.o)({count:m.JJ.COUNT})],f.prototype,"alphaDiscardMode",void 0),(0,r._)([(0,_.o)({count:n.COUNT})],f.prototype,"integratedMeshMode",void 0),(0,r._)([(0,_.o)({count:g.A.COUNT})],f.prototype,"transparencyPassType",void 0),(0,r._)([(0,_.o)({count:u.U.COUNT})],f.prototype,"ellipsoidMode",void 0),(0,r._)([(0,_.o)({count:d.f7.COUNT})],f.prototype,"pbrMode",void 0),(0,r._)([(0,_.o)({count:l.r.COUNT})],f.prototype,"normalType",void 0),(0,r._)([(0,_.o)()],f.prototype,"spherical",void 0),(0,r._)([(0,_.o)()],f.prototype,"doublePrecisionRequiresObfuscation",void 0),(0,r._)([(0,_.o)()],f.prototype,"hasVertexColors",void 0),(0,r._)([(0,_.o)()],f.prototype,"hasNormals",void 0),(0,r._)([(0,_.o)()],f.prototype,"hasSlicePlane",void 0),(0,r._)([(0,_.o)()],f.prototype,"hasColorTexture",void 0),(0,r._)([(0,_.o)()],f.prototype,"receiveAmbientOcclusion",void 0),(0,r._)([(0,_.o)()],f.prototype,"receiveShadows",void 0),(0,r._)([(0,_.o)()],f.prototype,"blendingEnabled",void 0),(0,r._)([(0,_.o)()],f.prototype,"hasScreenSpaceReflections",void 0),(0,r._)([(0,_.o)()],f.prototype,"hasPolygonOffset",void 0),(0,r._)([(0,_.o)()],f.prototype,"hasMetallicRoughnessTexture",void 0),(0,r._)([(0,_.o)()],f.prototype,"hasEmissionTexture",void 0),(0,r._)([(0,_.o)()],f.prototype,"hasOcclusionTexture",void 0),(0,r._)([(0,_.o)()],f.prototype,"hasNormalTexture",void 0),(0,r._)([(0,_.o)()],f.prototype,"hasOccludees",void 0),(0,r._)([(0,_.o)()],f.prototype,"multipassEnabled",void 0),(0,r._)([(0,_.o)()],f.prototype,"cullAboveGround",void 0),(0,r._)([(0,_.o)()],f.prototype,"hasNormalTextureTransform",void 0),(0,r._)([(0,_.o)()],f.prototype,"hasCloudsReflections",void 0),(0,r._)([(0,_.o)()],f.prototype,"snowCover",void 0),(0,r._)([(0,_.o)()],f.prototype,"objectAndLayerIdColor",void 0),(0,r._)([(0,_.o)({constValue:!1})],f.prototype,"occlusionPass",void 0),(0,r._)([(0,_.o)({constValue:p.P.Draw})],f.prototype,"pbrTextureBindType",void 0),(0,r._)([(0,_.o)({constValue:!0})],f.prototype,"hasSliceHighlight",void 0),(0,r._)([(0,_.o)({constValue:!1})],f.prototype,"hasSliceInVertexProgram",void 0),(0,r._)([(0,_.o)({constValue:!1})],f.prototype,"useCustomDTRExponentForWater",void 0),(0,r._)([(0,_.o)({constValue:!1})],f.prototype,"hasVertexTangents",void 0),(0,r._)([(0,_.o)({constValue:!0})],f.prototype,"supportsTextureAtlas",void 0),(0,r._)([(0,_.o)({constValue:!1})],f.prototype,"highStepCount",void 0),(0,r._)([(0,_.o)({constValue:!1})],f.prototype,"instancedDoublePrecision",void 0),(0,r._)([(0,_.o)({constValue:!1})],f.prototype,"hasModelTransformation",void 0),(0,r._)([(0,_.o)({constValue:!0})],f.prototype,"useFillLights",void 0),(0,r._)([(0,_.o)({constValue:!1})],f.prototype,"objectAndLayerIdColorInstanced",void 0)},91871:(e,t,i)=>{i.d(t,{a:()=>o,z:()=>d});var n,r,s,a,o,l=i(30168),h=i(41644),c=i(98634);function d(e,t){const i=e.vertex;switch(i.code.add((0,c.H)(n||(n=(0,l.Z)(["#define VERTEX_DISCARD_CUTOFF (1.0 - 1.0 / 255.0)"])))),t.vertexDiscardMode){case o.None:i.code.add((0,c.H)(r||(r=(0,l.Z)(["#define vertexDiscardByOpacity(_opacity_) {}"]))));break;case o.Opaque:i.code.add((0,c.H)(s||(s=(0,l.Z)(["#define vertexDiscardByOpacity(_opacity_) { if (_opacity_ >  VERTEX_DISCARD_CUTOFF) {  gl_Position = vec4(1e38, 1e38, 1e38, 1.0); return; } }"]))));break;case o.Transparent:i.code.add((0,c.H)(a||(a=(0,l.Z)(["#define vertexDiscardByOpacity(_opacity_) { if (_opacity_ <= VERTEX_DISCARD_CUTOFF) {  gl_Position = vec4(1e38, 1e38, 1e38, 1.0); return; } }"]))));break;case o.COUNT:break;default:(0,h.Bg)(t.vertexDiscardMode)}}!function(e){e[e.None=0]="None",e[e.Transparent=1]="Transparent",e[e.Opaque=2]="Opaque",e[e.COUNT=3]="COUNT"}(o||(o={}))},92911:(e,t,i)=>{i.d(t,{N:()=>a});var n=i(55158),r=i(60113),s=i(4760);function a(e){const t=(0,n.U$)().vec3f(s.T.POSITION);return e.hasNormals&&t.vec2i16(s.T.NORMALCOMPRESSED,{glNormalized:!0}),e.textureCoordinates===r.N.Default?t.vec2f(s.T.UV0):e.textureCoordinates===r.N.Atlas&&(t.vec2f(s.T.UV0),t.vec4u16(s.T.UVREGION,{glNormalized:!0})),e.colors&&t.vec4u8(s.T.COLOR,{glNormalized:!0}),t}},75831:(e,t,i)=>{i.d(t,{R:()=>l});var n,r=i(30168),s=i(54943),a=i(96415),o=i(98634);function l(e){const t=e.fragment;e.include(a.GZ),t.include(s.K),t.code.add((0,o.H)(n||(n=(0,r.Z)(["vec3 normalFromDepth(sampler2D depthMap, vec3 pixelPos, vec2 fragCoord, vec2 uv) {\nivec2 iuv = ivec2(uv * vec2(textureSize(depthMap, 0)));\nfloat leftPixelDepth = linearizeDepth(texelFetch(depthMap, iuv + ivec2(-1, 0), 0).r);\nfloat rightPixelDepth = linearizeDepth(texelFetch(depthMap, iuv + ivec2(1, 0), 0).r);\nfloat bottomPixelDepth = linearizeDepth(texelFetch(depthMap, iuv + ivec2(0, -1), 0).r);\nfloat topPixelDepth = linearizeDepth(texelFetch(depthMap, iuv + ivec2(0, 1), 0).r);\nbool pickLeft = abs(pixelPos.z - leftPixelDepth) < abs(pixelPos.z - rightPixelDepth);\nbool pickBottom = abs(pixelPos.z - bottomPixelDepth) < abs(pixelPos.z - topPixelDepth);\nvec3 fragCoordHorizontal = pickLeft\n? vec3(fragCoord + vec2(-1.0, 0.0), leftPixelDepth)\n: vec3(fragCoord + vec2(1.0, 0.0), rightPixelDepth);\nvec3 fragCoordVertical = pickBottom\n? vec3(fragCoord + vec2(0.0, -1.0), bottomPixelDepth)\n: vec3(fragCoord + vec2(0.0, 1.0), topPixelDepth);\nvec3 verticalPixelPos = reconstructPosition(fragCoordHorizontal.xy, fragCoordHorizontal.z);\nvec3 horizontalPixelPos = reconstructPosition(fragCoordVertical.xy, fragCoordVertical.z);\nvec3 normal = normalize(cross(verticalPixelPos - pixelPos, horizontalPixelPos - pixelPos));\nreturn pickLeft == pickBottom ? normal : -normal;\n}"]))))}},97397:(e,t,i)=>{i.d(t,{M:()=>l});var n,r,s,a=i(30168),o=i(98634);function l(e,t){e.varyings.add("tbnTangent","vec3"),e.varyings.add("tbnBiTangent","vec3"),t.spherical?e.vertex.code.add((0,o.H)(n||(n=(0,a.Z)(["void forwardVertexTangent(vec3 n) {\ntbnTangent = normalize(cross(vec3(0.0, 0.0, 1.0), n));\ntbnBiTangent = normalize(cross(n, tbnTangent));\n}"])))):e.vertex.code.add((0,o.H)(r||(r=(0,a.Z)(["void forwardVertexTangent(vec3 n) {\ntbnTangent = vec3(1.0, 0.0, 0.0);\ntbnBiTangent = normalize(cross(n, tbnTangent));\n}"])))),e.fragment.code.add((0,o.H)(s||(s=(0,a.Z)(["mat3 getTBNMatrix(vec3 n) {\nreturn mat3(tbnTangent, tbnBiTangent, n);\n}"]))))}},35600:(e,t,i)=>{var n;i.d(t,{MV:()=>s,iM:()=>n,pU:()=>r}),function(e){e[e.Normal=0]="Normal",e[e.Average=1]="Average",e[e.Lighten=2]="Lighten",e[e.Lighter=3]="Lighter",e[e.Plus=4]="Plus",e[e.Screen=5]="Screen",e[e.ColorDodge=6]="ColorDodge",e[e.Darken=7]="Darken",e[e.Multiply=8]="Multiply",e[e.ColorBurn=9]="ColorBurn",e[e.Overlay=10]="Overlay",e[e.SoftLight=11]="SoftLight",e[e.HardLight=12]="HardLight",e[e.VividLight=13]="VividLight",e[e.Hue=14]="Hue",e[e.Saturation=15]="Saturation",e[e.Luminosity=16]="Luminosity",e[e.Color=17]="Color",e[e.DestinationOver=18]="DestinationOver",e[e.DestinationAtop=19]="DestinationAtop",e[e.DestinationIn=20]="DestinationIn",e[e.DestinationOut=21]="DestinationOut",e[e.SourceAtop=22]="SourceAtop",e[e.SourceIn=23]="SourceIn",e[e.SourceOut=24]="SourceOut",e[e.Xor=25]="Xor",e[e.Difference=26]="Difference",e[e.Exclusion=27]="Exclusion",e[e.Minus=28]="Minus",e[e.Invert=29]="Invert",e[e.Reflect=30]="Reflect",e[e.COUNT=31]="COUNT"}(n||(n={}));const r={normal:n.Normal,average:n.Average,lighten:n.Lighten,lighter:n.Lighter,screen:n.Screen,plus:n.Plus,"color-dodge":n.ColorDodge,darken:n.Darken,multiply:n.Multiply,"color-burn":n.ColorBurn,overlay:n.Overlay,"soft-light":n.SoftLight,"hard-light":n.HardLight,"vivid-light":n.VividLight,hue:n.Hue,saturation:n.Saturation,luminosity:n.Luminosity,color:n.Color,difference:n.Difference,exclusion:n.Exclusion,minus:n.Minus,invert:n.Invert,reflect:n.Reflect,"destination-over":n.DestinationOver,"destination-atop":n.DestinationAtop,"destination-in":n.DestinationIn,"destination-out":n.DestinationOut,"source-atop":n.SourceAtop,"source-in":n.SourceIn,"source-out":n.SourceOut,xor:n.Xor};function s(e){return e===n.DestinationOver||e===n.DestinationAtop||e===n.DestinationIn||e===n.DestinationOut||e===n.SourceAtop||e===n.SourceIn||e===n.SourceOut||e===n.Xor}},54786:(e,t,i)=>{i.d(t,{i:()=>l});var n,r=i(30168),s=i(58406),a=i(98634),o=i(19253);function l(e){e.fragment.uniforms.add(new o.A("u_colormap",(e=>e.u_colormap)),new s.p("u_colormapOffset",(e=>e.colormap.u_colormapOffset)),new s.p("u_colormapMaxIndex",(e=>e.colormap.u_colormapMaxIndex)),new s.p("u_opacity",(e=>e.common.u_opacity))),e.fragment.code.add((0,a.H)(n||(n=(0,r.Z)(["vec4 colormap(vec4 currentPixel, bool isFloat) {\nfloat colorIndex = isFloat ? currentPixel.r - u_colormapOffset : currentPixel.r * 255.0 - u_colormapOffset;\nvec4 result;\nif (currentPixel.a == 0.0 || colorIndex > u_colormapMaxIndex) {\nresult = vec4(0.0, 0.0, 0.0, 0.0);\n} else {\nvec2 texelCoordinates = vec2((colorIndex + 0.5), 0.5);\nresult = texelFetch(u_colormap, ivec2(texelCoordinates), 0);\n}\nreturn result;\n}"]))))}},9386:(e,t,i)=>{i.d(t,{G:()=>m,J:()=>_});var n,r=i(30168),s=i(82999),a=i(98634),o=i(19253);function l(e){e.fragment.uniforms.add(new o.A("u_transformGrid",(e=>e.u_transformGrid)),new s.A("u_transformSpacing",(e=>e.common.u_transformSpacing)),new s.A("u_targetImageSize",(e=>e.common.u_targetImageSize))),e.fragment.code.add((0,a.H)(n||(n=(0,r.Z)(["vec2 projectPixelLocation(vec2 coords) {\nvec2 index_image = floor(coords * u_targetImageSize);\nvec2 oneTransformPixel = vec2(4.0, 1.0);\nvec2 index_transform = floor(index_image / u_transformSpacing) * oneTransformPixel;\nvec2 pos = fract((index_image + 0.5) / u_transformSpacing);\nvec2 transform_location = index_transform + 0.5;\nvec2 srcLocation;\nif (pos.s <= pos.t) {\nvec3 ll_abc = texelFetch(u_transformGrid, ivec2(transform_location), 0).rgb;\nvec3 ll_def = texelFetch(u_transformGrid, ivec2(transform_location.s + 1.0, transform_location.t), 0).rgb;\nsrcLocation.s = dot(ll_abc, vec3(pos, 1.0));\nsrcLocation.t = dot(ll_def, vec3(pos, 1.0));\n} else {\nvec3 ur_abc = texelFetch(u_transformGrid, ivec2(transform_location.s + 2.0, transform_location.t), 0).rgb;\nvec3 ur_def = texelFetch(u_transformGrid, ivec2(transform_location.s + 3.0, transform_location.t), 0).rgb;\nsrcLocation.s = dot(ur_abc, vec3(pos, 1.0));\nsrcLocation.t = dot(ur_def, vec3(pos, 1.0));\n}\nreturn srcLocation;\n}"]))))}var h,c,d,u=i(32426),p=i(13773);class _ extends u.R{constructor(e,t,i){super(),this.common=e,this.u_image=t,this.u_transformGrid=i}}function m(e,t){e.include(l),e.fragment.uniforms.add(new o.A("u_image",(e=>e.u_image)),new p.U("u_flipY",(e=>e.common.u_flipY)),new p.U("u_applyTransform",(e=>e.common.u_applyTransform)));const{requireBilinearWithNN:i}=t;i&&e.fragment.uniforms.add(new s.A("u_srcImageSize",(e=>e.common.u_srcImageSize))),e.fragment.code.add((0,a.H)(h||(h=(0,r.Z)(["vec2 getPixelLocation(vec2 coords) {\nvec2 targetLocation = u_flipY ? vec2(coords.s, 1.0 - coords.t) : coords;\nif (!u_applyTransform) {\nreturn targetLocation;\n}\nreturn projectPixelLocation(targetLocation);\n}\nbool isOutside(vec2 coords){\nif (coords.t>1.00001 ||coords.t<-0.00001 || coords.s>1.00001 ||coords.s<-0.00001) {\nreturn true;\n} else {\nreturn false;\n}\n}"])))),i?e.fragment.code.add((0,a.H)(c||(c=(0,r.Z)(["vec4 sampleBilinear(sampler2D sampler, vec2 coords, vec2 texSize) {\nvec2 texelStart = floor(coords * texSize);\nvec2 coord0 = texelStart / texSize;\nvec2 coord1 = (texelStart +  vec2(1.0, 0.0)) / texSize;\nvec2 coord2 = (texelStart +  vec2(0.0, 1.0)) / texSize;\nvec2 coord3 = (texelStart +  vec2(1.0, 1.0)) / texSize;\nvec4 color0 = texture(sampler, coord0);\nvec4 color1 = texture(sampler, coord1);\nvec4 color2 = texture(sampler, coord2);\nvec4 color3 = texture(sampler, coord3);\nvec2 blend = fract(coords * texSize);\nvec4 color01 = mix(color0, color1, blend.x);\nvec4 color23 = mix(color2, color3, blend.x);\nvec4 color = mix(color01, color23, blend.y);\nfloat alpha = floor(color0.a * color1.a * color2.a * color3.a + 0.5);\ncolor = color * alpha + (1.0 - alpha) * texture(sampler, coords);\nreturn color;\n}\nvec4 getPixel(vec2 pixelLocation) {\nreturn sampleBilinear(u_image, pixelLocation, u_srcImageSize);\n}"])))):e.fragment.code.add((0,a.H)(d||(d=(0,r.Z)(["vec4 getPixel(vec2 pixelLocation) {\nreturn texture(u_image, pixelLocation);\n}"]))))}},98864:(e,t,i)=>{i.d(t,{P:()=>u});var n,r,s,a=i(30168),o=i(48655),l=i(71033),h=i(20395),c=i(22035),d=i(98634);function u(e,t){e.include(o.c,t),e.fragment.include(l.y);const i=e.fragment;i.uniforms.add(new h.$("baseColor",(e=>e.baseColor))),i.uniforms.add(new c.p("objectOpacity",(e=>e.objectOpacity))),t.hasVertexColors?i.code.add((0,d.H)(n||(n=(0,a.Z)(["vec3 _baseColor() {\nreturn baseColor.rgb * vColor.rgb;\n}\nfloat _baseOpacity() {\nreturn baseColor.a * vColor.a;\n}"])))):i.code.add((0,d.H)(r||(r=(0,a.Z)(["vec3 _baseColor() {\nreturn baseColor.rgb;\n}\nfloat _baseOpacity() {\nreturn baseColor.a;\n}"])))),i.code.add((0,d.H)(s||(s=(0,a.Z)(["vec4 computeMaterialColor(vec4 textureColor, vec4 externalColor, int externalColorMixMode) {\nvec3 baseColor = _baseColor();\nfloat baseOpacity = _baseOpacity();\nvec3 color = mixExternalColor(\nbaseColor,\ntextureColor.rgb,\nexternalColor.rgb,\nexternalColorMixMode\n);\nfloat opacity = objectOpacity * mixExternalOpacity(\nbaseOpacity,\ntextureColor.a,\nexternalColor.a,\nexternalColorMixMode\n);\nreturn vec4(color, opacity);\n}"]))))}},48051:(e,t,i)=>{i.d(t,{B:()=>v});var n,r,s,a,o,l,h,c,d=i(30168),u=i(41644),p=i(16010),_=i(85380),m=i(74058),g=i(96658),f=i(98634);function v(e,t){const i=e.fragment;switch(t.doubleSidedMode){case g.q.None:i.code.add((0,f.H)(n||(n=(0,d.Z)(["vec3 _adjustDoublesided(vec3 normal) {\nreturn normal;\n}"]))));break;case g.q.View:e.include(m.up,t),i.code.add((0,f.H)(r||(r=(0,d.Z)(["vec3 _adjustDoublesided(vec3 normal) {\nreturn dot(normal, vPositionWorldCameraRelative) > 0.0 ? -normal : normal;\n}"]))));break;case g.q.WindingOrder:i.code.add((0,f.H)(s||(s=(0,d.Z)(["vec3 _adjustDoublesided(vec3 normal) {\nreturn gl_FrontFacing ? normal : -normal;\n}"]))));break;default:(0,u.Bg)(t.doubleSidedMode);case g.q.COUNT:}switch(t.normalType){case p.r.Attribute:case p.r.Compressed:e.include(_.Bb,t),i.code.add((0,f.H)(a||(a=(0,d.Z)(["vec3 shadingNormalWorld() {\nreturn _adjustDoublesided(normalize(vNormalWorld));\n}\nvec3 shadingNormal_view() {\nvec3 normal = normalize(vNormalView);\nreturn gl_FrontFacing ? normal : -normal;\n}"]))));break;case p.r.ScreenDerivative:e.include(m.up,t),i.code.add((0,f.H)(o||(o=(0,d.Z)(["vec3 shadingNormalWorld() {\nreturn normalize(cross(\ndFdx(vPositionWorldCameraRelative),\ndFdy(vPositionWorldCameraRelative)\n));\n}\nvec3 shadingNormal_view() {\nreturn normalize(cross(dFdx(vPosition_view),dFdy(vPosition_view)));\n}"]))));break;case p.r.Ground:t.spherical?(e.include(m.up,t),i.code.add((0,f.H)(l||(l=(0,d.Z)(["vec3 shadingNormalWorld() {\nreturn normalize(positionWorld());\n}"]))))):i.code.add((0,f.H)(h||(h=(0,d.Z)(["vec3 shadingNormalWorld() {\nreturn vec3(0.0, 0.0, 1.0);\n}"])))),i.code.add((0,f.H)(c||(c=(0,d.Z)(["vec3 shadingNormal_view() {\nreturn normalize(cross(dFdx(vPosition_view),dFdy(vPosition_view))).xyz;\n}"]))));break;default:(0,u.Bg)(t.normalType);case p.r.COUNT:}}},51612:(e,t,i)=>{i.d(t,{s:()=>_});var n,r,s,a=i(30168),o=i(37081),l=i(60113),h=i(51520),c=i(27193),d=i(98634),u=i(78050),p=i(68401);function _(e,t){const i=e.fragment;if(!t.hasColorTexture||t.output!==o.H_.Color&&t.alphaDiscardMode===p.JJ.Opaque)i.code.add((0,d.H)(s||(s=(0,a.Z)(["vec4 readBaseColorTexture() { return vec4(1.0); }"]))));else{e.include(h.i,t);const s=t.textureCoordinateType===l.N.Atlas;i.uniforms.add(new u.R("baseColorTexture",(e=>e.texture))),s?(e.include(c.r),i.code.add((0,d.H)(n||(n=(0,a.Z)(["vec4 readBaseColorTexture() {\nreturn textureAtlasLookup(baseColorTexture, vuv0, vuvRegion);\n}"]))))):i.code.add((0,d.H)(r||(r=(0,a.Z)(["vec4 readBaseColorTexture() {\nreturn texture(baseColorTexture, vuv0);\n}"]))))}}},91835:(e,t,i)=>{i.d(t,{H:()=>a});var n,r=i(30168),s=i(98634);function a(e){e.code.add((0,s.H)(n||(n=(0,r.Z)(["\n    float lineFactorAtPosition(float value) {\n      float pos = value * ",";\n      if(pos < 0.5 || pos > ",") {\n        return 1.0;\n      }\n\n      pos = pos + 0.5;\n      float modulo = mod(pos, 16.0);\n      return modulo <= 2.0 ?  1.0 - abs(modulo - 1.0) : 0.0;\n    }\n\n    float lineFactorAtUV(vec2 uv) {\n      return max(lineFactorAtPosition(uv.x), lineFactorAtPosition(uv.y));\n    }\n\n    float lineFactor(vec2 uv) {\n      vec2 offset = fwidth(uv) * 0.25;\n      return (lineFactorAtUV(vec2(uv.x + offset.x, uv.y + offset.y)) +\n              lineFactorAtUV(vec2(uv.x - offset.x, uv.y + offset.y)) +\n              lineFactorAtUV(vec2(uv.x + offset.x, uv.y - offset.y)) +\n              lineFactorAtUV(vec2(uv.x - offset.x, uv.y - offset.y))) / 4.0;\n    }\n\n    vec3 gridColor(vec2 uv) {\n      float line = lineFactor(uv) * 0.1 + 0.9;\n      return vec3(1.0, 0.972, 0.918) * line;\n    }"])),s.H.float(257),s.H.float(256.5)))}},57017:(e,t,i)=>{var n;i.d(t,{I:()=>n}),function(e){e[e.NotRequired=0]="NotRequired",e[e.Required=1]="Required",e[e.COUNT=2]="COUNT"}(n||(n={}))},8966:(e,t,i)=>{var n;i.d(t,{l:()=>n}),function(e){e[e.Composite=0]="Composite",e[e.ColorComposite=1]="ColorComposite",e[e.GridComposite=2]="GridComposite",e[e.GroupBackgroundComposite=3]="GroupBackgroundComposite",e[e.COUNT=4]="COUNT"}(n||(n={}))},25012:(e,t,i)=>{var n;i.d(t,{m:()=>n}),function(e){e[e.Off=0]="Off",e[e.On=1]="On",e[e.COUNT=2]="COUNT"}(n||(n={}))},28288:(e,t,i)=>{i.d(t,{EK:()=>b,uS:()=>y});var n,r,s,a,o,l,h,c,d,u,p=i(30168),_=i(93511),m=i(91835),g=i(55375),f=i(98634),v=i(61809);class y extends _.nj{constructor(){super(...arguments),this.overlayOpacity=1}}function b(e,t){const{vertex:i,fragment:_,varyings:v}=e;v.add("vtc","vec2"),i.uniforms.add(new x("texOffsetAndScale")),_.uniforms.add(new T("tex")),_.uniforms.add(new C("textureOpacities"));const y=t.textureFadingEnabled&&!t.renderOccluded;y&&(i.uniforms.add(new x("nextTexOffsetAndScale")),v.add("nvtc","vec2"),_.uniforms.add(new T("texNext")),_.uniforms.add(new C("nextTexOpacities")),_.uniforms.add(new w("fadeFactor")));const b=t.tileBlendInput===g.R.ColorComposite,S=t.tileBlendInput===g.R.GridComposite;S&&_.include(m.H),b&&_.uniforms.add(new C("backgroundColor")),i.code.add((0,f.H)(n||(n=(0,p.Z)(["\n  void forwardTextureCoordinatesWithTransform(in vec2 uv) {\n    vtc = uv * texOffsetAndScale.zw + texOffsetAndScale.xy;\n    ","\n  }"])),y?(0,f.H)(r||(r=(0,p.Z)(["nvtc = uv * nextTexOffsetAndScale.zw + nextTexOffsetAndScale.xy;"]))):(0,f.H)(s||(s=(0,p.Z)([""]))))),_.code.add((0,f.H)(a||(a=(0,p.Z)(["\n    vec4 getColor(vec4 color, vec2 uv, vec3 opacities) {\n      ","\n    }"])),S||b?(0,f.H)(o||(o=(0,p.Z)(["\n              if (opacities.y <= 0.0) {\n                return color * opacities.z * opacities.x;\n              }\n              vec4 bg = vec4("," * opacities.y, opacities.y);\n              vec4 layer = color * opacities.z;\n              return (bg * (1.0 - layer.a) + layer) * opacities.x;"])),b?(0,f.H)(l||(l=(0,p.Z)(["backgroundColor"]))):(0,f.H)(h||(h=(0,p.Z)(["gridColor(uv)"])))):(0,f.H)(c||(c=(0,p.Z)(["return color;"]))))),y?_.code.add((0,f.H)(d||(d=(0,p.Z)(["vec4 getTileColor() {\nvec4 color = getColor(texture(tex, vtc), vtc, textureOpacities);\nif (fadeFactor >= 1.0) {\nreturn color;\n}\nvec4 nextColor = getColor(texture(texNext, nvtc), nvtc, nextTexOpacities);\nreturn mix(nextColor, color, fadeFactor);\n}"])))):_.code.add((0,f.H)(u||(u=(0,p.Z)(["vec4 getTileColor() {\nreturn getColor(texture(tex, vtc), vtc, textureOpacities);\n}"]))))}class w extends v.x{constructor(e){super(e,"float")}}class C extends v.x{constructor(e){super(e,"vec3")}}class x extends v.x{constructor(e){super(e,"vec4")}}class T extends v.x{constructor(e){super(e,"sampler2D")}}},63434:(e,t,i)=>{i.d(t,{J:()=>de});var n,r,s,a,o,l,h,c,d,u,p,_,m,g,f,v,y,b,w,C,x,T,S,P,M,R,A,O,E,D,I,L,N,U,H,F,V,q,z,B,G,k=i(30168),Z=(i(12400),i(35600)),j=i(91835),W=i(57017),X=i(8966),Q=i(25012),Y=i(98634);function J(e,t){const i=t.blendMode;i!==Z.iM.Normal&&(i===Z.iM.Reflect&&e.code.add((0,Y.H)(n||(n=(0,k.Z)(["float reflectBlend(in float cb, in float cl) {\nreturn (cl == 1.0) ? cl : min(cb * cb / (1.0 - cl), 1.0);\n}"])))),i!==Z.iM.ColorDodge&&i!==Z.iM.VividLight||e.code.add((0,Y.H)(r||(r=(0,k.Z)(["float colorDodge(in float cb, in float cl) {\nreturn (cb == 0.0) ? 0.0 : (cl == 1.0) ? 1.0 : min(1.0, cb / (1.0 - cl));\n}"])))),i!==Z.iM.ColorBurn&&i!==Z.iM.VividLight||e.code.add((0,Y.H)(s||(s=(0,k.Z)(["float colorBurn(in float cb, in float cl) {\nreturn (cb == 1.0) ? 1.0 : (cl == 0.0) ? 0.0 : 1.0 - min(1.0, (1.0 - cb) / cl);\n}"])))),i===Z.iM.Overlay&&e.code.add((0,Y.H)(a||(a=(0,k.Z)(["float overlay(in float cb, in float cl) {\nreturn (1.0 - step(0.5, cl)) * (1.0 - 2.0 * (1.0 - cl ) * (1.0 - cb)) + step(0.5, cl) * (2.0 * cl * cb);\n}"])))),i===Z.iM.HardLight&&e.code.add((0,Y.H)(o||(o=(0,k.Z)(["float hardLight(in float cb, in float cl) {\nreturn (1.0 - step(0.5, cl)) * (2.0 * cl * cb) + step(0.5, cl) * (1.0 - 2.0 * (1.0 - cl) * (1.0 - cb));\n}"])))),i===Z.iM.SoftLight&&e.code.add((0,Y.H)(l||(l=(0,k.Z)(["float softLight(in float cb, in float cl) {\nif (cl <= 0.5) {\nreturn cb - (1.0 - 2.0 * cl) * cb * (1.0 - cb);\n}\nif (cb <= 0.25) {\nreturn cb + (2.0 * cl - 1.0) * cb * ((16.0 * cb - 12.0) * cb + 3.0);\n}\nreturn cb + (2.0 * cl - 1.0) * (sqrt(cb) - cb);\n}"])))),i===Z.iM.VividLight&&e.code.add((0,Y.H)(h||(h=(0,k.Z)(["float vividLight(in float cb, in float cl) {\nreturn (1.0 - step(0.5, cl)) * colorBurn(cb, 2.0 * cl) + step(0.5, cl) * colorDodge(cb, (2.0 * (cl - 0.5)));\n}"])))),i!==Z.iM.Hue&&i!==Z.iM.Saturation&&i!==Z.iM.Color&&i!==Z.iM.Luminosity||(e.code.add((0,Y.H)(c||(c=(0,k.Z)(["float minv3(in vec3 c) {\nreturn min(min(c.r, c.g), c.b);\n}\nfloat maxv3(in vec3 c) {\nreturn max(max(c.r, c.g), c.b);\n}\nfloat lumv3(in vec3 c) {\nreturn dot(c, vec3(0.3, 0.59, 0.11));\n}\nvec3 clipColor(vec3 color) {\nfloat lum = lumv3(color);\nfloat mincol = minv3(color);\nfloat maxcol = maxv3(color);\nif (mincol < 0.0) {\ncolor = lum + ((color - lum) * lum) / (lum - mincol);\n}\nif (maxcol > 1.0) {\ncolor = lum + ((color - lum) * (1.0 - lum)) / (maxcol - lum);\n}\nreturn color;\n}\nvec3 setLum(vec3 cbase, vec3 clum) {\nreturn clipColor(cbase + vec3(lumv3(clum) - lumv3(cbase)));\n}"])))),i!==Z.iM.Hue&&i!==Z.iM.Saturation||e.code.add((0,Y.H)(d||(d=(0,k.Z)(["float satv3(vec3 c) {\nreturn maxv3(c) - minv3(c);\n}\nvec3 setLumSat(vec3 cbase, vec3 csat, vec3 clum)\n{\nfloat minbase = minv3(cbase);\nfloat sbase = satv3(cbase);\nfloat ssat = satv3(csat);\nreturn setLum(sbase > 0.0 ? (cbase - minbase) * ssat / sbase : vec3(0.0), clum);\n}"]))))),e.code.add((0,Y.H)(u||(u=(0,k.Z)(["\n    vec4 applyBlendMode(vec3 cl, float ol, vec3 cb, float ob) {\n      ","\n    }\n  "])),i===Z.iM.Multiply?(0,Y.H)(p||(p=(0,k.Z)(["return vec4(cl * ol * cb * ob + cl * ol * (1.0 - ob) + cb * ob * (1.0 - ol), mix(ob, 1.0, ol));"]))):i===Z.iM.Average?(0,Y.H)(_||(_=(0,k.Z)(["return vec4((cb + cl) * 0.5 * ol * ob + cl * ol * (1.0 - ob) + cb * ob * (1.0 - ol), mix(ob, 1.0, ol));"]))):i===Z.iM.Lighten?(0,Y.H)(m||(m=(0,k.Z)(["return vec4(max(cb, cl) * ol * ob + cl * ol * (1.0 - ob) + cb * ob * (1.0 - ol), mix(ob, 1.0, ol));"]))):i===Z.iM.Darken?(0,Y.H)(g||(g=(0,k.Z)(["return vec4(min(cl, cb) * ol * ob + cl * ol * (1.0 - ob) + cb * ob * (1.0 - ol), mix(ob, 1.0, ol));"]))):i===Z.iM.Lighter?(0,Y.H)(f||(f=(0,k.Z)(["return vec4(cl * ol + cb * ob, ol + ob);"]))):i===Z.iM.Plus?(0,Y.H)(v||(v=(0,k.Z)(["return clamp(vec4(cl.rgb + cb.rgb, ol + ob), 0.0, 1.0);"]))):i===Z.iM.Minus?(0,Y.H)(y||(y=(0,k.Z)(["return vec4(clamp(vec3(cb.rgb - cl.rgb), 0.0, 1.0), ob * ol);"]))):i===Z.iM.Screen?(0,Y.H)(b||(b=(0,k.Z)(["return vec4((cl + cb - cl * cb) * ol * ob + cl * ol * (1.0 - ob) + cb * ob * (1.0 - ol), mix(ob, 1.0, ol));"]))):i===Z.iM.Difference?(0,Y.H)(w||(w=(0,k.Z)(["return vec4(abs(cb - cl) * ol * ob + cl * ol * (1.0 - ob) + cb * ob * (1.0 - ol), mix(ob, 1.0, ol));"]))):i===Z.iM.Invert?(0,Y.H)(C||(C=(0,k.Z)(["return vec4((1.0 - cb) * ol * ob + cb * ob * (1.0 - ol), ob);"]))):i===Z.iM.DestinationOver?(0,Y.H)(x||(x=(0,k.Z)(["return vec4(cl * ol * (1.0 - ob) + cb * ob, ol + ob - ol * ob);"]))):i===Z.iM.DestinationAtop?(0,Y.H)(T||(T=(0,k.Z)(["return vec4(cl * ol * (1.0 - ob) + cb * ob * ol, ol);"]))):i===Z.iM.DestinationOut?(0,Y.H)(S||(S=(0,k.Z)(["return vec4(cb * ob * (1.0 - ol), ob * (1.0 - ol));"]))):i===Z.iM.SourceAtop?(0,Y.H)(P||(P=(0,k.Z)(["return vec4(cl * ol * ob + cb * ob * (1.0 - ol), ob);"]))):i===Z.iM.SourceOut?(0,Y.H)(M||(M=(0,k.Z)(["return vec4(cl * ol * (1.0 - ob), ol * (1.0 - ob));"]))):i===Z.iM.Xor?(0,Y.H)(R||(R=(0,k.Z)(["return vec4(cl * ol * (1.0 - ob) + cb * ob * (1.0 - ol), ol * (1.0 - ob) + ob * (1.0 - ol));"]))):i===Z.iM.DestinationIn?(0,Y.H)(A||(A=(0,k.Z)(["return vec4(cb * ob * ol, ol * ob);"]))):i===Z.iM.SourceIn?(0,Y.H)(O||(O=(0,k.Z)(["return vec4(cl * ol * ob, ol * ob);"]))):i===Z.iM.Hue?(0,Y.H)(E||(E=(0,k.Z)(["\n          vec3 f = setLumSat(cl, cb, cb);\n          return vec4(f * ol * ob + cl * ol * (1.0 - ob) + cb * ob * (1.0 - ol), mix(ob, 1.0, ol));"]))):i===Z.iM.Saturation?(0,Y.H)(D||(D=(0,k.Z)(["\n          vec3 f = setLumSat(cb, cl, cb);\n          return vec4(f * ol * ob + cl * ol * (1.0 - ob) + cb * ob * (1.0 - ol), mix(ob, 1.0, ol));"]))):i===Z.iM.Color?(0,Y.H)(I||(I=(0,k.Z)(["\n          vec3 f = setLum(cl, cb);\n          return vec4(f * ol * ob + cl * ol * (1.0 - ob) + cb * ob * (1.0 - ol), mix(ob, 1.0, ol));"]))):i===Z.iM.Luminosity?(0,Y.H)(L||(L=(0,k.Z)(["\n          vec3 f = setLum(cb, cl);\n          return vec4(f * ol * ob + cl * ol * (1.0 - ob) + cb * ob * (1.0 - ol), mix(ob, 1.0, ol));"]))):i===Z.iM.Exclusion?(0,Y.H)(N||(N=(0,k.Z)(["\n          vec3 f = cl + cb - 2.0 * cl * cb;\n          return vec4(f * ol * ob + cl * ol * (1.0 - ob) + cb * ob * (1.0 - ol), mix(ob, 1.0, ol));"]))):i===Z.iM.Reflect?(0,Y.H)(U||(U=(0,k.Z)(["\n          vec3 f = vec3(reflectBlend(cb.r, cl.r), reflectBlend(cb.g, cl.g), reflectBlend(cb.b, cl.b));\n          return vec4(f * ol * ob + cl * ol * (1.0 - ob) + cb * ob * (1.0 - ol), mix(ob, 1.0, ol));"]))):i===Z.iM.ColorDodge?(0,Y.H)(H||(H=(0,k.Z)(["\n          vec3 f = vec3(colorDodge(cb.r, cl.r), colorDodge(cb.g, cl.g), colorDodge(cb.b, cl.b));\n          return vec4(f * ol * ob + cl * ol * (1.0 - ob) + cb * ob * (1.0 - ol), mix(ob, 1.0, ol));"]))):i===Z.iM.ColorBurn?(0,Y.H)(F||(F=(0,k.Z)(["\n          vec3 f = vec3(colorBurn(cb.r, cl.r), colorBurn(cb.g, cl.g), colorBurn(cb.b, cl.b));\n          return vec4(f * ol * ob + cl * ol * (1.0 - ob) + cb * ob * (1.0 - ol), mix(ob, 1.0, ol));"]))):i===Z.iM.Overlay?(0,Y.H)(V||(V=(0,k.Z)(["\n          vec3 f = vec3(overlay(cb.r, cl.r), overlay(cb.g, cl.g), overlay(cb.b, cl.b));\n          return vec4(f * ol * ob + cl * ol * (1.0 - ob) + cb * ob * (1.0 - ol), mix(ob, 1.0, ol));"]))):i===Z.iM.SoftLight?(0,Y.H)(q||(q=(0,k.Z)(["\n          vec3 f = vec3(softLight(cb.r, cl.r), softLight(cb.g, cl.g), softLight(cb.b, cl.b));\n          return vec4(f * ol * ob + cl * ol * (1.0 - ob) + cb * ob * (1.0 - ol), mix(ob, 1.0, ol));"]))):i===Z.iM.HardLight?(0,Y.H)(z||(z=(0,k.Z)(["\n          vec3 f = vec3(hardLight(cb.r, cl.r), hardLight(cb.g, cl.g), hardLight(cb.b, cl.b));\n          return vec4(f * ol * ob + cl * ol * (1.0 - ob) + cb * ob * (1.0 - ol), mix(ob, 1.0, ol));"]))):i===Z.iM.VividLight?(0,Y.H)(B||(B=(0,k.Z)(["\n          vec3 f = vec3(vividLight(cb.r, cl.r), vividLight(cb.g, cl.g), vividLight(cb.b, cl.b));\n          return vec4(f * ol * ob + cl * ol * (1.0 - ob) + cb * ob * (1.0 - ol), mix(ob, 1.0, ol));"]))):(0,Y.H)(G||(G=(0,k.Z)([""]))))))}var K,$,ee,te,ie,ne,re,se,ae,oe,le=i(49450),he=i(58406),ce=i(19253);function de(e,t){const i=t.output===X.l.GridComposite,n=t.output===X.l.ColorComposite,r=t.output===X.l.GroupBackgroundComposite,s=t.output===X.l.Composite,a=t.baseOpacityMode===W.I.Required,o=e.fragment;a&&o.uniforms.add(new he.p("baseOpacity",(e=>e.baseOpacity))),i?o.include(j.H):n?o.uniforms.add(new le.J("backgroundColor",(e=>e.backgroundColor))):s&&o.uniforms.add(new ce.A("fboColor",(e=>e.fboTexture)));const l=t.blendMode!==Z.iM.Normal,h=t.premultipliedSource===Q.m.On,c=!l&&!h&&(s&&!a||r);o.include(J,t),o.code.add((0,Y.H)(K||(K=(0,k.Z)(["\n    vec4 getBackground(vec2 uv) {\n      return "," ",";\n    }\n\n    vec4 blendLayers(vec2 bgUV, vec4 colorLayer, float opacity) {\n      ","\n    }"])),a?(0,Y.H)($||($=(0,k.Z)(["baseOpacity *"]))):"",r?(0,Y.H)(ee||(ee=(0,k.Z)(["vec4(0.0, 0.0, 0.0, 0.0)"]))):n?(0,Y.H)(te||(te=(0,k.Z)(["vec4(backgroundColor, 1.0)"]))):i?(0,Y.H)(ie||(ie=(0,k.Z)(["vec4(gridColor(uv), 1.0)"]))):(0,Y.H)(ne||(ne=(0,k.Z)(["texelFetch(fboColor, ivec2(gl_FragCoord.xy), 0)"]))),l?(0,Y.H)(re||(re=(0,k.Z)(["\n          vec3 cl = colorLayer.a == 0.0 ? colorLayer.rgb : colorLayer.rgb / colorLayer.a;\n          vec4 bgColor = getBackground(bgUV);\n          vec3 cb = bgColor.a == 0.0 ? bgColor.rgb : bgColor.rgb / bgColor.a;\n          return applyBlendMode(clamp(cl, vec3(0.0), vec3(1.0)), colorLayer.a * opacity, cb, bgColor.a);"]))):(0,Y.H)(se||(se=(0,k.Z)(["\n          float composeAlpha = colorLayer.a * opacity;\n          ",""])),c?(0,Y.H)(ae||(ae=(0,k.Z)(["return colorLayer * opacity;"]))):(0,Y.H)(oe||(oe=(0,k.Z)(["\n            vec4 bgColor = getBackground(bgUV);\n            return bgColor * (1.0 - composeAlpha) + colorLayer * opacity;"]))))))}},55375:(e,t,i)=>{var n;i.d(t,{R:()=>n}),function(e){e[e.LayerOnly=0]="LayerOnly",e[e.ColorComposite=1]="ColorComposite",e[e.GridComposite=2]="GridComposite",e[e.COUNT=3]="COUNT"}(n||(n={}))},32426:(e,t,i)=>{i.d(t,{R:()=>c,T:()=>d});var n,r=i(30168),s=i(6644),a=i(82999),o=i(58406),l=i(98634),h=i(4760);class c extends l.K{constructor(){super(...arguments),this.scale=1,this.offset=s.AG}}function d(e){e.attributes.add(h.T.POSITION,"vec2"),e.attributes.add(h.T.UV0,"vec2"),e.varyings.add("uv","vec2"),e.varyings.add("vuv","vec2"),e.vertex.uniforms.add(new o.p("scale",(e=>e.scale)),new a.A("offset",(e=>e.offset))).code.add((0,l.H)(n||(n=(0,r.Z)(["void main(void) {\ngl_Position = vec4(position, 0.0, 1.0);\nuv = uv0 * scale + offset;\nvuv = uv0;\n}"]))))}},86097:(e,t,i)=>{i.d(t,{U:()=>n,j:()=>s});var n,r=i(92975);function s(e){return e&&(0,r.BZ)(e)?n.Mars:e&&(0,r.V2)(e)?n.Moon:n.Earth}!function(e){e[e.Earth=1]="Earth",e[e.Mars=2]="Mars",e[e.Moon=3]="Moon",e[e.COUNT=4]="COUNT"}(n||(n={}))},76284:(e,t,i)=>{i.d(t,{C:()=>u,c:()=>d});var n,r=i(30168),s=i(29134),a=i(7025),o=i(12400),l=i(96415),h=i(98634),c=i(8654);class d extends h.K{constructor(){super(...arguments),this.localOrigin=(0,o.ll)()}}function u(e){e.include(l.GZ),e.fragment.uniforms.add(new c.g("inverseViewMatrix",((e,t)=>{const i=(0,a.Ue)();return(0,s.Iu)(i,t.camera.viewMatrix,e.localOrigin),(0,s.iS)(i,i)}))),e.fragment.code.add((0,h.H)(n||(n=(0,r.Z)(["vec4 reconstructLocalPosition(vec2 coord, float linearDepth) {\nvec4 cameraSpace = vec4(reconstructPosition(coord, linearDepth), 1.0);\nreturn inverseViewMatrix * cameraSpace;\n}"]))))}},75104:(e,t,i)=>{i.d(t,{I:()=>a});var n=i(32035),r=i(93311),s=i(12400);class a{constructor(e){this._low=(0,s.Ue)(),this._high=(0,s.Ue)(),e&&this.set(e)}get low(){return this._low}get high(){return this._high}set(e){(0,n.c)(this._low,(0,n.c)(o,e));const t=(0,n.z)(o,e,this._low);(0,n.c)(this._high,t)}get(e){return(0,n.g)(e,this._low,this._high)}getLowScaled(e){return(0,n.j)(e,this._low,1)}}const o=(0,r.Ue)()},53641:(e,t,i)=>{i.d(t,{Bn:()=>o,QI:()=>a});var n=i(4760),r=i(8548),s=i(61109);new s.G(n.T.POSITION,3,r.g.FLOAT,0,12);const a=[new s.G(n.T.POSITION,2,r.g.FLOAT,0,8)],o=[new s.G(n.T.POSITION,2,r.g.FLOAT,0,16),new s.G(n.T.UV0,2,r.g.FLOAT,8,16)]},2263:(e,t,i)=>{i.d(t,{Y:()=>n,n:()=>o});var n,r=i(93169),s=i(59447),a=i(75248);function o(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:!(0,r.Z)("disable-feature:high-quality-idle"),t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;const i=new s.r;return e?(i.set(a.n.IDLE,n.Antialiasing,"low"!==t),i.set(a.n.IDLE,n.HighResolutionAtmosphere,"low"!==t),i.set(a.n.IDLE,n.HighQualityTransparency,!0),i.set(a.n.IDLE,n.SSAO,!0),i.set(a.n.IDLE,n.WaterReflection,!0),i.set(a.n.IDLE,n.PhysicalPixelRendering,!0)):(i.set(a.n.ANIMATING,n.HighResolutionShadows,!0),i.set(a.n.ANIMATING,n.HighResolutionViewshed,!0),i.set(a.n.INTERACTING,n.HighResolutionShadows,!0),i.set(a.n.INTERACTING,n.HighResolutionViewshed,!0)),i.set(a.n.IDLE,n.HighResolutionShadows,!0),i.set(a.n.IDLE,n.HighResolutionViewshed,!0),i.set(a.n.IDLE,n.HighResolutionVoxel,!0),i}!function(e){e[e.Antialiasing=0]="Antialiasing",e[e.HighQualityTransparency=1]="HighQualityTransparency",e[e.HighResolutionVoxel=2]="HighResolutionVoxel",e[e.HighResolutionAtmosphere=3]="HighResolutionAtmosphere",e[e.SSAO=4]="SSAO",e[e.WaterReflection=5]="WaterReflection",e[e.HighResolutionShadows=6]="HighResolutionShadows",e[e.HighResolutionViewshed=7]="HighResolutionViewshed",e[e.PhysicalPixelRendering=8]="PhysicalPixelRendering"}(n||(n={}))},99905:(e,t,i)=>{i.d(t,{g:()=>c});class n{constructor(e){this._maxCount=e,this._nextIndex=0,this._recycledIndices=[]}get activeCount(){return this._nextIndex-this._recycledIndices.length}get availableCount(){return this._recycledIndices.length+this._maxCount-this._nextIndex}acquire(){return this._recycledIndices.length>0?this._recycledIndices.pop():this.availableCount?this._nextIndex++:void 0}release(e){this._recycledIndices.push(e)}}var r=i(25158),s=i(8548),a=i(57808),o=i(52311);class l{constructor(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1;this._rctx=e,this._fieldCount=t,this.textureWidth=4096,this._dirty=!0;const i=new o.X(this.textureWidth,1);i.samplingMode=s.cw.NEAREST,i.wrapMode=s.e8.CLAMP_TO_EDGE,this._texture=new a.x(this._rctx,i),this._data=new r.mc(new ArrayBuffer(4*this.textureWidth))}dispose(){this._texture.dispose(),this._texture=void 0,this._data=void 0}setData(e,t,i,n,r,s){const a=e*this._fieldCount+t;this._dirty=!0,this._data.set(a,0,i),this._data.set(a,1,n),this._data.set(a,2,r),this._data.set(a,3,s)}setDataElement(e,t,i,n){const r=e*this._fieldCount+t;this._dirty=!0,this._data.set(r,i,n)}getDataElement(e,t,i){const n=e*this._fieldCount+t;return this._dirty=!0,this._data.get(n,i)}resizeToFit(e){const t=(e+1)*this._fieldCount;if(t>this._data.count){const e=Math.ceil(t/this.textureWidth)*this.textureWidth,i=new r.mc(new ArrayBuffer(4*e));i.typedBuffer.set(this._data.typedBuffer),this._data=i}}updateTexture(){if(!this._dirty)return;const e=this._texture.descriptor.width,t=this._texture.descriptor.height;this._data.count>e*t&&this._texture.resize(e,this._data.count/e),this._texture.setData(this._data.typedBuffer),this._dirty=!1}get texture(){return this._texture}}class h{constructor(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1;this.textureBuffer=new l(e,t),this._indexManager=new n(65536)}dispose(){this.textureBuffer.dispose(),this.textureBuffer=void 0}get availableCount(){return this._indexManager.availableCount}get activeCount(){return this._indexManager.activeCount}acquireIndex(){const e=this._indexManager.acquire();return this.textureBuffer.resizeToFit(e),e}releaseIndex(e){this._indexManager.release(e)}}class c{constructor(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1;this._rctx=e,this._fieldCount=t,this._buffers=[]}garbageCollect(){this._buffers=this._buffers.filter((e=>0!==e.activeCount||(e.dispose(),!1)))}destroy(){this._buffers.forEach((e=>e.dispose())),this._buffers=[]}getBuffer(e){for(const i of this._buffers)if(i.availableCount>=e)return i;if(e>65536)return null;const t=new h(this._rctx,this._fieldCount);return this._buffers.push(t),t}updateTextures(){for(const e of this._buffers)e.textureBuffer.updateTexture()}}},58206:(e,t,i)=>{i.d(t,{U:()=>F});var n=i(27366),r=i(80987),s=i(16889),a=i(92026),o=i(94172),l=i(49861),h=i(93169),c=(i(32718),i(84936),i(69912)),d=i(29134),u=i(7025),p=i(32035),_=i(12400),m=i(37081),g=i(70374),f=i(93822),v=i(18020),y=i(32251),b=i(86361),w=i(81296),C=i(97731);let x=class extends w.Z{constructor(){super(...arguments),this.sectionAngles=(0,b.Ue)()}get sectionAnglesDeg(){return(0,b.nI)(this.sectionAngles.map((e=>(0,s.BV)(e))))}set sectionAnglesDeg(e){this.sectionAngles=(0,b.nI)(e.map((e=>(0,s.Vl)(e))))}get projectionMatrix(){const e=(0,u.Ue)();return(0,d.dC)(e,this.sectionMatrix,this._projectionMatrixInternal)}get sectionMatrix(){const e=this.sectionAngles[0],t=this.sectionAngles[1],i=this.sectionAngles[2],n=this.sectionAngles[3];(0,C.hu)(e<=t),(0,C.hu)(i<=n);const r=2*Math.tan(this.fovX/2),s=2*Math.tan(this.fovY/2),a=Math.tan(e),o=Math.tan(t),l=Math.tan(i),h=o-a,c=Math.tan(n)-l,p=r/h,_=s/c,m=-(a+h/2)/r*2,g=-(l+c/2)/s*2,f=(0,u.Ue)();(0,d.vc)(f,[m,g,0]);const v=(0,u.Ue)();(0,d.xJ)(v,[p,_,1]);const y=(0,u.Ue)();return(0,d.dC)(y,v,f)}get _sectionRatioX(){const e=Math.tan(this.sectionAngles[0]),t=Math.tan(this.sectionAngles[1]),i=2*Math.tan(this.fovX/2);return Math.min(1,(t-e)/i)}setViewport(e,t){const i=t*this._sectionRatioX;return this.viewport=[e[0],e[1],i,t],i}};(0,n._)([(0,l.Cb)()],x.prototype,"sectionAngles",void 0),(0,n._)([(0,l.Cb)()],x.prototype,"sectionAnglesDeg",null),(0,n._)([(0,l.Cb)()],x.prototype,"projectionMatrix",null),(0,n._)([(0,l.Cb)()],x.prototype,"sectionMatrix",null),(0,n._)([(0,l.Cb)()],x.prototype,"_sectionRatioX",null),x=(0,n._)([(0,c.j)("esri.views.3d.webgl-engine.lib.ViewshedFaceCamera")],x);var T=i(8548);class S{constructor(){this.textureSizeModHighQuality=1.3,this.textureSizeModLowQuality=.9,this.textureSizeMultiple=128,this.toleranceSides=5,this.toleranceBottomTop=10}textureSizeModifier(e){return e?this.textureSizeModHighQuality:this.textureSizeModLowQuality}textureResizeModulo(e){return Math.ceil(e/this.textureSizeMultiple)*this.textureSizeMultiple}}const P=["front","left","right","back","top","bottom"];class M{constructor(e){this._fbos=e,this._enabled=!1,this._faces={},this._textureWidth=0,this._textureHeight=0,this.settings=new S,this._maxTextureWidth=Math.min((0,h.Z)("esri-mobile")?4096:16384,e.rctx.parameters.maxTextureSize)}get depthTexture(){var e;return null===(e=this._handle)||void 0===e?void 0:e.getTexture()}get enabled(){return this._enabled}set enabled(e){this._enabled=e,e||this.disposeOffscreenBuffers()}get isTextureZero(){return 0===this._textureWidth||0===this._textureHeight}get nearFar(){const e=this.faces;return 0===e.length?null:e[0].nearFar}get numActiveFaces(){const e=this._faces;let t=0;return Object.keys(e).forEach((i=>{e[i]&&(t+=1)})),t}get faces(){const e=this._faces,t=[];for(const i of P){const n=e[i];n&&t.push(n)}return t}get atlasRegions(){return this.faces.map((e=>[e.x/this._textureWidth,(e.x+e.width)/this._textureWidth,e.y/this._textureHeight,(e.y+e.height)/this._textureHeight]))}get viewshedProjectionMatrices(){return this.faces.map((e=>e.projectionMatrix))}get viewshedViewMatrices(){return this.faces.map((e=>e.viewMatrix))}_setupFaceCamera(e,t,i,n){const{observerRenderSpace:r,tiltedUpVector:a,targetRenderSpace:o,farDistanceRenderSpace:l,horizontalFieldOfView:h,verticalFieldOfView:c}=t,m=(0,_.Ue)();(0,p.z)(m,o,r);const g=(0,_.Ue)(),f=(0,_.Ue)(),v=(e,t)=>{const i=(0,_.Ue)(),n=(0,u.Ue)();return(0,d.Us)(n,e,t),(0,p.h)(i,m,n),(0,p.g)(i,r,i),i};let y,b=a;const w=Math.min(90,h),C=Math.min(90,Math.max(0,(h-90)/2));let T=-45,S=45,P=-45,M=45;if(function(e){return!["top","bottom"].includes(e)}(e)){const e=e=>(0,s.uZ)(e,-45,45);P=e(-c/2)-this.settings.toleranceBottomTop,M=e(+c/2)+this.settings.toleranceBottomTop}switch(e){case"front":y=o,T=-w/2,S=w/2;break;case"left":y=v(Math.PI/2,a),T=45-C;break;case"right":y=v(-Math.PI/2,a),S=-45+C;break;case"top":y=(0,p.g)(g,r,a),b=(0,p.k)(f,m);break;case"bottom":y=(0,p.z)(g,r,a),b=m;break;case"back":y=v(Math.PI,a)}const R=new x({center:y,eye:r,up:b,far:l});R.sectionAnglesDeg=[T-this.settings.toleranceSides,S+this.settings.toleranceSides,P,M],R.fovY=Math.PI/2;const A=R.setViewport(i,n);return this._faces[e]=R,A}_bindFBO(){var e;const t=this._fbos.rctx;t.unbindTexture(this.depthTexture),t.bindFramebuffer(null===(e=this._handle)||void 0===e?void 0:e.fbo)}_computeActiveFaces(e){const t=new Set,{horizontalFieldOfView:i,verticalFieldOfView:n}=e,r=-n/2,s=n/2;return 0===i||0===n||(r<=45&&s>=-45&&t.add("front"),i>90&&(t.add("left"),t.add("right")),i>270&&t.add("back"),s>45-this.settings.toleranceBottomTop&&t.add("top"),r<-45+this.settings.toleranceBottomTop&&t.add("bottom")),t}_computeBaseTextureSize(e,t,i,n){const r=Math.min(window.devicePixelRatio,t)/e.pixelRatio,s=this.settings.textureSizeModifier(i),a=(0,y.nq)(Math.floor(Math.max(e.fullWidth,e.fullHeight)*r*s)),o=Math.floor(this._maxTextureWidth/n),l=Math.min(o,a);return(0,y.pf)(l)}_ensureFBO(){var e,t,i;const n=this._textureWidth,r=this._textureHeight;(null===(e=this._handle)||void 0===e||null===(e=e.fbo)||void 0===e?void 0:e.width)===n&&(null===(t=this._handle)||void 0===t||null===(t=t.fbo)||void 0===t?void 0:t.height)===r||(null!==(i=this._handle)&&void 0!==i&&i.release(),this._handle=this._fbos.acquire(n,r,"viewshed shadow map",v.q.RGBA4)),this._handle.acquireDepth(v.m.DEPTH16_BUFFER)}clearFBO(){const e=this._fbos.rctx;this._ensureFBO(),this._bindFBO(),e.setClearColor(1,1,1,1),e.clear(T.lk.COLOR_BUFFER_BIT|T.lk.DEPTH_BUFFER_BIT)}dispose(){this.enabled=!1,this.disposeOffscreenBuffers()}disposeOffscreenBuffers(){this._handle=(0,a.RY)(this._handle)}start(e,t,i,n){if(this._faces={},!this.enabled)return!1;const r=this._computeActiveFaces(t),s=r.size;if(0===s)return!1;const a=this._computeBaseTextureSize(e,n,i,s);if(0===a)return!1;let o=0,l=0,h=0;return P.filter((e=>r.has(e))).forEach((e=>{const i=function(e,t){if(t<4)return 0;const i="front"===e||"left"===e;return 4===t?i?0:1:i||"right"===e?0:1}(e,s);i>l&&(h=Math.max(h,o),o=0),l=i;const n=i*a;o+=this._setupFaceCamera(e,t,[o,n],a)})),h=Math.max(h,o),this._textureWidth=this.settings.textureResizeModulo(h),this._textureHeight=function(e){return e<4?1:2}(s)*a,this.clearFBO(),!0}finish(){var e;null===(e=this._handle)||void 0===e||e.detachDepth()}get test(){return{faces:this._faces,faceTypes:P}}}var R=i(95720),A=i(82144),O=i(31132),E=i(7566),D=i(78041),I=i(27627),L=i(36207);class N extends O.A{initializeProgram(e){return new I.$(e.rctx,N.shader.get().build(this.configuration),E.i)}initializePipeline(){return(0,L.sm)({colorWrite:L.BK,blending:D.wu})}}N.shader=new A.J(R.a,(()=>i.e(20191).then(i.bind(i,20191))));var U=i(33559);class H extends U.m{constructor(){super(...arguments),this.useNormalMap=!0}}(0,n._)([(0,U.o)()],H.prototype,"useNormalMap",void 0);let F=class extends g.tY{get viewshedShadowMap(){return this._viewshedShadowMap}get enabled(){return this._viewsheds.length>0}constructor(e,t){super(e),this._pluginContext=null,this.renderHighQuality=!1,this._parameters=new R.V,this._configuration=new H,this._viewsheds=new r.Z,this.produces=new Map([[f.r.VIEWSHED,()=>!0]]),this._renderShadowMap=t}initialize(){this.addHandles((0,o.watch)((()=>this.view.qualitySettings.maximumPixelRatio),(e=>this._maximumPixelRatio=e),o.syncAndInitial))}destroy(){this.uninitializeRenderContext()}consumes(){return this.enabled?g.of:g.jt}initializeRenderContext(e){this._pluginContext=e,this._viewshedShadowMap=new M(this.fboCache),this._viewshedShadowMap.enabled=!0}renderNode(e,t,i){var n,r,s;const{bindParameters:a,rctx:o}=e;if(!this.enabled||!a.depth||null==i)return;const l=this._setupNormals(i);if(null!=this._technique&&this._configuration.useNormalMap===l||(this._configuration.useNormalMap=l,this._technique=null===(n=this._pluginContext)||void 0===n?void 0:n.techniques.acquire(N,this._configuration)),null!==(r=this._technique)&&void 0!==r&&r.compiled)for(const h of this._viewsheds){const t=e.rctx.getBoundFramebufferObject(),i=this._renderViewshedShadowCubeMap(a,h),n=this._viewshedShadowMap;i&&null!=n.depthTexture&&!n.isTextureZero&&(this._setPassParameters(h),e.rctx.bindFramebuffer(t),o.bindTechnique(this._technique,a,this._parameters),o.screen.draw())}else null===(s=this._pluginContext)||void 0===s||s.requestRender()}uninitializeRenderContext(){this._pluginContext=null,this._viewshedShadowMap.dispose(),this._technique=(0,a.SC)(this._technique)}updateViewsheds(e){const t=e.removes;null!=t&&(r.Z.isCollection(t)?this._viewsheds.removeMany(t):this._viewsheds.remove(t));const i=e.adds;if(null!=i)if(r.Z.isCollection(i)){const e=i.filter((e=>!this._viewsheds.includes(e)));this._viewsheds.addMany(e)}else this._viewsheds.includes(i)||this._viewsheds.add(i)}_renderViewshedShadowCubeMap(e,t){const i=this._viewshedShadowMap;if(!i.enabled)return!1;const n=i.start(e.camera,t,this.renderHighQuality,this._maximumPixelRatio);if(n)for(const r of i.faces)this._renderShadowMap(e,r,m.H_.ViewshedShadow);return i.finish(),n}_setPassParameters(e){const t=this._parameters,i=this._viewshedShadowMap,n=e.observerRenderSpace;t.localOrigin=n,t.fovs=[(0,s.Vl)(e.horizontalFieldOfView),(0,s.Vl)(e.verticalFieldOfView)],t.headingAndTilt=[(0,s.Vl)(e.heading),(0,s.Vl)(e.tiltParallelToSurface)],t.upVector=e.tiltedUpVector;const r=function(e,t){const i=(0,_.Ue)();return(0,p.z)(i,e,t)}(e.targetRenderSpace,n);t.targetVector=r,t.shadowMap=i;const a=[],o=[];for(let s=0;s<i.numActiveFaces;s++)(0,d.Iu)(q,i.viewshedViewMatrices[s],n),a.push(...q.flat()),V(i.viewshedProjectionMatrices[s],q,z),o.push(...z.flat());t.viewMatrices=a,t.projectionMatrices=o}_setupNormals(e){const t=e.get("normals"),i=null===t||void 0===t?void 0:t.getTexture();return this._parameters.normalTexture=i,null!=i}get test(){return{viewsheds:this._viewsheds}}};function V(e,t,i){const n=(0,_.al)(.5,.5,.5);return(0,d.vc)(i,n),(0,d.bA)(i,i,n),(0,d.dC)(i,i,e),(0,d.dC)(i,i,t),i}(0,n._)([(0,l.Cb)()],F.prototype,"_pluginContext",void 0),(0,n._)([(0,l.Cb)()],F.prototype,"fboCache",void 0),(0,n._)([(0,l.Cb)()],F.prototype,"view",void 0),(0,n._)([(0,l.Cb)()],F.prototype,"viewshedShadowMap",null),F=(0,n._)([(0,c.j)("esri.views.3d.webgl-engine.lib.Viewshed")],F);const q=(0,u.Ue)(),z=(0,u.Ue)()},67009:(e,t,i)=>{i.d(t,{Hr:()=>c,dG:()=>h,dx:()=>l,rD:()=>o,so:()=>d,tf:()=>a});var n=i(50256),r=i(55158),s=i(4760);const a=(0,r.U$)().vec3f(s.T.POSITION).u16(s.T.COMPONENTINDEX).freeze(),o=(0,r.U$)().vec2u8(s.T.SIDENESS).freeze(),l=(0,n.K)(o),h=(0,r.U$)().vec3f(s.T.POSITION0).vec3f(s.T.POSITION1).vec2i16(s.T.NORMALCOMPRESSED).u16(s.T.COMPONENTINDEX).u8(s.T.VARIANTOFFSET,{glNormalized:!0}).u8(s.T.VARIANTSTROKE).u8(s.T.VARIANTEXTENSION,{glNormalized:!0}).freeze(),c=(0,r.U$)().vec3f(s.T.POSITION0).vec3f(s.T.POSITION1).vec2i16(s.T.NORMALCOMPRESSED).vec2i16(s.T.NORMAL2COMPRESSED).u16(s.T.COMPONENTINDEX).u8(s.T.VARIANTOFFSET,{glNormalized:!0}).u8(s.T.VARIANTSTROKE).u8(s.T.VARIANTEXTENSION,{glNormalized:!0}).freeze(),d=new Map([[s.T.POSITION0,0],[s.T.POSITION1,1],[s.T.COMPONENTINDEX,2],[s.T.VARIANTOFFSET,3],[s.T.VARIANTSTROKE,4],[s.T.VARIANTEXTENSION,5],[s.T.NORMALCOMPRESSED,6],[s.T.NORMAL2COMPRESSED,7],[s.T.SIDENESS,8]])},41371:(e,t,i)=>{i.d(t,{D:()=>f,q:()=>v});var n=i(84936),r=i(32035),s=i(12400),a=i(50256),o=i(52920),l=i(67009);class h{updateSettings(e){this.settings=e,this._edgeHashFunction=e.reducedPrecision?_:p}write(e,t,i){b.seed=this._edgeHashFunction(i);const n=b.getIntRange(0,255),r=b.getIntRange(0,this.settings.variants-1),s=b.getFloat(),a=255*(.5*function(e,t){return Math.abs(e)**t*Math.sign(e)}(-(1-Math.min(s/.7,1))+Math.max(0,s-.7)/(1-.7),1.2)+.5);e.position0.setVec(t,i.position0),e.position1.setVec(t,i.position1),e.componentIndex.set(t,i.componentIndex),e.variantOffset.set(t,n),e.variantStroke.set(t,r),e.variantExtension.set(t,a)}}const c=new Float32Array(6),d=new Uint32Array(c.buffer),u=new Uint32Array(1);function p(e){return c[0]=e.position0[0],c[1]=e.position0[1],c[2]=e.position0[2],c[3]=e.position1[0],c[4]=e.position1[1],c[5]=e.position1[2],u[0]=31*(31*(31*(31*(31*(166811+d[0])+d[1])+d[2])+d[3])+d[4])+d[5],u[0]}function _(e){const t=c;t[0]=g(e.position0[0]),t[1]=g(e.position0[1]),t[2]=g(e.position0[2]),t[3]=g(e.position1[0]),t[4]=g(e.position1[1]),t[5]=g(e.position1[2]),u[0]=5381;for(let i=0;i<d.length;i++)u[0]=31*u[0]+d[i];return u[0]}const m=1e4;function g(e){return Math.round(e*m)/m}class f{constructor(){this._commonWriter=new h}updateSettings(e){this._commonWriter.updateSettings(e)}allocate(e){return l.dG.createBuffer(e)}write(e,t,i){this._commonWriter.write(e,t,i),(0,r.g)(y,i.faceNormal0,i.faceNormal1),(0,r.n)(y,y);const{typedBuffer:n,typedBufferStride:s}=e.normalCompressed;(0,o.hd)(n,t,y[0],y[1],y[2],s)}}f.Layout=l.dG,f.glLayout=(0,a.K)(l.dG,1);class v{constructor(){this._commonWriter=new h}updateSettings(e){this._commonWriter.updateSettings(e)}allocate(e){return l.Hr.createBuffer(e)}write(e,t,i){this._commonWriter.write(e,t,i);{const{typedBuffer:n,typedBufferStride:r}=e.normalCompressed;(0,o.hd)(n,t,i.faceNormal0[0],i.faceNormal0[1],i.faceNormal0[2],r)}{const{typedBuffer:n,typedBufferStride:r}=e.normal2Compressed;(0,o.hd)(n,t,i.faceNormal1[0],i.faceNormal1[1],i.faceNormal1[2],r)}}}v.Layout=l.Hr,v.glLayout=(0,a.K)(l.Hr,1);const y=(0,s.Ue)(),b=new n.Z},32666:(e,t,i)=>{i.d(t,{n:()=>l});var n=i(16889),r=i(27546),s=i(32035),a=i(12400);const o=-1;function l(e,t,i){const n=e.vertices.position,r=e.vertices.componentIndex,a=m.position0,l=m.position1,d=m.faceNormal0,p=m.faceNormal1,{edges:_,normals:g}=c(e),f=_.length/4,v=t.allocate(f);let y=0;const b=f,x=null===i||void 0===i?void 0:i.allocate(b);let S=0,P=0,M=0;u.length=0;for(let o=0;o<f;++o){const e=4*o;n.getVec(_.data[e],a),n.getVec(_.data[e+1],l);const t=u.pushNew();t.index=4*o,t.length=(0,s.p)(a,l)}u.sort(((e,t)=>t.length-e.length));const R=new Array,A=new Array;u.forAll((e=>{let{length:c,index:u}=e;const f=_.data[u],b=_.data[u+1],O=_.data[u+2],E=_.data[u+3],D=E===o;if(n.getVec(f,a),n.getVec(b,l),D){const e=3*O;(0,s.s)(d,g.data[e],g.data[e+1],g.data[e+2]),(0,s.c)(p,d),m.componentIndex=r.get(f),m.cosAngle=(0,s.m)(d,p)}else{let e=3*O;if((0,s.s)(d,g.data[e],g.data[e+1],g.data[e+2]),e=3*E,(0,s.s)(p,g.data[e],g.data[e+1],g.data[e+2]),m.componentIndex=r.get(f),m.cosAngle=(0,s.m)(d,p),function(e,t){return e.cosAngle>t}(m,C))return;m.cosAngle<-.9999&&(0,s.c)(p,d)}P+=c,M++,D||function(e,t){return e.cosAngle<t}(m,T)?(t.write(v,y++,m),R.push(c)):h(m,w)&&(x&&i&&i.write(x,S++,m),A.push(c))}));const O=new Float32Array(R.reverse()),E=new Float32Array(A.reverse()),D=x&&i?{instancesData:x.slice(0,S),lodInfo:{lengths:E}}:void 0;return{regular:{instancesData:v.slice(0,y),lodInfo:{lengths:O}},silhouette:D,averageEdgeLength:P/M}}function h(e,t){const i=(0,n.ZF)(e.cosAngle);return(0,s.E)(f,e.position1,e.position0),i*((0,s.m)((0,s.b)(g,e.faceNormal0,e.faceNormal1),f)>0?-1:1)>t}function c(e){const t=e.faces.length/3,i=e.faces,n=e.neighbors,r=e.vertices.position;p.length=_.length=0;for(let a=0;a<t;a++){const e=3*a,t=n[e],l=n[e+1],h=n[e+2],c=i[e],d=i[e+1],u=i[e+2];r.getVec(c,v),r.getVec(d,y),r.getVec(u,b),(0,s.f)(y,y,v),(0,s.f)(b,b,v),(0,s.b)(v,y,b),(0,s.n)(v,v),_.pushArray(v),(t===o||c<d)&&(p.push(c),p.push(d),p.push(a),p.push(t)),(l===o||d<u)&&(p.push(d),p.push(u),p.push(a),p.push(l)),(h===o||u<c)&&(p.push(u),p.push(c),p.push(a),p.push(h))}return{edges:p,normals:_}}class d{constructor(){this.index=0,this.length=0}}const u=new r.Z({allocator:e=>e||new d,deallocator:null}),p=new r.Z({deallocator:null}),_=new r.Z({deallocator:null}),m=new class{constructor(){this.position0=(0,a.Ue)(),this.position1=(0,a.Ue)(),this.faceNormal0=(0,a.Ue)(),this.faceNormal1=(0,a.Ue)(),this.componentIndex=0,this.cosAngle=0}},g=(0,a.Ue)(),f=(0,a.Ue)(),v=(0,a.Ue)(),y=(0,a.Ue)(),b=(0,a.Ue)(),w=(0,n.Vl)(4),C=Math.cos(w),x=(0,n.Vl)(35),T=Math.cos(x)},79762:(e,t,i)=>{i.d(t,{Kl:()=>c,n_:()=>g,kY:()=>d,Yr:()=>m});var n=i(35888);function r(e,t,i){const n=t/3,r=new Uint32Array(i+1),s=new Uint32Array(i+1),a=(e,t)=>{e<t?r[e+1]++:s[t+1]++};for(let f=0;f<n;f++){const t=e[3*f],i=e[3*f+1],n=e[3*f+2];a(t,i),a(i,n),a(n,t)}let o=0,l=0;for(let f=0;f<i;f++){const e=r[f+1],t=s[f+1];r[f+1]=o,s[f+1]=l,o+=e,l+=t}const h=new Uint32Array(6*n),c=r[i],d=(e,t,i)=>{if(e<t){const n=r[e+1]++;h[2*n]=t,h[2*n+1]=i}else{const n=s[t+1]++;h[2*c+2*n]=e,h[2*c+2*n+1]=i}};for(let f=0;f<n;f++){const t=e[3*f],i=e[3*f+1],n=e[3*f+2];d(t,i,f),d(i,n,f),d(n,t,f)}const u=(e,t)=>{const i=2*e,n=t-e;for(let r=1;r<n;r++){const e=h[i+2*r],t=h[i+2*r+1];let n=r-1;for(;n>=0&&h[i+2*n]>e;n--)h[i+2*n+2]=h[i+2*n],h[i+2*n+3]=h[i+2*n+1];h[i+2*n+2]=e,h[i+2*n+3]=t}};for(let f=0;f<i;f++)u(r[f],r[f+1]),u(c+s[f],c+s[f+1]);const p=new Int32Array(3*n),_=(t,i)=>t===e[3*i]?0:t===e[3*i+1]?1:t===e[3*i+2]?2:-1,m=(e,t)=>{const i=_(e,t);p[3*t+i]=-1},g=(e,t,i,n)=>{const r=_(e,t);p[3*t+r]=n;const s=_(i,n);p[3*n+s]=t};for(let f=0;f<i;f++){let e=r[f];const t=r[f+1];let i=s[f];const n=s[f+1];for(;e<t&&i<n;){const t=h[2*e],n=h[2*c+2*i];t===n?(g(f,h[2*e+1],n,h[2*c+2*i+1]),e++,i++):t<n?(m(f,h[2*e+1]),e++):(m(n,h[2*c+2*i+1]),i++)}for(;e<t;)m(f,h[2*e+1]),e++;for(;i<n;)m(h[2*c+2*i],h[2*c+2*i+1]),i++}return p}var s=i(55158),a=i(4760),o=i(67009),l=i(41371),h=i(32666);function c(e){const t=d(e.data,e.skipDeduplicate,e.indices,e.indicesLength);return p.updateSettings(e.writerSettings),_.updateSettings(e.writerSettings),(0,h.n)(t,p,_)}function d(e,t,i,s){if(t){const t=r(i,s,e.count);return new u(i,s,t,e)}const a=(0,n.d)(e.buffer,e.stride/4,{originalIndices:i,originalIndicesLength:s}),l=r(a.indices,s,a.uniqueCount);return{faces:a.indices,facesLength:a.indices.length,neighbors:l,vertices:o.tf.createView(a.buffer)}}class u{constructor(e,t,i,n){this.faces=e,this.facesLength=t,this.neighbors=i,this.vertices=n}}const p=new l.D,_=new l.q,m=(0,s.U$)().vec3f(a.T.POSITION0).vec3f(a.T.POSITION1),g=(0,s.U$)().vec3f(a.T.POSITION0).vec3f(a.T.POSITION1).u16(a.T.COMPONENTINDEX)},20684:(e,t,i)=>{i.d(t,{l:()=>u,o:()=>c});var n=i(7566),r=i(53641),s=i(80658),a=i(44070),o=i(8548),l=i(57808),h=i(52311);function c(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:r.QI,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:n.i,l=arguments.length>3&&void 0!==arguments[3]?arguments[3]:-1,h=arguments.length>4&&void 0!==arguments[4]?arguments[4]:1,c=null;return c=t===r.Bn?new Float32Array([l,l,0,0,h,l,1,0,l,h,0,1,h,h,1,1]):new Float32Array([l,l,h,l,l,h,h,h]),new s.U(e,i,{geometry:t},{geometry:a.f.createVertex(e,o.l1.STATIC_DRAW,c)})}const d=4;function u(e){const t=new h.X(d);return t.samplingMode=o.cw.NEAREST,new l.x(e,t)}},79485:(e,t,i)=>{i.d(t,{l:()=>a,w:()=>n});var n,r=i(27366),s=i(33559);!function(e){e[e.Gradient=0]="Gradient",e[e.Threshold=1]="Threshold",e[e.COUNT=2]="COUNT"}(n||(n={}));class a extends s.m{constructor(){super(...arguments),this.visualization=n.Gradient,this.bandsEnabled=!1}}(0,r._)([(0,s.o)({count:n.COUNT})],a.prototype,"visualization",void 0),(0,r._)([(0,s.o)()],a.prototype,"bandsEnabled",void 0)},85276:(e,t,i)=>{i.r(t),i.d(t,{default:()=>MC});var n=i(27366),r=i(63665),s=(i(59486),i(36721)),a=i(80987),o=i(50093),l=i(10064),h=i(98928),c=i(42537),d=i(93169),u=i(32718),p=i(92026),_=i(62314),m=i(66978),g=i(94172),f=i(99346),v=i(17842),y=i(70431),b=i(49861),w=i(89125),C=(i(84936),i(69912)),x=i(25243),T=i(7138),S=i(25265),P=i(23879);function M(e,t){const i=(0,P.vw)(e),n=(0,P.vw)(t),r=i.store,s=n.store,a=n.metadata;for(const o in a){const t=a[o],i=r.originOf(o),n=s.originOf(o);if(!t.readOnly&&n!==S.s3.DEFAULTS)if(i===S.s3.DEFAULTS)e.set(o,s.get(o));else{const e=r.get(o),t=s.get(o);e&&t&&t instanceof T.default&&e instanceof T.default&&e instanceof t.constructor&&M(e,t)}}}var R=i(12400),A=i(68748),O=i(90724),E=i(79803),D=i(77258),I=i(68859),L=i(65156),N=i(82218),U=i(85305),H=i(82582),F=i(37933),V=i(37319),q=i(6003),z=i(42047),B=i(60084),G=i(91505),k=i(78952),Z=i(34066),j=i(8904),W=i(35535);let X=class extends G.Z.EventedAccessor{constructor(e){super(e),this.demResolution={min:-1,max:-1},this.noDataValue=W.zl}initialize(){this.view.basemapTerrain.on("elevation-change",(()=>this.emit("changed",{})))}get extent(){const e=this.view.basemapTerrain;if(null==(null===e||void 0===e?void 0:e.extent)||null==e.spatialReference)return null;const t=(0,L.HH)(e.extent,e.spatialReference);return t.zmin=e.visibleElevationBounds.min,t.zmax=e.visibleElevationBounds.max,t}get spatialReference(){var e,t;return null!==(e=null===(t=this.view.basemapTerrain)||void 0===t?void 0:t.spatialReference)&&void 0!==e?e:k.Z.WGS84}elevationAt(e,t){var i,n;if(null==this.extent||!(0,Z.Kv)(this.extent,e,t)){const i=null!=this.extent?"".concat(this.extent.xmin,", ").concat(this.extent.ymin,", ").concat(this.extent.xmax,", ").concat(this.extent.ymax):null;return u.Z.getLogger(this).warn("#elevationAt()","Point used to sample elevation (".concat(e,", ").concat(t,") is outside of the sampler extent (").concat(i,")")),this.noDataValue}return null!==(i=null===(n=this.view.elevationProvider)||void 0===n?void 0:n.getElevation(e,t,0,this.spatialReference,"ground"))&&void 0!==i?i:this.noDataValue}queryElevation(e){return(0,j.G$)(e.clone(),this)}};(0,n._)([(0,b.Cb)({readOnly:!0})],X.prototype,"demResolution",void 0),(0,n._)([(0,b.Cb)({readOnly:!0})],X.prototype,"extent",null),(0,n._)([(0,b.Cb)({readOnly:!0})],X.prototype,"noDataValue",void 0),(0,n._)([(0,b.Cb)()],X.prototype,"spatialReference",null),(0,n._)([(0,b.Cb)({constructOnly:!0})],X.prototype,"view",void 0),X=(0,n._)([(0,C.j)("esri.views.support.GroundViewElevationSampler")],X);const Q=X;let Y=class extends T.default{constructor(e){super(e),this.view=null,this.layerViews=new a.Z}initialize(){this.addHandles((0,g.when)((()=>{var e;return null===(e=this.view)||void 0===e||null===(e=e.map)||void 0===e?void 0:e.ground}),(e=>e.load()))),this.addHandles(this.layerViews.on("after-changes",(()=>this._layerViewsAfterChangesHandler())))}destroy(){this._set("view",null);for(const e of this.layerViews)e.destroy();this.layerViews.length=0}get elevationSampler(){return this.view?"2d"===this.view.type?null:this.view.ready&&this.view.basemapTerrain&&this.view.basemapTerrain.ready?new Q({view:this.view}):null:null}get extent(){const e=this.view;return e&&"2d"!==e.type&&e.ready?(0,B.HH)(e,e.state.camera,e.pointsOfInterest.centerOnSurfaceFrequent.renderLocation):null}get updating(){return!this.suspended&&this.layerViews.some((e=>e.updating))}get suspended(){return!this.view||this.view.suspended}_layerViewsAfterChangesHandler(){this.removeHandles("updating"),this.addHandles(this.layerViews.map((e=>(0,g.watch)((()=>e.updating),(()=>this._updateUpdating()),g.sync))).toArray(),"updating"),this._updateUpdating()}_updateUpdating(){this.notifyChange("updating")}};(0,n._)([(0,b.Cb)({readOnly:!0})],Y.prototype,"elevationSampler",null),(0,n._)([(0,b.Cb)({readOnly:!0})],Y.prototype,"extent",null),(0,n._)([(0,b.Cb)({type:Boolean,readOnly:!0})],Y.prototype,"updating",null),(0,n._)([(0,b.Cb)({constructOnly:!0})],Y.prototype,"view",void 0),(0,n._)([(0,b.Cb)({type:a.Z,readOnly:!0})],Y.prototype,"layerViews",void 0),(0,n._)([(0,b.Cb)({readOnly:!0})],Y.prototype,"suspended",null),Y=(0,n._)([(0,C.j)("esri.views.GroundView")],Y);const J=Y;var K=i(28435),$=i(91175),ee=i(9918),te=i(50951);const ie=()=>Promise.all([i.e(13355),i.e(31819)]).then(i.bind(i,31819)),ne=()=>i.e(73725).then(i.bind(i,73725)),re={"base-dynamic":()=>Promise.all([i.e(69229),i.e(27304)]).then(i.bind(i,27304)),"base-elevation":ne,"base-tile":ie,"bing-maps":ie,"building-scene":()=>Promise.all([i.e(45026),i.e(59008),i.e(27607),i.e(54054),i.e(71486),i.e(71621),i.e(50489),i.e(11828),i.e(1576),i.e(44011),i.e(48750),i.e(63899),i.e(37829),i.e(59147),i.e(43629),i.e(37791),i.e(48506)]).then(i.bind(i,7452)),catalog:()=>i.e(57862).then(i.bind(i,57862)),"catalog-dynamic-group":()=>i.e(10866).then(i.bind(i,10866)),"catalog-footprint":()=>Promise.all([i.e(45026),i.e(59008),i.e(27607),i.e(54054),i.e(71486),i.e(71621),i.e(50489),i.e(11828),i.e(1576),i.e(48750),i.e(46340)]).then(i.bind(i,46340)),csv:()=>Promise.all([i.e(45026),i.e(59008),i.e(27607),i.e(54054),i.e(71486),i.e(71621),i.e(50489),i.e(11828),i.e(1576),i.e(48750),i.e(4766)]).then(i.bind(i,4766)),dimension:()=>i.e(46143).then(i.bind(i,46143)),elevation:ne,feature:()=>Promise.all([i.e(45026),i.e(59008),i.e(27607),i.e(54054),i.e(71486),i.e(71621),i.e(50489),i.e(11828),i.e(1576),i.e(48750),i.e(41863)]).then(i.bind(i,41863)),geojson:()=>Promise.all([i.e(45026),i.e(59008),i.e(27607),i.e(54054),i.e(71486),i.e(71621),i.e(50489),i.e(11828),i.e(1576),i.e(48750),i.e(74385)]).then(i.bind(i,74385)),graphics:()=>Promise.all([i.e(50489),i.e(97881)]).then(i.bind(i,79240)),group:()=>i.e(5407).then(i.bind(i,5407)),imagery:()=>Promise.all([i.e(69229),i.e(11283)]).then(i.bind(i,11283)),"integrated-mesh":()=>Promise.all([i.e(45026),i.e(59008),i.e(27607),i.e(54054),i.e(71486),i.e(71621),i.e(50489),i.e(11828),i.e(1576),i.e(44011),i.e(48750),i.e(63899),i.e(37829),i.e(43629),i.e(10983)]).then(i.bind(i,10983)),"integrated-mesh-3dtiles":()=>i.e(12996).then(i.bind(i,12996)),"line-of-sight":()=>i.e(31484).then(i.bind(i,31484)),"map-image":()=>Promise.all([i.e(69229),i.e(13355),i.e(23344)]).then(i.bind(i,23344)),media:()=>Promise.all([i.e(99058),i.e(121),i.e(38856),i.e(48521)]).then(i.bind(i,48521)),"ogc-feature":()=>Promise.all([i.e(45026),i.e(59008),i.e(27607),i.e(54054),i.e(71486),i.e(71621),i.e(50489),i.e(11828),i.e(1576),i.e(48750),i.e(1732)]).then(i.bind(i,1732)),"open-street-map":ie,"oriented-imagery":()=>Promise.all([i.e(45026),i.e(59008),i.e(27607),i.e(54054),i.e(71486),i.e(71621),i.e(50489),i.e(11828),i.e(1576),i.e(48750),i.e(41863)]).then(i.bind(i,41863)),"point-cloud":()=>Promise.all([i.e(44011),i.e(74432),i.e(51941)]).then(i.bind(i,51941)),voxel:()=>i.e(9714).then(i.bind(i,9714)),route:()=>Promise.all([i.e(50489),i.e(72305),i.e(29417),i.e(62827)]).then(i.bind(i,62923)),scene:e=>null==e.profile||"mesh-pyramids"===e.profile?Promise.all([i.e(45026),i.e(59008),i.e(27607),i.e(54054),i.e(71486),i.e(71621),i.e(50489),i.e(11828),i.e(1576),i.e(44011),i.e(48750),i.e(63899),i.e(37829),i.e(43629),i.e(13826),i.e(37791),i.e(47745)]).then(i.bind(i,47745)):Promise.all([i.e(45026),i.e(59008),i.e(27607),i.e(54054),i.e(71486),i.e(71621),i.e(50489),i.e(11828),i.e(1576),i.e(44011),i.e(48750),i.e(63899),i.e(37829),i.e(13826),i.e(65225)]).then(i.bind(i,65225)),stream:()=>Promise.all([i.e(45026),i.e(59008),i.e(27607),i.e(54054),i.e(71486),i.e(71621),i.e(50489),i.e(1576),i.e(11679),i.e(10676)]).then(i.bind(i,21643)),tile:ie,"imagery-tile":()=>Promise.all([i.e(80394),i.e(18354)]).then(i.bind(i,18354)),"vector-tile":()=>Promise.all([i.e(9892),i.e(30969),i.e(7180),i.e(56130),i.e(61368)]).then(i.bind(i,61368)),wcs:()=>Promise.all([i.e(80394),i.e(18354)]).then(i.bind(i,18354)),"web-tile":ie,wfs:()=>Promise.all([i.e(45026),i.e(59008),i.e(27607),i.e(54054),i.e(71486),i.e(71621),i.e(50489),i.e(11828),i.e(1576),i.e(48750),i.e(2662)]).then(i.bind(i,2662)),wms:()=>Promise.all([i.e(69229),i.e(69121)]).then(i.bind(i,69121)),wmts:()=>i.e(15421).then(i.bind(i,15421)),"geo-rss":null,kml:null,"knowledge-graph":null,"link-chart":null,"knowledge-graph-sublayer":null,"map-notes":null,"subtype-group":null,unknown:null,unsupported:null,video:null};const se=e=>null!=re[e.type],ae=e=>{const t=re[e.type];if(null==t)throw function(e){const t=e.declaredClass?e.declaredClass.slice(e.declaredClass.lastIndexOf(".")+1):"Unknown",i=t.replaceAll(/([a-z])([A-Z])/g,"$1-$2").toLowerCase();return new l.Z("".concat(i,":view-not-supported"),"".concat(t," is not supported in 3D"))}(e);return t(e)};var oe=i(14921);const le="analyses-owner-handles";var he,ce;!function(e){e[e.PENDING=0]="PENDING",e[e.CREATED=1]="CREATED"}(he||(he={})),function(e){e[e.ADDED=0]="ADDED",e[e.REMOVED=1]="REMOVED"}(ce||(ce={}));let de=class extends T.default{constructor(e){super(e),this._allAnalysisViews=new a.Z,this._creatingViewCount=0,this._items=new Map,this._scheduledUpdateHandle=null,this._attachedToViewResolver=ue(),this._analysisModules={"area-measurement":{module:null},dimension:{module:null},"direct-line-measurement":{module:null},"line-of-sight":{module:null},slice:{module:null},viewshed:{module:null}}}destroy(){this._disconnectOwners(),this._attachedToViewResolver.reject((0,m.zE)("AnalysisViewManager was destroyed"))}attach(){this._connectOwners(),this._attachedToViewResolver.resolve()}detach(){this._disconnectOwners(),this._attachedToViewResolver.reject((0,m.zE)()),this._attachedToViewResolver=ue()}get updating(){return!this.view.ready||0!==this._creatingViewCount||this._allAnalysisViews.some((e=>e.updating))}get testInfo(){}async whenAnalysisView(e){await this._attachedToViewResolver.promise;const t=this._items.get(e);if(null==t||t.state.list===ce.REMOVED)throw new l.Z("AnalysisViewManager:no-analysisview-for-analysis","The analysis has not been added to view.analyses",{analysis:e});return t.createAnalysisViewTask.promise}_connectOwners(){this.addHandles(this._connectAnalysesCollection(this.view.analyses),le)}_disconnectOwners(){this.removeHandles(le),this._update(),this._creatingViewCount=0}_connectAnalysesCollection(e){for(const n of e)this._addAnalysis(n);const t=e.on("after-add",(e=>this._addAnalysis(e.item))),i=e.on("after-remove",(e=>this._removeAnalysis(e.item)));return(0,c.kB)((()=>{t.remove(),i.remove();for(const t of e)this._removeAnalysis(t)}))}_addAnalysis(e){const t=this._items.get(e);if(null==t){const t={state:{view:he.PENDING,list:ce.ADDED},analysis:e,view:null,createAnalysisViewTask:null};this._items.set(e,t),t.createAnalysisViewTask=(0,oe.vr)((e=>this._createAnalysisViewPromise(t,e)))}else t.state.list=ce.ADDED}_removeAnalysis(e){const t=this._items.get(e);null!=t?(t.state.list=ce.REMOVED,this._scheduleUpdate()):u.Z.getLogger(this).error("Trying to remove analysis which was not added")}_scheduleUpdate(){null==this._scheduledUpdateHandle&&(this._scheduledUpdateHandle=(0,f.Os)((()=>this._update())))}_update(){this._scheduledUpdateHandle=(0,p.hw)(this._scheduledUpdateHandle),this._items.forEach((e=>{if(e.state.list===ce.REMOVED)switch(this._items.delete(e.analysis),e.state.view){case he.PENDING:e.createAnalysisViewTask=(0,p.IM)(e.createAnalysisViewTask);break;case he.CREATED:null!=e.view&&(this._allAnalysisViews.remove(e.view),e.view=(0,p.SC)(e.view),e.createAnalysisViewTask=null)}}))}async _createAnalysisViewPromise(e,t){const i=e.analysis,n=i.type,r=this._analysisModules[n];if(this._creatingViewCount+=1,null==r.module)try{r.module=await this._loadAnalysisModule(n)}catch(a){throw this._creatingViewCount-=1,a}if((0,m.Hc)(t))throw this._creatingViewCount-=1,(0,m.zE)("AnalysisView creation aborted");const s=new r.module.default({analysis:i,view:this.view});try{await s.when()}catch(a){throw this._creatingViewCount-=1,a}if((0,m.Hc)(t))throw this._creatingViewCount-=1,s.destroy(),(0,m.zE)("AnalysisView creation aborted");return e.view=s,e.state.view=he.CREATED,this._allAnalysisViews.add(s),this._creatingViewCount-=1,s}_loadAnalysisModule(e){switch(e){case"area-measurement":return Promise.all([i.e(99058),i.e(17877),i.e(121),i.e(95050),i.e(6230),i.e(77)]).then(i.bind(i,59214));case"dimension":return Promise.all([i.e(99058),i.e(17877),i.e(121),i.e(38856),i.e(73807),i.e(96026),i.e(10039),i.e(97411),i.e(29950),i.e(95050),i.e(6230),i.e(15502)]).then(i.bind(i,89290));case"direct-line-measurement":return Promise.all([i.e(99058),i.e(121),i.e(95050),i.e(6230),i.e(61491)]).then(i.bind(i,61491));case"line-of-sight":return Promise.all([i.e(17877),i.e(96026),i.e(10039),i.e(28050)]).then(i.bind(i,77897));case"slice":return Promise.all([i.e(17877),i.e(10039),i.e(44011),i.e(59147),i.e(98035),i.e(68796)]).then(i.bind(i,94018));case"viewshed":return Promise.all([i.e(99058),i.e(17877),i.e(96026),i.e(10039),i.e(97411),i.e(6599),i.e(97433)]).then(i.bind(i,44549))}}};function ue(){const e=(0,m.hh)();return e.promise.catch((()=>{})),e}(0,n._)([(0,b.Cb)()],de.prototype,"updating",null),(0,n._)([(0,b.Cb)({constructOnly:!0})],de.prototype,"view",void 0),(0,n._)([(0,b.Cb)()],de.prototype,"_allAnalysisViews",void 0),(0,n._)([(0,b.Cb)()],de.prototype,"_creatingViewCount",void 0),de=(0,n._)([(0,C.j)("esri.views.3d.analysis.AnalysisViewManager3D")],de);const pe=de;var _e=i(11582),me=i(16889),ge=i(22186),fe=i(80064);let ve=class extends T.default{constructor(e){super(e),this.collision=new Ce,this.distance=1/0,this.minimumPoiDistance=4,this.tilt=null}get altitude(){return this.mode===te.JY.Local?null:this._get("altitude")||null}set altitude(e){this.mode!==te.JY.Local?this._set("altitude",e):u.Z.getLogger(this).warn("Altitude constraint is ignored in local scenes")}clampAltitude(e){return this.altitude?(0,me.uZ)(e,this.altitude.min,this.altitude.max):e}clampTilt(e,t){if(!this.tilt)return t;const i=this.tilt(e);return(0,me.uZ)(t,i.min,i.max)}clampDistance(e){return Math.min(e,this.distance)}createDefaultTilt(){return this.mode===te.JY.Local?this._createDefaultTiltLocal():this._createDefaultTiltGlobal()}createConstantMaxTilt(e){return function(t){let i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:we;return i.min=be.min,i.max=e,i}}_createDefaultTiltLocal(){const e=this.collision.enabled?(0,fe.uV)([[4e3,be.max],[1e4,(0,me.Vl)(88)],[6e6,(0,me.Vl)(88)]]):()=>be.max;return function(t){let i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:we;return i.min=be.min,i.max=e(t),i}}_createDefaultTiltGlobal(){const e=this.collision.enabled?(0,fe.uV)([[4e3,be.max],[5e4,(0,me.Vl)(88)],[6e6,(0,me.Vl)(88)],[2e7,be.min]]):(0,fe.uV)([[3e5,be.max],[3e6,(0,me.Vl)(88)],[6e6,(0,me.Vl)(88)],[2e7,be.min]]);return function(t){let i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:we;return i.min=be.min,i.max=e(t),i}}};(0,n._)([(0,b.Cb)()],ve.prototype,"altitude",null),(0,n._)([(0,b.Cb)({readOnly:!0})],ve.prototype,"collision",void 0),(0,n._)([(0,b.Cb)()],ve.prototype,"distance",void 0),(0,n._)([(0,b.Cb)({readOnly:!0})],ve.prototype,"minimumPoiDistance",void 0),(0,n._)([(0,b.Cb)()],ve.prototype,"tilt",void 0),(0,n._)([(0,b.Cb)({constructOnly:!0})],ve.prototype,"mode",void 0),ve=(0,n._)([(0,C.j)("esri.views.3d.state.Constraints")],ve);const ye=function(e){return{min:-2e5,max:4*e.radius}}(ge.sv),be={min:(0,me.Vl)(.5),max:(0,me.Vl)(179.5)},we={min:0,max:0};let Ce=class extends T.default{constructor(){super(...arguments),this.enabled=!0,this.elevationMargin=5}};(0,n._)([(0,b.Cb)({type:Boolean})],Ce.prototype,"enabled",void 0),(0,n._)([(0,b.Cb)({type:Number})],Ce.prototype,"elevationMargin",void 0),Ce=(0,n._)([(0,C.j)("esri.views.3d.state.Constraints.CollisionConstraint")],Ce);let xe=class extends _e.j{constructor(){super(...arguments),this.min=ye.min,this.max=ye.max}};(0,n._)([(0,b.Cb)({type:Number})],xe.prototype,"min",void 0),(0,n._)([(0,b.Cb)({type:Number})],xe.prototype,"max",void 0),xe=(0,n._)([(0,C.j)("esri.views.3d.constraints.AltitudeConstraint")],xe);let Te=class extends _e.j{constructor(){super(...arguments),this.mode="auto"}get near(){return this._get("near")}set near(e){this._set("near",e),e>=this._get("far")&&(this.far=e+1e-9),this.mode="manual"}castNear(e){return Math.max(1e-8,e)}get far(){return this._get("far")}set far(e){this._set("far",e),e<=this._get("near")&&(this.near=e-1e-9),this.mode="manual"}castFar(e){return Math.max(1e-8,e)}autoUpdate(e,t){"auto"===this.mode&&(this._get("near")!==e&&this._set("near",e),this._get("far")!==t&&this._set("far",t))}};(0,n._)([(0,b.Cb)({type:Number,value:1e-8})],Te.prototype,"near",null),(0,n._)([(0,w.p)("near")],Te.prototype,"castNear",null),(0,n._)([(0,b.Cb)({type:Number,value:1e-8})],Te.prototype,"far",null),(0,n._)([(0,w.p)("far")],Te.prototype,"castFar",null),(0,n._)([(0,b.Cb)({type:["auto","manual"]})],Te.prototype,"mode",void 0),Te=(0,n._)([(0,C.j)("esri.views.3d.constraints.ClipDistanceConstraint")],Te);const Se={min:(0,me.BV)(be.min),max:(0,me.BV)(be.max)};let Pe=class extends _e.j{constructor(e){super(e),this.mode="auto"}get max(){return this._get("max")}set max(e){this._set("max",e),this.mode="manual"}castMax(e){return(0,me.uZ)(e,Se.min,Se.max)}autoUpdate(e){"auto"===this.mode&&this._get("max")!==e&&this._set("max",e)}};(0,n._)([(0,b.Cb)({type:["auto","manual"]})],Pe.prototype,"mode",void 0),(0,n._)([(0,b.Cb)({type:Number,value:Se.max})],Pe.prototype,"max",null),(0,n._)([(0,w.p)("max")],Pe.prototype,"castMax",null),Pe=(0,n._)([(0,C.j)("esri.views.3d.constraints.TiltConstraint")],Pe);let Me=class extends _e.j{constructor(){super(...arguments),this.tilt=new Pe,this.altitude=new xe,this.clipDistance=new Te}};(0,n._)([(0,b.Cb)({type:Pe})],Me.prototype,"tilt",void 0),(0,n._)([(0,b.Cb)({type:xe})],Me.prototype,"altitude",void 0),(0,n._)([(0,b.Cb)({type:Te})],Me.prototype,"clipDistance",void 0),Me=(0,n._)([(0,C.j)("esri.views.3d.constraints.Constraints")],Me);var Re=i(41644),Ae=i(84652),Oe=i(13086),Ee=i(12040);const De={key:"type",defaultKeyValue:"sun",base:null,typeMap:{sun:Oe.Z,virtual:Ee.Z}};var Ie;let Le=Ie=class extends T.default{set quality(e){["low","high"].includes(e)&&this._set("quality",e)}clone(){return new Ie({quality:this.quality})}};(0,n._)([(0,b.Cb)({type:["low","high"],value:"low"})],Le.prototype,"quality",null),Le=Ie=(0,n._)([(0,C.j)("esri.views.3d.environment.SceneViewAtmosphere")],Le);var Ne,Ue=i(21147),He=i(18814),Fe=i(67808);let Ve=Ne=class extends Ue.Z{constructor(e){super(e),this.atmosphere=new Le,this.lighting=this.castLighting(),this.cachedCameraTrackingEnabled=null}destroy(){this.atmosphere.destroy()}static fromWebsceneEnvironment(e){const t=e.cloneConstructProperties();return new Ne({...t,lighting:t.lighting?"virtual"===t.lighting.type?Ee.Z.fromWebsceneLighting(t.lighting):Oe.Z.fromWebsceneLighting(t.lighting):void 0})}castLighting(e){return this._convertLightingWithDestroy(e)}applyLighting(e){this.lighting=this._convertLightingWithDestroy(e)}_convertLightingWithDestroy(e){const t=this._convertLighting(e);return t!==e&&this.addHandles((0,c.ed)(t)),t}_convertLighting(e){var t,i;return e?e instanceof Oe.Z||e instanceof Ee.Z?e:e instanceof He.Z?this.lighting&&"virtual"!==this.lighting.type?this.lighting.cloneWithWebsceneLighting(e):new Oe.Z({...e.cloneConstructProperties(),...null===(t=this.lighting)||void 0===t?void 0:t.cloneNonPersistentConstructProperties()}):e instanceof Fe.Z?this.lighting&&"virtual"===this.lighting.type?this.lighting.cloneWithWebsceneLighting(e):new Ee.Z({...e.cloneConstructProperties(),...null===(i=this.lighting)||void 0===i?void 0:i.cloneNonPersistentConstructProperties()}):(0,x.N7)(De,e):new Oe.Z}clone(){return new Ne({lighting:this.lighting.clone(),atmosphere:this.atmosphere.clone(),weather:this.weather.clone(),atmosphereEnabled:this.atmosphereEnabled,starsEnabled:this.starsEnabled,background:(0,Ae.d9)(this.background)})}cloneWithWebsceneEnvironment(e){return new Ne({atmosphere:this.atmosphere.clone(),weather:this.weather.clone(),atmosphereEnabled:this.atmosphereEnabled,starsEnabled:this.starsEnabled,background:(0,Ae.d9)(this.background),...e.cloneConstructProperties(),lighting:this._getLighting(e)})}_getLighting(e){switch(e.lighting.type){case"sun":return this.lighting&&"sun"===this.lighting.type?this.lighting.cloneWithWebsceneLighting(e.lighting):Oe.Z.fromWebsceneLighting(e.lighting);case"virtual":return this.lighting&&"virtual"===this.lighting.type?this.lighting.cloneWithWebsceneLighting(e.lighting):Ee.Z.fromWebsceneLighting(e.lighting);default:return(0,Re.Bg)(e.lighting),Oe.Z.fromWebsceneLighting(e.lighting)}}};(0,n._)([(0,b.Cb)({type:Le,json:{read:!1},nonNullable:!0})],Ve.prototype,"atmosphere",void 0),(0,n._)([(0,b.Cb)({nonNullable:!0})],Ve.prototype,"lighting",void 0),(0,n._)([(0,w.p)("lighting")],Ve.prototype,"castLighting",null),Ve=Ne=(0,n._)([(0,C.j)("esri.views.3d.environment.SceneViewEnvironment")],Ve);const qe=Ve;var ze,Be=i(47898),Ge=i(32035),ke=i(92975),Ze=i(83448);!function(e){e[e.Realistic=0]="Realistic",e[e.Local=1]="Local",e[e.Mars=2]="Mars",e[e.None=3]="None"}(ze||(ze={}));var je=i(86950),We=i(100),Xe=i(13611),Qe=i(19093),Ye=i(86361),Je=i(5461),Ke=i(6644),$e=i(39073),et=i(98634),tt=i(82144),it=i(31132),nt=i(7566),rt=i(27627),st=i(8548),at=i(36207);class ot extends et.K{constructor(){super(...arguments),this.heightParameters=(0,Ye.Ue)(),this.radii=(0,Ke.Ue)(),this.innerFadeDistance=0,this.altitudeFade=0,this.hazeStrength=1,this.renderScale=(0,Ke.Ue)(),this.backgroundColor=(0,R.Ue)()}}class lt extends it.A{initializeProgram(e){return new rt.$(e.rctx,lt.shader.get().build(this.configuration),nt.i)}initializePipeline(){return this.configuration.reduced?(0,at.sm)({blending:(0,at.if)(st.zi.ONE,st.zi.ZERO),depthTest:{func:st.wb.ALWAYS},colorWrite:at.BK}):this.configuration.haze?(0,at.sm)({blending:(0,at.wK)(st.zi.ONE,st.zi.ZERO,st.zi.ONE_MINUS_SRC_COLOR,st.zi.ONE),colorWrite:at.BK}):(0,at.sm)({blending:(0,at.if)(st.zi.SRC_ALPHA,st.zi.ONE_MINUS_SRC_ALPHA),depthTest:{func:st.wb.LEQUAL},colorWrite:at.BK})}}lt.shader=new tt.J($e.C,(()=>i.e(40608).then(i.bind(i,40608))));var ht=i(33559);class ct extends ht.m{constructor(){super(...arguments),this.haze=!1}}(0,n._)([(0,ht.o)()],ct.prototype,"haze",void 0);class dt extends ct{constructor(){super(...arguments),this.reduced=!1}}(0,n._)([(0,ht.o)()],dt.prototype,"reduced",void 0);var ut=i(18020),pt=i(53641),_t=i(20684),mt=i(32251),gt=i(50690);class ft extends it.A{initializeProgram(e){return new rt.$(e.rctx,ft.shader.get().build(this.configuration),nt.i)}initializePipeline(){return this.configuration.haze?(0,at.sm)({blending:(0,at.wK)(st.zi.ONE,st.zi.ZERO,st.zi.ONE_MINUS_SRC_COLOR,st.zi.ONE),depthTest:{func:st.wb.ALWAYS},colorWrite:at.BK}):(0,at.sm)({blending:(0,at.if)(st.zi.SRC_ALPHA,st.zi.ONE_MINUS_SRC_ALPHA),depthTest:{func:st.wb.ALWAYS},colorWrite:at.BK})}}ft.shader=new tt.J(gt.a,(()=>i.e(93074).then(i.bind(i,93074))));var vt=i(13910);class yt{constructor(e,t){this._view=e,this._context=t,this.type=ze.Realistic,this._handles=new We.Z,this._compositingPassParameters=new gt.A,this._passParameters=new ot,this._rootTileElevationMin=NaN,this._lowerBoundEarthRadius=ge.sv.radius,this._fadeHaze=0,this._updateRadius(ge.sv.radius);const i=this._context.renderContext.rctx;this._updateRootTileElevationBounds(),this._handles.add([(0,g.watch)((()=>{var e;return null===(e=this._view)||void 0===e||null===(e=e.basemapTerrain)||void 0===e?void 0:e.rootTileElevationBounds}),(()=>{var e;return null!==(e=this._view)&&void 0!==e&&e.basemapTerrain?this._updateRootTileElevationBounds():null})),(0,g.watch)((()=>{var e;return null===(e=this._view)||void 0===e||null===(e=e.basemapTerrain)||void 0===e?void 0:e.visibleElevationBounds}),(()=>{var e;return null!==(e=this._view)&&void 0!==e&&e.basemapTerrain?this._updateVisibleElevationBounds():null})),(0,g.watch)((()=>{var e;return null===(e=this._view)||void 0===e?void 0:e.environment.background}),(e=>{const t=e instanceof vt.Z?(0,je.O)(e.color):Ye.AG;(0,Ge.s)(this._passParameters.backgroundColor,t[0]*t[3],t[1]*t[3],t[2]*t[3])}),g.syncAndInitial)]);const n=new dt;n.haze=!1,this._atmosphereTechnique=this._context.techniques.acquire(lt,n),this._compositingTechnique=this._context.techniques.acquire(ft,n),n.haze=!0,this._atmosphereHazeTechnique=this._context.techniques.acquire(lt,n),this._compositingHazeTechnique=this._context.techniques.acquire(ft,n),n.reduced=!0,n.haze=!1,this._atmosphereReducedTechnique=this._context.techniques.acquire(lt,n),n.haze=!0,this._atmosphereHazeReducedTechnique=this._context.techniques.acquire(lt,n),this._vao=(0,_t.o)(i,pt.Bn)}destroy(){this._handles.destroy(),this._compositingTechnique.release(),this._compositingHazeTechnique.release(),this._atmosphereTechnique.release(),this._atmosphereHazeTechnique.release(),this._atmosphereReducedTechnique.release(),this._atmosphereHazeReducedTechnique.release(),this._vao.dispose()}render(e,t){this._render(e,t?this._atmosphereTechnique:this._atmosphereReducedTechnique,t,!1)}renderHaze(e,t,i){this._fadeHaze=t,this._render(e,i?this._atmosphereHazeTechnique:this._atmosphereHazeReducedTechnique,i,!0)}_render(e,t,i,n){const r=e.bindParameters.mainDepth;if(!r)return;this._update(e.bindParameters.camera),this._passParameters.depthTexture=r;const s=e.rctx.bindTechnique(t,e.bindParameters,this._passParameters),a=e.offscreenRenderingHelper;if(i)a.renderDepthDetached((()=>this._renderCommon(s,e)));else{const t=e.rctx.getViewport(),i=(0,Ge.l)(e.bindParameters.camera.eye)-ge.sv.radius;let o;if(i<Je.k8){const e=Math.min(1,Math.max(0,i/Je.k8));o=n?(0,me.t7)(.4,.5,e):(0,me.t7)(.2,.3,e)}else{const e=Math.min(1,Math.max(0,(i-Je.k8)/(15*Je.k8)));o=n?(0,me.t7)(.5,1,e):(0,me.t7)(.3,.6,e)}const l=(0,mt.nq)(Math.round(o*e.bindParameters.camera.fullViewport[2])),h=(0,mt.nq)(Math.round(o*e.bindParameters.camera.fullViewport[3]));e.rctx.setViewport(0,0,l,h);const c=a.renderToCachedFBO(null,n?"chapman haze":"chapman",(()=>this._renderCommon(s,e)),[0,0,0,1],ut.q.RGBA,null,l,h);e.rctx.setViewport(t.x,t.y,t.width,t.height),this._compositingPassParameters.color=c.getTexture(),this._compositingPassParameters.depth=r;const d=n?this._compositingHazeTechnique:this._compositingTechnique;e.rctx.bindTechnique(d,e.bindParameters,this._compositingPassParameters),a.renderDepthDetached((()=>e.rctx.screen.draw())),c.release()}}_renderCommon(e,t){null!=this._vao&&(t.rctx.bindVAO(this._vao),e.assertCompatibleVertexAttributeLocations(this._vao),t.rctx.drawArrays(st.MX.TRIANGLE_STRIP,0,4))}_updateRootTileElevationBounds(){const e=this._view.basemapTerrain.rootTileElevationBounds.min;e!==this._rootTileElevationMin&&(this._rootTileElevationMin=e,this._lowerBoundEarthRadius=ge.sv.radius,this._updateVisibleElevationBounds())}_updateVisibleElevationBounds(){const e=function(e){return e*Math.cos(Math.PI/16/16)}(ge.sv.radius+this._view.basemapTerrain.visibleElevationBounds.min);e<this._lowerBoundEarthRadius&&this._updateRadius(e)}_updateRadius(e){this._lowerBoundEarthRadius=e,(0,Xe.t8)(this._passParameters.radii,e,e+Je.k8),this._passParameters.innerFadeDistance=2*Math.sqrt((2*e-Je.Tk)*Je.Tk)}_update(e){if(!e)return;const t=(0,Ge.q)(e.eye),i=Math.sqrt(t),n=t-this._passParameters.radii[1]*this._passParameters.radii[1],r=(0,me.uZ)((i-this._passParameters.radii[0])/Je.k8,0,1);(0,Qe.s)(this._passParameters.heightParameters,i,t,n,r),this._passParameters.altitudeFade=(0,Je.yx)(i-this._lowerBoundEarthRadius),this._passParameters.hazeStrength=(0,me.t7)((0,me.t7)(.6,1,(0,me.CW)(9500,10500,i-ge.sv.radius)),1,this._fadeHaze)}}var bt=i(4685);class wt extends it.A{constructor(e){super(e,new ht.m,(()=>this.destroy()))}initializeProgram(e){return new rt.$(e.rctx,wt.shader.get().build(),nt.i)}initializePipeline(){return(0,at.sm)({blending:(0,at.wK)(st.zi.ONE,st.zi.ZERO,st.zi.SRC_ALPHA,st.zi.ONE),depthTest:{func:st.wb.LEQUAL},colorWrite:at.BK})}}wt.shader=new tt.J(bt.C,(()=>i.e(43359).then(i.bind(i,43359))));let Ct=class extends T.default{constructor(e){super(e),this._technique=new wt(e),this._vao=(0,_t.o)(e.rctx)}destroy(){this._technique=(0,p.RY)(this._technique),this._vao=(0,p.M2)(this._vao)}render(e){if(!this._technique.compiled)return void this.requestRender();const t=e.bindParameters.cloudsFade;if(null==this._vao||null==t.data)return;const i=e.rctx.bindTechnique(this._technique,e.bindParameters,xt);e.rctx.bindVAO(this._vao),i.assertCompatibleVertexAttributeLocations(this._vao),e.rctx.drawArrays(st.MX.TRIANGLE_STRIP,0,4)}};(0,n._)([(0,b.Cb)({constructOnly:!0})],Ct.prototype,"rctx",void 0),(0,n._)([(0,b.Cb)({constructOnly:!0})],Ct.prototype,"viewingMode",void 0),(0,n._)([(0,b.Cb)({constructOnly:!0})],Ct.prototype,"planetRadius",void 0),(0,n._)([(0,b.Cb)({constructOnly:!0})],Ct.prototype,"requestRender",void 0),Ct=(0,n._)([(0,C.j)("esri.views.3d.environment.CloudsComposition")],Ct);const xt=new et.K;var Tt=i(46208),St=i(29303),Pt=i(29134),Mt=i(7025),Rt=i(93311),At=i(50703),Ot=i(5573),Et=i(12658);class Dt extends it.A{constructor(e,t){super(e,t,(()=>this.destroy()))}initializeProgram(e){return new rt.$(e.rctx,Dt.shader.get().build(this.configuration),nt.i)}initializePipeline(){return(0,at.sm)({blending:(0,at.if)(st.zi.CONSTANT_COLOR,st.zi.ONE_MINUS_CONSTANT_COLOR,st.db.ADD,this.configuration.writeTextureChannels===Tt.uz.RG?[1,1,0,0]:[0,0,1,1]),depthTest:{func:st.wb.LEQUAL},colorWrite:at.BK})}}Dt.shader=new tt.J(At.a,(()=>i.e(78383).then(i.bind(i,78383))));var It=i(20460),Lt=i(50214),Nt=i(84819),Ut=i(68820);class Ht extends it.A{initializeProgram(e){return new rt.$(e.rctx,Ht.shader.get().build(this.configuration),nt.i)}initializePipeline(){return(0,at.sm)({blending:this.configuration.mode===Nt.u.Full?(0,at.if)(st.zi.ONE,st.zi.ZERO):(0,at.wK)(st.zi.ZERO,st.zi.ONE,st.zi.ONE,st.zi.ZERO),depthTest:{func:st.wb.ALWAYS},colorWrite:at.BK})}}Ht.shader=new tt.J(Lt.a,(()=>i.e(52659).then(i.bind(i,52659))));var Ft=i(53634),Vt=i(52311);let qt=class extends T.default{constructor(e){super(e),this._needsRender=!0,this._passParameters=new Lt.N,this._fbo=new Ft.X(e.context.renderContext.rctx,new Vt.X(Ut.a5)),this._vao=(0,_t.o)(e.context.renderContext.rctx)}get _techniques(){return this.context.techniques}get textureAtlas(){return null!=this._texture?null!=this._weatherMapTechnique&&this._weatherMapTechnique.compiled&&this._needsRender&&(this._texture=this._render(Nt.u.WeatherMap)):null!=this._fullTechnique&&this._fullTechnique.compiled&&(this._texture=this._render(Nt.u.Full)),this._texture}_setDirty(){this._needsRender=!0}updateWeatherMap(e){this._passParameters.weatherTile[0]===e[0]&&this._passParameters.weatherTile[1]===e[1]||((0,Xe.JG)(this._passParameters.weatherTile,e),this._setDirty())}destroy(){this._fullTechniqueCached=(0,p.RY)(this._fullTechniqueCached),this._weatherMapTechniqueCached=(0,p.RY)(this._weatherMapTechniqueCached),this._fbo=(0,p.M2)(this._fbo),this._vao=(0,p.M2)(this._vao)}get _fullTechnique(){if(null==this._fullTechniqueCached){const e=new Nt.i;e.mode=Nt.u.Full,this._fullTechniqueCached=this._techniques.acquire(Ht,e)}return this._fullTechniqueCached}get _weatherMapTechnique(){if(null==this._weatherMapTechniqueCached){const e=new Nt.i;e.mode=Nt.u.WeatherMap,this._weatherMapTechniqueCached=this._techniques.acquire(Ht,e)}return this._weatherMapTechniqueCached}_render(e){if(null==this._vao||null==this._fbo)return null;const t=e===Nt.u.Full?this._fullTechnique:this._weatherMapTechnique,i=this.context.renderContext.rctx,n=i.getViewport();i.setViewport(0,0,Ut.a5,Ut.a5),i.bindFramebuffer(this._fbo);const r=i.bindTechnique(t,null,this._passParameters);return i.bindVAO(this._vao),r.assertCompatibleVertexAttributeLocations(this._vao),i.gl.drawArrays(i.gl.TRIANGLE_STRIP,0,4),i.setViewport(n.x,n.y,n.width,n.height),this._needsRender=!1,this._fbo.colorTexture}};(0,n._)([(0,b.Cb)({constructOnly:!0})],qt.prototype,"context",void 0),(0,n._)([(0,b.Cb)({readOnly:!0})],qt.prototype,"_techniques",null),qt=(0,n._)([(0,C.j)("esri.views.3d.environment.NoiseTextureAtlas")],qt);var zt=i(83377),Bt=i(93463),Gt=i(73553);let kt=class extends T.default{constructor(e){super(e),this._techniques=new Array,this._techniqueConfiguration=new It.t,this._bindParameters=new zt.p(null,null),this._passParameters=new At.C,this._weatherTile=(0,Ke.Ue)(),this._weatherTileCount=128,this._faceIndex=0,this._tileIndex=0,this.coverage=(0,me.t7)(Et.L.default.coverage[0],Et.L.default.coverage[1],.5),this.density=(0,me.t7)(Et.L.default.density[0],Et.L.default.density[1],.5),this.absorption=(0,me.t7)(Et.L.default.absorption[0],Et.L.default.absorption[1],.5),this.cloudSize=(0,me.t7)(Et.L.default.cloudSize[0],Et.L.default.cloudSize[1],.5),this.detailSize=(0,me.t7)(Et.L.default.detailSize[0],Et.L.default.detailSize[1],.5),this.smoothness=(0,me.t7)(Et.L.default.smoothness[0],Et.L.default.smoothness[1],.5),this.cloudHeight=(0,me.t7)(Et.L.default.cloudHeight[0],Et.L.default.cloudHeight[1],.5),this.raymarchingSteps=Et.L.default.raymarchingSteps,this._viewMatrix=(0,Mt.Ue)(),this._dirty=!1,this.running=!1,this._vao=(0,_t.o)(e.context.renderContext.rctx)}_getTechnique(e){const t=1-this.context.renderContext.bindParameters.cloudsFade.readChannels,i=t===Tt.uz.RG?2*e:2*e+1;return this._techniques[i]||(this._techniqueConfiguration.writeTextureChannels=t,this._techniqueConfiguration.steps=e,this._techniques[i]=new Dt({rctx:this.context.renderContext.rctx,viewingMode:this.view.state.viewingMode},this._techniqueConfiguration),this._techniques[i])}updateWeatherTile(){const e=this.view.camera.position.latitude,t=this.view.camera.position.longitude;if(null==e||null==t)return;(0,Xe.t8)(this._weatherTile,(e+90)/180,(t+180)/360);const i=Math.floor(this._weatherTileCount*Math.abs(2*this._weatherTile[0]-1));this._weatherTile[0]=Math.floor(2*this._weatherTileCount*this._weatherTile[0]),this._weatherTile[1]=Math.floor(4*(this._weatherTileCount-i)*this._weatherTile[1]);let n=0,r=0;if(null!=this.view.environment&&"virtual"!==this.view.environment.lighting.type&&null!=this.view.environment.lighting.date){var s;const e=new Date(this.view.environment.lighting.date);e.setUTCHours(this.view.environment.lighting.date.getUTCHours()+(null!==(s=this.view.environment.lighting.displayUTCOffset)&&void 0!==s?s:0)),n=31*e.getUTCMonth()+e.getUTCDate(),r=e.getUTCFullYear()}this._weatherTile[0]=(this._weatherTile[0]+n)%(2*this._weatherTileCount),this._weatherTile[1]=(this._weatherTile[1]+r%100)%(4*this._weatherTileCount),(0,Xe.fS)(this._passParameters.weatherTile,this._weatherTile)||this.setDirty()}initialize(){const e=(0,Ze.Iu)(this.view.spatialReference);this._passParameters.cloudRadius=.5*e.radius,this.setDirty(),this.updateWeatherTile(),this.addHandles([this.view.resourceController.scheduler.registerTask(Bt.T8.CLOUDS_GENERATOR,this),(0,g.watch)((()=>[this.coverage,this.density,this.absorption,this.cloudSize,this.detailSize,this.smoothness,this.cloudHeight,this.raymarchingSteps]),(()=>this.setDirty()),g.initial)])}destroy(){this._techniques.forEach((e=>(0,p.RY)(e))),this._frameBufferCube=(0,p.M2)(this._frameBufferCube),this._techniques.length=0,this._vao.dispose(),this._passParameters.noiseTexture=(0,p.SC)(this._passParameters.noiseTexture)}get _tilesPerFace(){switch(this._techniqueConfiguration.steps){case It.p.SIXTEEN:return 1;case It.p.HUNDRED:return 4;case It.p.COUNT:case It.p.TWOHUNDRED:return 8}}get usedMemory(){var e,t,i,n;return(null!==(e=null===(t=this._frameBufferCube)||void 0===t?void 0:t.usedMemory)&&void 0!==e?e:0)+(null!==(i=null===(n=this._passParameters.noiseTexture)||void 0===n||null===(n=n.textureAtlas)||void 0===n?void 0:n.usedMemory)&&void 0!==i?i:0)}_ensureNoiseTexture(){var e,t;return null!==(t=(e=this._passParameters).noiseTexture)&&void 0!==t||(e.noiseTexture=new qt({context:this.context})),this._passParameters.noiseTexture.updateWeatherMap(this._passParameters.weatherTile),null!=this._passParameters.noiseTexture.textureAtlas}_ensureFrameBufferCube(e){if(null==this._frameBufferCube){const t=new Vt.X(e);t.target=st.No.TEXTURE_CUBE_MAP,t.wrapMode=st.e8.CLAMP_TO_EDGE,this._frameBufferCube=new Ft.X(this.context.renderContext.rctx,t)}return this._frameBufferCube}get cubeMap(){return this._frameBufferCube}destroyFrameBufferCube(){this._frameBufferCube=(0,p.M2)(this._frameBufferCube)}applyPreset(e,t){const i=e.median,n=e=>{const n=(0,me.t7)(e[0],e[1],i);return t<.5?(0,me.t7)(e[0],n,2*t):(0,me.t7)(n,e[1],2*(t-.5))};this.coverage=n(e.coverage),this.density=n(e.density),this.absorption=n(e.absorption),this.cloudSize=n(e.cloudSize),this.detailSize=n(e.detailSize),this.smoothness=n(e.smoothness),this.cloudHeight=n(e.cloudHeight),this.raymarchingSteps=e.raymarchingSteps}setDirty(){this._dirty=this.running=!0}runTask(e){0===this._faceIndex&&0===this._tileIndex&&(this._passParameters.raymarchingSteps=this.raymarchingSteps,this.updateWeatherTile(),(0,Xe.JG)(this._passParameters.weatherTile,this._weatherTile));const t=this._getTechnique(this._passParameters.raymarchingSteps);if(!t.compiled)return Gt.J;if(this.context.renderContext.bindParameters.cloudsFade.fadeMode===Ot.lL.CROSS_FADE||!this._ensureNoiseTexture())return Gt.J;0===this._faceIndex&&0===this._tileIndex&&(this.context.renderContext.bindParameters.cloudsFade.renderingStage=Tt.jL.RENDERING,this._passParameters.absorption=this.absorption,this._passParameters.density=this.density,this._passParameters.cloudSize=this.cloudSize,this._passParameters.detailSize=this.detailSize,this._passParameters.smoothness=this.smoothness,this._passParameters.cloudHeight=this.cloudHeight,this._passParameters.coverage=this.coverage,this._dirty=!1);const i=Zt[this._faceIndex],n=jt[this._faceIndex];(0,Pt.ji)(this._viewMatrix,Wt,i,n),(0,St.xO)(this._passParameters.viewMatrix,this._viewMatrix);const r=this.context.renderContext.rctx,s=r.bindTechnique(t,this._bindParameters,this._passParameters);r.bindVAO(this._vao),s.assertCompatibleVertexAttributeLocations(this._vao);const a=r.getViewport(),o=t.configuration.cubeMapSize,l=o/this._tilesPerFace,h=this._tileIndex*l;r.setViewport(0,h,o,l);const c=this._ensureFrameBufferCube(o);r.bindFramebuffer(c);const d=st.No.TEXTURE_CUBE_MAP_POSITIVE_X+this._faceIndex;return c.setColorTextureTarget(d),r.gl.drawArrays(r.gl.TRIANGLE_STRIP,0,4),r.gl.flush(),r.setViewport(a.x,a.y,a.width,a.height),this.requestRender(),++this._tileIndex,4===this._faceIndex&&this._tileIndex===this._tilesPerFace?(this.running=this._dirty,this._faceIndex=0,this._tileIndex=0,this.running||(this.context.renderContext.bindParameters.cloudsFade.renderingStage=Tt.jL.FADING)):this._tileIndex===this._tilesPerFace&&(++this._faceIndex,this._tileIndex=0),e.madeProgress(),Gt.J}};(0,n._)([(0,b.Cb)({constructOnly:!0})],kt.prototype,"context",void 0),(0,n._)([(0,b.Cb)({constructOnly:!0})],kt.prototype,"view",void 0),(0,n._)([(0,b.Cb)({constructOnly:!0})],kt.prototype,"requestRender",void 0),(0,n._)([(0,b.Cb)()],kt.prototype,"coverage",void 0),(0,n._)([(0,b.Cb)()],kt.prototype,"density",void 0),(0,n._)([(0,b.Cb)()],kt.prototype,"absorption",void 0),(0,n._)([(0,b.Cb)()],kt.prototype,"cloudSize",void 0),(0,n._)([(0,b.Cb)()],kt.prototype,"detailSize",void 0),(0,n._)([(0,b.Cb)()],kt.prototype,"smoothness",void 0),(0,n._)([(0,b.Cb)()],kt.prototype,"cloudHeight",void 0),(0,n._)([(0,b.Cb)()],kt.prototype,"raymarchingSteps",void 0),(0,n._)([(0,b.Cb)()],kt.prototype,"running",void 0),kt=(0,n._)([(0,C.j)("esri.views.3d.environment.CloudsGenerator")],kt);const Zt=[(0,Rt.al)(1,0,0),(0,Rt.al)(-1,0,0),(0,Rt.al)(0,1,0),(0,Rt.al)(0,-1,0),(0,Rt.al)(0,0,1)],jt=[(0,Rt.al)(0,1,0),(0,Rt.al)(0,1,0),(0,Rt.al)(0,0,-1),(0,Rt.al)(0,0,1),(0,Rt.al)(0,1,0)],Wt=(0,Rt.ll)();var Xt=i(43223);class Qt extends it.A{constructor(e){super(e,new ht.m,(()=>this.destroy()))}initializeProgram(e){return new rt.$(e.rctx,Qt.shader.get().build(),nt.i)}initializePipeline(){return(0,at.sm)({blending:(0,at.wK)(st.zi.SRC_ALPHA,st.zi.ZERO,st.zi.ONE_MINUS_SRC_ALPHA,st.zi.ONE),colorWrite:at.BK})}}Qt.shader=new tt.J(Xt.a,(()=>i.e(34991).then(i.bind(i,34991))));var Yt=i(50902);let Jt=class extends T.default{constructor(e){super(e),this._passParameters=new Xt.F;const t=e.context.renderContext.rctx;this._vao=(0,_t.o)(t,pt.Bn),this._technique=new Qt(e);const i=(0,Ze.Iu)(e.view.spatialReference);this._planetRadius=i.radius,this._atmosphereRadius=i.radius+Je.k8}destroy(){this._technique.release(),this._vao.dispose()}set strength(e){this._passParameters.fogStrength=e}get strength(){return this._passParameters.fogStrength}render(e,t){if(this._update(e,t),this._passParameters.fogAmount<=0)return;const i=this._technique;if(!i.compiled)return void this.context.requestRender();const n=e.offscreenRenderingHelper;n.renderDepthDetached((()=>{this._passParameters.depthTexture=n.depthTexture;const t=e.rctx.bindTechnique(i,e.bindParameters,this._passParameters);this._renderFog(t,e)}))}_renderFog(e,t){const i=t.rctx;i.bindVAO(this._vao),e.assertCompatibleVertexAttributeLocations(this._vao),i.drawArrays(st.MX.TRIANGLE_STRIP,0,4)}_update(e,t){const i=e.bindParameters.camera;(0,Ge.n)($t,i.eye);const n=Math.max(0,(0,Ge.m)($t,e.bindParameters.lighting.mainLight.direction)),r=t.color;(0,Ge.j)(ei,r,.1),(0,Ge.o)(this._passParameters.fogColor,ei,r,n);const s=(0,Ge.l)(i.eye),a=s*s;this._passParameters.atmosphereC=a-this._atmosphereRadius*this._atmosphereRadius,this._passParameters.fogAmount=(1-(0,me.CW)(.95*Yt.nq,1*Yt.nq,Math.abs(s-this._planetRadius)))*t.amount,this._passParameters.fogStrength=t.strength}};(0,n._)([(0,b.Cb)({constructOnly:!0})],Jt.prototype,"context",void 0),(0,n._)([(0,b.Cb)({constructOnly:!0})],Jt.prototype,"view",void 0),(0,n._)([(0,b.Cb)({constructOnly:!0})],Jt.prototype,"rctx",void 0),(0,n._)([(0,b.Cb)({constructOnly:!0})],Jt.prototype,"viewingMode",void 0),Jt=(0,n._)([(0,C.j)("esri.views.3d.environment.Fog")],Jt);class Kt{constructor(){this.color=(0,R.Ue)(),this.strength=0,this.amount=0}}const $t=(0,R.Ue)(),ei=(0,R.Ue)();var ti=i(92014),ii=i(69362);class ni extends it.A{initializeProgram(e){return new rt.$(e.rctx,ni.shader.get().build(this.configuration),nt.i)}initializePipeline(){return this.configuration.geometry===ii.n.Cylinder?(0,at.sm)({blending:(0,at.wK)(st.zi.SRC_ALPHA,st.zi.ONE,st.zi.ONE_MINUS_SRC_ALPHA,st.zi.ONE_MINUS_SRC_ALPHA),culling:at.Rd,depthTest:{func:st.wb.LEQUAL},colorWrite:at.BK}):(0,at.sm)({blending:(0,at.wK)(st.zi.SRC_ALPHA,st.zi.ONE,st.zi.ONE_MINUS_SRC_ALPHA,st.zi.ONE_MINUS_SRC_ALPHA),depthTest:{func:st.wb.LEQUAL},colorWrite:at.BK})}}ni.shader=new tt.J(ti.a,(()=>i.e(35701).then(i.bind(i,35701))));const ri=new Uint8ClampedArray([0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,2,0,0,0,2,0,0,0,2,0,0,0,2,0,0,0,2,0,0,0,2,0,0,0,3,0,0,0,3,0,0,0,3,0,0,0,3,0,0,0,3,0,0,0,4,0,0,0,4,0,0,0,4,0,0,0,4,0,0,0,4,0,0,0,4,0,0,0,5,0,0,0,5,0,0,0,5,0,0,0,5,0,0,0,5,0,0,0,6,0,0,0,6,0,0,0,6,0,0,0,6,0,0,0,6,0,0,0,7,0,0,0,7,0,0,0,7,0,0,0,7,0,0,0,7,0,0,0,8,0,0,0,8,0,0,0,8,0,0,0,8,0,0,0,8,0,0,0,9,0,0,0,9,0,0,0,9,0,0,0,9,0,0,0,9,0,0,0,10,0,0,0,10,0,0,0,10,0,0,0,10,0,0,0,11,0,0,0,11,0,0,0,11,0,0,0,11,0,0,0,11,0,0,0,12,0,0,0,12,0,0,0,12,0,0,0,12,0,0,0,13,0,0,0,13,0,0,0,13,0,0,0,13,0,0,0,14,0,0,0,14,0,0,0,14,0,0,0,14,0,0,0,15,0,0,0,15,0,0,0,15,0,0,0,15,0,0,0,15,16,0,0,16,16,0,0,16,16,0,0,16,16,0,0,16,15,0,0,17,15,0,0,17,15,0,0,17,15,0,0,17,14,0,0,18,14,0,0,18,14,0,0,18,13,0,0,19,13,0,0,19,13,0,0,19,13,0,0,19,13,0,0,20,13,0,0,20,13,0,0,20,13,0,0,20,12,0,0,21,12,0,0,21,12,0,0,21,12,0,0,21,12,0,0,22,12,0,0,22,12,0,0,22,12,0,0,22,11,0,0,23,11,0,0,23,11,0,0,23,11,0,0,24,11,0,0,24,11,0,0,24,11,0,0,24,10,0,0,25,10,0,0,25,10,0,0,25,10,0,0,26,10,0,0,26,10,0,0,26,10,0,0,26,9,0,0,27,9,0,0,27,9,0,0,27,18,0,0,28,18,0,0,28,18,0,0,28,18,0,0,28,18,0,0,29,18,0,0,29,18,0,0,29,17,0,0,30,17,0,0,30,17,0,0,30,17,0,0,30,16,0,0,31,16,0,0,31,16,0,0,31,16,0,0,32,16,0,0,32,16,0,0,32,15,0,0,33,15,0,0,33,15,0,0,33,15,0,0,34,15,8,0,34,15,8,0,34,15,8,0,34,15,7,0,35,15,7,0,35,15,7,0,35,21,7,0,36,21,7,0,36,21,7,0,36,21,7,0,37,21,7,0,37,21,7,0,37,20,7,0,38,20,7,0,38,20,7,0,38,20,7,0,39,20,7,0,39,20,7,0,39,20,7,0,39,19,6,0,40,19,6,0,40,19,6,0,40,19,6,0,41,19,6,0,41,19,6,0,41,18,6,0,42,18,6,0,42,18,6,0,42,24,6,0,43,24,6,0,43,24,6,0,43,23,6,0,44,23,6,0,44,23,6,0,44,23,6,0,45,23,6,0,45,23,6,0,45,22,6,0,46,22,6,0,46,22,6,0,46,22,5,0,47,22,5,0,47,22,5,0,47,21,5,0,48,21,5,0,48,21,5,0,48,21,5,0,49,21,5,0,49,26,5,0,49,25,5,0,50,25,5,0,50,25,5,0,50,25,5,0,51,25,5,0,51,25,5,0,51,25,5,0,52,25,5,0,52,25,5,0,52,24,5,0,53,24,5,0,53,24,5,0,53,24,9,0,54,28,9,0,54,28,9,0,54,28,9,0,55,28,9,0,55,27,9,0,56,27,9,0,56,27,9,0,56,27,9,4,57,27,9,4,57,27,9,4,57,26,9,4,58,26,9,4,58,26,9,4,58,26,9,4,59,26,9,4,59,26,9,4,59,26,8,4,60,30,8,4,60,30,8,4,60,29,8,4,61,29,8,4,61,29,8,4,62,29,8,4,62,29,8,4,62,28,8,4,63,28,8,4,63,28,8,4,63,28,12,4,64,28,12,4,64,28,12,4,64,27,12,4,65,27,12,8,65,27,12,8,65,31,12,8,66,31,12,8,66,30,11,8,67,30,11,8,67,30,11,8,67,30,11,8,68,30,11,8,68,30,11,8,68,30,15,7,69,30,15,7,69,30,15,7,69,33,15,11,70,33,15,11,70,32,14,11,71,32,14,11,71,32,14,11,71,32,18,14,72,32,18,14,72,32,18,14,72,31,17,14,73,35,17,14,73,34,17,17,74,34,21,17,74,34,21,17,74,34,20,17,75,34,20,20,75,34,20,20,75,34,23,20,76,34,23,20,76,36,23,23,77,36,23,23,77,36,23,23,77,36,23,23,78,36,26,26,78,36,26,26,78,36,26,26,79,36,26,29,79,38,26,29,80,38,29,29,80,38,29,29,80,38,28,31,81,38,28,31,81,38,31,31,81,37,31,34,82,37,31,34,82,37,31,37,83,40,34,37,83,40,34,37,83,39,33,39,84,39,33,39,84,39,36,42,84,39,36,42,85,39,36,42,85,39,36,42,85,39,39,44,86,39,39,44,86,41,38,47,87,41,41,47,87,41,41,50,87,41,41,49,88,41,41,52,88,40,43,52,89,43,43,52,89,43,43,54,89,42,45,54,90,42,45,57,90,42,45,57,90,42,45,59,91,42,48,59,91,44,47,61,92,44,47,61,92,44,50,61,92,44,49,63,93,44,49,63,93,44,52,66,93,43,52,65,94,46,54,68,94,46,54,70,95,46,54,70,95,46,54,70,95,45,56,72,96,45,56,72,96,45,58,74,97,47,58,76,97,47,58,76,97,47,60,78,98,47,60,78,98,47,60,81,98,49,62,80,99,49,62,82,99,48,61,84,100,48,64,84,100,48,64,84,100,50,63,86,101,50,66,86,101,50,66,88,101,50,65,90,102,52,67,89,103,51,69,91,104,51,68,92,105,52,69,93,107,52,71,94,108,54,70,96,109,53,71,96,111,52,73,98,112,54,72,98,114,53,73,100,115,54,72,100,117,54,73,102,118,55,74,104,120,55,76,105,121,56,77,106,123,56,76,107,124,57,79,107,126,58,78,110,128,57,79,111,129,56,80,113,131,58,79,112,132,57,82,114,134,58,81,116,136,60,82,117,137,59,83,117,139,60,83,119,141,59,84,120,142,60,85,122,144,59,86,122,146,60,86,126,148,62,87,127,149,61,88,127,151,62,88,128,153,63,89,130,155,62,90,131,156,63,90,132,158,64,91,134,160,65,91,135,162,64,92,136,163,63,93,138,165,66,95,139,167,65,95,140,169,66,95,142,171,67,96,142,172,66,97,144,174,67,99,145,176,67,97,148,178,67,99,147,180,68,100,149,181,68,100,150,183,69,101,152,185,70,102,153,187,71,103,155,188,70,103,156,190,70,104,157,192,71,105,158,194,71,106,160,195,72,106,161,197,72,108,161,199,73,108,163,200,73,109,164,202,74,109,165,204,74,110,167,206,75,111,168,207,74,112,170,209,75,112,170,210,76,113,171,212,76,114,173,214,77,115,174,215,78,115,175,217,78,116,175,218,78,117,177,220,78,118,178,221,79,118,180,223,80,120,180,224,81,120,181,226,81,120,182,227,82,121,184,229,82,122,185,230,84,123,186,232,83,123,187,233,84,124,189,234,84,125,188,235,85,126,189,237,86,126,190,238,86,127,191,239,87,127,192,240,87,129,193,242,88,129,194,243,89,130,195,244,90,131,196,245,90,132,197,246,91,132,197,247,92,133,198,248,92,134,199,249,93,135,200,250,94,136,201,251,95,137,202,252,96,138,203,253,97,140,204,254,98,141,205,254,99,142,206,255,101,143,207,255,102,144,208,255,103,146,209,255,104,147,209,255,106,148,210,255,107,149,211,255,108,151,212,255,110,152,213,255,111,153,213,255,112,154,214,255,114,156,215,255,115,157,215,255,117,158,216,255,118,160,217,255,120,161,217,255,121,162,218,255,123,164,218,255,124,165,219,255,125,166,219,255,127,167,220,255,129,169,220,255,130,170,221,255,132,171,221,255,133,173,222,255,134,174,222,255,136,175,223,255,139,178,224,255,142,180,224,255,144,182,225,255,147,185,226,255,150,187,226,255,153,189,227,255,155,191,228,255,158,194,228,255,160,196,229,255,163,198,229,255,165,200,230,255,168,202,231,255,170,203,231,255,172,205,232,255,174,207,232,255,176,209,233,255,178,210,234,255,180,212,234,255,182,214,235,255,184,215,236,255,186,217,237,255,188,219,238,255,190,220,238,255,192,221,239,255,193,222,240,255,194,224,240,255,196,225,241,255,197,226,241,255,198,226,242,255,199,227,242,255,200,228,242,255,201,228,243,255,202,229,243,255,203,230,243,255,204,230,244,255,205,231,244,255,207,232,244,255,208,233,245,255,209,233,245,255,211,234,246,255,213,235,246,255,217,238,247,255,222,240,248,255,226,242,249,255,231,245,250,255,236,247,251,255,241,249,252,255,245,251,253,255,249,252,254,255,255,255,255,255]);var si=i(50256),ai=i(55158),oi=i(70619),li=i(80658),hi=i(4760),ci=i(44070),di=i(57808),ui=i(3384);class pi{constructor(e,t){this.type=ze.Local,this._configuration=new ii.f,this._passParameters=new ti.S,this._configuration.geometry=ii.n.Cylinder,this._technique=t.techniques.acquire(ni,this._configuration);const i=t.renderContext.rctx;this._vao=function(e){const t=(0,oi.xu)(1,2,!1),{data:i,indices:n}=t[0][1],r=mi.createBuffer(n.length),s=r.position;for(let a=0;a<n.length;++a){const e=3*n[a%3==0?a+2:a%3==2?a-2:a];s.set(a,0,i[e]),s.set(a,1,i[e+1]),s.set(a,2,i[e+2])}return new li.U(e,nt.i,{geometry:(0,si.K)(mi)},{geometry:ci.f.createVertex(e,st.l1.STATIC_DRAW,r.buffer)})}(i),this._vaoCount=(0,ui._V)(this._vao,"geometry");const n=new Vt.X;n.wrapMode=st.e8.CLAMP_TO_EDGE,n.flipped=!0,n.width=1,n.height=512,this._passParameters.texture=new di.x(i,n,ri)}destroy(){this._passParameters.texture=(0,p.M2)(this._passParameters.texture),this._vao.dispose(),this._technique.release()}render(e){const t=e.rctx,i=t.bindTechnique(this._technique,e.bindParameters,this._passParameters);(function(e,t){(0,Pt.JG)(e,t),e[12]=0,e[13]=0,e[14]=0,e[15]=1})(_i,e.bindParameters.camera.viewMatrix),i.setUniformMatrix4fv("view",_i),t.bindVAO(this._vao),i.assertCompatibleVertexAttributeLocations(this._vao),t.drawArrays(st.MX.TRIANGLES,0,this._vaoCount)}renderHaze(){return!1}}const _i=(0,Mt.Ue)(),mi=(0,ai.U$)().vec3f(hi.T.POSITION);var gi=i(38461);const fi=new Uint8ClampedArray([0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,2,0,0,0,2,0,0,0,2,0,0,0,2,0,0,0,3,0,0,0,3,0,0,0,3,0,0,0,4,0,0,0,4,0,0,0,4,0,0,0,5,0,0,0,5,0,0,0,5,0,0,0,5,0,0,0,5,0,0,0,5,0,0,0,5,0,0,0,6,0,0,0,6,0,0,0,7,0,0,0,7,0,0,0,7,0,0,0,8,0,0,0,8,0,0,0,8,0,0,0,9,0,0,0,9,0,0,0,9,0,0,0,10,0,0,0,10,0,0,0,11,0,0,0,11,0,0,0,11,0,0,0,12,0,0,0,12,0,0,0,12,0,0,0,13,0,0,0,13,0,0,0,14,0,0,0,14,0,0,0,14,0,0,0,14,0,0,0,14,0,0,0,15,0,0,0,15,0,0,0,16,0,0,0,16,0,0,0,16,0,0,0,17,0,0,0,17,0,0,0,18,0,0,0,18,0,0,0,19,0,0,0,19,0,0,0,19,0,0,0,20,0,0,0,20,0,0,0,21,0,0,0,21,0,0,0,22,0,0,0,22,11,0,0,23,11,0,0,23,11,0,0,23,11,0,0,23,11,0,0,24,11,0,0,24,11,0,0,24,10,0,0,25,10,0,0,25,10,0,0,26,10,0,0,26,9,0,0,27,9,0,0,27,9,0,0,28,9,0,0,28,9,0,0,29,9,0,0,29,8,0,0,30,8,0,0,30,8,0,0,31,8,0,0,31,8,0,0,32,8,0,0,32,8,0,0,32,8,0,0,32,8,0,0,33,8,0,0,33,8,0,0,34,7,0,0,35,7,0,0,35,7,0,0,36,7,0,0,36,7,7,0,37,7,7,0,37,7,7,0,38,7,7,0,38,13,7,0,39,13,7,0,39,13,6,0,40,13,6,0,40,12,6,0,41,12,6,0,41,12,6,0,41,12,6,0,42,12,6,0,42,12,6,0,43,12,6,0,43,12,6,0,44,12,6,0,44,11,6,0,45,11,6,6,45,11,6,6,46,11,5,5,47,11,5,5,47,11,5,5,48,11,5,5,48,10,5,5,49,10,5,5,49,10,5,5,50,15,5,5,51,15,5,5,51,15,5,5,51,15,5,5,51,15,5,5,52,15,5,5,52,14,5,5,53,14,5,5,54,14,5,5,54,14,5,5,55,14,5,5,55,14,5,5,56,13,4,4,57,13,4,4,57,13,4,4,58,13,4,4,58,13,4,4,59,13,4,4,59,17,4,4,60,17,4,4,60,17,4,4,60,17,4,4,61,17,4,4,61,16,4,4,62,16,4,4,63,16,4,4,63,16,8,4,64,16,8,4,64,16,8,4,65,15,8,4,66,15,8,4,66,15,8,4,67,19,8,4,68,19,8,4,68,18,7,4,69,18,7,4,69,18,7,4,69,18,7,4,70,18,7,4,70,18,7,4,71,18,7,4,71,18,7,4,72,17,7,3,73,17,7,3,73,21,7,3,74,21,7,3,74,20,7,3,75,20,7,3,76,20,7,3,76,20,7,3,77,20,7,3,77,20,7,3,78,20,7,3,78,20,7,7,78,19,6,6,79,19,10,6,80,19,10,6,80,22,9,6,81,22,9,6,81,22,9,6,82,22,9,6,83,22,9,6,83,21,9,6,84,21,9,6,84,21,9,6,85,21,9,6,86,21,9,6,86,23,9,6,87,23,9,6,87,23,9,6,87,23,9,6,88,23,9,6,88,23,9,6,89,23,8,6,90,23,8,6,90,22,8,6,91,22,8,6,91,25,8,6,92,25,8,5,93,25,8,5,93,24,8,5,94,24,8,5,94,24,11,5,95,24,11,5,96,24,11,5,96,26,11,5,97,26,11,5,97,26,11,5,97,26,10,5,98,26,10,5,98,26,10,5,99,25,10,5,100,25,10,5,100,25,10,5,101,25,10,5,101,25,10,5,102,27,10,5,103,27,10,5,103,27,10,5,104,27,10,5,104,27,12,5,105,26,12,5,106,26,12,5,106,29,12,5,106,29,12,5,106,29,12,7,107,28,12,7,108,28,12,7,108,28,12,7,109,28,12,7,109,30,12,7,110,30,11,7,111,30,11,7,111,30,11,7,112,30,11,7,112,29,11,7,113,29,11,7,114,29,11,7,114,31,11,7,115,31,11,7,115,31,11,7,115,31,11,7,116,31,11,7,116,33,13,7,117,33,13,9,117,32,13,9,118,32,13,9,118,32,13,9,119,34,15,8,120,34,15,8,120,34,15,8,121,36,15,8,121,36,15,8,122,36,15,8,122,35,15,8,123,37,14,8,124,37,14,8,124,37,14,8,124,37,14,8,124,39,14,8,125,39,16,8,125,38,16,8,126,38,16,8,127,38,16,8,127,40,16,10,128,40,16,10,128,40,16,10,129,42,18,10,129,41,18,10,130,41,18,10,130,43,18,10,131,43,18,10,131,42,17,10,132,42,17,12,132,42,17,12,133,44,17,12,133,44,17,12,133,46,17,11,134,46,17,11,134,45,19,11,135,45,19,11,135,47,19,11,136,47,19,11,136,47,19,11,137,47,19,11,137,48,20,11,138,48,20,11,138,50,20,13,139,50,20,13,139,49,20,13,140,49,22,13,140,51,22,13,141,51,22,13,141,50,22,13,142,52,22,13,142,52,21,12,143,53,21,12,143,53,21,12,143,53,21,12,143,53,21,14,144,53,23,14,144,55,23,14,145,55,23,14,145,56,23,14,146,56,23,14,146,57,24,14,147,57,24,14,147,59,24,16,148,59,24,16,148,58,24,15,149,58,26,15,149,58,26,15,149,60,26,15,150,60,26,15,150,61,25,15,151,61,25,15,151,62,25,17,152,62,25,17,152,64,25,17,152,64,27,17,152,63,27,17,153,63,27,17,153,65,27,17,153,66,28,17,154,66,28,17,154,67,28,16,155,67,28,16,155,67,30,16,155,69,29,18,156,69,29,18,156,68,29,18,157,70,29,18,157,70,29,18,157,71,31,18,158,71,31,18,158,72,30,19,159,72,30,19,159,74,30,19,159,73,30,19,160,73,32,19,160,74,32,19,161,74,32,21,161,76,32,21,161,78,33,21,161,78,33,21,161,79,35,20,162,78,34,20,163,79,34,22,164,81,36,22,164,82,36,22,165,81,35,22,166,82,37,21,167,84,37,21,167,85,36,21,168,86,38,23,169,88,38,23,169,88,38,23,170,88,39,23,170,89,39,24,171,91,40,24,171,92,40,24,172,93,40,24,173,94,41,25,173,95,41,25,174,96,42,25,175,98,42,25,175,99,43,26,176,99,43,26,177,101,45,26,177,102,44,26,178,103,46,27,179,104,46,27,179,105,46,27,179,106,45,28,180,108,47,28,180,108,46,28,181,109,48,28,182,111,48,29,182,111,49,29,183,114,49,29,184,114,50,30,184,114,50,30,185,116,51,30,185,117,51,30,186,119,52,31,187,119,53,31,187,121,53,31,188,122,54,33,188,123,54,32,189,124,55,32,189,125,55,32,189,126,56,34,190,128,56,34,190,128,57,33,191,130,57,33,191,131,58,35,192,131,58,35,192,133,59,34,193,134,60,35,194,135,60,35,194,136,61,37,195,139,61,37,195,139,62,36,196,141,62,36,196,141,63,38,197,142,63,38,197,143,64,39,198,144,64,39,198,146,66,39,198,146,67,39,198,147,67,38,199,147,68,40,199,149,68,40,200,150,69,40,200,152,70,41,201,154,71,41,201,154,71,42,202,155,72,42,202,156,73,41,203,157,73,43,203,158,74,42,204,160,75,44,204,161,76,44,204,162,77,44,205,164,77,45,205,165,78,45,206,166,79,45,206,168,80,46,207,169,81,46,207,170,83,47,207,171,83,47,207,172,83,47,207,174,85,48,208,175,85,48,208,177,85,48,209,178,87,49,209,180,87,49,210,181,87,49,210,182,89,50,210,182,89,50,211,185,91,50,211,186,91,51,212,186,93,51,212,189,94,52,212,190,95,51,213,192,96,51,213,193,96,53,213,194,97,52,214,195,98,54,214,197,98,55,215,198,100,55,215,199,101,55,215,200,102,55,216,202,103,55,216,203,104,55,216,204,105,57,216,205,106,57,216,207,107,58,216,208,108,58,217,209,109,59,217,210,110,60,217,211,111,60,218,212,112,61,218,213,113,61,218,214,114,62,219,217,115,63,219,217,116,64,219,218,118,64,220,219,119,65,220,220,121,66,220,222,121,67,221,222,122,67,221,222,123,68,221,223,124,69,222,224,125,70,222,225,127,71,222,226,128,72,223,228,129,73,223,228,130,74,223,229,132,75,223,230,135,79,224,231,138,81,224,233,141,84,224,233,144,87,225,235,147,91,225,236,150,94,225,237,154,97,225,238,158,102,225,239,161,107,225,239,165,110,225,240,168,114,226,241,172,118,226,241,176,122,226,241,181,126,226,242,183,130,227,243,186,135,227,243,190,139,227,244,194,143,227,244,197,147,228,244,200,150,228,245,204,154,228,245,207,157,228,245,210,161,229,246,212,164,229,246,215,167,229,246,217,169,229,246,220,172,230,247,221,174,230]);var vi=i(97731);const yi=128,bi=-Je.Tk,wi=(0,fe.uV)([[50,.1015625],[500,.21875],[5e3,1-250/512],[5e4,.4140625]]);class Ci{constructor(e,t){this.view=e,this.type=ze.Mars,this._passParameters=new ti.S,this._vaoCount=0,this._texV1=1;const i=(0,Ze.Iu)(e.spatialReference);this._planetRadius=i.radius,this._outerRimWidth=i.outerAtmosphereRimWidth,this._innerRimFactor=(this._planetRadius+bi)/this._planetRadius,this._middleRimFactor=(this._planetRadius+0)/this._planetRadius,this._outerRimFactor=(this._planetRadius+this._outerRimWidth)/this._planetRadius,this._texV0=0/this._outerRimWidth,this._texVScale=this._texV1-this._texV0,this._techniques=t.techniques;const n=t.renderContext.rctx;this._cameraChangeHandle=(0,g.watch)((()=>{var e;return null===(e=this.view.state)||void 0===e?void 0:e.camera}),(()=>t.requestRender()),g.syncAndInitial),this._vao=this._createRibbon(n),this._vaoCount=(0,ui._V)(this._vao,"geometry"),this._fadeVao=(0,_t.o)(n),this._fadeVaoCount=(0,ui._V)(this._fadeVao,"geometry");const r=new Vt.X;r.wrapMode=st.e8.CLAMP_TO_EDGE,r.flipped=!0,r.width=1,r.height=512,this._passParameters.texture=new di.x(n,r,fi);const s=new ii.f;s.geometry=ii.n.Cone,this._coneTechnique=this._techniques.acquire(ni,s),s.geometry=ii.n.Underground,this._undergroundTechnique=this._techniques.acquire(ni,s)}destroy(){this._coneTechnique.release(),this._undergroundTechnique.release(),this._cameraChangeHandle.remove(),this._passParameters.texture=(0,p.M2)(this._passParameters.texture),this._fadeVao.dispose(),this._vao.dispose()}render(e){const t=e.bindParameters.camera;this._update(t);const i=e.rctx;this._passParameters.undergroundFadeAlpha<1&&(i.bindTechnique(this._coneTechnique,e.bindParameters,this._passParameters),i.bindVAO(this._vao),i.drawArrays(st.MX.TRIANGLES,0,this._vaoCount)),this._passParameters.undergroundFadeAlpha>0&&(i.bindTechnique(this._undergroundTechnique,e.bindParameters,this._passParameters),i.bindVAO(this._fadeVao),i.drawArrays(st.MX.TRIANGLE_STRIP,0,this._fadeVaoCount))}renderHaze(){}_update(e){const t=(0,R.Ue)(),i=this._planetRadius,n=(0,Ge.l)(e.eye),r=n-i;if(r<0){const e=Math.min(-r/5e3,1);this._passParameters.undergroundFadeAlpha=e}else this._passParameters.undergroundFadeAlpha=0;const s=Math.max(50,r),a=i+bi;this._passParameters.innerScale=function(e,t,i){return e*e/(Math.sqrt(e*e-t*t)*Math.sqrt(e*e-i*i)+t*i)}(i+s,i,a)-1,this._passParameters.altitudeFade=(0,Je.yx)(r),(0,Ge.j)(t,e.eye,(i+50)/n),xi(t,e.center,e.up,i,this._passParameters.silhouette);const o=this._computeScreenRimWidth(e,t,e.up,this._passParameters.silhouette),l=1-511/512,h=wi(r);let c=this._texV0+l*this._texVScale,d=this._texV0+o*h*this._texVScale;if(r>50){xi(e.eye,e.center,e.up,i,this._passParameters.silhouette);const t=this._computeScreenRimWidth(e,e.eye,e.up,this._passParameters.silhouette),n=(0,me.uZ)((t-1.5)/(o-1.5),0,1);c=this._texV0+n*l*this._texVScale,d=this._texV0+(0,me.t7)(this._texV1,o*h,n)*this._texVScale}(0,Xe.t8)(this._passParameters.texV,c,d)}_createRibbon(e){const t=(0,gi.xx)(1155),i=new Uint32Array(1920);t[0]=0,t[1]=0,t[2]=-1;for(let s=0;s<yi;s++){const e=9*s+3;t[e]=s,t[e+1]=this._innerRimFactor,t[e+2]=-1,t[e+3]=s,t[e+4]=this._middleRimFactor,t[e+5]=0,t[e+6]=s,t[e+7]=this._outerRimFactor,t[e+8]=1;const n=3*s+1,r=127===s?1:n+3,a=15*s;i[a]=n,i[a+1]=n+1,i[a+2]=r+1,i[a+3]=r+1,i[a+4]=r,i[a+5]=n,i[a+6]=n+1,i[a+7]=n+2,i[a+8]=r+2,i[a+9]=r+2,i[a+10]=r+1,i[a+11]=n+1,i[a+12]=n,i[a+13]=r,i[a+14]=0}const n=Mi.createBuffer(i.length),r=n.position;for(let s=0;s<i.length;++s){const e=3*i[s];r.set(s,0,t[e]),r.set(s,1,t[e+1]),r.set(s,2,t[e+2])}return new li.U(e,nt.i,{geometry:(0,si.K)(Mi)},{geometry:ci.f.createVertex(e,st.l1.STATIC_DRAW,n.buffer)})}_computeScreenRimWidth(e,t,i,n){return(0,Ge.g)(Si,n.center,n.v2),(0,Ge.j)(Pi,Si,this._outerRimFactor),(0,Pt.zB)(Ti,t,Si,i),(0,vi.iV)(Si,Ti,e.projectionMatrix,e.viewport,Si),(0,vi.iV)(Pi,Ti,e.projectionMatrix,e.viewport,Pi),(0,Ge.p)(Si,Pi)/e.height}}function xi(e,t,i,n,r){const s=(0,Ge.l)(e),a=n*Math.sqrt(s*s-n*n)/s,o=Math.sqrt(n*n-a*a),l=r.v1,h=r.v2;return(0,Ge.j)(r.center,e,o/s),(0,Ge.b)(l,e,t),(0,Ge.q)(l)<1&&(0,Ge.b)(l,e,i),(0,Ge.j)(l,l,a/(0,Ge.l)(l)),(0,Ge.b)(h,l,e),(0,Ge.j)(h,h,a/(0,Ge.l)(h)),a}const Ti=(0,Mt.Ue)(),Si=(0,R.Ue)(),Pi=(0,R.Ue)();const Mi=(0,ai.U$)().vec3f(hi.T.POSITION);var Ri=i(38499),Ai=i(19159);class Oi extends et.K{constructor(){super(...arguments),this.time=0,this.radius=1,this.width=500,this.opacity=1}}class Ei extends it.A{initializeProgram(e){return new rt.$(e.rctx,Ei.shader.get().build(this.configuration),Di)}initializePipeline(){return(0,at.sm)({blending:(0,at.wK)(st.zi.ONE,st.zi.ONE,st.zi.ONE_MINUS_SRC_ALPHA,st.zi.ONE_MINUS_SRC_ALPHA),depthTest:{func:st.wb.LEQUAL},colorWrite:at.BK})}}Ei.shader=new tt.J(Ai.P,(()=>i.e(79090).then(i.bind(i,79090))));const Di=new Map([[hi.T.POSITION,0],[hi.T.INSTANCEFEATUREATTRIBUTE,1]]);var Ii=i(96916),Li=i(96856);let Ni=class extends T.default{constructor(e){super(e),this._numParticles=25e4,this._rainSpeed=.1,this._snowSpeed=.01,this._passParameters=new Oi,this._animation=new Li.d,this._passParameters.time=0,this._passParameters.radius=(0,Ze.Iu)(e.view.spatialReference).radius,this._techniques=e.context.techniques}destroy(){this._numParticles=0,this._snowTechniqueCached=(0,p.RY)(this._snowTechniqueCached),this._rainTechniqueCached=(0,p.RY)(this._rainTechniqueCached),this._vao=(0,p.M2)(this._vao),this._instanceIdBuffer=(0,p.M2)(this._instanceIdBuffer)}get _rainTechnique(){if(null==this._rainTechniqueCached){const e=new Ii.Y;e.type=Ii.H.Rain,this._rainTechniqueCached=this._techniques.acquire(Ei,e)}return this._rainTechniqueCached}get _snowTechnique(){if(null==this._snowTechniqueCached){const e=new Ii.Y;e.type=Ii.H.Snow,this._snowTechniqueCached=this._techniques.acquire(Ei,e)}return this._snowTechniqueCached}update(e){return this._animation.advance(e)}render(e,t,i){const n="rainy"===i?this._rainTechnique:this._snowTechnique;if(!n.compiled)return void this.context.requestRender();const r=e.rctx;if(this._ensureResources(r),null==n||null==this._vao||null==this._instanceIdBuffer)return;if(null!=e.bindParameters.cloudsFade.data&&(this._passParameters.opacity=e.bindParameters.cloudsFade.opacity),this._passParameters.opacity<=0)return;t=t<.5?(0,me.t7)(0,.35,2*t):(0,me.t7)(.35,1,2*(t-.5)),this._passParameters.time=("rainy"===i?this._rainSpeed:this._snowSpeed)*(0,Ri.D9)(this._animation.time)%1e5;const s=r.bindTechnique(n,e.bindParameters,this._passParameters);r.bindVAO(this._vao),s.assertCompatibleVertexAttributeLocations(this._vao),(0,ui.XP)(r,Di,this._instanceIdBuffer,Hi,0),r.drawArraysInstanced(st.MX.TRIANGLES,0,3,this._numParticles*t),(0,ui.UF)(r,Di,this._instanceIdBuffer,Hi)}_ensureResources(e){null==this._vao&&(this._vao=function(e){const t=new Float32Array([-1,0,1,1,0,-1,1,0,1]);return new li.U(e,Di,{geometry:(0,si.K)(Ui)},{geometry:ci.f.createVertex(e,st.l1.STATIC_DRAW,t)})}(e)),null==this._instanceIdBuffer&&(this._instanceIdBuffer=this._createInstanceIndices(e))}_createInstanceIndices(e){const t=[];for(let i=0;i<this._numParticles;i++)t.push(i);return ci.f.createVertex(e,st.l1.STATIC_DRAW,new Float32Array(t))}};(0,n._)([(0,b.Cb)({constructOnly:!0})],Ni.prototype,"context",void 0),(0,n._)([(0,b.Cb)({constructOnly:!0})],Ni.prototype,"view",void 0),Ni=(0,n._)([(0,C.j)("esri.views.3d.environment.Precipitation")],Ni);const Ui=(0,ai.U$)().vec3f(hi.T.POSITION),Hi=(0,si.K)((0,ai.U$)().f32(hi.T.INSTANCEFEATUREATTRIBUTE),1);var Fi=i(65905),Vi=i(46634),qi=i(96894);class zi extends et.K{constructor(){super(...arguments),this.modelMatrix=(0,Mt.Ue)()}}class Bi extends it.A{constructor(e){super(e,new ht.m,(()=>this.destroy()))}initializeProgram(e){return new rt.$(e.rctx,Bi.shader.get().build(),nt.i)}initializePipeline(){return(0,at.sm)({blending:(0,at.wK)(st.zi.SRC_ALPHA,st.zi.ONE,st.zi.ONE_MINUS_SRC_ALPHA,st.zi.ONE_MINUS_SRC_ALPHA),depthTest:{func:st.wb.LEQUAL},colorWrite:at.BK})}}Bi.shader=new tt.J(qi.S,(()=>i.e(98080).then(i.bind(i,98080))));let Gi=class extends T.default{get updating(){return this._updatingTracking.updating||this.loading}get loading(){return null!=this._loadDataTask&&!this._loadDataTask.finished}constructor(e){super(e),this._loadDataTask=null,this._numPoints=0,this._passParameters=new zi,this._updatingTracking=new Vi.R}initialize(){this._loadDataTask=this._createLoadDataTask()}destroy(){this._loadDataTask=(0,p.IM)(this._loadDataTask),this._updatingTracking.destroy(),this._numPoints=0,this._technique=(0,p.RY)(this._technique),this._vao=(0,p.M2)(this._vao),Ji=null}render(e){const{rctx:t}=e;if(this._ensureResources(t),null==this._technique||null==this._vao)return;if(!this._technique.compiled)return void this.requestRender();const i=t.bindTechnique(this._technique,e.bindParameters,this._passParameters);t.bindVAO(this._vao),i.assertCompatibleVertexAttributeLocations(this._vao),t.drawArrays(st.MX.POINTS,0,this._numPoints)}_ensureResources(e){if(null!=this._technique||null==Ji)return;this._technique=new Bi({rctx:e,viewingMode:this.view.state.viewingMode}),this._numPoints=Ji.byteLength/Qi;const t=new Float32Array(Ji,0,2*this._numPoints),i=new Uint8Array(Ji,2*this._numPoints*4,this._numPoints);this._vao=function(e,t,i,n){const r=Yi.createBuffer(n),s=r.position,a=r.color,o=r.size;for(let l=0;l<n;l++){const e=t[2*l],n=t[2*l+1];s.set(l,0,-Math.cos(e)*Math.sin(n)),s.set(l,1,-Math.sin(e)*Math.sin(n)),s.set(l,2,-Math.cos(n));const r=Zi(i[l]),h=ki(ji[r[1]]);a.set(l,0,255*h[0]),a.set(l,1,255*h[1]),a.set(l,2,255*h[2]),a.set(l,3,255),o.set(l,r[0])}return new li.U(e,nt.i,{geometry:(0,si.K)(Yi)},{geometry:ci.f.createVertex(e,st.l1.STATIC_DRAW,r.buffer)})}(e,t,i,this._numPoints),this._updatingTracking.add((()=>"virtual"!==this.view.environment.lighting.type?this.view.environment.lighting.date:null),(e=>this._update(e)),g.initial)}_update(e){if(!e)return;const t=(e.getHours()/12+e.getMinutes()/60*(2/24)+e.getSeconds()/60*(2/1440)-.9972222)%2,i=2*function(e){const t=e,i=new Date(e.getFullYear(),0,1,11,58,56);return(+t-+i)/(+new Date(e.getFullYear()+1,0,1,11,58,55)-+i)}(e),n=(0,Pt.JG)(this._passParameters.modelMatrix,Xi);(0,Pt.jI)(n,n,-i*Math.PI),(0,Pt.Jp)(n,Wi,n),(0,Pt.jI)(n,n,-t*Math.PI),this.requestRender()}_createLoadDataTask(){if(null!=Ji)return null;const e=(0,oe.vr)((async e=>{const{data:t}=await(0,Fi.b)("esri/views/3d/environment/resources/stars.wsv",{responseType:"array-buffer",signal:e});(function(e){if(!e)throw new l.Z("stars:no-data-received","Failed to create stars because star catalogue is missing");const t=e.byteLength/Qi;if(t%1!=0||t>5e4||t<5e3)throw new l.Z("stars:invalid-data","Failed to create stars because star catalogue data is invalid")})(t),Ji=t}));return e.promise.catch((e=>{(0,m.D_)(e)||u.Z.getLogger(this).error(e)})).then((()=>{this.destroyed||(this.requestRender(),this.notifyChange("updating"))})),e}};function ki(e){return[parseInt(e.substring(0,2),16),parseInt(e.substring(2,4),16),parseInt(e.substring(4,6),16)]}function Zi(e){return e>=192?[2.9,e-192]:e>=160?[2.5,e-160]:e>=128?[2,e-128]:e>=96?[1.5,e-96]:e>=64?[1,e-64]:e>=32?[.7,e-32]:[.4,e]}(0,n._)([(0,b.Cb)({constructOnly:!0})],Gi.prototype,"view",void 0),(0,n._)([(0,b.Cb)({constructOnly:!0})],Gi.prototype,"requestRender",void 0),(0,n._)([(0,b.Cb)({readOnly:!0})],Gi.prototype,"updating",null),(0,n._)([(0,b.Cb)()],Gi.prototype,"_loadDataTask",void 0),(0,n._)([(0,b.Cb)()],Gi.prototype,"_updatingTracking",void 0),Gi=(0,n._)([(0,C.j)("esri.views.3d.environment.Stars")],Gi);const ji=["9bb2ff","9eb5ff","aabfff","bbccff","ccd8ff ","dae2ff","e4e9ff","eeefff","f8f6ff","fff9fb","fff5ef","fff1e5","ffeddb","ffe9d2","ffe6ca","ffe3c3","ffe0bb","ffddb4","ffdaad","ffd6a5","ffd29c","ffcc8f","ffc178","ffa94b","ff7b00"],Wi=(0,Mt.al)(1,0,0,0,0,.9174771405229186,.39778850739794974,0,0,-.39778850739794974,.9174771405229186,0,0,0,0,1),Xi=(0,Mt.al)(1,0,0,0,0,.9174771405229186,-.39778850739794974,0,0,.39778850739794974,.9174771405229186,0,0,0,0,1),Qi=9,Yi=(0,ai.U$)().vec3f(hi.T.POSITION).vec4u8(hi.T.COLOR).f32(hi.T.SIZE);let Ji=null;var Ki,$i=i(70374),en=i(93822);!function(e){e[e.Immediate=0]="Immediate",e[e.Faded=1]="Faded"}(Ki||(Ki={}));let tn=class extends $i.tY{constructor(e){super(e),this.produces=new Map([[en.r.OPAQUE_ENVIRONMENT,()=>!(null===this._atmosphere&&null===this._stars)],[en.r.TRANSPARENT_ENVIRONMENT,()=>!(null===this._atmosphere)]]),this._context=null,this._atmosphere=null,this._oldWeatherParameters=new nn,this._newWeatherParameters=new nn,this._fadedWeatherParameters=new nn,this._weatherParameters=this._newWeatherParameters}initialize(){this.view._stage.addRenderPlugin(this)}destroy(){var e;this.removeHandles(),this.uninitializeRenderContext(),null!=(null===(e=this.view)||void 0===e?void 0:e._stage)&&this.view._stage.removeRenderPlugin(this),this._set("view",null)}get atmosphere(){return this._atmosphere}get _atmosphereType(){return null!=this.atmosphere?this.atmosphere.type:ze.None}consumes(){return this._atmosphereType===ze.Realistic?$i.of:$i.jt}updateAnimation(e){return null!=this._precipitation&&this._precipitation.update(e)}get updating(){return null!=this._stars&&this._stars.updating||null!=this._clouds&&this._clouds.running}get weatherVisible(){return(0,Ge.l)(this.view.state.camera.eye)-(0,Ze.Iu)(this.view.spatialReference).radius<=Yt.nq}get usedMemory(){var e,t;return null!==(e=null===(t=this._clouds)||void 0===t?void 0:t.usedMemory)&&void 0!==e?e:0}get _stars(){var e,t;const i=this.view,n=null!==(e=null===(t=i.environment)||void 0===t?void 0:t.starsEnabled)&&void 0!==e&&e,r=this._get("_stars");return n&&null!=this._context?null!=r?r:new Gi({view:i,requestRender:()=>this._setNeedsRender()}):((0,p.SC)(r),null)}get _precipitation(){const e=this._get("_precipitation");if(!this._precipitationEnabled||null==this._context)return(0,p.SC)(e),null;const t=this.view,i=this._context;return null!=e&&e.context===i?e:((0,p.SC)(e),new Ni({context:i,view:t}))}get _clouds(){const e=this._get("_clouds");if(!this.weatherEnabled||null==this._context)return(0,p.SC)(e),null;if(null!=e)return e;const t=this.view,i=this._context;return(0,p.SC)(e),new kt({context:i,view:t,requestRender:()=>this._setNeedsRender()})}get _cloudsComposition(){const e=this._get("_cloudsComposition");if(!this.weatherEnabled||null==this._context)return(0,p.SC)(e),null;const t=this.view.state.viewingMode,i=this._context.renderContext.rctx,n=(0,Ze.Iu)(this.view.spatialReference).radius;return null!=e&&e.viewingMode===t&&e.planetRadius===n?e:((0,p.SC)(e),new Ct({rctx:i,viewingMode:t,planetRadius:n,requestRender:()=>this._setNeedsRender()}))}get _fog(){const e=this._get("_fog");if(!this.weatherEnabled||null==this._context)return(0,p.SC)(e),null;if(null!=e)return e;const t=this.view,i=this._context,n=this._context.renderContext.rctx,r=this.view.state.viewingMode;return new Jt({context:i,view:t,rctx:n,viewingMode:r})}get weatherEnabled(){var e;return!(null===(e=this.view)||void 0===e||null===(e=e.environmentManager)||void 0===e||!e.weatherEnabled)}get _precipitationEnabled(){return this.weatherEnabled&&("rainy"===this.view.environment.weather.type||"snowy"===this.view.environment.weather.type)}initializeRenderContext(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null;this._context=e;const t=()=>this._setNeedsRender();this.addHandles([(0,g.watch)((()=>({viewingMode:this.view.state.viewingMode,enabled:this.view.environment.atmosphereEnabled})),(e=>this._updateAtmosphere(e)),g.syncAndInitial),(0,g.watch)((()=>this._stars),t),(0,g.watch)((()=>this._precipitation),t),(0,g.watch)((()=>this._clouds),(()=>this._updateWeather()),g.initial),(0,g.watch)((()=>this._fog),(()=>this._updateFogHaze()),g.initial),(0,g.watch)((()=>this.view.state.mode),(()=>this._setNeedsRender()),g.sync),(0,g.watch)((()=>this._weatherUpdateParameters),(()=>{this._updateWeather(),this._updateFogHaze()}),g.syncAndInitial)])}uninitializeRenderContext(){this._context=null,this._atmosphere=(0,p.SC)(this._atmosphere),this._set("_stars",(0,p.SC)(this._stars)),this._set("_precipitation",(0,p.SC)(this._precipitation)),this._set("_clouds",(0,p.SC)(this._clouds)),this._set("_cloudsComposition",(0,p.SC)(this._cloudsComposition)),this._set("_fog",(0,p.SC)(this._fog))}prepareRender(e){var t;e.bindParameters.cloudsFade.data=(0,Tt.Ck)(this._clouds)?this._clouds:null,"local"!==this.view.viewingMode&&null!=(null===(t=e.bindParameters.cloudsFade.data)||void 0===t?void 0:t.cubeMap)&&(this._updateWeatherFading(e.bindParameters,e.time),e.bindParameters.cloudsFade.renderingStage===Tt.jL.FINISHED&&null!=this._clouds&&0===this._clouds.coverage&&!1===this._clouds.running&&(this._clouds.destroyFrameBufferCube(),e.bindParameters.cloudsFade.data=null))}renderNode(e){var t,i,n,r;switch(e.bindParameters.slot){case en.r.OPAQUE_ENVIRONMENT:null!==(t=this._stars)&&void 0!==t&&t.render(e),null!=this.atmosphere&&(this.atmosphere.render(e,null===(i=this.view)||void 0===i||null===(i=i._stage)||void 0===i||null===(i=i.renderer)||void 0===i?void 0:i.fullResolutionAtmosphere),this._cloudsComposition&&null!=e.bindParameters.cloudsFade.data&&(this.weatherVisible&&null!=this._clouds&&this._clouds.updateWeatherTile(),this._cloudsComposition.render(e)),e.bindParameters.cloudsFade.isFading&&this._context&&null!=(null===(n=e.bindParameters.cloudsFade.data)||void 0===n?void 0:n.cubeMap)&&this._context.requestRender());break;case en.r.TRANSPARENT_ENVIRONMENT:if(null!=this.atmosphere&&(this.atmosphere.renderHaze(e,this._weatherParameters.hazeAmount,null===(r=this.view)||void 0===r||null===(r=r._stage)||void 0===r||null===(r=r.renderer)||void 0===r?void 0:r.fullResolutionAtmosphere),this._weatherParameters.fog.amount>0&&null!=this._fog&&this._fog.render(e,this._weatherParameters.fog),this._precipitation)){const t=this.view.environment.weather;"rainy"!==t.type&&"snowy"!==t.type||this._precipitation.render(e,t.precipitation,t.type)}}}updateLightSources(e,t,i,n){if(null!=this._context){const r=this._context.renderContext;r.bindParameters.oldLighting.copyFrom(r.bindParameters.lighting),r.bindParameters.newLighting.noonFactor=t,r.bindParameters.newLighting.globalFactor=i,r.bindParameters.newLighting.set(e),n===Ki.Faded||r.bindParameters.weatherFading?r.bindParameters.fadeLighting(0):r.bindParameters.fadeLighting(1),this._context.requestRender()}}get _weatherUpdateParameters(){const e=this.weatherEnabled?this.view.environment.weather:null;return null==e?null:"rainy"===e.type||"snowy"===e.type?{type:e.type,weatherAdjustment:e.cloudCover,effect:e.precipitation}:{type:e.type,weatherAdjustment:"foggy"===e.type?e.fogStrength:e.cloudCover}}_updateWeatherFading(e,t){e.cloudsFade.updateFading(e.camera,this.view.state.mode,t,this.view.qualitySettings.fadeDuration),e.cloudsFade.updateParallax(e.camera),e.weatherFading&&(function(e){e.cloudsFade.fadeMode!==Ot.lL.CROSS_FADE&&e.cloudsFade.fadeMode!==Ot.lL.FADE_IN?e.fadeLighting(0):e.fadeLighting(e.cloudsFade.fadeFactor)}(e),this._updateFogAtmoshpere(e))}_updateFogAtmoshpere(e){e.cloudsFade.fadeMode!==Ot.lL.CROSS_FADE&&e.cloudsFade.fadeMode!==Ot.lL.FADE_IN?this._fadeWeather(0):this._fadeWeather(e.cloudsFade.fadeFactor)}_fadeWeather(e){const{_newWeatherParameters:t,_oldWeatherParameters:i}=this;e>=1?this._weatherParameters=t:(this._fadedWeatherParameters.lerp(i,t,e),this._weatherParameters=this._fadedWeatherParameters)}_updateWeather(){const e=this._weatherUpdateParameters;null!=e&&null!=this._clouds&&(this._clouds.applyPreset(Et.L[e.type],e.weatherAdjustment),this._setNeedsRender())}_setNeedsRender(){null!=this._context&&this._context.requestRender()}_updateFogHaze(){var e,t;const i=this._weatherUpdateParameters;if(null==this._fog||null==i||null==this._context)return;const n=this._context.renderContext.bindParameters;switch(this._oldWeatherParameters.copyFrom(this._weatherParameters),i.type){case"foggy":this._newWeatherParameters.fog.strength=(0,me.t7)(3e-5,.005,i.weatherAdjustment**3),(0,Ge.c)(this._newWeatherParameters.fog.color,sn),this._newWeatherParameters.fog.amount=1,this._newWeatherParameters.hazeAmount=1,this._setNeedsRender();break;case"rainy":this._newWeatherParameters.fog.strength=(0,me.t7)(4e-6,2e-4,(null!==(e=i.effect)&&void 0!==e?e:0)**3),(0,Ge.c)(this._newWeatherParameters.fog.color,rn),this._newWeatherParameters.fog.amount=1,this._newWeatherParameters.hazeAmount=0,this._setNeedsRender();break;case"snowy":this._newWeatherParameters.fog.strength=(0,me.t7)(4e-6,2e-4,(null!==(t=i.effect)&&void 0!==t?t:0)**3),(0,Ge.c)(this._newWeatherParameters.fog.color,sn),this._newWeatherParameters.fog.amount=1,this._newWeatherParameters.hazeAmount=1,this._setNeedsRender();break;default:this._newWeatherParameters.fog.strength=0,this._newWeatherParameters.fog.amount=0,this._newWeatherParameters.hazeAmount=1,this._setNeedsRender()}n.weatherFading?this._fadeWeather(0):this._fadeWeather(1)}_updateAtmosphere(e){const t=this._selectAtmosphereType(e);if(t!==ze.None&&this._context){if(!this._atmosphere||this._atmosphere.type!==t){this._atmosphere=(0,p.SC)(this._atmosphere);const e=this._getAtmosphereClass(t);e&&(this._atmosphere=new e(this.view,this._context))}}else this._atmosphere=(0,p.SC)(this._atmosphere);this._setNeedsRender()}_getAtmosphereClass(e){switch(e){case ze.Realistic:return yt;case ze.Local:return pi;case ze.Mars:return Ci;default:case ze.None:return null}}_selectAtmosphereType(e){const{enabled:t,viewingMode:i}=e;return!t||(0,ke.V2)(this.view.spatialReference)?ze.None:i===te.JY.Local?ze.Local:null!=this._context&&(0,ke.N$)(this.view.spatialReference)?ze.Realistic:(0,ke.BZ)(this.view.spatialReference)?ze.Mars:ze.None}get test(){}};(0,n._)([(0,b.Cb)({constructOnly:!0})],tn.prototype,"view",void 0),(0,n._)([(0,b.Cb)({readOnly:!0})],tn.prototype,"atmosphere",null),(0,n._)([(0,b.Cb)({readOnly:!0})],tn.prototype,"_atmosphereType",null),(0,n._)([(0,b.Cb)({type:Boolean,readOnly:!0})],tn.prototype,"updating",null),(0,n._)([(0,b.Cb)({readOnly:!0})],tn.prototype,"weatherVisible",null),(0,n._)([(0,b.Cb)()],tn.prototype,"_context",void 0),(0,n._)([(0,b.Cb)()],tn.prototype,"_atmosphere",void 0),(0,n._)([(0,b.Cb)({readOnly:!0})],tn.prototype,"_stars",null),(0,n._)([(0,b.Cb)({readOnly:!0})],tn.prototype,"_precipitation",null),(0,n._)([(0,b.Cb)({readOnly:!0})],tn.prototype,"_clouds",null),(0,n._)([(0,b.Cb)({readOnly:!0})],tn.prototype,"_cloudsComposition",null),(0,n._)([(0,b.Cb)({readOnly:!0})],tn.prototype,"_fog",null),(0,n._)([(0,b.Cb)({readOnly:!0})],tn.prototype,"weatherEnabled",null),(0,n._)([(0,b.Cb)({readOnly:!0})],tn.prototype,"_precipitationEnabled",null),(0,n._)([(0,b.Cb)({readOnly:!0})],tn.prototype,"_weatherUpdateParameters",null),tn=(0,n._)([(0,C.j)("esri.views.3d.environment.EnvironmentRenderer")],tn);class nn{constructor(){this.fog=new Kt,this.hazeAmount=1}copyFrom(e){this.fog.amount=e.fog.amount,this.hazeAmount=e.hazeAmount,this.fog.strength=e.fog.strength,(0,Ge.c)(this.fog.color,e.fog.color)}lerp(e,t,i){this.fog.amount=(0,me.t7)(e.fog.amount,t.fog.amount,i),this.hazeAmount=(0,me.t7)(e.hazeAmount,t.hazeAmount,i),this.fog.strength=(0,me.t7)(e.fog.strength,t.fog.strength,i),(0,Ge.o)(this.fog.color,e.fog.color,t.fog.color,i)}}const rn=(0,R.al)(.5,.5,.5),sn=(0,R.al)(1.5,1.5,1.5);var an=i(696),on=i(28961),ln=i(11954),hn=i(4914);let cn=class extends G.Z.EventedAccessor{constructor(){super(),this._referencePointUpdateDelay=200,this._referencePointUpdateInterval=3e3,this._referencePointUpdateDistThreshold=1e6,this._referencePosUpdateQuery=null,this._referencePosMapCoordsRequested=null,this._viewHandlesKey="viewHandles",this._preserveAbsoluteDateTime=!1,this._trackingEnabled=!1,this._referencePosResetPreserveAbsoluteTime=!1,this._referencePosUpdateTimer=null,this._referencePosMapCoords=null,this._mainLight=new ln.Eg,this._ambientLight=new ln.Mi,this._moonLight=new ln.AM,this.disableQueries=!1,this._disableWeather=!1,this._renderer=null,this._referencePositionGeographic=null,this._resetReferencePosition()}destroy(){this.disconnectView()}get _view(){var e;return null===(e=this._renderer)||void 0===e?void 0:e.view}get updating(){var e;return!((this.disableQueries||!this._referencePosUpdateQuery&&!this._referencePosMapCoordsRequested)&&(null===(e=this._renderer)||void 0===e||!e.updating))}get weatherEnabled(){var e,t;return(null===(e=this._view)||void 0===e?void 0:e.environment.atmosphereEnabled)&&!this._disableWeather&&(null===(t=this._view)||void 0===t||null===(t=t.state)||void 0===t?void 0:t.viewingMode)===te.JY.Global&&(0,ke.N$)(this._view.spatialReference)}get weatherVisible(){var e;return this.weatherEnabled&&(null===(e=this._renderer)||void 0===e?void 0:e.weatherVisible)}get referencePositionGeographic(){return this._referencePositionGeographic}connectView(e){if(this._renderer)return;this._renderer=new tn({view:e});const t=()=>this._updateRenderParameters(),i=()=>this._cameraHandler();this.addHandles([(0,g.watch)((()=>e.environment.lighting),(e=>this._updateLightingHandler(e)),g.sync),(0,g.watch)((()=>"virtual"!==e.environment.lighting.type?e.environment.lighting.date:null),(e=>this._lightingDateHandler(e)),g.sync),(0,g.watch)((()=>e.stationary),(()=>this._interactingStationaryHandler())),(0,g.watch)((()=>e.environment.lighting.directShadowsEnabled),t,g.sync),(0,g.watch)((()=>e.qualitySettings.ambientOcclusion),t,g.sync),(0,g.watch)((()=>e.qualitySettings.reflections),t,g.sync),(0,g.watch)((()=>e.spatialReference),(()=>this._resetReferencePosition(!0)),g.sync),(0,g.watch)((()=>e.environment.weather.type),(()=>this._updateLighting(null,Ki.Faded)),g.sync),(0,g.watch)((()=>this.weatherEnabled),(()=>this._updateLighting(null,Ki.Faded)),g.sync),(0,g.watch)((()=>e.viewingMode),(()=>this._resetReferencePosition(!0)),g.syncAndInitial),(0,g.watch)((()=>"virtual"!==e.environment.lighting.type&&e.environment.lighting.cameraTrackingEnabled),(e=>this._updateCameraTracking(e)),g.syncAndInitial),(0,g.watch)((()=>e.state.camera),i,g.syncAndInitial),(0,g.watch)((()=>this.disableQueries),i)],this._viewHandlesKey),this._updateRenderParameters(),this._updateLighting(),this._cameraHandler(),this.notifyChange("updating")}disconnectView(){this.removeHandles(this._viewHandlesKey),this._resetReferencePosition(),this._renderer=(0,p.SC)(this._renderer)}_updateLightingHandler(e){this._updateCameraTracking("virtual"!==e.type&&e.cameraTrackingEnabled),this._lightingDateHandler("virtual"!==e.type?e.date:null),this._updateRenderParameters()}_updateCameraTracking(e){if(this._trackingEnabled=e,e)this._cameraHandler();else{const e=this._view.environment.lighting;"virtual"!==(null===e||void 0===e?void 0:e.type)&&(e.positionTimezoneInfo.autoUpdated=!1)}}_lightingDateHandler(e){const t=this._view.environment.lighting;if("virtual"!==(null===t||void 0===t?void 0:t.type)){if(e){if(!t.positionTimezoneInfo.autoUpdated){this._preserveAbsoluteDateTime=!0;const i=this._view.spatialReference;if(!(0,E.canProjectWithoutEngine)(i,k.Z.WGS84)){const e=this._view.camera.position;if(!this._referencePosMapCoords||!this._referencePosMapCoords.equals(e))return void this._requestReferencePositionUpdate(e)}if(this._preupdateTracking(e),null!=this._referencePositionGeographic){const e=(0,an.dF)(this._referencePositionGeographic,_n);null!=e&&(t.autoUpdate(null,e),this._trackingEnabled&&(t.positionTimezoneInfo.autoUpdated=!0))}}this._updateLighting(e)}}else this._updateLighting()}_preupdateTracking(e){!this._trackingEnabled&&"virtual"!==this._view.environment.lighting.type&&this._view.environment.lighting.cameraTrackingEnabled&&this._cameraHandler(e)}_cameraHandler(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null;const t=this._view;if(!t.ready)return;const i=t.stateManager.camera;i&&(this._cameraHandlerClientSide(i,e)||this._cameraHandlerServerSide(i))}_cameraHandlerClientSide(e,t){var i,n,r,s;const a=(0,ke.N$)(this._view.spatialReference);if(a&&!(0,E.canProjectWithoutEngine)(this._view.spatialReference,k.Z.WGS84))return"virtual"===this._view.environment.lighting.type&&this._updateLighting(),!1;const o=e.position;return null!==(i=this._referencePositionGeographic)&&void 0!==i||(this._referencePositionGeographic=(0,R.Ue)()),a?(0,I.K)(o,this._referencePositionGeographic,k.Z.WGS84):(0,Ge.s)(this._referencePositionGeographic,null!==(n=o.longitude)&&void 0!==n?n:0,null!==(r=o.latitude)&&void 0!==r?r:0,null!==(s=o.z)&&void 0!==s?s:0),this.notifyChange("referencePositionGeographic"),this._autoUpdateTimezone(this._referencePositionGeographic,t)||this._updateLighting(t),!0}_cameraHandlerServerSide(e){var t;const i=e.position;(!this._referencePosMapCoords||this._referencePosMapCoordsRequested||this._exceedsReferencePosDistThreshold(i))&&this._requestReferencePositionUpdate(i,!0),this._view.mapCoordsHelper&&this._referencePositionGeographic&&(this._referencePositionGeographic[2]=(null!==(t=i.z)&&void 0!==t?t:0)*this._view.mapCoordsHelper.unitInMeters,this._referencePosChanged())}_interactingStationaryHandler(){this._view.stationary&&this._executePendingReferencePositionUpdate()}_updateLighting(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:Ki.Immediate;const i=this._view;e=e||("virtual"===i.environment.lighting.type?null:i.environment.lighting.date);const n=this._referencePositionGeographic,r=n?dn:un,s=this.weatherVisible?i.environment.weather.type:"disabled";null!=n?(0,on.WA)(e,n,i.state.viewingMode,s,i.state.camera,r):"virtual"===i.environment.lighting.type&&(0,on.H3)(i.state.camera,i.state.viewingMode,r.direct.directionToLightSource);const a=this._mainLight,o=r.direct;(0,Ge.j)(a.intensity,o.color,o.intensity*Math.PI),(0,Ge.c)(a.direction,o.directionToLightSource),a.specularStrength=r.specularStrength,a.environmentStrength=r.environmentStrength;const l=this._ambientLight;(0,Ge.j)(l.intensity,r.ambient.color,r.ambient.intensity);const h=this._moonLight;(0,Ge.o)(h.intensity,mn,gn,r.globalFactor);const c=(1-.5*r.globalFactor)*(1-.4*r.noonFactor*(1-r.globalFactor));(0,Ge.j)(h.intensity,h.intensity,c),(0,Ge.c)(h.direction,o.directionToLightSource),this._renderer.updateLightSources([a,l,h],r.noonFactor,r.globalFactor,t),this._updateRenderParameters()}_autoUpdateTimezone(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;if("virtual"===this._view.environment.lighting.type||!this._view.environment.lighting.cameraTrackingEnabled||null==e)return!1;const i=pn;i.setTime((t||this._view.environment.lighting.date).getTime());const n=(0,an.dF)(e,_n);if(null==n)return!1;let r=this._view.environment.lighting.positionTimezoneInfo;if(r.autoUpdated){if(r.hours===n.hours&&r.minutes===n.minutes&&r.seconds===n.seconds)return!1}else r=n;const s=i.getUTCHours()-(n.hours-r.hours),a=i.getUTCMinutes()-(n.minutes-r.minutes),o=i.getUTCSeconds()-(n.seconds-r.seconds);return i.setUTCHours(s),i.setUTCMinutes(a),i.setUTCSeconds(o),!t&&this._view.environment.lighting.autoUpdate(i,n)}_updateRenderParameters(){const e=this._view._stage;if(!e)return;const t=null==this._referencePositionGeographic||(0,on.XO)(this._referencePositionGeographic[2],this._view.state.viewingMode);e.renderer.setParameters({shadowMap:this._view.environment.lighting.directShadowsEnabled&&t,environment:this._view.environment,weatherVisible:this._view.environmentManager.weatherVisible,qualitySettings:this._view.qualitySettings})}_resetReferencePosition(){let e=arguments.length>0&&void 0!==arguments[0]&&arguments[0];this._cancelReferencePosUpdates(),this._referencePosMapCoords=null,this._referencePosMapCoordsRequested=null,this._referencePosResetPreserveAbsoluteTime=null,this._referencePositionGeographic=null,this.notifyChange("updating"),e&&this._cameraHandler()}_requestReferencePositionUpdate(e){let t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];if(!this.disableQueries&&(this._referencePosMapCoordsRequested?this._referencePosMapCoordsRequested.copy(e):this._referencePosMapCoordsRequested=e.clone(),this._referencePosResetPreserveAbsoluteTime=!!t,!this._referencePosUpdateQuery&&!this._referencePosUpdateTimer&&this._view.stationary)){const e=this._referencePosUpdateQuery=(0,m.e4)(this._referencePointUpdateDelay).then((()=>{if(this._referencePosUpdateQuery===e){const t=()=>this._referencePosUpdateQuery!==e;return this._doReferencePositionUpdateQuery(t)}})).catch((e=>{"mapcoordshelper:missing-geometry-service"===e.name&&(this.disableQueries=!0)})).then((()=>{this._referencePosUpdateQuery===e&&(this._referencePosUpdateQuery=null,this._referencePosUpdateTimer||this._executePendingReferencePositionUpdate(),this.notifyChange("updating"))})),t=this._referencePosUpdateTimer=(0,m.e4)(this._referencePointUpdateInterval).then((()=>{this._referencePosUpdateTimer===t&&(this._referencePosUpdateTimer=null,this._referencePosUpdateQuery||this._executePendingReferencePositionUpdate())}));this.notifyChange("updating")}}async _doReferencePositionUpdateQuery(e){this._referencePosResetPreserveAbsoluteTime&&(this._preserveAbsoluteDateTime=!1),this._referencePosMapCoords?this._referencePosMapCoords.copy(this._referencePosMapCoordsRequested):this._referencePosMapCoords=this._referencePosMapCoordsRequested.clone(),this._referencePosResetPreserveAbsoluteTime=null,this._referencePosMapCoordsRequested=null;const t=await this._view.mapCoordsHelper.toGeographic(this._referencePosMapCoords);if(!e()&&!isNaN(t[0])&&!isNaN(t[1])){var i;const e=(null!==(i=this._referencePosMapCoords.z)&&void 0!==i?i:0)*this._view.mapCoordsHelper.unitInMeters;this._referencePositionGeographic?(0,Ge.s)(this._referencePositionGeographic,t[0],t[1],e):this._referencePositionGeographic=(0,R.al)(t[0],t[1],e),this._referencePosChanged()}}_executePendingReferencePositionUpdate(){const e=this._referencePosMapCoordsRequested;e&&this._requestReferencePositionUpdate(e,this._referencePosResetPreserveAbsoluteTime)}_referencePosChanged(){this._preserveAbsoluteDateTime?this._updateLighting():this._autoUpdateTimezone(this._referencePositionGeographic)||this._updateLighting(),this.notifyChange("referencePositionGeographic")}_exceedsReferencePosDistThreshold(e){const t=this._referencePosMapCoords;if(null==t)return!0;const i=(0,hn.Z1)(t,e);return null==i||(0,Be.nn)(i,"meters").value>this._referencePointUpdateDistThreshold}_cancelReferencePosUpdates(){const e=!!this._referencePosUpdateQuery;return this._referencePosUpdateQuery=null,this._referencePosUpdateTimer=null,e}get test(){}};(0,n._)([(0,b.Cb)({type:Boolean,readOnly:!0})],cn.prototype,"updating",null),(0,n._)([(0,b.Cb)()],cn.prototype,"disableQueries",void 0),(0,n._)([(0,b.Cb)()],cn.prototype,"_disableWeather",void 0),(0,n._)([(0,b.Cb)()],cn.prototype,"weatherEnabled",null),(0,n._)([(0,b.Cb)()],cn.prototype,"weatherVisible",null),(0,n._)([(0,b.Cb)()],cn.prototype,"referencePositionGeographic",null),(0,n._)([(0,b.Cb)()],cn.prototype,"_renderer",void 0),(0,n._)([(0,b.Cb)()],cn.prototype,"_referencePositionGeographic",void 0),cn=(0,n._)([(0,C.j)("esri.views.3d.environment.SceneViewEnvironmentManager")],cn);const dn=new on.GD,un=new on.GD,pn=new Date,_n={hours:0,minutes:0,seconds:0},mn=(0,R.al)(.22,.22,.33),gn=(0,R.al)(.22,.22,.22);var fn,vn,yn,bn=i(23470),wn=i(40885);!function(e){e[e.NONE=0]="NONE",e[e.TILT=1]="TILT",e[e.ALTITUDE=2]="ALTITUDE",e[e.DISTANCE=4]="DISTANCE",e[e.COLLISION=8]="COLLISION",e[e.ALL=15]="ALL",e[e.ALL_EXCEPT_COLLISION=7]="ALL_EXCEPT_COLLISION"}(fn||(fn={})),function(e){e[e.NONE=0]="NONE",e[e.ZOOM=1]="ZOOM",e[e.TUMBLE=2]="TUMBLE",e[e.LOOK_AROUND=3]="LOOK_AROUND",e[e.PAN=4]="PAN",e[e.ASCEND=5]="ASCEND"}(vn||(vn={})),function(e){e[e.TUMBLE=0]="TUMBLE",e[e.LOOK_AROUND=1]="LOOK_AROUND"}(yn||(yn={}));class Cn{constructor(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:fn.ALL,t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:vn.NONE,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null,r=arguments.length>4&&void 0!==arguments[4]?arguments[4]:null,s=arguments.length>5&&void 0!==arguments[5]?arguments[5]:yn.TUMBLE;this.selection=e,this.interactionType=t,this.interactionFactor=i,this.interactionStartCamera=n,this.interactionDirection=r,this.tiltMode=s}}function xn(e,t){return!!(e&t)}function Tn(e,t,i,n,r,s){0!==e&&(i?(s.min=Math.min(s.min,t),s.max=Math.max(s.max,t)):null!=n?(s.min-=Math.max(0,(t-s.min)*(1-n)),s.max+=Math.max(0,(t-s.max)*(1-n))):r&&(s.min-=Math.max(0,t-s.min-r),s.max+=Math.max(0,t-s.max-r)))}const Sn=new Cn(fn.NONE);function Pn(e,t,i,n){return t=t||e.viewForward,(0,Ge.c)(n,t),(0,Ge.j)(n,n,Math.sign((0,Ge.m)(t,i))),n}var Mn=i(83281);function Rn(e,t){let i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:Sn;if(!function(e,t){const i=e.state.constraints.altitude;return!(!e.state.isGlobal||!i)&&(t.interactionType!==vn.TUMBLE||!xn(t.selection,fn.TILT))}(e,i)||!e.state.constraints.altitude)return 0;const n=function(e,t){return t.min=e.min,t.max=e.max,t}(e.state.constraints.altitude,An);!function(e,t,i){const n=t.interactionType;if(n===vn.NONE)return;const{min:r,max:s}=i,{interactionStartCamera:a,interactionFactor:o}=t;if(!a)return;const l=n===vn.TUMBLE||n===vn.ZOOM,h=Rn(e,a),c=0===h?0:e.renderCoordsHelper.getAltitude(a.eye);i.min=r,i.max=s,Tn(h,c,l,o,.05*c,i)}(e,i,n);const r=e.renderCoordsHelper.getAltitude(t.eye),s=(0,me.uZ)(r,n.min,n.max)-r;return Math.abs(s)<=1e-6?0:s}const An={min:0,max:0},On=(0,R.Ue)(),En=(0,R.Ue)(),Dn=(0,R.Ue)(),In=(0,R.Ue)();function Ln(e,t){let i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:Sn;if(!e.state.isLocal)return 0;const n=e.state.constraints.distance;if(!e.pointsOfInterest.surfaceOrigin.renderLocation||n===1/0)return 0;Un.min=0,Un.max=n,function(e,t,i){const n=t.interactionType;if(n===vn.NONE)return;const{min:r,max:s}=i,{interactionStartCamera:a,interactionFactor:o}=t;if(!a)return;const l=n===vn.ZOOM||n===vn.PAN,h=Ln(e,a),c=0===h?0:Nn(e,a);i.min=r,i.max=s,Tn(h,c,l,o,.05*c,i)}(e,i,Un);const r=Nn(e,t),s=Un.max-r;return s>=-1e-6?0:s}function Nn(e,t){const i=e.pointsOfInterest.surfaceOrigin;return i.renderLocation?(0,Ge.p)(t.eye,i.renderLocation):0}const Un={min:0,max:0},Hn=(0,R.Ue)(),Fn=(0,R.Ue)(),Vn=(0,R.Ue)(),qn=(0,R.Ue)(),zn=(0,R.Ue)();var Bn,Gn=i(87532);function kn(e,t){let i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:Bn.EYE;const n=e.state.constraints;if(!n.collision.enabled)return!1;const r=(0,Gn.wH)(e,t.eye),s=e.renderCoordsHelper.getAltitude(t.eye),a=r+n.collision.elevationMargin;if(s>=a)return!1;const o=(0,Ge.l)(t.eye);if((0,Ge.f)(Zn,t.center,t.eye),t.eye=e.renderCoordsHelper.setAltitude(jn,a,t.eye),i===Bn.EYE_AND_CENTER)t.center=(0,Ge.g)(Zn,t.eye,Zn);else if(i===Bn.EYE_AND_CENTER_SCALE){const e=(o-s+a)/o;t.center=(0,Ge.j)(Zn,t.center,e)}return!0}!function(e){e[e.EYE=0]="EYE",e[e.EYE_AND_CENTER=1]="EYE_AND_CENTER",e[e.EYE_AND_CENTER_SCALE=2]="EYE_AND_CENTER_SCALE"}(Bn||(Bn={}));const Zn=(0,R.Ue)(),jn=(0,R.Ue)();function Wn(e,t,i){e.worldUpAtPosition(t,Xn),(0,Ge.f)(Qn,i,t);const n=(0,Ge.l)(Qn);return 0===n?0:(0,me.ZF)((0,Ge.m)(Qn,Xn)/n)}const Xn=(0,R.Ue)(),Qn=(0,R.Ue)();function Yn(e,t,i){let n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:Sn,r=arguments.length>4?arguments[4]:void 0;if(!e.state.constraints.tilt)return 0;const s=t.distance,a=e.state.constraints.tilt(s,rr);return function(e,t,i){if(t.interactionType===vn.NONE)return;const{interactionStartCamera:n,interactionFactor:r}=t;if(!n)return;const{min:s,max:a}=i,o=Yn(e,n,Sn,t),l=0===o?0:Wn(e.renderCoordsHelper,n.center,n.eye);i.min=s,i.max=a,t.interactionType===vn.TUMBLE?(xn(t.selection,fn.ALTITUDE)&&$n(e,n,i),Tn(o,l,!0,r,nr,i)):Tn(o,l,!1,r,nr,i)}(e,i,a),n.interactionType===vn.TUMBLE&&xn(n.selection,fn.ALTITUDE)&&$n(e,n.interactionStartCamera,a),i.tiltMode===yn.LOOK_AROUND||n.tiltMode===yn.LOOK_AROUND?function(e,t,i,n){switch(n&&(n.requiresTwoSteps=!1),e.viewingMode){case"global":return function(e,t,i,n){const r=function(e,t,i){const n=e.pointsOfInterest.centerOnSurfaceFrequent.estimatedSurfaceAltitude,r=n+(0,Ze.Iu)(e.spatialReference).radius,s=e.renderCoordsHelper.intersectManifold(t.ray,n,ir);return i.eyeCenterDistance=t.distance,i.centerIsOnSurface=!1,null!=s?(i.eyeCenterDistance=(0,Ge.p)(t.eye,s),i.tiltAtCenter=Wn(e.renderCoordsHelper,s,t.eye),i.centerIsOnSurface=!0):e.state.isLocal?i.tiltAtCenter=Wn(e.renderCoordsHelper,t.center,t.eye):((0,bn.e)((0,bn.h)(bn.t,r),t.ray,ir),i.eyeCenterDistance=(0,Ge.p)(t.eye,ir),i.tiltAtCenter=(0,me.ZF)(-(0,Ge.m)(t.viewForward,(0,Ge.n)(ir,ir)))),i.radius=r,i.eyeRadius=(0,Ge.l)(t.eye),i.constraints=e.state.constraints,i}(e,t,sr),s=(0,me.uZ)(r.tiltAtCenter,i.min,i.max);if(!Jn(r.tiltAtCenter-s))return 0;let a,o;return r.centerIsOnSurface?(a=function(e){const{constraints:t,eyeCenterDistance:i,tiltAtCenter:n}=e;let r=n,s=t.clampTilt(i,n);const a=Kn(e,s);if(t.clampTilt(a,n)===s)return s;let o=0;for(;o<10&&Jn(s-r);){const i=(r+s)/2,n=Kn(e,i);Jn(t.clampTilt(n,i)-i)?r=i:s=i,o++}return s}(r),o=function(e,t){const i=(0,me.Kt)(e.radius/e.eyeRadius*Math.sin(e.tiltAtCenter)),n=(0,me.Kt)(e.radius/e.eyeRadius*Math.sin(t));return e.eyeRadius>e.radius?i-n:n-i}(r,a)):(a=r.constraints.clampTilt(r.eyeCenterDistance,r.tiltAtCenter),n&&a<Math.PI/2&&(n.requiresTwoSteps=!0,a=Math.PI/2-1e-5),o=function(e,t){return e.tiltAtCenter-Math.PI/2-(t-Math.PI/2)}(r,a)),n&&(n.eyeCenterDistance=Kn(r,a)),o}(e,t,i,n);case"local":return function(e,t,i,n){const r=Wn(e.renderCoordsHelper,t.center,t.eye),s=(0,me.uZ)(r,i.min,i.max),a=r-s;if(!Jn(a))return 0;if(n){const i=e.pointsOfInterest.centerOnSurfaceFrequent.estimatedSurfaceAltitude,r=e.renderCoordsHelper.getAltitude(t.eye)-i,a=Math.cos(s);Math.abs(a)>1e-4?n.eyeCenterDistance=r/a:n.eyeCenterDistance=t.distance}return a}(e,t,i,n)}}(e,t,a,r):function(e,t,i){const n=Wn(e.renderCoordsHelper,t.center,t.eye),r=n-(0,me.uZ)(n,i.min,i.max);return Jn(r)?r:0}(e,t,a)}function Jn(e){return Math.abs(e)>1e-9}function Kn(e,t){if(!e.centerIsOnSurface)return e.eyeCenterDistance;const i=Math.PI-(0,me.uZ)(t,0,Math.PI),n=(0,me.Kt)(e.radius/e.eyeRadius*Math.sin(i)),r=Math.PI-i-n,s=Math.sin(r)/Math.sin(i);if(e.eyeRadius<e.radius&&s>1){const t=Math.PI-n,r=Math.PI-i-t;return Math.sin(r)/Math.sin(i)*e.eyeRadius}return s*e.eyeRadius}function $n(e,t,i){const n=e.state.constraints;if(e.state.isLocal||!n.altitude||!t)return;const r=(0,Ge.q)(t.center),s=Math.sqrt(r),a=t.distance,o=(0,Ze.Iu)(e.spatialReference).radius,l=n.altitude.min+o,h=n.altitude.max+o,c=(l*l-a*a-r)/(-2*s*a),d=(h*h-a*a-r)/(-2*s*a);i.min=Math.max(i.min,Math.min(Math.PI-(0,me.ZF)(d),i.max)),i.max=Math.min(i.max,Math.PI-(0,me.ZF)(c))}const er=(0,R.Ue)(),tr=(0,Mt.Ue)(),ir=(0,R.Ue)(),nr=(0,me.Vl)(5),rr={min:0,max:0},sr={constraints:null,radius:0,eyeRadius:0,centerIsOnSurface:!0,eyeCenterDistance:0,tiltAtCenter:0},ar={eyeCenterDistance:0,requiresTwoSteps:!1};var or=i(64006);function lr(e,t){let i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:dr,n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:t;n!==t&&n.copyFrom(t),n.computeUp(e.state.viewingMode);let r=!1;for(let o=0;o<ur;o++){let t=0;for(const s of cr)if(xn(i.selection,s.type)){const a=Math.abs(s.error(e,n,i));s.apply(e,n,i)&&(r=!0,t+=a)}if(0===t)break}const s=xn(i.selection,fn.COLLISION),a=function(e,t){switch(e){case vn.PAN:return Bn.EYE_AND_CENTER;case vn.ASCEND:return t.state.isGlobal?Bn.EYE_AND_CENTER_SCALE:Bn.EYE_AND_CENTER;default:return Bn.EYE}}(i.interactionType,e);return s&&kn(e,n,a)&&(r=!0),r&&n.computeUp(e.state.viewingMode),r}function hr(e){const t=Math.min(1,e/150);return(0,or.FT)(t)}const cr=[{type:fn.TILT,error:function(e,t,i){return Yn(e,t,i)*t.distance},apply:function e(t,i,n){let r=!(arguments.length>3&&void 0!==arguments[3])||arguments[3];ar.eyeCenterDistance=0,ar.requiresTwoSteps=!1;const s=Yn(t,i,n,Sn,ar);if(0===s)return!1;switch((0,Pt.Us)(tr,-s,i.viewRight),n.tiltMode){case yn.LOOK_AROUND:(0,Ge.h)(er,i.viewForward,tr),(0,Ge.j)(er,er,ar.eyeCenterDistance),i.center=(0,Ge.g)(ir,i.eye,er);break;case yn.TUMBLE:(0,Ge.f)(er,i.center,i.eye),(0,Ge.h)(er,er,tr),i.eye=(0,Ge.f)(ir,i.center,er);break;default:(0,Re.Bg)(n.tiltMode)}return i.up=(0,Ge.h)(ir,i.up,tr),!ar.requiresTwoSteps||!r||e(t,i,n,!1)}},{type:fn.ALTITUDE,error:Rn,apply:function(e,t){let i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:Sn;const n=Rn(e,t,i);if(0===n)return!1;const r=e.renderCoordsHelper,s=r.getAltitude(t.eye)+n,a=Pn(t,i.interactionDirection,function(e,t,i,n){return e.renderCoordsHelper.worldUpAtPosition(t.eye,n),(0,Ge.j)(n,n,i),n}(e,t,Math.sign(n),En),On),o=(0,Ge.c)(Dn,t.viewForward),l=r.intersectInfiniteManifold((0,wn.re)(t.eye,a),s,In);return t.eye=null!=l?l:r.setAltitude(In,s,t.eye),t.center=(0,Mn.W8)(In,t.eye,o,t.center),!0}},{type:fn.DISTANCE,error:Ln,apply:function(e,t){let i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:Sn;const n=Ln(e,t,i);if(0===n)return!1;const r=e.pointsOfInterest.surfaceOrigin;if(!r.renderLocation)return!1;const s=Nn(e,t)+n,a=(0,Ge.c)(Hn,t.eye),o=Pn(t,i.interactionDirection,function(e,t,i){return(0,Ge.E)(i,e.eye,t)}(t,r.renderLocation,qn),Vn);if(!(0,bn.i)((0,bn.k)(r.renderLocation,s),(0,wn.re)(t.eye,o),zn))return!1;t.eye=zn;const l=(0,Ge.f)(Fn,t.eye,a);t.center=(0,Ge.g)(zn,t.center,l);const h=e.renderCoordsHelper.getAltitude(t.center),c=e.renderCoordsHelper.intersectInfiniteManifold(t.ray,h,zn);return null!=c&&(t.center=c),!0}}],dr=new Cn,ur=5;var pr=i(21389);class _r{get pitch(){return this._pitch}get yaw(){return this._yaw}get distance(){return this._distance}get fov(){return this._fov}get size(){return this._size}constructor(e){this.viewingMode=e,this.center=(0,R.Ue)(),this._pitch=0,this._yaw=0,this._distance=0,this.direction=(0,R.d9)(Cr),this._fov=55,this._size=1}pixelsPerPanAtZoom(e){return this._size/2/(this._zoomToPanScale*e)}zoomAtPixelsPerPan(e){return this._size/2/(this._zoomToPanScale*e)}pixelsPerRotateAtZoom(){const e=Math.max(Math.cos(Math.abs(this._pitch)),.5);return this._size/2/e}compareTo(e,t){if(this.viewingMode===te.JY.Global){const i=((0,Ge.l)(this.center)+(0,Ge.l)(e.center))/2;t.pan=(0,fe.EU)(this.center,e.center)*i}else t.pan=(0,Ge.p)(this.center,e.center);let i=Math.abs(e._yaw-this._yaw);i>=Math.PI&&(i=2*Math.PI-i);const n=Math.abs(e._pitch-this._pitch);t.rotate=Math.max(i,n),t.fov=e.fov-this.fov,t.sourceZoom=this._distance,t.targetZoom=e._distance}interpolate(e,t,i){this.viewingMode===te.JY.Global?(0,fe.ZA)(e.center,t.center,i.pan,this.center):(0,Ge.o)(this.center,e.center,t.center,i.pan),this._distance=isFinite(t.distance)?(0,me.t7)(e.distance,t.distance+i.zoomOffset,i.zoom):e.distance,this._pitch=(0,me.t7)(e.pitch,t.pitch,i.rotate);let n=e._yaw;const r=t._yaw;Math.abs(r-n)>=Math.PI&&(n+=2*(n<r?1:-1)*Math.PI),this._yaw=(0,me.t7)(n,r,i.rotate),this._fov=(0,me.t7)(e.fov,t.fov,i.fov)}copyFrom(e){(0,Ge.c)(this.center,e.center),this._pitch=e.pitch,this._yaw=e.yaw,this._distance=e.distance,(0,Ge.c)(this.direction,e.direction),this._size=e.size,this._fov=e.fov,this._zoomToPanScale=Math.atan(.5*this._fov),this.viewingMode=e.viewingMode}copyFromRenderCamera(e){const t=this._lookAtOrientation(e.center,Tr);(0,Ge.c)(this.center,e.center),(0,Ge.f)(vr,e.center,e.eye),(0,Ge.t)(vr,vr,t),(0,Ge.t)(yr,e.up,t),this._distance=(0,Ge.l)(vr),0!==this._distance&&(vr[0]/=this._distance,vr[1]/=this._distance,vr[2]/=this._distance),this._pitch=this._eyeUpToPitch(vr),this._yaw=function(e,t){const i=br;return Math.abs(t[2])<.5?((0,Ge.c)(i,t),e[2]>0&&(0,Ge.j)(i,i,-1)):(0,Ge.c)(i,e),(0,Ge.b)(gr,i,wr),(0,Ge.n)(gr,gr),(0,fe.EU)(xr,gr,wr)}(vr,yr),this._size=Math.sqrt(e.width*e.width+e.height*e.height),this._fov=e.fov,this._zoomToPanScale=Math.atan(.5*this._fov)}copyToRenderCamera(e){const t=this._lookAtOrientation(this.center,Tr);(0,St.p4)(t,t),this._axisAngleVec3(xr,this._pitch-Math.PI/2,Cr,vr),this._axisAngleVec3(wr,this._yaw,vr,vr),this._axisAngleVec3(xr,this._pitch-Math.PI/2,wr,yr),this._axisAngleVec3(wr,this._yaw,yr,yr),(0,Ge.j)(vr,vr,this._distance),(0,Ge.t)(vr,vr,t),(0,Ge.t)(yr,yr,t),e.center=this.center,e.eye=(0,Ge.f)(vr,this.center,vr),e.up=yr,e.fov=this._fov}_axisAngleVec3(e,t,i,n){const r=Math.cos(t),s=Math.sin(t);return(0,Ge.j)(mr,i,r),(0,Ge.b)(gr,e,i),(0,Ge.j)(gr,gr,s),(0,Ge.j)(fr,e,(1-r)*(0,Ge.m)(e,i)),(0,Ge.g)(n,(0,Ge.g)(n,mr,gr),fr)}_lookAtOrientation(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:(0,pr.Ue)();return this._upAtLookAt(e,fr),(0,Ge.b)(mr,this.direction,fr),(0,Ge.n)(mr,mr),0===mr[0]&&0===mr[1]&&0===mr[2]&&(0,Ge.c)(mr,xr),(0,Ge.b)(gr,fr,mr),(0,Ge.n)(gr,gr),t[0]=mr[0],t[1]=gr[0],t[2]=fr[0],t[3]=mr[1],t[4]=gr[1],t[5]=fr[1],t[6]=mr[2],t[7]=gr[2],t[8]=fr[2],t}_upAtLookAt(e,t){return this.viewingMode===te.JY.Local?(0,Ge.c)(t,wr):(0,Ge.n)(t,e)}_eyeUpToPitch(e){return Math.PI-(0,fe.EU)(wr,e)}}const mr=(0,R.Ue)(),gr=(0,R.Ue)(),fr=(0,R.Ue)(),vr=(0,R.Ue)(),yr=(0,R.Ue)(),br=(0,R.Ue)(),wr=R.eG,Cr=R.IO,xr=R.E9,Tr=(0,pr.Ue)();var Sr=i(81296),Pr=i(90973);class Mr{get finished(){return this.currentTime>=this._animation.time}get time(){return this._animation.time}constructor(e){this.currentTime=(0,Ri.HA)(0),this._animation=new Pr.f((()=>new _r(e))),this._current=new _r(e)}update(e,t,i){const{source:n,target:r}=this._animation.definition,s=(0,Ge.f)(Rr,t.center,e.center),a=(0,Ge.l)(s);a>=1e-5?(s[0]/=a,s[1]/=a,s[2]/=a):(s[0]=0,s[1]=1,s[0]=0),(0,Ge.c)(n.direction,s),(0,Ge.c)(r.direction,s),n.copyFromRenderCamera(e),r.copyFromRenderCamera(t),this._current.copyFrom(n),this._animation.update(n,r,i),this.currentTime=(0,Ri.HA)(0),e.almostEquals(t)&&(this.currentTime=this._animation.time)}cameraAt(e,t){return this._animation.cameraAt(e,this._current),t=t||new Sr.Z,this._current.copyToRenderCamera(t),t}step(e,t){return this.finished||(this.currentTime=(0,Ri.HA)(this.currentTime+(0,Ri.up)(e)),this.currentTime>=this.time&&(this.currentTime=this.time)),this.cameraAt(this.currentTime/this.time,t)}}const Rr=(0,R.Ue)();var Ar;!function(e){e[e.Ready=0]="Ready",e[e.Rejected=1]="Rejected",e[e.Running=2]="Running",e[e.Stopped=3]="Stopped",e[e.Finished=4]="Finished"}(Ar||(Ar={}));let Or=class extends T.default{constructor(e){super(e),this.state=Ar.Ready}get active(){return this.state===Ar.Running}get isInteractive(){return!1}get canStop(){return!1}stopController(){return!!this.canStop&&(this.state=Ar.Stopped,!0)}finishController(){this.state=Ar.Finished}get steppingFinished(){return!1}};(0,n._)([(0,b.Cb)({constructOnly:!0})],Or.prototype,"view",void 0),(0,n._)([(0,b.Cb)({readOnly:!0})],Or.prototype,"active",null),(0,n._)([(0,b.Cb)()],Or.prototype,"state",void 0),(0,n._)([(0,b.Cb)({readOnly:!0})],Or.prototype,"isInteractive",null),Or=(0,n._)([(0,C.j)("esri.views.3d.state.controllers.CameraController")],Or);let Er=class extends Or{constructor(){super(...arguments),this._asyncResult=null}get canStop(){return!0}set asyncResult(e){this._asyncResult&&(this._asyncResult.reject((0,m.zE)()),this._asyncResult=null),this.state===Ar.Finished||this.state===Ar.Stopped?((0,p.O3)(e),this.state===Ar.Finished?e.resolve():e.reject((0,m.zE)())):this._asyncResult=e}get asyncResult(){return this._asyncResult}onControllerStart(){this.state=Ar.Running,null!=this.viewAnimation&&this.viewAnimation.when((()=>this.updateStateFromViewAnimation()),(()=>this.updateStateFromViewAnimation()))}updateStateFromViewAnimation(){null==this.viewAnimation||this.state!==Ar.Ready&&this.state!==Ar.Running||(this.viewAnimation.state===ee.Z.State.FINISHED?this.finish():this.viewAnimation.state===ee.Z.State.STOPPED&&(this.state=Ar.Stopped))}onControllerEnd(){null==this.viewAnimation||this.viewAnimation.done||(this.state===Ar.Finished?this.viewAnimation.finish():this.state===Ar.Stopped&&this.viewAnimation.stop()),this._asyncResult&&(this.state===Ar.Finished?this._asyncResult.resolve():this._asyncResult.reject((0,m.zE)()))}finish(){this.finishController()}};Er=(0,n._)([(0,C.j)("esri.views.3d.state.controllers.AnimationController")],Er);var Dr=i(88153);let Ir=class extends Er{get intersectionHelper(){return this.view.sceneIntersectionHelper}constructor(e){super(e),this.mode="interaction",this._hasTarget=!1}initialize(){this.animation=new Mr(this.view.state.viewingMode),this.viewAnimation="interaction"===this.mode?null:new ee.Z}get isInteractive(){return"interaction"===this.mode}begin(e,t){this._hasTarget=!0;const i=this.animationSettings(t);Lr.copyFrom(this.view.state.camera);const n=(0,Dr.Z8)(this.view.state.viewingMode);this.intersectionHelper.intersectRay(Lr.ray,n,Nr)&&(Lr.center=Nr),this.animation.update(Lr,e,i),this.animation.finished&&this.finish()}finish(){this.animation.currentTime=this.animation.time,super.finish()}get steppingFinished(){return this._hasTarget&&this.animation.finished}stepController(e,t){this._hasTarget&&this.animation.step(e,t)}onControllerEnd(e){this._hasTarget&&(this.animation.cameraAt(this.animation.currentTime/this.animation.time,e),this.animation.currentTime=this.animation.time),super.onControllerEnd(e)}animationSettings(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};return{apex:{maximumDistance:this.view.state.constraints.clampAltitude(1/0)/6,ascensionFactor:void 0,descensionFactor:void 0},...e,easing:"string"==typeof e.easing?or.q8[e.easing]:e.easing}}};(0,n._)([(0,b.Cb)({constructOnly:!0})],Ir.prototype,"mode",void 0),(0,n._)([(0,b.Cb)({readOnly:!0})],Ir.prototype,"isInteractive",null),Ir=(0,n._)([(0,C.j)("esri.views.3d.state.controllers.PointToPointAnimationController")],Ir);const Lr=new Sr.Z,Nr=(0,R.Ue)();var Ur=i(17768),Hr=i(68700),Fr=i(50894),Vr=i(40927),qr=i(51378);function zr(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:Zr;return[e[0],e[1],e[2],e[3]]}function Br(e,t){return Gr(e[0],e[1],e[2],t,qr.o6.get())}function Gr(e,t,i,n){let r=arguments.length>4&&void 0!==arguments[4]?arguments[4]:zr();return r[0]=e,r[1]=t,r[2]=i,r[3]=n,r}function kr(e,t,i){return(0,Ge.b)(i,e,t),(0,Ge.n)(i,i),i[3]=(0,Vr.EU)(e,t),i}const Zr=[0,0,1,0];(0,Fr.Ue)(),(0,Fr.Ue)();var jr=i(55652),Wr=i(81703);function Xr(e,t,i,n){const r=(0,Wr.iE)(t,i,Qr);return(0,bn.i)(e,r,n)}const Qr=(0,wn.Ue)();var Yr,Jr=i(76783);!function(e){e[e.Ellipsoid=0]="Ellipsoid",e[e.Silhouette=1]="Silhouette"}(Yr||(Yr={}));const Kr=[1,3e8],$r=1508e5,es={exclude:new Set([Jr.xX])};function ts(e,t,i){return i[0]=t[0]/(e.fullWidth/e.pixelRatio),i[1]=t[1]/(e.fullHeight/e.pixelRatio),i}function is(e){for(;e>Math.PI;)e-=2*Math.PI;for(;e<-Math.PI;)e+=2*Math.PI;return e}function ns(e,t,i){const n=(0,Pt.Us)(qr.MP.get(),i[3],i);null==n||(0,Pt.I6)(n,Mt.Wd)||((0,Ge.f)(Ws,e.eye,t),(0,Ge.h)(Ws,Ws,n),e.eye=(0,Ge.g)(Ws,Ws,t),(0,Ge.f)(Ws,e.center,t),(0,Ge.h)(Ws,Ws,n),e.center=(0,Ge.g)(Ws,Ws,t),e.up=(0,Ge.h)(Ws,e.up,n))}function rs(e,t,i,n){return(0,jr.BR)(e,(0,Wr.iE)(t,i,Ks),n)}function ss(e,t,i,n){const r=qr.WM.get();let s=1-i;(0,Ge.f)(r,t,e.eye);const a=(0,Ge.l)(r);let o=a*(1-s);s>=0&&o<n&&(o=n,s=-(o-a)/a),Math.abs(a-o)<1e-6||((0,Ge.j)(r,r,s),e.eye=(0,Ge.g)(Ws,e.eye,r),e.center=(0,Ge.o)(Ws,e.center,t,s))}function as(e,t,i){t.getScreenCenter(os),Xr(e,t,os,Ws)&&(t.center=Ws);const n=t.distance,r=n*i;if(Math.abs(n-r)<1e-6)return;const s=(0,Ge.j)(qr.WM.get(),t.viewForward,r);t.eye=(0,Ge.f)(Ws,t.center,s)}const os=(0,v.s1)();function ls(e,t){(0,Ge.s)(t,0,0,0);for(const i of e)(0,Ge.g)(t,t,i);(0,Ge.j)(t,t,1/e.length)}function hs(e,t,i,n){return Math.sin(e/(0,Ge.l)(t))*(i+n.radius)}function cs(e,t,i,n){return hs(Math.PI/2,t,i,n)+(e-Math.PI/2)}var ds;!function(e){e[e.Vertical=0]="Vertical",e[e.Horizontal=1]="Horizontal"}(ds||(ds={}));const us={Elevation:3e4,Angle:(0,me.Vl)(16)},ps={Pole:.95,Angle:(0,me.Vl)(18),Tilt:45},_s=(0,me.Vl)(80);function ms(e,t,i,n,r,s){const a=(0,R.Ue)(),o=(0,bn.c)();let l=!0,h=!0;return e.intersectScreen(i,a,s)?o[3]=(0,Ge.l)(a):(h=!1,t.aboveGround&&r!==Yr.Ellipsoid?o[3]=Math.max((0,Ge.l)(t.center),.9*n.radius):o[3]=(0,Ge.l)(t.eye)-t.relativeElevation,r===Yr.Silhouette?ys(o,t,i,a):l=Xr(o,t,i,a)),{sphere:o,scenePickPoint:l?a:null,hasGeometryIntersection:h}}function gs(e,t,i,n){const r=e.relativeElevation;if(r>us.Elevation&&"global"===n)return ds.Horizontal;(0,Wr.iE)(e,t,$s);const s=Math.sign(r),a=i.worldUpAtPosition(e.eye,Ws);return-s*(0,Ge.m)(a,$s.direction)<Math.sin(us.Angle)*(0,Ge.l)($s.direction)?ds.Vertical:ds.Horizontal}function fs(e,t,i){(0,Ge.f)(vs,i,t),e.eye=(0,Ge.f)(Ws,e.eye,vs),e.center=(0,Ge.f)(Ws,e.center,vs)}const vs=(0,R.Ue)();function ys(e,t,i,n){const r=(0,Wr.iE)(t,i,Ks);return null!=r&&((0,bn.e)(e,r,bs),(0,bn.i)(e,r,n)?!((0,Ge.a)(bs,r.origin)<(0,Ge.a)(n,r.origin))||((0,Ge.c)(n,bs),!1):((0,Ge.f)(ws,t.eye,t.center),(0,Ge.n)(ws,ws),(0,jr.Oy)(ws,-(0,Ge.m)((0,Ge.n)(ws,ws),bs),Cs),(0,jr.BR)(Cs,r,n),!1))}const bs=(0,R.Ue)(),ws=(0,R.Ue)(),Cs=(0,jr.Ue)();function xs(e,t,i,n,r,s){let a=0;if((0,Ge.b)(Ys,e,t),(0,Ge.f)(Xs,e,t),(0,Ge.l)(e)<=r||!n.aboveGround){(0,Ge.b)(i,Xs,n.eye);const o=(0,Ge.m)(e,t)/((0,Ge.l)(e)*(0,Ge.l)(t));if(o<.9999)a=(0,me.ZF)(o);else{const i=(0,Ge.l)((0,Ge.b)((0,R.Ue)(),e,t))/((0,Ge.l)(e)*(0,Ge.l)(t));a=(0,me.Kt)(i)}const l=Math.cos((0,me.uZ)(Ur.Q4.normalize((0,me.Vl)(s)),0,_s));a=-a-Math.max(0,(0,Ge.l)(t)-r)/(l*r)}else(0,Ge.f)(Ts,n.eye,n.center),(0,Ge.b)(i,Xs,Ts),a=-(0,Ge.l)(Xs)/r;return(0,Ge.n)(i,i),(0,Ge.j)(i,i,(0,Ge.l)(Ys)),a}const Ts=(0,R.Ue)();function Ss(e,t,i,n){let r,s;const a=Math.cos((0,me.uZ)(Ur.Q4.normalize((0,me.Vl)(n)),0,_s));return r=t>i?-(t-i)/(a*i):t<-i?Math.PI-(t+i)/(a*i):(0,me.ZF)(t/i),s=e>i?-(e-i)/(a*i):e<-i?Math.PI-(e+i)/(a*i):(0,me.ZF)(e/i),(s-r)*i}function Ps(e,t,i,n,r,s,a,o,l,h){(0,Ge.b)(Ys,e,t),(0,U.Tz)(s.up,s.eye,Us,Hs,Fs),(0,U.Tz)([0,0,1],s.eye,Is,Ls,Ns),(0,Ge.c)(i,Ls),(0,Ge.c)(n,Is),(0,Ge.n)(i,i),(0,Ge.j)(i,i,(0,Ge.l)(Ys)),(0,U.yS)(e,(0,Ge.n)(Hs,Hs),(0,Ge.n)(Fs,Fs),(0,Ge.n)(Us,Us),Vs),(0,U.yS)(t,Hs,Fs,Us,qs),function(e,t,i,n,r,s,a,o,l,h){const c=Ss(e[2],t[2],s[3],o),d=l?Ss(e[0],t[0],s[3],180):t[0]-e[0],u=Math.sin(a)*d-Math.cos(a)*c,p=Math.cos(a)*d+Math.sin(a)*c;(0,Ge.n)(Ws,r);const _=l?u/Math.sqrt(Math.abs(s[3]**2-(0,Ge.m)(i,Ws)**2)):u/s[3],m=p/Math.sqrt(Math.abs(s[3]**2-(0,Ge.m)(i,n)**2));(0,Xe.t8)(h,_,m)}(Vs,qs,e,Is,Ls,a,o,l,h,r)}function Ms(e,t,i,n,r,s,a){(0,Pt.Us)(Gs,r,n),(0,Pt.Us)(ks,a,s),(0,Pt.Jp)(Zs,Gs,ks),(0,Ge.f)(t,e,i),(0,Ge.h)(t,t,Zs),(0,Ge.g)(t,t,i)}function Rs(e,t,i,n,r,s){(0,Pt.Us)(Gs,n,i),(0,Pt.Us)(ks,s,r),(0,Pt.Jp)(Zs,Gs,ks),(0,Ge.f)(Ws,e.eye,t),(0,Ge.h)(Ws,Ws,Zs),e.eye=(0,Ge.g)(Ws,Ws,t),(0,Ge.f)(Ws,e.center,t),(0,Ge.h)(Ws,Ws,Zs),e.center=(0,Ge.g)(Ws,Ws,t),(0,Ge.f)(Ws,e.up,t),(0,Ge.h)(Ws,Ws,Zs),e.up=(0,Ge.g)(Ws,Ws,t)}function As(e,t,i,n,r,s){return(Math.abs(n)>Math.PI-ps.Angle||Math.abs(n)<ps.Angle)&&(Math.abs(e[2])<i*ps.Pole||Math.abs(t)>i)&&s.aboveGround&&r<ps.Tilt}function Os(e,t,i,n,r,s){if(s)kr(i,n,Bs),ns(t,(0,bn.g)(e),Bs);else{const s=xs(i,n,Js,t,e[3],r);ns(t,(0,bn.g)(e),Br(Js,s))}}function Es(e,t,i,n,r,s,a){const o=a?20:1;let l,h;(0,Ge.c)(js,n),Qs.copyFrom(t);for(let c=0;c<o&&(0,Ge.a)(i,js)>1e-12&&(l=(0,Ge.a)(i,js),Ps(i,js,Ls,Is,zs,Qs,e,r,s,a),Rs(Qs,(0,bn.g)(e),Is,zs[1],Ls,zs[0]),Ms(js,js,(0,bn.g)(e),Is,zs[1],Ls,zs[0]),h=(0,Ge.a)(i,js),h<l||0===c);c++)t.copyFrom(Qs)}function Ds(e,t,i,n,r,s,a,o,l){As(e.center,(0,Ge.m)(e.up,e.center),(0,Ge.l)(e.center),-Ur.Q4.normalize((0,me.Vl)(s)),a,t)?function(e,t,i,n,r,s){const{eye:a}=e;(0,U.Tz)([0,0,1],a,Is,Ls,Ns);const o=t.translation[0]*i.pan,l="zoom"===r.mode?0:t.translation[1]*i.pan,h=Math.max(Math.sqrt(Math.abs(1-(0,Ge.m)(e.center,Is)**2/(0,Ge.l)(e.center)**2)),.5),c=(Math.sin(s)*l+Math.cos(s)*o)/h,d=-Math.cos(s)*l+Math.sin(s)*o;switch((0,Pt.U1)(n.pan.matrix,n.pan.matrix,c,Is),n.pan.enabled=!0,r.mode){case"pan":(0,Pt.U1)(n.pan.matrix,n.pan.matrix,d,Ls),n.pan.enabled=!0;break;case"zoom":n.zoom=-t.translation[1]*i.zoom}}(t,i,n,o,l,-Ur.Q4.normalize((0,me.Vl)(r))):function(e,t,i,n,r){const{eye:s,viewRight:a}=e,o=(0,Ge.b)(qr.WM.get(),a,s),l=t.translation[0]*i.pan;switch(0!==l&&((0,Pt.U1)(n.pan.matrix,n.pan.matrix,-l,o),n.pan.enabled=!0),r.mode){case"pan":{const e=t.translation[1]*i.pan;0!==e&&((0,Pt.U1)(n.pan.matrix,n.pan.matrix,e,a),n.pan.enabled=!0);break}case"zoom":n.zoom=-t.translation[1]*i.zoom}}(t,i,n,o,l)}const Is=(0,R.Ue)(),Ls=(0,R.Ue)(),Ns=(0,R.Ue)(),Us=(0,R.Ue)(),Hs=(0,R.Ue)(),Fs=(0,R.Ue)(),Vs=(0,R.Ue)(),qs=(0,R.Ue)(),zs=(0,Ke.Ue)(),Bs=zr(),Gs=(0,Mt.Ue)(),ks=(0,Mt.Ue)(),Zs=(0,Mt.Ue)(),js=(0,R.Ue)(),Ws=(0,R.Ue)(),Xs=(0,R.Ue)(),Qs=new Sr.Z,Ys=(0,R.Ue)(),Js=(0,R.Ue)(),Ks={origin:(0,R.Ue)(),direction:(0,R.Ue)()},$s={origin:(0,R.Ue)(),direction:(0,R.Ue)()};let ea=class extends Ir{constructor(){super(...arguments),this._zoomLocation=(0,R.Ue)(),this._tmpCamera=new Sr.Z,this._tmpViewDir=(0,R.Ue)(),this._tmpRayDir={origin:(0,R.Ue)(),direction:(0,R.Ue)()},this._targetOnSphere=(0,R.Ue)(),this._tmpCenter=(0,R.Ue)(),this._beginCamera=new Sr.Z,this._constraintOptions=new Cn(fn.ALL_EXCEPT_COLLISION,vn.ZOOM,null,this._beginCamera),this._sphere=(0,bn.c)()}initialize(){this._intersector=(0,Dr.Z8)(this.view.state.viewingMode)}zoomStep(e,t){if(!this.active)return;const i=this.view.state;this.animation.finished?this._beginCamera.copyFrom(i.camera):this.animation.cameraAt(1,this._beginCamera);let n=!1,r=!1;this.intersectionHelper.intersectScreen(t,this._zoomLocation,0===this.view.map.ground.opacity?es:{})&&(n=e>0,r=!0),this._tmpCamera.copyFrom(i.camera),n?this.intersectionHelper.intersectRay(this._tmpCamera.ray,this._intersector,this._tmpCenter)&&(this._tmpCamera.center=this._tmpCenter):this.intersectionHelper.intersectRay(this._tmpCamera.ray,this._intersector,this._zoomLocation)?this._tmpCamera.center=this._zoomLocation:(0,Ge.c)(this._zoomLocation,this._tmpCamera.center),this._updateCamera(this._tmpCamera,e,this._zoomLocation,t,r),this.begin(this._tmpCamera)}animationSettings(){return{duration:(0,Ri.HA)(600),easing:or.cZ}}_updateCamera(e,t,i,n,r){const s=gs(e,n,this.view.renderCoordsHelper,this.view.viewingMode),a=Math.abs(this.view.camera.position.z);(0,Ge.n)(ia,e.eye),(0,Ge.j)(ia,ia,-1),(0,Wr.iE)(e,n,this._tmpRayDir),(0,Ge.n)(this._tmpRayDir.direction,this._tmpRayDir.direction);const o=(0,me.uZ)(Math.min(8,1/Math.abs((0,Ge.m)(ia,this._tmpRayDir.direction)))*a,200,$r);if(s===ds.Horizontal){let r=.6**t;this._sphere[3]=(0,Ge.l)(i),(0,Ge.f)(this._tmpViewDir,e.center,e.eye);const s=Math.min((0,Ge.l)(this._tmpViewDir),o);let a=s*r;if(r<=1&&a<4&&(a=4,r=a/s),Math.abs(s-a)<1e-6)return;const l=(0,Ge.l)(e.center);if(this._sphere[3]!==l){const t=this._sphere[3]+r*(l-this._sphere[3]);e.center=(0,Ge.j)(ta,e.center,t/l)}(0,Ge.j)(this._tmpViewDir,this._tmpViewDir,-r),e.eye=(0,Ge.g)(ta,e.center,this._tmpViewDir),lr(this.view,e,this._constraintOptions),(0,Ge.a)(i,e.center)>1e-12&&Xr(this._sphere,e,n,this._targetOnSphere)&&function(e,t,i,n,r,s,a){As(i,(0,Ge.m)(t.up,i),e[3],-Ur.Q4.normalize((0,me.Vl)(r)),s,t)?Es(e,t,i,n,-Ur.Q4.normalize((0,me.Vl)(r)),s,a):Os(e,t,i,n,s,a)}(this._sphere,e,i,this._targetOnSphere,this.view.camera.heading,this.view.camera.tilt,!0)}else{let s=.6**Math.abs(t);const a=t>0?1:-1;(0,Ge.f)(this._tmpViewDir,i,e.eye);const l=(0,Ge.l)(this._tmpViewDir),h=this.view._stage.renderView.getMinimalDepthForArea(null,n[0],n[1],this.view.state.camera,60);let c=null!=h?h:o;c=r&&t>0?Math.min(c,l):c,(0,Ge.j)(this._tmpRayDir.direction,this._tmpRayDir.direction,c),(0,Ge.g)(i,this._tmpRayDir.origin,this._tmpRayDir.direction);let d=c*s;const u=Math.max(4,1.01*e.nearFar[0]);if(t>0&&d<u&&(d=u,s=d/c),Math.abs(c-d)<1e-6)return;(0,Ge.j)(this._tmpRayDir.direction,this._tmpRayDir.direction,a*(1-s)),e.eye=(0,Ge.g)(ta,e.eye,this._tmpRayDir.direction),e.center=(0,Ge.g)(ta,e.center,this._tmpRayDir.direction)}kn(this.view,e)}};ea=(0,n._)([(0,C.j)("esri.views.3d.state.controllers.ZoomStepControllerGlobal")],ea);const ta=(0,R.Ue)(),ia=(0,R.Ue)();var na=i(39261);let ra=class extends Ir{constructor(){super(...arguments),this._zoomLocation=(0,R.Ue)(),this._tmpCamera=new Sr.Z,this._tmpRayDir=(0,R.Ue)(),this._tmpCenter=(0,R.Ue)(),this._beginCamera=new Sr.Z,this._constraintOptions=new Cn(fn.ALL,vn.ZOOM,null,this._beginCamera)}zoomStep(e,t){if(!this.active)return;const i=this.view.state;this.animation.finished?this._beginCamera.copyFrom(i.camera):this.animation.cameraAt(1,this._beginCamera),this._tmpCamera.copyFrom(i.camera);const n=(0,Dr.Z8)(this.view.state.viewingMode);let r=!1;e>0?(r=this.intersectionHelper.intersectScreenFreePointFallback(t,this._zoomLocation,0===this.view.map.ground.opacity?es:{}),this.intersectionHelper.intersectRay(this._tmpCamera.ray,n,this._tmpCenter)&&(this._tmpCamera.center=this._tmpCenter)):this.intersectionHelper.intersectRay(this._tmpCamera.ray,n,this._zoomLocation)?this._tmpCamera.center=this._zoomLocation:(0,Ge.c)(this._zoomLocation,this._tmpCamera.center);const s=.6**e;let a=this.view._stage.renderView.getMinimalDepthForArea((0,na.$L)(this.view),t[0],t[1],this.view.state.camera,60);(0,Ge.f)(oa,this._tmpCamera.eye,this._zoomLocation),(0,Ge.n)(oa,oa);const o=(0,me.uZ)(Math.min(8,1/Math.abs((0,Ge.m)(aa,oa)))*Math.abs(this.view.camera.position.z),200,$r);if(a=null!=a?a:o,a){const e=(0,R.Ue)();(0,Ge.f)(e,this._zoomLocation,this._tmpCamera.eye),(a<(0,Ge.l)(e)||!r)&&((0,Ge.n)(e,e),(0,Ge.g)(this._zoomLocation,this._tmpCamera.eye,(0,Ge.j)(e,e,a)))}this._updateCamera(this._tmpCamera,s,this._zoomLocation),this.begin(this._tmpCamera)}animationSettings(){return{duration:(0,Ri.HA)(600),easing:or.cZ}}_updateCamera(e,t,i){(0,Ge.f)(this._tmpRayDir,i,e.eye);const n=(0,Ge.l)(this._tmpRayDir);let r=n*t;const s=t<=1,a=Math.max(4,1.01*e.nearFar[0]);0!==r&&(s&&r<a&&(r=a,t=r/n),Math.abs(n-r)<1e-6||((0,Ge.j)(this._tmpRayDir,this._tmpRayDir,t),e.eye=(0,Ge.f)(sa,i,this._tmpRayDir),e.center=(0,Ge.o)(sa,e.center,i,1-t),lr(this.view,e,this._constraintOptions)))}};ra=(0,n._)([(0,C.j)("esri.views.3d.state.controllers.ZoomStepControllerLocal")],ra);const sa=(0,R.Ue)(),aa=(0,R.al)(0,0,1),oa=(0,R.Ue)();var la=i(45371),ha=i(41722);class ca extends la.a{constructor(e,t){super(!0),this._view=e,this.registerIncoming("double-click",t,(e=>this._handleDoubleClick(e)))}_handleDoubleClick(e){const t=e.data;if((0,ha.h)(t,"primary")){const i=this._view.state.isGlobal?new ea({view:this._view,mode:"animation"}):new ra({view:this._view,mode:"animation"});this._view.state.switchCameraController(i),i.zoomStep(Math.log(.5)/Math.log(.6),(0,v.s1)(t.x,t.y)),e.stopPropagation()}}}var da=i(53866),ua=i(848),pa=i(68860);class _a{constructor(e,t){this._elevationProvider=e,this._referenceEllipsoid=(0,Ze.Iu)(t),this._unitInMeters=(0,pa.c9)(t,this._referenceEllipsoid.metersPerDegree)}compute(e,t,i,n,r){var s;r||(r={near:0,far:0});let a=e[2]*this._unitInMeters;const o=a,l=a-n,h=null===(s=this._elevationProvider)||void 0===s?void 0:s.visibleElevationBounds;h&&(a=l>=0?o-this._unitInMeters*h.min:this._unitInMeters*h.max-o);const c={x:(i=null!=i?i:new da.Z({xmin:0,ymin:0,zmin:0,xmax:0,ymax:0,zmax:0})).xmax-i.xmin,y:i.ymax-i.ymin,z:4*Math.max(i.xmax-i.xmin,i.ymax-i.ymin)},d=Math.max(c.x,c.y,c.z);(0,Ge.f)(Ca,t,e),wa[0]=Ca[0]>0?i.xmax:i.xmin,wa[1]=Ca[1]>0?i.ymax:i.ymin,wa[2]=Ca[2]>0?d/2:-d/2,(0,Ge.f)(wa,wa,e),(0,Ge.n)(Ca,Ca);const u=1.1*(0,Ge.m)(wa,Ca)*this._unitInMeters,p=Math.sqrt(a*(a+2*this._referenceEllipsoid.radius)),_=Math.max(i.xmax-i.xmin,i.ymax-i.ymin),m=_*ya*this._unitInMeters,g=_*ba*this._unitInMeters,f=(0,me.uZ)((a-g)/(m-g),0,1)**3,v=Math.min((0,me.t7)(p,u,f),p)*Math.max(Math.log(Math.abs(l)),1);return ga(Math.min(v,Math.max(34064e4,d))/this._unitInMeters,fa,this._unitInMeters,r)}}class ma{constructor(e){this._referenceEllipsoid=(0,Ze.Iu)(e)}compute(e,t,i,n,r){r||(r={near:0,far:0});const s=(0,Ge.l)(e),a=s-this._referenceEllipsoid.radius,o=this._referenceEllipsoid.radius+Math.min(0,n),l=Math.abs(a-n),h=Math.max(l,Math.abs(a)),c=Math.sqrt(h*(h+2*o)),d=s+this._referenceEllipsoid.radius;return ga(1.2*(0,me.t7)(c,d,(0,Je.yx)(h)),(0,me.uZ)(2e4-(Math.log(h)-7.983)/9.011*19900,100,2e4),1,r)}}function ga(e,t,i,n){const r=va/i;return e/t>r?(n.far=e,n.near=n.far/t):(n.near=r,n.far=n.near*t),n}const fa=2e4,va=2,ya=.001,ba=1e-4,wa=(0,R.Ue)(),Ca=(0,R.Ue)();let xa=class extends T.default{constructor(e){super(e)}initialize(){this.addHandles(this.view.basemapTerrain.on("elevation-change",(e=>this._handleElevationChangeEvent(e))))}_handleElevationChangeEvent(e){if(this.view.state.cameraController)return;const t=this.view.state.camera;null!=e.spatialReference&&(0,Gn.lM)(this.view,t,e.extent,e.spatialReference)&&this._applyToCurrentCamera()}_applyToCurrentCamera(){this.view.state.updateCamera((e=>kn(this.view,e,Bn.EYE_AND_CENTER)))}};(0,n._)([(0,b.Cb)({constructOnly:!0})],xa.prototype,"view",void 0),xa=(0,n._)([(0,C.j)("esri.views.3d.state.SurfaceCollisionConstraint")],xa);let Ta=class extends T.default{constructor(e){super(e),this.nearFarHeuristic=function(e,t,i){return e===te.JY.Global?new ma(i):new _a(t,i)}(e.view.state.viewingMode,e.view.basemapTerrain,e.view.renderCoordsHelper.spatialReference)}initialize(){this.addHandles([(0,g.watch)((()=>{var e,t;return[null===(e=this.view.constraints)||void 0===e||null===(e=e.clipDistance)||void 0===e?void 0:e.near,null===(t=this.view.constraints)||void 0===t||null===(t=t.clipDistance)||void 0===t?void 0:t.far]}),(()=>this._clipDistanceNearFarChanged())),(0,g.watch)((()=>{var e;return null===(e=this.view.constraints)||void 0===e||null===(e=e.clipDistance)||void 0===e?void 0:e.mode}),(()=>this._updateNearFar())),this.view.state.events.on("before-camera-change",(e=>this._updateCameraNearFar(e))),(0,g.watch)((()=>this.view.renderDataExtent),(()=>this._updateNearFar()),g.sync),(0,g.watch)((()=>{var e,t;return[null===(e=this.view.constraints)||void 0===e||null===(e=e.altitude)||void 0===e?void 0:e.min,null===(t=this.view.constraints)||void 0===t||null===(t=t.altitude)||void 0===t?void 0:t.max]}),(()=>this._updateAltitude()),g.sync),(0,g.watch)((()=>{var e;return null===(e=this.view.constraints)||void 0===e||null===(e=e.tilt)||void 0===e?void 0:e.max}),(()=>this._updateTiltMax()),g.sync),(0,g.watch)((()=>{var e;return null===(e=this.view.constraints)||void 0===e||null===(e=e.tilt)||void 0===e?void 0:e.mode}),(()=>this._updateTilt()),g.sync),(0,g.watch)((()=>{var e;return null===(e=this.view.state)||void 0===e?void 0:e.camera}),(()=>this._updateTiltAutoMax()),g.sync),(0,g.watch)((()=>{var e,t;return[null===(e=this.view.map)||void 0===e||null===(e=e.ground)||void 0===e||null===(e=e.navigationConstraint)||void 0===e?void 0:e.type,null===(t=this.view.state)||void 0===t||null===(t=t.constraints)||void 0===t||null===(t=t.collision)||void 0===t?void 0:t.enabled]}),(()=>this._updateCollision()),g.sync)]),this.view.state.isLocal&&this.addHandles((0,g.watch)((()=>this.view.renderDataExtent),(e=>this._updateLocalSurfaceDistance(e)),g.initial)),this._updateNearFar(),this.view.state.viewingMode!==te.JY.Local&&this._updateAltitude(),this._updateTilt(),this._updateCollision(),this._set("surfaceCollisionConstraint",new xa({view:this.view}))}destroy(){this.surfaceCollisionConstraint&&(this.surfaceCollisionConstraint.destroy(),this._set("surfaceCollisionConstraint",null))}_clipDistanceNearFarChanged(){var e;const t=null===(e=this.view.constraints)||void 0===e?void 0:e.clipDistance;t&&"auto"!==t.mode&&this.view.state.updateCamera((e=>Sa(e,t)))}_updateNearFar(){this.view.state.updateCamera((e=>this._updateCameraNearFar(e)))}_updateCameraNearFar(e){const t=this.view.constraints&&this.view.constraints.clipDistance;"manual"===(t?t.mode:"auto")?Sa(e,t):this._updateCameraNearFarAuto(e,t)}_updateCameraNearFarAuto(e,t){this.nearFarHeuristic.compute(e.eye,e.center,this.view.renderDataExtent,(0,Gn.wH)(this.view,e.eye),e),t&&t.autoUpdate(e.near,e.far)}_updateCollision(){var e;const t=null===(e=this.view.map)||void 0===e||null===(e=e.ground)||void 0===e||null===(e=e.navigationConstraint)||void 0===e?void 0:e.type,i=!t||"stay-above"===t,n=this.view.state.constraints.collision;if(i!==n.enabled){n.enabled=i,i&&this._reapplyConstraints(fn.COLLISION);const e=this.view.constraints&&this.view.constraints.tilt;e&&"auto"!==e.mode||this._updateTiltAuto()}}_updateAltitude(){const e=this.view.constraints&&this.view.constraints.altitude;e&&this.view.state.viewingMode!==te.JY.Local?this.view.state.constraints.altitude={min:e.min,max:e.max}:this.view.state.constraints.altitude=null,this._reapplyConstraints()}_updateTiltMax(){const e=this.view.constraints&&this.view.constraints.tilt;e&&"auto"!==e.mode&&(this._updateTiltManual(e),this._reapplyConstraints())}_updateTilt(){const e=this.view.constraints&&this.view.constraints.tilt;"manual"===(e?e.mode:"auto")?this._updateTiltManual(e):this._updateTiltAuto(),this._reapplyConstraints()}_updateTiltManual(e){const t=this.view.state.constraints;t.tilt=t.createConstantMaxTilt((0,me.Vl)(e.max))}_updateTiltAuto(){const e=this.view.state.constraints;e.tilt=e.createDefaultTilt(),this._updateTiltAutoMax()}_updateTiltAutoMax(){const e=this.view.constraints&&this.view.constraints.tilt;if(!e||"auto"!==e.mode)return;const t=this.view.state.constraints;if(t.tilt){const i=t.tilt(this.view.state.camera.distance).max;e.autoUpdate((0,me.BV)(i))}}_updateLocalSurfaceDistance(e){if(null==e)return;let t=Math.max(e.width,e.height);if(t<=0)return;null!=e.zmax&&null!=e.zmin&&(t=Math.max(t,e.zmax-e.zmin));const i=this.view.state,n=3*t/Math.atan(i.camera.fov/2);n!==i.constraints.distance&&(i.constraints.distance=n)}_reapplyConstraints(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:fn.ALL;this.view.state.updateCamera((t=>lr(this.view,t,new Cn(e,vn.NONE,null))))}};function Sa(e,t){t&&(e.near=t.near,e.far=t.far)}(0,n._)([(0,b.Cb)({constructOnly:!0})],Ta.prototype,"view",void 0),(0,n._)([(0,b.Cb)({readOnly:!0})],Ta.prototype,"surfaceCollisionConstraint",void 0),Ta=(0,n._)([(0,C.j)("esri.views.3d.state.ConstraintsManager")],Ta);var Pa=i(38161);let Ma=class extends Or{set desiredCamera(e){this._set("desiredCamera",e.clone())}constructor(e){super(e)}get canStop(){return!0}get constraintEnabled(){return this.view.state.constraints.collision.enabled}onControllerStart(){this.state=Ar.Running,this.addHandles(this.view.basemapTerrain.on("elevation-change",(e=>this._handleElevationChangeEvent(e)))),this._applyCorrection()}onControllerEnd(){this.removeAllHandles()}stepController(){}_handleElevationChangeEvent(e){(null==e.spatialReference||(0,Gn.lM)(this.view,this.desiredCamera,e.extent,e.spatialReference))&&this._applyCorrection()}_applyCorrection(){this.view.state.updateCamera((e=>{e.copyViewFrom(this.desiredCamera),kn(this.view,e,Bn.EYE_AND_CENTER)||this.constraintEnabled||(this.state=Ar.Stopped)}))}};(0,n._)([(0,b.Cb)({constructOnly:!0})],Ma.prototype,"desiredCamera",null),Ma=(0,n._)([(0,C.j)("esri.views.3d.state.controllers.SurfaceCollisionCorrectionController")],Ma);var Ra=i(90647);class Aa{constructor(e,t,i){this._target=e,this._options=t,this.view=i,this.state="pending",this._animationController=null,this.promise=new Promise(((e,t)=>{this._resolveCallback=e,this._rejectCallback=t;const i=new AbortController;null!=this._options.signal&&(0,m.fu)(this._options.signal,(()=>{this.abort()})),this._abortController=i,this._waitForReady()}))}_resolve(e){if("finished"!==this.state)return this.state="finished",this._resolveCallback(e)}_reject(e){if("finished"!==this.state)return this.state="finished",this._rejectCallback(e)}abort(){let e=arguments.length>0&&void 0!==arguments[0]&&arguments[0];this._abortController.abort(),"wait-for-animation-finish"===this.state&&!e&&null!=this._animationController&&this.view.state.cameraController===this._animationController&&this._animationController.active&&this._animationController.stopController(),this._reject((0,m.zE)())}async _waitForReady(){if(this.state="wait-for-ready",!this.view.ready)try{await(0,g.whenOnce)((()=>this.view.ready),this._abortController.signal)}catch(e){return this._reject(e)}this._createViewPoint()}async _createViewPoint(){if("finished"!==this.state){this.state="wait-for-viewpoint",this._animationController=this._options.animate?this._getAnimationController():null;try{const e=await(0,Ra.Ue)(this.view,this._target,this._abortController.signal);if("finished"===this.state)return;const t=e?this._getCameraFromViewpoint(e):null;if(null==t)return;if(this._options.animate){if(null==this._animationController)return;this._startAnimation(t,this._animationController)}else this.view.stateManager.setStateCamera(t.camera,{applyConstraints:!t.isFullySpecified,positionAndOrientationOnly:!0,doNotCancelGoToOperation:!0}),this._resolve()}catch(e){this._reject(e)}}}_getCameraFromViewpoint(e){const t=!!(this._target instanceof s.Z&&this._target.camera||this._target instanceof r.Z),i=e.camera;if(null==i)return null;if(!this.view.stateManager.isCompatible(i)){var n;const e=i.position,t=e&&e.spatialReference,r=t?t.wkid:"none",s=null===(n=this.view.spatialReference)||void 0===n?void 0:n.wkid;return this._reject(new l.Z("GotoAnimation:incompatible-spatialreference","Resulting camera has an incompatible spatial reference (camera: ".concat(r,", view: ").concat(s,")"),{camera:i})),null}const a=(0,B.n3)(this.view,i);return null==a?(this._reject(new l.Z("GotoAnimation:invalid-camera","Resulting camera is invalid")),null):{viewpoint:e,camera:a,isFullySpecified:t}}_startAnimation(e,t){this.state="wait-for-animation-finish";const i=t.viewAnimation;if(null==i)return void this._reject(new l.Z("GotoAnimation:missing-animation","Unreachable code in view.stateManager"));if(i.update(e.viewpoint,"running"),!t.active||null==t.viewAnimation||t.viewAnimation.target!==e.viewpoint||this.view.state.cameraController!==t)return this.abort();let n;e.isFullySpecified?(n=new Ma({view:this.view,desiredCamera:e.camera}),kn(this.view,e.camera,Bn.EYE_AND_CENTER)):lr(this.view,e.camera),t.begin(e.camera,this._options);const r=e=>{if(null!=this.view.state)switch(t.state){case Ar.Finished:switch(this.state){case"pending":case"wait-for-ready":case"wait-for-viewpoint":case"wait-for-animation-finish":this._resolve()}break;case Ar.Ready:case Ar.Rejected:case Ar.Running:case Ar.Stopped:switch(this.state){case"pending":case"wait-for-ready":case"wait-for-viewpoint":case"wait-for-animation-finish":this._reject(e)}}};i.when((()=>{const i=this.view.state.cameraController;n&&(i&&i.active?i instanceof Ir&&null!=i.viewAnimation&&i.viewAnimation.target===e.viewpoint&&(this.view.state.cameraController=n):null!=t.viewAnimation&&t.viewAnimation.target===e.viewpoint&&t.state===Ar.Finished&&(this.view.state.cameraController=n))}),(e=>r(e))),t.asyncResult={resolve:()=>r(),reject:e=>r(e)}}_getAnimationController(){let e=null,t=null;const i=this.view.state.cameraController;return i instanceof Ir&&(i.updateStateFromViewAnimation(),i.active&&(e=i,t=e.viewAnimation)),null!=e||(e=new Ir({view:this.view,mode:"animation"}),t=e.viewAnimation,this.view.state.switchCameraController(e))?e:(null!=t&&t.stop(),this._reject(new l.Z("GotoAnimation:goto-cannot-interrupt","Cannot start an animation while interacting")),null)}}var Oa=i(76419),Ea=i(41947),Da=i(2263),Ia=i(75248);let La=class extends T.default{constructor(e){super(e),this.ready=!1,this._windowDevicePixelRatio=1,this._devicePixelRatioOverride=null,this._idleTimeout=ka,this.test={viewStateManager:this,contentCameraResetState:new Map,setDevicePixelRatio:e=>this._devicePixelRatioOverride=e,renderState:null,get maximumPixelRatio(){return this.viewStateManager.view.qualitySettings.maximumPixelRatio},get updatingIgnoreRenderState(){return null!=this.renderState},get idleTimeoutEnabled(){return this.viewStateManager._idleTimeout>0},set idleTimeoutEnabled(e){this.viewStateManager._idleTimeout=e?ka:0}},this._propertiesPool=new Oa.L({frustum:Pa.i},this),this._cameraSetByUser=!1,this._gotoOperation=null,this._cameraChangeTime=0,this._tmpCanvasSize=new Na}initialize(){this._cameraChangeTime=performance.now(),this.addHandles([(0,g.on)((()=>this.view.state.events),"before-camera-change",(e=>e&&this._updateElevation(e))),(0,g.watch)((()=>{var e;return null===(e=this.view.state)||void 0===e?void 0:e.camera}),((e,t)=>this._cameraChangedHandler(e,t)),g.sync)]),(0,g.when)((()=>{var e;return null===(e=this.view.state)||void 0===e?void 0:e.camera}),(e=>this._updateElevation(e)),{once:!0,sync:!0}),this.addHandles([(0,f.A)({prepare:()=>this._prepareFrame()}),(0,g.watch)((()=>this.view.state.cameraController),(()=>{this._cameraSetByUser=!0,this.removeHandles(Ba)})),(0,g.on)((()=>this.view.state.events),"camera-projection-changed",(()=>this.notifyChange("scale")))])}destroy(){this.exit(),this._propertiesPool=(0,p.SC)(this._propertiesPool)}get camera(){const e=this._get("camera");if(!this.ready)return e;const t=(0,B.l0)(this.view,this.view.state.camera,Va);return t&&e&&t.equals(e)?e:t.clone()}set camera(e){var t,i;this._updatePropertyBeforeReady("camera",e)||(null!==(t=this.view.elevationProvider)&&void 0!==t&&t.enableCache(!0),this.setStateCamera((0,B.n3)(this.view,e),{applyConstraints:!1})||u.Z.getLogger(this).error("#camera=","Invalid camera",e),null===(i=this.view.elevationProvider)||void 0===i||i.enableCache(!1))}get contentCamera(){const e=this._get("contentCamera");if(!this.ready)return e;const t=(0,B.l0)(this.view,this.view.state.contentCamera,Va);return t&&e&&t.equals(e)?e:t.clone()}set contentCamera(e){if(this._updatePropertyBeforeReady("contentCamera",e))return;const t=(0,B.n3)(this.view,e);null!=t?(this._updateElevation(t),this.view.state.contentCamera=t):this.view.state.contentCamera=null}installContentCameraReset(e){if(this.removeHandles(Ga),this.test.contentCameraResetState.clear(),!this.view.state.fixedContentCamera)return!1;const t=this.zoom,i=this.view.state.camera.distance**2,n=(0,R.nI)(this.view.state.camera.center),r=e.sticky?this.contentCamera.clone():null;return this.addHandles([(0,g.watch)((()=>this.contentCamera),(()=>{e.sticky||(this.removeHandles(Ga),this.test.contentCameraResetState.clear())})),(0,g.watch)((()=>this.zoom),(e=>{void 0!==e&&void 0!==t&&(this.test.contentCameraResetState.set("view.zoom",Math.abs(e-t)/2),Math.abs(e-t)>2?this.contentCamera=null:this.view.state.fixedContentCamera||(this.contentCamera=r))})),(0,g.watch)((()=>this.view.state.camera),(e=>{const t=(0,Ge.a)(n,e.center);this.test.contentCameraResetState.set("camera.center",t/i),t>i?this.contentCamera=null:this.view.state.fixedContentCamera||(this.contentCamera=r)}))],Ga),!0}get center(){return this.ready?this.view.pointsOfInterest.centerOnContent.location:this._get("center")}set center(e){var t;this._updatePropertyBeforeReady("center",e)||(e?this.isCompatible(e)?this.setStateCamera(this._centerToCamera(e),{applyConstraints:!0})?this.view.pointsOfInterest.centerOnContent.runTask():u.Z.getLogger(this).error("#center=","Invalid center",e):u.Z.getLogger(this).error("#center=","Center has an incompatible spatial reference (center: "+(e.spatialReference?e.spatialReference.wkid:"none")+", view: "+(null===(t=this.view.spatialReference)||void 0===t?void 0:t.wkid)+")",e):u.Z.getLogger(this).error("#center=","Center may not be null or undefined"))}get extent(){if(!this.ready)return this._get("extent");const e=this.view,t=(0,B.HH)(e,e.state.camera,e.pointsOfInterest.centerOnContent.renderLocation);return null!=t?t:this._get("extent")}set extent(e){var t;this._updatePropertyBeforeReady("extent",e)||(e?this.isCompatible(e)?this.setStateCamera(this._extentToCamera(e),{applyConstraints:!0})||u.Z.getLogger(this).error("#extent=","Invalid extent",e):u.Z.getLogger(this).error("#extent=","Extent has an incompatible spatial reference (extent: "+(e.spatialReference?e.spatialReference.wkid:"none")+", view: "+(null===(t=this.view.spatialReference)||void 0===t?void 0:t.wkid)+")",e):u.Z.getLogger(this).error("#extent=","Extent may not be null or undefined"))}get frustum(){const e=this._propertiesPool.get("frustum");return e.renderCoordsHelper=this.view.renderCoordsHelper,e.update(this.view.state.camera),e}get constraintsManager(){return this._constraintsManager}get _initialViewpoint(){var e;const t=this.view.map;return t&&"initialViewProperties"in t?null===(e=t.initialViewProperties)||void 0===e?void 0:e.viewpoint:void 0}get hasInitialView(){return!!this._initialViewpoint}get scale(){if(this.ready){const e=this.view.pointsOfInterest.centerOnContent;return(0,B.Xt)(this.view,e.distance,e.location.latitude)}return this._get("scale")}set scale(e){this._updatePropertyBeforeReady("scale",e)||this.setStateCamera(this._scaleToCamera(e),{applyConstraints:!0})||u.Z.getLogger(this).error("#scale=","Invalid scale",e)}get terrainScale(){if(!this.ready)return this._get("scale");const e=this.view,t=e.basemapTerrain.tilingScheme,i=e.pointsOfInterest.cameraOnSurface.scale;if(!t||!i)return this._get("scale");const n=e.state.contentCamera;let r=(0,B.t_)(e,n.eye,n.viewForward,n.up).tilt;r>90&&(r=180-r);const s=2*(r/90)**2,a=t.levelAtScale(i)-s;return a<0?this._get("scale"):t.scaleAtLevel(a)}get padding(){if(!this.ready)return this._get("padding");const e=this.view.state.camera,t=e.padding,i=e.pixelRatio,n=this._get("padding"),r=Math.round(t[Ea.Np.TOP]/i),s=Math.round(t[Ea.Np.RIGHT]/i),a=Math.round(t[Ea.Np.BOTTOM]/i),o=Math.round(t[Ea.Np.LEFT]/i);return null!=n&&n.top===r&&n.right===s&&n.bottom===a&&n.left===o?n:{top:r,right:s,bottom:a,left:o}}set padding(e){this._updatePropertyBeforeReady("padding",e)||(this._paddingToArray(e,this.view.state.camera.pixelRatio,za),this.view.state.updateCamera((e=>e.padding=za)))}_paddingToArray(e,t,i){e?(0,Qe.s)(i,e.top||0,e.right||0,e.bottom||0,e.left||0):(0,Qe.s)(i,0,0,0,0);for(let n=0;n<4;n++)i[n]=Math.round(i[n]*t)}get screenCenter(){const e=this.padding;return(0,v.vW)((this.view.width-(e.left+e.right))/2+e.left,(this.view.height-(e.top+e.bottom))/2+e.top)}get viewpoint(){return this.ready?(0,Ra.Q8)(this.view,this.camera):this._get("viewpoint")}set viewpoint(e){if(!this._updatePropertyBeforeReady("viewpoint",e))if(e)if(this.isCompatible(e))this.setStateCamera(this._viewpointToCamera(e),{applyConstraints:!e.camera})||u.Z.getLogger(this).error("#viewpoint=","Invalid viewpoint",e);else{var t;const i=null!=e.camera?e.camera.position:e.targetGeometry,n=null!=i&&i.spatialReference;u.Z.getLogger(this).error("#viewpoint=","Viewpoint has an incompatible spatial reference (viewpoint: "+(n?n.wkid:"none")+", view: "+(null===(t=this.view.spatialReference)||void 0===t?void 0:t.wkid)+")",e)}else u.Z.getLogger(this).error("#viewpoint=","Viewpoint may not be null or undefined")}get zoom(){return this.ready?(0,B.sO)(this.view,this.scale):this._get("zoom")}set zoom(e){this._updatePropertyBeforeReady("zoom",e)||void 0===e||this.setStateCamera(this._zoomToCamera(e),{applyConstraints:!0})||u.Z.getLogger(this).error("#zoom=","Invalid zoom",e)}_computeCanvasSize(){var e;if(this._devicePixelRatioOverride)return this.view.state.contentPixelRatio=this._devicePixelRatioOverride,this._tmpCanvasSize.width=Math.round(this.view.surface.clientWidth*this._devicePixelRatioOverride),this._tmpCanvasSize.height=Math.round(this.view.surface.clientHeight*this._devicePixelRatioOverride),this._tmpCanvasSize.pixelRatio=this._devicePixelRatioOverride,this._tmpCanvasSize;const t=Math.min(this._windowDevicePixelRatio,this.view.qualitySettings.maximumPixelRatio),i=(this._usePhysicalPixelRendering?this._windowDevicePixelRatio:t)*this.view.resolutionScale;this._tmpCanvasSize.width=Math.round(this.view.surface.clientWidth*i),this._tmpCanvasSize.height=Math.round(this.view.surface.clientHeight*i);const n=null===(e=this.view._stage.renderView.renderingContext)||void 0===e?void 0:e.parameters.maxTextureSize;return n&&(0,Ft.d)(this._tmpCanvasSize,n),this._tmpCanvasSize.pixelRatio=this._tmpCanvasSize.width>0?this._tmpCanvasSize.width/this.view.surface.clientWidth*.5+this._tmpCanvasSize.height/this.view.surface.clientHeight*.5:i,this.view.state&&(this.view.state.contentPixelRatio=Math.min(this._windowDevicePixelRatio,this.view.qualitySettings.maximumPixelRatio)),this._tmpCanvasSize}get _rasterPixelRatio(){return null!=this._devicePixelRatioOverride?this._devicePixelRatioOverride:this._usePhysicalPixelRenderingAny?this._windowDevicePixelRatio:Math.min(this._windowDevicePixelRatio,this.view.qualitySettings.maximumPixelRatio)}get _usePhysicalPixelRendering(){var e,t;return null!==(e=null===(t=this.view)||void 0===t||null===(t=t._stage)||void 0===t?void 0:t.renderer.isFeatureEnabled(Da.Y.PhysicalPixelRendering))&&void 0!==e&&e}get _usePhysicalPixelRenderingAny(){var e;const t=null===(e=this.view)||void 0===e||null===(e=e._stage)||void 0===e?void 0:e.renderer;return t&&(t.isFeatureEnabled(Da.Y.PhysicalPixelRendering,Ia.n.IDLE)||t.isFeatureEnabled(Da.Y.PhysicalPixelRendering,Ia.n.INTERACTING)||t.isFeatureEnabled(Da.Y.PhysicalPixelRendering,Ia.n.ANIMATING))}preinit(e){var t,i;return!(this._isOverridden("center")&&!(0,E.isLoadedOrLoadFor)(this.center.spatialReference,e))&&!(this._isOverridden("camera")&&!(0,E.isLoadedOrLoadFor)(this.camera.position.spatialReference,e))&&!(this._isOverridden("extent")&&!(0,E.isLoadedOrLoadFor)(this.extent.spatialReference,e))&&!!(!this._isOverridden("viewpoint")||(0,E.isLoadedOrLoadFor)(null===(t=this.viewpoint.targetGeometry)||void 0===t?void 0:t.spatialReference,e)&&(0,E.isLoadedOrLoadFor)(null===(i=this.viewpoint.camera)||void 0===i||null===(i=i.position)||void 0===i?void 0:i.spatialReference,e))}init(){this._constraintsManager=new Ta({view:this.view}),this._prepareFrame();const e=this._getInitialProperties();this._cameraSetByUser=!1,this._set("ready",!0);for(const t of e)this.set(t.name,t.value);if(!this._cameraSetByUser){const e=this._initialViewpoint||this.view.initialExtent;e&&this.isCompatible(e)?this._setInitialView(e):this.view.state.viewingMode===te.JY.Local&&this.addHandles((0,g.when)((()=>this.view.basemapTerrain.ready),(()=>{this.removeHandles(Ba),this._setInitialView(this.view.dataExtent)}),{once:!0,initial:!0}),Ba)}}exit(){this._cancelGoToOperation(),this.ready&&(this._override("padding",this.padding),this._set("ready",!1),this._clearOverride("hasInitialView"),this._cameraSetByUser=!1,this.removeHandles(Ba),this._constraintsManager=(0,p.SC)(this._constraintsManager))}async goTo(e,t){return t={animate:!0,...t},null!=this._gotoOperation&&this._gotoOperation.abort(t.animate),this._gotoOperation=new Aa(e,t,this.view),this.view.resourceController.scheduler.stopFrame(),this._gotoOperation.promise}debugSetCameraOnContent(){this.setStateCamera((0,Gn.dP)(this.view),{applyConstraints:!1})}step(e){const t=this.view.state,i=null===t||void 0===t?void 0:t.cameraController;i&&(t.updateCamera((t=>i.stepController(e,t))),i.steppingFinished&&i.finishController())}_cancelGoToOperation(){null!=this._gotoOperation&&(this._gotoOperation.abort(),this._gotoOperation=null)}_getInitialProperties(){const e=new Set,t=[];for(const{propertyName:i,overrides:n}of Ha){const r=e.has(i),s=this._isOverridden(i);!r&&s&&t.push({name:i,value:this._get(i)}),this._clearOverride(i),(r||s)&&n.forEach((t=>e.add(t)))}return t}_setInitialView(e){if(null==e||this._cameraSetByUser)return;if(e instanceof r.Z)return void this.setStateCamera((0,B.n3)(this.view,e),{applyConstraints:!1});if(e instanceof s.Z){if(e.targetGeometry instanceof da.Z){const t=(0,B.S9)(this.view,e.targetGeometry,0,.5,B.Q8.LOCKED);return void(null!=t&&this.setStateCamera((0,B.n3)(this.view,t),{applyConstraints:!0}))}const t={applyConstraints:!e.camera},i=this._viewpointToCamera(e);return void this.setStateCamera(i,t)}const t=(0,B.S9)(this.view,e,0,.5,B.Q8.LOCKED);null!=t&&this.setStateCamera((0,B.n3)(this.view,t),{applyConstraints:!0})}_updatePropertyBeforeReady(e,t){return!this.ready&&(this._override(e,t),t&&Ua.has(e)&&this._override("hasInitialView",!0),!0)}isCompatible(e){return null!=e&&(e instanceof s.Z?e.camera?this.isCompatible(e.camera):this.isCompatible(e.targetGeometry):e instanceof r.Z?this.isCompatible(e.position):e.spatialReference&&!(0,E.requiresLoad)(e.spatialReference,this.view.spatialReference))}_getPreservingHeadingTilt(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:Fa;return this._cameraSetByUser?(e.heading=this.camera.heading,e.tilt=this.camera.tilt):(e.heading=0,e.tilt=.5),e}_centerPointAtDistanceToCamera(e,t){let i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:qa;const{heading:n,tilt:r}=this._getPreservingHeadingTilt(),s=(0,B.P$)(this.view,n,r,e,t,B.Q8.ADJUST);return null==s?null:(i.copyFrom(this.view.state.camera),i.eye=s.eye,i.center=s.center,i.up=s.up,i)}_centerToCamera(e){const t=this.view.pointsOfInterest.centerOnContent;t.runTask();const i=t.distance;return this._centerPointAtDistanceToCamera(e,i)}_extentToCamera(e){const{heading:t,tilt:i}=this._getPreservingHeadingTilt(),n=(0,B.S9)(this.view,e,t,i,B.Q8.ADJUST,Va);return n?(0,B.n3)(this.view,n):null}_scaleToCamera(e){if(null==e)return null;const t=this.view.pointsOfInterest.centerOnContent;t.runTask();const i=t.renderLocation,n=t.location.latitude,r=(0,B._U)(this.view,e,n);return this._centerPointAtDistanceToCamera(i,r)}_zoomToCamera(e){return this._scaleToCamera((0,B.EO)(this.view,e))}_viewpointToCamera(e){return(0,B.n3)(this.view,(0,Ra.QI)(this.view,e))}setStateCamera(e,t){return!(null==e||!this.view.state.stopActiveCameraController())&&(this._cameraSetByUser=!0,t.doNotCancelGoToOperation||this._cancelGoToOperation(),this.view.state.updateCamera((i=>{t.positionAndOrientationOnly?(i.eye=e.eye,i.center=e.center,i.up=e.up,i.fov=e.fov):i.copyFrom(e),t.applyConstraints&&lr(this.view,i)})),t.applyConstraints||(this.view.state.cameraController=new Ma({view:this.view,desiredCamera:e})),!0)}_prepareFrame(){const{surface:e,canvas:t}=this.view;if(!e||!t)return;this._windowDevicePixelRatio=window.devicePixelRatio;const i=this._computeCanvasSize();if(0!==i.width&&0!==i.height&&(t.width===i.width&&t.height===i.height||(t.width=i.width,t.height=i.height),this.view.state)){const e=this.view.state.camera;e.fullWidth===i.width&&e.fullHeight===i.height&&e.pixelRatio===i.pixelRatio||(qa.copyFrom(e),qa.pixelRatio!==i.pixelRatio&&(this._paddingToArray(this.padding,i.pixelRatio,za),qa.padding=za),qa.fullWidth=i.width,qa.fullHeight=i.height,qa.pixelRatio=i.pixelRatio,this.view.state.camera=qa),this._updateViewState()}}_updateElevation(e){var t,i,n;const r=null===(t=this.view.basemapTerrain)||void 0===t?void 0:t.spatialReference,s=null!==(i=null===(n=this.view.renderCoordsHelper)||void 0===n?void 0:n.getAltitude(e.eye))&&void 0!==i?i:0,a=r?(0,Gn.wH)(this.view,e.eye):0;e.relativeElevation=s-a}_updateViewState(){null!=this.test.renderState?this.view.state.mode=this.test.renderState:this.view.animation?this.view.state.mode=Ia.n.ANIMATING:this.view.interacting?this.view.state.mode=Ia.n.INTERACTING:(this.view.state.mode===Ia.n.ANIMATING&&(this._cameraChangeTime=0),performance.now()-this._cameraChangeTime<this._idleTimeout?this.view.state.mode=Ia.n.INTERACTING:this.view.state.mode=Ia.n.IDLE),this.view.state.rasterPixelRatio=this._rasterPixelRatio}_cameraChangedHandler(e,t){e&&t&&e.almostEquals(t)||(this._cameraChangeTime=performance.now(),this._updateViewState())}};(0,n._)([(0,b.Cb)({type:r.Z,dependsOn:["view.state.camera","ready"]})],La.prototype,"camera",null),(0,n._)([(0,b.Cb)({type:r.Z,dependsOn:["view.state.contentCamera","ready"]})],La.prototype,"contentCamera",null),(0,n._)([(0,b.Cb)({type:ua.Z})],La.prototype,"center",null),(0,n._)([(0,b.Cb)({type:da.Z})],La.prototype,"extent",null),(0,n._)([(0,b.Cb)({readOnly:!0})],La.prototype,"frustum",null),(0,n._)([(0,b.Cb)()],La.prototype,"_constraintsManager",void 0),(0,n._)([(0,b.Cb)({readOnly:!0})],La.prototype,"constraintsManager",null),(0,n._)([(0,b.Cb)()],La.prototype,"_initialViewpoint",null),(0,n._)([(0,b.Cb)({readOnly:!0})],La.prototype,"hasInitialView",null),(0,n._)([(0,b.Cb)({readOnly:!0,type:Boolean})],La.prototype,"ready",void 0),(0,n._)([(0,b.Cb)({type:Number})],La.prototype,"scale",null),(0,n._)([(0,b.Cb)({type:Number})],La.prototype,"terrainScale",null),(0,n._)([(0,b.Cb)()],La.prototype,"padding",null),(0,n._)([(0,b.Cb)({readOnly:!0})],La.prototype,"screenCenter",null),(0,n._)([(0,b.Cb)({constructOnly:!0})],La.prototype,"view",void 0),(0,n._)([(0,b.Cb)({type:s.Z})],La.prototype,"viewpoint",null),(0,n._)([(0,b.Cb)({type:Number})],La.prototype,"zoom",null),(0,n._)([(0,b.Cb)({readOnly:!0})],La.prototype,"_rasterPixelRatio",null),(0,n._)([(0,b.Cb)({readOnly:!0})],La.prototype,"_usePhysicalPixelRendering",null),(0,n._)([(0,b.Cb)({readOnly:!0})],La.prototype,"_usePhysicalPixelRenderingAny",null),(0,n._)([(0,b.Cb)()],La.prototype,"_windowDevicePixelRatio",void 0),(0,n._)([(0,b.Cb)()],La.prototype,"_devicePixelRatioOverride",void 0),La=(0,n._)([(0,C.j)("esri.views.3d.state.ViewStateManager")],La);class Na{constructor(){this.width=0,this.height=0,this.pixelRatio=1}}const Ua=new Set(["camera","viewpoint","extent","scale","center","zoom"]),Ha=[{propertyName:"camera",overrides:["viewpoint"]},{propertyName:"viewpoint",overrides:["extent"]},{propertyName:"extent",overrides:["center","scale"]},{propertyName:"center",overrides:[]},{propertyName:"scale",overrides:["zoom"]},{propertyName:"zoom",overrides:[]},{propertyName:"padding",overrides:[]}],Fa={heading:0,tilt:0},Va=new r.Z,qa=new Sr.Z,za=(0,Ye.Ue)(),Ba="pending-initial-view",Ga="content-camera-reset",ka=300;let Za=class extends Or{constructor(){super(...arguments),this.startCamera=new Sr.Z,this.currentCamera=new Sr.Z,this._lastInteraction=0}get isInteractive(){return performance.now()-this._lastInteraction<100}stepController(e,t){t.copyViewFrom(this.currentCamera),this.currentCamera.copyFrom(t)}onControllerStart(e){this.state=Ar.Running,this.startCamera.copyFrom(e),this.currentCamera.copyFrom(e)}onControllerEnd(e){e.copyViewFrom(this.currentCamera)}commitCamera(){this._lastInteraction=performance.now(),setTimeout((()=>this.notifyChange("isInteractive")),100),this.view.state.updateCamera((e=>this.stepController(0,e))),this.steppingFinished&&this.finishController()}};var ja;(0,n._)([(0,b.Cb)({readOnly:!0})],Za.prototype,"isInteractive",null),(0,n._)([(0,b.Cb)()],Za.prototype,"_lastInteraction",void 0),Za=(0,n._)([(0,C.j)("esri.views.3d.state.controllers.InteractiveController")],Za),function(e){e[e.CENTER=0]="CENTER",e[e.EYE=1]="EYE"}(ja||(ja={}));let Wa=class extends Za{get _intersectionHelper(){return this.view.sceneIntersectionHelper}constructor(e){super(e),this.pivot=ja.CENTER,this._rotScale=0,this._lastPoint=(0,Ke.Ue)(),this._tmpWorldUp=(0,R.Ue)(),this._tmpViewDir=(0,R.Ue)(),this._tmpRotCurPoint=(0,Ke.Ue)(),this._tmpTransf=(0,Mt.Ue)(),this._tmpAxis=(0,R.Ue)(),this._tmpPivotPoint=(0,R.Ue)(),this._pivotPos=(0,R.Ue)(),this._constraintOptions=new Cn(fn.ALL,vn.TUMBLE,0,this.startCamera)}initialize(){this._rotScale=this.pivot===ja.CENTER?3:1.5}begin(e){if(this.active){switch(this.pivot){case ja.EYE:(0,Ge.c)(this._pivotPos,this.startCamera.eye),this._constraintOptions.interactionType=vn.LOOK_AROUND,this._constraintOptions.tiltMode=yn.LOOK_AROUND,this._constraintOptions.selection=fn.NONE;break;case ja.CENTER:{const t=this._intersectionHelper.intersectRayFreePointFallback(this.startCamera.ray,this._pivotPos,0===this.view.map.ground.opacity?es:{});t||(0,Ge.c)(this._pivotPos,this.startCamera.center),this._constrainPivotPoint(e,t),this.startCamera.center=this._pivotPos,this._constraintOptions.interactionType=vn.TUMBLE,this._constraintOptions.tiltMode=yn.TUMBLE,this._constraintOptions.selection=fn.ALL&~fn.DISTANCE;break}}ts(this.startCamera,e,this._lastPoint)}}_constrainPivotPoint(e,t){var i,n;const r=this.startCamera,s=(0,R.Ue)();(0,Ge.f)(s,this._pivotPos,r.eye);const a=(0,Ge.l)(s),o=Math.abs(this.view.camera.position.z);this.view.renderCoordsHelper.worldUpAtPosition(r.eye,Qa);let l=Math.max(Math.min(5,1/Math.abs((0,Ge.m)(Qa,r.viewForward)))*o,10);t&&(l=Math.min(a,l));const h=(0,v.s1)(r.width/r.pixelRatio*.5,r.height/r.pixelRatio*.5),c=gs(this.startCamera,h,this.view.renderCoordsHelper,this.view.viewingMode);let d=this.view._stage.renderView.getMinimalDepthForArea((0,na.$L)(this.view),r.fullWidth/r.pixelRatio*.5,r.fullHeight/r.pixelRatio*.5,r,225,90),u=this.view._stage.renderView.getMinimalDepthForArea((0,na.$L)(this.view),e[0],e[1],r,90);null==d&&null==u||(d=null!==(i=null!==(n=d)&&void 0!==n?n:u)&&void 0!==i?i:0,u=null==u||c===ds.Horizontal?d:u,l=d>u?u:d,l=t?Math.min(l,a):l),(0,Ge.n)(s,s),(0,Ge.c)(this._pivotPos,(0,Ge.g)(this._tmpPivotPoint,r.eye,(0,Ge.j)(this._tmpPivotPoint,s,l)))}update(e){if(this.active){switch(this.pivot){case ja.EYE:this.currentCamera.center=this._applyRotation(this.currentCamera,e,this.currentCamera.center,this._pivotPos);break;case ja.CENTER:this.currentCamera.center=this._pivotPos,this.currentCamera.eye=this._applyRotation(this.currentCamera,e,this.currentCamera.eye,this._pivotPos)}lr(this.view,this.currentCamera,this._constraintOptions),this.commitCamera()}}end(){this.active&&this.finishController()}_applyRotation(e,t,i,n){this.view.renderCoordsHelper.worldUpAtPosition(n,this._tmpWorldUp),ts(e,t,this._tmpRotCurPoint);let r=(this._lastPoint[1]-this._tmpRotCurPoint[1])*this._rotScale,s=(this._tmpRotCurPoint[0]-this._lastPoint[0])*this._rotScale;(0,Ge.f)(this._tmpViewDir,i,n);const a=(0,Ge.l)(this._tmpViewDir),o=(0,me.ZF)((0,Ge.m)(this._tmpViewDir,this._tmpWorldUp)/a);if(this.pivot===ja.EYE){r*=-.5;const e=.5*Math.PI-o,t=.5*Math.PI*.99;r=e-Math.max(-t,Math.min(t,e+r))}return r=(0,me.uZ)(r+o,be.min,be.max)-o,(0,Ge.b)(this._tmpAxis,e.up,this._tmpViewDir),this.pivot===ja.CENTER&&(s=-s),(0,Pt.Us)(this._tmpTransf,s,this._tmpWorldUp),(0,Pt.U1)(this._tmpTransf,this._tmpTransf,r,this._tmpAxis),(0,Ge.h)(this._tmpViewDir,this._tmpViewDir,this._tmpTransf),e.up=(0,Ge.h)(Xa,e.up,this._tmpTransf),(0,Ge.g)(Xa,n,this._tmpViewDir),(0,Xe.JG)(this._lastPoint,this._tmpRotCurPoint),Xa}};(0,n._)([(0,b.Cb)()],Wa.prototype,"pivot",void 0),Wa=(0,n._)([(0,C.j)("esri.views.3d.state.controllers.RotateController")],Wa);const Xa=(0,R.Ue)(),Qa=(0,R.Ue)();class Ya extends la.a{constructor(e,t,i,n){super(!0),this._view=e,this.pointerAction=t,this._pivot=i,this.registerIncoming("drag",n,(e=>this._handleDrag(e)))}_handleDrag(e){const t=e.data;if(t.pointers.size>1)return;if(!(0,ha.b)(e.data,this.pointerAction))return;const i=(0,v.s1)(t.center.x,t.center.y);switch(t.action){case"start":this._cameraController&&(this._cameraController.end(),this._cameraController=null),this._cameraController=new Wa({view:this._view,pivot:this._pivot}),this._view.state.switchCameraController(this._cameraController),this._cameraController.begin(i);break;case"update":this._cameraController&&this._cameraController.update(i);break;case"end":this._cameraController&&(this._cameraController.end(),this._cameraController=null)}e.stopPropagation()}}let Ja=class extends Za{constructor(){super(...arguments),this._pickPoint=(0,R.Ue)(),this._tmpP0=(0,Ke.Ue)(),this._panAxisAngle=zr(),this._tmpRayDir=(0,R.Ue)(),this._tmpRayDirPick=(0,R.Ue)(),this._targetOnSphere=(0,R.Ue)(),this._navMode=ds.Horizontal,this._tmpRay={origin:(0,R.Ue)(),direction:(0,R.Ue)()},this.dragBeginPoint=(0,v.s1)(),this._normalizedAnchorPoint=(0,Ke.Ue)(),this._constraintOptions=new Cn(fn.ALL_EXCEPT_COLLISION,vn.ZOOM,0,this.startCamera),this._sphere=(0,bn.c)(),this._hasPickPoint=!1}get _intersectionHelper(){return this.view.sceneIntersectionHelper}begin(e){var t;if(!this.active)return;(0,Xe.JG)(this.dragBeginPoint,e),ts(this.startCamera,e,this._normalizedAnchorPoint);const i=(0,Ze.Iu)(this.view.spatialReference),n=ms(this._intersectionHelper,this.startCamera,e,i,Yr.Ellipsoid,0===this.view.map.ground.opacity?es:{});if(this._navMode=gs(this.startCamera,e,this.view.renderCoordsHelper,this.view.viewingMode),this._navMode===ds.Horizontal)this._hasPickPoint=!!n.scenePickPoint,this._pickPoint=null!==(t=n.scenePickPoint)&&void 0!==t?t:this._pickPoint,this._sphere=n.sphere;else{let t;(0,Wr.iE)(this.startCamera,e,this._tmpRay),(0,Ge.n)(this._tmpRay.direction,this._tmpRay.direction),null!=n.scenePickPoint&&((0,Ge.f)(this._tmpRayDirPick,this.startCamera.eye,n.scenePickPoint),t=(0,Ge.l)(this._tmpRayDirPick));const i=Math.abs(this.view.camera.position.z);this.view.renderCoordsHelper.worldUpAtPosition(this.startCamera.eye,$a);let r=(0,me.uZ)(Math.min(30,1/Math.abs((0,Ge.m)($a,this._tmpRay.direction)))*i,Kr[0],Kr[1]);const s=this.view._stage.renderView.getMinimalDepthForArea(null,e[0],e[1],this.view.state.camera,80);r=null!=s?s:r,r=null!=t?Math.min(r,t):r,this._hasPickPoint=!0,(0,Ge.j)(this._tmpRay.direction,this._tmpRay.direction,r),(0,Ge.g)(this._pickPoint,this._tmpRay.origin,this._tmpRay.direction)}}update(e){if(this.active){if(this.currentCamera.eye=this.startCamera.eye,this.currentCamera.center=this.startCamera.center,this.currentCamera.up=this.startCamera.up,this._navMode===ds.Horizontal){(0,Ge.f)(this._tmpRayDir,this.currentCamera.center,this.currentCamera.eye);const t=(0,Ge.l)(this._tmpRayDir);ts(this.currentCamera,e,this._tmpP0);const i=12*(this._normalizedAnchorPoint[1]-this._tmpP0[1]);let n=t*2**i;const r=this.view.state.constraints.minimumPoiDistance;if(i<0&&n<r&&(n=r),Math.abs(t-n)<1e-6)return;if(this._hasPickPoint&&n<t){const e=1-(1-n/t)*(1-this._sphere[3]/(0,Ge.l)(this.currentCamera.center));this.currentCamera.center=(0,Ge.j)(Ka,this.currentCamera.center,e)}(0,Ge.j)(this._tmpRayDir,this._tmpRayDir,-n/t),this.currentCamera.eye=(0,Ge.g)(Ka,this.currentCamera.center,this._tmpRayDir),this._constraintOptions.interactionFactor=hr((0,Xe.TE)(this.dragBeginPoint,e)),lr(this.view,this.currentCamera,this._constraintOptions),this._hasPickPoint&&(ys(this._sphere,this.currentCamera,this.dragBeginPoint,this._targetOnSphere),kr(this._pickPoint,this._targetOnSphere,this._panAxisAngle),ns(this.currentCamera,(0,bn.g)(this._sphere),this._panAxisAngle))}else{const t=(0,Ge.l)(this._tmpRay.direction);ts(this.currentCamera,e,this._tmpP0);const i=12*(this._normalizedAnchorPoint[1]-this._tmpP0[1]);let n=t*2**i;const r=this.view.state.constraints.minimumPoiDistance;if(i<0&&n<r&&(n=r),Math.abs(t-n)<1e-6)return;(0,Ge.j)(this._tmpRayDir,this._tmpRay.direction,1-n/t),this.currentCamera.eye=(0,Ge.g)(Ka,this.currentCamera.eye,this._tmpRayDir),this.currentCamera.center=(0,Ge.g)(Ka,this.currentCamera.center,this._tmpRayDir)}kn(this.view,this.currentCamera),this.commitCamera()}}end(){this.active&&this.finishController()}};Ja=(0,n._)([(0,C.j)("esri.views.3d.state.controllers.ZoomControllerGlobal")],Ja);const Ka=(0,R.Ue)(),$a=(0,R.Ue)();let eo=class extends Za{constructor(){super(...arguments),this._tmpP=(0,R.Ue)(),this._tmpDir=(0,R.Ue)(),this._tmpN=(0,R.Ue)(),this._tmpP0=(0,Ke.Ue)(),this._tmpPoi=(0,R.Ue)(),this._tmpRayDir=(0,R.Ue)(),this.dragBeginPoint=(0,v.s1)(),this._normalizedAnchorPoint=(0,Ke.Ue)(),this._constraintOptions=new Cn(fn.ALL,vn.ZOOM,0,this.startCamera,(0,R.Ue)()),this._plane=(0,jr.Ue)()}get _intersectionHelper(){return this.view.sceneIntersectionHelper}begin(e){if(!this.active)return;(0,Xe.JG)(this.dragBeginPoint,e),ts(this.startCamera,e,this._normalizedAnchorPoint);const t=this._intersectionHelper.intersectScreenFreePointFallback(e,this._tmpP,0===this.view.map.ground.opacity?es:{});(0,Ge.f)(this._tmpDir,this._tmpP,this.startCamera.eye);const i=(0,Ge.l)(this._tmpDir);(0,Ge.n)(this._tmpDir,this._tmpDir);const n=Math.abs(this.view.camera.position.z);let r=(0,me.uZ)(Math.min(30,1/Math.abs((0,Ge.m)(io,this._tmpDir)))*n,Kr[0],Kr[1]);const s=this.view._stage.renderView.getMinimalDepthForArea((0,na.$L)(this.view),e[0],e[1],this.view.state.camera,80);r=null!=s?s:r,r=t?Math.min(r,i):r,(0,Ge.j)(this._tmpDir,this._tmpDir,r),(0,Ge.g)(this._tmpP,this.startCamera.eye,this._tmpDir),(0,Ge.f)(this._tmpN,this.startCamera.eye,this.startCamera.center),(0,Ge.n)(this._tmpN,this._tmpN),this._tmpN[1]<0&&(0,Ge.k)(this._tmpN,this._tmpN),(0,jr.Yq)(this._tmpP,this._tmpN,this._plane)}update(e){if(!this.active)return;(function(e,t,i,n){return(0,jr.BR)(e,(0,Wr.u4)(t,i,Ks),n)})(this._plane,this.currentCamera,this.dragBeginPoint,this._tmpPoi)||(0,Ge.c)(this._tmpPoi,this.currentCamera.center),ts(this.currentCamera,e,this._tmpP0);let t=4*(this._tmpP0[1]-this._normalizedAnchorPoint[1]);(0,Xe.JG)(this._normalizedAnchorPoint,this._tmpP0),(0,Ge.f)(this._tmpRayDir,this._tmpPoi,this.currentCamera.eye);const i=(0,Ge.l)(this._tmpRayDir);let n=i*(1-t);this._constraintOptions.interactionDirection&&((0,Ge.c)(this._constraintOptions.interactionDirection,this._tmpRayDir),(0,Ge.j)(this._constraintOptions.interactionDirection,this._constraintOptions.interactionDirection,Math.sign(t)/i));const r=this.view.state.constraints.minimumPoiDistance;t>=0&&n<r&&(n=r,t=-(n-i)/i),Math.abs(i-n)<1e-6||((0,Ge.j)(this._tmpRayDir,this._tmpRayDir,t),this.currentCamera.eye=(0,Ge.g)(to,this.currentCamera.eye,this._tmpRayDir),(0,Ge.o)(to,this.currentCamera.center,this._tmpPoi,t),this._tmpPoi[2]>this.startCamera.center[2]?to[2]=Math.max(this.startCamera.center[2],to[2]):to[2]=Math.min(this.startCamera.center[2],to[2]),this.currentCamera.center=to,this._constraintOptions.interactionFactor=hr((0,Xe.TE)(this.dragBeginPoint,e)),lr(this.view,this.currentCamera,this._constraintOptions),this.commitCamera())}end(){this.active&&this.finishController()}};eo=(0,n._)([(0,C.j)("esri.views.3d.state.controllers.ZoomControllerLocal")],eo);const to=(0,R.Ue)(),io=(0,R.al)(0,0,1);class no extends la.a{constructor(e,t,i){super(!0),this._view=e,this.pointerAction=t,this.registerIncoming("drag",i,(e=>this._handleDrag(e)))}_handleDrag(e){const t=e.data;if(t.pointers.size>1)return;if(!(0,ha.b)(e.data,this.pointerAction))return;const i=(0,v.s1)(t.center.x,t.center.y);switch(t.action){case"start":this._cameraController&&(this._cameraController.end(),this._cameraController=null),this._view.state.isGlobal?this._cameraController=new Ja({view:this._view}):this._cameraController=new eo({view:this._view}),this._view.state.switchCameraController(this._cameraController),this._cameraController.begin(i);break;case"update":this._cameraController&&this._cameraController.update(i);break;case"end":this._cameraController&&(this._cameraController.end(),this._cameraController=null)}e.stopPropagation()}}var ro=i(71917),so=i(73320);let ao=class extends Za{constructor(e){super(e),this._filteredSurfaceElevation=0,this._transformation={translation:[0,0,0],heading:0,tilt:0,zoom:0},this._keysButtonState=[0,0,0,0,0,0,0,0,0,0,0,0],this._tmpCamera=new Sr.Z,this._headingStart=0,this._constraintOptions=new Cn(fn.ALL,vn.NONE,0,new Sr.Z,null,yn.LOOK_AROUND)}handleEventGamepad(e){const t=(0,so.CY)(e,this.view.navigation.gamepad,this._transformation);("end"===e.action||(0,so._r)(t))&&this.finishController()}activateDirection(e){this._keysButtonState[e]=1,(0,so.U_)(this._keysButtonState,this._transformation)}deactivateDirection(e){this._keysButtonState[e]=0;const t=(0,so.U_)(this._keysButtonState,this._transformation);(0,so._r)(t)&&this.finishController()}onControllerStart(e){this._filteredSurfaceElevation=this.view.pointsOfInterest.cameraOnSurface.location.z,this._headingStart=this.view.camera.heading,super.onControllerStart(e)}_updateFilteredSurfaceElevation(e){const t=this.view.pointsOfInterest.cameraOnSurface.location.z;this._filteredSurfaceElevation+=1*(t-this._filteredSurfaceElevation)*e}stepController(e,t){var i;this._updateStartHeading(),this._updateFilteredSurfaceElevation(e),this.currentCamera.copyViewFrom(t),this._updateCameraCenter(),null!==(i=this._constraintOptions.interactionStartCamera)&&void 0!==i&&i.copyFrom(this.currentCamera),this._calculateControlTransformation(e,this.currentCamera,mo),this._applyDisabledMovementTypes(mo),this._applyPan(mo.pan),this._applyRotate(mo.rotate),this._applyZoom(mo.zoom),this._applyAscend(mo.ascend),this._constraintOptions.interactionType=vn.NONE,this._constraintOptions.selection=fn.COLLISION,lr(this.view,this.currentCamera,this._constraintOptions),super.stepController(e,t)}_updateStartHeading(){0!==this._transformation.heading&&(this._headingStart=this.view.camera.heading)}_applyRotate(e){if(!e.enabled)return;const t=this.currentCamera;(0,Ge.f)(go,t.center,t.eye),(0,Ge.h)(go,go,e.matrix),t.center=(0,Ge.g)(go,go,t.eye),t.up=(0,Ge.h)(go,t.up,e.matrix),this._constraintOptions.interactionType=vn.LOOK_AROUND,this._constraintOptions.selection=fn.ALL_EXCEPT_COLLISION,lr(this.view,t,this._constraintOptions)}_applyPan(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:this.currentCamera;e.enabled&&(t.eye=(0,Ge.h)(go,t.eye,e.matrix),t.center=(0,Ge.h)(go,t.center,e.matrix),this.view.state.isGlobal&&(t.up=(0,Ge.h)(go,t.up,e.matrix)),this._constraintOptions.interactionType=vn.PAN,this._constraintOptions.selection=fn.ALL,lr(this.view,t,this._constraintOptions))}_applyZoom(e){if(!e)return;const t=this.currentCamera.viewForward;this.currentCamera.eye=(0,Ge.g)(go,this.currentCamera.eye,(0,Ge.j)(qr.WM.get(),t,e)),(0,Ge.c)(fo,t),(0,Ge.k)(fo,fo),this._constraintOptions.interactionDirection=fo,this._constraintOptions.interactionType=vn.ZOOM,this._constraintOptions.selection=fn.ALL_EXCEPT_COLLISION,lr(this.view,this.currentCamera,this._constraintOptions),this._constraintOptions.interactionDirection=null}_applyAscend(e){if(!e)return;const t=this.view.renderCoordsHelper.worldUpAtPosition(this.currentCamera.eye,qr.WM.get());if(this._constraintOptions.interactionDirection=(0,Ge.c)(fo,t),this.view.state.isGlobal){const t=(0,Ge.l)(this.currentCamera.eye),i=(t+e)/t;this.currentCamera.eye=(0,Ge.j)(go,this.currentCamera.eye,i),this.currentCamera.center=(0,Ge.j)(go,this.currentCamera.center,i)}else{const i=(0,Ge.j)(qr.WM.get(),t,e);this.currentCamera.eye=(0,Ge.g)(go,this.currentCamera.eye,i),this.currentCamera.center=(0,Ge.g)(go,this.currentCamera.center,i)}this._updateCameraCenter(),this._constraintOptions.interactionType=vn.ASCEND,this._constraintOptions.selection=fn.COLLISION,lr(this.view,this.currentCamera,this._constraintOptions)&&this._updateCameraCenter(),this._constraintOptions.selection=fn.ALL_EXCEPT_COLLISION,lr(this.view,this.currentCamera,this._constraintOptions),this._constraintOptions.interactionDirection=null}_calculateControlTransformation(e,t,i){!function(e){e.zoom=0,e.ascend=0,e.pan.enabled=!1,(0,Pt.yR)(e.pan.matrix),e.rotate.enabled=!1,(0,Pt.yR)(e.rotate.matrix)}(i);const n=this._computeVelocities(e);this.view.state.isLocal?this._calculateControlTransformationLocal(n,t,i):this._calculateControlTransformationGlobal(n,t,i)}_updateCameraCenter(){const e=this.view.pointsOfInterest.centerOnSurfaceFrequent.estimatedSurfaceAltitude,t=this.view.renderCoordsHelper,i=this.currentCamera.ray;this.currentCamera.center=t.intersectManifoldClosestSilhouette(i,e,go)}_calculateControlTransformationLocal(e,t,i){const{viewRight:n,viewForward:r}=t,s=this._transformation,a=this.view.navigation.gamepad,o=(0,Ge.s)(qr.WM.get(),r[0],r[1],0);(0,Ge.n)(o,o);const l=s.translation[0]*e.pan;if(0!==l){const e=(0,Ge.j)(qr.WM.get(),n,l);(0,Pt.Iu)(i.pan.matrix,i.pan.matrix,e),i.pan.enabled=!0}switch(a.mode){case"pan":{const t=-s.translation[1]*e.pan;if(0!==t){const e=(0,Ge.j)(qr.WM.get(),o,t);(0,Pt.Iu)(i.pan.matrix,i.pan.matrix,e),i.pan.enabled=!0}i.zoom=s.zoom*e.zoom;break}case"zoom":i.zoom=(-s.translation[1]+s.zoom)*e.zoom;break;default:(0,Re.Bg)(a.mode)}const h=s.translation[2]*e.ascend;i.ascend=h;const c=-s.heading*e.rotate;0!==c&&((0,Pt.U1)(i.rotate.matrix,i.rotate.matrix,c,this.view.renderCoordsHelper.worldUpAtPosition(t.eye,qr.WM.get())),i.rotate.enabled=!0);const d=s.tilt*e.rotate,u=Wn(this.view.renderCoordsHelper,t.center,t.eye),p=(0,me.uZ)(u+d,be.min,be.max)-u;p&&((0,Pt.U1)(i.rotate.matrix,i.rotate.matrix,p,n),i.rotate.enabled=!0)}_calculateControlTransformationGlobal(e,t,i){const{eye:n,viewRight:r}=t,s=this._transformation,a=this.view.navigation.gamepad,o=(0,Ge.b)(qr.WM.get(),r,n);(0,Ge.n)(o,o),(0,Ge.k)(o,o),Ds(this.startCamera,t,s,e,this.view.camera.heading,this._headingStart,this.view.camera.tilt,i,a),this._tmpCamera.copyFrom(this.currentCamera),this._applyPan(mo.pan,this._tmpCamera);const l=this.view.pointsOfInterest.centerOnSurfaceFrequent.estimatedSurfaceAltitude,h=s.translation[2]*e.ascend;i.ascend=h;const c=-s.heading*e.rotate;0!==c&&((0,Pt.U1)(i.rotate.matrix,i.rotate.matrix,c,this._tmpCamera.eye),i.rotate.enabled=!0);const d=s.tilt*e.rotate,u=this._clampTiltDeltaGlobalToValidRange(d,t.ray,l);0!==u&&((0,Pt.U1)(i.rotate.matrix,i.rotate.matrix,u,this._tmpCamera.viewRight),i.rotate.enabled=!0),i.zoom+=s.zoom*e.zoom}_clampTiltDeltaGlobalToValidRange(e,t,i){const n=(0,Ze.Iu)(this.view.spatialReference),r=hs(be.min,t.origin,i,n);let s=0,a=0;const o=qr.WM.get();if(this.view.renderCoordsHelper.intersectManifold(t,i,o)){s=hs(Wn(this.view.renderCoordsHelper,o,t.origin),t.origin,i,n),a=hs(be.max,t.origin,i,n)}else{(0,bn.e)((0,bn.h)(bn.t,i+n.radius),t,o);s=cs(Math.PI+(0,Vr.EU)(t.direction,o),t.origin,i,n),a=cs(be.max,t.origin,i,n)}return(0,me.uZ)(s+e,r,a)-s}_getPointAbsoluteSurfaceElevation(e,t,i){const{renderCoordsHelper:n}=this.view,r=n.getAltitude(e),s=t+Math.abs(r-t);return n.setAltitude(i,s,e),s}_clampedDistanceToSurface(e,t){const{renderCoordsHelper:i}=this.view,{camera:n}=this.view.state,{direction:r}=(0,B.kE)(this.view,t,0,lo,vo),s=i.intersectManifoldClosestSilhouette((0,wn.re)(t,r),e,qr.WM.get()),a=(0,Ge.p)(t,s),o=i.intersectManifoldClosestSilhouette((0,wn.re)(t,(0,Ge.E)(qr.WM.get(),t,n.center)),e,qr.WM.get()),l=(0,Ge.p)(t,o);return Math.min(a,l)}_computeHeadingRotateRadius(e){const{renderCoordsHelper:t,state:i}=this.view,{camera:n,isGlobal:r}=i,s=t.intersectManifoldClosestSilhouette(n.ray,this._filteredSurfaceElevation,qr.WM.get());if(r){const t=(0,Ge.f)(qr.WM.get(),e,s),i=(0,Ge.l)(t);(0,Ge.j)(t,t,1/i);const n=(0,Ge.n)(qr.WM.get(),e),r=(0,me.ZF)((0,Ge.m)(n,t));return i*Math.sin(Math.min(ho,r))}{const i=(0,Ge.c)(qr.WM.get(),e);return t.setAltitude(i,this._filteredSurfaceElevation),(0,Ge.p)(s,i)}}_minimumAscendVelocity(){return this.view.state.constraints.collision.enabled?0:uo}_computeVelocities(e){const t=this._filteredSurfaceElevation,i=t+(0,Ze.Iu)(this.view.spatialReference).radius,{camera:n,isGlobal:r}=this.view.state,s=qr.WM.get(),a=this._getPointAbsoluteSurfaceElevation(n.eye,t,s),o=this._clampedDistanceToSurface(t,s),l=n.width/2,h=co*n.width,c=co*n.width,d=o*Math.tan(.5*n.fovX)/l,u=d/i,p=d/this._computeHeadingRotateRadius(s),_=a-t;return{pan:(r?u:d)*h*e,ascend:Math.max(this._minimumAscendVelocity()*e,2**(h*e/l)*_-_),zoom:2**(h*e/l)*o-o,rotate:(0,me.uZ)(p*c,po,_o)*e}}_applyDisabledMovementTypes(e){null==this.disableMovements||void 0!==this.disableMovements.mode&&this.view.state.viewingMode!==this.disableMovements.mode||(e.zoom=this.disableMovements.zoom?0:e.zoom,e.ascend=this.disableMovements.ascend?0:e.ascend,e.pan.enabled=!this.disableMovements.pan,this.disableMovements.pan&&(0,Pt.yR)(e.pan.matrix),e.rotate.enabled=!this.disableMovements.rotate,this.disableMovements.rotate&&(0,Pt.yR)(e.rotate.matrix))}static activatesFor(e,t){const i=(0,so.CY)(t,e.navigation.gamepad,oo);return!("end"===t.action||(0,so._r)(i))}};(0,n._)([(0,b.Cb)({constructOnly:!0})],ao.prototype,"gamepadDevice",void 0),(0,n._)([(0,b.Cb)({constructOnly:!0})],ao.prototype,"disableMovements",void 0),ao=(0,n._)([(0,C.j)("esri.views.3d.state.controllers.GamepadKeyboardController")],ao);const oo={translation:[0,0,0],heading:0,tilt:0,zoom:0},lo=80,ho=(0,me.Vl)(lo),co=.75,uo=5,po=(0,me.Vl)(30),_o=(0,me.Vl)(80),mo={zoom:0,ascend:0,pan:{enabled:!1,matrix:(0,Mt.Ue)()},rotate:{enabled:!1,matrix:(0,Mt.Ue)()}},go=(0,R.Ue)(),fo=(0,R.Ue)(),vo=(0,ro.d)();class yo extends la.a{constructor(e){super(!0),this._view=e,this._watchHandles=new We.Z,this._handle=this.registerIncoming("gamepad",(e=>this._handleEventGamepad(e))),this._handle.pause()}onInstall(e){super.onInstall(e),this._watchHandles.add([(0,g.watch)((()=>this._view.navigation.gamepad.enabled),(e=>{e?this._handle.resume():(this._handle.pause(),this._cameraControllerGamepad&&(this._cameraControllerGamepad.finishController(),this._cameraControllerGamepad=null))}),g.initial),(0,g.watch)((()=>this._view.navigation.gamepad.device),(e=>{this._cameraControllerGamepad&&e&&this._cameraControllerGamepad.gamepadDevice!==e&&(this._cameraControllerGamepad.finishController(),this._cameraControllerGamepad=null)}))])}onUninstall(){this._watchHandles.removeAll(),super.onUninstall()}_handleEventGamepad(e){var t;const i=this._view.navigation.gamepad.device;if(i&&e.data.device!==i)return;const n=null===(t=this._cameraControllerGamepad)||void 0===t?void 0:t.active;if(n||ao.activatesFor(this._view,e.data)){if(!n){const t=new ao({view:this._view,gamepadDevice:e.data.device});this._view.state.switchCameraController(t)&&(this._cameraControllerGamepad=t)}this._cameraControllerGamepad&&this._cameraControllerGamepad.active&&this._cameraControllerGamepad.gamepadDevice===e.data.device&&this._cameraControllerGamepad.handleEventGamepad(e.data)}}}var bo,wo=i(65638);!function(e){e[e.LEFT=0]="LEFT",e[e.RIGHT=1]="RIGHT",e[e.FORWARD=2]="FORWARD",e[e.BACKWARD=3]="BACKWARD",e[e.UP=4]="UP",e[e.DOWN=5]="DOWN",e[e.HEADINGLEFT=6]="HEADINGLEFT",e[e.HEADINGRIGHT=7]="HEADINGRIGHT",e[e.TILTUP=8]="TILTUP",e[e.TILTDOWN=9]="TILTDOWN",e[e.ZOOMIN=10]="ZOOMIN",e[e.ZOOMOUT=11]="ZOOMOUT"}(bo||(bo={}));class Co extends la.a{constructor(e,t){super(!0),this._view=e,this._disableMovements={pan:!0,zoom:!1,ascend:!0,rotate:!1,mode:te.JY.Local},this._keyToNumber={[t.left]:bo.LEFT,[t.right]:bo.RIGHT,[t.forward]:bo.FORWARD,[t.backward]:bo.BACKWARD,[t.up]:bo.UP,[t.down]:bo.DOWN,[t.headingLeft]:bo.HEADINGLEFT,[t.headingRight]:bo.HEADINGRIGHT,[t.tiltUp]:bo.TILTUP,[t.tiltDown]:bo.TILTDOWN,[t.zoomIn]:bo.ZOOMIN,[t.zoomOut]:bo.ZOOMOUT},this.registerIncoming("key-down",null,(e=>this._handleKeyDown(e))),this.registerIncoming("key-up",null,(e=>this._handleKeyUp(e))),this.registerIncoming("blur",null,(()=>this._handleStop())),this._visibilityHandle=(0,wo.$)((e=>e?null:this._handleStop()))}onUninstall(){var e;null!==(e=this._visibilityHandle)&&void 0!==e&&e.remove(),this._handleStop()}_handleKeyDown(e){if(e.data.native.ctrlKey||e.data.native.metaKey)return;const t=this._keyToNumber[e.data.key];null!=t&&(this._cameraControllerKeyboard&&this._cameraControllerKeyboard.active||(this._cameraControllerKeyboard=new ao({view:this._view,disableMovements:this._disableMovements}),this._view.state.switchCameraController(this._cameraControllerKeyboard)),this._cameraControllerKeyboard.active&&(this._cameraControllerKeyboard.activateDirection(t),e.stopPropagation()))}_handleStop(){var e;(null===(e=this._cameraControllerKeyboard)||void 0===e?void 0:e.active)&&(this._cameraControllerKeyboard.finishController(),this._cameraControllerKeyboard=null)}_handleKeyUp(e){var t;if(e.data.native.ctrlKey||e.data.native.metaKey)return;const i=this._keyToNumber[e.data.key];null!=i&&(null===(t=this._cameraControllerKeyboard)||void 0===t?void 0:t.active)&&(this._cameraControllerKeyboard.deactivateDirection(i),e.stopPropagation())}}class xo extends la.a{constructor(e,t){super(!0),this._view=e,this.registerIncoming("mouse-wheel",t,(e=>this._handleMouseWheel(e)))}_handleMouseWheel(e){if(!this._view.navigation.mouseWheelZoomEnabled)return;const t=e.data;this._cameraController&&this._cameraController.active||(this._cameraController=this._view.state.isGlobal?new ea({view:this._view,mode:"interaction"}):new ra({view:this._view,mode:"interaction"}),this._view.state.switchCameraController(this._cameraController)),this._cameraController.zoomStep(-1/60*t.deltaY,(0,v.s1)(t.x,t.y)),e.preventDefault(),e.stopPropagation()}}class To{constructor(e){this._gain=e}reset(e){this._value=e}set gain(e){this._gain=e}get value(){return void 0===this._value?0:this._value}update(e){void 0===this._value?this._value=e:this._value=this._gain*e+(1-this._gain)*this._value}}let So=class extends Er{constructor(){super(...arguments),this._beginCamera=new Sr.Z,this._elapsedTimeSec=0,this.constraintOptions=new Cn(fn.ALL,vn.PAN,0,this._beginCamera)}initialize(){this.constraintOptions.interactionType=this.interactionType,this.viewAnimation=new ee.Z}get steppingFinished(){return this.momentum.isFinished(this._elapsedTimeSec)}onControllerStart(e){this._beginCamera.copyFrom(e),super.onControllerStart(e)}stepController(e,t){t.copyViewFrom(this._beginCamera),this._elapsedTimeSec+=e,this.momentumStep(this._elapsedTimeSec,t),lr(this.view,t,this.constraintOptions)}};So=(0,n._)([(0,C.j)("esri.views.3d.state.controllers.momentum.MomentumController")],So);let Po=class extends So{constructor(e){super(e),this.interactionType=vn.PAN,this._tmpPan=(0,R.Ue)()}momentumStep(e,t){const i=this.momentum.value(e);(0,Ge.j)(this._tmpPan,this.momentum.direction,i),t.eye=(0,Ge.f)(Mo,t.eye,this._tmpPan),t.center=(0,Ge.f)(Mo,t.center,this._tmpPan),this.constraintOptions.interactionDirection=this._tmpPan}};(0,n._)([(0,b.Cb)({constructOnly:!0})],Po.prototype,"momentum",void 0),Po=(0,n._)([(0,C.j)("esri.views.3d.state.controllers.momentum.PanPlanarMomentumController")],Po);const Mo=(0,R.Ue)(),Ro=(0,R.Ue)(),Ao=(0,R.Ue)();let Oo=class extends So{constructor(e){super(e),this.interactionType=vn.PAN}momentumStep(e,t){const i=this.momentum.value1(e),n=this.momentum.value2(e);(0,Ge.c)(Ao,t.eye),(0,Ge.n)(Ao,Ao),(0,Ge.b)(this.momentum.axis2,Ao,this.momentum.axis1),Rs(t,Ro,this.momentum.axis1,i,this.momentum.axis2,n)}};(0,n._)([(0,b.Cb)({constructOnly:!0})],Oo.prototype,"momentum",void 0),Oo=(0,n._)([(0,C.j)("esri.views.3d.state.controllers.momentum.PanSphericalMomentumController")],Oo);let Eo=class extends So{set center(e){this._set("center",(0,R.d9)(e))}set axis(e){this._set("axis",(0,R.d9)(e))}constructor(e){super(e),this.interactionType=vn.TUMBLE}momentumStep(e,t){const i=this.momentum.value(e);ns(t,this.center,Br(this.axis,i))}};(0,n._)([(0,b.Cb)({constructOnly:!0})],Eo.prototype,"momentum",void 0),(0,n._)([(0,b.Cb)({constructOnly:!0})],Eo.prototype,"center",null),(0,n._)([(0,b.Cb)({constructOnly:!0})],Eo.prototype,"axis",null),Eo=(0,n._)([(0,C.j)("esri.views.3d.state.controllers.momentum.RotationMomentumController")],Eo);let Do=class extends So{set zoomCenter(e){this._set("zoomCenter",(0,R.d9)(e))}constructor(e){super(e),this.interactionType=vn.ZOOM,this.constraintOptions.interactionDirection=(0,R.Ue)()}momentumStep(e,t){const{interactionDirection:i}=this.constraintOptions;if(!i)return;(0,Ge.c)(i,t.eye);const n=this.momentum.valueDelta(0,e);ss(t,this.zoomCenter,n,this.view.state.constraints.minimumPoiDistance),(0,Ge.E)(i,t.eye,i)}};(0,n._)([(0,b.Cb)({constructOnly:!0})],Do.prototype,"momentum",void 0),(0,n._)([(0,b.Cb)({constructOnly:!0})],Do.prototype,"zoomCenter",null),Do=(0,n._)([(0,C.j)("esri.views.3d.state.controllers.momentum.ZoomPlanarMomentumController")],Do);let Io=class extends So{set screenCenter(e){this._set("screenCenter",(0,v.s1)(e[0],e[1]))}set sceneCenter(e){this._set("sceneCenter",(0,R.d9)(e))}constructor(e){super(e),this.interactionType=vn.ZOOM,this.radius=0,this._tmpSceneCenter=(0,R.Ue)(),this._tmpZoomAxisAngle=zr(),this._sphere=(0,bn.c)()}initialize(){this._sphere[3]=this.radius}momentumStep(e,t){const i=this.momentum.valueDelta(0,e);as(this._sphere,t,i),this.constraintOptions.interactionType=vn.ZOOM,lr(this.view,t,this.constraintOptions),ys(this._sphere,t,this.screenCenter,this._tmpSceneCenter),kr(this.sceneCenter,this._tmpSceneCenter,this._tmpZoomAxisAngle),ns(t,(0,bn.g)(this._sphere),this._tmpZoomAxisAngle),this.constraintOptions.interactionType=vn.PAN}};(0,n._)([(0,b.Cb)({constructOnly:!0})],Io.prototype,"momentum",void 0),(0,n._)([(0,b.Cb)({constructOnly:!0})],Io.prototype,"screenCenter",null),(0,n._)([(0,b.Cb)({constructOnly:!0})],Io.prototype,"sceneCenter",null),(0,n._)([(0,b.Cb)({constructOnly:!0})],Io.prototype,"radius",void 0),Io=(0,n._)([(0,C.j)("esri.views.3d.state.controllers.momentum.ZoomSphericalMomentumController")],Io);var Lo=i(87022),No=i(78738);class Uo{constructor(e){this._gain=e}update(e){void 0!==this.filteredValue?this.filteredValue=(1-this._gain)*this.filteredValue+this._gain*e:this.filteredValue=e}reset(){this.filteredValue=void 0}get hasFilteredValue(){return void 0!==this.filteredValue}}var Ho=i(99742);const Fo=1e-5;class Vo extends Ho.X{constructor(e,t,i,n,r){let s=arguments.length>5&&void 0!==arguments[5]?arguments[5]:0,a=arguments.length>6?arguments[6]:void 0;super(e,t,i),this._angularVelocity1=n,this.axis1=r,this.angularVelocity2=s,this.axis2=a}value1(e){return super.valueFromInitialVelocity(this._angularVelocity1,e)}value2(e){return super.valueFromInitialVelocity(this.angularVelocity2,e)}}class qo{constructor(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:300,t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:12,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:.84;this._minimumInitialVelocity=e,this._stopVelocity=t,this._friction=i,this.enabled=!0,this._tmpAxis1=(0,R.Ue)(),this._tmpAxis2=(0,R.Ue)(),this._tmpAngles=(0,Ke.Ue)(),this._time=new No.J(.3),this._screen=[new No.J(.4),new No.J(.4)],this._angle1=new Uo(.6),this._angle2=new Uo(.6),this._axis1=(0,R.Ue)(),this._axis2=(0,R.Ue)(),this._lastScene=(0,R.Ue)()}addMomentumDirectRotation(e,t,i,n,r,s){if(this.enabled){if(this._time.hasLastValue()){if(this._time.computeDelta(i)<.01)return;let e=xs(this._lastScene,t,this._tmpAxis2,n,r,s);this._angle2.update(0),(0,Ge.q)(this._tmpAxis2)<Fo?e=0:(0,Ge.n)(this._axis1,this._tmpAxis2),this._angle1.update(e),(0,Ge.c)(this._lastScene,t)}this._screen[0].update(e[0]),this._screen[1].update(e[1]),this._time.update(i)}}addMomentumPreserveHeading(e,t,i,n,r,s,a){if(this.enabled){if(this._time.hasLastValue()){if(this._time.computeDelta(i)<.01)return;Ps(this._lastScene,t,this._tmpAxis2,this._tmpAxis1,this._tmpAngles,n,r,s,a,!1),(0,Ge.q)(this._tmpAxis2)<Fo?(this._angle1.update(0),this._angle2.update(0)):(this._angle1.update(this._tmpAngles[1]),this._angle2.update(this._tmpAngles[0]),(0,Ge.n)(this._axis1,this._tmpAxis1),(0,Ge.n)(this._axis2,this._tmpAxis2)),(0,Ge.c)(this._lastScene,t)}this._screen[0].update(e[0]),this._screen[1].update(e[1]),this._time.update(i)}}reset(){this._screen[0].reset(),this._screen[1].reset(),this._angle1.reset(),this._angle2.reset(),this._time.reset()}evaluateMomentum(){if(!this.enabled||!this._screen[0].hasFilteredDelta())return null;const e=this._screen[0].filteredDelta,t=this._screen[1].filteredDelta,i=null==e||null==t?null:Math.sqrt(e*e+t*t),n=this._time.filteredDelta,r=null==i||null==n?0:i/n;return Math.abs(r)<this._minimumInitialVelocity?null:this.createMomentum(r,this._stopVelocity,this._friction)}createMomentum(e,t,i){const n=this._time.filteredDelta,r=this._angle1.filteredValue,s=this._angle2.filteredValue,a=null==n||null==s?0:s/n;return new Vo(e,t,i,null==n||null==r?0:r/n,this._axis1,a,this._axis2)}}var zo=i(19475),Bo=i(62124);let Go=class extends Za{constructor(){super(...arguments),this._smoothRotation=new To(.05),this._rotationAxis=(0,R.Ue)(),this._beginAngle=0,this._beginHeading=0,this._panningPlane=(0,jr.Ue)(),this._beginRadius=0,this._smoothScaling=new To(.05),this._zoomCenterScreen=(0,v.s1)(),this._zoomMomentumEstimator=new Bo.D,this._rotationMomentumEstimator=new zo.y,this._panSphericalMomentumEstimator=new qo,this._panPlanarMomentumEstimator=new Lo.G,this._adjustedSphere=(0,bn.c)(),this._tmp3d=(0,R.Ue)(),this._tmpScreenPointArray=(0,v.s1)(),this._beginScreenPoint=(0,v.s1)(),this._beginScenePoint=(0,R.Ue)(),this._screenPickPoint=(0,v.s1)(),this._scenePickPoint=(0,R.Ue)(),this._navMode=ds.Horizontal,this._sphere=(0,bn.c)(),this._pointerCount=0,this._tmpInteractionDirection=(0,R.Ue)(),this._beginCamera=new Sr.Z,this._constraintOptions=new Cn(fn.ALL,vn.NONE,0,this._beginCamera)}get _intersectionHelper(){return this.view.sceneIntersectionHelper}begin(e){if(!this.active)return;this._zoomMomentumEstimator.enabled=this._rotationMomentumEstimator.enabled=this._panPlanarMomentumEstimator.enabled=this._panSphericalMomentumEstimator.enabled=this.view.navigation.momentumEnabled,this._beginHeading=-Ur.Q4.normalize((0,me.Vl)(this.view.camera.heading)),this._beginRadius=e.radius,this._pointerCount=e.pointers.size,this._beginAngle=e.angle,this._smoothRotation.reset(),(0,v.md)(e.center,this._screenPickPoint),(0,Xe.JG)(this._beginScreenPoint,this._screenPickPoint);const t=(0,Ze.Iu)(this.view.spatialReference),i=ms(this._intersectionHelper,this.startCamera,this._screenPickPoint,t,Yr.Silhouette,0===this.view.map.ground.opacity?es:{});null!=i.scenePickPoint&&(this._scenePickPoint=i.scenePickPoint,this._sphere=i.sphere,(0,Ge.c)(this._beginScenePoint,this._scenePickPoint),this._navMode=gs(this.startCamera,this._screenPickPoint,this.view.renderCoordsHelper,this.view.viewingMode),this._navMode===ds.Vertical&&this._preparePlanarPanMode(e,i.hasGeometryIntersection),this._beginCamera.copyFrom(this.startCamera))}update(e){if(!this.active)return;this.currentCamera.copyFrom(this.startCamera);const t=e.pointers.size>1;this._navMode===ds.Horizontal?(t&&this._zoomSpherical(e),this._panningSpherical(e),t&&this._rotateSpherical(e)):(t&&this._zoomPlanar(e),this._panningPlanar(e),t&&this._rotatePlanar(e)),this.commitCamera()}end(e){e.pointers.size===this._pointerCount&&this.update(e),this.finishController();const t=this._zoomMomentumEstimator.evaluateMomentum();if(t)return this._navMode===ds.Horizontal?new Io({view:this.view,momentum:t,screenCenter:this._zoomCenterScreen,sceneCenter:this._beginScenePoint,radius:this._sphere[3]}):new Do({view:this.view,momentum:t,zoomCenter:this._beginScenePoint});const i=this._rotationMomentumEstimator.evaluateMomentum();if(i)return new Eo({view:this.view,momentum:i,center:(0,bn.g)(this._sphere),axis:this._rotationAxis});if(this._navMode===ds.Horizontal){const e=this._panSphericalMomentumEstimator.evaluateMomentum();if(e)return new Oo({view:this.view,momentum:e})}else{const e=this._panPlanarMomentumEstimator.evaluateMomentum();if(e)return new Po({view:this.view,momentum:e})}return null}_preparePlanarPanMode(e,t){const i=(0,Ge.k)(this._tmp3d,this.startCamera.viewForward);(0,jr.Yq)(this._scenePickPoint,i,this._panningPlane);const n=(0,v.s1)(this._screenPickPoint[0],0),r=(0,R.Ue)(),s=(0,Ge.l)(this.startCamera.eye);this._adjustedSphere[3]=s<this._sphere[3]?s-100:this._sphere[3],ys(this._adjustedSphere,this.startCamera,n,r);const a=(0,v.J$)();this.startCamera.projectToRenderScreen(r,a);const o=(0,R.Ue)(),l=(0,R.Ue)(),h=(0,R.Ue)();(0,Ge.f)(o,this._scenePickPoint,this.currentCamera.eye);const c=(0,Ge.l)(o);(0,Ge.n)(o,o);const d=5*Math.max(Math.abs(this.view.camera.position.z),50),u=this.view._stage.renderView.getMinimalDepthForArea(null,this._screenPickPoint[0],this._screenPickPoint[1],this.view.state.camera,80);let p=null!=u?u:d;p=t?Math.min(p,c):p,(0,Ge.c)(h,(0,Ge.g)(l,this.currentCamera.eye,(0,Ge.j)(l,o,p))),this._panningPlane[3]=-(0,Ge.m)((0,jr.st)(this._panningPlane),h),this.startCamera.center=(0,Ge.g)(l,this.startCamera.eye,(0,Ge.j)(l,this.startCamera.viewForward,p));const _=(0,v.md)(e.center,this._tmpScreenPointArray);rs(this._panningPlane,this.startCamera,_,this._beginScenePoint)}_zoomSpherical(e){const t=this._beginRadius/e.radius,i=.001875*Math.min(Math.max(e.radius,40),120);this._smoothScaling.gain=i,this._smoothScaling.update(t),as(this._sphere,this.currentCamera,this._smoothScaling.value),(0,v.md)(e.center,this._zoomCenterScreen),this._zoomMomentumEstimator.add(this._smoothScaling.value,.001*e.timestamp),this._constraintOptions.interactionType=vn.ZOOM,this._constraintOptions.interactionFactor=hr(e.radius-this._beginRadius),lr(this.view,this.currentCamera,this._constraintOptions)}_panningSpherical(e){const t=(0,v.md)(e.center,this._tmpScreenPointArray);ys(this._sphere,this.currentCamera,t,this._tmp3d),As(this._beginScenePoint,(0,Ge.m)(this.currentCamera.up,this._beginScenePoint),this._sphere[3],this._beginHeading,this.view.camera.tilt,this.startCamera)?(Es(this._sphere,this.currentCamera,this._beginScenePoint,this._tmp3d,this._beginHeading,this.view.camera.tilt,!1),this._panSphericalMomentumEstimator.addMomentumPreserveHeading(t,this._tmp3d,.001*e.timestamp,this.startCamera,this._sphere,this._beginHeading,this.view.camera.tilt)):(Os(this._sphere,this.currentCamera,this._beginScenePoint,this._tmp3d,this.view.camera.tilt,!1),this._panSphericalMomentumEstimator.addMomentumDirectRotation(t,this._tmp3d,.001*e.timestamp,this.startCamera,this._sphere[3],this.view.camera.tilt)),this._constraintOptions.interactionType=vn.PAN,this._constraintOptions.interactionFactor=hr((0,Xe.TE)(this._screenPickPoint,t)),lr(this.view,this.currentCamera,this._constraintOptions)}_rotateSpherical(e){(0,Ge.n)(this._rotationAxis,this._scenePickPoint),this.currentCamera.aboveGround||(0,Ge.k)(this._rotationAxis,this._rotationAxis);const t=this._smoothRotation.value,i=t+is(e.angle-t),n=.00125*Math.min(Math.max(e.radius,40),120);this._smoothRotation.gain=n,this._smoothRotation.update(i);const r=this._smoothRotation.value-this._beginAngle;this._rotationMomentumEstimator.add(r,.001*e.timestamp),ns(this.currentCamera,(0,bn.g)(this._sphere),Br(this._rotationAxis,r)),this._constraintOptions.interactionType=vn.TUMBLE,this._constraintOptions.interactionFactor=hr(e.radius*i),lr(this.view,this.currentCamera,this._constraintOptions)}_panningPlanar(e){const t=(0,v.md)(e.center,this._tmpScreenPointArray);rs(this._panningPlane,this.currentCamera,t,this._tmp3d)&&(fs(this.currentCamera,this._beginScenePoint,this._tmp3d),this._panPlanarMomentumEstimator.add(t,this._tmp3d,.001*e.timestamp),this._constraintOptions.interactionType=vn.PAN,this._constraintOptions.interactionFactor=hr((0,Xe.TE)(this._beginScreenPoint,t)),this._constraintOptions.interactionDirection=this.view.renderCoordsHelper.worldUpAtPosition(this.currentCamera.eye,this._tmpInteractionDirection),lr(this.view,this.currentCamera,this._constraintOptions),this._constraintOptions.interactionDirection=null)}_zoomPlanar(e){const t=this._beginRadius/e.radius,i=.001875*Math.min(Math.max(e.radius,40),120);this._smoothScaling.gain=i,this._smoothScaling.update(t),this._zoomMomentumEstimator.add(this._smoothScaling.value,.001*e.timestamp),ss(this.currentCamera,this._beginScenePoint,this._smoothScaling.value,this.view.state.constraints.minimumPoiDistance),this._constraintOptions.interactionType=vn.ZOOM,this._constraintOptions.interactionFactor=hr(e.radius-this._beginRadius),lr(this.view,this.currentCamera,this._constraintOptions)}_rotatePlanar(e){(0,Ge.c)(this._rotationAxis,this._beginScenePoint),this.currentCamera.aboveGround||(0,Ge.k)(this._rotationAxis,this._rotationAxis);const t=this._smoothRotation.value;let i=e.angle-t;i=is(i);const n=t+i,r=.00125*Math.min(Math.max(e.radius,40),120);this._smoothRotation.gain=r,this._smoothRotation.update(n);const s=this._smoothRotation.value-this._beginAngle;this._rotationMomentumEstimator.add(s,.001*e.timestamp),ns(this.currentCamera,(0,bn.g)(this._sphere),Br(this._rotationAxis,s)),this._constraintOptions.interactionType=vn.TUMBLE,this._constraintOptions.interactionFactor=hr(e.radius*s),lr(this.view,this.currentCamera,this._constraintOptions)}};Go=(0,n._)([(0,C.j)("esri.views.3d.state.controllers.PinchAndPanControllerGlobal")],Go);const ko=(0,R.al)(0,0,1);let Zo=class extends Za{constructor(){super(...arguments),this._rotationValueSmooth=new To(.05),this._scalingValueSmooth=new To(.05),this._planeHorizontal=(0,jr.Ue)(),this._planeVertical=(0,jr.Ue)(),this._rotationMomentumEstimator=new zo.y,this._panMomentumEstimator=new Lo.G(300,12,.9),this._zoomMomentumEstimator=new Bo.D,this._beginRadius=0,this._beginCenter=(0,R.Ue)(),this._beginAngle=0,this._tmpPoints=[],this._navMode=ds.Horizontal,this._beginCenterScreen=(0,v.s1)(),this._tmpCentroid3d=(0,R.Ue)(),this._tmpCentroid2d=(0,v.s1)(),this._tmp2d=(0,v.s1)(),this._pointerCount=0,this._beginCamera=new Sr.Z,this._constraintOptions=new Cn(fn.ALL,vn.NONE,0,this._beginCamera)}begin(e){if(!this.active)return;const t=this.view.navigation.momentumEnabled;this._zoomMomentumEstimator.enabled=t,this._rotationMomentumEstimator.enabled=t,this._panMomentumEstimator.enabled=t,this._beginRadius=e.radius,this._pointerCount=e.pointers.size,this._beginAngle=e.angle,this._rotationValueSmooth.reset(),this._scalingValueSmooth.reset(),(0,v.md)(e.center,this._beginCenterScreen),(0,jr.Oy)(ko,0,this._planeHorizontal);const i=(0,R.Ue)(),n=this._intersectionHelper.intersectScreenFreePointFallback(this._beginCenterScreen,i,0===this.view.map.ground.opacity?es:{}),r=(0,R.Ue)();(0,Ge.k)(r,this.startCamera.viewForward);const s=(0,R.Ue)();(0,Ge.c)(s,ko);const a=(0,Ge.m)(r,s);this._navMode=gs(this.startCamera,this._beginCenterScreen,this.view.renderCoordsHelper,this.view.viewingMode);const o=Math.min(5,1/Math.abs((0,Ge.m)(s,this.startCamera.viewForward)))*Math.max(Math.abs(this.view.camera.position.z),50);(0,jr.T5)(this._planeHorizontal,this._planeHorizontal,i),this.startCamera.aboveGround||(0,jr.tk)(this._planeHorizontal,this._planeHorizontal);const l=(0,R.Ue)(),h=(0,R.Ue)(),c=(0,R.Ue)();(0,Ge.f)(l,i,this.currentCamera.eye);const d=(0,Ge.l)(l);if((0,Ge.n)(l,l),this._navMode===ds.Vertical){(0,Ge.j)(s,s,a),(0,Ge.f)((0,jr.st)(this._planeVertical),r,s),(0,Ge.n)((0,jr.st)(this._planeVertical),(0,jr.st)(this._planeVertical)),(0,jr.T5)(this._planeVertical,this._planeVertical,i);const t=this.view._stage.renderView.getMinimalDepthForArea((0,na.$L)(this.view),this._beginCenterScreen[0],this._beginCenterScreen[1],this.view.state.camera,80);let u=null!=t?t:o;u=n?Math.min(u,d):u,(0,Ge.c)(c,(0,Ge.g)(h,this.currentCamera.eye,(0,Ge.j)(h,l,u))),this._planeVertical[3]=-(0,Ge.m)((0,jr.st)(this._planeVertical),c),this._computePlanePoints(e.pointers,this._planeVertical,this.startCamera,this._tmpPoints),ls(this._tmpPoints,this._beginCenter)}else{const t=n?d:o;(0,Ge.c)(c,(0,Ge.g)(h,this.currentCamera.eye,(0,Ge.j)(h,l,t))),this._planeHorizontal[3]=-(0,Ge.m)((0,jr.st)(this._planeHorizontal),c),this._computePlanePoints(e.pointers,this._planeHorizontal,this.startCamera,this._tmpPoints),ls(this._tmpPoints,this._beginCenter)}this._beginCamera.copyFrom(this.startCamera)}update(e){if(!this.active)return;this.currentCamera.copyFrom(this.startCamera);const t=e.pointers.size>1,i=this._navMode===ds.Horizontal?this._planeHorizontal:this._planeVertical,n=this._beginCenter;if(t){const t=this._beginRadius/e.radius,i=.001875*Math.min(Math.max(e.radius,40),120);this._scalingValueSmooth.gain=i,this._scalingValueSmooth.update(t),ss(this.currentCamera,n,this._scalingValueSmooth.value,this.view.state.constraints.minimumPoiDistance),this._zoomMomentumEstimator.add(this._scalingValueSmooth.value,.001*e.timestamp),this._constraintOptions.interactionType=vn.ZOOM,this._constraintOptions.interactionFactor=hr(Math.abs(e.radius-this._beginRadius)),lr(this.view,this.currentCamera,this._constraintOptions)}if(this._computePlanePoints(e.pointers,i,this.currentCamera,this._tmpPoints),ls(this._tmpPoints,this._tmpCentroid3d),(0,v.md)(e.center,this._tmpCentroid2d),fs(this.currentCamera,n,this._tmpCentroid3d),this._panMomentumEstimator.add(this._tmpCentroid2d,this._tmpCentroid3d,.001*e.timestamp),this._constraintOptions.interactionType=vn.PAN,this._constraintOptions.interactionFactor=hr((0,Xe.TE)(this._beginCenterScreen,this._tmpCentroid2d)),lr(this.view,this.currentCamera,this._constraintOptions),t){const t=n,i=this._rotationValueSmooth.value,r=i+is(e.angle-i),s=.00125*Math.min(Math.max(e.radius,40),120);this._rotationValueSmooth.gain=s,this._rotationValueSmooth.update(r);const a=this._rotationValueSmooth.value-this._beginAngle;this._rotationMomentumEstimator.add(a,.001*e.timestamp);const o=(0,jr.st)(this._planeHorizontal);ns(this.currentCamera,t,Br(o,a)),this._constraintOptions.interactionType=vn.TUMBLE,this._constraintOptions.interactionFactor=hr(Math.abs(e.radius*a)),lr(this.view,this.currentCamera,this._constraintOptions)}this.commitCamera()}end(e){e.pointers.size===this._pointerCount&&this.update(e),this.finishController();const t=this._zoomMomentumEstimator.evaluateMomentum();if(t)return new Do({view:this.view,momentum:t,zoomCenter:this._beginCenter});const i=this._rotationMomentumEstimator.evaluateMomentum();if(i)return new Eo({view:this.view,momentum:i,center:this._beginCenter,axis:(0,jr.st)(this._planeHorizontal)});const n=this._panMomentumEstimator.evaluateMomentum();return n?new Po({view:this.view,momentum:n}):null}_computePlanePoints(e,t,i,n){n.length=e.size;const r=this._tmp2d;let s=0;return e.forEach((e=>{r[0]=e.x,r[1]=e.y,void 0===n[s]&&(n[s]=(0,R.Ue)()),rs(t,i,r,n[s]),s+=1})),n}get _intersectionHelper(){return this.view.sceneIntersectionHelper}};Zo=(0,n._)([(0,C.j)("esri.views.3d.state.controllers.PinchAndPanControllerLocal")],Zo);class jo extends la.a{constructor(e,t,i){super(!0),this._view=e,this.pointerAction=t,this._lastEndTimestamp=0,this._lastTimestamp=0,this.registerIncoming("drag",i,(e=>this._handleDrag(e)))}_handleDrag(e){if("mouse"===e.data.pointerType&&!(0,ha.b)(e.data,this.pointerAction))return;const t=e.timestamp-this._lastEndTimestamp,i=this._momentum&&this._momentum.active&&t<40;switch(e.data.action){case"start":case"update":if(i)break;this._controller&&this._controller.active?e.data.timestamp-this._lastTimestamp>2&&(this._controller.update(e.data),this._lastTimestamp=e.timestamp):this._startController(e);break;case"end":case"removed":this._endController(e,!0);break;case"added":this._endController(e,!1),this._startController(e)}e.stopPropagation()}_endController(e,t){var i;if(null!==(i=this._controller)&&void 0!==i&&i.active){this._lastEndTimestamp=e.timestamp;const i=this._controller.end(e.data);t&&i&&(this._momentum=i,this._view.state.switchCameraController(this._momentum))}this._controller=null}_startController(e){this._controller=this._createController(),this._view.state.switchCameraController(this._controller),this._controller.begin(e.data),this._lastTimestamp=e.timestamp}_createController(){return this._view.state.isGlobal?new Go({view:this._view}):new Zo({view:this._view})}}class Wo extends la.a{constructor(e,t){super(!0),this.view=e,this.registerIncoming("pointer-down",t,(()=>this.view.state.stopActiveCameraController()))}}class Xo extends la.a{constructor(e,t){super(!0),this.key=e,this.registerIncoming("key-down",t,(e=>this._handleKeyDown(e)))}_handleKeyDown(e){e.data.key===this.key&&(this.activate(),e.stopPropagation())}}class Qo extends Xo{constructor(e,t,i){super(t,i),this.view=e}activate(){this.view.goTo({heading:0}).catch((()=>{}))}}class Yo extends Xo{constructor(e,t,i){super(t,i),this.view=e}activate(){this.view.goTo({tilt:0}).catch((()=>{}))}}class Jo extends la.a{constructor(e){let t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];super(!0),this._view=e,this._invert=t,this.registerIncoming("vertical-two-finger-drag",(e=>this._handleTwoFinger(e)))}_handleTwoFinger(e){var t,i,n;const r=this._invert?-1:1,s=(0,v.s1)(0,e.data.delta*r);switch(e.data.action){case"begin":null!==(t=this._cameraController)&&void 0!==t&&t.end(),this._cameraController=new Wa({view:this._view,pivot:ja.CENTER}),this._view.state.switchCameraController(this._cameraController),this._cameraController.begin(s);break;case"update":null===(i=this._cameraController)||void 0===i||i.update(s);break;case"end":null!==(n=this._cameraController)&&void 0!==n&&n.end(),this._cameraController=null}}}var Ko=i(31822),$o=i(1614),el=i(83659),tl=i(33666),il=i(11802),nl=i(64544),rl=i(46525),sl=i(43308);class al extends la.a{constructor(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:20,t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:40;super(!1),this._threshold=e,this._maxDelta=t,this._state="ready",this._emittedArtificalEnd2=!1,this._vertical=this.registerOutgoing("vertical-two-finger-drag"),this._artificalDrag=this.registerOutgoing("drag"),this._dragEventSeparator=new sl.H({start:(e,t)=>this._observeStart(e,t),update:(e,t,i)=>this._observeUpdate(e,t,i),end:(e,t)=>this._observeEnd(t)}),this.registerIncoming("drag",(e=>this._dragEventSeparator.handle(e)))}get failed(){return"failed"===this._state}_observeStart(e,t){1===e&&this._emittedArtificalEnd2&&(this._emittedArtificalEnd2=!1,this._artificalDrag.emit({action:"start",button:t.data.button,buttons:t.data.buttons,pointerType:t.data.pointerType,timestamp:t.data.timestamp,pointers:t.data.pointers,pointer:t.data.pointer,angle:t.data.angle,radius:t.data.radius,center:t.data.center}),t.stopPropagation()),this._state=2===e?"ready":"failed"}_observeUpdate(e,t,i){if("failed"!==this._state&&2===e)return"active"===this._state?(this._vertical.emit({delta:t.data.center.y-this._thresholdReachedCenter.y,action:"update"}),void t.stopPropagation()):void(this._checkMovementWithinLimits(t.data,i.data)?this._checkVerticalThresholdReached(t.data,i.data)&&(this._state="active",this._emittedArtificalEnd2=!0,this._thresholdReachedCenter=t.data.center,this._artificalDrag.emit({action:"end",button:t.data.button,buttons:t.data.buttons,pointerType:t.data.pointerType,timestamp:t.data.timestamp,pointers:t.data.pointers,pointer:t.data.pointer,angle:t.data.angle,radius:t.data.radius,center:t.data.center}),this._vertical.emit({delta:t.data.center.y-this._thresholdReachedCenter.y,action:"begin"}),t.stopPropagation()):this._state="failed")}_observeEnd(e){"active"===this._state&&(this._vertical.emit({delta:e.data.center.y-this._thresholdReachedCenter.y,action:"end"}),this._state="ready",e.stopPropagation())}_checkMovementWithinLimits(e,t){let i=-1/0,n=1/0,r=-1/0,s=1/0;for(const{x:_,y:m}of t.pointers.values())i=Math.max(i,_),n=Math.min(n,_),r=Math.max(r,m),s=Math.min(s,m);let a=-1/0,o=1/0,l=-1/0,h=1/0;for(const{x:_,y:m}of e.pointers.values())a=Math.max(a,_),o=Math.min(o,_),l=Math.max(l,m),h=Math.min(h,m);const c=i-n,d=r-s,u=a-o,p=l-h;return Math.abs(e.center.x-t.center.x)<this._threshold&&Math.abs(u-c)<=this._maxDelta&&Math.abs(p-d)<=this._maxDelta}_checkVerticalThresholdReached(e,t){let i=Math.abs(e.center.y-t.center.y);return e.pointers.forEach(((e,n)=>{const r=t.pointers.get(n);i=Math.min(i,Math.abs(e.y-r.y))})),i>=this._threshold}}let ol=class extends T.default{destroy(){this.disconnect()}get primaryDragAction(){return this._get("primaryDragAction")}set primaryDragAction(e){"pan"!==e&&"rotate"!==e||e===this._get("primaryDragAction")||(this._set("primaryDragAction",e),this._updateMode())}get mode(){return this._get("mode")}set mode(e){"default"!==e&&"pro"!==e||e===this._get("mode")||(this._set("mode",e),this._updateMode())}get updating(){var e;return!(null===(e=this._inputManager)||void 0===e||!e.updating)}get latestPointerType(){var e;return null===(e=this._inputManager)||void 0===e?void 0:e.latestPointerType}get latestPointerLocation(){var e;return null===(e=this._inputManager)||void 0===e?void 0:e.latestPointerLocation}get multiTouchActive(){var e,t;return null!==(e=null===(t=this._inputManager)||void 0===t?void 0:t.multiTouchActive)&&void 0!==e&&e}disconnect(){this.view.viewEvents.disconnect(),this._inputManager=(0,p.SC)(this._inputManager)}connect(){const e=this.view;this._source=new Ko.z(this.view.surface,e.input);const t=[new il.y,new nl.e,new rl.y,new tl.n(this.view.navigation),new al],i=new $o.$({eventSource:this._source,recognizers:t});this._inputManager=i,i.installHandlers("prevent-context-menu",[new el.G],$o.f.INTERNAL),this._modeDragPan=new jo(e,"primary"),this._modeDragRotate=new Ya(e,"secondary",ja.CENTER),this._modeDragZoom=new no(e,"tertiary");const n="b",r={left:"ArrowLeft",right:"ArrowRight",forward:"ArrowUp",backward:"ArrowDown",up:"u",down:"j",headingLeft:"a",headingRight:"d",tiltUp:"w",tiltDown:"s",zoomIn:"+",zoomOut:"-"},s="n",a="p";i.installHandlers("navigation",[new Wo(e),new ca(e),new yo(e),new Co(e,r),new xo(e),new Yo(e,a),new Qo(e,s),new Ya(e,"primary",ja.EYE,[n]),new Ya(e,"secondary",ja.CENTER,[n]),new jo(e,"tertiary",[n]),this._modeDragRotate,this._modeDragZoom,this._modeDragPan,new Jo(e)],$o.f.INTERNAL),this.view.viewEvents.connect(i),this._updateMode(),this.addHandles((0,g.watch)((()=>{var e;return null===(e=this.view.navigation)||void 0===e?void 0:e.browserTouchPanEnabled}),(e=>{this._source.browserTouchPanningEnabled=!e}),g.initial))}isModifierKeyDown(e){var t,i;return null!==(t=null===(i=this._inputManager)||void 0===i?void 0:i.isModifierKeyDown(e))&&void 0!==t&&t}_updateMode(){var e;const t=this.mode,i=this.primaryDragAction,n=null===(e=ll.get(t))||void 0===e?void 0:e.get(i);n&&(this._modeDragPan&&(this._modeDragPan.pointerAction=n.pan),this._modeDragRotate&&(this._modeDragRotate.pointerAction=n.rotate),this._modeDragZoom&&(this._modeDragZoom.pointerAction=n.zoom))}get test(){}};(0,n._)([(0,b.Cb)()],ol.prototype,"view",void 0),(0,n._)([(0,b.Cb)({value:"pan"})],ol.prototype,"primaryDragAction",null),(0,n._)([(0,b.Cb)({value:"default"})],ol.prototype,"mode",null),(0,n._)([(0,b.Cb)({readOnly:!0})],ol.prototype,"updating",null),(0,n._)([(0,b.Cb)()],ol.prototype,"latestPointerType",null),(0,n._)([(0,b.Cb)()],ol.prototype,"latestPointerLocation",null),(0,n._)([(0,b.Cb)()],ol.prototype,"multiTouchActive",null),(0,n._)([(0,b.Cb)()],ol.prototype,"_inputManager",void 0),ol=(0,n._)([(0,C.j)("esri.views.3d.input.SceneInputManager")],ol);const ll=new Map,hl=new Map,cl=new Map;hl.set("pan",{pan:"primary",rotate:"secondary",zoom:"tertiary"}),hl.set("rotate",{pan:"secondary",rotate:"primary",zoom:"tertiary"}),cl.set("pan",{pan:"primary",rotate:"tertiary",zoom:"secondary"}),cl.set("rotate",{pan:"tertiary",rotate:"primary",zoom:"secondary"}),ll.set("default",hl),ll.set("pro",cl);const dl=ol;var ul=i(77427),pl=i(27546),_l=i(94463);let ml,gl,fl=!1,vl=!1,yl=!1,bl=!1,wl=null;function Cl(e){yl=_l.h.DECONFLICTOR_SHOW_VISIBLE,bl=_l.h.DECONFLICTOR_SHOW_INVISIBLE,fl=yl||bl,vl=_l.h.DECONFLICTOR_SHOW_GRID,wl=null,fl||vl?wl=()=>function(e){null==ml&&(ml=document.createElement("canvas"),ml.setAttribute("id","debugCanvas2d"),e.surface.parentElement.style.position="relative",e.surface.parentElement.appendChild(ml));const{state:t}=e,{camera:i,pixelRatio:n}=t,{width:r,height:s}=i,a=r*n,o=s*n;ml.setAttribute("width","".concat(a,"px")),ml.setAttribute("height","".concat(o,"px")),ml.setAttribute("style","position:absolute;left:0px;top:0px;display:block;pointer-events:none;width:".concat(r,"px;height:").concat(s,"px")),gl=ml.getContext("2d"),gl.clearRect(0,0,r,s),gl.font="12px Arial"}(e):ml&&(ml.parentElement.removeChild(ml),ml=null)}function xl(){wl&&(wl(),wl=null)}function Tl(e,t,i,n,r){xl();const s=ml.height,a=gl;a.beginPath(),a.lineWidth=1,a.strokeStyle=r,a.moveTo(e,s-i),a.lineTo(t,s-i),a.stroke(),a.lineTo(t,s-n),a.stroke(),a.lineTo(t,s-i),a.stroke(),a.lineTo(e,s-i),a.stroke(),a.lineTo(e,s-i),a.stroke(),a.closePath()}function Sl(e,t){fl&&(t&&yl||!t&&bl)&&Tl(e.aabr[0],e.aabr[2],e.aabr[1],e.aabr[3],t?"green":"red")}var Pl=i(70446),Ml=i(65216),Rl=i(21400),Al=i(21166);const Ol=(0,R.Ue)(),El=(0,Ye.Ue)(),Dl=(0,Ye.Ue)(),Il=(0,R.Ue)(),Ll=(0,Mt.Ue)(),Nl=(0,bn.c)(),Ul=(0,wn.Ue)(),Hl=(0,R.Ue)(),Fl=(0,L.Ue)();class Vl{constructor(){this.aabr=(0,L.Ue)(),this.distance=0,this.culled=!1,this.visible=!1}}class ql{constructor(e,t){this.graphics3DGraphic=e,this.slicePlaneEnabled=t,this.info={}}}var zl;!function(e){e[e.Idle=0]="Idle",e[e.Process=1]="Process",e[e.Sort=2]="Sort",e[e.Deconflict=3]="Deconflict",e[e.NumStates=4]="NumStates"}(zl||(zl={}));class Bl{constructor(){this.camera=new Sr.Z,this.slicePlane=(0,N.a)(),this.slicePlaneEnabled=!1}copyFrom(e){this.camera.copyFrom(e.camera),(0,N.c)(e.slicePlane,this.slicePlane),this.slicePlaneEnabled=e.slicePlaneEnabled}}let Gl=class extends T.default{get dirty(){return this._dirty}get state(){return this._state}constructor(e){super(e),this._dirty=!1,this._viewState=new Bl,this._state=zl.Idle,this._active=new Map,this._visible=new Map,this._iterators=new jl,this._accBinsNumX=15,this._accBinsNumY=20,this._accBinsSizeX=0,this._accBinsSizeY=0,this._accBins=null,this.accNumTests=0}destroy(){this._active.clear(),this._visible.clear(),this._iterators=null}setDirty(){!this._dirty&&this._active.size>0&&(this._dirty=!0,this.notifyChange("updating"))}get updating(){return this._state!==zl.Idle||this._dirty}get updatingProgress(){if(!this.updating)return 1;const e=this._state/zl.NumStates;return this._dirty?.5*e:e}get running(){return this.view.ready&&null!=this.view.state&&this.updating}runTask(e){switch(this._state){case zl.Idle:this._startUpdate(),e.madeProgress();case zl.Process:if(this._state=zl.Process,!this._processActiveGraphics(e))return;case zl.Sort:if(this._state=zl.Sort,!this._sortVisibleGraphics(e))return;case zl.Deconflict:if(this._state=zl.Deconflict,!this._deconflictVisibleGraphics(e))return;default:(function(e,t){if(!vl||!gl)return;xl();const i=gl;let n=0;for(let r=0;r<e.accBinsNumX;r++)for(let t=0;t<e.accBinsNumY;t++){const s=e.accBins[r][e.accBinsNumY-1-t];n+=s.length;const a=r*e.accBinsSizeX,o=(r+1)*e.accBinsSizeX,l=t*e.accBinsSizeY,h=(t+1)*e.accBinsSizeY;i.fillText(s.length.toFixed(),a+5,l+15),Tl(a,o,l,h,"blue")}i.fillText("total totalShownLabels: "+n,70,40),i.fillText("total visible labels: "+t.size,70,50),i.fillText("total numTests: "+e.accNumTests,70,30)})(this,this._visible),this._state=zl.Idle,this.notifyChange("updating")}}modifyGraphics(e,t){t?e.forEach((e=>this.addToActiveGraphics(e))):e.forEach((e=>this.removeFromActiveGraphics(e))),this.setDirty()}layerSupportsDeconfliction(e){var t;if(null==e||"object3d"!==e.type)return!1;const i=e.stageObject;if(1!==(null!==(t=null===i||void 0===i?void 0:i.geometries.length)&&void 0!==t?t:0))return!1;const n=null===i||void 0===i?void 0:i.geometries[0];return(null===n||void 0===n?void 0:n.material)instanceof Rl.A}_startUpdate(){Cl(this.view),this._dirty=!1,this._viewState.copyFrom(this.viewState);const{fullWidth:e,fullHeight:t}=this._viewState.camera;this._initBins(e,t),this._resetIterators()}addToActiveGraphics(e){e.info[this.visibilityGroup]=new Vl,this._active.set(e.graphics3DGraphic.graphic.uid,e),this.setDirty()}removeFromActiveGraphics(e){this._visible.delete(e.graphics3DGraphic.graphic.uid),function(e,t){const i=e.graphics3DGraphic;i.destroyed||i.setVisibilityFlag(t,Pl.P.DECONFLICTION,!0)}(e,this.visibilityGroup),delete e.info[this.visibilityGroup],this._active.delete(e.graphics3DGraphic.graphic.uid),this.setDirty()}_processActiveGraphics(e){const t=this._ensureActiveGraphicsIterator(),i=(0,Pt.iS)(Ll,this._viewState.camera.projectionMatrix),n="global"===this.view.viewingMode&&1===this.view.map.ground.opacity&&this._viewState.camera.relativeElevation>0?Nl:null;let r=0;for(null!=n&&((0,Ge.h)((0,bn.g)(n),R.AG,this._viewState.camera.viewMatrix),n[3]=(0,Ze.Iu)(this.view.spatialReference).radius,r=(0,bn.d)(n,R.AG));!e.done;){e.madeProgress();const s=t.next();if(!0===s.done)return this._resetActiveGraphicsIterator(),!0;const a=s.value,o=null===a||void 0===a?void 0:a.info[this.visibilityGroup];o&&(this._collectGraphics3DGraphics(a,i,n,r),o.culled?this._visible.delete(a.graphics3DGraphic.graphic.uid):this._visible.set(a.graphics3DGraphic.graphic.uid,a))}return!1}_sortVisibleGraphics(e){const t=this._ensureSortGraphicsIterator();for(;!e.done;){const i=t.next();if(e.madeProgress(),!0===i.done)return this._resetSortGraphicsIterator(),!0}return!1}_deconflictVisibleGraphics(e){const t=this._ensureVisibleGraphicsIterator(),i=this.visibilityGroup===Pl.E.LABEL;for(;!e.done;){e.madeProgress();const n=t.next();if(!0===n.done)return this._resetVisibleGraphicsIterator(),!0;const r=n.value,s=r.info[this.visibilityGroup];if(!s||s.culled){this._setGraphicVisibility(r,!1);continue}const a=r.graphics3DGraphic,o=!i||a.isVisible();s.visible=o&&!this._isConflicted(r),s.visible&&this._addToBins(r),this._setGraphicVisibility(r,s.visible),Sl(s,s.visible)}return!1}_resetIterators(){this._iterators.active=null,this._iterators.visible=null,this._iterators.sort=null}_ensureActiveGraphicsIterator(){return this._iterators.active||(this._iterators.active=kl(this._active)),this._iterators.active}_resetActiveGraphicsIterator(){this._iterators.active=null}_ensureVisibleGraphicsIterator(){return this._iterators.visible||(this._iterators.visible=kl(this._visible)),this._iterators.visible}_resetVisibleGraphicsIterator(){this._iterators.visible=null}_ensureSortGraphicsIterator(){return this._iterators.sort||(this._iterators.sort=function*(e,t,i){t.clear(),e.forEach(((e,n)=>{var r;const s=t.pushNew();s.id=n,s.visible=e.graphics3DGraphic.getVisibilityFlag(i,Pl.P.DECONFLICTION);const a=null===(r=e.info)||void 0===r?void 0:r[i];s.prio=e.graphics3DGraphic.deconflictionPriority,s.distance=a?a.distance:Number.MAX_VALUE})),yield;const n=t.iterableSort(((e,t)=>e.prio!==t.prio?t.prio-e.prio:e.distance!==t.distance?e.distance-t.distance:e.visible!==t.visible?e.visible?-1:1:e.id-t.id));for(let r=n.next();!r.done;r=n.next())yield;t.forAll((t=>{const i=e.get(t.id);i&&(e.delete(t.id),e.set(t.id,i))})),t.clear()}(this._visible,this._iterators.sortArray,this.visibilityGroup)),this._iterators.sort}_resetSortGraphicsIterator(){this._iterators.sort=null}_collectGraphics3DGraphics(e,t,i,n){const r=e.graphics3DGraphic;if(r.destroyed)return;const s=e.info[this.visibilityGroup];if(!r.isVisible(Pl.E.GRAPHIC,Pl.P.DECONFLICTION))return void(s.culled=!0);const a=this.getGraphicsLayers(r);(0,L.cS)(s.aabr);let o=null;for(const l of a){if(!this.layerSupportsDeconfliction(l))continue;const r=l.stageObject.geometries[0].material;if(null==o&&(o=Ql,this._getProjectionInfo(l,t,o),o.isOutsideScreen||this._isCulledBySlice(e,Ol)||null!=i&&Xl(o,i,n)))return void(s.culled=!0);this._expandBoundingRect(s,l,r,o)}null==o?s.culled=!0:(s.distance=o.distance,s.culled=!1)}_getProjectionInfo(e,t,i){const n=this._viewState.camera,r=e.stageObject,s=r.geometries[0],a=s.material,o=(0,bn.g)(r.boundingVolumeWorldSpace.bounds);(0,Ge.h)(Ol,o,n.viewMatrix);const l=s.attributes,h=l.get(hi.T.NORMAL).data,c=l.get(hi.T.CENTEROFFSETANDDISTANCE).data;a.applyShaderOffsetsView(Ol,h,r.transformation,c,n,i.scaleInfo,Ol),(0,Qe.s)(El,Ol[0],Ol[1],Ol[2],1),(0,Qe.t)(Dl,El,n.projectionMatrix),(0,Ge.j)(i.positionNDC,Dl,1/Dl[3]),a.applyShaderOffsetsNDC(i.positionNDC,c,n,i.positionNDC,Il),i.distanceWithoutPolygonOffset=n.depthNDCToWorld(Il[2]),i.distance=Il[2]===i.positionNDC[2]?i.distanceWithoutPolygonOffset:n.depthNDCToWorld(i.positionNDC[2]),(0,Qe.s)(Dl,i.positionNDC[0],i.positionNDC[1],i.positionNDC[2],1),(0,Qe.t)(El,Dl,t),(0,Qe.b)(El,El,1/El[3]),(0,Ge.s)(i.positionView,Ol[0],Ol[1],Ol[2])}_isCulledBySlice(e,t){return e.slicePlaneEnabled&&this._viewState.slicePlaneEnabled&&(0,N.e)(this._viewState.slicePlane,t)}_expandBoundingRect(e,t,i,n){let{positionNDC:r,scaleInfo:s}=n;const a=this._viewState.camera,o=t.getScreenSize(Wl);(0,Ml.TU)(o,s.factor,o),o[0]*=a.pixelRatio,o[1]*=a.pixelRatio;const l=(0,L.cv)(i.calculateRelativeScreenBounds(o,s.factorAlignment.scale,Fl),(0,me.t7)(0,a.fullWidth,.5+.5*r[0]),(0,me.t7)(0,a.fullHeight,.5+.5*r[1])),h=this.marginFactor;if(0!==h){const e=h*Math.min((0,L.d_)(l),(0,L.Cb)(l));l[0]-=e,l[1]-=e,l[2]+=e,l[3]+=e}(0,L.jn)(e.aabr,l,e.aabr)}_isConflicted(e){const t=e.graphics3DGraphic.graphic.uid,i=e.info[this.visibilityGroup];let n=!0;for(let r=Math.floor(i.aabr[0]/this._accBinsSizeX);r<=Math.floor(i.aabr[2]/this._accBinsSizeX);r++)if(!(r<0||r>=this._accBinsNumX))for(let e=Math.floor(i.aabr[1]/this._accBinsSizeY);e<=Math.floor(i.aabr[3]/this._accBinsSizeY);e++){if(e<0||e>=this._accBinsNumY)continue;n=!1;const s=this._accBins[r][e];for(let e=0;e<s.length;e++){const n=s.data[e],r=n.info[this.visibilityGroup];if(r&&r.visible&&n.graphics3DGraphic.graphic.uid!==t&&(this.accNumTests++,(0,L.kK)(r.aabr,i.aabr)))return!0}}return n}_initBins(e,t){if(null==this._accBins){this._accBins=[];for(let e=0;e<this._accBinsNumX;e++){this._accBins.push([]);const e=this._accBins[this._accBins.length-1];for(let t=0;t<this._accBinsNumY;t++)e.push(new pl.Z)}}else for(let i=0;i<this._accBinsNumX;i++)for(let e=0;e<this._accBinsNumY;e++)this._accBins[i][e].clear();this._accBinsSizeX=e/this._accBinsNumX,this._accBinsSizeY=t/this._accBinsNumY,this.accNumTests=0}_addToBins(e){const t=e.info[this.visibilityGroup],i=Math.floor(t.aabr[0]/this._accBinsSizeX),n=Math.floor(t.aabr[2]/this._accBinsSizeX),r=Math.floor(t.aabr[1]/this._accBinsSizeY),s=Math.floor(t.aabr[3]/this._accBinsSizeY);for(let a=i;a<=n;a++)if(!(a<0||a>=this._accBinsNumX))for(let t=r;t<=s;t++)t<0||t>=this._accBinsNumY||this._accBins[a][t].push(e)}_setGraphicVisibility(e,t){const i=e.graphics3DGraphic;i.destroyed||(i.setVisibilityFlag(this.visibilityGroup,Pl.P.DECONFLICTION,t),this.visibilityGroup===Pl.E.LABEL&&this.view.labeler.setLabelGraphicVisibility(i,t))}};function*kl(e){if(Map.prototype.entries){const t=e.entries();for(let e=t.next();!e.done;e=t.next())yield e.value[1]}else yield*e.values()}(0,n._)([(0,b.Cb)({constructOnly:!0})],Gl.prototype,"view",void 0),(0,n._)([(0,b.Cb)({type:Boolean,readOnly:!0})],Gl.prototype,"updating",null),Gl=(0,n._)([(0,C.j)("esri.views.3d.layers.graphics.Deconflictor")],Gl);class Zl{constructor(){this.id=0,this.visible=!1,this.prio=0,this.distance=0}}class jl{constructor(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null,t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null;this.active=e,this.visible=t,this.sort=i,this.sortArray=new pl.Z({allocator:e=>e||new Zl})}}const Wl=(0,Ke.Ue)();function Xl(e,t,i){return(0,Ge.c)(Ul.direction,e.positionView),(0,Ge.s)(Ul.origin,0,0,0),!!(0,bn.i)(t,Ul,Hl)&&e.distanceWithoutPolygonOffset>i}const Ql=new class{constructor(){this.positionView=(0,R.Ue)(),this.positionNDC=(0,R.Ue)(),this.distance=0,this.distanceWithoutPolygonOffset=0,this.scaleInfo=new Al.G}get isOutsideScreen(){const e=this.positionNDC;return e[0]<-1||e[1]<-1||e[2]<-1||e[0]>=1||e[1]>=1}};let Yl=class extends Gl{constructor(e){super(e),this.visibilityGroup=Pl.E.LABEL,this.marginFactor=.05,this._lastDeconfliction=0}get viewState(){return this.parent.viewState}runTask(e){if(this.parent.running)return Gt.J;const t=performance.now();if(e.state!==Ia.n.IDLE&&t-this._lastDeconfliction<2e3)return Gt.J;super.runTask(e),this.state===zl.Idle&&(this._lastDeconfliction=t)}enabledChanged(e,t){this.modifyGraphics(t,e.labelsEnabled)}getGraphicsLayers(e){return e.labelLayers}};(0,n._)([(0,b.Cb)({constructOnly:!0})],Yl.prototype,"parent",void 0),Yl=(0,n._)([(0,C.j)("esri.views.3d.layers.graphics.LabelDeconflictor")],Yl);let Jl=class extends Gl{constructor(){super(...arguments),this._contexts=new Map,this.visibilityGroup=Pl.E.GRAPHIC,this._marginFactor=-.1,this.test={overrideMarginFactor:e=>{this._marginFactor=e,this.setDirty()}}}get labels(){return this._labels}get viewState(){return this._viewState}initialize(){this.addHandles([(0,g.watch)((()=>{var e;return null===(e=this.view)||void 0===e||null===(e=e.state)||void 0===e?void 0:e.camera}),(()=>{this._updateViewState(),this.setDirty()})),(0,g.watch)((()=>{var e;return null===(e=this.view)||void 0===e||null===(e=e.map)||void 0===e||null===(e=e.ground)||void 0===e?void 0:e.opacity}),((e,t)=>{1!==e&&1!==t||this.setDirty()})),(0,g.watch)((()=>{var e;return null===(e=this.view)||void 0===e?void 0:e.slicePlane}),(()=>{this._updateSlicePlane(),this._slicePlaneChanged()}),g.initial)]),this._frameTask=this.view.resourceController.scheduler.registerTask(Bt.T8.GRAPHICS_DECONFLICTOR,this),this._labels=new Yl({view:this.view,parent:this})}destroy(){this._labels=(0,p.SC)(this._labels),this._frameTask=(0,p.hw)(this._frameTask)}get marginFactor(){return this._marginFactor}setDirty(){this._contexts.size>0&&(super.setDirty(),this._labels.setDirty())}runTask(e){super.runTask(e),this.running||this._labels.setDirty()}_updateViewState(){var e;(null===(e=this.view)||void 0===e?void 0:e.state)&&(this._viewState.camera.copyFrom(this.view.state.camera),this._updateSlicePlane())}_updateSlicePlane(){const e=this.view?this.view.slicePlane:null;null!=e&&(0,N.t)(e,this._viewState.camera.viewMatrix,this._viewState.slicePlane),this._viewState.slicePlaneEnabled=null!=e}_slicePlaneChanged(){(0,ul.oE)(this._contexts,((e,t)=>t.symbolCreationContext.slicePlaneEnabled))&&this.setDirty()}addGraphicsOwner(e){const t=this._getGraphicsContext(e);return{addGraphic:i=>this._addGraphic(e,t,i),removeGraphic:e=>this._removeGraphic(t,e),labelingInfoChange:()=>this._labels.enabledChanged(e,t),featureReductionChange:()=>this.enabledChanged(e,t),slicePlaneEnabledChange:()=>this._slicePlaneEnabledChanged(e,t),clear:()=>t.forEach((e=>this._removeGraphic(t,e.graphics3DGraphic))),remove:()=>this._removeGraphicsOwner(e),setDirty:()=>this.setDirty()}}_removeGraphicsOwner(e){const t=this._contexts.get(e);t&&(t.forEach((e=>this._removeGraphic(t,e.graphics3DGraphic))),this._contexts.delete(e),this.setDirty())}_addGraphic(e,t,i){const n=i.graphic.uid,r=new ql(i,e.symbolCreationContext.slicePlaneEnabled);t.set(n,r),Kl(e)&&this.addToActiveGraphics(r),e.labelsEnabled&&this._labels.addToActiveGraphics(r);const s=!this._graphicSupportsDeconfliction(i)||!Kl(e);i.setVisibilityFlag(Pl.E.GRAPHIC,Pl.P.DECONFLICTION,s)}_removeGraphic(e,t){const i=t.graphic.uid,n=e.get(i);n&&(this.removeFromActiveGraphics(n),this._labels.removeFromActiveGraphics(n),e.delete(i),this.setDirty())}enabledChanged(e,t){const i=Kl(e);i||function(e){const t=e.graphics3DGraphics;t&&t.forEach((e=>e.setVisibilityFlag(Pl.E.GRAPHIC,Pl.P.DECONFLICTION,!0)))}(e),this.modifyGraphics(t,i)}_slicePlaneEnabledChanged(e,t){const i=e.symbolCreationContext.slicePlaneEnabled;t.forEach((e=>e.slicePlaneEnabled=i)),this.setDirty()}getGraphicsLayers(e){return e.layers}_graphicSupportsDeconfliction(e){if(e.isDraped)return!1;const t=e.layers;if(null===t||void 0===t||!t.length)return!1;for(const i of t)if(this.layerSupportsDeconfliction(i))return!0;return!1}_getGraphicsContext(e){const t=this._contexts.get(e);if(t)return t;const i=new Map;return this._contexts.set(e,i),this.setDirty(),i}};function Kl(e){const t=e.layer;return!(null===t||void 0===t||!t.featureReduction||"selection"!==t.featureReduction.type)}Jl=(0,n._)([(0,C.j)("esri.views.3d.layers.graphics.GraphicsDeconflictor")],Jl);var $l=i(31901),eh=i(95439),th=i(13470),ih=i(95773),nh=i(74702),rh=i(13005),sh=i(29691),ah=i(50628),oh=i(96334);var lh=i(57557);class hh{constructor(e,t){this._renderCoordsHelper=e,this._getIsGroundOpaque=t,this._surfaceElevation=0,this._isGroundOpaque=!1,this._cache=new Map,this._frustumBoundingSphereCenter=(0,R.Ue)(),this._frustumBoundingSphereRadius=0,this._frustum=new Pa.i(e),this._extendedFrustum=new Pa.i(e),this._intersector=new lh.q({renderCoordsHelper:e}),this._renderSR=e.spatialReference;const i=(0,sh.rS)(this._renderSR);this._renderSREllipsoidRadius=(0,Ze.Iu)(i).radius,this._renderCoordsHelper=e}begin(e,t){this._surfaceElevation=t,this._aboveGround=e.aboveGround,this._isGroundOpaque=this._getIsGroundOpaque(),this._frustum.update(e),yh(this._frustum),this._updateExtendedFrustum(e),this._updateFrustumBoundingSphere()}end(){this._cache.clear()}calculate(e){const t=this._renderCoordsHelper.viewingMode===te.JY.Global&&e.lij[0]>=ch&&e.lij[0]<dh,i=this._getOrCalculateSingleTileVisibility(e,!t);return i!==th.E.INVISIBLE&&t?this._calculateAggregatedChildrenVisibility(e):i}_calculateAggregatedChildrenVisibility(e){let t=th.E.INVISIBLE;const i=this._cache.get(e.id);if(null!=i)return i;const n=vh.acquire();e.getChildren(n);for(const r of n){const e=this.calculate(r);if(e!==th.E.INVISIBLE&&(t=e,e===th.E.VISIBLE_ON_SURFACE))break}return vh.release(n),this._cache.set(e.id,t),t}_getOrCalculateSingleTileVisibility(e,t){const i=this._cache.get(e.id);if(null!=i)return i;const n=this._calculateSingleTileVisibility(e);return t&&this._cache.set(e.id,n),n}_calculateSingleTileVisibility(e){return!this._aboveGround&&this._renderCoordsHelper.viewingMode===te.JY.Global&&e.lij[0]<uh?this._calculateSingleTileVisibilitySided(e,!1)===th.E.INVISIBLE?this._calculateSingleTileVisibilitySided(e,!0):void 0:this._calculateSingleTileVisibilitySided(e,this._aboveGround)}_isTileVisibleInFrustum(e){return this._renderCoordsHelper.viewingMode===te.JY.Local?this._isTileVisibleInFrustumLocal(e):this._isTileVisibleInFrustumGlobal(e)}_updateFrustumBoundingSphere(){const e=this._frustum,t=e.origin,i=Vh;(0,Ge.n)(i,e.direction);const n=e.points,r=qh;(0,Ge.z)(r,n[4],t);const s=.5*(0,Ge.m)(r,r)/(0,Ge.m)(i,r),a=this._frustumBoundingSphereCenter;(0,Ge.r)(a,t,i,s);const o=1+s;this._frustumBoundingSphereRadius=o}_isTileVisibleInFrustumLocal(e){const t=e.tilingScheme.spatialReference,i=e.extent,n=this._renderSR,r=Ah;if(r[0]=i[0],r[1]=i[1],r[2]=0,r[3]=i[2],r[4]=i[3],r[5]=0,!(0,ah.projectBuffer)(r,t,0,r,n,0,2))return!1;const s=Oh;(0,Ge.s)(s[0],r[0],r[1],0),(0,Ge.s)(s[1],r[3],r[1],0),(0,Ge.s)(s[2],r[3],r[4],0),(0,Ge.s)(s[3],r[0],r[4],0);const a=Eh;(0,Ge.s)(a,.5*(r[0]+r[3]),.5*(r[1]+r[4]),.5*(r[2]+r[5]));const o=Dh;(0,Ge.s)(o,0,0,1);const l=.5*(0,Ge.F)(s[0],s[2]),h=this._frustum,c=this._frustumBoundingSphereRadius,d=this._frustumBoundingSphereCenter,u=Bh;(0,Ge.z)(u,d,a);const p=(0,Ge.m)(o,u),_=zh;if((0,Ge.r)(_,a,o,p),(0,Ge.F)(_,d)>l+c)return!1;const m=Rh,g=this._isGroundOpaque&&this._aboveGround,f=this._isGroundOpaque&&!this._aboveGround,v=Math.min(f?uc:1/0,p+c),y=Math.max(g?-uc:-1/0,p-c);for(let b=0;b<4;++b)(0,Ge.r)(m[b],s[b],o,v),(0,Ge.r)(m[b+4],s[b],o,y);return!Sh(h.planes,m,8)}_isTileVisibleInFrustumGlobal(e){const t=e.tilingScheme.spatialReference,i=e.extent,n=this._isGroundOpaque&&this._aboveGround,r=this._isGroundOpaque&&!this._aboveGround;if(e.lij[0]<Ph)return!0;const s=Oh,a=.5*(i[0]+i[2]);if((0,Ge.s)(s[0],i[0],i[1],0),(0,Ge.s)(s[1],i[2],i[1],0),(0,Ge.s)(s[2],i[2],i[3],0),(0,Ge.s)(s[3],i[0],i[3],0),(0,Ge.s)(s[4],a,i[1],0),(0,Ge.s)(s[5],a,i[3],0),!function(e,t,i,n,r,s){let a=arguments.length>6&&void 0!==arguments[6]?arguments[6]:1;const o=(0,oh.R8)(t,r,oh._U);if(null==o)return!1;if(o===oh.iq){if(e===n&&i===s)return!0;const t=i+a;for(let r=i,a=s;r<t;++r,++a)(0,Ge.c)(n[a],e[r]);return!0}const l=i+a;for(let h=i,c=s;h<l;++h,++c)o(e[h],0,n[c],0);return!0}(s,t,0,s,this._renderSR,0,6))return!1;const o=s[0][2]>0,l=s[3][2]<0,h=o||l,c=this._renderSREllipsoidRadius;if(h){const e=(0,R.al)(0,0,1),t=Lh;bh(t,e,s[0]);const i=Nh;if(bh(i,e,s[1]),o){const n=Ih,r=s[4],a=Uh;bh(a,r,e),bh(n,a,r);const o=s[0];(0,Ge.b)(o,t,n),Ch(o,c);const l=s[1];(0,Ge.b)(l,i,n),Ch(l,c)}else if(l){const n=Ih,r=s[5],a=Uh;bh(a,r,e),bh(n,r,a);const o=s[3];(0,Ge.b)(o,n,t),Ch(o,c);const l=s[2];(0,Ge.b)(l,n,i),Ch(l,c)}}const d=Eh;{const e=(0,Ge.z)(Wh,s[3],s[0]);(0,Ge.n)(e,e);const t=(0,Ge.g)(Xh,s[0],s[3]);(0,Ge.j)(t,t,.5);const i=-(0,Ge.m)(t,e),n=(0,Ge.g)(Qh,s[0],s[1]);(0,Ge.j)(n,n,.5);const r=(0,Ge.g)(Yh,s[2],s[3]);(0,Ge.j)(r,r,.5);const a=(0,Ge.z)(Jh,r,n);(0,Ge.n)(a,a);const o=-(i+(0,Ge.m)(e,n))/(0,Ge.m)(e,a);(0,Ge.r)(d,n,a,o),Ch(d,c)}const u=this._frustumBoundingSphereRadius,p=this._frustumBoundingSphereCenter,_=this._frustum,m=_.planes,g=Hh;(0,Ge.n)(g,d);const f=(0,Ge.m)(s[0],g)/(0,Ge.H)(s[0]),v=_.origin,y=_.points;let b=!1;if(n){{b=!0;const e=(0,Ge.n)((0,R.Ue)(),v);for(let t=0;t<4;++t){const i=y[4+t],n=(0,Ge.z)((0,R.Ue)(),i,v);(0,Ge.n)(n,n);const r=(0,Ge.b)((0,R.Ue)(),e,n);(0,Ge.n)(r,r);const s=(0,Ge.b)((0,R.Ue)(),n,r);if((0,Ge.n)(s,s),(0,Ge.m)(v,s)>c){b=!1;break}}}if(b&&(0,Ge.m)(v,g)<c*f-uc)return!1;const e=(0,Ge.n)(pc,_.origin);if((0,Ge.m)(e,g)<0)return!1;{const e=(0,Ge.n)(_c,_.direction);if((0,Ge.m)(e,g)>mc)return!1}}const w=Math.sqrt(1-f*f);if(w>.9)return!0;let C=!1;{const e=(0,Ge.m)(g,p),t=(0,Ge.H)(p);if(t<=u&&!m.some((e=>(0,jr.jH)(e,Gh)>0))){if(!n)return!0;C=!0}const i=e/t;if(!C&&e<=0&&-e>u)return!1;const r=u/t;if(Math.sqrt(1-i*i)*Math.sqrt(1-r*r)-r*i>w)return!1}if(!b){if(s.some((e=>_.intersectsPoint(e))))return!0;if(_.intersectsPoint(d))return!0}const x=kh;(0,Ge.z)(x,p,Gh);const T=(0,Ge.m)(x,g),S=Fh;(0,Ge.j)(S,g,T);const P=(0,Ge.F)(S,p),M=t.isWGS84,A=e.lij,O=M&&A[2]===2**A[0]-1,E=M&&0===A[2],D=E?oc:O?sc:nc,I=E?lc:O?ac:rc;if(!C){const e=s,t=hc,i=Kh,n=$h,r=Gh;for(const s of D){const a=e[s];if(wh(i,e[(s+1)%4],a),wh(n,r,a),bh(t,n,i),Mh(t,y,1))return!1}}let L=null;if(!n&&T<1.01*u){const e=2.5*u;if(P>f*e+u)return!1;const t=jh,i=e/f;for(let n=0;n<4;++n)(0,Ge.j)(t[n],s[n],i/c);(0,Ge.s)(t[4],0,0,0),L=t}else{const e=(r?c+uc:T+u)/f,t=n?c-uc:(T-u)/f,i=Zh;for(let n=0;n<4;++n){const r=s[n];(0,Ge.j)(i[n],r,t/c),(0,Ge.j)(i[n+4],r,e/c)}L=i}if(Sh(m,L,L.length))return!1;const N=_.lines,U=ec,H=tc;for(const R of N){(0,Ge.n)(H,R.direction);for(const e of I){const t=L[e];if((0,Ge.n)(U,t),dc(H,U,L,y))return!1;const i=(e+1)%4;if(n){const e=L[i];if((0,Ge.z)(U,e,t),(0,Ge.n)(U,U),dc(H,U,L,y))return!1}if(r){const t=L[4+e],n=L[4+i];if((0,Ge.z)(U,n,t),(0,Ge.n)(U,U),dc(H,U,L,y))return!1}}}return!0}_calculateSingleTileVisibilitySided(e,t){return this._isTileVisibleInFrustum(e)?(this._intersector.update(e.extent,e.tilingScheme.spatialReference,this._surfaceElevation,t),this._intersector.isVisibleInFrustum(this._frustum,this._renderSREllipsoidRadius,!0)?th.E.VISIBLE_ON_SURFACE:th.E.VISIBLE_WHEN_EXTENDED):th.E.INVISIBLE}_updateExtendedFrustum(e){this._extendedFrustum.update(e),yh(this._extendedFrustum);const t=this._renderCoordsHelper.worldUpAtPosition(e.eye,mh);this._aboveGround||(0,Ge.k)(t,t);const i=(0,me.ZF)(-(0,Ge.m)(t,e.viewForward));if(this._hasExtendedFrustum=i>e.fovY/2,!this._hasExtendedFrustum)return;const n=this._extendedFrustumParameters(),r=this._extendedFrustum.mutablePoints;for(let s=0;s<4;s++){const e=n.pointIndices[s],t=r[e],i=this._renderCoordsHelper.getAltitude(t);if(n.needsAltitudeAdjustment(i)){switch(this._renderCoordsHelper.worldUpAtPosition(t,mh),e){case ih.NQ.FAR_BOTTOM_LEFT:case ih.NQ.FAR_TOP_LEFT:case ih.NQ.NEAR_BOTTOM_LEFT:case ih.NQ.NEAR_TOP_LEFT:(0,jr._l)(this._extendedFrustum.planes[ih.Nu.LEFT],mh,mh);break;case ih.NQ.FAR_BOTTOM_RIGHT:case ih.NQ.FAR_TOP_RIGHT:case ih.NQ.NEAR_BOTTOM_RIGHT:case ih.NQ.NEAR_TOP_RIGHT:(0,jr._l)(this._extendedFrustum.planes[ih.Nu.RIGHT],mh,mh)}(0,Ge.j)(mh,mh,n.direction),this._renderCoordsHelper.intersectInfiniteManifold((0,wn.re)(t,mh),n.zWithMargin,t)}}if(this._extendedFrustum.updatePoints(r),(0,jr.zk)(r[ih.NQ.NEAR_BOTTOM_LEFT],r[ih.NQ.NEAR_BOTTOM_RIGHT],r[ih.NQ.NEAR_TOP_RIGHT],gh),(0,jr.zk)(r[ih.NQ.NEAR_BOTTOM_RIGHT],r[ih.NQ.NEAR_TOP_RIGHT],r[ih.NQ.NEAR_TOP_LEFT],fh),(0,Ge.m)((0,jr.st)(gh),(0,jr.st)(fh))<0){const e=this._extendedFrustum.mutablePoints;this._aboveGround?[e[ih.NQ.NEAR_BOTTOM_LEFT],e[ih.NQ.NEAR_BOTTOM_RIGHT]]=[e[ih.NQ.NEAR_BOTTOM_RIGHT],e[ih.NQ.NEAR_BOTTOM_LEFT]]:[e[ih.NQ.NEAR_TOP_LEFT],e[ih.NQ.NEAR_TOP_RIGHT]]=[e[ih.NQ.NEAR_TOP_RIGHT],e[ih.NQ.NEAR_TOP_LEFT]],this._extendedFrustum.updatePoints(e)}}_extendedFrustumParameters(){return this._aboveGround?this._extendedFrustumParametersAboveSurface():this._extendedFrustumParametersBelowSurface()}_extendedFrustumParametersAboveSurface(){const e=this._surfaceElevation-_h;return{zWithMargin:e,pointIndices:Pa.i.planePointIndices.bottom,direction:-1,needsAltitudeAdjustment:t=>t>e}}_extendedFrustumParametersBelowSurface(){const e=this._surfaceElevation+_h;return{zWithMargin:e,pointIndices:Pa.i.planePointIndices.top,direction:1,needsAltitudeAdjustment:t=>t<e}}}const ch=2,dh=6,uh=12,ph=.95,_h=1,mh=(0,R.Ue)(),gh=(0,jr.Ue)(),fh=(0,jr.Ue)(),vh=new rh.Z(Array,(e=>{4!==e.length&&(e[0]=new th.C,e[1]=new th.C,e[2]=new th.C,e[3]=new th.C)}),(e=>{e[0].release(),e[1].release(),e[2].release(),e[3].release()}));function yh(e){const t=Pa.i.nearFarLineIndices,i=e.mutablePoints;for(const n of t){const[e,t]=n,r=i[e],s=i[t];(0,Ge.f)(mh,s,r),(0,Ge.j)(mh,mh,ph),(0,Ge.g)(i[t],r,mh)}e.updatePoints(i)}function bh(e,t,i){return(0,Ge.b)(e,t,i),(0,Ge.n)(e,e),e}function wh(e,t,i){return(0,Ge.z)(e,t,i),(0,Ge.n)(e,e),e}function Ch(e,t){return(0,Ge.j)(e,e,t/(0,Ge.H)(e)),e}const xh=[ih.Nu.LEFT,ih.Nu.RIGHT,ih.Nu.BOTTOM,ih.Nu.TOP,ih.Nu.FAR];function Th(e,t,i){for(let n=0;n<i;++n)if((0,jr.jH)(e,t[n])<=0)return!1;return!0}function Sh(e,t,i){for(const n of xh)if(Th(e[n],t,i))return!0;return!1}const Ph=4;function Mh(e,t,i){for(const n of t)if((0,Ge.m)(n,e)<i)return!1;return!0}const Rh=[(0,R.Ue)(),(0,R.Ue)(),(0,R.Ue)(),(0,R.Ue)(),(0,R.Ue)(),(0,R.Ue)(),(0,R.Ue)(),(0,R.Ue)()],Ah=[0,0,0,0,0,0],Oh=[(0,R.Ue)(),(0,R.Ue)(),(0,R.Ue)(),(0,R.Ue)(),(0,R.Ue)(),(0,R.Ue)()],Eh=(0,R.Ue)(),Dh=(0,R.Ue)(),Ih=(0,R.Ue)(),Lh=(0,R.Ue)(),Nh=(0,R.Ue)(),Uh=(0,R.Ue)(),Hh=(0,R.Ue)(),Fh=(0,R.Ue)(),Vh=(0,R.Ue)(),qh=(0,R.Ue)(),zh=(0,R.Ue)(),Bh=(0,R.Ue)(),Gh=(0,R.al)(0,0,0),kh=(0,R.Ue)(),Zh=[(0,R.Ue)(),(0,R.Ue)(),(0,R.Ue)(),(0,R.Ue)(),(0,R.Ue)(),(0,R.Ue)(),(0,R.Ue)(),(0,R.Ue)()],jh=[(0,R.Ue)(),(0,R.Ue)(),(0,R.Ue)(),(0,R.Ue)(),(0,R.Ue)()],Wh=(0,R.Ue)(),Xh=(0,R.Ue)(),Qh=(0,R.Ue)(),Yh=(0,R.Ue)(),Jh=(0,R.Ue)(),Kh=(0,R.Ue)(),$h=(0,R.Ue)(),ec=(0,R.Ue)(),tc=(0,R.Ue)(),ic=(0,R.Ue)(),nc=[0,1,2,3],rc=[0,1,2,3],sc=[0,1,3],ac=[0,1,3],oc=[1,2,3],lc=[1,2,3],hc=(0,R.Ue)();const cc=[0,0];function dc(e,t,i,n){if(0===i.length||0===n.length)return!0;const r=ic;bh(r,e,t);const s=n[0]<i[0],a=s?i:n,o=cc;return function(e,t,i){let n=1/0,r=-1/0;for(const s of i){const e=(0,Ge.m)(t,s);n=Math.min(n,e),r=Math.max(r,e)}e[0]=n,e[1]=r}(o,r,s?n:i),function(e,t,i,n){let r=1/0,s=-1/0;for(const a of n){const n=(0,Ge.m)(i,a);if(r=Math.min(r,n),s=Math.max(s,n),r<=t&&s>=e)return!1}return!0}(o[0],o[1],r,a)}const uc=430,pc=(0,R.Ue)(),_c=(0,R.Ue)(),mc=Math.cos(.25*Math.PI);class gc{constructor(e){this._camera=new Sr.Z,this._focusOnMap=[0,0],this._screenRect=(0,L.Ue)(),this._tileSize=e.tileSize,this._renderCoordsHelper=e.renderCoordsHelper,this._tilingScheme=e.tilingScheme,this._visibility=new hh(e.renderCoordsHelper,e.getIsGroundOpaque)}begin(e,t,i){this._camera.copyFrom(e),this._surfaceElevation=i,this._focusOnMap[0]=t.x,this._focusOnMap[1]=t.y,(0,L.al)(0,0,e.fullWidth,e.fullHeight,this._screenRect),this._visibility.begin(this._camera,i)}end(){this._visibility.end()}updateTile(e){e.measures.visibility=this._visibility.calculate(e),e.measures.distance=(0,L.TE)(e.extent,this._focusOnMap),e.measures.visibility!==th.E.INVISIBLE&&this._updateScreenMeasure(e)}_updateScreenMeasure(e){const t=fc,i=1<<t,n=e.measures.screenRect;(0,L.cS)(n);let r=0;const s=e.lij,a=s[0],o=a+t,l=s[1]<<t,h=s[2]<<t,c=this._tileSizeWithBias(e),d=c*c,u=this._camera,{frustum:p,viewport:_}=u;if(this._renderCoordsHelper.viewingMode===te.JY.Local||a>Ph){const t=bc;this._tilingScheme.getExtent(s[0],s[1],s[2],t);const i=yc,n=Pc,r=(0,L.cS)();for(let e=0;e<4;++e)this._toRenderCoords(t,Mc[e][0],Mc[e][1],n[e]),u.projectToScreen(n[e],i[e]),(0,L.Ho)(r,i[e]);const a=Sh(p,n,4),o=r[0]>_[2]||r[1]>_[3]||r[2]<_[0]||r[3]<_[1];if(a||o)return void(e.measures.shouldSplit=!1)}for(let m=0;m<i;m++)for(let t=0;t<i;t++)if(r+=this._computeScreenArea(o,l+m,h+t,n),r>d)return void(e.measures.shouldSplit=!0);e.measures.shouldSplit=!1}_tileSizeWithBias(e){return e.measures.visibility===th.E.VISIBLE_WHEN_EXTENDED?this._tileSize*vc:this._tileSize}_computeScreenArea(e,t,i,n){this._tilingScheme.ensureMaxLod(e);const r=bc;this._tilingScheme.getExtent(e,t,i,r);const s=Cc;return this._toRenderCoords(r,0,3,s[0]),this._toRenderCoords(r,2,3,s[1]),this._toRenderCoords(r,2,1,s[2]),this._toRenderCoords(r,0,1,s[3]),this._computeTriangleScreenArea([s[0],s[1],s[2]],n)+this._computeTriangleScreenArea([s[2],s[1],s[3]],n)}_computeTriangleScreenArea(e,t){const i=this._camera.frustum[ih.Nu.NEAR];let n=0,r=-1,s=-1;for(let a=0;a<3;++a)(0,jr.jH)(i,e[a])>0?(n++,-1===r&&(r=a)):-1===s&&(s=a);if(0===n)return this._computeTriangleScreenAreaInside(e,t);if(1===n){const n=Tc,s=(r+1)%3,a=(r+2)%3,o=r;(0,Ge.c)(n[0],e[s]),(0,Ge.c)(n[1],e[a]),Sc(n[2],e[a],e[o],i);const l=this._computeTriangleScreenAreaInside(n,t);return Sc(n[1],e[s],e[o],i),l+this._computeTriangleScreenAreaInside(n,t)}if(2===n){const n=Tc,r=s;(0,Ge.c)(n[0],e[r]);const a=(s+1)%3,o=(s+2)%3;return Sc(n[1],e[r],e[a],i),Sc(n[2],e[r],e[o],i),this._computeTriangleScreenAreaInside(n,t)}return 0}_computeTriangleScreenAreaInside(e,t){for(let i=0;i<3;i++)this._camera.projectToRenderScreen(e[i],xc),this._camera.renderToScreen(xc,yc[i]),(0,L.jn)(t,yc[i],t);return(0,nh.wu)(yc[0],yc[1],yc[2])}_toRenderCoords(e,t,i,n){return wc[0]=e[t],wc[1]=e[i],wc[2]=this._surfaceElevation,this._renderCoordsHelper.toRenderCoords(wc,this._tilingScheme.spatialReference,n),n}}const fc=2,vc=5,yc=[(0,v.s1)(),(0,v.s1)(),(0,v.s1)(),(0,v.s1)()],bc=(0,L.Ue)(),wc=(0,R.Ue)(),Cc=[(0,R.Ue)(),(0,R.Ue)(),(0,R.Ue)(),(0,R.Ue)()],xc=(0,v.J$)(),Tc=[(0,R.Ue)(),(0,R.Ue)(),(0,R.Ue)()];function Sc(e,t,i,n){const r=(0,jr.jH)(n,t),s=(0,jr.jH)(n,i),a=Math.abs(s-r);(0,Ge.j)(e,t,Math.abs(s)/a),(0,Ge.r)(e,e,i,Math.abs(r)/a)}const Pc=[(0,R.Ue)(),(0,R.Ue)(),(0,R.Ue)(),(0,R.Ue)()],Mc=[[0,3],[2,3],[2,1],[0,1]];var Rc=i(65206);let Ac=class extends T.default{get tilingScheme(){const e=this.tilingSchemeOwner.tilingScheme;return e?e.clone():null}set filterExtent(e){if(null!=e&&!e.spatialReference.equals(this.viewState.spatialReference))return void u.Z.getLogger(this).error("#extent","extent spatial reference needs to be in the same spatial reference as the view");const t=this._get("filterExtent");if(t===e||null!=t&&e&&t.equals(e))return;const i=null!=e?e.clone():null;this._set("filterExtent",i),this._setDirty()}get _filterExtentRect(){if(null==this.filterExtent)return null;const e=(0,L.Ue)();return(0,Rc.G)(this.filterExtent,e,this.tilingScheme.spatialReference),e}get _rootTileIds(){const{tilingScheme:e}=this;return this._filterExtentRect&&e?e.rootTilesInExtent(this._filterExtentRect):[[0,0,0]]}set suspended(e){e!==this._get("suspended")&&(this._set("suspended",e),this._setDirty())}get updating(){return this._dirty||!!this._pendingTiles}constructor(e){super(e),this.tiles=new a.Z,this.tileSize=512,this._idToTile=new Map,this._clients=new Set,this._dirty=!1,this._pendingTiles=null,this._newTiles=new pl.Z}initialize(){this.addHandles([(0,g.watch)((()=>[this.tilingScheme,this.tileSize]),(()=>this._reset()),g.sync),(0,g.watch)((()=>{var e,t,i;return[this.tileSize,null===(e=this.cameraOnSurface)||void 0===e?void 0:e.location,this.tilingScheme,null===(t=this.viewState)||void 0===t?void 0:t.contentCamera,null===(i=this.focus)||void 0===i?void 0:i.location]}),(()=>this._setDirty()),g.syncAndInitial),(0,g.watch)((()=>{var e,t;return null!==(e=null===(t=this.terrain)||void 0===t?void 0:t.baseOpacity)&&void 0!==e?e:1}),(()=>this._setDirty()))]),this.scheduler&&(this._frameWorker=this.scheduler.registerTask(Bt.T8.FEATURE_TILE_TREE,this))}destroy(){this._frameWorker=(0,p.hw)(this._frameWorker)}addClient(){const e=(0,eh.D)();return this._clients.add(e),1===this._clients.size&&this._setDirty(),(0,c.kB)((()=>this._removeClient(e)))}_removeClient(e){this._clients.delete(e),this._hasClients||this._clear()}get _hasClients(){return this._clients.size>0}_setDirty(){!this._hasClients||this.suspended||this._dirty||(this._frameWorker?(this._dirty=!0,this.notifyChange("updating")):this.runTask(Bt.G5))}_clear(){this.tiles.removeAll(),this._idToTile.clear(),this._reset(),this._dirty=!1,this.notifyChange("updating")}get running(){return this.updating}runTask(e){this._dirty=!1,this._pendingTiles||(this._startUpdate(),null!=this._frameWorker&&(this._frameWorker.priority=Bt.T8.FEATURE_TILE_TREE_ACTIVE)),this._subdivideTilesForView(e),this._pendingTiles||null==this._frameWorker||(this._frameWorker.priority=Bt.T8.FEATURE_TILE_TREE),this.notifyChange("updating")}_startUpdate(){var e;if(this.suspended)return;if(!this.tilingScheme)return void this._clear();this._tileMeasurements||(this._tileMeasurements=new gc({renderCoordsHelper:this.renderCoordsHelper,tilingScheme:this.tilingScheme,tileSize:this.tileSize,getIsGroundOpaque:()=>{var e,t;return 1===(null!==(e=null===(t=this.terrain)||void 0===t?void 0:t.baseOpacity)&&void 0!==e?e:1)}}));const t=this.viewState.contentCamera;this._tileMeasurements.begin(t,this.focus.location,null!==(e=this.cameraOnSurface.location.z)&&void 0!==e?e:0),this._pendingTiles=this._getRootTiles()}_reset(){this._newTiles.clear(),this._tileMeasurements=null,this._pendingTiles=null,this._setDirty()}_getRootTiles(){const{tilingScheme:e}=this;return this._rootTileIds.map((t=>new th.C(t[0],t[1],t[2],e)))}_purgeHorizonTiles(e){if(e.sort(((e,t)=>{const i=e.measures.screenRect,n=t.measures.screenRect;return i[1]+i[3]-(n[1]+n[3])})),!(e.length>Dc))return e.toArray();(0,L.cS)(Oc);for(let t=0;t<e.length;t++)if((0,L.jn)(Oc,e.data[t].measures.screenRect,Oc),(0,L.Cb)(Oc)>Ec)return e.data.slice(t,e.length);return[]}_subdivideTilesForView(e){if(!this._pendingTiles)return;const{tilingScheme:t}=this;for(;this._pendingTiles.length>0&&!e.done;){const i=this._pendingTiles.pop();e.madeProgress(),this._filterExtentRect&&!(0,L.kK)(this._filterExtentRect,i.extent)||(this._tileMeasurements.updateTile(i),i.measures.visibility!==th.E.INVISIBLE&&(i.measures.shouldSplit?(t.ensureMaxLod(i.lij[0]+1),this._pendingTiles.push(...i.getChildren())):this._newTiles.push(i)))}0===this._pendingTiles.length&&(this._updateTiles(this._purgeHorizonTiles(this._newTiles)),this._newTiles.clear(),this._tileMeasurements.end(),this._pendingTiles=null)}_updateTiles(e){for(const n of this.tiles.items)n.used=!1;const t=e.filter((e=>{const t=this._idToTile.get(e.id);return t?(t.copyMeasurementsFrom(e),t.used=!0):this._idToTile.set(e.id,e),!t})),i=this.tiles.items.filter((e=>!e.used&&(this._idToTile.delete(e.id),!0)));this.tiles.removeMany(i),this.tiles.addMany(t),this._sortTiles()}_sortTiles(){this.viewState.fixedContentCamera||this.tiles.sort(((e,t)=>e.measures.visibility!==t.measures.visibility?e.measures.visibility===th.E.VISIBLE_ON_SURFACE?-1:1:e.measures.distance-t.measures.distance)),this.tiles.forEach(((e,t)=>e.loadPriority=t))}};(0,n._)([(0,b.Cb)({constructOnly:!0})],Ac.prototype,"scheduler",void 0),(0,n._)([(0,b.Cb)({constructOnly:!0})],Ac.prototype,"renderCoordsHelper",void 0),(0,n._)([(0,b.Cb)({constructOnly:!0})],Ac.prototype,"tilingSchemeOwner",void 0),(0,n._)([(0,b.Cb)({constructOnly:!0})],Ac.prototype,"cameraOnSurface",void 0),(0,n._)([(0,b.Cb)({constructOnly:!0})],Ac.prototype,"focus",void 0),(0,n._)([(0,b.Cb)({constructOnly:!0})],Ac.prototype,"viewState",void 0),(0,n._)([(0,b.Cb)({constructOnly:!0})],Ac.prototype,"terrain",void 0),(0,n._)([(0,b.Cb)()],Ac.prototype,"tiles",void 0),(0,n._)([(0,b.Cb)()],Ac.prototype,"tileSize",void 0),(0,n._)([(0,b.Cb)({readOnly:!0})],Ac.prototype,"tilingScheme",null),(0,n._)([(0,b.Cb)()],Ac.prototype,"filterExtent",null),(0,n._)([(0,b.Cb)({readOnly:!0})],Ac.prototype,"_filterExtentRect",null),(0,n._)([(0,b.Cb)({readOnly:!0})],Ac.prototype,"_rootTileIds",null),(0,n._)([(0,b.Cb)({value:!1})],Ac.prototype,"suspended",null),(0,n._)([(0,b.Cb)({readOnly:!0})],Ac.prototype,"updating",null),Ac=(0,n._)([(0,C.j)("esri.views.3d.layers.support.FeatureTileTree3D")],Ac);const Oc=(0,L.Ue)(),Ec=10,Dc=50;var Ic=i(3073);let Lc=class extends T.default{constructor(){super(...arguments),this._propertiesPool=new Oa.L({camera:Sr.Z},this),this._lastSeenCameraProjectionValues=new Sr.Z,this.mode=Ia.n.ANIMATING,this._cssCamera=new Sr.Z,this._camera=new Sr.Z,this.rasterPixelRatio=1,this.contentPixelRatio=1,this.events=new G.Z,this.viewingMode=te.JY.Global,this._cameraChanged=!1,this._updateQueue=new Array,this._processingUpdates=!1}init(e,t){this._set("viewingMode",e),this._set("spatialReference",t),this._set("constraints",new ve({mode:this.viewingMode}))}exit(){this.cameraController=null,this._propertiesPool.destroy(),this._propertiesPool=new Oa.L({camera:Sr.Z},this)}destroy(){var e;this.cameraController=null,null!==(e=this._propertiesPool)&&void 0!==e&&e.destroy(),this._propertiesPool=null}createInitialCamera(){if(this.viewingMode===te.JY.Global){const e=(0,Ze.Iu)(this.spatialReference).radius;this.camera=new Sr.Z({eye:(0,R.al)(4*e,0,0),center:(0,R.al)(e,0,0),up:(0,R.al)(0,0,1)})}else this.camera=new Sr.Z({eye:(0,R.al)(0,0,100),center:(0,R.al)(0,0,0),up:(0,R.al)(0,1,0)})}get animation(){return this.cameraController instanceof Er&&null!=this.cameraController.viewAnimation?this.cameraController.viewAnimation:null}get cssCamera(){const e=this._cssCamera.copyFrom(this.camera),{height:t,width:i,pixelRatio:n}=this.camera;return e.pixelRatio=1,e.height=Math.round(t/n),e.width=Math.round(i/n),e}get camera(){return this._camera}set camera(e){e!==Uc&&Uc.copyFrom(e),Uc.computeUp(this.viewingMode),this.events.emit("before-camera-change",Uc);const t=this._camera;if(function(e,t){return e.fov!==t.fov||e.fullViewport[0]!==t.fullViewport[0]||e.fullViewport[1]!==t.fullViewport[1]||e.fullViewport[2]!==t.fullViewport[2]||e.fullViewport[3]!==t.fullViewport[3]||e.padding[Ea.Np.TOP]!==t.padding[Ea.Np.TOP]||e.padding[Ea.Np.RIGHT]!==t.padding[Ea.Np.RIGHT]||e.padding[Ea.Np.BOTTOM]!==t.padding[Ea.Np.BOTTOM]||e.padding[Ea.Np.LEFT]!==t.padding[Ea.Np.LEFT]}(this._lastSeenCameraProjectionValues,Uc)&&(this._lastSeenCameraProjectionValues.copyFrom(Uc),this.events.emit("camera-projection-changed",this._lastSeenCameraProjectionValues)),!t.equals(Uc)&&(this._camera=this._propertiesPool.get("camera").copyFrom(Uc),this._cameraChanged=!t.almostEquals(Uc),this._cameraChanged)){const e=(0,Ic.Fs)((()=>{this._cameraChanged=!1,e.remove()}))}}get pixelRatio(){return this.camera.pixelRatio}get alignPixelEnabled(){return this.pixelRatio===this.rasterPixelRatio&&this.mode===Ia.n.IDLE}get updating(){return this.mode!==Ia.n.IDLE}get contentCamera(){var e;return null!==(e=this._contentCamera)&&void 0!==e?e:this.camera}set contentCamera(e){this._contentCamera=null!=e?e.clone():null}get fixedContentCamera(){return null!=this._contentCamera}get isGlobal(){return this.viewingMode===te.JY.Global}get isLocal(){return this.viewingMode===te.JY.Local}get navigating(){var e;return!(null===(e=this.cameraController)||void 0===e||!e.isInteractive)}get stationary(){return!this._cameraChanged&&!this.navigating}get cameraController(){return this._get("cameraController")}set cameraController(e){var t;this.stopActiveCameraController()?(null!==(t=this.cameraController)&&void 0!==t&&t.destroy(),e&&(this.removeHandles(Hc),this.addHandles((0,g.when)((()=>e.state===Ar.Finished||e.state===Ar.Stopped),(()=>{this._set("cameraController",null),this.updateCamera((t=>e.onControllerEnd(t)))}),{sync:!0,once:!0}),Hc),e.onControllerStart(this.camera)),this._set("cameraController",e)):e&&(e.state=Ar.Rejected)}switchCameraController(e){return this.cameraController=e,e.state!==Ar.Rejected}stopActiveCameraController(){return!(this.cameraController&&!this.cameraController.stopController())}updateCamera(e){this._updateQueue.push(e),this._processUpdateQueue()}_processUpdateQueue(){if(0===this._updateQueue.length||this._processingUpdates)return;this._processingUpdates=!0;const e=this._updateQueue.shift();Uc.copyFrom(this._get("camera")),e(Uc),this.camera=Uc,this._processingUpdates=!1,this._processUpdateQueue()}};(0,n._)([(0,b.Cb)()],Lc.prototype,"mode",void 0),(0,n._)([(0,b.Cb)({readOnly:!0,type:ee.Z})],Lc.prototype,"animation",null),(0,n._)([(0,b.Cb)({type:Sr.Z})],Lc.prototype,"cssCamera",null),(0,n._)([(0,b.Cb)()],Lc.prototype,"_cssCamera",void 0),(0,n._)([(0,b.Cb)({type:Sr.Z})],Lc.prototype,"camera",null),(0,n._)([(0,b.Cb)()],Lc.prototype,"_camera",void 0),(0,n._)([(0,b.Cb)({readOnly:!0})],Lc.prototype,"pixelRatio",null),(0,n._)([(0,b.Cb)()],Lc.prototype,"rasterPixelRatio",void 0),(0,n._)([(0,b.Cb)()],Lc.prototype,"contentPixelRatio",void 0),(0,n._)([(0,b.Cb)({readOnly:!0})],Lc.prototype,"alignPixelEnabled",null),(0,n._)([(0,b.Cb)({readOnly:!0})],Lc.prototype,"updating",null),(0,n._)([(0,b.Cb)({})],Lc.prototype,"_contentCamera",void 0),(0,n._)([(0,b.Cb)({type:Sr.Z})],Lc.prototype,"contentCamera",null),(0,n._)([(0,b.Cb)({readOnly:!0})],Lc.prototype,"fixedContentCamera",null),(0,n._)([(0,b.Cb)({readOnly:!0})],Lc.prototype,"constraints",void 0),(0,n._)([(0,b.Cb)({readOnly:!0})],Lc.prototype,"events",void 0),(0,n._)([(0,b.Cb)({readOnly:!0})],Lc.prototype,"isGlobal",null),(0,n._)([(0,b.Cb)({readOnly:!0})],Lc.prototype,"isLocal",null),(0,n._)([(0,b.Cb)({readOnly:!0})],Lc.prototype,"viewingMode",void 0),(0,n._)([(0,b.Cb)({readOnly:!0})],Lc.prototype,"spatialReference",void 0),(0,n._)([(0,b.Cb)()],Lc.prototype,"navigating",null),(0,n._)([(0,b.Cb)()],Lc.prototype,"stationary",null),(0,n._)([(0,b.Cb)()],Lc.prototype,"_cameraChanged",void 0),(0,n._)([(0,b.Cb)()],Lc.prototype,"cameraController",null),Lc=(0,n._)([(0,C.j)("esri.views.3d.state.ViewState")],Lc);const Nc=Lc;const Uc=new Sr.Z,Hc="ViewStateHandles";var Fc=i(74509),Vc=i(9985),qc=i(54463),zc=i(22178);class Bc{constructor(e,t,i){this.viewingMode=e,this._forEachLayer=t,this._view=i,this._externalIntersectionHandlers=new pl.Z,this._tolerance=Dr.jb,this._tmpRay=(0,wn.Ue)(),this._tmpRegion=(0,L.Ue)(),this._validateHUDIntersector=(0,Dr.Z8)(this.viewingMode),this._validateHUDIntersector.options.hud=!1}intersectScreen(e,t,i){return this.intersectRay(this._getPickRay(e,this._tmpRay),Wc(this.viewingMode),t,i)}intersectScreenFreePointFallback(e,t,i){return this.intersectRayFreePointFallback(this._getPickRay(e,this._tmpRay),t,i)}intersectRayFreePointFallback(e,t,i){return this.intersectRay(e,Wc(this.viewingMode),t,i)||this._intersectRayFreePointLocal(e,t)}intersectRay(e,t,i,n){return t.options.selectionMode=!1,t.options.store=qc.eC.MIN,this.computeIntersection(e,t,n),!!t.results.min&&t.results.min.getIntersectionPoint(i)}getCenterRayWithSubpixelOffset(e,t){let i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:.5,n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:.5;return e.getRenderCenter(Kc,i,n),Kc[0]+=.0466,Kc[1]-=.0123,(0,Wr.eW)(e,Kc,t)}intersectIntersectorScreen(e,t,i){this.computeIntersection(this._getPickRay(e,this._tmpRay),t,i)}intersectToolIntersectorScreen(e,t,i){const n=this._getPickRay(e,this._tmpRay);this.intersectToolIntersectorRay(n,t,i)}intersectToolIntersectorRay(e,t,i){t.options.selectionMode=!0,this.computeIntersection(e,t,i);const n=t.results.min;this._view.basemapTerrain&&this._view.basemapTerrain.opaque||(0,zc.nn)(n)&&n.intersector!==qc.q7.TERRAIN||(t.options.selectionMode=!1,this.computeIntersection(e,t,i))}setTolerance(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:Dr.jb;this._tolerance=e}addIntersectionHandler(e){this._externalIntersectionHandlers.push(e),this._externalIntersectionHandlers.sort(((e,t)=>e.type===qc.q7.TERRAIN?1:t.type===qc.q7.TERRAIN?-1:0))}removeIntersectionHandler(e){null!=this._externalIntersectionHandlers.removeUnordered(e)&&this._externalIntersectionHandlers.sort(((e,t)=>e.type===qc.q7.TERRAIN?1:t.type===qc.q7.TERRAIN?-1:0))}_getPickRay(e,t){const i=this._view.state.camera;return(0,Wr.u4)(i,e,t)}_intersectRayFreePointLocal(e,t){return this.viewingMode!==te.JY.Local||null==e||(0,Ge.g)(t,e.origin,(0,Ge.n)(qr.WM.get(),e.direction)),!1}intersectElevationFromScreen(e,t){let i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null;return this._intersectElevation(this._getPickRay(e,this._tmpRay),t,i,n)}_intersectElevation(e,t){let i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null;if(null==e)return null;const r=this._view,{renderCoordsHelper:s}=r,a=(0,pa._R)(r.spatialReference),o=null!=t?t.mode:"absolute-height",l=(0,Fc.fm)(t)/a,h=("on-the-ground"!==o?l+i:0)*a/s.unitInMeters,{camera:c}=r.state;if("absolute-height"===o){const t=null===s||void 0===s?void 0:s.getAltitude(c.eye),i=(0,Ge.m)((0,Ge.n)(Yc,e.direction),s.worldUpAtPosition(c.eye,Jc));if(t<h&&i<0||t>=h&&i>0)return null;if(s.intersectInfiniteManifold(e,h,Yc)){var d;const e=(0,Vc.K0)(r,Yc);return null!==(d=e.z)&&void 0!==d||(e.z=0),e.z-=l,e}return null}const u=(0,v.Wv)(qr.WM.get());c.projectToRenderScreen(e.origin,u);const p=new Xc(null,this._forEachLayer),{slicePlane:_}=r,m=null!=_?(0,zc.e4)(_):null,g=(0,Dr.Z8)(this.viewingMode);g.options.store=qc.eC.MIN,g.options.verticalOffset=h,g.options.normalRequired=!1;const f=e.origin,y=(0,Ge.g)(qr.WM.get(),f,e.direction);g.reset(f,y,c),g.point=u;const b=n?"type"in n&&"graphics"===n.type?e=>e.layerUid!==n.uid:e=>e.graphicUid!==n.uid:null;switch(o){case"relative-to-scene":{const e=e=>(!b||b(e))&&!!e.lastValidElevationBB;g.intersect(p.layers,u,this._tolerance,null,e),this._externalIntersectionHandlers.forAll((e=>{if(e.type===qc.q7.I3S||e.type===qc.q7.TERRAIN||e.type===qc.q7.TILES3D){const t=e.slicePlaneEnabled?m:null;e.intersect(g,t,g.rayBegin,g.rayEnd,u)}}));break}case"on-the-ground":case"relative-to-ground":this._externalIntersectionHandlers.forAll((e=>{if(e.isGround){const t=e.slicePlaneEnabled?m:null;e.intersect(g,t,g.rayBegin,g.rayEnd,u)}}))}if(g.results.min.getIntersectionPoint(Yc)){const e=(0,Vc.K0)(r,Yc);return e.z=i,e}return null}computeIntersection(e,t,i,n){if(null==e)return;const r=this._view.state.camera,s=(0,v.Wv)(qr.WM.get());r.projectToRenderScreen(e.origin,s);const a=new Xc(i,this._forEachLayer);t.options.selectOpaqueTerrainOnly=!i||!("include"in i||"exclude"in i);const o=e.origin,l=(0,Ge.g)(qr.WM.get(),e.origin,e.direction);t.reset(o,l,r),t.intersect(a.layers,s,this._tolerance);const h=this._view.slicePlane,c=null!=h?(0,zc.e4)(h):null;t.intersect(a.sliceableLayers,s,this._tolerance,c);const d=i&&(i.requiresGroundFeedback||i.enableDraped);this._externalIntersectionHandlers.forAll((e=>{const i=e.layerUid,r=Array.isArray(i),h=r?i:[i];r&&(t.options.filteredLayerUids=[]);let u=!1;for(const n of h)a.filterLayerUid(n)?u=!0:r&&t.options.filteredLayerUids.push(n);if(t.options.isFiltered=!u,e.isGround&&d||!t.options.isFiltered){const i=e.slicePlaneEnabled?c:null;e.intersect(t,i,o,l,s,n)}}));const u=qr.WM.get(),p=this._view.basemapTerrain;if(i&&i.enableDraped&&null!=p.spatialReference&&t.results.ground.getIntersectionPoint(u)){var _,m;const e=p.overlayManager.renderer,i=this._view.renderCoordsHelper.spatialReference,n=qr.WM.get();this._view.renderCoordsHelper.fromRenderCoords(u,n,p.spatialReference),n[2]=null!==(_=null===(m=this._view.elevationProvider)||void 0===m?void 0:m.getElevation(u[0],u[1],u[2],i,"ground"))&&void 0!==_?_:0,e.intersect(t,n,t.results.ground,(e=>a.filterRenderGeometry(e)))}t.sortResults(),this._processHUDResults(t)}_processHUDResults(e){const t=e.results.hud;(0,L.JG)(this._tmpRegion,L.G_);const i=this._view.state.camera,n=[],r=this._tmpRegion,s=e=>{const t=new Zc(e);i.projectToRenderScreen(e.target.center,t.screenPoint),t.screenPoint[0]=Math.floor(t.screenPoint[0]),t.screenPoint[1]=Math.floor(t.screenPoint[1]),n.push(t),(0,L.Ho)(r,t.screenPoint)};e.sortResults(t.all),null!=t.min.dist&&s(t.min);for(const g of t.all)t.min.target.object!==g.target.object&&t.max.target.object!==g.target.object&&s(g);if(null!=t.max.dist&&t.max.target.object!==t.min.target.object&&s(t.max),!n.length)return;r[0]===r[2]&&(r[2]+=1),r[1]===r[3]&&(r[3]+=1);const a=i.fullWidth,o=i.fullHeight,l=Math.max(0,r[0]-Gc),h=Math.max(0,r[1]-Gc),c=Math.min((0,L.d_)(r)+2*Gc,a-l),d=Math.min((0,L.Cb)(r)+2*Gc,o-h);if(c<=0||d<=0)return;const u=new Uint8Array(c*d*4);this._view._stage.renderer.readHUDVisibility(l,h,c,d,u);let p=!0;const _=null==e.results.max.dist;let m=0;for(const g of n)for(const t of kc){const i=4*(Math.min(g.screenPoint[0]+t[0],a)-r[0]+(Math.min(g.screenPoint[1]+t[1],o)-r[1])*c);if(!(i<0||i>=u.length)&&u[i]){p&&(e.results.min.copy(g.result),p=!1),_&&e.results.max.copy(g.result),e.options.store===qc.eC.ALL&&e.results.all.splice(m++,0,g.result);break}}}}const Gc=1,kc=(()=>{const e=[],t=Gc;for(let i=-t;i<=t;i++)for(let n=-t;n<=t;n++)e.push([n+t,i+t]);return e})();class Zc{constructor(e){this.result=e,this.screenPoint=(0,v.J$)()}}let jc;function Wc(e){return jc&&jc.viewingMode===e||(jc=(0,Dr.Z8)(e)),jc}class Xc{constructor(e,t){this.layers=new Array,this.sliceableLayers=new Array,this.include=null===e||void 0===e?void 0:e.include,this.exclude=null===e||void 0===e?void 0:e.exclude,t((e=>{e.pickable&&this.filterLayerUid(e.apiLayerUid)&&(e.sliceable?this.sliceableLayers:this.layers).push(e)}))}filterLayerUid(e){const{include:t,exclude:i}=this;return null==e?null==t&&null==i:(null==t||t.has(e))&&(null==i||!i.has(e))}filterRenderGeometry(e){return this.filterLayerUid(e.layerUid)}}function Qc(e){return"object"==typeof e&&"intersect"in e}const Yc=(0,R.Ue)(),Jc=(0,R.Ue)(),Kc=(0,v.J$)();var $c=i(91293),ed=i(2985);let td=class extends(G.Z.EventedMixin(T.default)){get spatialReference(){var e;return null===(e=this.view)||void 0===e||null===(e=e.basemapTerrain)||void 0===e?void 0:e.spatialReference}constructor(e){super(e),this._im=new Array,this._ground=new Array,this._scene=new Array,this.lastElevationQuery=null,this._cacheEnabled=!1}destroy(){this._cachedQuery=(0,p.SC)(this._cachedQuery)}enableCache(e){e||(this.lastElevationQuery=null),this._cacheEnabled=e}getElevation(e,t,i,n,r){if(this._cacheEnabled&&null!=this.lastElevationQuery){const s=this.lastElevationQuery;if(e===s.x&&t===s.y&&i===s.z&&(0,ke.fS)(n,s.spatialReference)&&r===s.queryContext)return s.result}let s=null;return s=id(s,this._im,e,t,i,n,r),null==s&&(s=id(s,this._ground,e,t,i,n,r)),"scene"===r&&(s=id(s,this._scene,e,t,i,n,r)),this._cacheEnabled&&(this.lastElevationQuery={x:e,y:t,z:i,spatialReference:n,queryContext:r,result:s}),s}getSphereElevationBounds(e,t,i){const n=new ed.r;function r(r){for(const s of r)if(s.getSphereElevationBounds){const r=s.getSphereElevationBounds(e,t,i);null!=r&&n.expandElevationRangeValues(r.elevationRangeMin,r.elevationRangeMax)}}return r(this._ground),r(this._im),"scene"===i&&r(this._scene),n}getRootElevationBounds(){const e=new ed.r;for(const t of[this._im,this._ground,this._scene])t.forEach((t=>{if(t.getRootElevationBounds){const i=t.getRootElevationBounds();null!=i&&e.expandElevationRangeValues(i.elevationRangeMin,i.elevationRangeMax)}}));return e}async queryElevation(e,t,i,n,r){let s=arguments.length>5&&void 0!==arguments[5]?arguments[5]:null,a=arguments.length>6&&void 0!==arguments[6]?arguments[6]:0;const o=this._getElevationQuery(n);try{const l=await o.queryElevation(e,t,s,a);return"scene"===r?id(l,this._scene,e,t,i,n,r):l}catch(l){return(0,m.r9)(l),this.getElevation(e,t,i,n,r)}}register(e,t){this.addHandles(t.on("elevation-change",(e=>this.emit("elevation-change",e))),t),this._providersFromContext(e).push(t)}unregister(e){this.removeHandles(e);for(const t of[this._im,this._ground,this._scene]){const i=t.indexOf(e);i>-1&&t.splice(i,1)}}_providersFromContext(e){switch(e){case"ground":return this._ground;case"im":return this._im;case"scene":return this._scene}}_getElevationQuery(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:this.view.spatialReference;const t=this._cachedQuery;if(null!=t&&(0,ke.fS)(e,t.spatialReference))return t;null===t||void 0===t||t.destroy({completeTasks:!0});const{wkid:i,wkt:n,wkt2:r,latestWkid:s}=e,a=new $c.K(this.view.resourceController.scheduler,new k.Z({wkid:i,wkt:n,wkt2:r,latestWkid:s}),(()=>{var e;return null===(e=this.view.map)||void 0===e?void 0:e.ground}),{maximumAutoTileRequests:4});return this._cachedQuery=a,a}};function id(e,t,i,n,r,s,a){for(const o of t){const t=o.getElevation(i,n,r,s,a);null!=t&&(e=null!=e?Math.max(t,e):t)}return e}(0,n._)([(0,b.Cb)({constructOnly:!0})],td.prototype,"view",void 0),(0,n._)([(0,b.Cb)()],td.prototype,"spatialReference",null),td=(0,n._)([(0,C.j)("esri.views.3d.support.CombinedElevationProvider")],td);class nd{static isValidProfile(e){return e in nd.profiles}static getDefaultProfile(){return(0,d.Z)("esri-iPhone")?"low":"medium"}static apply(e,t){const i=nd.profiles[e];t.graphics3D.maxTotalNumberOfFeatures=i.graphics3D.maxTotalNumberOfFeatures,t.graphics3D.maxNumberOfDrawCalls=i.graphics3D.maxNumberOfDrawCalls,t.graphics3D.maxTotalNumberOfVertices=i.graphics3D.maxTotalNumberOfVertices,t.graphics3D.polygonLodFactor=i.graphics3D.polygonLodFactor,t.graphics3D.polylineLodFactor=i.graphics3D.polylineLodFactor,t.graphics3D.snapshotAvailable=i.graphics3D.snapshotAvailable,t.graphics3D.skipHighSymbolLods=i.graphics3D.skipHighSymbolLods,t.graphics3D.uncompressedTextureDownsamplingEnabled=i.graphics3D.uncompressedTextureDownsamplingEnabled;const n=t.sceneService.object,r=i.sceneService.object;n.lodFactor=r.lodFactor,t.sceneService.point.lodFactor=i.sceneService.point.lodFactor,t.sceneService.integratedMesh.lodFactor=i.sceneService.integratedMesh.lodFactor,t.sceneService.pointCloud.lodFactor=i.sceneService.pointCloud.lodFactor,t.sceneService.uncompressedTextureDownsamplingEnabled=i.sceneService.uncompressedTextureDownsamplingEnabled,t.tiledSurface.lodBias=i.tiledSurface.lodBias,t.tiledSurface.angledSplitBias=i.tiledSurface.angledSplitBias,t.tiledSurface.vtlContentZoom=i.tiledSurface.vtlContentZoom,t.tiledSurface.elevationLevelDelta=i.tiledSurface.elevationLevelDelta,t.tiledSurface.reduceTileLevelDifferences=i.tiledSurface.reduceTileLevelDifferences,t.heatmap.pixelRatio=i.heatmap.pixelRatio,t.heatmap.maxTotalNumberOfFeatures=i.heatmap.maxTotalNumberOfFeatures,t.fadeDuration=i.fadeDuration,t.antialiasingEnabled=i.antialiasingEnabled,t.physicallyBasedRenderingEnabled=i.physicalBasedRenderingEnabled,t.highQualityTransparency=i.highQualityTransparency,t.highResolutionAtmosphere=i.highResolutionAtmosphere,t.reflections=i.reflections,t.ambientOcclusion=i.ambientOcclusion,t.memoryLimit=i.memoryLimit,t.additionalCacheMemory=i.additionalCacheMemory,t.frameRate=i.frameRate,t.maximumPixelRatio=i.maximumPixelRatio}}nd.test={reset(){const e=sd();for(const t of Object.keys(e))nd.profiles[t]=e[t]}};const rd={IPhone12Pro:120,GalaxyS20:200,FullHD:240,SurfacePro7:300,FullHDRetina:430};function sd(){const e=!!(0,d.Z)("esri-mobile"),t=!!(0,d.Z)("ios"),i=(0,Ri.HA)(400);return{low:{graphics3D:{maxTotalNumberOfFeatures:25e3,maxNumberOfDrawCalls:8e3,maxTotalNumberOfVertices:255e4,polygonLodFactor:.5,polylineLodFactor:1,snapshotAvailable:!1,skipHighSymbolLods:!0,uncompressedTextureDownsamplingEnabled:!0},heatmap:{pixelRatio:.125,maxTotalNumberOfFeatures:5e4},sceneService:{object:{lodFactor:.2},point:{lodFactor:1},integratedMesh:{lodFactor:.6},pointCloud:{lodFactor:.5},uncompressedTextureDownsamplingEnabled:!0},tiledSurface:{lodBias:-1,angledSplitBias:.5,vtlContentZoom:.75,elevationLevelDelta:3,reduceTileLevelDifferences:!0},fadeDuration:(0,Ri.HA)(0),antialiasingEnabled:!1,physicalBasedRenderingEnabled:!1,highQualityTransparency:!1,highResolutionAtmosphere:!1,reflections:!1,ambientOcclusion:!1,memoryLimit:200+rd.IPhone12Pro,additionalCacheMemory:0,frameRate:0,maximumPixelRatio:1},medium:{graphics3D:{maxTotalNumberOfFeatures:1e5,maxNumberOfDrawCalls:17e3,maxTotalNumberOfVertices:625e4,polygonLodFactor:e?.8:1,polylineLodFactor:e?1.2:1.5,snapshotAvailable:!t,skipHighSymbolLods:!1,uncompressedTextureDownsamplingEnabled:e},heatmap:{pixelRatio:.25,maxTotalNumberOfFeatures:13e4},sceneService:{object:{lodFactor:1},point:{lodFactor:1},integratedMesh:{lodFactor:1},pointCloud:{lodFactor:1},uncompressedTextureDownsamplingEnabled:e},tiledSurface:{lodBias:0,angledSplitBias:1,vtlContentZoom:1.5,elevationLevelDelta:3,reduceTileLevelDifferences:!(0,d.Z)("disable-feature:reduce-map-tile-levels")},fadeDuration:i,antialiasingEnabled:!1,physicalBasedRenderingEnabled:!0,highQualityTransparency:!0,highResolutionAtmosphere:!1,reflections:!1,ambientOcclusion:!1,memoryLimit:e?600+rd.GalaxyS20:750+rd.FullHD,additionalCacheMemory:e?-100:150,frameRate:0,maximumPixelRatio:1},high:{graphics3D:{maxTotalNumberOfFeatures:1e5,maxNumberOfDrawCalls:17e3,maxTotalNumberOfVertices:125e5,polygonLodFactor:e?1.2:2,polylineLodFactor:e?1.2:2,snapshotAvailable:!t,skipHighSymbolLods:!1,uncompressedTextureDownsamplingEnabled:!1},heatmap:{pixelRatio:.5,maxTotalNumberOfFeatures:23e4},sceneService:{object:{lodFactor:1},point:{lodFactor:1},integratedMesh:{lodFactor:1},pointCloud:{lodFactor:1},uncompressedTextureDownsamplingEnabled:!1},tiledSurface:{lodBias:0,angledSplitBias:1,vtlContentZoom:1.5,elevationLevelDelta:2,reduceTileLevelDifferences:!(0,d.Z)("disable-feature:reduce-map-tile-levels")},fadeDuration:i,antialiasingEnabled:!0,physicalBasedRenderingEnabled:!0,highQualityTransparency:!0,highResolutionAtmosphere:!0,reflections:!0,ambientOcclusion:!0,memoryLimit:e?900+rd.SurfacePro7:1500+rd.FullHDRetina,additionalCacheMemory:e?-150:0,frameRate:0,maximumPixelRatio:e?1:1/0}}}!function(e){e.profiles=sd()}(nd||(nd={}));const ad=nd;var od=i(77648),ld=i(51995);const hd=new ld.Z([0,255,255]),cd=new ld.Z([0,0,0]);let dd=class extends T.default{constructor(){super(...arguments),this.color=hd.clone(),this.haloColor=null,this.haloOpacity=1,this.fillOpacity=.25,this.shadowOpacity=.4,this.shadowColor=cd.clone(),this.shadowDifference=.2}};(0,n._)([(0,b.Cb)({type:ld.Z})],dd.prototype,"color",void 0),(0,n._)([(0,b.Cb)({type:ld.Z})],dd.prototype,"haloColor",void 0),(0,n._)([(0,b.Cb)()],dd.prototype,"haloOpacity",void 0),(0,n._)([(0,b.Cb)()],dd.prototype,"fillOpacity",void 0),(0,n._)([(0,b.Cb)()],dd.prototype,"shadowOpacity",void 0),(0,n._)([(0,b.Cb)({type:ld.Z})],dd.prototype,"shadowColor",void 0),(0,n._)([(0,b.Cb)()],dd.prototype,"shadowDifference",void 0),dd=(0,n._)([(0,C.j)("esri.views.3d.support.HighlightOptions")],dd);const ud=dd;var pd,_d=i(67387),md=i(45362),gd=i(81943);class fd{constructor(e,t){this.spatialReference=t,this.unitInMeters=(0,pa.c9)(this.spatialReference,(0,Ze.Iu)(this.spatialReference).metersPerDegree);const i=e&&"portalItem"in e?e.portalItem:void 0;this._geometryServiceURLPromise=(0,_d.getGeometryServiceURL)(i).catch((()=>{throw new l.Z("mapcoordshelper:missing-geometry-service","Must specify geometryService in esri/config")}))}async toGeographic(e){const t=await this._geometryServiceURLPromise;let i,n=!0;Array.isArray(e[0])&&"number"!=typeof e[0]?i=e:(i=[e],n=!1);const r=i.map((e=>e instanceof ua.Z?e:new ua.Z(e,this.spatialReference))),s=new gd.Z({geometries:r,outSpatialReference:k.Z.WGS84}),a=(await(0,md.i)(t,s)).map((e=>"point"===e.type?[e.x,e.y]:void 0)).filter((e=>!!e));return n?a:a[0]}}!function(e){e[e.ELEVATION=0]="ELEVATION",e[e.MAP=1]="MAP"}(pd||(pd={}));const vd=[pd.ELEVATION,pd.MAP];var yd=i(74923);async function bd(e,t){var i;const{results:n,ground:r}=await(0,yd.ZV)(e,t),s=(!r.layer||!(0,F.nx)(r.layer.type))&&r.mapPoint,a=[],o=function(e){const t=new Map;for(const i of e.allLayerViews){const e=i.layer.uid;t.set(e,i)}return t}(e),l=s?function(e,t){const i=new Set,n=[];for(let s=e.basemapTerrain.numLayers(pd.MAP)-1;s>=0;s--){const t=e.basemapTerrain.layerViewByIndex(s,pd.MAP);i.add(t.layer.uid),n.push(t)}const r=e.basemapTerrain.overlayManager.renderer.layers;for(const{uid:s}of r){const e=t.get(s);e&&(i.add(s),n.push(e))}return n.reverse(),{layerUids:i,layerViews:n}}(e,o):wd;let h=0,c=0;const d=()=>{const e=l.layerViews[c];s&&e&&"fetchPopupFeaturesAtLocation"in e&&a.push({mapPoint:r.mapPoint,layerView:e}),++c};let u=null;for(;h<n.length||c<l.layerViews.length;){var p,_,m;const t=n[h];if(t&&"graphic"!==t.type)++h;else if("scene"!==(null===t||void 0===t||null===(p=t.layer)||void 0===p?void 0:p.type)||(null===t||void 0===t||null===(_=t.layer)||void 0===_?void 0:_.parent)!==(null===e||void 0===e||null===(m=e.map)||void 0===m?void 0:m.basemap))if(t){var g,f,v,y;const e=null===(g=t.layer)||void 0===g?void 0:g.uid,i=l.layerUids.has(e)&&t.distance===r.distance,n=o.get(null===(f=t.layer)||void 0===f?void 0:f.uid);if(null!==(v=u)&&void 0!==v||(u=t.mapPoint),c<l.layerViews.length&&(i||(null!==(y=t.distance)&&void 0!==y?y:0)>r.distance)&&l.layerViews[c]!==n){d();continue}a.push({graphic:t.graphic,layerView:n}),++h}else d();else++h}return null!==(i=u)&&void 0!==i||(u=r.mapPoint),{hits:a,location:u}}const wd={layerUids:new Set,layerViews:[]};let Cd=class extends T.default{constructor(){super(...arguments),this.minTotalNumberOfFeatures=2e3,this.maxTotalNumberOfFeatures=5e4,this.maxNumberOfDrawCalls=17e3,this.maxTotalNumberOfVertices=17e5,this.snapshotAvailable=!0,this.polygonLodFactor=1,this.polylineLodFactor=1,this.skipHighSymbolLods=!1,this.uncompressedTextureDownsamplingEnabled=!1}};(0,n._)([(0,b.Cb)()],Cd.prototype,"minTotalNumberOfFeatures",void 0),(0,n._)([(0,b.Cb)()],Cd.prototype,"maxTotalNumberOfFeatures",void 0),(0,n._)([(0,b.Cb)()],Cd.prototype,"maxNumberOfDrawCalls",void 0),(0,n._)([(0,b.Cb)()],Cd.prototype,"maxTotalNumberOfVertices",void 0),(0,n._)([(0,b.Cb)()],Cd.prototype,"snapshotAvailable",void 0),(0,n._)([(0,b.Cb)()],Cd.prototype,"polygonLodFactor",void 0),(0,n._)([(0,b.Cb)()],Cd.prototype,"polylineLodFactor",void 0),(0,n._)([(0,b.Cb)()],Cd.prototype,"skipHighSymbolLods",void 0),(0,n._)([(0,b.Cb)()],Cd.prototype,"uncompressedTextureDownsamplingEnabled",void 0),Cd=(0,n._)([(0,C.j)("esri.views.3d.support.QualitySettings.Graphics3DSettings")],Cd);let xd=class extends T.default{constructor(){super(...arguments),this.lodFactor=1}};(0,n._)([(0,b.Cb)()],xd.prototype,"lodFactor",void 0),xd=(0,n._)([(0,C.j)("esri.views.3d.support.QualitySettings.LoDFactorSettings")],xd);let Td=class extends T.default{constructor(){super(...arguments),this.object=new xd,this.point=new xd,this.integratedMesh=new xd,this.pointCloud=new xd,this.uncompressedTextureDownsamplingEnabled=!1}};(0,n._)([(0,b.Cb)({type:xd})],Td.prototype,"object",void 0),(0,n._)([(0,b.Cb)({type:xd})],Td.prototype,"point",void 0),(0,n._)([(0,b.Cb)({type:xd})],Td.prototype,"integratedMesh",void 0),(0,n._)([(0,b.Cb)({type:xd})],Td.prototype,"pointCloud",void 0),(0,n._)([(0,b.Cb)()],Td.prototype,"uncompressedTextureDownsamplingEnabled",void 0),Td=(0,n._)([(0,C.j)("esri.views.3d.support.QualitySettings.SceneServiceSettings")],Td);let Sd=class extends T.default{constructor(){super(...arguments),this.lodBias=0,this.angledSplitBias=1,this.vtlContentZoom=1,this.elevationLevelDelta=3,this.reduceTileLevelDifferences=!0}};(0,n._)([(0,b.Cb)()],Sd.prototype,"lodBias",void 0),(0,n._)([(0,b.Cb)()],Sd.prototype,"angledSplitBias",void 0),(0,n._)([(0,b.Cb)()],Sd.prototype,"vtlContentZoom",void 0),(0,n._)([(0,b.Cb)()],Sd.prototype,"elevationLevelDelta",void 0),(0,n._)([(0,b.Cb)()],Sd.prototype,"reduceTileLevelDifferences",void 0),Sd=(0,n._)([(0,C.j)("esri.views.3d.support.QualitySettings.TiledSurfaceSettings")],Sd);let Pd=class extends T.default{constructor(){super(...arguments),this.pixelRatio=1,this.maxTotalNumberOfFeatures=5e4}};(0,n._)([(0,b.Cb)()],Pd.prototype,"pixelRatio",void 0),(0,n._)([(0,b.Cb)()],Pd.prototype,"maxTotalNumberOfFeatures",void 0),Pd=(0,n._)([(0,C.j)("esri.views.3d.support.QualitySettings.HeatmapSettings")],Pd);let Md=class extends T.default{constructor(){super(...arguments),this.graphics3D=new Cd,this.sceneService=new Td,this.tiledSurface=new Sd,this.heatmap=new Pd,this.fadeDuration=(0,Ri.HA)(400),this.antialiasingEnabled=!0,this.physicallyBasedRenderingEnabled=!1,this.highQualityTransparency=!0,this.highResolutionAtmosphere=!1,this.reflections=!1,this.ambientOcclusion=!1,this.memoryLimit=750,this.additionalCacheMemory=0,this.frameRate=void 0,this.maximumPixelRatio=1/0}};(0,n._)([(0,b.Cb)({type:Cd})],Md.prototype,"graphics3D",void 0),(0,n._)([(0,b.Cb)({type:Td})],Md.prototype,"sceneService",void 0),(0,n._)([(0,b.Cb)({type:Sd})],Md.prototype,"tiledSurface",void 0),(0,n._)([(0,b.Cb)({type:Pd})],Md.prototype,"heatmap",void 0),(0,n._)([(0,b.Cb)()],Md.prototype,"fadeDuration",void 0),(0,n._)([(0,b.Cb)()],Md.prototype,"antialiasingEnabled",void 0),(0,n._)([(0,b.Cb)()],Md.prototype,"physicallyBasedRenderingEnabled",void 0),(0,n._)([(0,b.Cb)()],Md.prototype,"highQualityTransparency",void 0),(0,n._)([(0,b.Cb)()],Md.prototype,"highResolutionAtmosphere",void 0),(0,n._)([(0,b.Cb)()],Md.prototype,"reflections",void 0),(0,n._)([(0,b.Cb)()],Md.prototype,"ambientOcclusion",void 0),(0,n._)([(0,b.Cb)()],Md.prototype,"memoryLimit",void 0),(0,n._)([(0,b.Cb)()],Md.prototype,"additionalCacheMemory",void 0),(0,n._)([(0,b.Cb)()],Md.prototype,"frameRate",void 0),(0,n._)([(0,b.Cb)()],Md.prototype,"maximumPixelRatio",void 0),Md=(0,n._)([(0,C.j)("esri.views.3d.support.QualitySettings")],Md);const Rd=Md;var Ad=i(91643),Od=i(76432),Ed=i(45888),Dd=i(31195),Id=i(76200),Ld=i(63780);class Nd{constructor(e){this.client=e,this._cancelled=!1,this.size=0,this.duration=0}}class Ud{constructor(e){this.typeWorkerQuota=e,this.tasks=new Array,this.numWorkers=0,this.statistics=new Hd}}class Hd{constructor(){this.requests=0,this.size=0,this.duration=0,this.speed=0}}class Fd{constructor(e,t,i,n){this._workerFunc=e,this._callbackFunc=t,this._maxTotalNumWorkers=i,this._totalNumWorkers=0,this._clients=n.map((e=>new Ud(e)))}destroy(){this._clients.length=0}hasQuota(e){const t=this._clients[e];return!!t&&(this._totalNumWorkers<this._maxTotalNumWorkers||t.numWorkers+t.tasks.length<t.typeWorkerQuota)}push(e){const t=this._clients[e.client];t&&(this._totalNumWorkers<this._maxTotalNumWorkers?(t.numWorkers++,this._totalNumWorkers++,this._workerFunc(e,((e,t)=>this._taskCallback(e,t)))):t.tasks.push(e))}cancel(e){this._taskFinished(e),e._cancelled=!0}_taskFinished(e){const t=this._clients[e.client];this._totalNumWorkers--,t&&(t.numWorkers--,t.statistics.requests++,t.statistics.size+=e.size||0,t.statistics.duration+=e.duration||0,t.statistics.speed=t.statistics.duration>0?t.statistics.size/t.statistics.duration:0,(0,vi.hu)(t.numWorkers>=0)),this._next()}_next(){for(const e of this._clients)if(e&&e.numWorkers<e.typeWorkerQuota&&this._processQueue(e))return;for(const e of this._clients)if(e&&this._processQueue(e))return}_processQueue(e){for(;e.tasks.length>0;)if(this._workerFunc(e.tasks.shift(),((e,t)=>this._taskCallback(e,t))))return e.numWorkers++,this._totalNumWorkers++,!0;return!1}_taskCallback(e,t){e._cancelled||(this._callbackFunc(e,t),this._taskFinished(e))}getStatsForType(e){const t=this._clients[e];return t?{quota:t.typeWorkerQuota,workers:t.numWorkers,queueSize:t.tasks.length,requestStats:t.statistics}:null}get test(){}}class Vd{constructor(e,t){this.element=e,this.type="image+type",this.isOpaque="image/jpeg"===t}}var qd=i(55468);let zd=class extends T.default{constructor(){super(...arguments),this._tasks=new Map,this._onLoadQueue=new Array,this._doneQueue=new Array,this.updating=!1}setup(e,t,i){this._loadQueue=new Fd(((e,t)=>this._startLoading(e,t)),((e,t)=>this._doneLoadingCB(e,t)),e,t),i&&(this._frameTask=i.registerTask(Bt.T8.STREAM_DATA_LOADER,this))}destroy(){this._frameTask=(0,p.hw)(this._frameTask),this._tasks.forEach((e=>(0,p.IM)(e.abortController))),this._loadQueue=(0,p.SC)(this._loadQueue),this._onLoadQueue=null,this._doneQueue=null,this._tasks=null}hasDownloadSlots(e){return this._loadQueue.hasQuota(e)}request(e,t,i){let n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:{};const r=(0,m.hh)();r.__signal=null!=n?n.signal:null;const s=this._createOrUpdateTask(e,t,i,n,r);return(0,m.fu)(n,(()=>this._cancelRequest(s,r))),r.promise}_createTask(e,t,i,n,r,s){const a=new Gd(e,t,i,n,r);return this._updateTask(a,s),this._tasks.set(r,a),1===this._tasks.size&&this._set("updating",!0),this._loadQueue.push(a),a}_cancelRequest(e,t){var i;(0,Ld.e$)(e.resolvers,t),t.reject((0,m.zE)()),0===e.resolvers.length&&(e.status===kd.DOWNLOADING&&(e.status=kd.CANCELLED,this._loadQueue.cancel(e),null!==(i=e.abortController)&&void 0!==i&&i.abort(),e.request=null,e.abortController=null),e.status=kd.CANCELLED,this._tasks.delete(e.key),0===this._tasks.size&&this._set("updating",!1))}_updateTask(e,t){e.resolvers.push(t)}_createOrUpdateTask(e,t,i,n,r){const s=function(e,t,i){return"".concat(e,":").concat(t,":").concat(i)}((null===n||void 0===n?void 0:n.uid)||e,t,i),a=this._tasks.get(s);return a?(this._updateTask(a,r),a):this._createTask(e,n,t,i,s,r)}_doneLoadingCB(e,t){this._loadQueue&&((0,vi.hu)(e.status===kd.DOWNLOADING),e.status=kd.DOWNLOADED,this._frameTask?this._doneQueue.push({task:e,err:t}):this._doneLoading(e,t))}get running(){return this._doneQueue.length>0||this._onLoadQueue.length>0}runTask(e){for(;!e.done&&this._onLoadQueue.length>0;){const t=this._onLoadQueue.shift();(0,m.k_)(t.task.abortController),t.task.abortController=null,t.callback(t.task),e.madeProgress()}for(;!e.done&&this._doneQueue.length>0;){const t=this._doneQueue.shift();t.task.status!==kd.DOWNLOADED&&(t.err=t.err||(0,m.zE)()),this._doneLoading(t.task,t.err),e.madeProgress()}}_doneLoading(e,t){if(t&&!(0,m.D_)(t)&&e.numRetries>0)return--e.numRetries,void this._loadQueue.push(e);let i=(0,qd.Cm)(e.result)||e.result instanceof HTMLImageElement?0:e.resolvers.length;for(const n of e.resolvers)if(t)(0,m.D_)(t)?n.reject(t):n.reject(new l.Z("stream-data-loader:request-error","Failed to request resource at '".concat(e.url,"'. ").concat(t),{url:e.url,error:t}));else{--i;const t=i>0?(0,Ae.d9)(e.result):e.result;n.resolve(t)}this._tasks.delete(e.key),0===this._tasks.size&&this._set("updating",!1)}_startLoading(e,t){if(e.status===kd.CANCELLED)return!1;let i,n;switch(e.startTime=performance.now(),e.status=kd.DOWNLOADING,e.docType){case"binary":n="array-buffer",i=0;break;case"image":n="image";break;case"image+type":n="array-buffer";break;default:n="json"}e.abortController=new AbortController;const r=e.abortController.signal;e.request=(0,Id.Z)(e.url,{...e.options,responseType:n,timeout:i,signal:r});const s=i=>{e.duration=performance.now()-e.startTime,e.size=i instanceof ArrayBuffer?i.byteLength:e.size||0,e.result=i,this._frameTask?this._onLoadQueue.push({callback:t,task:e}):(e.abortController=null,t(e))},a=i=>{e.status===kd.DOWNLOADING&&t(e,i)};return"image+type"!==e.docType?(e.request.then((e=>s(e.data)),a),!0):(e.request.then((t=>{const o=t.data,l=function(e){if(e.byteLength<2)return"unknown";const t=new Uint8Array(e,0,e.byteLength);return 137===t[0]&&80===t[1]?"image/png":71===t[0]&&73===t[1]?"image/gif":66===t[0]&&77===t[1]?"image/bmp":255===t[0]&&216===t[1]?"image/jpeg":"unknown"}(o);if(n="image",e.size=o.byteLength,"unknown"===l)return e.request=(0,Id.Z)(e.url,{responseType:n,timeout:i,signal:r}),void e.request.then((e=>s(e.data)),a);const h=new Blob([o],{type:l}),c=window.URL.createObjectURL(h);e.request=(0,Id.Z)(c,{responseType:n,timeout:i,signal:r}),e.request.then((e=>s(new Vd(e.data,l))),a).finally((()=>window.URL.revokeObjectURL(c)))}),a),!0)}get test(){}};(0,n._)([(0,b.Cb)({readOnly:!0})],zd.prototype,"updating",void 0),zd=(0,n._)([(0,C.j)("esri.views.3d.support.StreamDataLoader")],zd);const Bd=0;class Gd extends Nd{constructor(e,t,i,n,r){super(n),this.url=e,this.options=t,this.docType=i,this.key=r,this.result=null,this.status=kd.QUEUED,this.request=null,this.abortController=null,this.resolvers=new Array,this.startTime=0,this.numRetries=Bd}}var kd;!function(e){e[e.QUEUED=1]="QUEUED",e[e.DOWNLOADING=2]="DOWNLOADING",e[e.DOWNLOADED=3]="DOWNLOADED",e[e.CANCELLED=4]="CANCELLED"}(kd||(kd={}));let Zd=class extends T.default{constructor(){super(...arguments),this.updating=!1}};(0,n._)([(0,b.Cb)({readOnly:!0})],Zd.prototype,"updating",void 0),Zd=(0,n._)([(0,C.j)("esri.views.3d.support.ResourceController.ResourceControllerMain")],Zd);let jd=class extends Zd{constructor(){super(...arguments),this._immediateTask=Bt.sq,this._normalTask=Bt.sq,this._updatingObjects=(0,Od.t)([]),this._frameTask=null}get immediate(){return this._immediateTask}get normal(){return this._normalTask}initialize(){this._scheduler=(0,Bt.z4)(),this._memoryController=(0,Dd.c)(this.view),this._streamDataLoader=new zd,this._streamDataLoader.setup(Ed.NT,Ed.Ty,this._scheduler),this.addHandles([(0,g.watch)((()=>{var e;return null===(e=this.view.state)||void 0===e?void 0:e.mode}),(e=>{null!=e&&(this._scheduler.state=e)}),g.sync),(0,g.watch)((()=>this.view.stationary),(()=>this._stationaryChangedHandler()))]),this._frameTask=(0,f.A)({update:e=>this._frame(e)}),this._immediateTask=this._scheduler.registerTask(Bt.T8.RESOURCE_CONTROLLER_IMMEDIATE),this._normalTask=this._scheduler.registerTask(Bt.T8.RESOURCE_CONTROLLER)}destroy(){this._immediateTask.remove(),this._normalTask.remove(),this._frameTask=(0,p.hw)(this._frameTask),this._streamDataLoader=(0,p.SC)(this._streamDataLoader),this._memoryController=(0,p.SC)(this._memoryController),this._scheduler=(0,p.SC)(this._scheduler),this.view=null}get updating(){var e,t,i,n;return!!(null!==(e=this._memoryController)&&void 0!==e&&e.updating||null!==(t=this._streamDataLoader)&&void 0!==t&&t.updating||null!==(i=this._immediateTask)&&void 0!==i&&i.updating)||(null===(n=this._updatingObjects)||void 0===n?void 0:n.value.some((e=>e.updating)))}get scheduler(){return this._scheduler}get memoryController(){return this._memoryController}createStreamDataRequester(e){const t=this._streamDataLoader;return{request:(i,n,r)=>t.request(i,n,e,r),get busy(){return!t.hasDownloadSlots(e)}}}addUpdatingObject(e){const t=this._updatingObjects;return t.value=[...t.value,e],(0,c.kB)((()=>{t.value=t.value.filter((t=>t!==e))}))}_frame(e){this.view.suspended||this.view.stateManager&&(this.view.stateManager.step((0,Ri.D9)(e.deltaTime)),!this._scheduler)||(this._memoryController.update(),this._scheduler.updateBudget(e)&&this._scheduler.frame())}_stationaryChangedHandler(){this.memoryController.resetStableQuality()}get test(){}};(0,n._)([(0,b.Cb)()],jd.prototype,"view",void 0),(0,n._)([(0,b.Cb)()],jd.prototype,"_scheduler",void 0),(0,n._)([(0,b.Cb)()],jd.prototype,"_memoryController",void 0),(0,n._)([(0,b.Cb)()],jd.prototype,"_streamDataLoader",void 0),(0,n._)([(0,b.Cb)()],jd.prototype,"_immediateTask",void 0),(0,n._)([(0,b.Cb)()],jd.prototype,"_normalTask",void 0),(0,n._)([(0,b.Cb)()],jd.prototype,"_updatingObjects",void 0),(0,n._)([(0,b.Cb)({readOnly:!0})],jd.prototype,"updating",null),jd=(0,n._)([(0,C.j)("esri.views.3d.support.ResourceController")],jd);var Wd=i(70116),Xd=i(20488);class Qd{constructor(e){this.layer=null,this.memory=0,this.displayedNumberOfFeatures=0,this.maximumNumberOfFeatures=null,this.totalNumberOfFeatures=null,this.layer=e.layer;const t=e.performanceInfo;this.memory=t.usedMemory,this.displayedNumberOfFeatures=t.displayedFeatures,this.maximumNumberOfFeatures=t.maximumFeatures,this.totalNumberOfFeatures=t.totalFeatures}}class Yd{constructor(e){var t,i,n,r,s,a,o;if(this.totalMemory=0,this.usedMemory=0,this.quality=1,this.load=0,this.terrainMemory=0,this.edgesMemory=0,this.layerPerformanceInfos=new Array,this.cachedMemory=0,this.fboMemory=0,null!=e.resourceController){var l;const t=e.resourceController.memoryController;this.totalMemory=(null!==(l=t.maxMemory)&&void 0!==l?l:0)*Wd.Y.MEGABYTES,this.usedMemory=Math.round(t.usedMemory*this.totalMemory),this.quality=e.quality,this.load=e.resourceController.scheduler.load,this.cachedMemory=t.usedCacheMemory}this.terrainMemory=null!==(t=null===(i=e.basemapTerrain)||void 0===i?void 0:i.usedMemory)&&void 0!==t?t:0,this.edgesMemory=null!==(n=null===(r=e._stage)||void 0===r?void 0:r.renderer.usedMemory.edges)&&void 0!==n?n:0,this.fboMemory=null!==(s=null===(a=e._stage)||void 0===a?void 0:a.renderer.usedMemory.fbos)&&void 0!==s?s:0,null!==(o=e.allLayerViews)&&void 0!==o&&o.items.forEach((e=>{(0,Xd.l)(e)&&this.layerPerformanceInfos.push(new Qd(e))})),this.layerPerformanceInfos.sort(((e,t)=>t.memory-e.memory))}}var Jd=i(27053),Kd=i(57516),$d=i(13041);class eu{constructor(e){this._gltfLoading=new Map,this._wosrLoading=new Map,this._gltfMemCache=e("gltf-resources",(()=>{})),this._wosrMemCache=e("wosr-resources",(()=>{}))}destroy(){this._gltfLoading.forEach((e=>e.abortController.abort())),this._wosrLoading.forEach((e=>e.abortController.abort())),this._gltfMemCache.destroy(),this._wosrMemCache.destroy()}loadGLTF(e,t,i){const n=i?"gltfPBR:".concat(e):"gltf:".concat(e),r=this._gltfMemCache.get(n);return null!=r?Promise.resolve(r):tu(this._gltfLoading,this._gltfMemCache,n,(t=>(0,Kd.Q)(new Jd.C(t.streamDataRequester),e,t,i)),t)}loadWOSR(e,t){const i="wosr:".concat(e,":").concat(t.disableTextures),n=this._wosrMemCache.get(i);return null!=n?Promise.resolve(n):tu(this._wosrLoading,this._wosrMemCache,i,(t=>(0,$d.zD)(e,t)),t)}}async function tu(e,t,i,n,r){(0,m.k_)(r);const s=(0,m.fu)(r,(()=>function(e,t){const i=e.get(t);if(null!=i&&--i.refCount>0)return;e.delete(t),null!=i&&i.abortController.abort()}(e,i)));let a=e.get(i);if(a)a.refCount++;else{const t=new AbortController;a={refCount:1,abortController:t,promise:n({...r,signal:t.signal})},e.set(i,a)}try{const n=await a.promise;return t.put(i,n,n.size),e.delete(i),(0,m.k_)(r),n}finally{(0,p.hw)(s)}}var iu=i(35995);let nu=class extends T.default{constructor(e,t){var i;super({}),this._stage=e,this._textureRequests=new Map,this._frameTask=null!==(i=null===t||void 0===t?void 0:t.registerTask(Bt.T8.TEXTURE_UNLOAD))&&void 0!==i?i:Bt.sq}normalizeCtorArgs(){return{}}destroy(){var e,t,i;super.destroy(),null!==(e=this._frameTask)&&void 0!==e&&e.remove(),null!==(t=this._textureRequests)&&void 0!==t&&t.forEach((e=>this._releaseTextureRequest(e))),null===(i=this._textureRequests)||void 0===i||i.clear()}get updating(){return this._frameTask.updating}fromData(e,t){const i=this.makeUid(e);let n=this._textureRequests.get(i);if(!n){const e=new su;e.texture=t(),this._stage&&(e.texture.load(this._stage.renderView.renderingContext),this._stage.add(e.texture)),this._textureRequests.set(i,e),n=e}return n.referenceCount++,new ru(i,n.texture,(()=>this._release(i)))}_release(e){const t=this._textureRequests.get(e);t?(t.referenceCount<1&&console.warn("TextureCollection: reference count is < 1 for "+e),t.referenceCount--,t.referenceCount<1&&this._frameTask.schedule((()=>this._releaseNow(e)))):console.warn("TextureCollection: texture doesn't exist: '".concat(e,"'"))}get test(){}_releaseNow(e){var t;if(!this._textureRequests)return;const i=this._textureRequests.get(e);!i||i.referenceCount>0||(null!==(t=i.texture)&&void 0!==t&&t.unload(),this._releaseTextureRequest(i),this._textureRequests.delete(e))}_releaseTextureRequest(e){var t;e.texture?null===(t=this._stage)||void 0===t||t.remove(e.texture):e.abortController&&(e.abortController.abort(),e.abortController=null)}makeUid(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;return null!=t?"".concat(e,".").concat(t,"px"):e}};(0,n._)([(0,b.Cb)()],nu.prototype,"_frameTask",void 0),(0,n._)([(0,b.Cb)()],nu.prototype,"updating",null),nu=(0,n._)([(0,C.j)("esri.views.3d.support.TextureCollection")],nu);class ru{constructor(e,t,i){this.uid=e,this.texture=t,this.release=i}}class su{constructor(){this.referenceCount=0}}var au=i(1487);class ou extends nu{constructor(e,t,i){super(t,i),this._streamDataRequester=e}async fromUrl(e,t,i){(0,m.k_)(i);const n=null===i||void 0===i?void 0:i.signal,r=this.makeUid(e,t);let s=this._textureRequests.get(r);if(!s){const i=new AbortController,n=this._streamDataRequester.request(e,"image",{uid:r,signal:i.signal});s=new su,s.abortController=i;const a=s;this._textureRequests.set(r,s),s.textureAsync=n.then((async i=>{const n=this._createTexture(e,i,t);return a.texture=n,a.abortController=null,await n.load(this._stage.renderView.renderingContext),this._stage.add(n),new ru(r,n,(()=>this._release(r)))}),(e=>{throw a.abortController=null,e}))}s.referenceCount++;try{return await(0,m.Hl)(s.textureAsync,n)}catch(a){throw this._release(r),a}}_createTexture(e,t,i){const n={width:t.width,height:t.height,wrap:{s:st.e8.CLAMP_TO_EDGE,t:st.e8.CLAMP_TO_EDGE},preMultiplyAlpha:!0,reloadable:!0};if((0,iu.zd)(e)){var r;if(i||0===t.width&&0===t.height){const e=t.width?t.height/t.width:1;i=i||64,e>1?(t.width=Math.round(i/e),t.height=i):(t.width=i,t.height=Math.round(i*e))}(null===(r=this._stage.renderView)||void 0===r?void 0:r.renderingContext.driverTest.svgPremultipliesAlpha.result)&&(n.preMultiplyAlpha=!1)}return new au.x(t,n)}}class lu{constructor(e){this.streamDataRequester=null,this._graphicsOwners=[],this._screenSizePerspectiveHandles=null,this.cimSymbolRasterizer=null,this._viewState=e.viewState,this._view=e.view,this._pointsOfInterest=e.pointsOfInterest,this.streamDataRequester=e.resourceController.createStreamDataRequester(Ed.Bh.SYMBOLOGY),this.objectResourceCache=new eu(((t,i)=>e.resourceController.memoryController.newCache(t,i))),this.textures=new ou(this.streamDataRequester,e.view._stage,e.resourceController.scheduler);const t=(0,Ze.Iu)(this._view.spatialReference).radius;this.screenSizePerspectiveSettings=(0,Ml.Gw)(e.viewingMode,t),this.screenSizePerspectiveSettingsLabels=(0,Ml.n9)(e.viewingMode,t)}destroy(){this.textures.destroy(),this.streamDataRequester=null}addGraphicsOwner(e){if(!e)return(0,c.kB)();this._graphicsOwners.push(e);const t=(0,g.watch)((()=>{var t;return null===(t=e.layer)||void 0===t?void 0:t.screenSizePerspectiveEnabled}),(()=>this._updateScreenSizePerspectiveEnabled()));return this._updateScreenSizePerspectiveEnabled(),(0,c.kB)((()=>{t.remove(),(0,Ld.e$)(this._graphicsOwners,e),this._updateScreenSizePerspectiveEnabled()}))}_updateScreenSizePerspectiveEnabled(){const e=this._graphicsOwners.some((e=>{var t;return!0===(null===(t=e.layer)||void 0===t?void 0:t.screenSizePerspectiveEnabled)}));if(e&&!this._screenSizePerspectiveHandles){this._screenSizePerspectiveHandles=new We.Z;const e=()=>this._updateScreenSizePerspectiveSettings();this._screenSizePerspectiveHandles.add([(0,g.watch)((()=>this._pointsOfInterest.centerOnSurfaceInfrequent.distance),e,g.sync),this._viewState.events.on("camera-projection-changed",e)]),this._updateScreenSizePerspectiveSettings()}else e||(this._screenSizePerspectiveHandles=(0,p.SC)(this._screenSizePerspectiveHandles))}_updateScreenSizePerspectiveSettings(){const e=this._pointsOfInterest;hu.distance=e.centerOnSurfaceInfrequent.distance,hu.fovY=this._viewState.camera.fovY,this.screenSizePerspectiveSettings.update(hu),this.screenSizePerspectiveSettingsLabels.update(hu),this._view._stage.renderView.requestRender()}get test(){}}const hu={distance:0,fovY:0};var cu=i(52639),du=(i(51508),i(62554)),uu=i(36365),pu=i(87037);class _u{constructor(e,t){let i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"";this.graphics=e,this._symbol=new du.Z({symbolLayers:new a.Z([new uu.Z({material:{color:t},outline:{color:[255,255,255],size:1},resource:{primitive:"circle"}}),new pu.Z({text:i,halo:{color:"white",size:1/.75},material:{color:t},size:12})])})}show(e,t){if(null==t)return;this.hide();const i=new ua.Z({x:e[0],y:e[1],z:e[2],spatialReference:t});this._graphic=new cu.Z({geometry:i,symbol:this._symbol}),this.graphics.add(this._graphic)}hide(){null!=this._graphic&&(this.graphics.remove(this._graphic),this._graphic=null)}}let mu=class extends T.default{constructor(e){super(e)}};(0,n._)([(0,b.Cb)({constructOnly:!0})],mu.prototype,"renderCoordsHelper",void 0),(0,n._)([(0,b.Cb)({constructOnly:!0})],mu.prototype,"surface",void 0),(0,n._)([(0,b.Cb)({constructOnly:!0})],mu.prototype,"state",void 0),mu=(0,n._)([(0,C.j)("esri.views.3d.support.pointsOfInterest.PointOfInterest")],mu);const gu=Array;let fu=class extends mu{constructor(e){super(e),this._dirty=!1,this._propertiesPool=new Oa.L({location:ua.Z,renderLocation:gu},this),this._estimatedSurfaceAltitude=0,this._pendingElevationQueryController=null,this.renderLocation=(0,R.Ue)(),this._tmpPoint=new ua.Z}initialize(){if(this.scheduler&&this.addHandles(this.scheduler.registerTask(this.task,this)),this.runTask(),this.map){const e=()=>this._setDirty();this.addHandles((0,g.on)((()=>{var e;return null===(e=this.map)||void 0===e||null===(e=e.ground)||void 0===e?void 0:e.layers}),"change",e,{onListenerAdd:e,onListenerRemove:e}))}this._updateRenderLocation()}destroy(){this._cancelPendingRequest(),this._propertiesPool=(0,p.SC)(this._propertiesPool)}get _camera(){return this.state.contentCamera}get location(){const e=this._propertiesPool.get("location");return e.spatialReference=this.state.spatialReference,this.renderCoordsHelper.fromRenderCoords(this.renderLocation,e),e}get scale(){const e=this._camera,t=(0,Ge.p)(e.eye,this.renderLocation),i={renderCoordsHelper:this.renderCoordsHelper,state:{camera:e}};return(0,B.Xt)(i,t,0)}get updating(){return this._dirty||null!=this._pendingElevationQueryController}updateRenderLocation(){this._setDirty(),this._updateRenderLocation()}_setDirty(){this._dirty||(this._dirty=!0,this.notifyChange("updating"))}_cancelPendingRequest(){const e=this._pendingElevationQueryController;e&&(this._pendingElevationQueryController=null,e.abort(),this.notifyChange("updating"))}get running(){return!this._pendingElevationQueryController&&this._dirty}runTask(){var e,t;if(this._cancelPendingRequest(),this._dirty=!1,this.notifyChange("updating"),null===(e=this.map)||void 0===e||!e.ground)return this._updateSurfaceAltitude(0),Gt.J;const i=this.state.spatialReference;this._tmpPoint.spatialReference=i,this.renderCoordsHelper.fromRenderCoords(this._camera.eye,this._tmpPoint);const n=(null!==(t=this._tmpPoint.z)&&void 0!==t?t:0)>yu&&this.renderCoordsHelper.viewingMode===te.JY.Global&&(i.isWGS84||i.isWebMercator);let r=new AbortController;return this.map.ground.queryElevation(this._tmpPoint,{signal:r.signal,cache:this.cache,minDemResolution:n?bu:0}).then((e=>{var t;return this._updateSurfaceAltitude(null!==(t=e.geometry.z)&&void 0!==t?t:0)})).catch((e=>{(0,m.D_)(e)||this._updateSurfaceAltitude(0)})).catch((()=>{})).then((()=>{this._pendingElevationQueryController===r&&(this._pendingElevationQueryController=null,this.notifyChange("updating")),r=null})),this._pendingElevationQueryController=r,Gt.J}_updateSurfaceAltitude(e){this._estimatedSurfaceAltitude!==e&&(this._estimatedSurfaceAltitude=e,this._updateRenderLocation())}_updateRenderLocation(){this.renderCoordsHelper.setAltitude(vu,this._estimatedSurfaceAltitude,this._camera.eye),(0,Ge.e)(this._get("renderLocation"),vu)||(this._set("renderLocation",(0,Ge.c)(this._propertiesPool.get("renderLocation"),vu)),this.notifyChange("renderLocation"))}};(0,n._)([(0,b.Cb)({constructOnly:!0})],fu.prototype,"scheduler",void 0),(0,n._)([(0,b.Cb)({constructOnly:!0})],fu.prototype,"cache",void 0),(0,n._)([(0,b.Cb)({constructOnly:!0})],fu.prototype,"task",void 0),(0,n._)([(0,b.Cb)()],fu.prototype,"location",null),(0,n._)([(0,b.Cb)({constructOnly:!0})],fu.prototype,"map",void 0),(0,n._)([(0,b.Cb)()],fu.prototype,"renderLocation",void 0),(0,n._)([(0,b.Cb)()],fu.prototype,"scale",null),(0,n._)([(0,b.Cb)()],fu.prototype,"updating",null),fu=(0,n._)([(0,C.j)("esri.views.3d.support.pointsOfInterest.CameraOnSurface")],fu);const vu=(0,R.Ue)(),yu=1e5,bu=1e6,wu=Array;let Cu=class extends mu{constructor(e){super(e),this._propertiesPool=new Oa.L({location:ua.Z,renderLocation:wu},this),this._currentSurfaceAltitude=0,this._latestSurfaceAltitude=0,this.distance=0,this.renderLocation=(0,R.Ue)(),this.updating=!1}initialize(){this._frameWorker=this.scheduler.registerTask(this.task,this),this.runTask()}destroy(){this._frameWorker=(0,p.hw)(this._frameWorker),this._propertiesPool=(0,p.SC)(this._propertiesPool)}get _camera(){return this.state.contentCamera}get location(){const e=this._propertiesPool.get("location");return e.spatialReference=this.state.spatialReference,this.renderCoordsHelper.fromRenderCoords(this.renderLocation,e),e}updateRenderLocation(){this.updating=!0,this._updateRenderLocation()}get estimatedSurfaceAltitude(){return this._latestSurfaceAltitude}get running(){return this.updating}runTask(){return this._latestSurfaceAltitude=this.estimateSurfaceAltitudeAtCenter(),this._updateRenderLocation(),this.updating=!1,Gt.J}_updateRenderLocation(){const e=Tu;let t=this._calculateSurfaceIntersection(this._currentSurfaceAltitude,e);const i=this._currentSurfaceAltitude!==this._latestSurfaceAltitude;!t&&i&&(t=this._calculateSurfaceIntersection(this._latestSurfaceAltitude,e),t&&(this._currentSurfaceAltitude=this._latestSurfaceAltitude));const n=Su;t&&this._latestSurfaceAltitudeChangesDistanceSignificantly(e,n)&&((0,Ge.c)(e,n),this._currentSurfaceAltitude=this._latestSurfaceAltitude),t?this.distance=(0,Ge.p)(this._camera.eye,e):((0,Ge.j)(e,this._camera.viewForward,this._get("distance")),(0,Ge.g)(e,e,this._camera.eye)),(0,Ge.e)(this._get("renderLocation"),e)||this._set("renderLocation",(0,Ge.c)(this._propertiesPool.get("renderLocation"),e))}_calculateSurfaceIntersection(e,t){const i=this._camera;if(!this.renderCoordsHelper.intersectInfiniteManifold(i.ray,e,t))return!1;if(this.state.isGlobal){const n=(0,Ze.Iu)(this.renderCoordsHelper.spatialReference).radius,r=n+e,s=(0,Ge.q)(i.eye),a=s<r*r,o=(0,Ge.p)(i.eye,t);if(a&&o>n/4){const e=r-Math.sqrt(s);return(0,Ge.j)(t,i.viewForward,e),(0,Ge.g)(t,t,i.eye),!0}}else{var n,r;const e=null!==(n=this.surface)&&void 0!==n&&n.ready?this.surface.extent:null;null!=e&&(0,D.d)(e,null===(r=this.surface)||void 0===r?void 0:r.spatialReference,Pu,this.renderCoordsHelper.spatialReference)&&(t[0]=(0,me.uZ)(t[0],Pu[0],Pu[2]),t[1]=(0,me.uZ)(t[1],Pu[1],Pu[3]))}return!0}_latestSurfaceAltitudeChangesDistanceSignificantly(e,t){if(this._latestSurfaceAltitude===this._currentSurfaceAltitude||null==e)return!1;if(this._calculateSurfaceIntersection(this._latestSurfaceAltitude,t)){if(_l.h.TESTS_DISABLE_OPTIMIZATIONS)return!0;const i=this._camera.eye,n=(0,Ge.p)(i,e),r=(0,Ge.p)(i,t);if(Math.abs(r-n)/n>xu)return!0}return!1}};(0,n._)([(0,b.Cb)({constructOnly:!0})],Cu.prototype,"scheduler",void 0),(0,n._)([(0,b.Cb)({constructOnly:!0})],Cu.prototype,"task",void 0),(0,n._)([(0,b.Cb)()],Cu.prototype,"distance",void 0),(0,n._)([(0,b.Cb)({constructOnly:!0})],Cu.prototype,"estimateSurfaceAltitudeAtCenter",void 0),(0,n._)([(0,b.Cb)({readOnly:!0})],Cu.prototype,"location",null),(0,n._)([(0,b.Cb)({readOnly:!0})],Cu.prototype,"renderLocation",void 0),(0,n._)([(0,b.Cb)()],Cu.prototype,"updating",void 0),Cu=(0,n._)([(0,C.j)("esri.views.3d.support.pointsOfInterest.CenterOnSurface")],Cu);const xu=.05,Tu=(0,R.Ue)(),Su=(0,R.Ue)(),Pu=(0,L.Ue)();class Mu{constructor(e){this._handles=new We.Z,this.events=new G.Z,this._contentLayerViews=e.contentLayerViews,this._handles.add(this._contentLayerViews.on("change",(e=>this._layerViewsChanged(e)))),this._layerViewsChanged({added:this._contentLayerViews.toArray(),removed:[],moved:[],target:this._contentLayerViews})}destroy(){this._handles=(0,p.SC)(this._handles),this._contentLayerViews.destroy()}_layerViewsChanged(e){e.added.forEach((e=>{"esri.views.3d.layers.SceneLayerView3D"===e.declaredClass&&this._handles.add(e.on("visible-geometry-changed",(()=>this._contentChanged())),e.uid)})),e.removed.forEach((e=>this._handles.remove(e.uid)))}_contentChanged(){this.events.emit("request-update",Ru)}}const Ru={},Au=Array;let Ou=class extends mu{constructor(e){super(e),this._propertiesPool=new Oa.L({location:ua.Z,renderLocation:Au},this),this._dirty=!0,this.renderLocation=this._propertiesPool.get("renderLocation")}initialize(){this.addHandles([(0,g.watch)((()=>this.centerOnSurface.renderLocation),(()=>this.updateRenderLocation())),(0,g.watch)((()=>this.state.contentCamera),(()=>this.updateRenderLocation()))]),this.scheduler&&this.addHandles(this.scheduler.registerTask(Bt.T8.POINT_OF_INTEREST_FREQUENT,this))}destroy(){this._propertiesPool=(0,p.SC)(this._propertiesPool)}get updating(){return this._dirty||this.centerOnSurface.updating}get location(){const e=this._propertiesPool.get("location");return e.spatialReference=this.state.spatialReference,this.renderCoordsHelper.fromRenderCoords(this.renderLocation,e),e}get worldUnitsPerContentPixel(){const{camera:e,contentPixelRatio:t}=this.state;return e.computeRenderPixelSizeAt(this.renderLocation)*(e.pixelRatio/t)}get running(){return this._dirty}runTask(){const e=this._get("renderLocation"),t=this.centerOnSurface.renderLocation,i=this.renderCoordsHelper,n=this.state.contentCamera;this._dirty=!1,i.worldUpAtPosition(t,Eu);const r=Math.max(0,(Math.acos((0,Ge.m)(Eu,n.viewForward))-.5*Math.PI)*(n.aboveGround?1:-1));if(Number.isNaN(r)){if(!e||!(0,Ge.G)(e,t)){const e=this._propertiesPool.get("renderLocation");(0,Ge.c)(e,t),this._set("renderLocation",e)}return Gt.J}const s=1-(0,me.uZ)(r/(.5*Math.PI),0,1),a=s*s*s;this._calculateScreenHorizontalEdgeOnSurface(Iu);const o=this._propertiesPool.get("renderLocation");return(0,Ge.o)(o,t,Iu,a),e&&(0,Ge.G)(e,o)||this._set("renderLocation",o),Gt.J}_calculateScreenHorizontalEdgeOnSurface(e){const t=this.state.contentCamera,i=t.getRenderCenter((0,v.J$)());if(i[1]=t.aboveGround?t.padding[Ea.Np.BOTTOM]:t.fullHeight-t.padding[Ea.Np.TOP],this.estimateSurfaceIntersectionAtRenderPoint(i,e))return e;const n=this.renderCoordsHelper.getAltitude(this.centerOnSurface.renderLocation);if(t.unprojectFromRenderScreen(i,Du)){(0,Ge.f)(Du,Du,t.eye);const i=(0,Ge.n)(Du,Du);if(this.renderCoordsHelper.intersectInfiniteManifold((0,wn.re)(t.eye,i),n,e))return e}return this.renderCoordsHelper.setAltitude(e,n,t.eye)}updateRenderLocation(){this._dirty=!0}};(0,n._)([(0,b.Cb)()],Ou.prototype,"_dirty",void 0),(0,n._)([(0,b.Cb)({constructOnly:!0})],Ou.prototype,"scheduler",void 0),(0,n._)([(0,b.Cb)({constructOnly:!0})],Ou.prototype,"centerOnSurface",void 0),(0,n._)([(0,b.Cb)({constructOnly:!0})],Ou.prototype,"estimateSurfaceIntersectionAtRenderPoint",void 0),(0,n._)([(0,b.Cb)()],Ou.prototype,"updating",null),(0,n._)([(0,b.Cb)()],Ou.prototype,"location",null),(0,n._)([(0,b.Cb)()],Ou.prototype,"renderLocation",void 0),(0,n._)([(0,b.Cb)()],Ou.prototype,"worldUnitsPerContentPixel",null),Ou=(0,n._)([(0,C.j)("esri.views.3d.support.pointsOfInterest.Focus")],Ou);const Eu=(0,R.Ue)(),Du=(0,R.Ue)(),Iu=(0,R.Ue)();let Lu=class extends T.default{get surface(){var e;return null===(e=this.view.map)||void 0===e?void 0:e.ground}get surfaceView(){return this.view.basemapTerrain}get renderLocation(){if(!this.location)return null;const e=(0,R.Ue)();return this.view.renderCoordsHelper.toRenderCoords(this.location,e),e}constructor(e){super(e),this.location=null,this._updateController=null}initialize(){this.view.state.isLocal&&(this.addHandles([(0,g.watch)((()=>{var e,t;return[null===(e=this.surfaceView)||void 0===e?void 0:e.spatialReference,null===(t=this.surfaceView)||void 0===t?void 0:t.extent]}),(()=>this._update())),(0,g.on)((()=>{var e;return null===(e=this.surface)||void 0===e?void 0:e.layers}),"change",(()=>this._update()))]),this._update())}_update(){var e;if(this._updateController&&(this._updateController.abort(),this._updateController=null),null==(null===(e=this.surfaceView)||void 0===e?void 0:e.extent)||null==this.surfaceView.spatialReference)return void this._set("location",null);const t=(0,L.be)(this.surfaceView.extent),i=new ua.Z({x:t[0],y:t[1],z:0,spatialReference:this.surfaceView.spatialReference});this.surface&&this.surface.layers.length>0?(this._set("location",null),this._updateController=new AbortController,this.surface.queryElevation(i,{noDataValue:0,signal:this._updateController.signal,cache:this.cache}).then((e=>{this._updateController=null,this._set("location",e.geometry)})).catch((e=>{}))):this._set("location",i)}};(0,n._)([(0,b.Cb)({constructOnly:!0})],Lu.prototype,"view",void 0),(0,n._)([(0,b.Cb)({constructOnly:!0})],Lu.prototype,"cache",void 0),(0,n._)([(0,b.Cb)()],Lu.prototype,"surface",null),(0,n._)([(0,b.Cb)()],Lu.prototype,"surfaceView",null),(0,n._)([(0,b.Cb)({readOnly:!0})],Lu.prototype,"location",void 0),(0,n._)([(0,b.Cb)({readOnly:!0})],Lu.prototype,"renderLocation",null),Lu=(0,n._)([(0,C.j)("esri.views.3d.support.pointsOfInterest.StableSurfaceCenter")],Lu);let Nu=class extends T.default{constructor(e){super(e),this._tileGeometryUpdateExtent=(0,L.cS)(),this._tileGeometryUpdateSpatialReference=null,this.events=new G.Z,this.updating=!1}initialize(){this.addHandles([this.surface.on("elevation-change",(e=>this._tileGeometryChanged(e))),this.scheduler.registerTask(Bt.T8.SURFACE_GEOMETRY_UPDATES,this)])}get running(){return this.updating}runTask(){return this.updating?(this._tileGeometryUpdateSpatialReference&&this._centerIntersectsExtent(this._tileGeometryUpdateExtent,this._tileGeometryUpdateSpatialReference)&&this.events.emit("request-update",Uu),(0,L.cS)(this._tileGeometryUpdateExtent),this._set("updating",!1),Gt.J):Gt.J}_tileGeometryChanged(e){this._tileGeometryUpdateSpatialReference=e.spatialReference,(0,L.jn)(this._tileGeometryUpdateExtent,e.extent,this._tileGeometryUpdateExtent),this._set("updating",!0)}_furthestCenterOnSurface(){let e=this.centerOnSurfaces[0];for(let t=1;t<this.centerOnSurfaces.length;t++){const i=this.centerOnSurfaces[t];i.distance>e.distance&&(e=i)}return e}_centerIntersectsExtent(e,t){const i=this.state.contentCamera.eye,n=Vu,r=this._furthestCenterOnSurface();return this.renderCoordsHelper.fromRenderCoords(i,Hu,t),this.renderCoordsHelper.fromRenderCoords(r.renderLocation,Fu,t),Hu[0]<Fu[0]?(n[0]=Hu[0],n[2]=Fu[0]):(n[0]=Fu[0],n[2]=Hu[0]),Hu[1]<Fu[1]?(n[1]=Hu[1],n[3]=Fu[1]):(n[1]=Fu[1],n[3]=Hu[1]),(0,L.kK)(n,e)}};(0,n._)([(0,b.Cb)({constructOnly:!0})],Nu.prototype,"state",void 0),(0,n._)([(0,b.Cb)({constructOnly:!0})],Nu.prototype,"centerOnSurfaces",void 0),(0,n._)([(0,b.Cb)({constructOnly:!0})],Nu.prototype,"renderCoordsHelper",void 0),(0,n._)([(0,b.Cb)({constructOnly:!0})],Nu.prototype,"scheduler",void 0),(0,n._)([(0,b.Cb)({constructOnly:!0})],Nu.prototype,"surface",void 0),(0,n._)([(0,b.Cb)({readOnly:!0})],Nu.prototype,"updating",void 0),Nu=(0,n._)([(0,C.j)("esri.views.3d.support.pointsOfInterest.SurfaceGeometryUpdates")],Nu);const Uu={},Hu=(0,R.Ue)(),Fu=(0,R.Ue)(),Vu=(0,L.cS)();let qu=class extends T.default{constructor(e){super(e),this.renderPointOfView=(0,R.Ue)(),this._pois=new Array,this._debugCenters=new Map,this._tmpRay=(0,wn.Ue)(),this._centerRayDirty=!0,this._surfaceAltitudeAtCenter=0,this._surfaceAltitudeAtCenterDirty=!0,this._contentAltitudeAtCenter=0,this._contentAltitudeAtCenterDirty=!0,this._propertiesPool=new Oa.L({renderPointOfView:zu},this)}initialize(){var e;const{state:t,basemapTerrain:i,renderCoordsHelper:n,map:r}=this.view;this._surfaceIntersector=(0,Dr.Z8)(t.viewingMode),t.isGlobal?this._surfaceIntersector.options.backfacesTerrain=!1:this._surfaceIntersector.options.backfacesTerrain=!0,this._surfaceIntersector.options.invisibleTerrain=!1,this._surfaceIntersector.options.store=qc.eC.MIN,this._contentIntersector=(0,Dr.Z8)(t.viewingMode);const s=()=>this._estimateSurfaceAltitudeAtCenter(),a=this.view.resourceController.scheduler,o=null===(e=this.view.basemapTerrain)||void 0===e?void 0:e.elevationQueryCache,l={state:t,scheduler:a,surface:i,renderCoordsHelper:n};this._set("centerOnSurfaceInfrequent",new Cu({...l,task:Bt.T8.POINT_OF_INTEREST_INFREQUENT,estimateSurfaceAltitudeAtCenter:s})),this._set("centerOnSurfaceFrequent",new Cu({...l,task:Bt.T8.POINT_OF_INTEREST_FREQUENT,estimateSurfaceAltitudeAtCenter:s})),this._set("centerOnContent",new Cu({...l,task:Bt.T8.POINT_OF_INTEREST_FREQUENT,estimateSurfaceAltitudeAtCenter:()=>this._estimateContentAltitudeAtCenter()})),this._set("cameraOnSurface",new fu({...l,cache:o,task:Bt.T8.POINT_OF_INTEREST_INFREQUENT,map:r})),this._set("surfaceGeometryUpdates",new Nu({...l,centerOnSurfaces:[this.centerOnSurfaceFrequent,this.centerOnContent,this.centerOnSurfaceInfrequent]})),this._set("contentGeometryUpdates",new Mu({contentLayerViews:this.view.allLayerViews,renderCoordsHelper:n})),this._set("surfaceOrigin",new Lu({cache:o,view:this.view})),this._set("focus",new Ou({state:t,scheduler:a,surface:i,renderCoordsHelper:n,centerOnSurface:this.centerOnSurfaceFrequent,estimateSurfaceIntersectionAtRenderPoint:(e,t)=>this._estimateSurfaceIntersectionAtRenderPoint(e,this.view.state.contentCamera,t)})),this._pois.push(this.centerOnContent,this.centerOnSurfaceFrequent,this.centerOnSurfaceInfrequent,this.cameraOnSurface,this.focus);const h=this.view.graphics;this._debugCenters.set(this.centerOnContent,new _u(h,"red","CenterOnContent")),this._debugCenters.set(this.centerOnSurfaceFrequent,new _u(h,"red","CenterOnSurface")),this._debugCenters.set(this.centerOnSurfaceInfrequent,new _u(h,"red","CenterOnSurface")),this._debugCenters.set(this.cameraOnSurface,new _u(h,"blue","CameraOnSurface")),this._debugCenters.set(this.focus,new _u(h,"green","Focus")),this.addHandles([(0,g.watch)((()=>t.contentCamera),(e=>this._cameraChanged(e)),g.sync),(0,g.watch)((()=>i.extent),(()=>this._updateCenterPointsOfInterest())),(0,g.when)((()=>!i.updating),(()=>this._updateCenterPointsOfInterest()),g.sync),(0,g.on)((()=>this.surfaceGeometryUpdates.events),"request-update",(()=>this._updateCenterPointsOfInterest())),(0,g.on)((()=>this.contentGeometryUpdates.events),"request-update",(()=>this._updateCenterOnContent())),(0,g.when)((()=>_l.h.SHOW_POI),(e=>this._setDebug(e)),g.initial)]),this._cameraChanged(this.view.state.contentCamera);for(const c of this._pois)c.runTask()}destroy(){this._setDebug(!1),this._propertiesPool.destroy();for(const e of this._pois)e.destroy();this.surfaceOrigin.destroy()}get updating(){var e;return!((null===(e=this.surfaceGeometryUpdates)||void 0===e||!e.updating)&&!this._pois.some((e=>e.updating)))}get _centerRay(){return this._centerRayDirty&&(this._centerRayCached=this.view.sceneIntersectionHelper.getCenterRayWithSubpixelOffset(this.view.state.contentCamera,this._tmpRay),this._centerRayDirty=!1),this._centerRayCached}_estimateContentAltitudeAtCenter(){if(!this._contentAltitudeAtCenterDirty)return this._contentAltitudeAtCenter;this._contentAltitudeAtCenterDirty=!1;const e=this._centerRay;return null==e||(this.view.sceneIntersectionHelper.intersectRay(e,this._contentIntersector,Bu,ku)?this._contentAltitudeAtCenter=this.view.renderCoordsHelper.getAltitude(Bu):this._contentAltitudeAtCenter=this._estimateSurfaceAltitudeAtCenter()),this._contentAltitudeAtCenter}_estimateSurfaceAltitudeAtCenter(){if(!this.view.basemapTerrain)return 0;if(!this._surfaceAltitudeAtCenterDirty)return this._surfaceAltitudeAtCenter;this._surfaceAltitudeAtCenterDirty=!1;const e=this._centerRay;if(null==e)return this._surfaceAltitudeAtCenter;const t=e.origin,i=(0,Ge.g)(Bu,e.origin,e.direction);return this._surfaceIntersector.resetWithRay(e,this.view.state.contentCamera),this.view.basemapTerrain.intersect(this._surfaceIntersector,null,t,i),this._surfaceIntersector.results.min.getIntersectionPoint(Bu)&&(this._surfaceAltitudeAtCenter=this.view.renderCoordsHelper.getAltitude(Bu)),this._surfaceAltitudeAtCenter}_estimateSurfaceIntersectionAtRenderPoint(e,t,i){const n=(0,Wr.eW)(t,e,Gu);if(null==n)return null;const r=n.origin,s=(0,Ge.g)(Bu,n.origin,n.direction);return this._surfaceIntersector.resetWithRay(n,t),this.view.basemapTerrain.intersect(this._surfaceIntersector,null,r,s),this._surfaceIntersector.results.min.getIntersectionPoint(i)?i:null}_cameraChanged(e){this._updateCenterPointsOfInterest();const t=e.eye;(0,Ge.e)(this.renderPointOfView,t)||this._set("renderPointOfView",(0,Ge.c)(this._propertiesPool.get("renderPointOfView"),t))}_updateCenterPointsOfInterest(){this._centerRayDirty=!0,this._surfaceAltitudeAtCenterDirty=!0,this._contentAltitudeAtCenterDirty=!0;for(const e of this._pois)e.updateRenderLocation()}_updateCenterOnContent(){this._contentAltitudeAtCenterDirty=!0,this.centerOnContent.updateRenderLocation()}_setDebug(e){if(!e)return this._debugCenters.forEach((e=>e.hide())),void this.removeHandles("debug");for(const t of this._pois)this.addHandles((0,g.watch)((()=>t.renderLocation),(e=>{var i;return null===(i=this._debugCenters.get(t))||void 0===i?void 0:i.show(e,t.renderCoordsHelper.spatialReference)}),g.initial),"debug")}get test(){}};(0,n._)([(0,b.Cb)()],qu.prototype,"centerOnContent",void 0),(0,n._)([(0,b.Cb)()],qu.prototype,"centerOnSurfaceFrequent",void 0),(0,n._)([(0,b.Cb)()],qu.prototype,"centerOnSurfaceInfrequent",void 0),(0,n._)([(0,b.Cb)()],qu.prototype,"cameraOnSurface",void 0),(0,n._)([(0,b.Cb)()],qu.prototype,"focus",void 0),(0,n._)([(0,b.Cb)()],qu.prototype,"renderPointOfView",void 0),(0,n._)([(0,b.Cb)()],qu.prototype,"surfaceOrigin",void 0),(0,n._)([(0,b.Cb)()],qu.prototype,"contentGeometryUpdates",void 0),(0,n._)([(0,b.Cb)()],qu.prototype,"surfaceGeometryUpdates",void 0),(0,n._)([(0,b.Cb)({constructOnly:!0})],qu.prototype,"view",void 0),(0,n._)([(0,b.Cb)()],qu.prototype,"updating",null),qu=(0,n._)([(0,C.j)("esri.views.3d.support.pointsOfInterest.PointsOfInterest")],qu);const zu=Array,Bu=(0,R.Ue)(),Gu=(0,wn.Ue)(),ku={exclude:new Set([Jr.xX])};var Zu=i(77178),ju=i(76861),Wu=i(5986),Xu=i(22689),Qu=i(72291),Yu=i(4035),Ju=i(58890);class Ku{constructor(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;this.min=e,this.max=t,this.level=0,this.hasNoDataValues=!1}copyFrom(e){this.min=e.min,this.max=e.max,this.level=e.level,this.hasNoDataValues=e.hasNoDataValues}}var $u=i(11939);class ep{constructor(e,t,i){this.type="elevation",this.level=e[0],this.i=e[1],this.j=e[2],this.extent=t,this.samplerData=new $u.K(i,t)}computeMinMaxValue(e,t,i,n){n.min=1/0,n.max=-1/0,n.hasNoDataValues=!1;const r=e-this.level;if(r<=0)return n;const s=2**r;if(Math.floor(t/s)!==this.i||Math.floor(i/s)!==this.j)return n;let a=1/0,o=-1/0;const l=this.samplerData.data.width,h=this.samplerData.data.values,c=.5*W.zl;let d=(l-1)/s,u=(i-this.j*s)*d,p=(t-this.i*s)*d;if(d<1){const e=Math.floor(u),t=Math.floor(p),i=e+t*l,r=h[i],s=h[i+1],a=h[i+l],o=h[i+l+1];if(r+s+a+o<c){const i=u-e,l=p-t,h=(0,fe.bX)(r,s,a,o,i,l),c=(0,fe.bX)(r,s,a,o,i+d,l),_=(0,fe.bX)(r,s,a,o,i,l+d),m=(0,fe.bX)(r,s,a,o,i+d,l+d);return n.min=Math.min(h,c,_,m),n.max=Math.max(h,c,_,m),n}u=e,p=t,d=1}else u=Math.floor(u),p=Math.floor(p),d=Math.ceil(d);for(let _=u;_<=u+d;_++)for(let e=p;e<=p+d;e++){const t=h[_+e*l];t<c?(a=Math.min(a,t),o=Math.max(o,t)):n.hasNoDataValues=!0}return n.min=a,n.max=o,n}}const tp=.5*W.zl;function ip(e,t,i){if(null==i)return null;for(const n of i){if(!n)continue;const i=n.safeWidth;let r=(0,me.uZ)(n.dy*(n.y1-t),0,i),s=(0,me.uZ)(n.dx*(e-n.x0),0,i);const a=Math.floor(r),o=Math.floor(s),l=n.data.width,h=a*l+o,c=n.data.values,d=c[h],u=c[h+1],p=h+l,_=c[p],m=c[p+1];if(d+_+u+m<tp){r-=a,s-=o;const e=d+(u-d)*s;return e+(_+(m-_)*s-e)*r}}return null}var np=i(53379);let rp=class extends T.default{constructor(e){super(e)}initialize(){this.addHandles([this.layerViews.on("change",(()=>this.notifyChange("stencilEnabledExtents")))])}destroy(){}get layerViewsExtent(){return this._computeLayerViewsExtent()}get tiledLayersExtent(){return this._computeTiledLayersExtent()}get stencilEnabledExtents(){return this._computeStencilEnabledExtents()}_computeStencilEnabledExtents(){const e=[];return this.layerViews.forEach((t=>{const i=t.layer;if("operationalLayerType"in i&&(0,F.$4)(i.operationalLayerType)&&null!=this.viewSpatialReference){const t=op(i.fullExtent,this.viewSpatialReference);null!=t&&e.push((0,L.oJ)(t))}})),e}};(0,n._)([(0,b.Cb)({readOnly:!0})],rp.prototype,"layerViewsExtent",null),(0,n._)([(0,b.Cb)({readOnly:!0})],rp.prototype,"tiledLayersExtent",null),(0,n._)([(0,b.Cb)({readOnly:!0})],rp.prototype,"stencilEnabledExtents",null),(0,n._)([(0,b.Cb)()],rp.prototype,"viewSpatialReference",void 0),(0,n._)([(0,b.Cb)()],rp.prototype,"tilingScheme",void 0),(0,n._)([(0,b.Cb)()],rp.prototype,"defaultTiledLayersExtent",void 0),(0,n._)([(0,b.Cb)({constructOnly:!0})],rp.prototype,"layers",void 0),(0,n._)([(0,b.Cb)({constructOnly:!0})],rp.prototype,"layerViews",void 0),rp=(0,n._)([(0,C.j)("esri.views.3d.terrain.ExtentHelper")],rp);let sp=class extends rp{_computeLayerViewsExtent(){return this._globalExtent}_computeTiledLayersExtent(){return this._globalExtent}get _globalExtent(){return this.viewSpatialReference.isWebMercator?W.uU:W.JR}};sp=(0,n._)([(0,C.j)("esri.views.3d.terrain.ExtentHelper.ExtentHelperGlobal")],sp);let ap=class extends rp{_computeLayerViewsExtent(){const e=(0,L.cS)(),t=this.viewSpatialReference;this.layerViews.forEach((i=>{const n=i.layer;if(i.isResolved()&&("graphics"!==n.type||!n.internal)){const n=op("fullExtentInLocalViewSpatialReference"in i&&i.fullExtentInLocalViewSpatialReference||i.layer.fullExtent,t);(0,L.jn)(e,n,e)}}));const i=(0,L.sU)(e)?e:null,n=this._get("layerViewsExtent");return(0,L.fS)(i,n)?n:i}_computeTiledLayersExtent(){const e=this.tilingScheme;if(!e)return null;const t=this.viewSpatialReference,i=(0,L.cS)();this.layers.forEach((n=>{if(n.loaded&&(0,F.iC)(n)){var r;const s=(0,np.E_)(n,t,te.JY.Local);if(null==s)return;const{tileInfo:a,fullExtent:o}=s,l="tilemapCache"in n?null===(r=n.tilemapCache)||void 0===r?void 0:r.effectiveMaxLOD:void 0;null!=a&&null!=o&&((0,np.x4)(n)||e.compatibleWith(a,l)&&o.spatialReference.equals(e.spatialReference))&&(0,L.jn)(i,o,i)}})),(0,L.jn)(i,this.defaultTiledLayersExtent,i);const n=(0,L.sU)(i)?i:null,r=this._get("tiledLayersExtent");return(0,L.fS)(n,r)?r:n}};function op(e,t){return null==e||e.spatialReference.equals(t)?e:(0,E.projectWithoutEngine)(e,e.spatialReference,t)}ap=(0,n._)([(0,C.j)("esri.views.3d.terrain.ExtentHelper.ExtentHelperLocal")],ap);var lp=i(54134),hp=i(81753),cp=i(19265),dp=i(68401),up=i(61403),pp=i(56529),_p=i(81341);function mp(){var e;const t=null===(e=globalThis.require)||void 0===e?void 0:e.modules;if(t){const e=Object.keys(t);for(const i of e)i.includes(".glsl")&&delete t[i]}}const gp=[[-.1,-2,3.9,2],[-.1,-3.9,3.9,.1],[-2,-3.9,2,.1],[-3.9,-3.9,.1,.1],[-3.9,-2,.1,2],[-3.9,-.1,.1,3.9],[-2,-.1,2,3.9],[-.1,-.1,3.9,3.9]];let fp,vp=class extends T.default{constructor(e){super(e),this._spatialReference=null,this._renderSR=null,this._overlaySREqualsRenderSR=!0,this._drapeSources=new Set,this._drapeTargets=new Set,this._placementDirty=!1,this._contentUpdated=!1,this._drawTexturesDirty=!1,this._drawTexturesAnimateDirty=!1,this._longitudeCyclical=null,this._latestOriginId=0,this._maxResolution=(0,d.Z)("esri-mobile")?2048:4096,this._animationTimeLast=0}initialize(){const e=this.view;this.renderer=new cp.CB({view:e,worldToPCSRatio:this._worldToPCSRatio,spatialReference:this._spatialReference}),e._stage.renderer.plugins.add(this.renderer);const t=()=>this.setDrawTexturesDirty();this._groundIntersector=(0,Dr.Z8)(this.view.state.viewingMode),this._groundIntersector.options.backfacesTerrain=!0,this._groundIntersector.options.invisibleTerrain=!0,this._groundIntersector.options.hud=!1,this.addHandles([(0,g.watch)((()=>this.renderer.hasHighlights),t),this.renderer.events.on("has-water",(t=>{var i;return null===(i=e._stage)||void 0===i?void 0:i.renderer.setParameters({hasOverlayWater:t})})),this.renderer.events.on("content-changed",t),(0,g.watch)((()=>e.state.camera.pixelRatio),t),(0,g.watch)((()=>e.state.alignPixelEnabled),t),this.renderer.events.on("textures-disposed",(()=>this.surface.requestRender())),(0,g.watch)((()=>{var t,i;return[null===(t=e.pointsOfInterest)||void 0===t?void 0:t.renderPointOfView,null===(i=e.pointsOfInterest)||void 0===i||null===(i=i.centerOnSurfaceFrequent)||void 0===i?void 0:i.location]}),(()=>this.setPlacementDirty())),(0,g.watch)((()=>{var t,i;return[null===(t=e.state)||void 0===t?void 0:t.pixelRatio,null===(i=e.state)||void 0===i?void 0:i.contentPixelRatio]}),(()=>this.setPlacementDirty()),g.sync),this.surface.on("elevation-change",(()=>this.setPlacementDirty())),e.on("resize",(()=>this.setPlacementDirty())),e.resourceController.scheduler.registerTask(Bt.T8.OVERLAY,this),e._stage.renderView.events.on("force-camera-for-screenshot",(e=>{this._updateOverlays(Bt.G5,e.camera,dp.Xx.BACKGROUND),this.renderer.hasOverlays&&this._drawOverlays(dp.Xx.BACKGROUND,e)}))]),e._stage.renderer.renderOverlay=e=>this._renderOverlay(e)}destroy(){var e;null!==(e=this.view)&&void 0!==e&&e._stage&&(this.view._stage.renderer.plugins.remove(this.renderer),this.view._stage.renderer.renderOverlay=()=>{}),fp&&(fp.hide(),fp=null),this.renderer=(0,p.SC)(this.renderer)}get running(){return this._placementDirty&&(this._drapeSources.size>0||this.view.graphics.length>0||_l.h.OVERLAY_DRAW_DEBUG_TEXTURE)&&!!this._spatialReference&&!this.suspended&&this.surface.ready}get _isSpherical(){return this.view.state.isGlobal}get _worldToPCSRatio(){return null!=this._spatialReference&&this._spatialReference.isGeographic&&!this.view.state.isLocal?(0,Ze.Iu)(this._spatialReference).metersPerDegree:1}get _overlayStretch(){return 1.3/this.view.resolutionScale}get suspended(){return this.surface.suspended}get updating(){return this.running||this.renderer.updating||this._contentUpdated}get rendersOccludedDraped(){return this.renderer.rendersOccludedDraped}_renderOverlay(e){if(this._contentUpdated=!1,this.renderer.processSyncDrapeSources(),this.renderer.hasOverlays)return this._dispatchAnimationUpdate(e),this._drawOverlays(dp.Xx.UPDATE,this.view.state)}get hasOverlays(){return this.renderer.hasOverlays}setSpatialReference(e){this._spatialReference=e,this.renderer.spatialReference=e,this._longitudeCyclical=null;const t=this.view.renderSpatialReference;null!=e&&null!=t?(this._renderSR=t,this._overlaySREqualsRenderSR=e.equals(this._renderSR),this._isSpherical&&(this._longitudeCyclical=e.isWebMercator?new Ur.pE(-20037508.342787,20037508.342787):new Ur.pE(-180,180),this.renderer.longitudeCyclical=this._longitudeCyclical),this.renderer&&(this.renderer.worldToPCSRatio=this._worldToPCSRatio)):this.renderer.disposeOverlays()}registerDrapeSource(e,t,i){this._drapeSources.add(e),this.renderer.ensureOverlays(this._drapeTargets,this._drapeSources);const n=this.renderer.createDrapeSourceRenderer(e,t,i);return this._updateDrapeSourceExtent(e),this._setContentDirty(),this.notifyChange("running"),n}registerGeometryDrapeSource(e){return this.registerDrapeSource(e,_p.S)}_updateDrapeSourceExtent(e){2===this.renderer.overlays.length&&null!=e.setDrapingExtent&&null!=this._spatialReference&&e.setDrapingExtent(this.renderer.overlays,this._spatialReference)}unregisterDrapeSource(e){this._drapeSources.has(e)&&(this._drapeSources.delete(e),this.renderer.removeDrapeSourceRenderer(e),this.renderer.ensureDrapeSources(this._drapeSources),this._setContentDirty(),this.notifyChange("running"))}registerDrapeTarget(e){this._drapeTargets.add(e),this.renderer.ensureOverlays(this._drapeTargets,this._drapeSources)}unregisterDrapeTarget(e){this._drapeTargets.delete(e),this.renderer.ensureDrapeTargets(this._drapeTargets)}_setContentDirty(){this.setPlacementDirty(),this.setDrawTexturesDirty()}setPlacementDirty(){this._placementDirty=!0}runTask(e){return this._updateOverlays(e,this.view.state.contentCamera,dp.Xx.UPDATE)}_updateOverlays(e,t,i){if(!this._spatialReference)return Gt.J;const n=this._computeOverlayResolution(t);this._computeOverlayExtents(t,n,wp),this.renderer.ensureOverlays(this._drapeTargets,this._drapeSources,wp.stretch);const r=this._updateOverlay(lp.fu.INNER,wp.inner,n,1*wp.pixelRatioAdjustment,wp.mapUnitsPerPixel),s=(0,L.d_)(wp.inner)/(0,L.d_)(wp.outer),a=this._updateOverlay(lp.fu.OUTER,wp.outer,n,s*wp.pixelRatioAdjustment,wp.mapUnitsPerPixel);r!==Sp.EXTENT&&a!==Sp.EXTENT||(this._drapeSources.forEach((e=>this._updateDrapeSourceExtent(e))),this.surface.updateTileOverlayParams(i)),r===Sp.NONE&&a===Sp.NONE||this.setDrawTexturesDirty(),this._placementDirty=!1,e.madeProgress()}_computeOverlayResolution(e){const t=this.view.state.contentPixelRatio*this.view.resolutionScale,i=e.fullWidth/e.pixelRatio*t,n=e.fullHeight/e.pixelRatio*t,r=Math.ceil(1.5*Math.max(i,n));return Math.min((0,mt.nq)(r),this._maxResolution)}_updateOverlay(e,t,i,n,r){if(0===this.renderer.overlays.length)return Sp.NONE;const s=this.renderer.overlays[e],a=s.mapUnitsPerPixel;if(s.mapUnitsPerPixel=r,s.pixelRatio=n,function(e,t){const i=1e-5,n=_l.h.TESTS_DISABLE_OPTIMIZATIONS?0:i*Math.max(e[2]-e[0],e[3]-e[1],t[2]-t[0],t[3]-t[1]);return Math.abs(t[0]-e[0])<=n&&Math.abs(t[1]-e[1])<=n&&Math.abs(t[2]-e[2])<=n&&Math.abs(t[3]-e[3])<=n}(t,s.extent)&&i===s.resolution)return a===r?Sp.NONE:Sp.RERENDER_ONLY;(0,L.JG)(s.extent,t),s.resolution=i;const o=(0,L.be)(s.extent);return s.renderLocalOrigin=(0,up.a)(o[0],o[1],0,"OV_"+this._latestOriginId++),Sp.EXTENT}setTileParameters(e){const t=e.renderData.overlay;if(this.renderer.overlays.length>0){const i=this.renderer.overlays[lp.fu.INNER],n=this.renderer.overlays[lp.fu.OUTER],r=e.extent;this._rectInsideRect(i.extent,r)||this._rectanglesOverlap(r,i.extent)||this._rectanglesOverlap(r,n.extent)?(this._setTileOverlayData(r,lp.fu.INNER,t),this._setTileOverlayData(r,lp.fu.OUTER,t)):(this._clearTileOverlayData(lp.fu.INNER,t),this._clearTileOverlayData(lp.fu.OUTER,t))}else this._clearTileOverlayData(lp.fu.INNER,t),this._clearTileOverlayData(lp.fu.OUTER,t)}overlayPixelSizeInMapUnits(e,t){if(0===this.renderer.overlays.length)return t();const i=this.renderer.overlays[lp.fu.INNER],n=this.renderer.overlays[lp.fu.OUTER],r=this._pointIsInExtent(e,i.extent)?i:n;return(r.extent[2]-r.extent[0])/r.resolution}_setTileOverlayData(e,t,i){if(0===this.renderer.overlays.length)return;const n=this.renderer.overlays[t].extent,r=(0,L.d_)(n),s=(0,L.Cb)(n);let a=e[0];if(this._longitudeCyclical){a=this._longitudeCyclical.minimalMonotonic(n[0],a);const t=this._longitudeCyclical.minimalMonotonic(n[0],e[2]);a>t&&(a=t-(e[2]-e[0]))}i.setScale(t,(0,L.d_)(e)/r,(0,L.Cb)(e)/s),i.setOffset(t,(a-n[0])/r,(e[1]-n[1])/s)}_clearTileOverlayData(e,t){t.setScale(e,-1,-1),t.setOffset(e,-1,-1)}async reloadShaders(){mp(),await this.renderer.reloadShaders(),this.setDrawTexturesDirty(),this.runTask(Bt.G5)}_dispatchAnimationUpdate(e){const t=(0,Ri.HA)(e-this._animationTimeLast);if(t>=this.surface.view._stage.renderer.animationTimestep||null!=this.view.state.forcedAnimationTime||this._drawTexturesDirty||this._drawTexturesAnimateDirty){const i=(0,Ri.HA)(t/this.surface.view._stage.renderer.animationTimeDilation),n=new pp._o(this.view.state.camera,i,this.view.state.forcedAnimationTime);this.renderer.updateAnimation(n)&&(this._drawTexturesAnimateDirty=!0),this._animationTimeLast=e}}setDrawTexturesDirty(){this.renderer.hasOverlays?(this._contentUpdated=!0,this._drawTexturesDirty=!0,this.view._stage.renderView.requestRender()):this.setPlacementDirty()}_intersectGroundFromView(e,t,i,n){const r=this.view.sceneIntersectionHelper.getCenterRayWithSubpixelOffset(e,Tp,t,i);if(null==r)return!1;const s=r.origin,a=(0,Ge.g)(bp,r.origin,r.direction);return this._groundIntersector.reset(s,a,e),this._groundIntersector.intersect([]),this.view.basemapTerrain.intersect(this._groundIntersector,null,s,a),this._groundIntersector.results.min.getIntersectionPoint(n)}_findHorizonBasedPointOfInterest(e,t){let i=.5;const n=.55,r=this.view.renderCoordsHelper.getAltitude(e.eye),s=this.view.pointsOfInterest.centerOnSurfaceFrequent,a=1e-5,o=(0,me.uZ)(s.estimatedSurfaceAltitude,e.aboveGround?-1/0:r+a,e.aboveGround?r-a:1/0),l=e.aboveGround;if("global"===this.view.viewingMode){const t=bp;(0,bn.e)((0,bn.h)(bn.t,(0,Ze.Iu)(this.view.spatialReference).radius+o),(0,wn.re)(e.eye,e.viewForward),t),(0,Ge.f)(t,t,e.eye);const r=Ur.Q4.normalize((0,Vr.cp)(e.viewForward,t,e.viewRight))/e.fovY+.5,s=r<=0||r>=1?.5:n;i=l?s*r:r+s*(1-r)}else{const t=.5*Math.PI-Math.acos(-e.viewForward[2]),r=Math.tan(t),s=(0,Ye.al)(0,r,1,0),a=(0,Qe.t)(s,s,e.projectionMatrix)[1],o=(0,me.uZ)(.5+.5*a,0,1);i=1===o||0===o?.5:l?o*n:1-(1-o)*n}return!!this._intersectGroundFromView(e,.5,i,t)&&(0,Ge.w)(t,e.eye)<s.distance*s.distance}_computeOverlayExtents(e,t,i){var n;const r=this.view.pointsOfInterest.centerOnSurfaceFrequent.renderLocation,s=(0,R.Ue)();this._findHorizonBasedPointOfInterest(e,s)||(0,Ge.c)(s,r),_l.h.OVERLAY_SHOW_CENTER?(null==fp&&(fp=new _u(this.view.graphics,"red")),fp.show(s,this._renderSR)):null!=fp&&fp.hide();const a=Math.max(.1,(0,Ge.p)(e.eye,s)),o=Wn(this.view.renderCoordsHelper,r,e.eye);this._overlaySREqualsRenderSR||(0,Wu.S)(s,this._renderSR,s,this._spatialReference);const l=this.surface.extent,h=!this._isSpherical&&(null===(n=this._spatialReference)||void 0===n?void 0:n.isGeographic),c=h&&this._spatialReference?1/(0,Ze.Iu)(this._spatialReference).metersPerDegree:1,d=this.view.state.contentPixelRatio,u=e.perScreenPixelRatio/d*a*c;i.mapUnitsPerPixel=u/this._worldToPCSRatio,i.stretch=this._overlayStretch;let p=t*u/2*i.stretch,_=!1,m=h?90:1/0;this._isSpherical&&l&&this._spatialReference&&(this._spatialReference.isWebMercator?(p/=Math.cos((0,hp.mZ)(s[1])),m=l[3]):(_=!0,p/=(0,Ze.Iu)(this._spatialReference).metersPerDegree,m=90),p>=m&&(p=m,s[1]=0,this._spatialReference.isWebMercator&&(s[0]=0)));let g=1;_&&(g=1/Math.max(.2,Math.cos(Math.abs((0,me.Vl)(s[1])))),p*g>180&&(g=180/p),i.mapUnitsPerPixel*=g);const f=Math.log(2)/12;p=Math.exp(Math.round(Math.log(p)/f)*f);const v=p*g,y=.5*t/(32*v),b=.5*t/(32*p);s[0]=Math.round(s[0]*y)/y,s[1]=Math.round(s[1]*b)/b;const w=i.inner;w[0]=s[0]-v,w[1]=s[1]-p,w[2]=s[0]+v,w[3]=s[1]+p,this._isSpherical&&this._shiftExtentToFitBounds(w,1/0,m);const C=i.outer;if(6*v>(0,L.d_)(l))(0,L.JG)(C,l);else if(Math.PI/2-Math.abs(o-Math.PI/2)<=.25*Math.PI)C[0]=w[0]-v,C[1]=w[1]-p,C[2]=w[2]+v,C[3]=w[3]+p;else{(0,Wu.S)(e.eye,this._renderSR,bp,this._spatialReference),(0,Xe.$X)(yp,s,bp);let t=-Math.atan2(yp[1],yp[0])+.125*Math.PI;t<0&&(t+=2*Math.PI);const i=Math.floor(t/(.25*Math.PI));(0,Qe.b)(yp,gp[i],2*p),yp[0]*=g,yp[2]*=g,(0,Qe.f)(C,w,yp)}if(this._isSpherical)C[0]=this._longitudeCyclical.clamp(C[0]),C[2]=this._longitudeCyclical.clamp(C[2]),C[1]=Math.max(C[1],-m),C[3]=Math.min(C[3],m);else{const e=(0,L.jV)(w,l,Cp),t=(0,L.jV)(C,l,xp);(0,L.r3)(e,t)&&(C[2]=C[0],C[3]=C[1])}const x=Math.abs(w[2]-w[0])/t;i.mapUnitsPerPixel=Math.max(i.mapUnitsPerPixel,x),i.pixelRatioAdjustment=i.mapUnitsPerPixel/x}_drawOverlays(e,t){if(!this.renderer.hasOverlays)return;if(!this._drawTexturesDirty&&!this._drawTexturesAnimateDirty)return this.renderer;const i=this._drawTexturesDirty;this._drawTexturesDirty=this._drawTexturesAnimateDirty=!1;const n=this.renderer.computeValidity();return this.renderer.releaseRenderTargets(),this.renderer.drawOverlays(t),n!==this.renderer.computeValidity()&&this.surface.updateTileOverlayParams(dp.Xx.UPDATE),i?(this.surface.requestRender(e),e===dp.Xx.UPDATE&&this.surface.requestUpdate()):this.surface.requestRender(dp.Xx.BACKGROUND),this.renderer}_rectanglesOverlap(e,t){return null!=e&&(this._longitudeCyclical?(this._longitudeCyclical.contains(t[0],t[2],e[0])||this._longitudeCyclical.contains(t[0],t[2],e[2])||this._longitudeCyclical.contains(e[0],e[2],t[0]))&&!(e[1]>t[3]||e[3]<t[1]):(0,L.kK)(e,t))}_rectInsideRect(e,t){return null!=t&&(this._longitudeCyclical?this._longitudeCyclical.contains(e[0],e[2],t[0])&&this._longitudeCyclical.contains(e[0],e[2],t[2])&&t[1]>e[1]&&t[3]<e[3]:(0,L.r3)(e,t))}_pointIsInExtent(e,t){if(this._longitudeCyclical)return this._longitudeCyclical.contains(t[0],t[2],e.x)&&e.y>=t[1]&&e.y<=t[3];const i=e.x,n=e.y;return i>t[0]&&i<t[2]&&n>t[1]&&n<t[3]}_shiftExtentToFitBounds(e,t,i){let n=0,r=0;e[0]<-t?n=e[0]+t:e[2]>t&&(n=t-e[2]),e[1]<-i?r=e[1]+i:e[3]>i&&(r=i-e[3]),(0,L.cv)(e,n,r)}get test(){}};(0,n._)([(0,b.Cb)()],vp.prototype,"_spatialReference",void 0),(0,n._)([(0,b.Cb)({readOnly:!0})],vp.prototype,"running",null),(0,n._)([(0,b.Cb)()],vp.prototype,"_placementDirty",void 0),(0,n._)([(0,b.Cb)()],vp.prototype,"_contentUpdated",void 0),(0,n._)([(0,b.Cb)()],vp.prototype,"_isSpherical",null),(0,n._)([(0,b.Cb)()],vp.prototype,"_worldToPCSRatio",null),(0,n._)([(0,b.Cb)()],vp.prototype,"renderer",void 0),(0,n._)([(0,b.Cb)({constructOnly:!0})],vp.prototype,"view",void 0),(0,n._)([(0,b.Cb)({constructOnly:!0})],vp.prototype,"surface",void 0),(0,n._)([(0,b.Cb)()],vp.prototype,"suspended",null),(0,n._)([(0,b.Cb)()],vp.prototype,"updating",null),(0,n._)([(0,b.Cb)({type:Boolean})],vp.prototype,"rendersOccludedDraped",null),vp=(0,n._)([(0,C.j)("esri.views.3d.terrain.OverlayManager")],vp);const yp=(0,Ye.Ue)(),bp=(0,R.Ue)(),wp=new class{constructor(){this.inner=(0,L.Ue)(),this.outer=(0,L.Ue)(),this.mapUnitsPerPixel=0,this.pixelRatioAdjustment=1,this.stretch=1.3}},Cp=(0,L.Ue)(),xp=(0,L.Ue)(),Tp=(0,wn.Ue)();var Sp;!function(e){e[e.NONE=0]="NONE",e[e.EXTENT=1]="EXTENT",e[e.RERENDER_ONLY=2]="RERENDER_ONLY"}(Sp||(Sp={}));var Pp=i(41414),Mp=i(35367),Rp=i(52920);class Ap{constructor(){this.indices=null,this.indexCount=0,this.edgeIndicesStartIndex=0,this.poleIndicesStartIndex=0,this.vertexAttributes=null,this.edgeVerticesStartIndex=0,this.poleVerticesStartIndex=0,this.maxEdgeVertexCount=0,this.boundingBox=(0,Pp.cS)(),this.numVerticesPerSide=0,this.minu=0,this.minv=0,this.maxu=1,this.maxv=1,this.outerEdgesOffsetAndLength=[0,0,0,0,0,0,0,0]}release(){this.vertexAttributes=(0,p.RY)(this.vertexAttributes),this.indices=null}reset(){this.indices=null,this.vertexAttributes=null,(0,Pp.cS)(this.boundingBox),this.numVerticesPerSide=0}getEdgeFirstVertexIndex(e){return this.outerEdgesOffsetAndLength[2*e]}getEdgeCount(e){return this.outerEdgesOffsetAndLength[2*e+1]}getEdgeVertexIndex(e,t){return this.getEdgeAttributeIndex(e,t)}getEdgeVertexPosition(e,t,i,n){this._getEdgeVertexRaw(this.getEdgeAttributeIndex(e,n),t),(0,Ge.g)(t,t,i)}getEdgeNormal(e,t,i){const{typedBuffer:n,typedBufferStride:r}=this.vertexAttributes.normalCompressed;(0,Rp.rc)(t,n,this.getEdgeAttributeIndex(e,i),r)}setEdgeNormalFromValues(e,t,i,n,r){this._setNormal(this.getEdgeAttributeIndex(e,t),i,n,r)}setEdgeVertexFromValuesRawPositionUV(e,t,i,n,r,s,a){const o=this.getEdgeAttributeIndex(e,t);this.vertexAttributes.position.setValues(o,i,n,r),this._setUV(o,s,a)}setEdgeVertexFromValuesRawPositionUVNormal(e,t,i,n,r,s,a,o,l,h){const c=this.getEdgeAttributeIndex(e,t);this.vertexAttributes.position.setValues(c,i,n,r),this._setUV(c,s,a),this._setNormal(c,o,l,h)}_getEdgeVertexRaw(e,t){this.vertexAttributes.position.getVec(e,t)}_setNormal(e,t,i,n){const{typedBuffer:r,typedBufferStride:s}=this.vertexAttributes.normalCompressed;(0,Rp.hd)(r,e,t,i,n,s)}_setUV(e,t,i){Ep(this.vertexAttributes.uv0,e,t,i)}getEdgeAttributeIndex(e,t){return(0,np.Fp)(0<=t&&t<this.getEdgeCount(e)),this.getEdgeFirstVertexIndex(e)+t}}const Op=16384;function Ep(e,t,i,n){e.setValues(t,i*Op,n*Op)}class Dp{constructor(){this.numVerticesPerSide=0,this.samplerData=null,this.samplerDataVersion=0,this.clippingArea=null,this.wireframe=!1,this.cornerPeerNeighbors=[null,null,null,null],this.cornerNeighborCornerTiles=[null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null],this.cornerNeighborCornerTileSamplerVersions=[-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1],this.edgeResolutions=[-1,-1,-1,-1],this.edgePeerNeighbors=[null,null,null,null],this.edgePeerNeighborSamplerVersions=[-1,-1,-1,-1]}}class Ip{constructor(e){this._getFadeDuration=e,this._fadeStart=0,this._delayedTime=0}clear(){this._current=(0,p.SC)(this._current),this._next=(0,p.SC)(this._next),this._waiting=(0,p.SC)(this._waiting),this._delayed=(0,p.SC)(this._delayed)}get current(){if(null==this._current)return null;if(!this._isFadingEnabled){const e=this._delayed||this._waiting||this._next||this._current;e!==this._current&&(this._current=null,this.clear(),this._current=e)}let e=Ip.test.fadeMoment;if(null!=this._delayed&&(e=e||performance.now(),e>=this._delayedTime&&(this._push(this._delayed,Lp.Immediate),this._delayed=null)),null!=this._next){e=e||performance.now();const t=this._fadeDuration,i=null!=this._current&&this._next.texture===this._current.texture,n=this._next.type!==lp.Ns.FADING,r=e-this._fadeStart>=t;(i||n||r)&&((0,p.SC)(this._current),this._current=this._next,this._next=this._waiting,this._waiting=null,this._fadeStart=this._alignFadeStart(e))}return this._current}get next(){return this._next}get fadeFactor(){if(null==this._next)return 1;const e=Ip.test.fadeMoment||performance.now(),t=Math.max(0,e-this._fadeStart),i=this._fadeDuration;return t>i?0:1-t/i}get isFading(){return null!=this._next||null!=this._delayed}push(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:Lp.Immediate;this._delayed=(0,p.SC)(this._delayed),this._push(e,t)}_push(e,t){if(this._isFadingEnabled||this.clear(),null==this._current)return void(this._current=e);const i=Ip.test.fadeMoment||performance.now();return t!==Lp.Immediate?(this._delayed=e,void(this._delayedTime=i+t)):null==this._next?(this._next=e,void(this._fadeStart=this._alignFadeStart(i))):void(null!=e&&((0,p.SC)(this._waiting),this._waiting=e))}get _fadeDuration(){return null==this._waiting?this._getFadeDuration():.5*this._getFadeDuration()}_alignFadeStart(e){const t=this._getFadeDuration();return e+t-e%t}get _isFadingEnabled(){return this._getFadeDuration()>0}}var Lp;Ip.test={fadeMoment:0},function(e){e[e.Immediate=0]="Immediate",e[e.Delayed=5e3]="Delayed"}(Lp||(Lp={}));var Np=i(24204),Up=i(36734);class Hp{get updating(){return!!this._tileRequested}init(e,t,i,n){this.tile=e,this._layerIdx=t,this._layerClass=i,this._suspended=n,this._tileLayerInfo=e.getLayerInfo(t,i),this._tileRequested=null;const r=this._findAncestorWithData();this._setUpsampleTile(r)}startLoading(){return this._requestNext()}dispose(){this._tileRequested&&(this._tileRequested.unrequestLayerData(this._layerIdx,this._layerClass,this),this._tileRequested=null),this.tile=null,this._tileLayerInfo=null}setSuspension(e){e!==this._suspended&&(this._suspended=e,e?this._tileRequested&&(this._tileRequested.unrequestLayerData(this._layerIdx,this._layerClass,this),this._tileRequested=null):this._tileLayerInfo.data||this.update())}update(){const e=this._findAncestorWithData();return this._setUpsampleTile(e),this._requestNext()}dataArrived(e,t){this._setUpsampleTile(e,t),this._tileRequested=null,e===this.tile?this.tile.updateRenderData(this._layerClass,lp.Ns.FADING,t):this._requestNext()}dataMissing(){this._tileRequested=null,this._tileLayerInfo.data=null,this._requestNext()}_agentDone(){this.tile.agentDone(this._layerIdx,this._layerClass),this.dispose()}_requestNext(){if(this._suspended)return!0;const e=this._findNextDownload();if(this._tileRequested){if(e===this._tileRequested)return!0;this._tileRequested.unrequestLayerData(this._layerIdx,this._layerClass,this),this._tileRequested=null}return null!=e?e.requestLayerData(this._layerIdx,this._layerClass,this)&&(this._tileRequested=e):this._agentDone(),!!this._tileRequested}_findNextDownload(){const e=this._layerIdx,t=this._layerClass,i=this.tile.surface.layerViewByIndex(e,t),n=(0,np.RB)(i),{minLevel:r,maxLevel:s}=i.dataLevelRange,a=this._desiredMinLevelDelta,o=this._progressiveLevelModulo+a,l=this._scaleRangeEnabled?Up.yf:()=>!0;let h=this.tile;const c=h.level;let d;const u=this._tileLayerInfo.upsampleInfo,p=null!=u?u.tile.level:-1,_=null!=u&&p-c>=a,m=null===n||void 0===n?void 0:n.tilemapCache,g="vector-tile-3d"===i.type?i.schemaHelper:null;for(;h&&l(h,n,!1)&&h.level>=r;){var f;const i=h.level,n=c-i,l=h.layerInfo[t][e];if(l.data&&n>=a){(!_||i>p)&&this._setUpsampleTile(h),l.dataInvalidated&&(d=h);break}const u=null!==(f=null===g||void 0===g?void 0:g.getLevelRowColumn(h.lij))&&void 0!==f?f:h.lij;if("unavailable"!==(null===m||void 0===m?void 0:m.getAvailability(u[0],u[1],u[2]))&&i<=s&&!l.data&&!l.dataMissing&&((!d||h.level===r||i%W.GZ==0||c-d.level<a)&&(d=h),n>=o))break;h=h.parent}if(null!=d&&c-d.level<a)if(u)d=null;else{const i=this._findAncestorWithData();null!=i&&(this._setUpsampleTile(i),d=i.layerInfo[t][e].dataInvalidated?i:null)}return d}_findAncestorWithData(){const e=this.tile.elevationLevel,t=this._desiredMinLevelDelta;let i;for(let n=this.tile;n;n=n.parent)if(n.hasLayerData(this._layerIdx,this._layerClass)){if(e-n.level>=t)return n;i=n}return i}_setUpsampleTile(e,t){this._tileLayerInfo.setUpsampleInfo(this.tile,e),this.tile.updateRenderData(this._layerClass,lp.Ns.FADING,t)}get test(){}}const Fp=new Error("Abstract method called on TileAgent"),Vp=new class extends Hp{constructor(){super(...arguments),this.type="none"}get _desiredMinLevelDelta(){throw Fp}get _progressiveLevelModulo(){throw Fp}dispose(){}};var qp;!function(e){e[e.INSIDE=0]="INSIDE",e[e.INTERSECTS=1]="INTERSECTS",e[e.OUTSIDE=2]="OUTSIDE"}(qp||(qp={}));class zp{constructor(){this.waitingAgents=new pl.Z,this._upsampleInfo=null,this.loadingAgent=null,this.requestPromise=null,this.requestAbort=null,this.pendingUpdates=0}static acquire(e){const t=Bp.acquire();return t._init(e),t}release(){this.dispose(),Gp.delete(this),Bp.release(this)}dispose(){this.loadingAgent=(0,p.M2)(this.loadingAgent),this.abortRequest(),this._unsetUpsampleInfo(),this.pendingUpdates=0,this._data=(0,np.ep)(this._data)}static prune(){Bp.prune(0)}_init(e){this.waitingAgents.clear(),this._data=(0,np.ep)(this._data),this.dataMissing=!1,this.dataInvalidated=!1,this._unsetUpsampleInfo(),this.abortRequest(),this.loadingAgent=null,this.pendingUpdates=0,this._pool=e,this.elevationBounds=null}invalidateSourceData(){this.dataInvalidated=!0,this.dataMissing=!1,this._unsetUpsampleInfo()}abortRequest(){this.requestAbort=(0,p.IM)(this.requestAbort),this.requestPromise=null}get upsampleInfo(){return this._upsampleInfo}_unsetUpsampleInfo(){null!=this._upsampleInfo&&(this._upsampleInfo.tile.unrefMapData(),this._pool.release(this._upsampleInfo),this._upsampleInfo=null)}setUpsampleInfo(e,t){if(e!==t&&null!=t){if(null==this._upsampleInfo)this._upsampleInfo=this._pool.acquire();else{if(this._upsampleInfo.tile===t)return;this._upsampleInfo.tile.unrefMapData()}t.refMapData(),(0,Up.QT)(e,t,this._upsampleInfo)}else this._unsetUpsampleInfo()}get data(){return this._data}set data(e){(0,np.ep)(this._data),this._data=e}}const Bp=new rh.Z(zp,null,(()=>{})),Gp=new Map;var kp;!function(e){e[e.NONE=0]="NONE",e[e.SPLIT=1]="SPLIT",e[e.ELEVATION=2]="ELEVATION",e[e.MERGE=4]="MERGE",e[e.GEOMETRY=8]="GEOMETRY",e[e.TEXTURE_NOFADING=16]="TEXTURE_NOFADING",e[e.TEXTURE_FADING=32]="TEXTURE_FADING"}(kp||(kp={}));class Zp{constructor(){this._lij=[0,0,0],this._children=[null,null,null,null],this._pendingUpdates=0,this.renderData=null,this._dirty=!0,this._previouslyRendered=!1,this.extent=(0,L.Ue)(),this._elevationBoundsMin=NaN,this._elevationBoundsMax=0,this.layerInfo=[[],[]],this.extentInRadians=(0,L.Ue)(),this.centerAtSeaLevel=(0,R.Ue)(),this._center=[(0,R.Ue)(),(0,bn.c)(),(0,R.Ue)()],this.up=(0,R.tN)(),this._isWithinClippingArea=!0,this._intersectsClippingArea=!0,this._maxTesselation=0,this._usedMemory=null,this._mapTileMemoryInternal=0,this._mapDataRefCount=0,this.screenDepth=0,this.renderOrder=0,this._edgeLen=0,this._edgeLen2=0,this._curvatureHeight=0,this.extentMidX=0,this.extentMidY=0,this.distanceToPOI=-1,this._lastPOI=(0,R.Ue)(),this.maxLevelDeltaNeighborCount=0,this.unmergableChildCount=0}get lij(){return this._lij}get elevationLevelDelta(){return this._surface.getElevationLevelDelta(this.level)}static prune(){Xp.prune(0),Qp.prune(0),zp.prune()}get _isCached(){return!this.isLeaf&&this._mapDataRefCount<=0}get maxTesselation(){return this._maxTesselation}get isWithinClippingArea(){return this._isWithinClippingArea}get intersectsClippingArea(){return this._intersectsClippingArea}get clippingArea(){return this._clippingArea}get parent(){return this._parent}get children(){return this._children}get surface(){return this._surface}get elevationBoundsMin(){return this._elevationBoundsMin}get elevationBoundsMax(){return this._elevationBoundsMax}get level(){return this._lij[0]}get key(){return"".concat(this._lij[0],"/").concat(this._lij[1],"/").concat(this._lij[2])}get edgeLen(){return this._edgeLen}get radius(){return this._center[Jp.MIDDLE][3]}get visible(){return this._dirty&&this.computeVisibility(),this._visible}get frustumVisibility(){return this._dirty&&this.computeVisibility(),this._frustumVisibility}computeVisibility(){var e;this._dirty=!1;const t=this.parent,i=null!==(e=null===t||void 0===t?void 0:t.frustumVisibility)&&void 0!==e?e:qp.INTERSECTS;this._frustumVisibility=i===qp.INSIDE?qp.INSIDE:i===qp.OUTSIDE?qp.OUTSIDE:this._calculateFrustumVisibilityStatus(this.surface.frustum);const n=this._frustumVisibility!==qp.OUTSIDE&&this._intersectsClippingArea;n!==this._visible&&(this._visible=n,this._surface.emit("tiles-visibility-changed"),this._surface.renderer.setDirty(),this.updateAgentSuspension())}get loadable(){return this.visible||this._surface.view.state.fixedContentCamera}get rendered(){const e=!!this.renderData;return e!==this._previouslyRendered&&(this._surface.emit("tiles-visibility-changed"),this._previouslyRendered=e,this._surface.renderer.setDirty()),e}init(e,t,i,n,r){this._lij[0]=e,this._lij[1]=t,this._lij[2]=i,this.ellipsoid=(0,Ze.Iu)(r.tilingScheme.spatialReference),r.tilingScheme.getExtent(e,t,i,this.extent),r.tilingScheme.convertExtentToRadians(this.extent,this.extentInRadians),this.extentMidX=.5*(this.extent[0]+this.extent[2]),this.extentMidY=.5*(this.extent[1]+this.extent[3]),this._isWithinClippingArea=!0,this._intersectsClippingArea=!0,this._clippingArea=null,this._mapDataRefCount=0,r.upsampleMapCache.pop(this.key),this._edgeLen=0,this._edgeLen2=0,this._center[Jp.MIDDLE][3]=0,this.elevationLevel=e,n&&!Number.isNaN(n.elevationBoundsMin)?(this._elevationBoundsMin=n.elevationBoundsMin,this._elevationBoundsMax=n.elevationBoundsMax):(this._elevationBoundsMin=0,this._elevationBoundsMax=0),this._pendingUpdates=0,this.renderData=null,this.screenDepth=0,this._visible=!1,this._previouslyRendered=!1,this._parent=n,this.unsetChildren(),this._surface=r,this.updateVisibility(),this.maxLevelDeltaNeighborCount=0,this.unmergableChildCount=0;for(const s of vd){const e=r.numLayers(s),t=this.layerInfo[s];for(const i of t)i.release();t.length=e;for(let i=0;i<e;i++)t[i]=zp.acquire(this._surface.upsampleInfoPool),s===pd.ELEVATION&&this.findElevationBoundsForLayer(i,-1)}this.computeElevationBounds(),this._maxTesselation=Math.min(r.tilingScheme.pixelSize,W.Cf)}dispose(){(0,np.wu)(!this.renderData,"tile.renderData was not unloaded"),this._surface.upsampleMapCache.pop(this.key);for(const e of vd){for(const t of this.layerInfo[e])t.release();this.layerInfo[e].length=0}this._parent=null;for(let e=0;e<4;++e)this._children[e]=null;this._surface=null,this.setMemoryDirty()}refMapData(){++this._mapDataRefCount,this._isCached||this._surface.upsampleMapCache.pop(this.key)}unrefMapData(){if(--this._mapDataRefCount,this._isCached){this.setMemoryDirty();const e=this._cachedMemory;e>0&&this._surface.upsampleMapCache.put(this.key,this,e)}}setMemoryDirty(){this._usedMemory=null}get usedMemory(){return this._ensureUsedMemory()+(this._isCached?0:this._mapTileMemoryInternal)}get _cachedMemory(){return this._isCached?this._mapTileMemory:0}get _mapTileMemory(){return this._ensureUsedMemory(),this.layerInfo[pd.MAP].reduce(((e,t)=>{let{data:i}=t;return e+((0,qd.AK)(i)?i.usedMemory/i.referenced:0)}),this._mapTileMemoryInternal)}get _cpuImageMemorySize(){const e=this._surface.tilingScheme.pixelSize;return e*e*4}_ensureUsedMemory(){var e,t;if(null!=this._usedMemory)return this._usedMemory;this._usedMemory=this._baseUsedMemory,this._mapTileMemoryInternal=0;let i=0;for(const{data:r}of this.layerInfo[pd.MAP])(0,qd.AK)(r)?i+=this._getTerrainDataMemory(r):this._mapTileMemoryInternal+=this._getTerrainDataMemory(r);const n=this._cpuImageMemorySize;for(const r of this.layerInfo[pd.ELEVATION])this._usedMemory+=r.data?n:0;return this.renderData&&(this._usedMemory+=this.renderData.estimatedGeometryMemoryUsage,this._mapTileMemoryInternal+=null!==(e=null===(t=this.renderData.texture)||void 0===t?void 0:t.usedMemory)&&void 0!==e?e:0),this._isCached&&this._surface.upsampleMapCache.updateSize(this.key,this,this._mapTileMemoryInternal+i),this._usedMemory}getUsedMemoryForLayer(e,t){const i=this.layerInfo[e][t];return null!==i&&void 0!==i&&i.data?e===pd.MAP?this._isCached?0:this._getTerrainDataMemory(i.data):e===pd.ELEVATION?this._cpuImageMemorySize:0:0}_getTerrainDataMemory(e){return(0,qd.Q_)(e)?e.texture.usedMemory:(0,qd.yd)(e)?e.memoryUsage:(0,qd.AK)(e)?e.usedMemory/e.referenced:(0,qd.Cm)(e)||e instanceof HTMLImageElement?this._cpuImageMemorySize:0}updateScreenDepth(e){const t=this._center[Jp.MIDDLE],i=e,n=t[0],r=t[1],s=t[2],a=i[2]*n+i[6]*r+i[10]*s+i[14];this.screenDepth=a<0?0:a/(i[3]*n+i[7]*r+i[11]*s+i[15])}shouldSplit(e,t,i){if(!this.visible)return kp.NONE;if(e.frustum&&(!this._intersectsClippingArea||this._calculateFrustumVisibilityStatus(e.frustum)===qp.OUTSIDE))return kp.NONE;const n=this.level;(0,Ge.f)(n_,(0,bn.g)(this._center[Jp.MIDDLE]),t);let r=(0,Ge.q)(n_),s=n_,a=(0,bn.g)(this._center[Jp.MIDDLE]);(0,Ge.f)(r_,this._center[Jp.TOP],t);const o=(0,Ge.q)(r_);o<r&&(r=o,s=r_,a=this._center[Jp.TOP]),(0,Ge.f)(s_,this._center[Jp.BOTTOM],t);const l=(0,Ge.q)(s_);if(l<r&&(r=l,s=s_,a=this._center[Jp.BOTTOM]),this._edgeLen2>r&&n<e.maxLod)return kp.SPLIT;const h=Math.sqrt(r),c=e.fovX*h*2,d=this._edgeLen/c,u=()=>{if(n<e.maxLod)return this.elevationLevel=n,kp.NONE;const t=n+Math.ceil(-Math.log2(e.relativeWidthLimit/d));return t!==this.elevationLevel?(this.elevationLevel=t,kp.ELEVATION):kp.NONE},p=null!=i?i-n:1/0;if(p<=.5)return u();const _=(0,Ge.m)(this.up,n_),m=this._elevationBoundsMax-this._elevationBoundsMin,g=m/this.edgeLen;if(e.aboveGround&&_>0&&g<.001&&_/h-Math.sin(this._curvatureHeight/(this.edgeLen*Math.SQRT1_2)*Math.PI)-g>0)return kp.NONE;const f=null!=i?3-Math.min(p,2):1;if(d*f<e.relativeWidthLimit||n>=e.maxLod)return u();if(n<7)return kp.SPLIT;(0,Ge.j)(a_,this.up,_),(0,Ge.f)(a_,a_,s);const v=(0,Ge.q)(a_);if(v<=this.radius*this.radius)return kp.SPLIT;(0,Ge.j)(a_,a_,this.radius/Math.sqrt(v)),(0,Ge.g)(a_,a_,a),(0,Ge.f)(a_,t,a_);const y=Math.min(1,(Math.abs((0,Ge.m)(a_,this.up))+.5*m+this._curvatureHeight)/(0,Ge.l)(a_)),b=.1/e.angledSplitBias,w=e.fovY*h*2;return y*(this._edgeLen/w*f)<b*e.relativeHeightLimit?kp.NONE:kp.SPLIT}setChildren(e,t,i,n){(0,np.wu)(!!(e&&t&&i&&n),"Null child passed");const r=this._children;return r[0]=e,r[1]=t,r[2]=i,r[3]=n,r}unsetChildren(){this._children[0]=null,this._children[1]=null,this._children[2]=null,this._children[3]=null}get isLoaded(){var e,t;return null!==(e=null===(t=this.renderData)||void 0===t?void 0:t.hasGeometry)&&void 0!==e&&e}load(){this.refMapData();for(const e of vd)this._createOrUpdateAgents(0,e);this.surface.renderer.loadTile(this)}unload(e){e.unloadTile(this);for(const t of vd){const e=this.layerInfo[t];for(const t of e)t.loadingAgent&&t.loadingAgent!==Vp&&(Wp(t.loadingAgent),t.loadingAgent=null),t.pendingUpdates=0}this.resetPendingUpdate(kp.GEOMETRY),this.resetPendingUpdate(kp.TEXTURE_NOFADING),this.resetPendingUpdate(kp.TEXTURE_FADING),this.unrefMapData()}unloadMapData(){const e=this.layerInfo[pd.MAP];for(const t of e)t.loadingAgent&&t.loadingAgent!==Vp&&(Wp(t.loadingAgent),t.loadingAgent=null),t.pendingUpdates=0;this.renderData&&this.renderData.releaseTexture(),this.setMemoryDirty()}updateClippingStatus(e){if((0,L.fS)(e,this._clippingArea))return!1;const t=this._intersectsClippingArea,i=this._isWithinClippingArea;null!=e?(this._intersectsClippingArea=this.intersectsExtent(e),this._isWithinClippingArea=this._isWithinExtent(e)):(this._intersectsClippingArea=!0,this._isWithinClippingArea=!0),this._clippingArea=e,this.updateVisibility();const n=i&&this._isWithinClippingArea,r=!(i||t||this._isWithinClippingArea||this._intersectsClippingArea);return!this.renderData||n||r||this.setPendingUpdate(kp.GEOMETRY),!0}updateVisibility(){this._dirty=!0,this._surface.setTileTreeDirty()}getLayerInfo(e,t){return this.layerInfo[t][e]}hasLayerData(e,t){const i=this.layerInfo[t][e];return!(null===i||void 0===i||!i.data||i.dataInvalidated)}get updating(){if(this.hasPendingUpdates)return!0;for(const e of vd){const t=this.layerInfo[e];for(const e of t)if(e.loadingAgent&&e.loadingAgent!==Vp&&e.loadingAgent.updating)return!0}return!1}_isSuspended(e){return!!this.hasPendingUpdate(kp.SPLIT)||e!==pd.ELEVATION&&!this.loadable}get hasPendingUpdates(){return 0!==this._pendingUpdates}hasPendingUpdate(e){return(this._pendingUpdates&e)===e}setPendingUpdate(e){const t=this._pendingUpdates;return this._pendingUpdates|=e,e===kp.SPLIT||e===kp.MERGE?this._surface.setTileTreeDirty():this._surface.requestUpdate(),t!==this._pendingUpdates}resetPendingUpdate(e){return!!this.hasPendingUpdate(e)&&(this._pendingUpdates&=~e,!0)}requestLayerData(e,t,i){const n=this.layerInfo[t][e];if(n.waitingAgents.has(i))return console.warn("agent already requested this piece of map data (tile %s, agent tile %s, layer: %d/%d)",this._lij.toString(),i.tile.lij.toString(),t,e),!0;if(n.waitingAgents.push(i),n.data&&!n.dataInvalidated){console.warn("agent requested existing data (tile %s, agent tile %s, layer: %d/%d)",this._lij.toString(),i.tile.lij.toString(),t,e);const r=(0,qd.AK)(n.data);return i.dataArrived(this,r),!0}if(n.requestPromise)return!0;(0,p.IM)(n.requestAbort),n.requestAbort=new AbortController;const r=this._surface.requestTileData(this,e,t,n.requestAbort);if(!r)return n.requestAbort=null,!1;const s=()=>{n.requestPromise===r&&(n.requestPromise=null,n.requestAbort=null)};return n.requestPromise=r,r.then(s,s),!0}get isLeaf(){return null==this._children[0]}hasLij(e){return this._lij[0]===e[0]&&this._lij[1]===e[1]&&this._lij[2]===e[2]}findByLij(e){if(this.hasLij(e))return this;const t=this._children;return t[0]?t[0].findByLij(e)||t[1].findByLij(e)||t[2].findByLij(e)||t[3].findByLij(e):null}distanceToSquared(e){return(0,Ge.q)((0,Ge.f)(a_,(0,bn.g)(this._center[Jp.MIDDLE]),e))}containsPoint(e){const t=this.extent;return e[0]>=t[0]&&e[1]>=t[1]&&e[0]<=t[2]&&e[1]<=t[3]}containsPointXY(e,t){const i=this.extent;return e>=i[0]&&t>=i[1]&&e<=i[2]&&t<=i[3]}unrequestLayerData(e,t,i){const n=this.layerInfo[t][e],r=n.waitingAgents,s=null!=r.removeUnordered(i);(0,np.wu)(s,"agent has not requested this piece of map data"),r.length<1&&(n.abortRequest(),this.setMemoryDirty())}dataArrived(e,t,i){const n=(0,qd.AK)(i),r=this.layerInfo[t][e];r.data=i,r.dataInvalidated=!1,r.waitingAgents.forAll((e=>e.dataArrived(this,n))),r.waitingAgents.clear(),this.setMemoryDirty()}dataMissing(e,t){const i=this.layerInfo[t][e];i.dataMissing=!0,i.waitingAgents.forAll((e=>e.dataMissing())),i.waitingAgents.clear(),this.setMemoryDirty()}updateRenderData(e,t,i){switch(i&&this.forEachLoadedNeighbor((i=>i.updateRenderData(e,t))),e){case pd.MAP:return this._updateTexture(t);case pd.ELEVATION:return this._updateGeometry()}}_updateTexture(e){this.renderData&&(this.resetPendingUpdate(e===lp.Ns.FADING?kp.TEXTURE_NOFADING:kp.TEXTURE_FADING),this.setPendingUpdate(e===lp.Ns.FADING?kp.TEXTURE_FADING:kp.TEXTURE_NOFADING))}_updateGeometry(){this.setPendingUpdate(kp.GEOMETRY);for(const e of this.layerInfo[pd.ELEVATION])e.pendingUpdates|=kp.GEOMETRY}invalidateLayerData(e,t){this.layerInfo[t][e].invalidateSourceData(),this.restartAgents(t)}computeElevationBounds(){const e=this._elevationBoundsMin,t=this._elevationBoundsMax;let i=1/0,n=-1/0;const r=this.layerInfo[pd.ELEVATION];let s=!0;for(const a of r)null!=a.elevationBounds&&(i=Math.min(i,a.elevationBounds.min),n=Math.max(n,a.elevationBounds.max),a.elevationBounds.hasNoDataValues||(s=!1));s&&(i=Math.min(i,0),n=Math.max(n,0)),e===i&&t===n||(this._elevationBoundsMin=i,this._elevationBoundsMax=n,this.updateRadiusAndCenter(),this._surface.setTileTreeDirty())}_updateCenter(){const e=this._elevationBoundsMin,t=this._elevationBoundsMax,i=.5*(e+t),n=this._center;(0,Ge.j)(a_,this.up,i),(0,Ge.g)((0,bn.g)(n[Jp.MIDDLE]),this.centerAtSeaLevel,a_),(0,Ge.j)(a_,this.up,e),(0,Ge.g)(n[Jp.TOP],this.centerAtSeaLevel,a_),(0,Ge.j)(a_,this.up,t),(0,Ge.g)(n[Jp.BOTTOM],this.centerAtSeaLevel,a_)}findElevationBoundsForLayer(e,t){const i=this.layerInfo[pd.ELEVATION][e],n=this.elevationLevelDelta,r=Math.max(this.elevationLevel-n,0),s=i.elevationBounds;if(null!=s&&s.level>=t&&s.level<=r)return;const a=this._surface.layerViewByIndex(e,pd.ELEVATION),o=(0,np.RB)(a);if(!(0,Up.yf)(this,o,!1))return;const l=Yp;let h=!1;const c=i.data;if(c&&c.level<=r){const e=i.data;l.min=e.samplerData.data.minValue,l.max=e.samplerData.data.maxValue,l.hasNoDataValues=e.samplerData.data.hasNoDataValues,l.level=this.level,h=!0}else{let t,i,s=0;for(let a=this._parent;a&&(!i||s<n)&&(s=this.elevationLevel-a.level,t=i||t,i=a.layerInfo[pd.ELEVATION][e].data,!(!i&&t&&a.level<=r));a=a.parent);i=i||t,i&&(i.computeMinMaxValue(this._lij[0],this._lij[1],this._lij[2],l),l.min!==1/0&&(l.level=i.level,h=!0))}h&&(null==i.elevationBounds&&(i.elevationBounds=new Ku),i.elevationBounds.copyFrom(l))}modifyLayers(e,t,i){const n=this.layerInfo[i];for(const a of n)a.loadingAgent&&a.loadingAgent!==Vp&&(Wp(a.loadingAgent),a.loadingAgent=null),a.waitingAgents.clear();for(let a=0;a<n.length;++a)void 0===e[a]&&n[a].release();const r=new Array(...n),s=t.length;n.length=s;for(let a=0;a<s;a++){const e=t[a];n[a]=e>-1?r[e]:zp.acquire(this._surface.upsampleInfoPool)}this.setMemoryDirty()}restartAgents(e){this.renderData&&(this._createOrUpdateAgents(0,e),this.updateRenderData(e,lp.Ns.FADING))}updateAgents(e){if(this.renderData){const t=this.layerInfo[e];for(const e of t)e.loadingAgent===Vp&&(e.loadingAgent=null);this._createOrUpdateAgents(0,e)}}updateAgentSuspension(){for(const e of vd){const t=this._isSuspended(e);for(const i of this.layerInfo[e])i.loadingAgent&&i.loadingAgent!==Vp&&(i.loadingAgent.setSuspension(t),i.loadingAgent===Vp&&this.updateRenderData(e,lp.Ns.FADING))}}removeLayerAgent(e,t){const i=this.layerInfo[t][e];i.loadingAgent&&i.loadingAgent!==Vp&&i.loadingAgent.dispose(),i.loadingAgent=null}agentDone(e,t){const i=this.layerInfo[t][e];i.loadingAgent=Vp,i.data||null!=i.upsampleInfo||this._createOrUpdateAgents(e+1,t)}_hasBlendableAncestor(e){return"normal"!==e.blendMode||(0,F.CY)(e.parent)&&this._hasBlendableAncestor(e.parent)}_hasBlendModes(e,t,i){for(let a=e;a<t;++a){var n,r,s;const e=this._surface.layerViewByIndex(a,i);if((0,np.TK)(e)&&"normal"!==(null===e||void 0===e||null===(n=e.layer)||void 0===n?void 0:n.blendMode)||(0,F.CY)(null===e||void 0===e||null===(r=e.layer)||void 0===r?void 0:r.parent)&&this._hasBlendableAncestor(null===e||void 0===e||null===(s=e.layer)||void 0===s?void 0:s.parent))return!0}return!1}_createOrUpdateAgents(e,t){const i=this.layerInfo[t];if(0===i.length)return;const n=this._isSuspended(t);for(let r=e;r<i.length;++r){const s=i[r];let a=!1;const o=this._surface.layerViewByIndex(r,t),l=(0,np.RB)(o);if(s.loadingAgent?(0,Up.yf)(this,l,!1)?(s.loadingAgent!==Vp&&s.loadingAgent.setSuspension(n),s.loadingAgent!==Vp&&(a=s.loadingAgent.update())):s.dispose():(0,Up.yf)(this,l,!1)&&(s.loadingAgent=jp(this,r,t,n),a=s.loadingAgent.startLoading(),a?s.loadingAgent===Vp&&this.setPendingUpdate(kp.GEOMETRY):(Wp(s.loadingAgent),s.loadingAgent=Vp)),s.loadingAgent===Vp&&this.updateRenderData(t,lp.Ns.FADING),!this._hasBlendModes(e,i.length,t)&&a&&o.isOpaque)return}}_isWithinExtent(e){const t=this.extent;return t[0]>=e[0]&&e[2]>=t[2]&&t[1]>=e[1]&&e[3]>=t[3]}intersectsExtent(e){const t=this.extent;return t[2]>=e[0]&&e[2]>=t[0]&&t[3]>=e[1]&&e[3]>=t[1]}getElevationVerticesPerSide(e){const t=this.elevationLevel-this.level,i=Math.max(this.level-e,this.elevationLevelDelta-t),n=(0,me.uZ)(1+(this.maxTesselation>>i),2,this.maxTesselation+1),r=this.getDefaultVerticesPerSide();return Math.max(n,r)}_findLIJ(e,t){if(!e)return null;const i=this.surface.rootTiles;if(null!=i)for(const n of i)if(Kp(n,e)){let i=n,r=e[0]-i.level-1;for(;r>=0&&!i.isLeaf&&!t(i);){const t=e[1]>>r&1,n=e[2]>>r&1;i=i.children[2*t+n],r--}return t(i)?i:null}return null}findNeighborTile(e,t){const i=this._lij,n=this.getNeighborLIJ(i,e);return n?$p(i,n)?t(this)?this:null:this._findLIJ(n,t):null}findCorner(e,t){const i=e===Mp.X.NORTH_EAST?1:e===Mp.X.NORTH_WEST?0:e===Mp.X.SOUTH_WEST?2:3;let n=this;for(;n.children[0]&&(!t||!t(n));)n=n.children[i];return n}findNeighborCornerTileExact(e,t){var i;return(null===(i=this.findNeighborTile(e,(e=>t(e)||e.level===this.level)))||void 0===i?void 0:i.findCorner((0,np.$v)(e),t))||null}forAllSubtreeOnSide(e,t){const i=e===Mp.X.NORTH?[0,1]:e===Mp.X.NORTH_EAST?[1]:e===Mp.X.EAST?[1,3]:e===Mp.X.SOUTH_EAST?[3]:e===Mp.X.SOUTH?[2,3]:e===Mp.X.SOUTH_WEST?[2]:e===Mp.X.WEST?[0,2]:[0],n=e=>{const r=e.children;!t(e)&&r[0]&&i.forEach((e=>n(r[e])))};n(this)}getNeighborEdgeStartVertexIndex(e,t){if(!t)return 0;const i=this.level-t.level;if((0,np.Fp)(!np.T9||i>=0),0===i)return 0;const n=2**i,r=!(1&~e),s=r?0:1,a=t.lij[s+1]*n,o=this._lij[s+1],l=o-a,h=r?n-1-l:l;return np.T9&&((0,np.Fp)(a<=o&&o<a+n),(0,np.Fp)(0<=h&&h<n)),h}forEachLoadedNeighbor(e){const t=this.level,i=e=>e.level===t||e.isLoaded;np.OC.forEach((t=>{const n=this.findNeighborTile(t,i);null!=n&&n!==this&&n.forAllSubtreeOnSide((0,np._F)(t),(i=>!!i.isLoaded&&(e(i,t),!0)))})),np.cA.forEach((t=>{var n;const r=null===(n=this.findNeighborTile(t,i))||void 0===n?void 0:n.findCorner((0,np.$v)(t),(e=>e.isLoaded));(0,np.Fp)(!r||e_(this,r,t)),(null===r||void 0===r?void 0:r.isLoaded)&&e(r,t)}))}getNeighborLIJ(e,t){const i=(0,np.Mw)(t)?-1:(0,np.uv)(t)?1:0,n=(0,np.OD)(t)?-1:(0,np.Eu)(t)?1:0,r=[e[0],e[1]+i,e[2]+n];return r[1]<0?null:this.surface.isGlobal?this.wrapLIJ(r):r[2]<0?null:r}wrapLIJ(e){return!e||e[1]<0||e[1]>=2**e[0]?null:this.surface.wrapEastWest(e)}get westNeighborWestExtent(){return this.extent[0]*(this.isWestEnd?-1:1)}get eastNeighborEastExtent(){return this.extent[2]*(this.isEastEnd?-1:1)}get isEastEnd(){return this._lij[2]===this.surface.lijEastEnd(this.level)-1}get isWestEnd(){return 0===this._lij[2]}get isNorthEnd(){return 0===this._lij[1]}get isSouthEnd(){var e;const t=this.surface.extent,i=null!==(e=null===t||void 0===t?void 0:t[1])&&void 0!==e?e:null;return null!=i&&this.extent[1]+(0,Np.bn)()>=i}checkGeometryWaterproofness(){var e;np.V0&&((0,np.Fp)(this.isLoaded),null===(e=this.renderData)||void 0===e||e.checkGeometryWaterproofness())}shouldHaveNeighbor(e){const t=this.extent,i=this.surface.rootTilesExtent,n=.25*(t[2]-t[0]);if((0,np.Mw)(e)&&t[3]+n>=i[3])return!1;if((0,np.uv)(e)&&t[1]-n<=i[1])return!1;const r=this.surface.isGlobal;return!(!r&&(0,np.OD)(e)&&t[0]-n<=i[0])&&!(!r&&(0,np.Eu)(e)&&t[2]+n>=i[2])}updateDistanceToPOI(e){const t=this._lastPOI;if(this.distanceToPOI>=0&&t[0]===e[0]&&t[1]===e[1]&&t[2]===e[2])return;(0,Ge.c)(this._lastPOI,e);const i=this._center[Jp.MIDDLE],n=e[0]-i[0],r=e[1]-i[1],s=e[2]-i[2];this.distanceToPOI=n*n+r*r+s*s}get test(){return{cachedMemory:this._cachedMemory}}}function jp(e,t,i,n){const r=i===pd.ELEVATION?Qp.acquire():Xp.acquire();return r.init(e,t,i,n),r}function Wp(e){e.dispose(),function(e){return"elevation"===e.type}(e)?Qp.release(e):function(e){return"map"===e.type}(e)&&Xp.release(e)}const Xp=new rh.Z(class extends Hp{constructor(){super(),this.type="map",this._scaleRangeEnabled=!0}get _desiredMinLevelDelta(){return 0}get _progressiveLevelModulo(){return W.GZ}}),Qp=new rh.Z(class extends Hp{constructor(){super(...arguments),this.type="elevation",this._scaleRangeEnabled=!1}get _desiredMinLevelDelta(){return this.tile.elevationLevelDelta-(this.tile.elevationLevel-this.tile.level)}get _progressiveLevelModulo(){return 0}}),Yp=new Ku;var Jp;function Kp(e,t){const i=e.lij,n=t[0]-i[0];return!(n<0)&&t[1]>>n===i[1]&&t[2]>>n===i[2]}function $p(e,t){return e[0]===t[0]&&e[1]===t[1]&&e[2]===t[2]}function e_(e,t,i){return null!=e&&null!=t&&t!==e&&(e.level>=t.level?t_(e,t,i):t_(t,e,(0,np.$v)(i)))}function t_(e,t,i){(0,np.Fp)(e.level>=t.level);const n=(0,np._0)(i),r=(0,np.wt)(i),s=e.extent,a=t.extent,o=[n?s[0]:s[2],r?s[3]:s[1]],l=[n?a[2]:a[0],r?a[1]:a[3]],h=1e-5*(s[2]-s[0]),c=(0,np.Wq)(o[0],l[0],h)||e.surface.isGlobal&&(0,np.Wq)(o[0],-l[0],h),d=(0,np.Wq)(o[1],l[1],h);if(c&&d)return!0;if(e.level===t.level)return(0,np.Fp)(!1),!1;if(!c&&!d)return(0,np.Fp)(!1),!1;const u=c?i_(a[1],a[3],s[1],s[3],h):i_(a[0],a[2],s[0],s[2],h);return(0,np.Fp)(u),u}function i_(e,t,i,n,r){return e-r<=i&&i<=n&&n<=t+r}!function(e){e[e.TOP=0]="TOP",e[e.MIDDLE=1]="MIDDLE",e[e.BOTTOM=2]="BOTTOM"}(Jp||(Jp={}));const n_=(0,R.Ue)(),r_=(0,R.Ue)(),s_=(0,R.Ue)(),a_=(0,R.Ue)();class o_{constructor(){this._scales=(0,Ye.al)(-1,-1,-1,-1),this._offsets=(0,Ye.al)(-1,-1,-1,-1)}clear(){this._scales[0]=this._scales[1]=this._scales[2]=this._scales[3]=-1,this._offsets[0]=this._offsets[1]=this._offsets[2]=this._offsets[3]=-1}setScale(e,t,i){this._scales[2*e]=t,this._scales[2*e+1]=i}setOffset(e,t,i){this._offsets[2*e]=t,this._offsets[2*e+1]=i}get scales(){return this._scales}get offsets(){return this._offsets}}var l_=i(37081),h_=i(89438),c_=i(50411);class d_ extends it.A{constructor(){super(...arguments),this.useStencil=!1}initializeConfiguration(e,t){t.spherical=e.viewingMode===te.JY.Global}initializeProgram(e){return new rt.$(e.rctx,d_.shader.get().build(this.configuration),u_)}initializePipeline(){return this._stencilPipelineState=this._createPipeline(!0),this._createPipeline(!1)}_createPipeline(e){const t=this.configuration,i=t.backfaceCullingEnabled&&!t.renderOccluded;return(0,at.sm)({blending:t.renderOccluded?(0,at.if)(st.zi.ONE,st.zi.ONE_MINUS_SRC_ALPHA):null,culling:i?at.Rd:null,depthTest:t.renderOccluded?null:{func:st.wb.LESS},depthWrite:t.renderOccluded?null:at.LZ,colorWrite:at.BK,stencilTest:e?(0,c_.iV)(dp.hU.IntegratedMeshMaskExcluded):null,drawBuffers:t.output===l_.H_.Depth?{buffers:[st.Xg.NONE]}:null})}getPipeline(){return this.useStencil?this._stencilPipelineState:super.getPipeline()}}d_.shader=new tt.J(h_.a,(()=>i.e(28268).then(i.bind(i,28268))));const u_=new Map([[hi.T.POSITION,0],[hi.T.UV0,1],[hi.T.NORMALCOMPRESSED,2]]);class p_{constructor(){this.geometry=new Ap,this.intersectionData=null,this.geometryState=null,this._vao=null,this._texture=null,this._textureRef=new Ip((()=>this.tile.surface.fadeDuration)),this.overlay=new o_,this._localOrigin=null,this._geometryStateChangedSinceLastUpdate=!0,this._hasGeometry=!1,this._modifiedFlags=0}get tile(){return this._tile}get localOrigin(){return this._localOrigin}init(e,t){this.clear(),this._tile=e,this.geometry.reset(),this.intersectionData=null,this.geometryState=new Dp,this._localOrigin=t,this.overlay.clear()}clear(){this.releaseGeometry(),this.releaseTexture(),this._textureRef.clear(),this._tile=null,this.intersectionData=null,this.geometryState=null}updateGeometryIfNeeded(e){if((!this._vao||this._geometryStateChangedSinceLastUpdate||this.wireframeChanged||this.clippingAreaChanged||this.samplerDataChanged||this.numVerticesPerSideChanged||this.dirtyCorners||this.dirtyEdgeResolutions||this.dirtyEdges)&&(this._updateGeometry(e),this._geometryStateChangedSinceLastUpdate=!1),np.T9&&this.tile.intersectsClippingArea)for(let t=0;t<4;++t)(0,np.Fp)(this.geometry.getEdgeCount(t)===this.geometryState.edgeResolutions[t]+1)}_calculateEdgeResolution(e,t){var i;const n=this.tile,r=this.geometryState.numVerticesPerSide-1;if(!n.surface.isGlobal){const t=n.surface.extent;if(null!=t&&(0===e&&n.extent[3]>t[3]||1===e&&n.extent[2]>t[2]||2===e&&n.extent[1]<t[1]||3===e&&n.extent[0]<t[0]))return r}const s=n.level,a=np.OC[e];if(!t)return(0,np.Fp)(null==(null===(i=n.surface)||void 0===i?void 0:i.rootTiles)||n.surface.updatingRootTiles||!n.shouldHaveNeighbor(a)),r;if(t.isLoaded){const i=t,n=i.renderData.geometryState,a=s-i.level;if((0,np.Fp)(a>=0),0===a){const e=n.numVerticesPerSide-1;return Math.max(e,r)}const o=2**a,l=n.edgeResolutions[(e+2)%4]/o;return Math.max(1,l)}(0,np.Fp)(!t.isLeaf);let o=r;return t.forAllSubtreeOnSide((0,np._F)(a),(e=>e===n||(e.isLoaded?(o=Math.max(o,2**(e.level-s)),!0):((0,np.Fp)(!e.isLeaf),!1)))),o}updateNeighborData(){const e=this.tile;if(!e.intersectsClippingArea)return;const t=e.renderData.geometryState,i=t=>(t.isLoaded||t.level===e.level)&&(null===t||void 0===t?void 0:t.intersectsClippingArea),n=t.edgePeerNeighbors,r=t.edgePeerNeighborSamplerVersions;for(let l=0;l<4;++l){var s,a;const o=e.findNeighborTile(np.OC[l],i),h=C_(e,o),c=null!==(s=null===h||void 0===h||null===(a=h.renderData)||void 0===a?void 0:a.geometryState.samplerDataVersion)&&void 0!==s?s:-1,d=n[l],u=h!==C_(e,d),p=r[l]!==c;np.T9&&o&&((0,np.Fp)(e.level>=o.level),(0,np.Fp)(e.level-o.level<=W.qC)),n[l]=o,(u||p)&&(r[l]=c,this._markEdgeDirty(l));const _=t.edgeResolutions[l],m=this._calculateEdgeResolution(l,o);(0,np.Fp)((0,me.wt)(m)),(0,np.Fp)(m>=1),t.edgeResolutions[l]=m,_!==m&&this._markEdgeResolutionDirty(l)}for(let l=0;l<4;++l){const r=e.findNeighborTile(np.cA[l],i);t.cornerPeerNeighbors[l]=r;const s=C_(e,n[l]),a=C_(e,n[(l+1)%4]),h=C_(e,r);w_[l]=h,w_[(l+1)%4]=a,w_[(l+2)%4]=e,w_[(l+3)%4]=s,(0,np.Fp)(w_.some((t=>(null===t||void 0===t?void 0:t.isLoaded)||t===e)));const c=w_.reduce(((e,t)=>{var i;return Math.min(e,null!==(i=null===t||void 0===t?void 0:t.level)&&void 0!==i?i:1/0)}),1/0);w_.forEach(((e,t)=>{e&&(null===e||void 0===e?void 0:e.level)>c&&(w_[t]=null)})),(0,np.Fp)(w_.some((t=>(null===t||void 0===t?void 0:t.isLoaded)||t===e)));const d=t.cornerNeighborCornerTiles,u=t.cornerNeighborCornerTileSamplerVersions;for(let e=0;e<4;++e){var o;const t=w_[e],i=null!==(o=null===t||void 0===t?void 0:t.renderData.geometryState.samplerDataVersion)&&void 0!==o?o:-1,n=4*l+e,r=d[n]!==t,s=!r&&u[n]!==i;(r||s)&&(d[n]=t,u[n]=i,this._markCornerDirty(l))}np.T9&&(0,np.Fp)(O_.some((t=>{var i;return(null===(i=d[4*l+t])||void 0===i?void 0:i.isLoaded)||d[4*l+t]===e})))}np.T9&&(0,np.Fp)(this.geometryState.edgeResolutions.every((e=>e>0)));for(let l=0;l<4;++l)w_[l]=null}_updateGeometry(e){var t;if(!this.tile.intersectsClippingArea)return;np.T9&&(0,np.Fp)(!this.tile.intersectsClippingArea||this.geometryState.edgeResolutions.every((e=>e>0))),this.intersectionData=null;const{tile:i,_vao:n,geometry:r,geometryState:s}=this,a=!n||this.wireframeChanged||this.samplerDataChanged||this.clippingAreaChanged||this.numVerticesPerSideChanged,o=0!==this.dirtyEdgeResolutions,l=s.edgeResolutions.reduce(((e,t)=>e+t+1),0),h=a||o&&l>(null!==(t=null===r||void 0===r?void 0:r.maxEdgeVertexCount)&&void 0!==t?t:0),c=!h&&o,d=!c&&(0!==this.dirtyEdges||o),u=!d&&0!==this.dirtyCorners;h?(this.releaseGeometry(),this._createGeometry(e)):c?i.updateEdgeElevationsAndResolutions():d||u?i.updateEdgeElevations():u?i.updateCornerElevations():console.warn("Update for no reason?"),this._modifiedFlags=0}get hasGeometry(){return this._hasGeometry}releaseGeometry(){return this._hasGeometry=!1,this.intersectionData=null,!!this._vao&&(this._vao=(0,p.M2)(this._vao),this.geometry.release(),!0)}ensureTexture(e,t,i){const n=t?st.VI.RGBA:st.VI.RGB;return null==this._texture||this._texture.descriptor.width===e&&this._texture.descriptor.pixelFormat===n||this.releaseTexture(),null==this._texture&&(this._texture=i(),this.tile.setMemoryDirty()),this._texture}releaseTexture(){null!=this._texture&&(this._texture.release(),this._texture=null,this.tile.setMemoryDirty())}get numVerticesPerSideChanged(){return!!(this._modifiedFlags&x_)}get samplerDataChanged(){return!!(this._modifiedFlags&T_)}get clippingAreaChanged(){return!!(this._modifiedFlags&S_)}get wireframeChanged(){return!!(this._modifiedFlags&P_)}get dirtyEdges(){return this._modifiedFlags>>M_&15}get dirtyCorners(){return this._modifiedFlags>>R_&15}get dirtyEdgeResolutions(){return this._modifiedFlags>>A_&15}_markCornerDirty(e){const t=1<<e<<R_;this._modifiedFlags|=t}_markEdgeDirty(e){const t=1<<e<<M_;this._modifiedFlags|=t,this._markCornerDirty((e+0)%4),this._markCornerDirty((e+3)%4)}_markEdgeResolutionDirty(e){const t=1<<e<<A_;this._modifiedFlags|=t,this._markEdgeDirty(e)}_markAllEdgesAndCornersDirty(){this._modifiedFlags|=15<<R_|15<<M_|15<<A_}updateGeometryState(){const e=this._getElevationInfo(),t=this.tile,i=e.samplerData?t.getElevationVerticesPerSide(e.maxTileLevel):t.getDefaultVerticesPerSide(),n=Math.max(i,5);let r=t.clippingArea;t.intersectsClippingArea&&!t.isWithinClippingArea||(r=null);const s=this.geometryState;let a=!1;s.numVerticesPerSide!==n&&(this._modifiedFlags|=1,s.numVerticesPerSide=n,s.samplerDataVersion++,a=!0),e.changed&&(this._modifiedFlags|=2,s.samplerData=e.samplerData,s.samplerDataVersion++,a=!0),(0,Ld.fS)(s.clippingArea,r)||(this._modifiedFlags=4,s.clippingArea=r,a=!0);const o=t.surface.wireframe;return s.wireframe!==o&&(this._modifiedFlags=8,s.wireframe=o,a=!0),this._geometryStateChangedSinceLastUpdate||(this._geometryStateChangedSinceLastUpdate=a),a&&this._markAllEdgesAndCornersDirty(),this._hasGeometry=!0,this._geometryStateChangedSinceLastUpdate}_createGeometry(e){this.tile.createGeometry();const t=this.geometry.vertexAttributes,i=this.geometry.indices,n=e.gl;this._vao=new li.U(e,u_,{geometry:(0,si.K)(t.layout)},{geometry:ci.f.createVertex(e,n.STATIC_DRAW,t.buffer)},ci.f.createIndex(e,n.STATIC_DRAW,i)),this._hasGeometry=!0}get vao(){return this._vao}setTextureReference(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:Lp.Immediate;null!=e&&e.texture!==this._texture&&this.releaseTexture(),this._textureRef.push(e,t)}get textureReference(){return this._textureRef.current}get nextTextureReference(){return this._textureRef.next}get textureFadeFactor(){return this._textureRef.fadeFactor}get textureIsFading(){return this._textureRef.isFading}_getElevationInfo(){const e=this.geometryState.samplerData,t=this.tile.layerInfo[pd.ELEVATION],i=t.length,n=new Array(i);let r=0,s=0,a=!1;for(let h=0;h<i;h++){const i=t[h];if(null!=i.upsampleInfo){const t=i.upsampleInfo.tile,o=t.layerInfo[pd.ELEVATION][h].data,l=o&&o.samplerData;e&&e[r]===l||(a=!0),n[r++]=l,s=Math.max(s,t.lij[0])}else if(i.data){const t=this.tile.surface.layerViewByIndex(h,pd.ELEVATION);if((0,Up.yf)(this.tile,t.layer,!1)){const t=i.data;e&&e[r]===t.samplerData||(a=!0),n[r++]=t.samplerData,s=this.tile.level}}}null!=e&&e.length!==r&&(a=!0);const o=r>0,l=o?n:null;return o&&(n.length=r),{changed:a,samplerData:l,maxTileLevel:s}}get estimatedGeometryMemoryUsage(){var e,t,i,n,r,s;const a=null!==(e=null===(t=this.intersectionData)||void 0===t?void 0:t.estimatedMemoryUsage)&&void 0!==e?e:0;return(null!==(i=null===(n=this.geometry.indices)||void 0===n?void 0:n.byteLength)&&void 0!==i?i:0)+(null!==(r=null===(s=this.geometry.vertexAttributes)||void 0===s?void 0:s.byteLength)&&void 0!==r?r:0)+a}get texture(){return this._texture}get test(){}checkGeometryWaterproofness(){if(!np.T9)return;const e=this.tile;if(!e.isLoaded||!e.intersectsClippingArea||0===e.level)return void(0,np.Fp)(null===e||void 0===e?void 0:e.isLoaded);const t=e.surface.extent;if(null!=t&&!e.intersectsExtent(t))return;const i=np.OC.map(((i,n)=>null!=t&&(n<2?-1:1)*(e.extent[3-n]-t[3-n])<0)),n=e.level;(0,np.Fp)(0===this.dirtyCorners),(0,np.Fp)(0===this.dirtyEdges),(0,np.Fp)(0===this.dirtyEdgeResolutions),(0,np.Fp)(!this.numVerticesPerSideChanged),(0,np.Fp)(!this.samplerDataChanged),(0,np.Fp)(!this.clippingAreaChanged),(0,np.Fp)(!this.wireframeChanged);const r=np.cA.map((t=>{var i;return null!==(i=e.findNeighborCornerTileExact(t,(t=>!t.intersectsClippingArea||t.isLoaded||t.level===e.level)))&&void 0!==i?i:null})).map((e=>null!==e&&void 0!==e&&e.intersectsClippingArea?e:null)),s=this.geometryState;for(let a=0;a<4;++a){const t=s.cornerPeerNeighbors[a],i=r[a];(0,np.Fp)(i===t,"Tile[".concat(e.lij,"].corner[").concat(a,"] out of date: cur=[").concat(null===t||void 0===t?void 0:t.lij,"] exp=[").concat(null===i||void 0===i?void 0:i.lij,"]"))}np.OC.forEach(((t,r)=>{if(i[r])return;const s=e.findNeighborTile(t,(e=>(e.level===n||(null===e||void 0===e?void 0:e.isLoaded))&&(null===e||void 0===e?void 0:e.intersectsClippingArea)));if(!s){const i=!e.surface.updatingRootTiles&&null!=e.surface.rootTiles&&e.surface.rootTiles.length>0&&e.shouldHaveNeighbor(t);return void(0,np.Fp)(!i)}(0,np.Fp)(s.isLoaded||s.level===e.level),(0,np.Fp)(s===this.geometryState.edgePeerNeighbors[r]);const a=n-s.level;if(!s.isLoaded)return(0,np.Fp)(!s.isLeaf),void(0,np.Fp)(0===a);const o=s.renderData;(0,np.Fp)(function(e,t,i){if(null==e||null==t)return!1;if(0===e.level&&0===t.level){if(e.isEastEnd&&t.isWestEnd&&i===Mp.X.EAST)return!0;if(e.isWestEnd&&t.isEastEnd&&i===Mp.X.WEST)return!0}const n=Math.max(1e-6*(e.extent[2]-e.extent[0]),1);switch(i){case Mp.X.NORTH:return(0,np.Wq)(e.extent[3],t.extent[1],n);case Mp.X.SOUTH:return(0,np.Wq)(e.extent[1],t.extent[3],n);case Mp.X.EAST:return(0,np.Wq)(e.extent[2],t.extent[0],n)||(0,np.Wq)(e.extent[2],-t.extent[0],n);case Mp.X.WEST:return(0,np.Wq)(e.extent[0],t.extent[2],n)||(0,np.Wq)(e.extent[0],-t.extent[2],n)}}(e,s,t)),(0,np.Fp)(a>=0);const l=2**a;if(a<0)return void(0,np.Fp)(!1);const h=e.renderData,c=h.geometry,d=h.localOrigin,u=c.getEdgeCount(r),p=c.numVerticesPerSide-1,_=o.geometry;if(!_)return void(0,np.Fp)(!1);const m=o.localOrigin,g=this.geometryState.edgePeerNeighbors[r];if(null!==g&&void 0!==g&&g.isLoaded){const e=g.renderData;(0,np.Fp)(h.geometryState.edgePeerNeighborSamplerVersions[r]===e.geometryState.samplerDataVersion),(0,np.Fp)(this.geometryState.edgePeerNeighborSamplerVersions[r]===e.geometryState.samplerDataVersion)}const f=(r+2)%4,v=_.getEdgeCount(f),y=u-1,b=v-1;(0,np.Fp)(y*l===b,"Tile[".concat(e.lij,"]:e").concat(r,",res=").concat(y," edgeRes mismatch with Neighbor[").concat(s.lij,"]:e").concat(f,",res=").concat(b," (expected:").concat(y*l,")"));const w=e.extent,C=t===Mp.X.NORTH||t===Mp.X.SOUTH,x=v-1,T=x>>a,S=u-1;if(T<1)return void(0,np.Fp)(1===S);(0,np.Fp)(T===S),(0,np.Fp)((0,me.wt)(T));const P=_.numVerticesPerSide-1;(0,np.Fp)(a>0||T===Math.max(P,p));const M=e.getNeighborEdgeStartVertexIndex(r,s);(0,np.Fp)(0<=M&&M<l);const A=M*T;(0,np.Fp)(0<=A&&A<=x-T);let O=0,E=A;c.getEdgeVertexPosition(r,__,d,0),c.getEdgeVertexPosition(r,m_,d,u-1);const D=(0,Ge.p)(__,m_),I=Math.max(b_,1e-4*D);for(let i=0;i<=T;++i){c.getEdgeVertexPosition(r,__,d,O),_.getEdgeVertexPosition(f,m_,m,E);const n=i/T,a=C?w[0]+n*(w[2]-w[0]):t===Mp.X.WEST?w[0]:w[2],l=C?t===Mp.X.SOUTH?w[1]:w[3]:w[1]+n*(w[3]-w[1]),p=e.surface.extent;if(null==p||(0,L.jE)(p,a,l)){const t=(0,Ge.F)(__,m_),i=(0,Ge.H)(__)-ge.sv.radius,n=(0,Ge.H)(m_)-ge.sv.radius,g=t<I;if(!g){console.warn("Tile edge vertex position mismatch: between [".concat(e.lij,"].edge").concat(r,"[").concat(O,"/").concat(u,"] and [").concat(s.lij,"].edge").concat(f,"[").concat(E,"/").concat(v,"]")),null!=p&&console.warn("  surface extent= ",p," x,y=",a,",",l);const y=(0,R.Ue)();(0,Ge.f)(y,h.localOrigin,o.localOrigin),(0,Ge.H)(y)>0&&console.warn("   localOrigins: ".concat(h.localOrigin," vs ").concat(o.localOrigin," d=").concat((0,Ge.H)(y)," [").concat(y,"]")),(()=>{const t=(0,R.d9)(__),i=(0,R.d9)(m_);e.updateEdgeElevations(),s.updateEdgeElevations(),c.getEdgeVertexPosition(r,__,d,O),_.getEdgeVertexPosition(f,m_,m,E);const n=(0,R.Ue)();(0,Ge.z)(n,__,t),(0,Ge.H)(n)>0&&console.warn("  XXX Tile[".concat(e.lij,"] edge out of date: ").concat(t," vs ").concat(__," d=").concat((0,Ge.H)(n)," [").concat(n,"]")),(0,Ge.z)(n,m_,i),(0,Ge.H)(n)>0&&console.warn("  XXX Neighbor[".concat(s.lij,"] edge out of date: ").concat(i," vs ").concat(m_," d=").concat((0,Ge.H)(n)," [").concat(n,"]"))})();const b=c.getEdgeCount(r),w=_.getEdgeCount(v);(0,np.Fp)(g,"Mismatch in tile [".concat(e.lij,"].edge[").concat(r,"][").concat(O,"/").concat(b,"] vs neighbor [").concat(s.lij,"].edge[").concat(f,"][").concat(E,"/").concat(w,"] ").concat((0,np.zT)(__)," vs ").concat((0,np.zT)(m_),"  dist=").concat(t," h(t|n|d)=").concat(i,"|").concat(n,"|").concat(n-i))}c.getEdgeNormal(r,g_,O),_.getEdgeNormal(f,f_,E),(0,Ge.n)(v_,g_),(0,Ge.n)(y_,f_);const y=(0,Ge.m)(v_,y_),b=1-y<.01||e===s;if(!b){const t=(0,R.Ue)();(0,Ge.z)(t,g_,f_);const i=()=>"Mismatch in tile edge normal ".concat((0,np.sP)(e.lij)," (").concat(O,"/").concat(u-1,") edge ").concat(r," vs neighbor ").concat((0,np.sP)(s.lij),"  (").concat(E,"/").concat(v-1,") nedge ").concat(f," :").concat((0,np.zT)(g_)," vs ").concat((0,np.zT)(f_),"  dot = ").concat(y," : ").concat((0,np.zT)(t));console.warn("Mismatch in tile edge normal: ",i());{e.updateEdgeElevations(),s.updateEdgeElevations();const t=(0,R.Ue)(),i=(0,R.Ue)();c.getEdgeNormal(r,t,O),_.getEdgeNormal(f,i,E),(0,Ge.G)(g_,t)||console.warn("Missing update in tile normal: ",(0,np.zT)(g_)," => ",(0,np.zT)(t)),(0,Ge.G)(f_,i)||console.warn("Missing update in neighbor normal: ",(0,np.zT)(f_)," => ",(0,np.zT)(i))}(0,np.Fp)(b,i())}}O+=1,E+=1}}))}}const __=(0,R.Ue)(),m_=(0,R.Ue)(),g_=(0,R.Ue)(),f_=(0,R.Ue)(),v_=(0,R.Ue)(),y_=(0,R.Ue)(),b_=1,w_=[null,null,null,null];function C_(e,t){return null!==t&&void 0!==t&&t.isLoaded||t===e?t:null}const x_=1,T_=2,S_=4,P_=8,M_=4,R_=8,A_=12,O_=[0,1,2,3],E_=65536;function D_(e,t){const{tile:i,geometry:n,geometryState:r}=e,{extentInRadians:s,surface:a}=i,{isWebMercator:o,renderer:l}=a,{numVerticesPerSide:h,wireframe:c}=r,d=h-1,u=(h-2)**2,p=o&&(t===lp.tk.HAS_SOUTH_POLE||t===lp.tk.HAS_BOTH_POLES),_=o&&(t===lp.tk.HAS_NORTH_POLE||t===lp.tk.HAS_BOTH_POLES),m=((p?1:0)+(_?1:0))*dm*h,g=lm(r),f=u+m+4*g,v=l.tileGeometryCache.acquire(f);n.numVerticesPerSide=h,n.vertexAttributes=v,n.maxEdgeVertexCount=g;const{boundingBox:y}=n;(0,Pp.cS)(y);const b=H_(e);tm.update(d,s,b),function(e){const{tile:t}=e;if(!t.intersectsClippingArea)return;const{geometry:i,geometryState:n,localOrigin:r}=e,{numVerticesPerSide:s,samplerData:a}=n,o=s-2,l=s-1,{vertexAttributes:h,boundingBox:c}=i,d=h.position,u=h.uv0,{typedBuffer:p,typedBufferStride:_}=h.normalCompressed,{extent:m}=t,g=m[0],f=m[2],v=m[1],y=m[3],b=t.ellipsoid.radius,w=r[0],C=r[1],x=r[2],T=d.typedBuffer,S=d.typedBufferStride,P=1/l;let M=0;if(1<=o){const e=P,t=v*(1-e)+y*e,i=tm.sinLatLUT[1],n=tm.cosLatLUT[1];for(let r=1;r<=o;r++){const s=r*P,o=g*(1-s)+f*s,l=tm.sinLonLUT[r],h=tm.cosLonLUT[r],d=b+ip(o,t,a),p=d*h*n-w,_=d*l*n-C,m=d*i-x;om(p,_,m,c);const v=(r-1)*S;T[v]=p,T[v+1]=_,T[v+2]=m,Ep(u,r-1,s,e)}}for(let R=1;R<=o;R++){const e=R*P,t=v*(1-e)+y*e,i=tm.sinLatLUT[R],n=tm.cosLatLUT[R],r=R+1,s=r*P,h=v*(1-s)+y*s,d=tm.sinLatLUT[r],m=tm.cosLatLUT[r],A=tm.sinLonLUT[0],O=tm.cosLonLUT[0],E=b+ip(g,t,a);let D=O*n*E-w,I=A*n*E-C,L=i*E-x;const N=M*S;let U=T[N],H=T[N+1],F=T[N+2];for(let y=1;y<=o;y++){const e=y*P,r=g*(1-e)+f*e,A=tm.sinLonLUT[y],O=tm.cosLonLUT[y];let E=0,N=0,V=0;if(y<o){const e=(M+1)*S;E=T[e],N=T[e+1],V=T[e+2]}else{const e=tm.sinLonLUT[l],r=tm.cosLonLUT[l],s=b+ip(f,t,a);E=r*n*s-w,N=e*n*s-C,V=i*s-x}const q=D,z=I,B=L;D=U,I=H,L=F,U=E,H=N,F=V;const G=E-q,k=N-z,Z=V-B;let j=0,W=0,X=0;if(R>1){const e=(M-o)*S;j=T[e],W=T[e+1],X=T[e+2]}else{const e=tm.sinLatLUT[0],t=tm.cosLatLUT[0],i=b+ip(r,v,a);j=O*t*i-w,W=A*t*i-C,X=e*i-x}const Q=b+ip(r,h,a),Y=O*m*Q-w,J=A*m*Q-C,K=d*Q-x;if(R<o){const t=M+o,i=t*S;T[i]=Y,T[i+1]=J,T[i+2]=K,om(Y,J,K,c),Ep(u,t,e,s)}const $=j-Y,ee=W-J,te=X-K;let ie=O*n,ne=A*n,re=i;re*re<.999&&(ie=Z*ee-k*te,ne=G*te-Z*$,re=k*$-G*ee);const se=1/Math.sqrt(ie*ie+ne*ne+re*re);(0,Rp.hd)(p,M,ie*se,ne*se,re*se,_),++M}}}(e),n.poleVerticesStartIndex=u;const w=function(e,t,i){const{tile:n,localOrigin:r,geometry:s}=e,{extent:a,ellipsoid:o}=n,{boundingBox:l,numVerticesPerSide:h,vertexAttributes:c,poleVerticesStartIndex:d}=s,u=h-1,p=r[0],_=r[1],m=r[2],g=o.radius,f=a[1],v=a[3],y=[];let b=d;const w=(e,t)=>{const i=t*h;om(-p,-_,e*g-m,l),y.push(new $_(1===e,i,1===e?0:2,b,dm));const n=U_(-1===e?f:v,g),r=e*Math.PI/2-n,s=.99*(1===e?1:-1),a=g+0,{position:o,uv0:d}=c,{typedBuffer:w,typedBufferStride:C}=c.normalCompressed;for(let h=1;h<=dm;++h){const e=n+r*(h/dm),t=Math.cos(e),i=Math.sin(e);for(let n=0;n<=u;n++){const e=n/u,r=tm.sinLonLUT[n],h=tm.cosLonLUT[n]*t,c=r*t,g=i,f=h*a-p,v=c*a-_,y=g*a-m;om(f,v,y,l),o.setValues(b,f,v,y),Ep(d,b,e,s),(0,Rp.hd)(w,b,h,c,g,C),++b}}};return t&&w(-1,0),i&&w(1,u),y}(e,p,_);n.edgeVerticesStartIndex=u+m,j_(e),I_(e),G_(n,w,c),e.intersectionData=null}function I_(e){e.tile.intersectsClippingArea&&(N_(e),L_(e))}function L_(e){let t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];const{geometry:i,geometryState:n,tile:r,localOrigin:s}=e,{level:a,extent:o,extentInRadians:l,ellipsoid:h}=r,c=h.radius,d=l[0],u=l[2],p=l[1],_=l[3],{samplerData:m}=n,g=o[0],f=o[2],v=o[1],y=o[3],b=H_(e),{boundingBox:w,vertexAttributes:C}=i,x=s[0],T=s[1],S=s[2],P=C.position,M=P.typedBuffer,R=P.typedBufferStride,A=C.uv0;for(let O=0;O<4;++O){const s=1===O||3===O,l=n.edgeResolutions[O];(0,np.Fp)((0,me.wt)(l));const h=l+1,C=C_(r,n.edgePeerNeighbors[O]);if(rm(r,C,O)){X_(e,O,C);continue}const P=null!=C;(0,np.Fp)(!P||C.level===r.level),(0,np.Fp)(!P||(0,Up.gl)(r,C)<=0);const E=null===C||void 0===C?void 0:C.renderData,D=null===E||void 0===E?void 0:E.geometryState;if(np.T9){const e=r.surface;if(!C&&e&&!e.updatingRootTiles){const t=np.OC[O],i=r.findNeighborTile(t,(e=>e.isLoaded||e.isLeaf||e.level===r.level));i?i.intersectsClippingArea&&((0,np.Fp)(!i.isLoaded),(0,np.Fp)(!i.isLeaf),(0,np.Fp)(i.level===a)):(0,np.Fp)(null==(null===e||void 0===e?void 0:e.rootTiles)||!r.shouldHaveNeighbor(t))}}const I=1===O?o[2]:o[0],L=null===C||void 0===C?void 0:C.extent,N=L&&s?1===O?L[0]:L[2]:I,U=0===O?o[3]:o[1],H=1===O?1:0,F=0===O?1:0,V=1===O?u:d,q=0===O?_:p,z=Math.sin(V),B=Math.cos(V),G=Math.sin(q),k=Math.cos(q),Z=null===D||void 0===D?void 0:D.samplerData,j=P?(e,t,i)=>.5*(ip(e,t,m)+ip(i,t,Z)):(e,t,i)=>ip(e,t,m),W=i.outerEdgesOffsetAndLength[2*O+0],X=t&&h>3?h-3:1,Q=null!=m&&m.some((e=>null!=e)),Y=null!=Z&&Z.some((e=>null!=e)),J=Q||Y,K=1/l,$=W;(0,np.Fp)(!L||(0,np.Wq)(L[2]-L[0],o[2]-o[0])),(()=>{const e=1===O?-1:3===O?1:0,t=0===O?-1:2===O?1:0,n=(o[2]-o[0])*K,r=e*n,a=t*n,l=s?e*((u-d)*K):0,p=s?0:t*K,_=F,C=s?V+l:V,E=s?Math.sin(C):z,D=s?Math.cos(C):B,L=s?V-l:V,W=s?Math.sin(L):z,Q=s?Math.cos(L):B,Y=s?q:b(_+p),ee=s?G:Math.sin(Y),te=s?k:Math.cos(Y),ie=s?q:b(_-p),ne=s?G:Math.sin(ie),re=s?k:Math.cos(ie);let se=0,ae=0,oe=0;{const e=0*K,t=s?I:g*(1-e)+f*e,i=s?N:t,n=s?v*(1-e)+y*e:U,r=s?V:d*(1-e)+u*e,a=s?z:Math.sin(r),o=s?B:Math.cos(r),l=s?b(e):q,h=s?Math.sin(l):G,p=s?Math.cos(l):k,_=c+j(t,n,i);se=o*p*_,ae=a*p*_,oe=h*_}let le=0,he=0,ce=0;{const e=1*K,t=s?I:g*(1-e)+f*e,i=s?N:t,n=s?v*(1-e)+y*e:U,r=s?V:d*(1-e)+u*e,a=s?z:Math.sin(r),o=s?B:Math.cos(r),l=s?b(e):q,h=s?Math.sin(l):G,p=s?Math.cos(l):k,_=c+j(t,n,i);le=o*p*_,he=a*p*_,ce=h*_}for(let o=1;o<h-1;o+=X){let e=0,t=0,n=0;{const i=(o+1)*K,r=s?I:g*(1-i)+f*i,a=s?N:r,l=s?v*(1-i)+y*i:U,h=s?V:d*(1-i)+u*i,p=s?z:Math.sin(h),_=s?B:Math.cos(h),m=s?b(i):q,w=s?Math.sin(m):G,C=s?Math.cos(m):k,x=c+j(r,l,a);e=_*C*x,t=p*C*x,n=w*x}const l=e,h=t,p=n,_=le,C=he,L=ce;le=l,he=h,ce=p;{const e=$+o,t=e*R,i=_-x,n=C-T,r=L-S;M[t]=i,M[t+1]=n,M[t+2]=r,om(i,n,r,w);const a=o*K;Ep(A,e,s?H:a,s?a:F)}const X=se,Y=ae,ie=oe;se=_,ae=C,oe=L;const de=_,ue=C,pe=L,_e=1/Math.sqrt(de*de+ue*ue+pe*pe),me=pe*_e;let ge=0,fe=0,ve=0;if(J&&me*me<.999){let e=0,t=0,i=0;{const n=0===O?-1:1;e=n*(l-X),t=n*(h-Y),i=n*(p-ie)}{const n=o*K,l=s?I:g*(1-n)+f*n,h=s?N:l,p=s?v*(1-n)+y*n:U,_=s?V:d*(1-n)+u*n,w=s?z:Math.sin(_),C=s?B:Math.cos(_),x=s?b(n):q,T=s?Math.sin(x):G,S=s?Math.cos(x):k;let M=de,R=ue,A=pe;if(P){const e=c+ip(h-r,p-a,Z),t=s?S:re;M=(s?Q:C)*t*e,R=(s?W:w)*t*e,A=(s?T:ne)*e}{const n=c+ip(l+r,p+a,m),o=s?S:te,h=(s?D:C)*o*n,d=(s?E:w)*o*n,u=(s?T:ee)*n;P||(M=2*de-h,R=2*ue-d,A=2*pe-u);const _=3===O?-1:1,g=_*(M-h),f=_*(R-d),v=_*(A-u);ge=i*f-t*v,fe=e*v-i*g,ve=t*g-e*f;const y=1/Math.sqrt(ge*ge+fe*fe+ve*ve);ge*=y,fe*=y,ve*=y}}}else ge=de*_e,fe=ue*_e,ve=pe*_e;i.setEdgeNormalFromValues(O,o,ge,fe,ve)}})()}}function N_(e){Q_(e)}function U_(e,t){return Math.PI/2-2*Math.atan(Math.exp(-e/t))}function H_(e){const{tile:t}=e;if(t.surface.isWebMercator){const e=t.extent,i=t.ellipsoid.radius;return t=>function(e,t,i,n){return U_(e*(1-n)+t*n,i)}(e[1],e[3],i,t)}const i=t.extentInRadians;return e=>function(e,t,i){return e*(1-i)+t*i}(i[1],i[3],e)}function F_(e,t){const{tile:i,geometryState:n,geometry:r}=e,{extent:s,surface:a}=i,{wireframe:o}=n,l=s[0],h=s[1],c=s[2]-l,d=s[3]-h,{numVerticesPerSide:u,clippingArea:p}=n,_=null!=p?Math.max(0,(p[0]-l)/c):0,m=null!=p?Math.max(0,(p[1]-h)/d):0,g=null!=p?Math.min(1,(p[2]-l)/c):1,f=null!=p?Math.min(1,(p[3]-h)/d):1,v=(u-2)**2,y=lm(n),b=v+4*y,w=a.renderer.tileGeometryCache.acquire(b),{boundingBox:C}=r;(0,Pp.cS)(C),r.numVerticesPerSide=u,r.vertexAttributes=w,r.maxEdgeVertexCount=y,r.minu=_,r.minv=m,r.maxu=g,r.maxv=f,function(e){const t=e.tile;if(!t.intersectsClippingArea)return;const{geometry:i,geometryState:n,localOrigin:r}=e,{samplerData:s,clippingArea:a,numVerticesPerSide:o}=n,{surface:l,extent:h,ellipsoid:c}=t,{isWebMercatorOnPlateCarree:d}=l,u=null!=a?a:im,p=h[0],_=h[1],m=h[2],g=h[3],f=Math.max(p,u[0]),v=Math.min(m,u[2]),y=Math.max(_,u[1]),b=Math.min(g,u[3]),w=c.radius,C=t.horizontalScale,x=o-1,T=o-2,{minu:S,minv:P,maxu:M,maxv:R,boundingBox:A,vertexAttributes:O}=i,E=O.position,D=O.uv0,{typedBuffer:I,typedBufferStride:L}=O.normalCompressed,N=r[0],U=r[1],H=r[2],F=E.typedBuffer,V=E.typedBufferStride;let q=0;const z=(0,me.uZ)(_,y,b),B=d?(Math.PI/2-2*Math.atan(Math.exp(-z/w)))*w:z*C,G=1/x,k=(0,me.uZ)(_*(1-G)+g*G,y,b);let Z=B,j=d?(Math.PI/2-2*Math.atan(Math.exp(-k/w)))*w:k*C;for(let W=1;W<=T;W++){const e=W/x,t=(0,me.uZ)(_*(1-e)+g*e,y,b),i=(0,me.uZ)(e,P,R),n=j,r=(W-1)/x,a=(0,me.uZ)(_*(1-r)+g*r,y,b),o=Z,l=(W+1)/x,h=(0,me.uZ)(_*(1-l)+g*l,y,b),c=d?(Math.PI/2-2*Math.atan(Math.exp(-h/w)))*w:h*C,u=(0,me.uZ)(l,P,R);Z=j,j=c;const O=(0,me.uZ)(p,f,v);let E=O*C,z=ip(O,t,s);const B=1/x,G=(0,me.uZ)(B,S,M),k=(0,me.uZ)(p*(1-G)+m*G,f,v);let X=G,Q=k,Y=k*C,J=ip(k,t,s);if(1===W){const e=Y-N,t=Z-U,n=J-H,r=0*V;F[r]=e,F[r+1]=t,F[r+2]=n,om(e,t,n,A);Ep(D,q,(0,me.uZ)(B,S,M),i)}for(let d=1;d<=T;d++){const e=Y,r=J,l=(d+1)/x,_=(0,me.uZ)(l,S,M),g=(0,me.uZ)(p*(1-l)+m*l,f,v),y=Q;Q=g;{const e=q+1,r=e*V;if(1===W||d===T){const a=g*C,o=ip(g,t,s);if(1===W&&d<T){const t=a-N,s=n-U,l=o-H;F[r]=t,F[r+1]=s,F[r+2]=l,om(t,s,l,A),Ep(D,e,_,i)}Y=a,J=o}else Y=F[r]+N,J=F[r+2]+H}const b=Y,w=J,P=E,R=z;E=e,z=r;const O=(q-T)*V,B=1===W?ip(y,a,s):F[O+2]+H,G=ip(y,h,s);if(W<T){const t=q+T,i=t*V,n=e-N,r=c-U,s=G-H;F[i]=n,F[i+1]=r,F[i+2]=s,om(n,r,s,A);const a=X;X=_,Ep(D,t,a,u)}{const e=b-P,t=o-c,i=t*(w-R),n=e*(B-G),r=-t*e,s=i*i+n*n+r*r;if(0===s)(0,Rp.hd)(I,q,0,0,1,L);else{const e=1/Math.sqrt(s);(0,Rp.hd)(I,q,i*e,n*e,r*e,L)}}++q}}}(e),r.edgeVerticesStartIndex=v,j_(e),V_(e),G_(r,[],o),e.intersectionData=null}function V_(e,t){e.tile.intersectsClippingArea&&(z_(e),q_(e,!1))}function q_(e,t){const{geometry:i,geometryState:n,localOrigin:r}=e,s=e.tile,{surface:a,extent:o}=s,{clippingArea:l,samplerData:h}=n,c=null!=l?l:im,d=o[0],u=o[2],p=o[1],_=o[3],m=[_>c[3],u>c[2],p<c[1],d<c[0]],g=s.horizontalScale,f=B_(a.isWebMercatorOnPlateCarree,s.ellipsoid.radius,g),{minu:v,minv:y,maxu:b,maxv:w,boundingBox:C}=i,x=Math.max(d,c[0]),T=Math.min(u,c[2]),S=Math.max(p,c[1]),P=Math.min(_,c[3]),M=r[0],R=r[1],A=r[2];for(let O=0;O<4;++O){const r=1===O||3===O,o=n.edgeResolutions[O];(0,np.Fp)((0,me.wt)(o));const l=o+1,c=m[O],E=C_(s,n.edgePeerNeighbors[O]);if(!c&&rm(s,E,O)){X_(e,O,E);continue}const D=null!=E&&!c,I=null===E||void 0===E?void 0:E.renderData,L=null===I||void 0===I?void 0:I.geometryState;if(np.T9&&((0,np.Fp)(!D||E.level===s.level),(0,np.Fp)(!D||(0,Up.gl)(s,E)<=0),s&&!E&&!a.updatingRootTiles)){const e=np.OC[O],t=s.findNeighborTile(e,(e=>e.isLoaded||e.isLeaf||e.level===s.level));a.updatingRootTiles||(t?t.intersectsClippingArea&&((0,np.Fp)(!t.isLoaded),(0,np.Fp)(!t.isLeaf),(0,np.Fp)(t.level===s.level)):(0,np.Fp)(null==(null===a||void 0===a?void 0:a.rootTiles)||!s.shouldHaveNeighbor(e)))}const N=(0,me.uZ)(1===O?u:d,x,T),U=(0,me.uZ)(0===O?_:p,S,P),H=null===L||void 0===L?void 0:L.samplerData,F=t&&l>3?l-3:1,V=(0,me.uZ)(1===O?1:0,v,b),q=(0,me.uZ)(0===O?1:0,y,w),z=D?(e,t)=>.5*(ip(e,t,H)+ip(e,t,h)):(e,t)=>ip(e,t,h),B=(u-d)/o,G=r?1===O?B:-B:0,k=r?0:0===O?B:-B,Z=-G,j=-k;let W=0,X=0,Q=0;{const e=0/o,t=r?N:(0,me.uZ)(d*(1-e)+u*e,x,T),i=r?(0,me.uZ)(p*(1-e)+_*e,S,P):U,n=z(t,i);W=t*g,X=f(i),Q=n}let Y=0,J=0,K=0;{const e=1/o,t=r?N:(0,me.uZ)(d*(1-e)+u*e,x,T),i=r?(0,me.uZ)(p*(1-e)+_*e,S,P):U,n=z(t,i);Y=t*g,J=f(i),K=n}for(let e=1;e<l-1;e+=F){const t=e/o,n=Y,s=J,a=K;{const o=r?V:(0,me.uZ)(t,v,b),l=r?(0,me.uZ)(t,y,w):q,h=n-M,c=s-R,d=a-A;om(n,c,d,C),i.setEdgeVertexFromValuesRawPositionUV(O,e,h,c,d,o,l)}{const t=(e+1)/o,i=r?N:(0,me.uZ)(d*(1-t)+u*t,x,T),n=r?(0,me.uZ)(p*(1-t)+_*t,S,P):U,s=z(i,n);Y=i*g,J=f(n),K=s}const l=Y,c=K,m=W,E=X,I=Q;W=n,X=s,Q=a;let L=0,F=0,B=0;if(r){const e=J-s,i=c-a,r=E-s,o=I-a,l=(0,me.uZ)(p*(1-t)+_*t,S,P),d=N+Z,u=d*g-n,m=ip(d,l,h)-a,f=3===O?-1:1;if(L=f*(-r+e)*m,F=f*u*(-o+i),B=-f*u*(-r+e),D){const t=N+G,s=t*g-n;L=(-r+e)*(m-(ip(t,l,H)-a)),F=(u-s)*(-o+i),B=-(u-s)*(-r+e)}}else{const e=l-n,i=c-a,r=m-n,o=I-a,p=(0,me.uZ)(d*(1-t)+u*t,x,T),_=U+j,g=ip(p,_,h)-a,v=f(_)-s,y=2===O?-1:1;if(L=y*v*(-o+i),F=y*(-r+e)*g,B=-y*v*(-r+e),D){const t=p,n=U+k,l=f(n)-s;L=(-v+l)*(-o+i),F=(-r+e)*(-g+(ip(t,n,H)-a)),B=-(-v+l)*(-r+e)}}const $=1/Math.sqrt(L*L+F*F+B*B);i.setEdgeNormalFromValues(O,e,L*$,F*$,B*$)}}}function z_(e,t){Q_(e)}function B_(e,t,i){return e?e=>function(e,t){return(Math.PI/2-2*Math.atan(Math.exp(-e/t)))*t}(e,t):e=>function(e,t){return e*t}(e,i)}function G_(e,t,i){const{numVerticesPerSide:n,vertexAttributes:r,maxEdgeVertexCount:s}=e,a=n-1,o=r.count,l=2*(n-3)*(n-3),h=4*(a+s-3),c=O_.reduce(((t,i)=>t+(a+e.getEdgeCount(i)-3)),0),d=t.reduce(((e,t)=>e+a*(2*(t.latitudeResolution-1)+1)),0),u=3*(i?2:1),p=(l+h+d)*u,_=o>=E_?new Uint32Array(p):new Uint16Array(p);for(let m=0;m<p;++m)_[m]=0;e.indices=_,e.indexCount=(l+c+d)*u,e.poleIndicesStartIndex=l*u,e.edgeIndicesStartIndex=(l+d)*u,i?(function(e){const{indices:t,numVerticesPerSide:i,vertexAttributes:n}=e,{position:r}=n,{typedBuffer:s,typedBufferStride:a}=r,o=i-2;let l=0;for(let h=0;h<i-3;++h){const e=h*o;for(let n=0;n<i-3;++n){const i=h*o+n,r=i+1,c=r+o,d=c-1,u=e+n,p=u+1,_=p+o;hm(u,p,_,_-1,a,s)?(cm(t,l,i,r,c),l+=6,cm(t,l,c,d,i)):(cm(t,l,i,r,d),l+=6,cm(t,l,d,c,r)),l+=6}}}(e),function(e,t){const{indices:i,numVerticesPerSide:n,poleIndicesStartIndex:r}=e,s=n-1;let a=r;for(const o of t){const t=o.connectedOuterEdgeOffset;let r=e.getEdgeVertexIndex(t,0),l=1;for(let e=0;e<o.latitudeResolution;++e){const t=0===e?o.rowOffset:r+n;for(let n=0;n<s;n++)cm(i,a,r,r+1,t+n),a+=6,e<o.latitudeResolution-1&&(cm(i,a,r+1,t+n+1,t+n),a+=6),r+=l;r=t,l=1}}}(e,t),Z_(e)):(function(e){const{numVerticesPerSide:t,indices:i,vertexAttributes:n}=e,{position:r}=n,{typedBuffer:s,typedBufferStride:a}=r,o=t-2,l=t-3,h=0,c=t-3;let d=0;for(let u=0;u<l;++u){const e=u*o;for(let t=h;t<c;++t){const n=e+t,r=n+1,l=r+o,h=l-1;hm(n,r,l,h,a,s)?(i[d]=n,i[d+1]=r,i[d+2]=l,i[d+3]=l,i[d+4]=h,i[d+5]=n):(i[d]=n,i[d+1]=r,i[d+2]=h,i[d+3]=h,i[d+4]=r,i[d+5]=l),d+=6}}}(e),function(e,t){const{numVerticesPerSide:i,indices:n,poleIndicesStartIndex:r}=e,s=i-1;let a=r;for(const o of t){const t=o.isNorth?1:2,r=o.isNorth?2:1,l=o.isNorth?3:4,h=o.isNorth?4:3;let c=e.getEdgeVertexIndex(o.connectedOuterEdgeOffset,0),d=1;for(let e=0;e<o.latitudeResolution;++e){const u=0===e?o.rowOffset:c+i;for(let i=0;i<s;i++){const s=u+i;n[a]=c,n[a+t]=c+1,n[a+r]=s,e<o.latitudeResolution-1?(n[a+l]=c+1,n[a+h]=s+1,n[a+5]=s,a+=6):a+=3,c+=d}c=u,d=1}}}(e,t),k_(e))}function k_(e){const{indices:t,numVerticesPerSide:i,edgeIndicesStartIndex:n}=e,r=i-1,s=r-2;let a=n;for(let o=0;o<4;++o){const i=am[o];let n=0,l=0;const h=e.getEdgeCount(o),c=i.count;(0,np.Fp)(c===r-1);const d=1===o||2===o,u=d?1:2,p=d?2:1,_=e.getEdgeFirstVertexIndex(o),m=1,g=i.vertex0Index,f=i.stride;for(;n<h-1||l<c-1;){const e=g+l*f,i=_+n*m,o=n<h-1,d=l<c-1,v=o&&(!d||(o?0+r*(n+.5)/(h-1):0)<=(d?1+s*(l+.5)/(c-1):0));v?++n:++l;const y=v?i+m:e+f;t[a]=e,t[a+u]=i,t[a+p]=y,a+=3}}e.indexCount=a}function Z_(e){const{indices:t,numVerticesPerSide:i,edgeIndicesStartIndex:n}=e,r=i-1,s=r-2;let a=n;for(let o=0;o<4;++o){const i=am[o];let n=0,l=0;const h=e.getEdgeCount(o),c=i.count;(0,np.Fp)(c===r-1);const d=1===o||2===o,u=d?1:3,p=d?3:1,_=e.getEdgeFirstVertexIndex(o),m=1,g=i.vertex0Index,f=i.stride;for(;n<h-1||l<c-1;){const e=g+l*f,i=_+n*m,o=n<h-1,d=l<c-1,v=o&&(!d||(o?0+r*(n+.5)/(h-1):0)<=(d?1+s*(l+.5)/(c-1):0));v?++n:++l;const y=v?i+m:e+f;t[a]=e,t[a+u]=i,t[a+u+1]=i,t[a+p]=y,t[a+p+1]=y,t[a+5]=e,a+=6}}e.indexCount=a}function j_(e){const{geometry:t,geometryState:i}=e,{edgeResolutions:n}=i,{numVerticesPerSide:r,edgeVerticesStartIndex:s}=t,a=r-2;let o=s;for(let l=0;l<4;++l){{const e=0===l||2===l,t=(0===l?a-1:0)*a+(1===l?a-1:0),i=(e?0:1)*a+(e?1:0),n=am[l];n.vertex0Index=t,n.stride=i,n.count=a}{const e=n[l]+1;t.outerEdgesOffsetAndLength[2*l+0]=o,t.outerEdgesOffsetAndLength[2*l+1]=e,o+=e}}}function W_(e){j_(e),e.geometryState.wireframe?Z_(e.geometry):k_(e.geometry)}function X_(e,t,i){const{geometryState:n,geometry:r,tile:s,localOrigin:a}=e,o=1===t||3===t,l=n.edgeResolutions[t];(0,np.Fp)((0,me.wt)(l));const h=l+1,{boundingBox:c,minu:d,minv:u,maxu:p,maxv:_,vertexAttributes:m}=r,g=(0,me.uZ)(1===t?1:0,d,p),f=(0,me.uZ)(0===t?1:0,u,_),v=i.renderData,y=v.geometryState,b=v.geometry,w=(t+2)%4,C=b.getEdgeCount(w),x=s.getNeighborEdgeStartVertexIndex(t,i)*l,T=l*2**(s.level-i.level);(0,np.Fp)(y.edgeResolutions[w]===T),(0,np.Fp)(C-1===T);const S=v.localOrigin[0]-a[0],P=v.localOrigin[1]-a[1],M=v.localOrigin[2]-a[2],R=r.getEdgeFirstVertexIndex(t),A=m.position,O=A.typedBuffer,E=A.typedBufferStride,D=m.normalCompressed,I=D.typedBuffer,L=D.typedBufferStride,N=m.uv0,U=b.vertexAttributes,H=b.getEdgeFirstVertexIndex(w),F=U.position.typedBuffer,V=U.position.typedBufferStride,q=U.normalCompressed.typedBuffer,z=U.normalCompressed.typedBufferStride;for(let B=1;B<h-1;++B){const e=R+B,t=H+(x+B),i=e*E,n=t*V,r=F[n]+S,s=F[n+1]+P,a=F[n+2]+M;O[i]=r,O[i+1]=s,O[i+2]=a,om(r,s,a,c);const h=e*L,m=t*z;I[h]=q[m],I[h+1]=q[m+1];const v=B/l;Ep(N,e,o?g:(0,me.uZ)(v,d,p),o?(0,me.uZ)(v,u,_):f)}}function Q_(e){var t;const{geometry:i,geometryState:n,localOrigin:r}=e,{clippingArea:s,samplerData:a}=n,{minu:o,minv:l,maxu:h,maxv:c,boundingBox:d,vertexAttributes:u}=i,p=e.tile,{surface:_,ellipsoid:m,extent:g,extentInRadians:f,horizontalScale:v}=p,y="local"===(null===(t=_.view)||void 0===t?void 0:t.viewingMode),b=m.radius;let w=0,C=0,x=0;const T=y?(()=>{const e=s,t=null!=e&&(g[3]>e[3]||g[2]>e[2]||g[1]<e[1]||g[0]<e[0]),i=B_(_.isWebMercatorOnPlateCarree,b,v);return(n,r,s)=>{const a=0===n?g[0]:g[2],o=0===r?g[1]:g[3],l=t?(0,me.uZ)(a,e[0],e[2]):a,h=t?(0,me.uZ)(o,e[1],e[3]):o,c=s;w=l*v,C=i(h),x=c}})():(e,t,i)=>{const n=f[0===t?1:3],r=f[0===e?0:2],s=Math.cos(n),a=Math.sin(n),o=Math.sin(r),l=Math.cos(r),h=b+i;w=l*s*h,C=o*s*h,x=a*h};let S=0,P=0,M=0,R=0,A=0,O=0,E=0,D=0,I=0;const L=y&&_.isWebMercatorOnPlateCarree,N=(e,t,i,n,r)=>{let s=0,a=0,o=0;if(y){const e=t*v,r=L?(Math.PI/2-2*Math.atan(Math.exp(-i/b)))*b:i*v;s=e-w,a=r-C,o=n-x}else{const r=H_(e),l=e.tile,h=l.extent,c=l.extentInRadians,d=(t-h[0])/(h[2]-h[0]),u=(i-h[1])/(h[3]-h[1]),p=c[0]*(1-d)+c[2]*d,_=r(u),m=Math.cos(_),g=Math.sin(_),f=Math.sin(p),v=Math.cos(p),y=b+n;s=v*m*y-w,a=f*m*y-C,o=g*y-x}switch(r){case 0:E+=s,D+=a,I+=o;break;case 1:R-=s,A-=a,O-=o;break;case 2:E-=s,D-=a,I-=o;break;case 3:R+=s,A+=a,O+=o}},U=null!==s&&void 0!==s?s:im,H=g[0],F=g[2],V=g[1],q=g[3],z=[q>U[3],F>U[2],V<U[1],H<U[0]],B=Math.max(H,U[0]),G=Math.min(F,U[2]),k=Math.max(V,U[1]),Z=Math.min(q,U[3]),j=e=>Math.max(U[0],Math.min(U[2],e)),W=e=>Math.max(U[1],Math.min(U[3],e)),X=e=>{const t=n.cornerNeighborCornerTiles;S=0,P=0,M=1,R=0,A=0,O=0,E=0,D=0,I=0;let i=1/0;for(let n=0;n<4;++n){var r;const s=t[4*e+n];i=Math.min(i,null!==(r=null===s||void 0===s?void 0:s.level)&&void 0!==r?r:1/0)}for(let n=0;n<4;++n){const r=t[4*e+n];nm[n]=(null===r||void 0===r?void 0:r.level)===i?r:null}let s=1,a=0;for(let n=0;n<4;++n){const e=nm[n];e&&(s=Math.max(s,null===e||void 0===e?void 0:e.renderData.geometryState.numVerticesPerSide),a=e.extent[2]-e.extent[0])}const o=a,l=s;(0,np.Fp)(l>1);const h=o/l;for(let n=0;n<4;++n){const e=nm[(n+3)%4],t=nm[n%4];if(!e&&!t)continue;const i=0===n?1:1===n?2:2===n?3:0,r=0===n?2:1===n?3:2===n?0:1;if(e&&t){const s=em[n][0]*h,a=em[n][1]*h,o=e.extent,l=j(o[0===i||1===i?2:0]+s),c=W(o[0===i||3===i?3:1]+a),d=t.extent,u=j(d[0===r||1===r?2:0]+s),p=W(d[0===r||3===r?3:1]+a),_=e.renderData,m=t.renderData,g=ip(l,c,_.geometryState.samplerData),f=ip(u,p,m.geometryState.samplerData);N(_,l,c,.5*(g+f),n)}else{const s=null!==e&&void 0!==e?e:t,a=e?i:r,o=s.extent,l=em[n],c=j(o[0===a||1===a?2:0]+l[0]*h),d=W(o[0===a||3===a?3:1]+l[1]*h),u=s.renderData,p=ip(c,d,u.geometryState.samplerData);N(u,c,d,p,n)}}if(!y){const e=Math.sqrt(w*w+C*C+x*x);S=w/e,P=C/e,M=x/e}if(y||M*M<.999){const e=Math.sqrt(R*R+A*A+O*O);R/=e,A/=e,O/=e;const t=Math.sqrt(E*E+D*D+I*I);E/=t,D/=t,I/=t,S=O*D-A*I,P=R*I-O*E,M=A*E-R*D;const i=1/Math.sqrt(S*S+P*P+M*M);S*=i,P*=i,M*=i}},Q=n.cornerNeighborCornerTiles;for(let Y=0;Y<4;++Y){const e=Y,t=(Y+1)%4,s=0===Y||1===Y?1:0,_=0===Y||3===Y?1:0,m=(0,me.uZ)(s,o,h),g=(0,me.uZ)(_,l,c),f=i.getEdgeFirstVertexIndex(e),v=i.getEdgeCount(e),y=0===Y||3===Y?v-1:0,b=i.getEdgeFirstVertexIndex(t),R=i.getEdgeCount(t),A=0===Y||1===Y?R-1:0;let O=-1;for(let i=0;i<4;++i){const e=Q[4*Y+i],t=Q[4*Y+O];e&&(-1===O||(0,Up.gl)(t,e)>0)&&(O=i)}const E=O,D=Q[4*Y+E];if(D!==p){const e=p.level-D.level,t=2**e,i=[D.lij[0]+e,D.lij[1]*t,D.lij[2]*t],s=[i[1]+t===p.lij[1],0===Y&&(1===E||0===E&&D!==Q[4*Y+3])||1===Y&&(0===E||1===E&&D!==Q[4*Y+2]),i[1]===p.lij[1]+1,2===Y&&(3===E||2===E&&D!==Q[4*Y+1])||3===Y&&(2===E||3===E&&D!==Q[4*Y+0])],a=s.reduce(((e,t)=>e+(t?1:0)),0);(0,np.Fp)(1===a||2===a);let o=-1,l=-1;const h=D.renderData;if(1===a){const e=s.findIndex((e=>e));(0,np.Fp)(0<=e&&e<=3),o=(e+2)%4;const t=n.edgeResolutions[e];l=p.getNeighborEdgeStartVertexIndex(e,D)*t+t*(0===e&&0===Y||1===e&&0===Y||2===e&&1===Y||3===e&&3===Y?1:0)}else{(0,np.Fp)(s[1]||s[3]),o=s[1]?3:1;const e=h.geometryState.edgeResolutions[o];l=0===Y||3===Y?0:e}const c=h.geometry;{const e=f+y,t=b+A,i=c.getEdgeFirstVertexIndex(o)+l,n=c.vertexAttributes,s=h.localOrigin;{const a=n.position,o=a.typedBuffer,l=i*a.typedBufferStride,h=o[l]+s[0]-r[0],c=o[l+1]+s[1]-r[1],p=o[l+2]+s[2]-r[2];om(h,c,p,d);const _=u.position,m=_.typedBuffer;{const t=e*_.typedBufferStride;m[t]=h,m[t+1]=c,m[t+2]=p}{const e=t*_.typedBufferStride;m[e]=h,m[e+1]=c,m[e+2]=p}}const a=u.uv0;Ep(a,e,m,g),Ep(a,t,m,g);{const r=n.normalCompressed.typedBuffer,s=i*n.normalCompressed.typedBufferStride,a=u.normalCompressed,o=a.typedBuffer;{const t=e*a.typedBufferStride;o[t]=r[s],o[t+1]=r[s+1]}{const e=t*a.typedBufferStride;o[e]=r[s],o[e+1]=r[s+1]}}}}else{let n;if(z[e]||z[t]){n=ip((0,me.uZ)(H*(1-s)+F*s,B,G),(0,me.uZ)(V*(1-_)+q*_,k,Z),a)}else n=Y_(Q,Y);T(s,_,n),X(Y);const o=w-r[0],l=C-r[1],h=x-r[2];om(o,l,h,d),i.setEdgeVertexFromValuesRawPositionUVNormal(e,y,o,l,h,m,g,S,P,M),i.setEdgeVertexFromValuesRawPositionUVNormal(t,A,o,l,h,m,g,S,P,M)}}for(let Y=0;Y<4;++Y)nm[Y]=null}function Y_(e,t){const i=4*t,n=O_.reduce(((t,n)=>{var r,s;return Math.min(t,null!==(r=null===(s=e[i+n])||void 0===s?void 0:s.level)&&void 0!==r?r:1/0)}),1/0);np.T9&&((0,np.Fp)(!e[i+0]||!e[i+2]||e_(e[i+0],e[i+2],Mp.X.SOUTH_WEST)),(0,np.Fp)(!e[i+1]||!e[i+3]||e_(e[i+1],e[i+3],Mp.X.NORTH_WEST)));let r=0,s=0;for(let l=0;l<4;++l){const t=e[i+l];if(t&&t.level===n){var a;const e=0===l||1===l,i=0===l||3===l,n=t.extent;s+=ip(n[e?0:2],n[i?1:3],null===(a=t.renderData)||void 0===a||null===(a=a.geometryState)||void 0===a?void 0:a.samplerData),r++}}const o=r?s/r:0;return(0,np.Fp)(null!=o),o}function J_(e){const{vao:t,geometry:i}=e,{vertexAttributes:n,edgeVerticesStartIndex:r}=i,s=n.position.typedBuffer;t.vertexBuffers.geometry.setSubData(s,r,r,s.length)}function K_(e){const{vao:t,geometry:i}=e,{indices:n,indexCount:r,edgeIndicesStartIndex:s}=i;t.indexBuffer.setSubData(n,s,s,r)}class $_{constructor(e,t,i,n,r){this.isNorth=e,this.connectedRowOffset=t,this.connectedOuterEdgeOffset=i,this.rowOffset=n,this.latitudeResolution=r}}const em=[[0,1],[1,0],[0,-1],[-1,0]],tm=new class{constructor(){this.sinLonLUT=new Array(W.Cf+1),this.cosLonLUT=new Array(W.Cf+1),this.sinLatLUT=new Array(W.Cf+1),this.cosLatLUT=new Array(W.Cf+1)}update(e,t,i){const n=t[0],r=t[2];for(let s=0;s<=e;s++){const t=s/e,a=n*(1-t)+r*t;this.sinLonLUT[s]=Math.sin(a),this.cosLonLUT[s]=Math.cos(a);const o=i(t);this.sinLatLUT[s]=Math.sin(o),this.cosLatLUT[s]=Math.cos(o)}}},im=(0,L.al)(-1/0,-1/0,1/0,1/0),nm=[null,null,null,null];function rm(e,t,i){if(!t)return!1;const n=(0,Up.gl)(e,t);return n>0||0===n&&i>=2}class sm{constructor(){this.vertex0Index=0,this.stride=1,this.count=0}getVertexIndex(e){return(0,np.Fp)(0<=e&&e<this.count),this.vertex0Index+this.stride*e}}const am=[new sm,new sm,new sm,new sm];function om(e,t,i,n){e<n[0]?n[0]=e:e>n[3]&&(n[3]=e),t<n[1]?n[1]=t:t>n[4]&&(n[4]=t),i<n[2]?n[2]=i:i>n[5]&&(n[5]=i)}function lm(e){const{edgeResolutions:t,numVerticesPerSide:i}=e,n=1+Math.max(...t);return Math.max(i,n)}function hm(e,t,i,n,r,s){const a=e*r,o=s[a],l=s[a+1],h=s[a+2],c=t*r,d=s[c],u=s[c+1],p=s[c+2],_=i*r,m=s[_],g=s[_+1],f=s[_+2],v=n*r,y=s[v],b=s[v+1],w=s[v+2];return(d-y)*(d-y)+(u-b)*(u-b)+(p-w)*(p-w)>(o-m)*(o-m)+(l-g)*(l-g)+(h-f)*(h-f)}function cm(e,t,i,n,r){e[t]=i,e[t+1]=n,e[t+2]=n,e[t+3]=r,e[t+4]=r,e[t+5]=i}const dm=6;var um=i(42235);class pm extends Zp{constructor(e,t,i,n,r){super(),this._horizontalScaleFactor=1,this._extentInRenderSR=(0,L.Ue)(),this._baseUsedMemory=900,this._subtreeGeometryElevationBoundMin=0,this._subtreeGeometryElevationBoundMax=0,this.init(e,t,i,n,r)}init(e,t,i,n,r){super.init(e,t,i,n,r);const s=r.view.renderSpatialReference,a=r.spatialReference,o=null!=s&&(0,ke.QM)(s)&&null!=a&&a.isGeographic?this.ellipsoid.radius*Math.PI/180:1;this._horizontalScaleFactor=o;const{isWebMercatorOnPlateCarree:l}=r,h=this._extentInRenderSR,c=this.extent;if(l){const e=(0,R.al)(c[0],c[1],0);(0,Wu.S)(e,k.Z.WebMercator,e,k.Z.PlateCarree);const t=(0,R.al)(c[2],c[3],0);(0,Wu.S)(t,k.Z.WebMercator,t,k.Z.PlateCarree),h[0]=e[0],h[1]=e[1],h[2]=t[0],h[3]=t[1]}else for(let d=0;d<4;++d)h[d]=c[d]*o;this.centerAtSeaLevel[0]=.5*(h[0]+h[2]),this.centerAtSeaLevel[1]=.5*(h[1]+h[3]),this.centerAtSeaLevel[2]=0,this._edgeLen=Math.max(h[2]-h[0],h[3]-h[1]),this._edgeLen2=this._edgeLen*this._edgeLen,this.updateRadiusAndCenter()}updateRadiusAndCenter(){this._updateCenter();const e=this._extentInRenderSR,t=.5*(e[2]-e[0]),i=.5*(e[3]-e[1]),n=Math.sqrt(t*t+i*i),r=.5*(this.elevationBoundsMax-this.elevationBoundsMin),s=Math.max(n,r);this._center[Jp.MIDDLE][3]=s}_calculateFrustumVisibilityStatus(e){const t=this._aabb(),i=t[0],n=t[1],r=t[2],s=t[3],a=t[4],o=t[5];let l=!0;for(let h=0;h<6;h++){const t=e[h],c=t[0],d=t[1],u=t[2],p=t[3];if(c*(c>0?i:s)+d*(d>0?n:a)+u*(u>0?r:o)+p>=0)return qp.OUTSIDE;l=l&&c*(c<0?i:s)+d*(d<0?n:a)+u*(u<0?r:o)+p<=0}return l?qp.INSIDE:qp.INTERSECTS}_aabb(){const e=this._extentInRenderSR;return(0,Pp.re)(e[0],e[1],Math.min(this.elevationBoundsMin,this._subtreeGeometryElevationBoundMin),e[2],e[3],Math.max(this.elevationBoundsMax,this._subtreeGeometryElevationBoundMax))}intersectsRay(e,t,i,n){return _m[0]=1/t[0],_m[1]=1/t[1],_m[2]=1/t[2],(0,um.Fw)(this._aabb(),e,_m,i,n)}createGeometry(){F_(this.renderData,this._horizontalScaleFactor),this._updateSubtreeGeometryElevationsBounds(),this.setMemoryDirty()}_updateSubtreeGeometryElevationsBounds(){const e=this._subtreeGeometryElevationBoundMin,t=this._subtreeGeometryElevationBoundMax,i=this.renderData;let n=e,r=t;if(i){const e=i.geometry.boundingBox;n=e[2],r=e[5]}else if(!this.isLeaf){n=1/0,r=-1/0;for(const e of this.children)n=Math.min(n,e._subtreeGeometryElevationBoundMin),r=Math.max(r,e._subtreeGeometryElevationBoundMax)}if(n!==this._subtreeGeometryElevationBoundMin||r!==this._subtreeGeometryElevationBoundMax){this._subtreeGeometryElevationBoundMin=n,this._subtreeGeometryElevationBoundMax=r;const e=this.parent;null===e||void 0===e||e._updateSubtreeGeometryElevationsBounds()}}getDefaultVerticesPerSide(){return this.level<9?3:2}updateCornerElevations(){(function(e,t){e.tile.intersectsClippingArea&&(z_(e),q_(e,!0),J_(e),e.intersectionData=null)})(this.renderData,this._horizontalScaleFactor),this._updateSubtreeGeometryElevationsBounds()}updateEdgeElevations(){(function(e,t){e.tile.intersectsClippingArea&&(V_(e),J_(e),e.intersectionData=null)})(this.renderData,this._horizontalScaleFactor),this._updateSubtreeGeometryElevationsBounds()}updateEdgeElevationsAndResolutions(){(function(e,t){e.tile.intersectsClippingArea&&(W_(e),V_(e),J_(e),K_(e),e.intersectionData=null)})(this.renderData,this._horizontalScaleFactor),this._updateSubtreeGeometryElevationsBounds()}get horizontalScale(){return this._horizontalScaleFactor}}const _m=(0,R.Ue)();var mm=i(82394);class gm{constructor(){this.extent=(0,Ye.Ue)(),this.minLevel=0,this.maxLevel=0,this.callback=null}}let fm=class extends T.default{constructor(){super(...arguments),this._queries=new pl.Z({initialSize:10}),this._queriesInvPtr=0,this._queryQueue=new pl.Z({initialSize:30}),this._queryPool=new rh.Z(gm)}queryVisibleLevelRange(e,t,i,n){const r=this._queryPool.acquire();(0,Qe.c)(r.extent,e),r.minLevel=null!==t&&void 0!==t?t:-Number.MAX_VALUE,r.maxLevel=null!==i&&void 0!==i?i:Number.MAX_VALUE,r.callback=n,this._queryQueue.push(r),this.notifyChange("updating")}get updating(){return 0!==this._queryQueue.length}prepare(){for(;this._queries.length<this._queries.data.length&&this._queryQueue.length>0;){const e=this._queryQueue.pop();this._queries.push(e)}this._queriesInvPtr=this._queries.length}process(){for(let e=0;e<this._queries.length;e++){const t=this._queries.data[e];this._queryPool.release(t),t.callback(e>=this._queriesInvPtr),t.callback=null}this._queries.clear(),this.notifyChange("updating")}queriesForTile(e){const t=e.level;let i=0;for(;i<this._queriesInvPtr;){const n=this._queries.data[i],r=n.extent;t>=n.minLevel&&t<=n.maxLevel&&r[0]<=e.extent[2]&&r[2]>=e.extent[0]&&r[1]<=e.extent[3]&&r[3]>=e.extent[1]?(this._queries.swapElements(i,this._queriesInvPtr-1),this._queriesInvPtr--):i++}}};(0,n._)([(0,b.Cb)()],fm.prototype,"updating",null),fm=(0,n._)([(0,C.j)("esri.views.3d.terrain.ScaleRangeQueries")],fm);var vm=i(86372);class ym extends Zp{constructor(e,t,i,n,r){super(),this._convexHull=new Array(24),this._boundingSphere=(0,bn.c)(),this._baseUsedMemory=1816,this.init(e,t,i,n,r)}init(e,t,i,n,r){super.init(e,t,i,n,r);const s=this.ellipsoid.radius,a=this.extentInRadians[0],o=this.extentInRadians[1],l=this.extentInRadians[2],h=this.extentInRadians[3],c=(0,me.t7)(o,h,.5),d=(0,me.t7)(a,l,.5),u=0===e?0:Math.min(Math.abs(o),Math.abs(h));this._edgeLen=(l-a)*Math.cos(u)*s,this._edgeLen2=this._edgeLen*this._edgeLen,this._curvatureHeight=s-Math.sqrt(s*s-this._edgeLen2/4),function(e,t,i,n){const r=Math.cos(i);e[0]=Math.cos(t)*r*n,e[1]=Math.sin(t)*r*n,e[2]=Math.sin(i)*n}(this.centerAtSeaLevel,d,c,this.ellipsoid.radius),(0,Ge.n)(this.up,this.centerAtSeaLevel),this.updateRadiusAndCenter()}updateRadiusAndCenter(){this._updateBoundingVolumes();const e=this._center;if(0===this.lij[0])(0,Ge.s)((0,bn.g)(e[Jp.MIDDLE]),0,0,0),(0,Ge.s)(e[Jp.TOP],0,0,0),(0,Ge.s)(e[Jp.BOTTOM],0,0,0),e[Jp.MIDDLE][3]=this.ellipsoid.radius+this.elevationBoundsMax;else{this._updateCenter();const t=e[Jp.MIDDLE],i=this.convexHull;let n=0;for(let e=0;e<8;++e)n=Math.max(n,wm((0,bn.g)(t),i,3*e));e[Jp.MIDDLE][3]=Math.sqrt(n)}}_calculateFrustumVisibilityStatus(e){if(!(0,ih.hr)(e,this._boundingSphere))return qp.OUTSIDE;if(this.lij[0]<10)return qp.INTERSECTS;const t=this.convexHull,i=this.surface.view.state.camera.near;let n=!0;for(let r=0;r<ih.N9;r++){const s=r===ih.Nu.NEAR,a=e[r],o=a[0],l=a[1],h=a[2],c=a[3]-(s?i:0);let d=!1;for(let e=0;e<8;++e){const i=3*e;if(o*t[i]+l*t[i+1]+h*t[i+2]+c<0){if(d=!0,!n)break}else n=!1}if(!d)return qp.OUTSIDE}return n?qp.INSIDE:qp.INTERSECTS}computeElevationBounds(){super.computeElevationBounds(),this._updateBoundingVolumes()}createGeometry(){D_(this.renderData,this._getPatchType()),this._updateBoundingVolumes(),this.setMemoryDirty()}_updateBoundingVolumes(){this._updateConvexHull(),this._updateBoundingSphere(),np.T9&&this._checkBVs()}_updateBoundingSphere(){const e=this._boundingSphere,t=(0,bn.g)(e),i=this.elevationBoundsMin,n=this.elevationBoundsMax,r=this.ellipsoid.radius,s=n;if(0===this.level)(0,Ge.s)(t,0,0,0),e[3]=r+s;else{const s=this.extentInRadians,a=.5*(s[0]+s[2]),o=s[1],l=s[3];xm(Sm,a,o,r),xm(Pm,a,l,r),(0,Ge.g)(t,Sm,Pm),(0,Ge.j)(t,t,(r+.5*(i+n))/(0,Ge.H)(t));const h=this.convexHull;let c=0;const d=(e,t)=>{const i=e[0]-h[3*t],n=e[1]-h[3*t+1],r=e[2]-h[3*t+2];return Math.sqrt(i*i+n*n+r*r)};for(let e=0;e<8;++e){const i=d(t,e);c=Math.max(c,i)}const u=c;e[3]=u+2}}_updateConvexHull(){const e=this.extentInRadians,t=this.ellipsoid.radius;if(0===this.level)return;const i=this.elevationBoundsMin,n=this.elevationBoundsMax,r=this._getPatchType(),s=this.surface.isWebMercator,a=s&&r===lp.tk.HAS_NORTH_POLE,o=s&&r===lp.tk.HAS_SOUTH_POLE,l=o||a,h=Math.PI/2,c=e[0],d=e[2],u=o?-h:e[1],p=a?h:e[3],_=.5*(c+d),m=i,g=t+(l?Math.min(0,m-1):m),f=(e,t,i)=>xm(e,t,i,g),v=(0,R.Ue)(),y=(0,R.Ue)(),b=(0,R.Ue)(),w=(0,R.Ue)();f(v,c,u),f(y,c,p),f(b,d,p),f(w,d,u);const C=(e,t)=>{for(let i=0;i<3;++i)this._convexHull[3*t+i]=e[i]};C(v,0),C(y,1),C(b,2),C(w,3);const x=n,T=t+(l?Math.max(0,x+1):x),S=(0,R.Ue)(),P=(0,R.Ue)(),M=(0,R.Ue)();xm(P,_,p,g),xm(M,_,u,g),(0,Ge.g)(S,P,M),(0,Ge.n)(S,S);const A=(0,R.Ue)(),O=(0,R.Ue)(),E=(e,t)=>{(0,Ge.z)(O,e,t),(0,Ge.n)(O,O);const i=-(0,Ge.m)(e,A)/(0,Ge.m)(O,A);(0,np.Fp)(i>=0),(0,Ge.j)(O,O,i),(0,Ge.g)(e,e,O)};if(2**this.lij[0]>2*this.lij[1]){const e=M,t=(0,R.Ue)();(0,Ge.b)(t,Tm,e),(0,Ge.n)(t,t),(0,Ge.b)(A,e,t),(0,Ge.n)(A,A),(0,np.Fp)((0,np.Wq)((0,Ge.m)(A,e)/(0,Ge.H)(e),0)),E(v,y),E(w,b),C(v,0),C(w,3)}else if(2**this.lij[0]!==2*this.lij[1]){const e=P,t=(0,R.Ue)();(0,Ge.b)(t,Tm,e),(0,Ge.n)(t,t),(0,Ge.b)(A,t,e),(0,Ge.n)(A,A),E(y,v),E(b,w),C(y,1),C(b,2)}const D=(e,t)=>{const i=T/(0,Ge.m)(t,S);for(let n=0;n<3;++n)this._convexHull[3*e+n]=t[n]*i};D(4,v),D(5,y),D(6,b),D(7,w)}_getPatchType(){const e=this.lij[1],t=0===e,i=e===(1<<this.level)-1;return t?i?lp.tk.HAS_BOTH_POLES:lp.tk.HAS_NORTH_POLE:i?lp.tk.HAS_SOUTH_POLE:lp.tk.REGULAR}intersectsRay(e,t,i,n){const r=this._boundingSphere,s=r[3]+i,a=t[0]*t[0]+t[1]*t[1]+t[2]*t[2],o=r[0]-e[0],l=r[1]-e[1],h=r[2]-e[2],c=(o*t[0]+l*t[1]+h*t[2])/a,d=t[0]*c-o,u=t[1]*c-l,p=t[2]*c-h;return d*d+u*u+p*p<s*s}getDefaultVerticesPerSide(){return this.level<bm.length?bm[this.level]+1:2}updateCornerElevations(){(function(e){e.tile.intersectsClippingArea&&(N_(e),L_(e,!0),J_(e),e.intersectionData=null)})(this.renderData),this._updateBoundingVolumes()}updateEdgeElevations(){(function(e){e.tile.intersectsClippingArea&&(I_(e),J_(e),e.intersectionData=null)})(this.renderData),this._updateBoundingVolumes()}updateEdgeElevationsAndResolutions(){(function(e){e.tile.intersectsClippingArea&&(W_(e),I_(e),J_(e),K_(e),e.intersectionData=null)})(this.renderData),this._updateBoundingVolumes()}_checkBVs(){var e;if(!np.T9)return;if(this.level<=2)return;const t=this._boundingSphere,i=t[3],n=(0,bn.g)(t),r=(0,R.Ue)(),s=this.ellipsoid.radius,a=this.elevationBoundsMin,o=this.elevationBoundsMax,l=s+a,h=this._center[Jp.MIDDLE][3],c=this.convexHull,d=(e,t)=>{for(let i=0;i<3;++i)e[i]=c[3*t+i]};{const e=(0,R.Ue)(),t=(0,R.Ue)(),i=(0,R.Ue)(),n=(0,R.Ue)(),r=(0,R.Ue)(),s=(s,a,o,l)=>{d(t,s),d(i,a),d(n,o),(0,Ge.z)(t,t,i),(0,Ge.z)(n,n,i),(0,Ge.b)(e,t,n),(0,Ge.n)(e,e);const h=(0,Ge.m)(e,i);d(r,l);const c=(0,Ge.m)(e,r),u=Math.abs(c-h);(0,np.Fp)((0,np.Wq)(u,0),"Non coplanar ".concat(s,",").concat(a,",").concat(o,",").concat(l," diff = ").concat(u))};s(0,1,2,3),s(4,5,6,7),s(0,1,4,5),s(1,2,5,6),s(2,3,6,7),s(3,0,7,4)}const u=(0,vm.bg)(24),p=(0,R.Ue)(),_=(0,R.Ue)(),m=(0,R.Ue)(),g=(0,R.Ue)(),f=(e,t,i,n)=>{d(p,t),d(_,i),d(m,n),(0,Ge.z)(p,p,_),(0,Ge.n)(p,p),(0,Ge.z)(m,m,_),(0,Ge.n)(m,m),(0,Ge.b)(g,p,m),(0,Ge.n)(g,g);const r=(0,Ge.m)(g,_);((e,t,i)=>{const n=4*e;for(let r=0;r<3;++r)u[n+r]=t[r];u[n+3]=i})(e,g,r)};f(0,0,1,2),f(1,1,0,4),f(2,1,5,2),f(3,3,2,6),f(4,4,0,3),f(5,4,6,5);const v=(e,t,i,n)=>{const r=4*e;return u[r]*t+u[r+1]*i+u[r+2]*n-u[r+3]},y=(e,t,i,n)=>v(e,t,i,n)>=-1,b=(e,t)=>y(e,t[0],t[1],t[2]),w=2**this.lij[0]>2*this.lij[1],C=(e,t,r)=>Math.sqrt(Cm(e,t,r,n[0],n[1],n[2]))<i,x=e=>C(e[0],e[1],e[2]),T=(e,t)=>C(e[t],e[t+1],e[t+2]),S=this.extentInRadians,P=.5*(S[0]+S[2]),M=S[1],A=S[3],O=(0,R.Ue)(),E=(0,R.Ue)();xm(O,P,A,l),xm(E,P,M,l);const D=w?"Upper":"Lower";let I=!0;for(let R=0;R<6;++R){for(let e=0;e<8;++e){const t=3*e,i=y(R,c[t],c[t+1],c[t+2]);I&&(I=i),(0,np.Fp)(i,"Tile[".concat(this.lij,"] Convex hull point ").concat(e," outside of plane ").concat(R))}(0,np.Fp)(b(R,E),"Tile[".concat(this.lij,"] (").concat(D,") bottom mid outside of plane ").concat(R)),(0,np.Fp)(b(R,O),"Tile[".concat(this.lij,"] (").concat(D,") top mid outside of plane ").concat(R))}(0,np.Fp)(I,"Not all convex hull points are inside  convex hull polyhedron"),(0,np.Fp)(x(E),"Tile[".concat(this.lij,"] (").concat(D,") bottom mid outside of bounding sphere")),(0,np.Fp)(x(O),"Tile[".concat(this.lij,"] (").concat(D,") top mid outside of bounding sphere"));for(let R=0;R<8;++R){const e=T(c,3*R);(0,np.Fp)(e,"Tile[".concat(this.lij,"] Convex hull point ").concat(R," outside of bounding sphere"))}for(let R=0;R<6;++R)for(let e=0;e<8;++e){const t=3*e;y(R,c[t],c[t+1],c[t+2])||console.error("Tile[".concat(this.lij,"] Convex hull point ").concat(e," outside of plane ").concat(R))}const{extentInRadians:L}=this,N=Math.max(L[2]-L[0],L[3]-L[1]),U=Math.round(N*s),{renderData:H}=this;if(!H)return;const{geometry:F,geometryState:V,localOrigin:q}=H,z=null===(e=F.vertexAttributes)||void 0===e?void 0:e.position;if(!z)return;const B=(0,R.Ue)(),G=F.numVerticesPerSide-2,{indices:k,indexCount:Z,edgeVerticesStartIndex:j,poleVerticesStartIndex:W}=F;if(!k)return;const X=new Set;for(let R=0;R<Z;++R){const e=k[R];if(X.has(e))continue;X.add(e);const t=e<W,l=e>=j;let c=!1,d=-1;if(l){let t=j;for(let i=0;i<4;++i){const n=V.edgeResolutions[i];if(e===t||e===t+n-1){c=!0;break}if(t+=n,e<t){d=i;break}}}const u=l?V.edgePeerNeighbors[d]:null,p=l&&u&&(0,Up.gl)(this,u)>0;z.getVec(e,r),(0,Ge.g)(B,r,q);const _=(0,Ge.H)(B)-s;let m=0,g=!1;const f=a-_,b=_-o,w=f>1,C=b>1,x=w||C,T=()=>{const i=t?"internal":l&&!c?"edge":c?"corner":"pole";return"Tile[".concat(this.lij,"].vertex[").concat(e,"]:").concat(i)+(w?"(below)":C?"(above)":"")+(p?"(Neighbor)":"")},S=(0,Ge.F)(B,n);if(S>=i+0){const e=S-i;x||(console.error("".concat(T()," is out of the bounding sphere by ").concat(e.toFixed(0)," / ").concat(i.toFixed(0),"[tol=").concat(0,"] h=").concat(_.toFixed(0)," / [").concat(a.toFixed(0),"..").concat(o.toFixed(0),"] (").concat((e/i).toFixed(0),")")),g=!0)}for(let n=0;n<6;++n)if(!y(n,B[0],B[1],B[2])){const t=v(n,B[0],B[1],B[2]),r=e%G,s=(e-r)/G;0===n&&f||5===n&&b||(console.error("".concat(T()," (").concat(r,",").concat(s,")|").concat(G,"] is out of the bounding trapezoid plane ").concat(n," h=").concat(Math.round(_)," / [").concat(Math.round(a),"..").concat(Math.round(o),"] dist=").concat(Math.round(t)," radii = ").concat(Math.round(i),"/").concat(Math.round(h),"} : maxL = ").concat(U)),++m)}if(g||m>0)break}}get convexHull(){return this._convexHull}}const bm=[128,64,64,32,16,8,8,4];function wm(e,t,i){return Cm(e[0],e[1],e[2],t[i],t[i+1],t[i+2])}function Cm(e,t,i,n,r,s){const a=n-e,o=r-t,l=s-i;return a*a+o*o+l*l}const xm=(e,t,i,n)=>{const r=Math.cos(t),s=Math.sin(t),a=Math.cos(i),o=Math.sin(i);e[0]=n*a*r,e[1]=n*a*s,e[2]=n*o},Tm=[0,0,1],Sm=(0,R.Ue)(),Pm=(0,R.Ue)();let Mm=class extends T.default{constructor(){super(...arguments),this.fovX=0,this.fovY=0,this.relativeWidthLimit=0,this.relativeHeightLimit=0,this.maxLod=0,this.angledSplitBias=0,this.aboveGround=!0}};(0,n._)([(0,b.Cb)()],Mm.prototype,"fovX",void 0),(0,n._)([(0,b.Cb)()],Mm.prototype,"fovY",void 0),(0,n._)([(0,b.Cb)()],Mm.prototype,"relativeWidthLimit",void 0),(0,n._)([(0,b.Cb)()],Mm.prototype,"relativeHeightLimit",void 0),(0,n._)([(0,b.Cb)()],Mm.prototype,"maxLod",void 0),(0,n._)([(0,b.Cb)()],Mm.prototype,"angledSplitBias",void 0),(0,n._)([(0,b.Cb)()],Mm.prototype,"aboveGround",void 0),(0,n._)([(0,b.Cb)()],Mm.prototype,"frustum",void 0),Mm=(0,n._)([(0,C.j)("esri.views.3d.terrain.SplitLimits")],Mm);var Rm=i(25158),Am=i(92015);const Om=(0,ai.U$)().vec3f(hi.T.POSITION).vec2i16(hi.T.UV0).vec2i16(hi.T.NORMALCOMPRESSED,{glNormalized:!0});class Em{constructor(e){this._storage=new ju.N(((t,i)=>e.newCache(t,i)),"TileGeometry")}acquire(e){const t=4*Math.ceil(e/4),i=this._storage,n=function(e){return e.toString()}(t),r=i.pop(n);if(r)return r;const s=Om.createBuffer(t);return s.release=()=>i.put(n,s),s}clear(){this._storage.clear()}destroy(){this._storage.destroy()}}var Dm=i(35600);class Im extends ht.m{constructor(){super(...arguments),this.blendMode=Dm.iM.Normal}}(0,n._)([(0,ht.o)({count:Dm.iM.COUNT})],Im.prototype,"blendMode",void 0);var Lm=i(57017),Nm=i(8966),Um=i(25012);class Hm extends Im{constructor(){super(...arguments),this.output=Nm.l.Composite,this.baseOpacityMode=Lm.I.NotRequired,this.premultipliedSource=Um.m.Off}}(0,n._)([(0,ht.o)({count:Nm.l.COUNT})],Hm.prototype,"output",void 0),(0,n._)([(0,ht.o)({count:Lm.I.COUNT})],Hm.prototype,"baseOpacityMode",void 0),(0,n._)([(0,ht.o)()],Hm.prototype,"premultipliedSource",void 0);var Fm=i(32426),Vm=i(86868);class qm extends Fm.R{constructor(){super(...arguments),this.opacity=1,this.baseOpacity=1,this.texture=null,this.fboTexture=null,this.backgroundColor=R.AG}}class zm extends it.A{initializeProgram(e){return new rt.$(e.rctx,zm.shader.get().build(this.configuration),nt.i)}initializePipeline(){return(0,at.sm)({blending:(0,at.if)(st.zi.ONE,st.zi.ONE_MINUS_SRC_ALPHA),colorWrite:at.BK})}}zm.shader=new tt.J(Vm.B,(()=>i.e(96654).then(i.bind(i,96654))));class Bm extends Hm{constructor(){super(...arguments),this.background=Vm.a.BelowLayer}}(0,n._)([(0,ht.o)()],Bm.prototype,"background",void 0);class Gm{constructor(e,t,i,n,r,s){this.texture=e,this.type=t,e.retain(),this.offsetAndScale=(0,Ye.al)(i.offset[0],i.offset[1],i.scale,i.scale),this.opacities=(0,R.al)(n,r,s)}destroy(){this.texture.release()}}var km=i(39395),Zm=(i(37995),i(73828)),jm=(i(32344),i(85269),i(8768)),Wm=i(38684),Xm=i(42121),Qm=i(12463),Ym=i(36210),Jm=i(50127),Km=i(21391);const $m=(0,jm.Ue)();var eg=i(87071),tg=i(47566);class ig{constructor(){this._renderParams={reshuffleManager:new tg.y,context:null,drawPhase:1,state:new ng,stationary:!0,pixelRatio:1,displayLevel:-1,requiredLevel:-1,globalOpacity:1,renderPass:"background",styleLayer:null,styleLayerUID:-1,painter:null,glyphMosaic:null,spriteMosaic:null,profiler:null,renderingOptions:null,requestRender:null,allowDelayedRender:!1,deltaTime:-1,timeline:null,time:0,hasClipping:!1,blendMode:null,dataUploadCounter:0,effects:null,inFadeTransition:!1,requireFBO:!1,highlightGradient:null,stencilSymbols:!0,is3D:!0,backgroundColor:null},this._backgroundTile=new eg.H(new Zm.Z(0,0,0,0),0,0,0,512,512,4096,4096),this._heading=0,this._declutteredForHeading=new WeakMap}dispose(){this._renderParams=null}renderBackground(e,t,i,n,r,s,a,o,l,h){const c=this._backgroundTile;this._updateRenderParameters(e,t,c,i,r,s,a,o,l,h),this._renderParams.stencilSymbols=!1,i.drawBackground(this._renderParams,c,n)}renderContent(e,t,i,n,r,s,a,o,l,h,c,d){this._declutter(i),n.forAll((e=>this._declutter(e.sourceLayerInfo.data))),this._stencilSymbols(e,t,i,n,r,s,a,Math.round(1/o),l,h,c,d);let u=1;i.stencilRef=u++,e.setStencilFunction(st.wb.EQUAL,i.stencilRef,255),this._render(e,t,i,r,s,a,o,l,h,c,d),n.forAll((t=>{t.sourceLayerInfo.data.stencilRef=u++,this._renderSymbols(e,t.sourceLod,t.sourceLayerInfo.data,r,s,a,Math.round(1/o),t.offset,h,c,d)}))}_stencilSymbols(e,t,i,n,r,s,a,o,l,h,c,d){let u=1;i.stencilRef=u++,e.setDepthTestEnabled(!1),e.setDepthWriteEnabled(!1),e.setStencilTestEnabled(!0),e.setBlendingEnabled(!1),e.setColorMask(!1,!1,!1,!1),e.setStencilOp(st.xS.KEEP,st.xS.KEEP,st.xS.REPLACE),e.setStencilWriteMask(255),e.setStencilFunction(st.wb.ALWAYS,i.stencilRef,255),this._stencilTileSymbols(e,t,i,r,s,a,o,l,h,c,d);for(const p of n.toArray()){const{sourceLod:t,offset:i,sourceLayerInfo:n}=p;n.data.stencilRef=u++,e.setStencilFunction(st.wb.ALWAYS,n.data.stencilRef,255),this._stencilTileSymbols(e,t,n.data,r,s,a,o,i,h,c,d)}e.setStencilWriteMask(0),e.setBlendingEnabled(!0),e.setDepthTestEnabled(!0),e.setColorMask(!0,!0,!0,!0)}_renderSymbols(e,t,i,n,r,s,a,o,l,h,c){e.setStencilFunction(st.wb.EQUAL,i.stencilRef,255),this._render(e,t,i,n,r,s,a,o,l,h,c,Km.fR.SYMBOL)}_render(e,t,i,n,r,s,a,o,l,h,c,d){this._updateRenderParameters(e,t,i,n,s,a,o,l,h,c),this._renderParams.stencilSymbols=!1,n.drawTile(this._renderParams,i,r,d)}_stencilTileSymbols(e,t,i,n,r,s,a,o,l,h,c){this._updateRenderParameters(e,t,i,n,s,a,o,l,h,c),this._renderParams.stencilSymbols=!0,i.triangleCount=0,n.drawSymbols(this._renderParams,i,r)}_updateRenderParameters(e,t,i,n,r,s,a,o,l,h){"type"in i&&"vector-tile"===i.type&&!i.stage&&i.attachWithContext(e);const c=t[0]-r.getLevelShift(t[0]),d=this._renderParams;d.context=e,d.painter=n,d.glyphMosaic=n.glyphMosaic,d.spriteMosaic=n.spriteMosaic,d.pixelRatio=l*h,d.displayLevel=c,d.requiredLevel=c;const u=r.getScale(t[0]),[p,_]=r.getOffset(t,s*u),m=.125*s*u/o,g=i.transforms.displayViewScreenMat3;g[0]=m,g[4]=-m,g[6]=-1-p-a[0]*s*2,g[7]=1+_+(1-a[1])*s*2-2;const f=d.state,v=o/h;f.size[0]=v,f.size[1]=v,f.pixelRatio=h,f.rotation=(360-this._heading)%360;const y=2/v;(0,St.t8)(f.displayViewMat3,y,0,0,0,-y,0,-1,1,1);const b=(0,St.yR)(f.displayMat3),w=(0,Np.c$)(this._heading);(0,St.Iu)(b,b,[v/2,v/2]),(0,St.U1)(b,b,w),(0,St.Iu)(b,b,[-v/2,-v/2]),(0,St.Jp)(b,f.displayViewMat3,b)}updateHeading(e){this._heading=e}_declutter(e){this._declutteredForHeading.get(e)!==this._heading&&(function(e,t){const i=e.transforms.tileUnitsToPixels,n=(0,Np.c$)(t),r=Math.cos(n),s=Math.sin(n),a=Math.ceil(512*(Math.abs(s)+Math.abs(r)));(0,St.yR)($m),(0,St.Iu)($m,$m,[a/2,a/2]),(0,St.U1)($m,$m,n),(0,St.Iu)($m,$m,[-256,-256]),(0,St.bA)($m,$m,[1/8,1/8,1]),e.transforms.tileUnitsToPixels=$m;const o=[],l=new Ym.L(4096,o,(()=>new Wm.J)),h=new Qm.g(o,l,((i,n,r)=>new Xm.f(i,n,r,e.styleRepository,e.key.level,t)),((e,t)=>{(0,Jm.C$)(e,t,!1)}),(()=>0),(t=>{const i=e.styleRepository.getStyleLayerByUID(t).getLayoutProperty("visibility");return!i||i.getValue()!==Km.EE.NONE}));o.push(e),l.add(e),h.setScreenSize(a,a),h.continue(1/0),l.removeTile(e),e.transforms.tileUnitsToPixels=i}(e,(360-this._heading)%360),this._declutteredForHeading.set(e,this._heading))}}class ng{constructor(){this.size=[0,0],this.pixelRatio=1,this.rotation=0,this.displayMat3=(0,pr.Ue)(),this.displayViewMat3=(0,pr.Ue)(),this.transform=null,this.inverseTransform=null,this.viewMat2d=null,this.viewMat3=null,this.id=0,this.extent=null,this.center=null,this.scale=1,this.resolution=0,this.worldScreenWidth=0,this.spatialReference=null,this.viewpoint=null,this.getScreenTransform=null,this.toMap=null,this.toScreen=null,this.clone=null,this.copy=null,this.toJSON=null}}var rg=i(87016);class sg extends it.A{initializeProgram(e){return new rt.$(e.rctx,sg.shader.get().build(this.configuration),nt.i)}initializePipeline(){return(0,at.sm)({blending:(0,at.if)(st.zi.ONE,st.zi.ONE_MINUS_SRC_ALPHA),colorWrite:at.BK})}}sg.shader=new tt.J(rg.R,(()=>i.e(11454).then(i.bind(i,11454))));class ag extends Hm{constructor(){super(...arguments),this.colorizerType=km.U.Stretch,this.stretchType=km.H.Noop,this.applyColormap=!0,this.requireBilinearWithNN=!1}}(0,n._)([(0,ht.o)({count:km.U.COUNT})],ag.prototype,"colorizerType",void 0),(0,n._)([(0,ht.o)({count:km.H.COUNT})],ag.prototype,"stretchType",void 0),(0,n._)([(0,ht.o)()],ag.prototype,"applyColormap",void 0),(0,n._)([(0,ht.o)()],ag.prototype,"requireBilinearWithNN",void 0);var og=i(3479);class lg{constructor(e){this._rctx=e,this._fbos=new Map}get(e){return this._getPool(e)}dispose(){this._fbos.forEach((e=>e.dispose())),this._fbos.clear()}_getPool(e){const t=this._fbos.get(e);if(t)return t;const i=new Ft.X(this._rctx,new Vt.X(e),new og.Y(st.Tg.DEPTH24_STENCIL8,e));return this._fbos.set(e,i),i}}class hg{constructor(e,t){this._rctx=e,this._techniques=t,this._fbos=[],this._vectorTileHelper=new ig,this._bindParameters=new zt.p(null,null),this._blendLayersTechniqueConfig=new Bm,this._current=0,this._lastUsedIds=new Array,this._lastCreatedBufferId=0,this._onHoldIds=new Array,this._vaoQuad=(0,_t.o)(this._rctx,pt.Bn)}dispose(){this._fbos.forEach(p.M2),this._fbos=null,this._vtFBO=(0,p.M2)(this._vtFBO),this._vaoQuad=(0,p.M2)(this._vaoQuad),this._vectorTileHelper=(0,p.M2)(this._vectorTileHelper),this._backgroundTechnique=(0,p.RY)(this._backgroundTechnique),this._applyOpacityTechnique=(0,p.RY)(this._applyOpacityTechnique),this._blendLayersTechnique=(0,p.RY)(this._blendLayersTechnique)}updateHeading(e){var t;null===(t=this._vectorTileHelper)||void 0===t||t.updateHeading(e)}_getBlendLayersTechnique(e,t,i){let n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:Um.m.Off,r=arguments.length>4&&void 0!==arguments[4]?arguments[4]:Vm.a.BelowLayer;return this._blendLayersTechniqueConfig.output=t,this._blendLayersTechniqueConfig.blendMode=e,this._blendLayersTechniqueConfig.baseOpacityMode=i,this._blendLayersTechniqueConfig.premultipliedSource=n,this._blendLayersTechniqueConfig.background=r,this._blendLayersTechnique=this._techniques.releaseAndAcquire(zm,this._blendLayersTechniqueConfig,this._blendLayersTechnique),this._blendLayersTechnique}drawBackground(e,t){const i=this._getBlendLayersTechnique(Dm.iM.Normal,t?Nm.l.ColorComposite:Nm.l.GridComposite,Lm.I.NotRequired,Um.m.Off,Vm.a.Only),n=this._rctx.bindTechnique(i,this._bindParameters,e);this._render(n)}_render(e){this._rctx.bindVAO(this._vaoQuad),e.assertCompatibleVertexAttributeLocations(this._vaoQuad),this._rctx.drawArrays(st.MX.TRIANGLE_STRIP,0,(0,ui._V)(this._vaoQuad,"geometry"))}drawGroup(e,t,i,n){let r=arguments.length>4&&void 0!==arguments[4]?arguments[4]:Um.m.On;t===Nm.l.Composite&&(e.fboTexture=this._fbos[this.getLastOnHoldId()].get(i).colorTexture),e.texture=this.currentFBO(i).colorTexture,this.closeGroup(i);const s=e.baseOpacity<1?Lm.I.Required:Lm.I.NotRequired,a=this._getBlendLayersTechnique(n,t,s,r),o=this._rctx.bindTechnique(a,this._bindParameters,e);this._render(o)}drawImageData(e,t,i,n){let r=arguments.length>4&&void 0!==arguments[4]?arguments[4]:Um.m.Off;if(null==e.texture)return;const s=e.baseOpacity<1?Lm.I.Required:Lm.I.NotRequired;e.fboTexture=t===Nm.l.GroupBackgroundComposite||n===Dm.iM.Normal&&s===Lm.I.NotRequired&&r===Um.m.Off?null:this.switch(i).colorTexture;const a=this._getBlendLayersTechnique(n,t,s,r),o=this._rctx.bindTechnique(a,this._bindParameters,e);this._render(o)}drawRasterData(e,t,i,n,r){const s=r.sourceLayerInfo.data;if(!s.source)return;if(r.tile.surface.layerViewByIndex(r.layerIndex,pd.MAP).ensureSymbolizerParameters(s),!s.bind(this._rctx))return;const a=e.baseOpacity<1?Lm.I.Required:Lm.I.NotRequired;e.fboTexture=n===Dm.iM.Normal&&a===Lm.I.NotRequired?null:this.switch(i).colorTexture;const o=this._getRasterColorizerTechnique(s,t,n,a);s.opacity=e.opacity;const l=s.getUniforms();l.scale=r.scale,l.offset=r.offset,l.backgroundColor=e.backgroundColor,l.fboTexture=e.fboTexture,l.baseOpacity=e.baseOpacity;const h=this._rctx.bindTechnique(o,null,l);this._render(h)}_getRasterColorizerTechnique(e,t,i,n){const r=e.symbolizerParameters,s=["stretch","lut","hillshade"].indexOf(r.type);return null==this._rasterColorizerConfig&&(this._rasterColorizerConfig=new ag,this._rctx.gl.getExtension("WEBGL_color_buffer_float"),this._rctx.gl.getExtension("OES_texture_float")),this._rasterColorizerConfig.output=t,this._rasterColorizerConfig.blendMode=i,this._rasterColorizerConfig.baseOpacityMode=n,this._rasterColorizerConfig.colorizerType=s,this._rasterColorizerConfig.applyColormap=!!r.colormap,this._rasterColorizerConfig.requireBilinearWithNN=e.isBilinearWithStretchColorRamp,this._rasterColorizerConfig.stretchType=e.hasStretchTypeNone()?km.H.Noop:km.H.PerBand,this._rasterColorizerTechnique=this._techniques.releaseAndAcquire(sg,this._rasterColorizerConfig,this._rasterColorizerTechnique),this._rasterColorizerTechnique}drawVectorData(e,t,i,n,r,s,a,o){const l=this._rctx,h=r.sourceLayerInfo.data,c=r.tile.surface.layerViewByIndex(r.layerIndex,pd.MAP),d=e.baseOpacity<1?Lm.I.Required:Lm.I.NotRequired,p=d===Lm.I.Required||e.opacity<1||n!==Dm.iM.Normal||t!==Nm.l.Composite,_=p?Um.m.On:Um.m.Off,m=this._getBlendLayersTechnique(n,t,d,_);l.setPipelineState(m.getPipeline());let g=null,f=null;p?(f=this.currentFBO(i),null==this._vtFBO&&(this._vtFBO=new lg(this._rctx)),g=this._vtFBO.get(i),l.bindFramebuffer(g),this._clearCurrentFBO()):o&&l.clear(st.lk.DEPTH_BUFFER_BIT);try{this._vectorTileHelper.renderBackground(l,r.sourceLod,c.painter,c.layer.styleRepository,c.schemaHelper,Math.round(1/r.scale),r.offset,a,s,c.contentZoom),h&&this._vectorTileHelper.renderContent(l,r.sourceLod,h,r.vtlNeighborInfos,c.painter,c.layer.styleRepository,c.schemaHelper,Math.round(1/r.scale),r.offset,a,s,c.contentZoom)}catch(v){u.Z.getLogger("esri.views.3d.terrain").warnOnce("A render call containing vector tiles did not resolve correctly.",v)}return null==g||(l.bindFramebuffer(f),e.texture=g.colorTexture,e.offset=Ke.AG,e.scale=1,this.drawImageData(e,t,i,n,_),o)}copyFBOToTexture(e){const t=this._rctx,i=t.bindTexture(e.texture,di.x.TEXTURE_UNIT_FOR_UPDATES),n=e.descriptor;t.gl.copyTexImage2D(st.No.TEXTURE_2D,0,n.pixelFormat,0,0,n.width,n.height,0),e.generateMipmap(),t.bindTexture(i,di.x.TEXTURE_UNIT_FOR_UPDATES)}_clearCurrentFBO(){this._rctx.setStencilWriteMask(255),this._rctx.setClearColor(0,0,0,0),this._rctx.setClearDepth(1),this._rctx.setClearStencil(0),this._rctx.clear(st.lk.COLOR_BUFFER_BIT|st.lk.DEPTH_BUFFER_BIT|st.lk.STENCIL_BUFFER_BIT)}_initFBO(e,t,i){this._rctx.bindFramebuffer(e),i&&(this._rctx.setViewport(0,0,t,t),this._clearCurrentFBO())}ensureBuffer(e){this._lastUsedIds.length=0,this._lastUsedIds.push(1),this._lastCreatedBufferId=1,this._onHoldIds.length=0,this.bind(e)}bind(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,i=!(arguments.length>2&&void 0!==arguments[2])||arguments[2];if(this._current=t,t>=this._fbos.length)for(let n=this._fbos.length;n<=t;n++)this._fbos.push(new lg(this._rctx));this._initFBO(this._fbos[t].get(e),e,i)}_bindNextFreeBuffer(e){this._lastUsedIds.length>0?this.bind(e,this._lastUsedIds.pop()):(this._lastCreatedBufferId++,this.bind(e,this._lastCreatedBufferId))}openGroup(e){this._onHoldIds.push(this._current),this._bindNextFreeBuffer(e)}switch(e){const t=this.currentFBO(e),i=this._current;return this._bindNextFreeBuffer(e),this._lastUsedIds.push(i),t}getLastOnHoldId(){return this._onHoldIds[this._onHoldIds.length-1]}closeGroup(e){const t=this._current;this._bindNextFreeBuffer(e),this._lastUsedIds.push(t),this._lastUsedIds.push(this._onHoldIds.pop())}unbind(){this._rctx.bindFramebuffer(null)}currentFBO(e){return this._fbos[this._current].get(e)}}class cg{constructor(){this.sourceLayerInfo=null,this.sourceLod=[0,0,0],this.offset=[-1,0]}}class dg{constructor(e,t){this._texture=e,this._cache=t,this.type="tile-texture",this._refCount=1}retain(){++this._refCount}release(){if(--this._refCount,0===this._refCount)if(this._cache){const e="".concat(this._texture.descriptor.width," ").concat(this._texture.descriptor.pixelFormat);this._cache.put(e,this)}else this.dispose()}dispose(){this._texture.dispose()}get texture(){return this._texture}generateMipmap(){this._texture.generateMipmap()}get descriptor(){return this._texture.descriptor}get usedMemory(){return this._texture.usedMemory}}class ug{constructor(e,t,i,n,r,s){this.start=e,this.end=t,this.blendMode=i,this.opacity=n,this.output=r,this.baseOpacity=s}}class pg{constructor(e,t,i,n){this._rctx=e,this.tileSize=t,this._techniques=i,this._cache=n,this._passParameters=new qm,this._backgroundTexture=null,this._backgroundColor=null,this._backgroundDirty=!1,this._maxAnisotropy=this._rctx.parameters.maxMaxAnisotropy,this._compositor=new hg(this._rctx,this._techniques),this._ensureBackgroundTexture(this.tileSize)}dispose(){this._compositor=(0,p.M2)(this._compositor),this._backgroundTexture=(0,p.RY)(this._backgroundTexture)}get backgroundIsGrid(){return null==this._backgroundColor}get backgroundColor(){return this._backgroundColor}updateHeading(e){var t;null===(t=this._compositor)||void 0===t||t.updateHeading(e)}updateTileTexture(e,t){if(!e.renderData)return;const i=e.surface,n=i.baseOpacity;let r=0,s=0,a=this.tileSize,o=!1,l=!1;const h=i.view.state.contentPixelRatio;let c=!1;yg.clear(),bg.length=0;const d=e.layerInfo[pd.MAP];let u=0,p=null;for(;u<d.length;u++){const t=i.layerViewByIndex(u,pd.MAP),_=t.layer.opacity,m=t.fullOpacity;if(l=l||(0,F.sy)(t.layer),(0,np.TK)(t)){let e="normal"!==t.layer.blendMode;if((0,F.CY)(t.layer.parent)){const i=mg(t.layer.parent);null!=i&&""!==i&&(e=fg(t.layer.parent)||e)}e&&(c=e,o=!1)}if(0===_&&!c){d[u].pendingUpdates&=~(kp.TEXTURE_NOFADING&kp.TEXTURE_FADING);continue}++s;const g=(0,np.Q)(t),f=_g(e,u,g);if(f){if(d[u].pendingUpdates&=~(kp.TEXTURE_NOFADING&kp.TEXTURE_FADING),(0,F.CY)(t.layer.parent)){const e=mg(t.layer.parent);null!=e&&""!==e&&vg(t.layer.parent,u)}g?a=Math.max(a,this.tileSize*h):1===n&&1===m&&(t.isOpaque||this._dataToTexture(f)&&f.sourceLayerInfo.data.descriptor.isOpaque)&&(o=!0),++r,null===p&&(p=u)}}const _=a/this.tileSize,m=this._ensureBackgroundTexture(this.tileSize);0!==r&&null!==p?1===r&&!c&&this._useLayerTexture(e,p)||this._composeLayers(e,t,u-1,l,a,_,!o||c,yg,c):function(e,t,i,n){const r=e.renderData,s=!n&&null!=r.textureReference&&(e.surface.view.layerViewManager.updating||t>0)?Lp.Delayed:Lp.Immediate;r.setTextureReference(new Gm(i,lp.Ns.FADING,Cg,e.surface.baseOpacity,0,1),s)}(e,s,m,t!==lp.Ns.FADING)}_ensureBackgroundTexture(e){return null==this._backgroundTexture&&(this._backgroundTexture=this._buildTexture(e,!1),this._backgroundDirty=!0),this._backgroundDirty&&(this._compositor.bind(e),this._passParameters.offset=Ke.AG,this._passParameters.scale=1,this._passParameters.opacity=1,this.backgroundColor&&(this._passParameters.backgroundColor=this.backgroundColor),this._compositor.drawBackground(this._passParameters,null!=this.backgroundColor),this._compositor.copyFBOToTexture(this._backgroundTexture),this._compositor.unbind(),this._backgroundDirty=!1),this._backgroundTexture}_useLayerTexture(e,t){const i=e.surface.layerViewByIndex(t,pd.MAP),n=(0,F.sy)(i.layer),r=n?e.surface.baseOpacity:1,s=n?1:e.surface.baseOpacity,a=i.fullOpacity,o=_g(e,t,!1);return!!this._dataToTexture(o)&&(e.renderData.setTextureReference(new Gm(o.sourceLayerInfo.data,lp.Ns.FADING,o,r,s,a)),!0)}_composeLayers(e,t,i,n,r,s,a,o,l){this._compositor.ensureBuffer(r);const h=e.surface.baseOpacity;let c=!1,d=st.cw.LINEAR_MIPMAP_LINEAR,u=!1,p=0;for(let f=i;f>=0;f--){const t=e.surface.layerViewByIndex(f,pd.MAP),i=(0,np.Q)(t),_=_g(e,f,i),m=t.layer.opacity;if(!_||0===m&&!l)continue;const g=!(0,F.sy)(t.layer)&&!c;g&&(c=!0);let v=!1;o.forEach((e=>{e.start===f&&(e.output=n?Nm.l.Composite:a&&g?this.backgroundIsGrid?Nm.l.GridComposite:Nm.l.ColorComposite:Nm.l.Composite,e.baseOpacity=g?h:1,bg.push(e),this._compositor.openGroup(r),v=!0)}));const y=0===p,b=v?Nm.l.GroupBackgroundComposite:a&&y?this.backgroundIsGrid?Nm.l.GridComposite:Nm.l.ColorComposite:Nm.l.Composite,w=Dm.pU[(0,np.TK)(t)?t.layer.blendMode:"normal"];for(this._passParameters.baseOpacity=g&&!v&&h<1?h:1,this._passParameters.opacity=m,(0,np.Ke)(_)?u=this._compositor.drawVectorData(this._passParameters,b,r,w,_,s,this.tileSize,u):(0,np.Ay)(_)?(this._compositor.drawRasterData(this._passParameters,b,r,w,_),gg(_)&&(d=st.cw.NEAREST)):this._dataToTexture(_)&&(this._passParameters.texture=_.sourceLayerInfo.data.texture,this._passParameters.offset=_.offset,this._passParameters.scale=_.scale,this._compositor.drawImageData(this._passParameters,b,r,w));bg.length>0&&bg[bg.length-1].end===f;){const e=bg.pop();this._passParameters.baseOpacity=e.baseOpacity,this._passParameters.opacity=e.opacity,this._passParameters.offset=Ke.AG,this._passParameters.scale=1,this._compositor.drawGroup(this._passParameters,e.output,r,Dm.pU[e.blendMode])}p++}const _=e.renderData,m=l||c&&h<1,g=_.ensureTexture(r,m,(()=>this._buildTexture(r,m,d)));this._compositor.copyFBOToTexture(g),this._compositor.unbind(),_.setTextureReference(new Gm(g,t,Cg,c?1:h,0,1))}_dataToTexture(e){if((0,np.S3)(e)){const t=e.sourceLayerInfo;t.data=this._buildTexture(t.data,!0),e.tile.setMemoryDirty()}return(0,np.z7)(e)}setBackground(e){this._backgroundColor!==e&&(this._backgroundColor=e,this._backgroundDirty=!0)}_buildTexture(e,t){let i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:st.cw.LINEAR_MIPMAP_LINEAR;if(null==e)return null;const n=new Vt.X;n.wrapMode=st.e8.CLAMP_TO_EDGE,n.samplingMode=i,n.maxAnisotropy=this._maxAnisotropy,n.preMultiplyAlpha=!0,n.flipped=!0,n.hasMipmap=!0,t||(n.pixelFormat=st.VI.RGB);const r=this._rctx;let s;if("number"==typeof e)n.width=n.height=e,s=this._buildTileTexture(n,e);else if((0,qd.Cm)(e))n.isOpaque=e.isOpaque,n.isOpaque&&(n.pixelFormat=st.VI.RGB),s=this._buildTileTexture(n,e.element.width,e.element);else try{n.width=e.width,n.height=e.height,s=this._buildTileTexture(n,e.width,e)}catch(o){s=new dg((0,_t.l)(r)),console.warn("TileRenderer: failed to execute 'texImage2D', cross-origin image may not be loaded.")}const a=r.bindTexture(s.texture,di.x.TEXTURE_UNIT_FOR_UPDATES);return s.generateMipmap(),r.bindTexture(a,di.x.TEXTURE_UNIT_FOR_UPDATES),s}_buildTileTexture(e,t,i){const n="".concat(t," ").concat(e.pixelFormat),r=this._cache.pop(n);return r?(r.retain(),r.texture.setData(i),r):new dg(new di.x(this._rctx,e,i),this._cache)}get test(){}}function _g(e,t,i){wg.layerIndex=t,wg.vtlNeighborInfos.clear();const n=e.layerInfo[pd.MAP][t];if((0,Xe.t8)(wg.offset,0,0),wg.tile=e,wg.scale=1,wg.sourceLod=e.lij,wg.sourceLayerInfo=n,wg.isVTLBackground=i,n.data)return i&&e.forEachLoadedNeighbor(((i,r)=>{if(i.level!==e.level)return;const s=i.layerInfo[pd.MAP][t];if(!(0,np.B9)(s)||n.data===s.data)return;const a=wg.vtlNeighborInfos.pushNew();a.offset=xg[r],a.sourceLod=i.lij,a.sourceLayerInfo=s})),wg;const r=n.upsampleInfo;if(r){const e=r.tile.layerInfo[pd.MAP][t];return wg.tile=r.tile,(0,Xe.JG)(wg.offset,r.offset),wg.scale=r.scale,wg.sourceLod=r.tile.lij,wg.sourceLayerInfo=e,wg}return i?wg:null}function mg(e){return e.uid}function gg(e){const t=e.sourceLayerInfo.data;return!!t.source&&"nearest"===t.interpolation}function fg(e){let t="normal"!==e.blendMode;return(0,F.CY)(e.parent)&&(t=fg(e.parent)||t),t}function vg(e,t){(0,F.CY)(e.parent)&&vg(e.parent,t);const i=mg(e);if(null!=i&&""!==i){const n=yg.get(i);n?n.start=t:yg.set(i,new ug(t,t,e.blendMode,e.opacity,Nm.l.Composite,1))}}const yg=new Map,bg=new Array,wg=new class{constructor(){this.sourceLod=[0,0,0],this.offset=[0,0],this.scale=1,this.layerIndex=0,this.isVTLBackground=!1,this.vtlNeighborInfos=new pl.Z({allocator:e=>e||new cg})}},Cg={offset:[0,0],scale:1},xg=new Array;xg[Mp.X.NORTH]=[0,-1],xg[Mp.X.NORTH_EAST]=[-1,-1],xg[Mp.X.EAST]=[-1,0],xg[Mp.X.SOUTH_EAST]=[-1,1],xg[Mp.X.SOUTH]=[0,1],xg[Mp.X.SOUTH_WEST]=[1,1],xg[Mp.X.WEST]=[1,0],xg[Mp.X.NORTH_WEST]=[1,-1];const Tg=1e-6;class Sg{constructor(e,t,i,n,r){this.aabb=e,this.axis=t,this.d=i,this.midStartIndex=n,this.rightStartIndex=r}}class Pg{constructor(e,t,i,n){this.globalTriangleVertexIndices=e,this.firstTriangleIndex=t,this.positions=n,this._rayDirection=(0,R.Ue)(),this._callback=Dg,this._intersectionOptions=Eg,this.bspNodeTree=new Array;const r=i-t,s=new(r<Ag?Uint8Array:r<Og?Uint16Array:Uint32Array)(r);this.triangleIndexMap=s;for(let a=0;a<r;++a)s[a]=a;{const a=function(e,t,i,n,r){const s=i-t,a=new Float32Array(6*s);for(let o=0;o<s;++o){const i=3*(o+t),s=e[i]*r,l=e[i+1]*r,h=e[i+2]*r;for(let e=0;e<3;++e){const t=n[s+e],i=n[l+e],r=n[h+e];a[6*o+e]=Math.min(t,i,r),a[6*o+3+e]=Math.max(t,i,r)}}return a}(e,t,i,n.data,n.stride),o=(0,me.uZ)(Math.log2(r/40),2,10),l=(e,t,i)=>{const n=function(e,t,i,n){if(n<=i)return(0,Pp.al)(NaN,NaN,NaN,NaN,NaN,NaN);{const n=6*e[i];for(let e=0;e<3;++e)Mg[e]=t[n+0+e],Rg[e]=t[n+3+e]}for(let r=i+1;r<n;++r){const i=6*e[r];for(let e=0;e<3;++e)Mg[e]=Math.min(Mg[e],t[i+0+e]),Rg[e]=Math.max(Rg[e],t[i+3+e])}return(0,Pp.al)(Mg[0],Mg[1],Mg[2],Rg[0],Rg[1],Rg[2])}(s,a,e,t),r=t-e;if(r<=40){const i=new Sg(n,void 0,0,e,t);return this.bspNodeTree.push(i),i}const{axis:h,midValue:c}=function(e){const t=e[3]-e[0],i=e[4]-e[1],n=e[5]-e[2],r=t>i?t>n?0:i>n?1:2:i>n?1:n>t?2:0;return{axis:r,midValue:(e[r]+e[r+3])/2}}(n),d=function(e,t,i,n,r,s){let a=i,o=n;for(;a<o;){const i=e[a];t[6*i+r+3]<=s?++a:(--o,e[a]=e[o],e[o]=i)}let l=a;for(o=n;l<o;){const i=e[o-1];t[6*i+r]>=s?--o:(e[o-1]=e[l],e[l]=i,++l)}return{next:a,mid:l}}(s,a,e,t,h,c),u=(e,t)=>{if(i>o)return;const n=t-e;return n<40||n>=.8*r?void 0:l(e,t,i+1)},p=new Sg(n,h,c,d.next,d.mid);return this.bspNodeTree.push(p),p.leftNode=u(e,d.next),p.rightNode=u(d.mid,t),p};l(0,r,0)}}intersectRayTriangleRange(e,t){if(e>=t)return;const i=this.positions;(0,um.ET)(this._rayFrom,this._rayDirection,e,t,this.globalTriangleVertexIndices,i.data,i.stride,this._intersectionOptions.normalRequired,this._callback,this.triangleIndexMap,this.firstTriangleIndex),Pg.numFacesTested+=t-e}intersectRay(e,t,i,n){Pg.numFacesTested=0;const r=e,s=t,a=s[0]-r[0],o=s[1]-r[1],l=s[2]-r[2];if(a*a+o*o+l*l<Tg)return;this._rayFrom=r;const h=this._rayDirection;h[0]=a,h[1]=o,h[2]=l;const c=this.triangleIndexMap.length;this._callback=n,this._intersectionOptions=i,this.intersectRayBSP(this.bspNodeTree[0],0,c),this._callback=Dg,this._intersectionOptions=Eg}intersectRayBSP(e,t,i){const n=this._rayFrom,r=this._rayDirection;if(!function(e,t,i){const n=t,r=i;let s=0,a=1/0;for(let o=0;o<3;++o){{const t=e[o];if(n[o]<t){if(r[o]<=Tg)return!1;const e=(t-n[o])/r[o];s=Math.max(s,e)}else if(r[o]<=-1e-6){const e=(t-n[o])/r[o];a=Math.min(a,e)}if(s>a)return!1}{const t=e[o+3];if(n[o]>t){if(r[o]>=-1e-6)return!1;const e=(t-n[o])/r[o];s=Math.max(s,e)}else if(r[o]>=Tg){const e=(t-n[o])/r[o];a=Math.min(a,e)}if(s>a)return!1}}return!0}(e.aabb,n,r))return;const s=e.axis,a=e.d;if(n[s]<a||r[s]<0){const i=t,n=e.midStartIndex;if(i<n){const t=e.leftNode;void 0!==t?this.intersectRayBSP(t,i,n):this.intersectRayTriangleRange(i,n)}}if(this.intersectRayTriangleRange(e.midStartIndex,e.rightStartIndex),n[s]>a||r[s]>0){const t=e.rightStartIndex,n=i;if(t<n){const i=e.rightNode;void 0!==i?this.intersectRayBSP(i,t,n):this.intersectRayTriangleRange(t,n)}}}get estimatedMemoryUsage(){return this.triangleIndexMap.byteLength}}Pg.numFacesTested=0;const Mg=[1/0,1/0,1/0],Rg=[-1/0,-1/0,-1/0];const Ag=255,Og=65535,Eg=new um.sT,Dg=()=>{};var Ig=i(55375),Lg=i(91526),Ng=i(73059),Ug=i(16010),Hg=i(60113),Fg=i(41481),Vg=i(22702),qg=i(8883);class zg extends qg.W{constructor(){super(...arguments),this.output=l_.H_.Color,this.overlayMode=Vg.gT.Disabled,this.tileBlendInput=Ig.R.LayerOnly,this.spherical=!1,this.doublePrecisionRequiresObfuscation=!1,this.receiveShadows=!1,this.hasSlicePlane=!1,this.backfaceCullingEnabled=!1,this.textureFadingEnabled=!1,this.renderOccluded=!1,this.hasScreenSpaceReflections=!1,this.hasCloudsReflections=!1,this.invisible=!1,this.opaque=!0,this.tileBorders=!1,this.visualizeNormals=!1,this.screenSizePerspective=!1,this.receiveAmbientOcclusion=!1,this.pbrMode=Fg.f7.Simplified}}(0,n._)([(0,ht.o)({count:l_.H_.COUNT})],zg.prototype,"output",void 0),(0,n._)([(0,ht.o)({count:Vg.gT.COUNT})],zg.prototype,"overlayMode",void 0),(0,n._)([(0,ht.o)({count:Ig.R.COUNT})],zg.prototype,"tileBlendInput",void 0),(0,n._)([(0,ht.o)()],zg.prototype,"spherical",void 0),(0,n._)([(0,ht.o)()],zg.prototype,"doublePrecisionRequiresObfuscation",void 0),(0,n._)([(0,ht.o)()],zg.prototype,"receiveShadows",void 0),(0,n._)([(0,ht.o)()],zg.prototype,"hasSlicePlane",void 0),(0,n._)([(0,ht.o)()],zg.prototype,"backfaceCullingEnabled",void 0),(0,n._)([(0,ht.o)()],zg.prototype,"textureFadingEnabled",void 0),(0,n._)([(0,ht.o)()],zg.prototype,"renderOccluded",void 0),(0,n._)([(0,ht.o)()],zg.prototype,"hasScreenSpaceReflections",void 0),(0,n._)([(0,ht.o)()],zg.prototype,"hasCloudsReflections",void 0),(0,n._)([(0,ht.o)()],zg.prototype,"invisible",void 0),(0,n._)([(0,ht.o)()],zg.prototype,"opaque",void 0),(0,n._)([(0,ht.o)()],zg.prototype,"tileBorders",void 0),(0,n._)([(0,ht.o)()],zg.prototype,"visualizeNormals",void 0),(0,n._)([(0,ht.o)()],zg.prototype,"screenSizePerspective",void 0),(0,n._)([(0,ht.o)()],zg.prototype,"receiveAmbientOcclusion",void 0),(0,n._)([(0,ht.o)({count:Fg.f7.COUNT})],zg.prototype,"pbrMode",void 0),(0,n._)([(0,ht.o)({constValue:Ug.r.Compressed})],zg.prototype,"normalType",void 0),(0,n._)([(0,ht.o)({constValue:Hg.N.Compressed})],zg.prototype,"textureCoordinateType",void 0),(0,n._)([(0,ht.o)({constValue:!1})],zg.prototype,"highStepCount",void 0),(0,n._)([(0,ht.o)({constValue:!1})],zg.prototype,"useCustomDTRExponentForWater",void 0),(0,n._)([(0,ht.o)({constValue:!1})],zg.prototype,"useFillLights",void 0),(0,n._)([(0,ht.o)({constValue:!0})],zg.prototype,"hasColorTexture",void 0);const Bg=(0,Pp.Ue)();var Gg;!function(e){e[e.Opaque=0]="Opaque",e[e.Semitransparent=1]="Semitransparent",e[e.TransparentWithDraped=2]="TransparentWithDraped",e[e.Empty=3]="Empty"}(Gg||(Gg={}));let kg=class extends $i.He{get _isGlobal(){return this._stage.viewingMode===te.JY.Global}get _techniques(){return this._context.techniques}get _rctx(){return this._context.renderContext.rctx}constructor(e,t,i,n,r){super({}),this._overlayRenderer=e,this._stage=t,this._allTiles=i,this._ellipsoidRadius=n,this.type=qc.q7.TERRAIN,this.isGround=!0,this._tileSize=256,this._techniqueConfiguration=new zg,this._passParameters=new h_.T,this._drawParameters=new Ng.w,this._renderDataPool=new rh.Z(p_),this._visiblePatchesByOrigin=new Map,this._allPatchesByOrigin=new Map,this._patchesByOriginDirty=!0,this._patchSortingDirty=!0,this._tileIterator=new Up.AA,this._transparencyState=Gg.Opaque,this._castShadows=!1,this._inViewshed=!1,this._emptyTex=null,this._tileRenderer=null,this._stencilEnabledLayerExtents=new Array,this._numTilesRendered=0,this._numTilesCulled=0,this._numOriginsRendered=0,this.renderOccludedFlags=pp.yD.Occlude,this.produces=new Map([[en.r.OPAQUE_TERRAIN,()=>this._produces()],[en.r.TRANSPARENT_TERRAIN,()=>this._produces()],[en.r.OCCLUDED_TERRAIN,()=>this._produces()]]),this._tileTextureCache=new ju.N(((e,t)=>r.newCache(e,t)),"TileTexture"),this.tileGeometryCache=new Em(r)}normalizeCtorArgs(){return{}}initialize(){this._stage.addRenderPlugin(this),this.addHandles((0,g.watch)((()=>this._overlayRenderer.rendersOccludedDraped),(e=>{this.renderOccludedFlags=e?cp.Qi:pp.yD.Occlude,this.setNeedsRender()}),g.sync))}destroy(){this._stage.removeRenderPlugin(this),this._tileTextureCache.destroy(),this.tileGeometryCache.destroy()}_produces(){return this.visible&&!!this._rootTiles&&!this.renderingDisabled}consumes(){return this._overlayRenderer.hasWater?$i.of:$i.jt}set renderingDisabled(e){this._set("renderingDisabled",!!e),this.setDirty()}set visible(e){this._set("visible",!!e),this.setDirty()}updateHeading(e){var t;null===(t=this._tileRenderer)||void 0===t||t.updateHeading(e)}set transparency(e){this._transparencyState!==e&&(this._techniqueConfiguration.invisible=e===Gg.TransparentWithDraped||e===Gg.Empty,this._techniqueConfiguration.opaque=e===Gg.Opaque,this._transparencyState=e,this.setNeedsRender())}get transparency(){return this._transparencyState}get renderPatchBorders(){return!!this._techniqueConfiguration.tileBorders}set renderPatchBorders(e){this._techniqueConfiguration.tileBorders!==e&&(this._techniqueConfiguration.tileBorders=e,this.setNeedsRender(),this.notifyChange("renderPatchBorders"))}get visualizeNormals(){return!!this._techniqueConfiguration.visualizeNormals}set visualizeNormals(e){this._techniqueConfiguration.visualizeNormals!==e&&(this._techniqueConfiguration.visualizeNormals=e,this.setNeedsRender(),this.notifyChange("visualizeNormals"))}get cullBackFaces(){return this._techniqueConfiguration.backfaceCullingEnabled}set cullBackFaces(e){this._techniqueConfiguration.backfaceCullingEnabled!==e&&(this._techniqueConfiguration.backfaceCullingEnabled=e,this.notifyChange("cullBackFaces"),this.setNeedsRender())}set renderOrder(e){this._set("renderOrder",e),this._setSortingDirty()}get layerUid(){return Jr.xX}get slicePlaneEnabled(){return this._techniqueConfiguration.hasSlicePlane}set slicePlaneEnabled(e){this._techniqueConfiguration.hasSlicePlane!==e&&(this._techniqueConfiguration.hasSlicePlane=e,this.setNeedsRender())}set textureFadingEnabled(e){this._techniqueConfiguration.textureFadingEnabled!==e&&(this._techniqueConfiguration.textureFadingEnabled=e,this.setNeedsRender())}set pbrMode(e){this._techniqueConfiguration.pbrMode!==e&&(this._techniqueConfiguration.pbrMode=e,this.setNeedsRender())}setDebugScreenSizePerspective(e){this._techniqueConfiguration.screenSizePerspective!==e&&(this._techniqueConfiguration.screenSizePerspective=e,this.setNeedsRender())}setRootTiles(e){this._rootTiles=e,this.setDirty()}setStencilEnabledLayerExtents(e){this._stencilEnabledLayerExtents=e,this._setSortingDirty()}setTileSize(e){this._tileSize=e,null!=this._tileRenderer&&(this._tileRenderer.tileSize=e),this.setDirty()}_prepareTileForLoading(e){e.renderData||(e.renderData=this._renderDataPool.acquire(),e.renderData.init(e,this._getLocalOriginOfTile(e)))}loadTile(e){this._prepareTileForLoading(e),this.updateTileGeometryState(e),this.updateTileTexture(e,kp.TEXTURE_FADING)}updateTileTexture(e,t){null!=this._tileRenderer&&(this._tileRenderer.updateTileTexture(e,t===kp.TEXTURE_FADING?lp.Ns.FADING:lp.Ns.UNFADED),this.setNeedsRender(),e.resetPendingUpdate(t))}updateTileGeometryState(e){for(const i of e.layerInfo[pd.ELEVATION])i.pendingUpdates&=~kp.GEOMETRY;e.resetPendingUpdate(kp.GEOMETRY);const t=e.renderData.updateGeometryState();return t&&this.setDirty(),t}updateGeometryIfNeeded(e){e.isLoaded&&e.renderData.updateGeometryIfNeeded(this._rctx)}unloadTile(e){const t=e.renderData;t&&(t.releaseGeometry(),this._renderDataPool.release(t),t.clear(),e.renderData=null,e.setMemoryDirty(),this.setDirty())}_getLocalOriginOfTile(e){const t=Math.max(0,7*Math.floor((e.level-3)/7));if(this._isGlobal&&0===t)return R.AG;for(;e.parent&&e.level>t;)e=e.parent;return e.centerAtSeaLevel}getStats(){return{numTilesRendered:this._numTilesRendered,numTilesCulled:this._numTilesCulled,numOriginsRendered:this._numOriginsRendered}}set wireframe(e){this._get("wireframe")!==e&&(this._set("wireframe",e),this.setNeedsRender())}setDirty(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:dp.Xx.UPDATE;this._patchesByOriginDirty=!0,this._context.requestRender(e)}_setSortingDirty(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:dp.Xx.UPDATE;this._patchSortingDirty=!0,this._context.requestRender(e)}setNeedsRender(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:dp.Xx.UPDATE;this._context.requestRender(e)}initializeRenderContext(e){this._context=e,this._tileRenderer=new pg(this._rctx,this._tileSize,this._techniques,this._tileTextureCache),this.updateTileBackground(),this._emptyTex=(0,_t.l)(this._rctx)}uninitializeRenderContext(){this._emptyTex=(0,p.M2)(this._emptyTex),this._tileRenderer=(0,p.M2)(this._tileRenderer)}intersect(e,t,i,n){if(!this._rootTiles||e.options.selectOpaqueTerrainOnly&&e.options.selectionMode&&this.transparency!==Gg.Opaque)return;const r=Zg,s=jg;(0,Ge.f)(r,n,i),(0,Ge.s)(s,1/r[0],1/r[1],1/r[2]);const a=e.results.min,o=e.results.max,l=e.results.ground,h=e.options.store===qc.eC.MIN,c=!!e.results.ground.target,d=(0,Jr.lV)(e.verticalOffset),u=e.tolerance;let p,_=h&&null!=a.dist?a.dist:1/0;const m=e.options,g=m.normalRequired||!m.backfacesTerrain,f=new um.sT(!1,g),v=c=>{const v=c.renderData;if(null===v||void 0===v||!v.vao)return;const y=v.geometry;(0,Pp.t8)(Bg,y.boundingBox);const b=v.localOrigin;null!=d&&(d.localOrigin=b,d.applyToAabb(Bg));const w=Bg;if(Wg[0]=i[0]-b[0],Wg[1]=i[1]-b[1],Wg[2]=i[2]-b[2],!(0,um.Fw)(w,Wg,s,u,_))return;const C=(e,t,i)=>{e.set(this.type,c,t,i,Mt.Wd),_=h&&null!=a.dist?a.dist:1/0},x=(s,h,c)=>{if((!g||null!=c)&&s>=0&&(m.backfacesTerrain||(0,Ge.m)(c,r)<0)&&(m.invisibleTerrain||!m.selectionMode||null==t||t(i,n,s))){if((null==l.dist||s<l.dist)&&C(l,s,c),m.isFiltered)return;m.store===qc.eC.ALL&&(null==p?(p=(0,Dr.LP)(e.ray),C(p,s,c),e.results.all.push(p)):s<p.dist&&C(p,s,c)),(null==a.dist||s<a.dist)&&C(a,s,c),m.store!==qc.eC.MIN&&(null==o.dist||s>o.dist)&&C(o,s,c)}},T=Xg;(0,Ge.f)(T,n,b);const{indices:S,indexCount:P}=y,M=y.vertexAttributes,R=M.getField(hi.T.POSITION,Rm.ct),A=new Lg.U(R.typedBuffer,3,M.stride/4),O=P/3;if(!d&&O>200){const e=c.renderData;null==e.intersectionData&&(e.intersectionData=new Pg(S,0,O,A)),e.intersectionData.intersectRay(Wg,T,f,x)}else(0,um.CN)(Wg,T,0,O,S,A,d,f,x)},y=this._rootTiles;null!=y&&(()=>{const t=this._tileIterator;t.reset(y);const n=e.options.invisibleTerrain;for(let e=t.next();e;e=t.next())!(e.visible||n&&e.intersectsClippingArea)||null==d&&!e.intersectsRay(i,r,u,_)||c&&this._useStencilForTile(e)?t.skipSubtree():v(e)})()}processScaleRangeQueries(e,t){if(!t.done)for(this._updatePatchGroups();e.updating&&!t.done;){e.prepare();for(const t of this._visiblePatchesByOrigin.values())for(const n of t){var i;null!=(null===(i=n.renderData)||void 0===i?void 0:i.textureReference)&&e.queriesForTile(n)}e.process(),t.madeProgress()}}prepareTechnique(e){const t=(0,d.Z)("enable-feature:terrain-shadows")&&e.bindParameters.shadowMap.enabled;t!==this._castShadows&&(this._castShadows=t,this._patchesByOriginDirty=!0);const i=e.bindParameters.viewshedEnabled;if(this._inViewshed!==i&&(this._inViewshed=i,this._patchesByOriginDirty=!0),e.bindParameters.slot===en.r.OCCLUDED_TERRAIN){if(!(e.renderOccludedMask&cp.Qi))return null}else{const t=this.transparency===Gg.Opaque?en.r.OPAQUE_TERRAIN:en.r.TRANSPARENT_TERRAIN;if(e.bindParameters.slot!==t)return null}if(this.transparency===Gg.Empty)return null;switch(e.output){case l_.H_.Color:return this._techniqueConfiguration.hasScreenSpaceReflections=null!=e.bindParameters.ssr.lastFrameColor,this._techniqueConfiguration.hasCloudsReflections=null!=e.bindParameters.cloudsFade.data,this._techniqueConfiguration.receiveShadows=e.bindParameters.shadowMap.ready,this._techniqueConfiguration.receiveAmbientOcclusion=null!=e.bindParameters.ssao,this._techniqueConfiguration.overlayMode=this._overlayRenderer.mode,this._updateTechnique(l_.H_.Color,e.bindParameters.slot===en.r.OCCLUDED_TERRAIN);case l_.H_.Shadow:case l_.H_.ShadowExcludeHighlight:return this._castShadows?(this._techniqueConfiguration.receiveShadows=this._techniqueConfiguration.receiveAmbientOcclusion=!1,this._updateTechnique(l_.H_.Shadow,!1)):null;case l_.H_.ViewshedShadow:return this._inViewshed?(this._techniqueConfiguration.receiveShadows=this._techniqueConfiguration.receiveAmbientOcclusion=!1,this._updateTechnique(l_.H_.ViewshedShadow,!1)):null;case l_.H_.Depth:return this._techniqueConfiguration.receiveShadows=this._techniqueConfiguration.receiveAmbientOcclusion=!1,this._updateTechnique(l_.H_.Depth,!1);case l_.H_.Normal:return this._techniqueConfiguration.receiveShadows=this._techniqueConfiguration.receiveAmbientOcclusion=!1,this._updateTechnique(l_.H_.Normal,!1);case l_.H_.ObjectAndLayerIdColor:return this._updateTechnique(l_.H_.ObjectAndLayerIdColor,!1);case l_.H_.Highlight:return this._overlayRenderer.hasHighlights?(this._techniqueConfiguration.receiveShadows=this._techniqueConfiguration.receiveAmbientOcclusion=!1,this._updateTechnique(l_.H_.Highlight,!1)):null}return null}renderNode(e,t){switch(this._updatePatchGroups(),t.useStencil=!1,e.output){case l_.H_.Color:{const i=e.bindParameters.slot===en.r.OCCLUDED_TERRAIN?Am.D.Occluded:Am.D.Color;this._renderMaterialPass(e,t,i);break}case l_.H_.Depth:case l_.H_.Normal:this._renderAuxiliaryPass(e,t,Am.D.Color,this._visiblePatchesByOrigin);break;case l_.H_.Highlight:this._renderAuxiliaryPass(e,t,Am.D.Highlight,this._visiblePatchesByOrigin);break;case l_.H_.Shadow:case l_.H_.ShadowExcludeHighlight:case l_.H_.ViewshedShadow:this._renderAuxiliaryPass(e,t,null,this._allPatchesByOrigin);break;case l_.H_.ObjectAndLayerIdColor:this._renderAuxiliaryPass(e,t,Am.D.ObjectAndLayerIdColor,this._visiblePatchesByOrigin)}}updateTileBackground(e){if(null==this._tileRenderer)return;const t=this._tileRenderer;let i;if(null!=e){const t=ld.Z.toUnitRGBA(e);i=(0,R.al)(t[0]||0,t[1]||0,t[2]||0)}t.setBackground(i),this._allTiles.forAll((e=>t.updateTileTexture(e,lp.Ns.FADING))),this._techniqueConfiguration.tileBlendInput=t.backgroundIsGrid?Ig.R.GridComposite:null!=t.backgroundColor?Ig.R.ColorComposite:Ig.R.LayerOnly,this.setNeedsRender()}_updatePatchGroups(){if(this._patchesByOriginDirty&&(this._rebuildPatchGroups(),this._patchesByOriginDirty=!1,this._patchSortingDirty=!0),this._patchSortingDirty&&this.renderOrder!==mm.z.NONE){const e=Array.from(this._visiblePatchesByOrigin.values()),t=this._stencilEnabledLayerExtents;for(const i of e)(0,Up.zW)(this.renderOrder,i,t);e.sort(((e,t)=>(0,Up.dF)(e[0],t[0],this.renderOrder))),this._visiblePatchesByOrigin=new Map(e.map((e=>[e[0].renderData.localOrigin,e]))),this._patchSortingDirty=!1}}_rebuildPatchGroups(){const e=this._rootTiles;if(null!=e){var t;null!==(t=e[0])&&void 0!==t&&t.surface.checkAllTilesWaterproofness(),this._visiblePatchesByOrigin.clear(),this._allPatchesByOrigin.clear();for(const t of e)this._rebuildPatchGroupsForRootTile(t)}}_rebuildPatchGroupsForRootTile(e){const t=this._tileIterator;for(t.resetOne(e);!t.done;){const e=t.next(),i=e.renderData;if(!i){this._numTilesCulled++;continue}const n=i.localOrigin;if(this._castShadows||this._inViewshed){let t=this._allPatchesByOrigin.get(n);t||(t=[],this._allPatchesByOrigin.set(n,t)),t.push(e)}if(!e.visible){this._numTilesCulled++,t.skipSubtree();continue}let r=this._visiblePatchesByOrigin.get(n);r||(r=[],this._visiblePatchesByOrigin.set(n,r)),r.push(e),t.skipSubtree()}}_useStencilForTile(e){for(const t of this._stencilEnabledLayerExtents)if(e.intersectsExtent(t))return!0;return!1}_renderAuxiliaryPass(e,t,i,n){const r=e.rctx;this._passParameters.overlayContent=i,r.bindTechnique(t,e.bindParameters,this._passParameters);const s=this._stencilEnabledLayerExtents.length>0;n.forEach((n=>{this._drawParameters.origin=n[0].renderData.localOrigin,t.program.bindDraw(this._drawParameters,e.bindParameters,this._passParameters);for(let r=0;r<n.length;r++)this._renderPatch(e,t,n[r],st.MX.TRIANGLES,s,i)})),e.rctx.bindVAO(null)}_renderMaterialPass(e,t,i){var n;const{rctx:r}=e;this._passParameters.overlayContent=i,r.bindTechnique(t,e.bindParameters,this._passParameters),this._numTilesRendered=0,this._numTilesCulled=0,this._numOriginsRendered=0;const s=e.bindParameters.camera,a=t.program;if(this._techniqueConfiguration.screenSizePerspective&&this.pointsOfInterest){const e=(0,Ml.Gw)(this._stage.viewingMode,this._ellipsoidRadius),t=this.pointsOfInterest.centerOnSurfaceFrequent.distance;e.update({distance:t,fovY:s.fovY})}const o=this._stencilEnabledLayerExtents.length>0,l=i===Am.D.Occluded;l&&(a.bindTexture("tex",this._emptyTex),a.setUniform3fv("textureOpacities",R.AG),a.setUniform4fv("texOffsetAndScale",Ye.AG));const h=null!=(null===(n=this._tileRenderer)||void 0===n?void 0:n.backgroundColor)?this._tileRenderer.backgroundColor:R.AG;this._techniqueConfiguration.tileBlendInput===Ig.R.ColorComposite&&a.setUniform3fv("backgroundColor",h);const c=this.wireframe?st.MX.LINES:st.MX.TRIANGLES;this._techniqueConfiguration.textureFadingEnabled&&a.bindTexture("texNext",this._emptyTex);const d=this._visiblePatchesByOrigin;for(const u of d.values()){const n=u[0].renderData.localOrigin;t.program.bindDraw(new Ng.w(n),e.bindParameters,this._passParameters),this._numOriginsRendered++;for(const r of u){const n=r.renderData,s=n.textureReference;if(null!=s){if(!l){a.setUniform4fv("texOffsetAndScale",s.offsetAndScale),a.bindTexture("tex",s.texture.texture);const e=n.textureFadeFactor,t=e<1?n.nextTextureReference:null;this._techniqueConfiguration.textureFadingEnabled&&null!=t&&e<1?(a.setUniform1f("fadeFactor",e),a.setUniform4fv("nextTexOffsetAndScale",t.offsetAndScale),a.setUniform3fv("nextTexOpacities",t.opacities),a.bindTexture("texNext",t.texture.texture)):a.setUniform1f("fadeFactor",1),n.textureIsFading&&this.setNeedsRender(),a.setUniform3fv("textureOpacities",s.opacities)}this._renderPatch(e,t,r,c,o,i),r.renderOrder=this._numTilesRendered,this._numTilesRendered++}}}e.rctx.bindVAO(null)}_renderPatch(e,t,i,n,r,s){const a=i.renderData,o=a.vao,l=null===o||void 0===o?void 0:o.indexBuffer;if(!o||null==l)return void(np.T9&&console.error("Rendered tile with no indices: ",i.lij," : ",a));const h=t.program;null==s||this._overlayRenderer.isEmpty||this._bindOverlayPatchData(h,a.overlay),r&&(t.useStencil=this._useStencilForTile(i),e.rctx.setPipelineState(t.getPipeline()));const c=a.geometry.indexCount;e.rctx.bindVAO(o),h.assertCompatibleVertexAttributeLocations(o),e.rctx.drawElements(n,c,l.indexType,0)}_bindOverlayPatchData(e,t){e.setUniform4fv("overlayTexOffset",t.offsets),e.setUniform4fv("overlayTexScale",t.scales)}_updateTechnique(e,t){return this._techniqueConfiguration.output=e,this._techniqueConfiguration.renderOccluded=t,this._shaderTechnique=this._techniques.releaseAndAcquire(d_,this._techniqueConfiguration,this._shaderTechnique),this._shaderTechnique}get test(){}};(0,n._)([(0,b.Cb)({readOnly:!0})],kg.prototype,"_isGlobal",null),(0,n._)([(0,b.Cb)()],kg.prototype,"renderOccludedFlags",void 0),(0,n._)([(0,b.Cb)({value:!1})],kg.prototype,"renderingDisabled",null),(0,n._)([(0,b.Cb)({value:!0})],kg.prototype,"visible",null),(0,n._)([(0,b.Cb)()],kg.prototype,"renderPatchBorders",null),(0,n._)([(0,b.Cb)()],kg.prototype,"visualizeNormals",null),(0,n._)([(0,b.Cb)()],kg.prototype,"cullBackFaces",null),(0,n._)([(0,b.Cb)({value:mm.z.FRONT_TO_BACK})],kg.prototype,"renderOrder",null),(0,n._)([(0,b.Cb)()],kg.prototype,"wireframe",null),kg=(0,n._)([(0,C.j)("esri.views.3d.terrain.TerrainRenderer")],kg);const Zg=(0,R.Ue)(),jg=(0,R.Ue)(),Wg=(0,R.Ue)(),Xg=(0,R.Ue)();class Qg{constructor(){this.numNodes=0,this.numLeaves=0,this.numVisible=0,this.numRendered=0,this.numSplit=0,this.numMerged=0,this.numRenderedPerLevel=new Array,this.numLoadedPerLevel=new Array}}var Yg=i(82575),Jg=i(62140);let Kg=class extends T.default{constructor(e){super(e)}initialize(){this.addHandles([this.layers.on("change",(()=>this._update())),(0,g.watch)((()=>this.extentHelper.layerViewsExtent),(()=>this._setAdHocTilingScheme()))]),this._update(),this.tilingSchemeLocked||this._setAdHocTilingScheme()}destroy(){this._waitTask=null,this.layers.destroy()}_update(){if(this._waitTask=null,this.tilingSchemeLocked)return;let e;if(this.layers.some((t=>!(!(0,F.iC)(t)||t.isRejected())&&!(t.isFulfilled()&&!function(e,t,i){return null!=(0,np.E_)(e,t,i)}(t,this.viewSpatialReference,this.viewingMode))&&(e=t,!("vector-tile"===(null===t||void 0===t?void 0:t.type)||(0,np.x4)(t))))),e)if(e.isResolved()){const t=(0,np.E_)(e,this.viewSpatialReference,this.viewingMode);if(null!=t){const e=new Jg.t(t.tileInfo);this._lockTilingScheme(e)}}else this._updateWhen(e)}_updateWhen(e){const t=e.when().catch((()=>{})).then((()=>{t!==this._waitTask||this.destroyed||this._update()}));this._waitTask=t}_lockTilingScheme(e){if(this.viewingMode===te.JY.Global){const t=e.levels.length-1,i=e.spatialReference;i.isWebMercator?e=Jg.t.makeWebMercatorAuxiliarySphere(t):(0,Yg.O)(i)&&(e=Jg.t.makeGCSWithTileSize(e.spatialReference,e.pixelSize,t))}this.tilingSchemeLocked=!0,this.tilingScheme=e,this.extentHelper.tilingScheme=this.tilingScheme,this._updateTiledLayerExtent(),this.removeAllHandles(),this.addHandles((0,g.watch)((()=>this.extentHelper.tiledLayersExtent),(()=>this._updateTiledLayerExtent())))}_updateTiledLayerExtent(){this._set("extent",this.extentHelper.tiledLayersExtent)}_setAdHocTilingScheme(){if(this.viewingMode===te.JY.Global){const e=this.extentHelper.viewSpatialReference;e.isWebMercator?this.tilingScheme=Jg.t.WebMercatorAuxiliarySphere:(0,Yg.M)(e)&&(this.tilingScheme=Jg.t.makeGCSWithTileSize(e,256)),this._set("extent",this.extentHelper.layerViewsExtent)}else{const e=this.extentHelper.layerViewsExtent;null==e||(0,L.fS)(e,this.extent)||(this.tilingScheme=Jg.t.fromExtent(e,this.extentHelper.viewSpatialReference),this._set("extent",e))}}get test(){}};(0,n._)([(0,b.Cb)()],Kg.prototype,"tilingScheme",void 0),(0,n._)([(0,b.Cb)({readOnly:!0})],Kg.prototype,"extent",void 0),(0,n._)([(0,b.Cb)({value:!1})],Kg.prototype,"tilingSchemeLocked",void 0),(0,n._)([(0,b.Cb)({constructOnly:!0})],Kg.prototype,"viewSpatialReference",void 0),(0,n._)([(0,b.Cb)({constructOnly:!0})],Kg.prototype,"layers",void 0),(0,n._)([(0,b.Cb)({constructOnly:!0})],Kg.prototype,"extentHelper",void 0),(0,n._)([(0,b.Cb)({constructOnly:!0})],Kg.prototype,"viewingMode",void 0),Kg=(0,n._)([(0,C.j)("esri.views.3d.terrain.TilingSchemeLogic")],Kg);class $g{constructor(){this.offset=(0,Ke.Ue)(),this.scale=0,this.tile=null}init(e,t,i,n){this.tile=e,this.offset[0]=t,this.offset[1]=i,this.scale=n}dispose(){this.tile=null,this.offset[0]=0,this.offset[1]=0,this.scale=0}}var ef;let tf=ef=class extends(G.Z.EventedMixin(T.default)){constructor(e){var t,i,n;super(e),this._scaleRangeQueries=new fm,this._iteratorPool=new rh.Z(Up.AA,(e=>e.remove=()=>this._iteratorPool.release(e))),this._postorderIterator=new Up.rv,this._hasPendingUpdates=!1,this._pendingUpdates=0,this._asyncWorkItems=0,this._allTilesDirty=!0,this._allTilesSorted=!0,this._usedMemory=null,this._performanceInfo=new Qg,this._viewChanged=!1,this.heading=0,this._inFrameTask=!1,this._viewChangeUpdateDirty=!1,this._eyePosRenderSR=(0,R.Ue)(),this._eyePosSurfaceSR=(0,R.Ue)(),this._splitLimits=new Mm,this._frustum=(0,ih.Ue)(),this._viewProjectionMatrix=(0,Mt.Ue)(),this._layerViews=[new Array,new Array],this._layerIndexByUid=[new Map,new Map],this._basemapLayerViewHandles=new Map,this._watchUpdatingTracking=new Vi.R,this._frameTask=Bt.sq,this._allTiles=new pl.Z,this._upsampleInfoPool=new rh.Z($g),this._shouldEmitChangeEvent=!1,this._rootTilesExtent=(0,L.Ue)(),this.updatingProgress=.5,this._maxNumUpdating=1,this.maxTextureScale=1.2,this._spatialReference=k.Z.WebMercator,this._elevationProjectorCache=new Map,this.visibleElevationBounds=new Ku(1/0,-1/0),this.rootTileElevationBounds=new Ku(1/0,-1/0),this._sebProjectorMap=new Map,this._sebProjectorCache=(0,oh.sw)(),this._tilingSchemeSpatialReference=null,this._updatingRootTiles=!1,this._pendingTilesForElevationUpdateEvent=new Set,this._pendingTilesToUpdate=new Set,this.totalGeometryUpdates=0,this.totalTileUpdates=0,this._oneBatchPerFrameTask=!0,this._layerViewsDirty=!1,this.unloadedMemory=0,this.ignoresMemoryFactor=!1,this._isWebMercator=!1,this._isWebMercatorOnPlateCarree=!1,this.overlayManager=new vp({...e,surface:this}),this._isGlobal=!(null!==(t=e.view)&&void 0!==t&&null!==(t=t.state)&&void 0!==t&&t.isLocal),this._isGeographic=null!==(i=null===(n=this._spatialReference)||void 0===n?void 0:n.isGeographic)&&void 0!==i&&i,this._tileConstructor=this._isGlobal?ym:pm}initialize(){const e=this.view,t=e.resourceController,n=t.memoryController;this._tileCache=new ju.N(((e,t)=>n.newCache(e,t)),"terrain-tile"),this._upsampleMapCache=n.newCache("terrain-upsample",(e=>e.unloadMapData())),this._elevationQueryCache=new Xu.b(n.newCache("elevation-query"));const r=this.overlayManager;this._renderer=new kg(r.renderer,e._stage,this._allTiles,(0,Ze.Iu)(e.spatialReference).radius,n),this.addHandles([(0,g.watch)((()=>r.renderer.isEmpty),(()=>this._evaluateTransparency())),(0,g.watch)((()=>this.renderer.visible),(e=>this.suspended=!e)),(0,g.watch)((()=>this.heading),(e=>{this._renderer.updateHeading(e),this._updateTileTextures(lp.Ns.FADING)})),(0,g.watch)((()=>{var t,i;return{heading:null===(t=e.camera)||void 0===t?void 0:t.heading,state:null===(i=e.state)||void 0===i?void 0:i.mode}}),(e=>{let{heading:t,state:i}=e;if(null==t)return;if(this.isGlobal&&this.isGeographic||this.isWebMercatorOnPlateCarree)return void(this.heading=90*Math.round(t/90)%360);const n=Math.round(t)%360,r=Math.abs(n-this.heading);(i===Ia.n.IDLE||Math.min(r,360-r)>=30)&&(this.heading=n)}))],"overlayManager"),this.addHandles([(0,g.watch)((()=>this.baseOpacity),(()=>{this._handleLayerViewChanges(),this._updateTileTextures(this._evaluateTransparency()?lp.Ns.UNFADED:lp.Ns.IMMEDIATE)}),g.syncAndInitial),(0,g.watch)((()=>this.hasCompositeBlendMode),(()=>this._updateTileTextures(this._evaluateTransparency()?lp.Ns.UNFADED:lp.Ns.IMMEDIATE)),g.syncAndInitial),(0,g.watch)((()=>this.backgroundColor),((e,t)=>{(null===e||void 0===e?void 0:e.equals(t))||(this._handleLayerViewChanges(),this._renderer.updateTileBackground(e))}),g.sync),(0,g.watch)((()=>this.snapLevel),(()=>this._viewChanged=!0),g.sync),(0,g.watch)((()=>this.view.pointsOfInterest),(e=>{this._renderer.pointsOfInterest=e,this._watchUpdatingTracking.removeAll(),e&&this._watchUpdatingTracking.add((()=>e.focus.renderLocation),(()=>this._allTilesSorted=!1))})),(0,g.watch)((()=>_l.h.TERRAIN_TILE_TREE_SHOW_TILES),(t=>{t&&!this._treeDebugger?i.e(62782).then(i.bind(i,62782)).then((t=>{let{TerrainTileTree3DDebugger:i}=t;!this._treeDebugger&&_l.h.TERRAIN_TILE_TREE_SHOW_TILES&&(this._treeDebugger=new i({view:e}))})):t||(this._treeDebugger=(0,p.SC)(this._treeDebugger))}),g.initial)]);const{spatialReference:s}=e;this._extentHelper=function(e,t){return e===te.JY.Global?new sp(t):new ap(t)}(this.viewingMode,{layers:e.map.allLayers,layerViews:e.allLayerViews,viewSpatialReference:s});const a=new Zu.Z({getCollections:()=>{var t;return null===(t=e.defaultsFromMap)||void 0===t||null===(t=t.mapCollections)||void 0===t?void 0:t.map((e=>{let{layers:t}=e;return t}))},getChildrenFunction:e=>e&&"layers"in e?e.layers:null}),o=new Kg({layers:a,extentHelper:this._extentHelper,viewingMode:this.viewingMode,viewSpatialReference:s});this._set("tilingSchemeLogic",o),this._updateTilingScheme(),this._elevationDataRequester=t.createStreamDataRequester(Ed.Bh.ELEVATION),this._mapDataRequester=t.createStreamDataRequester(Ed.Bh.BASEMAP);const l=t.scheduler;this._frameTask=l.registerTask(Bt.T8.TERRAIN_SURFACE,this),this.addHandles([(0,g.watch)((()=>this._extentHelper.stencilEnabledExtents),(e=>this._renderer.setStencilEnabledLayerExtents(e)),g.initial),(0,g.watch)((()=>this.tilingSchemeLogic.tilingScheme),(()=>this._updateTilingScheme()),g.sync),(0,g.watch)((()=>this.extent),(()=>this._updateRootTiles()),g.initial),e.on("resize",(()=>this._viewChangeUpdate())),(0,g.watch)((()=>{const t=e.state;return[this._lodBias,this.lodSnapping,e.quality,t.camera,t.contentCamera,t.fixedContentCamera]}),(()=>this._viewChangeUpdate()),g.syncAndInitial),(0,g.watch)((()=>{var t;return null===(t=e.qualitySettings)||void 0===t?void 0:t.fadeDuration}),(e=>this._renderer.textureFadingEnabled=e>0),g.initial),(0,g.watch)((()=>{var t;return null===(t=e.qualitySettings)||void 0===t?void 0:t.physicallyBasedRenderingEnabled}),(e=>this._renderer.pbrMode=e?Fg.f7.Simplified:Fg.f7.Disabled),g.initial),(0,g.watch)((()=>{var t;return null===(t=e.qualitySettings)||void 0===t?void 0:t.tiledSurface.elevationLevelDelta}),(()=>this._updateAllTileGeometries())),(0,g.watch)((()=>this._userClippingExtent),(()=>this._updateClippingExtent()),g.sync)]),this.addHandles(e.allLayerViews.on("after-changes",(()=>this._layerViewsDirty=!0))),this._layerViewsDirty=!0,this._handleLayerViewChanges(),this._renderer.updateTileBackground(this.backgroundColor)}destroy(){this._frameTask.remove(),this._watchUpdatingTracking.destroy(),this._removeAllTiles(),this._set("tilingSchemeLogic",(0,p.SC)(this.tilingSchemeLogic)),this._basemapLayerViewHandles.forEach(((e,t)=>this._unregisterTiledLayerView(t))),this._elevationDataRequester=null,this._mapDataRequester=null,this._set("overlayManager",(0,p.SC)(this.overlayManager)),this._tileCache=(0,p.SC)(this._tileCache),Zp.prune(),this._treeDebugger=(0,p.SC)(this._treeDebugger),this._renderer=(0,p.SC)(this._renderer),this._iteratorPool=(0,p.SC)(this._iteratorPool),this._upsampleMapCache=(0,p.SC)(this._upsampleMapCache),this._elevationQueryCache=(0,p.SC)(this._elevationQueryCache),this._set("view",null),this._extentHelper=(0,p.SC)(this._extentHelper),this._upsampleInfoPool=(0,p.SC)(this._upsampleInfoPool),(0,Qu.K)(),Gp.size>0&&(console.log("".concat(Gp.size," live TilePerLayerInfo allocations:")),Gp.forEach((e=>console.log(e,"\n"))))}get renderer(){return this._renderer}get frustum(){return this._frustum}get snapLevel(){if(this.lodSnapping===lp.VB.ON){const e=this.view,t=this.tilingScheme,i=e.terrainScale;if(t&&i){const n=t.levelAtScale(i)+e.qualitySettings.tiledSurface.lodBias,r=t.getMaxLod();return Math.min(n,r||1/0)}}return null}get lodSnapping(){return this.view.qualitySettings.tiledSurface.reduceTileLevelDifferences?lp.VB.ON:lp.VB.OFF}get upsampleInfoPool(){return this._upsampleInfoPool}get upsampleMapCache(){return this._upsampleMapCache}get elevationQueryCache(){return this._elevationQueryCache}get _userClippingExtent(){const{spatialReference:e}=this,{clippingArea:t}=this.view;if(null==t||null==e)return null;const i=(0,L.Ue)(),n=(0,Rc.G)(t,i,e)?i:null,r=this._get("extent");return(0,L.fS)(n,r)?r:n}get rootTilesExtent(){return this._rootTilesExtent}get extent(){const e=(0,L.jV)(this.groundExtent,this._userClippingExtent,(0,L.Ue)()),t=this._get("extent");return(0,L.fS)(e,t)?t:e}get groundExtent(){return null!=this._tilingSchemeExtent?this._tilingSchemeExtent:this._rootTilesExtent}get _tilingSchemeExtent(){var e;return null===(e=this.tilingSchemeLogic)||void 0===e?void 0:e.extent}get updating(){var e,t;return this._hasPendingUpdates||(this._maxNumUpdating=1),!!((this.running||null!==(e=this._watchUpdatingTracking)&&void 0!==e&&e.updating||this._asyncWorkItems>0)&&this.ready&&!this.suspended||null!==(t=this.overlayManager)&&void 0!==t&&t.updating)}get running(){return(this._hasPendingUpdates||this._viewChanged||this._allTilesDirty||!this._allTilesSorted||this._layerViewsDirty||this._scaleRangeQueries.updating||this._frameTask.updating)&&this.ready&&!this.suspended}get updatingProgressValue(){return this._maxNumUpdating=Math.max(this._pendingUpdates,this._maxNumUpdating),1-this._pendingUpdates/this._maxNumUpdating}get baseOpacity(){var e,t;return null!==(e=null===(t=this.view)||void 0===t||null===(t=t.map)||void 0===t||null===(t=t.ground)||void 0===t?void 0:t.opacity)&&void 0!==e?e:1}set baseOpacity(e){this.view.map.ground.opacity=e}get viewingMode(){return this.view.state.viewingMode}get ready(){return null!=this._rootTiles}set renderOrder(e){this._renderer.renderOrder=e,this._set("renderOrder",e)}get rootTiles(){return this._rootTiles}get spatialReference(){var e,t;return null!==(e=null===(t=this.tilingScheme)||void 0===t?void 0:t.spatialReference)&&void 0!==e?e:null}get backgroundColor(){var e;return null===(e=this.view)||void 0===e||null===(e=e.map)||void 0===e||null===(e=e.ground)||void 0===e?void 0:e.surfaceColor}set backgroundColor(e){this.view.map.ground.surfaceColor=e}set slicePlaneEnabled(e){this._renderer.slicePlaneEnabled=e,this._set("slicePlaneEnabled",e),this._evaluateTransparency()}get tilingSchemeLocked(){var e,t;return null!==(e=null===(t=this.tilingSchemeLogic)||void 0===t?void 0:t.tilingSchemeLocked)&&void 0!==e&&e}get wireframe(){var e;return null===(e=this._renderer)||void 0===e?void 0:e.wireframe}set wireframe(e){e!==this._renderer.wireframe&&(this._renderer.wireframe=e,this._updateAllTileGeometries())}get opaque(){return this._renderer.transparency===Gg.Opaque}set suspended(e){this._set("suspended",e),this._viewChangeUpdate()}get fadeDuration(){var e;return null!==(e=this.view.qualitySettings.fadeDuration)&&void 0!==e?e:0}intersect(e,t,i,n){this._renderer.intersect(e,t,i,n)}getElevationLevelDelta(e){return e<4?3:this.view.qualitySettings.tiledSurface.elevationLevelDelta}getElevation(e,t,i,n){var r;const s=this._rootTiles;if(null===s||void 0===s||!s.length)return null;if(0===s[0].layerInfo[pd.ELEVATION].length)return null;let a=this._elevationProjectorCache.get(n);if(void 0===a&&(a=null!==(r=(0,oh.R8)(n,this._spatialReference))&&void 0!==r?r:null,this._elevationProjectorCache.set(n,a)),null==a)return u.Z.getLogger(this).error("TerrainSurface.getElevation(): could not project given point to tiling scheme coordinate system"),null;const o=(0,Ge.s)(rf,e,t,i);return a(o,0,o,0),hf(s,o[0],o[1])}getElevations(e,t,i){const n=this._rootTiles,r=n?n[0].layerInfo[pd.ELEVATION].length:0;if(null!==n&&void 0!==n&&n.length&&0!==r)for(let s=0;s<t;++s){const t=3*s;i(s,hf(n,e[t],e[t+1]))}else for(let s=0;s<t;++s)i(s,null)}getScale(e){if(!this.tilingScheme)return null;if(!(0,I.K)(e,rf,this.spatialReference))return u.Z.getLogger(this).error("TerrainSurface.getScale(): could not project given point to tiling scheme coordinate system"),null;const t=this._rootTiles;if(null!=t)for(const i of t)if(null!==i&&void 0!==i&&i.containsPoint(rf)){let e=i;for(;e.children[0]&&!e.rendered;){const t=e.children[0].extent;let i=0;rf[0]>t[2]&&(i+=1),rf[1]<t[1]&&(i+=2),e=e.children[i]}return this._getLodBiasCorrectedScale(e.level)}return 1/0}_ensureSEBProject(e){var t;const i=this._sebProjectorMap.get(e);if(i)return i;const n=null!==(t=(0,oh.R8)(e,this._tilingSchemeSpatialReference,this._sebProjectorCache))&&void 0!==t?t:null;return this._sebProjectorMap.set(e,n),n}getSphereElevationBounds(e,t){const i=this._ensureSEBProject(t);if(null==i)return u.Z.getLogger(this).error("TerrainSurface.getSphereElevationBounds(): could not project given point to tiling scheme coordinate system"),null;(0,bn.a)(e,sf);const n=(0,bn.g)(sf);i(n,0,n,0);const r=new ed.r,s=this._rootTiles;if(null!=s){const e=[];for(const i of s)e.push(i);let t=0;for(;t<e.length;){const i=e[t];if(++t,!(0,L.hr)(i.extent,sf))continue;const n=i.children;if(null==n[0]||i.rendered)r.expandElevationRangeValues(i.elevationBoundsMin,i.elevationBoundsMax);else for(const t of n)e.push(t)}}return r}getRootElevationBounds(){return new ed.r(this.rootTileElevationBounds.min,this.rootTileElevationBounds.max)}getSphereScale(e,t){if(!this.tilingScheme)return null;if(!(0,I.K)(e,(0,bn.g)(sf),this.spatialReference))return u.Z.getLogger(this).error("TerrainSurface.getSphereScale(): could not project given point to tiling scheme coordinate system"),null;sf[3]=t;let i=null;const n=e=>{if(e&&(0,L.hr)(e.extent,sf)){const t=e.children;if(t[0]&&!e.rendered)for(const e of t)n(e);else{const t=this._getLodBiasCorrectedScale(e.level);i=null==i?t:Math.min(i,t)}}},r=this._rootTiles;if(null!=r)for(const s of r)n(s);return i}queryVisibleScaleRange(e,t,i,n){const r=t?this.tilingScheme.levelAtScale(t):0,s=i?this.tilingScheme.levelAtScale(i):1/0,a=this._lodBias;this._scaleRangeQueries.queryVisibleLevelRange(e,r+a,s+a,n)}_evaluateTransparency(){var e;const t=this.baseOpacity,i=this.overlayManager.renderer.isEmpty,n=this._renderer.transparency,r=this._allSurfaceLayersTransparent()?i?Gg.Empty:Gg.TransparentWithDraped:t>=1&&!this.hasCompositeBlendMode&&!this._renderer.slicePlaneEnabled?Gg.Opaque:Gg.Semitransparent,s=n!==r;return s&&(this._renderer.transparency=r,null!==(e=this.view)&&void 0!==e&&null!==(e=e._stage)&&void 0!==e&&e.renderer.setParameters({terrainTransparency:this._renderer.transparency})),s}_updateTilingScheme(){var e,t,i,n,r;const s=this.tilingSchemeLogic.tilingScheme;if(s===this.tilingScheme)return;(0,np.wu)(!!s,"tiling scheme cannot be reset to undefined"),this._isGlobal=!(null!==(e=this.view)&&void 0!==e&&null!==(e=e.state)&&void 0!==e&&e.isLocal),this.tilingScheme&&this._removeAllTiles();const a=null!==(t=null===s||void 0===s?void 0:s.spatialReference)&&void 0!==t?t:k.Z.WebMercator;this._spatialReference=a,this._isWebMercator=!(null===a||void 0===a||!a.isWebMercator),this._isWebMercatorOnPlateCarree=this._isWebMercator&&(0,ke.QM)(null===(i=this.view)||void 0===i?void 0:i.renderSpatialReference),this._isGeographic=null!==(n=null===a||void 0===a?void 0:a.isGeographic)&&void 0!==n&&n,this._set("tilingScheme",s),this._tilingSchemeSpatialReference=null===(r=this.tilingScheme)||void 0===r?void 0:r.spatialReference,this._sebProjectorMap.clear(),this._updateClippingExtent(),s&&(this._updateTiledLayers(),this._renderer.setTileSize(s.pixelSize),this.overlayManager.setSpatialReference(s.spatialReference),this._updateRootTiles())}_acquireTile(e,t,i,n){const r=this._tileCache.pop(ef._tileMemcacheKey);return r?(r.init(e,t,i,n,this),r):new this._tileConstructor(e,t,i,n,this)}get updatingRootTiles(){return this._updatingRootTiles}_updateRootTiles(){const{extent:e,tilingScheme:t}=this;if(!t)return;const i=af;let n=t.rootTilesInExtent(e,i,5*W.$X);if(null!=this._rootTiles){if(n.length>W.$X)return void u.Z.getLogger(this).warn(W.C5);const e=this._rootTiles.map((e=>e.lij)),t=(0,Ld.e5)(e,n,$p);if(this._updatingRootTiles=!0,t.removed.length>0||t.added.length>0){const e=this._rootTiles.filter((e=>!(t.removed.findIndex((t=>$p(t,e.lij)))>-1)||(this._purgeTile(e),!1)));t.added.forEach((t=>e.push(this._newRootTile(t)))),this._setRootTiles(e)}}else this._updatingRootTiles=!0,n.length>W.$X&&(u.Z.getLogger(this).warn(W.p1),n=t.rootTilesInExtent(e,i,W.$X)),this._setRootTiles(n.map((e=>this._newRootTile(e))));(0,L.fS)(i,this._rootTilesExtent)||(this._rootTilesExtent=(0,L.Ue)(i)),this.renderer.visible=!0,this._viewChangeUpdate(),this.overlayManager.setPlacementDirty(),this.notifyChange("ready"),this._updateAllTileGeometries(),this._updatingRootTiles=!1,this.checkAllTilesWaterproofness()}_updateAllTileGeometries(){const e=this._allTiles.filter((e=>e.isLoaded&&e.intersectsClippingArea));e.sort(Up.gl),e.forEach((e=>this._renderer.updateTileGeometryState(e))),e.forEach((e=>e.renderData.updateNeighborData())),this._updateTilesGeometries(e),this._pendingTilesToUpdate.clear()}_updateTilesGeometries(e){if(0===e.length)return;e.sort(Up.gl);const t=this.renderer;e.forEach((e=>t.updateGeometryIfNeeded(e))),e.forEach((e=>this._pendingTilesForElevationUpdateEvent.add(e)))}_shouldSplit(e){return e.shouldSplit(this._splitLimits,this._eyePosRenderSR,this.snapLevel)===kp.SPLIT}_newRootTile(e){const t=this._acquireTile(0,e[1],e[2],null);return this._shouldSplit(t)&&t.setPendingUpdate(kp.SPLIT),this._loadTile(t),this._markTileToUpdate(t),this._updateRootTileElevationBounds(),t}_setRootTiles(e){if(this._rootTiles=e,this._allTiles.clear(),null!=e){const t=this._iteratorPool.acquire();for(t.reset(e);!t.done;)this._allTiles.push(t.next());t.remove()}this._renderer.setRootTiles(this._rootTiles),this._updateTilesVisibility(e)}_runViewChangeUpdateIfDirty(){this._viewChangeUpdateDirty&&(this._viewChangeUpdateDirty=!1,this._viewChangeUpdate())}_viewChangeUpdate(){this.view&&!this.suspended&&this.tilingScheme&&this.renderer.visible&&(this._inFrameTask?this._viewChangeUpdateDirty=!0:(this._viewChangeUpdateDirty=!1,this._updateViewDependentParameters(),this._updateTilesVisibility(this._rootTiles)))}_updateClippingStatus(e){e.updateClippingStatus(this.extent)&&e.resetPendingUpdate(kp.GEOMETRY)&&this._updateTileGeometryState(e)}_updateTilesVisibility(e){if(null==e)return;const t=(0,Up.t8)(e),i=this.visibleElevationBounds;let n=t?i.min:1/0,r=t?i.max:-1/0;const s=this.extent,a=this._viewProjectionMatrix;this.setTileTreeDirty();const o=this._iteratorPool.acquire();for(o.reset(e);!o.done;){const e=o.next();e.updateClippingStatus(s)&&e.resetPendingUpdate(kp.GEOMETRY)&&this._updateTileGeometryState(e),e.computeVisibility(),e.updateScreenDepth(a),e.renderData&&(n=Math.min(e.elevationBoundsMin,n),r=Math.max(e.elevationBoundsMax,r))}o.remove(),this._viewChanged=!0,this._allTilesDirty=!0,this._updatePendingTileGeometries(),isFinite(n)&&isFinite(r)&&(i.min!==n||i.max!==r)&&(this.visibleElevationBounds=new Ku(n,r))}_updateRootTileElevationBounds(){let e=1/0,t=-1/0;const i=this._rootTiles;null!=i&&i.forEach((i=>{let{elevationBoundsMin:n,elevationBoundsMax:r}=i;e=Math.min(e,n),t=Math.max(t,r)}));const n=this.rootTileElevationBounds;n.min===e&&n.max===t||(this.rootTileElevationBounds=new Ku(e,t))}_updateViewDependentParameters(){var e;const{camera:t,contentCamera:i}=this.view.state,n=Math.tan(.5*i.fovX),r=Math.tan(.5*i.fovY),s=this.tilingScheme.pixelSize,a=2**-this._lodBias*t.pixelRatio;this._splitLimits.aboveGround=t.aboveGround,this._splitLimits.fovX=n,this._splitLimits.fovY=r,this._splitLimits.relativeWidthLimit=s/t.width*this.maxTextureScale*a,this._splitLimits.relativeHeightLimit=s/t.height*this.maxTextureScale*a,this._splitLimits.maxLod=this.tilingScheme.getMaxLod(),this._splitLimits.angledSplitBias=this.view.qualitySettings.tiledSurface.angledSplitBias,this.view.state.fixedContentCamera?this._splitLimits.frustum=(0,ih.JG)(null!==(e=this._splitLimits.frustum)&&void 0!==e?e:(0,ih.Ue)(),i.frustum):this._splitLimits.frustum=null,(0,ih.JG)(this._frustum,t.frustum),(0,Pt.Jp)(this._viewProjectionMatrix,i.projectionMatrix,i.viewMatrix),(0,Ge.c)(this._eyePosRenderSR,i.eye),(0,Wu.S)(t.eye,this.view.renderSpatialReference,this._eyePosSurfaceSR,this.spatialReference)}_updateTileGeometryState(e){e.updateVisibility(),this._renderer.updateTileGeometryState(e)&&this._markTileToUpdate(e),this._usedMemory=null}_markAllTileNeighborsForUpdate(e){e.forEachLoadedNeighbor((e=>{this._layerViews[pd.MAP].some(np.Q)&&e.setPendingUpdate(kp.TEXTURE_FADING),this._pendingTilesToUpdate.add(e)}))}_updateTileTexture(e,t){const i=e.resetPendingUpdate(kp.TEXTURE_FADING)?kp.TEXTURE_FADING:!!e.resetPendingUpdate(kp.TEXTURE_NOFADING)&&kp.TEXTURE_NOFADING;i&&(this._renderer.updateTileTexture(e,i),this._usedMemory=null,t.madeProgress())}_emitElevationUpdateEventForTiles(){if(!this._shouldEmitChangeEvent)return;const e=of.extent;(0,L.cS)(e),this._pendingTilesForElevationUpdateEvent.forEach((t=>(0,L.jn)(e,t.extent,e))),this._pendingTilesForElevationUpdateEvent.clear(),of.spatialReference=this.spatialReference,this.emit("elevation-change",of),this._shouldEmitChangeEvent=!1}runTask(e){this._handleLayerViewChanges(e),this._frameTask.processQueue(e),this.renderer.processScaleRangeQueries(this._scaleRangeQueries,e),this._inFrameTask=!0,this._pendingUpdates=0,this._hasPendingUpdates=!1,this._updateAllTilesStatus(e),this._sortTiles(e);const t=!this.view.state.fixedContentCamera;if(this._mergeAndSplit(e,t),this._updateElevation(e),this._updateTextures(e),t||this._mergeAndSplit(e,!0),this._inFrameTask=!1,this._runViewChangeUpdateIfDirty(),this._updatePendingTileGeometries(),this._emitElevationUpdateEventForTiles(),e.done&&e.hasProgressed&&this.requestUpdate(),this.notifyChange("updatingProgressValue"),np.T9&&this._checkTileInvariant(),!e.hasProgressed)return Gt.J}_checkTileInvariant(){const e=new Map;this._allTiles.forAll((t=>e.set(t,new Set))),this._allTiles.forAll((t=>{if((0,np.wu)(t.rendered===t.isLeaf," rendered ".concat(t.rendered," != ").concat(t.isLeaf," leaf")),!t.isLeaf){const e=e=>0===e.unmergableChildCount&&0===e.maxLevelDeltaNeighborCount,i=t.children.reduce(((t,i)=>t+(e(i)?0:1)),0);if((0,np.wu)(t.unmergableChildCount===i," Tile[".concat(t.lij.toString(),"] unmergeable child count mismatch: actual ").concat(t.unmergableChildCount," vs ").concat(i)),t.hasPendingUpdate(kp.MERGE)){(0,np.wu)(!t.hasPendingUpdate(kp.SPLIT),"Tile can be both split and merge at the same time");for(const e of t.children)(0,np.wu)(e.isLeaf||e.hasPendingUpdate(kp.MERGE),"Child of tile to merge must also merge")}}for(let n=0;n<4;++n){if(t.rendered){var i;const e=null===(i=t.renderData)||void 0===i?void 0:i.geometryState.edgePeerNeighbors[n];if(null!=e){{const i=t.level-e.level<=W.qC;i||(console.log("tile level delta [".concat(t.lij.toString(),"] vs [").concat(e.lij.toString(),"] > ").concat(W.qC,"  (edge[").concat(n,"])")),(0,np.wu)(i,"tile level delta [".concat(t.level,"] vs [").concat(e.level,"] > ").concat(W.qC)))}(0,np.wu)(t.level-e.level<=W.qC,"Max tile lod delta exceeded: [".concat(t.lij.toString(),"] vs [").concat(e.lij.toString(),"]"))}}const r=t.level-W.qC,s=e=>e.isLeaf||e.level===t.level,a=t.findNeighborTile(np.OC[n],s);if(null!=a){if(t.isLeaf&&t.level>=W.qC){let i=a;for(;t.level-i.level<W.qC;)i=i.parent;if(!$p([r,t.lij[1]>>W.qC,t.lij[2]>>W.qC],i.lij)){const n=e.get(i);(0,np.wu)(!n.has(t),"Cannot already have neighbor"),n.add(t)}}(0,np.wu)(a.rendered||a.level===t.level,"Non-same-level-neighbor of rendered must be rendered"),(0,np.wu)(t.level-a.level<=W.qC,"Tile level delta [".concat(t.level,"] vs [").concat(a.level,"] > ").concat(W.qC))}}})),this._allTiles.forAll((t=>{const i=t.maxLevelDeltaNeighborCount,n=e.get(t);(0,np.wu)(i===n.size,"Tile[".concat(t.lij.toString(),"] merge-blocker mismatch: actual ").concat(i," vs ").concat(n.size))}))}_updateAllTilesStatus(e){if(!this._viewChanged||!this._rootTiles||e.done)return;this._viewChanged=!1;const t=new cf(this._allTiles.length);t.pushAll(this._rootTiles);const i=this.snapLevel,n=this._splitLimits,r=this._eyePosRenderSR;this._allTiles.forAll((e=>{e.maxLevelDeltaNeighborCount=0,e.unmergableChildCount=0}));const s=this._viewProjectionMatrix;for(;!t.empty;){const e=t.pop(),a=e.parent,o=null!=a&&a.hasPendingUpdate(kp.MERGE),l=o?kp.MERGE:e.shouldSplit(n,r,i),h=l===kp.SPLIT;e.isLeaf?df(e,h):t.pushAll(e.children),o?(e.resetPendingUpdate(kp.SPLIT),e.isLeaf||e.setPendingUpdate(kp.MERGE),this._updateClippingStatus(e),e.updateVisibility(),e.updateScreenDepth(s)):h?(e.resetPendingUpdate(kp.MERGE),e.isLeaf&&e.setPendingUpdate(kp.SPLIT)):(e.resetPendingUpdate(kp.SPLIT)&&e.updateAgentSuspension(),l===kp.ELEVATION&&e.updateAgents(pd.ELEVATION),e.isLeaf||(e.setPendingUpdate(kp.MERGE),e.resetPendingUpdate(kp.SPLIT)))}this.requestUpdate(),(this._shortBatches||!this._oneBatchPerFrameTask)&&this._updatePendingTileGeometries(),e.madeProgress()}_sortTiles(e){e.done||this._allTilesSorted||((0,Up.b)(this._allTiles,this.view.pointsOfInterest.focus.renderLocation),this._allTilesSorted=!0,this._treeDebugger&&this._treeDebugger.update(),e.madeProgress())}_markTileToUpdate(e){(0,np.Fp)(e.isLoaded),e.intersectsClippingArea&&(this._pendingTilesToUpdate.add(e),this._markAllTileNeighborsForUpdate(e))}_updatePendingTileGeometries(){const e=this._pendingTilesToUpdate,t=Array.from(e.keys()).filter((e=>e.isLoaded&&e.intersectsClippingArea));if(0===t.length)return void e.clear();const i=(i,n)=>{null===n||void 0===n||!n.isLoaded||!n.intersectsClippingArea||n.level<i.level||e.has(n)||(e.add(n),t.push(n),n.renderData.updateNeighborData())};t.sort(Up.gl);const n=t.length;for(let r=0;r<n;++r){const n=t[r];(0,np.Fp)(n.isLoaded),(0,np.Fp)(n.intersectsClippingArea);const s=n.renderData;s.updateNeighborData();const a=s.dirtyEdgeResolutions,o=s.geometryState,l=e=>{var t;const r=np.cA[e];i(n,null===(t=o.cornerPeerNeighbors[e])||void 0===t?void 0:t.findCorner((0,np.$v)(r),(e=>e.isLoaded)))};for(let t=0;t<4;++t)if(a&1<<t){const r=s.geometryState.edgePeerNeighbors[t];r&&(null===r||void 0===r?void 0:r.level)>=n.level&&r.forAllSubtreeOnSide((0,np._F)(np.OC[t]),(t=>!(!t.isLoaded||!t.intersectsClippingArea)&&((0,np.Fp)(e.has(t)||(0,Up.gl)(n,t)<0),i(n,t),!0))),l((t+1)%4),l(t)}}e.clear(),this._updateTilesGeometries(t),this._shouldEmitChangeEvent=!0,np.T9&&np.V0&&this.checkAllTilesWaterproofness()}_mergeAndSplit(e,t){if(this.suspended||e.done||!this._allTilesDirty)return;this._allTilesDirty=!1,this.requestUpdate();let i=!1;const n=this.view.state.fixedContentCamera;let r=!1;for(;!e.done;){r=!0;let s=!1;const a=!this._allTiles.some((r=>{if(!i&&!n&&!r.visible)return e.done;let a=r;if(r.hasPendingUpdate(kp.MERGE)){if(!t||r.unmergableChildCount>0)return e.done;for(r.resetPendingUpdate(kp.MERGE);null!=a.parent&&0===a.parent.unmergableChildCount&&a.parent.resetPendingUpdate(kp.MERGE);)a=a.parent;this._mergeTile(a),s=!0,e.madeProgress()}else if(r.resetPendingUpdate(kp.SPLIT)){let t=!0;const i=r.level;if(i>=W.qC){const e=e=>e.isLeaf||i-e.level<W.qC;for(let n=0;n<4;++n){const s=r.findNeighborTile(np.OC[n],e);null!=s&&i-s.level===W.qC&&(t=!1,np.T9&&((0,np.Fp)(s.isLeaf),(0,np.Fp)(s.hasPendingUpdate(kp.SPLIT))))}}t?(this._splitTile(r),e.madeProgress(),s=!0):r.setPendingUpdate(kp.SPLIT)}return e.done}));if(s&&(this._allTilesSorted=!1,this._allTilesDirty=!0,!this._oneBatchPerFrameTask&&this._updatePendingTileGeometries()),a){if(!i){i=!0;continue}if(!s)break}else this._allTilesDirty=!0}r?e.madeProgress():this._allTilesDirty=!0,!this._oneBatchPerFrameTask&&this._updatePendingTileGeometries(),this._sortTiles(e)}_updateElevation(e){e.done||(this._allTiles.some((t=>(t.resetPendingUpdate(kp.GEOMETRY)&&(this._updateTileGeometryState(t),this._shortBatches&&this._updatePendingTileGeometries(),e.madeProgress()),e.done))),!this._oneBatchPerFrameTask&&this._updatePendingTileGeometries())}_updateTextures(e){e.done||this._allTiles.some((t=>(this._updateTileTexture(t,e),e.done)))}_updateClippingExtent(){this.spatialReference&&(this.updateTileOverlayParams(dp.Xx.UPDATE),this.overlayManager.setPlacementDirty(),this._updateRootTiles())}get _lodBias(){const e=this.view.quality;return this.view.qualitySettings.tiledSurface.lodBias-(1-e)*W.if}_getLodBiasCorrectedScale(e){const t=this.tilingScheme.levels,i=(0,me.uZ)(e-this._lodBias,0,t.length-1),n=i-Math.floor(i);return t[Math.floor(i)].scale*(1-n)+t[Math.ceil(i)].scale*n}_removeAllTiles(){null!=this._rootTiles&&(this._rootTiles.forEach((e=>this._purgeTile(e))),this._setRootTiles(null),this.notifyChange("ready")),this._allTiles.clear(),this.renderer.visible=!1}_purgeDescendantTiles(e){if(!e.children[0])return;const t=e.children.slice();e.unsetChildren();for(let i=0;i<4;++i)this._purgeTile(t[i])}_purgeTile(e){e.isLeaf?pf(e):this._purgeDescendantTiles(e),this._allTiles.removeUnordered(e),this._unloadTile(e),this._tileCache.put(ef._tileMemcacheKey,e)}_unloadTile(e){this._pendingTilesToUpdate.delete(e),this._pendingTilesForElevationUpdateEvent.delete(e),e.unload(this._renderer)}_splitTile(e){(0,np.wu)(e.isLeaf,"Tile that is already split should not be split again!"),(0,np.wu)(e.rendered,"Tile marked to split is not rendered"),pf(e);const t=e.level+1,i=2*e.lij[1],n=2*e.lij[2],r=e.setChildren(this._createTile(t,i,n,e),this._createTile(t,i,n+1,e),this._createTile(t,i+1,n,e),this._createTile(t,i+1,n+1,e));this._allTiles.pushArray(r),e.updateAgentSuspension(),(0,np.wu)(e.rendered,"parent should be rendered"),this._unloadTile(e),r.forEach((e=>this._loadTile(e))),r.forEach((e=>this._pendingTilesToUpdate.add(e))),this._markAllTileNeighborsForUpdate(e),this._emitTileScaleChange(e,e.level+1),this._allTilesDirty=!0,this._shortBatches&&this._updatePendingTileGeometries(),r.forEach((e=>df(e,e.hasPendingUpdate(kp.SPLIT)))),++this._performanceInfo.numSplit}_emitTileScaleChange(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:e.level;lf.spatialReference=this.spatialReference,lf.extent=e.extent,lf.scale=this._getLodBiasCorrectedScale(t),this.emit("scale-change",lf)}_createTile(e,t,i,n){(0,np.wu)(!!n,"_createTile sanity check");const r=this._acquireTile(e,t,i,n);return r.updateClippingStatus(this.extent),r.updateScreenDepth(this._viewProjectionMatrix),this._shouldSplit(r)&&r.setPendingUpdate(kp.SPLIT),r}get _shortBatches(){return this.view.state.mode!==Ia.n.IDLE}_mergeTile(e){(0,np.wu)(!e.hasPendingUpdate(kp.SPLIT),"_mergeTile sanity check"),(0,np.wu)(!e.isLeaf,"Cannot merge a leaf"),e.isLeaf||(this._purgeDescendantTiles(e),(0,np.wu)(!e.renderData,"_mergeTile sanity check"),this._loadTile(e),this._markTileToUpdate(e),this._emitTileScaleChange(e),this._shortBatches&&this._updatePendingTileGeometries(),df(e,!1),this._allTilesDirty=!0,++this._performanceInfo.numMerged)}_loadTile(e){e.load(),this.requestUpdate(),this._allTilesDirty=!0,this.overlayManager&&this.overlayManager.hasOverlays&&this.overlayManager.setTileParameters(e)}_handleLayerViewChanges(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:Bt.G5;if(!this._layerViewsDirty)return;this._layerViewsDirty=!1;let t=!1;const i=new Set;let n=-1;for(let r=this.view.allLayerViews.length-1;r>=0;r--){const e=this.view.allLayerViews.items[r];if(i.add(e.uid),(0,np.wP)(e)||(0,np.a_)(e))if(this._basemapLayerViewHandles.has(e.uid)&&!(0,np.a_)(e)){const i=this._layerClassFromLayerView(e),r=this._getLayerIdxByUID(i,e.uid);null!=r&&((r<n||null==n)&&(t=!0),n=r)}else this._registerTiledLayerView(e),e.layer.loaded&&(t=!0)}this._basemapLayerViewHandles.forEach(((e,n)=>{i.has(n)||(this._unregisterTiledLayerView(n),t=!0)})),t&&this._updateTiledLayers(),this.hasCompositeBlendMode=this._hasCompositeBlendMode(),this._evaluateTransparency(),e.madeProgress()}_allSurfaceLayersTransparent(){var e;let t=0===(null===(e=this.view.map)||void 0===e||null===(e=e.ground)||void 0===e?void 0:e.opacity);for(const i of this.view.allLayerViews.items)if((0,np.GL)(i)&&!(0,F.sy)(i.layer)&&0!==i.fullOpacity)return t=!1,t;return t}_hasCompositeBlendMode(){for(const e of this.view.allLayerViews.items)if(((0,np.TK)(e)||(0,np.a_)(e))&&(0,Dm.MV)(Dm.pU[e.layer.blendMode]))return!0;return!1}_layerClassFromLayerView(e){return(0,np._1)(e)?pd.ELEVATION:pd.MAP}_registerTiledLayerView(e){const t=[];if(((0,np.TK)(e)||(0,np.a_)(e))&&t.push((0,g.watch)((()=>e.layer.blendMode),(()=>{this.hasCompositeBlendMode=this._hasCompositeBlendMode(),this._updateTileTextures(lp.Ns.UNFADED)}))),!(0,np.a_)(e)){const i=this._layerClassFromLayerView(e);t.push((0,g.watch)((()=>e.suspended),(()=>this._updateTiledLayers()))),t.push((0,g.watch)((()=>e.fullOpacity),(()=>this._updateTileTextures(lp.Ns.UNFADED)))),t.push((0,g.watch)((()=>"effectiveScaleRange"in e.layer?e.layer.effectiveScaleRange:null),(()=>this._restartAllAgents(i)))),t.push(e.on("data-changed",(()=>{const t=this._getLayerIdxByUID(i,e.uid);null!=t&&this._invalidateLayerData(t,i)})))}this._unregisterTiledLayerView(e.uid),this._basemapLayerViewHandles.set(e.uid,t)}_unregisterTiledLayerView(e){const t=this._basemapLayerViewHandles.get(e);if(t){for(const e of t)e.remove();this._basemapLayerViewHandles.delete(e)}}_updateTiledLayers(){if(!this.tilingScheme||this.view.suspended)return;const e=this.view.allLayerViews,t=[[],[]];let i=null;e.forEach((e=>{if(!e.layer||e.suspended||!(0,np.wP)(e)||!e.fullExtent)return;const n=this._layerClassFromLayerView(e);if(n===pd.MAP){const t=e.displayLevelRange.maxLevel;t!==1/0&&(null===i||t>i)&&(i=t)}t[n].push(e)}));for(const n of vd){const e=this._layerViews[n],i=t[n];i.reverse();const r=i.length;let s=e.length!==r;const a=new Array(r),o=new Array(e.length);this._layerIndexByUid[n].clear();for(let t=0;t<r;t++){const r=i[t].uid;this._layerIndexByUid[n].set(r,t);const l=e.indexOf(i[t]);a[t]=l,t!==l&&(s=!0),l>-1&&(o[l]=t)}if(s){const e=this._postorderIterator;for(e.reset(this._rootTiles);!e.done;)e.next().modifyLayers(o,a,n);this._layerViews[n]=i,this._restartAllAgents(n),this._updateTilesVisibility(this._rootTiles)}}this.tilingScheme.ensureMaxLod(i)&&(this._viewChangeUpdate(),this.notifyChange("tilingScheme"))}_restartAllAgents(e){const t=this._postorderIterator;for(t.reset(this._rootTiles);!t.done;){const i=t.next();i.restartAgents(e),e===pd.ELEVATION&&i.computeElevationBounds()}this._updateRootTileElevationBounds()}layerViewByIndex(e,t){return this._layerViews[t][e]}numLayers(e){return this._layerViews[e].length}_updateTileTextures(e){this._allTiles.forAll((t=>{t.updateAgents(pd.MAP),e===lp.Ns.IMMEDIATE?this.renderer.updateTileTexture(t,kp.TEXTURE_NOFADING):t.updateRenderData(pd.MAP,e)})),this._evaluateTransparency()}_invalidateLayerData(e,t){this._allTiles.forAll((i=>i.removeLayerAgent(e,t))),this._allTiles.forAll((i=>i.invalidateLayerData(e,t)))}setTileTreeDirty(){this._allTilesDirty=!0}requestRender(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:dp.Xx.UPDATE;this.renderer.setNeedsRender(e)}requestUpdate(){1==++this._pendingUpdates&&(this._hasPendingUpdates=!0)}requestTileData(e,t,i,n){const r=this.layerViewByIndex(t,i),s=r.layer;return!s.tilemapCache||(0,np.Q)(r)?this._requestTileData(e,i,r,n):(++this._asyncWorkItems,s.tilemapCache.fetchAvailability(e.lij[0],e.lij[1],e.lij[2],{...n,timeout:6e3}).then((()=>--this._asyncWorkItems)).catch((t=>{throw--this._asyncWorkItems,(0,m.k_)(n),(0,m.D_)(t)||this._dataMissing(e,i,r),t})).then((()=>this._frameTask.schedule((()=>this._requestTileData(e,i,r,n)),n.signal))))}_requestTileData(e,t,i,n){var r;const s=t===pd.ELEVATION;return null!==(r=n.requester)&&void 0!==r||(n.requester=s?this._elevationDataRequester:this._mapDataRequester),s?(0,np._1)(i)?this._requestElevationTileData(e,i,n):Promise.reject():(0,np.GL)(i)?this._requestMapTileData(e,i,n):Promise.reject()}_requestElevationTileData(e,t,i){++this._asyncWorkItems;const n=n=>{!(0,m.Hc)(i)&&n&&(this._usedMemory=null,this.requestUpdate(),this._elevationDataArrived(e,t,n))};return t.fetchTile(e.lij,i).then((e=>this._frameTask.schedule((()=>n(e)))),(i=>{(0,m.D_)(i)||(u.Z.getLogger(this).error("Tile ".concat(e.lij.toString()," layer ").concat(pd.ELEVATION,"/").concat(t.uid," error ").concat(i)),this._dataMissing(e,pd.ELEVATION,t),this.requestUpdate())})).finally((()=>--this._asyncWorkItems))}_elevationDataArrived(e,t,i){const n=this._layerIndexByUid[pd.ELEVATION].get(t.uid);if(null==n)return void u.Z.getLogger(this).warn("TerrainSurface: received data from unknown layer %d %s",pd.ELEVATION,e.lij.toString());const r=new ep(e.lij,e.extent,i);e.dataArrived(n,pd.ELEVATION,r);const s=[e],a=e.level,o=this._iteratorPool.acquire();for(o.reset(s);!o.done;){const e=o.next();e.findElevationBoundsForLayer(n,a),e.computeElevationBounds()}0===a&&this._updateRootTileElevationBounds(),o.remove(),this._updateTilesVisibility(s)}_requestMapTileData(e,t,i){var n=this;++this._asyncWorkItems;const r=(n,r)=>{(0,np.ep)(r),(0,m.Hc)(i)||(console.error("Tile ".concat(e.lij.toString()," layer ").concat(pd.MAP,"/").concat(t.uid," error ").concat(n)),this._dataMissing(e,pd.MAP,t),this.requestUpdate())},s=e=>t=>r(t,e);return t.fetchTile(e.lij,i).then((n=>this._frameTask.schedule((()=>{this.requestUpdate(),(0,m.Hc)(i)?(0,np.ep)(n):this._mapTileDataArrived(e,t,n)}),i.signal,s(n)).catch(s(n))),(function(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;return n._frameTask.schedule((()=>r(e,t)))})).finally((()=>--this._asyncWorkItems))}_mapTileDataArrived(e,t,i){const n=this._getLayerIdxByUID(pd.MAP,t.uid);if(null==n)return(0,np.ep)(i),void u.Z.getLogger(this).warn("TerrainSurface: received data from unknown layer");e.dataArrived(n,pd.MAP,i)}_getLayerIdxByUID(e,t){return this._layerIndexByUid[e].get(t)}_dataMissing(e,t,i){const n=this._getLayerIdxByUID(t,i.uid);null!=n?e.dataMissing(n,t):u.Z.getLogger(this).warn("TerrainSurface: received data from unknown layer")}updateTileOverlayParams(e){this._rootTiles&&this.overlayManager&&(this._allTiles.forAll((e=>{e.renderData&&this.overlayManager.setTileParameters(e)})),this._renderer.setNeedsRender(e))}get performanceInfo(){const e=this._performanceInfo;return e.numNodes=this._allTiles.length,e.numLeaves=e.numVisible=e.numRendered=e.numLoadedPerLevel.length=e.numRenderedPerLevel.length=0,this._allTiles.forAll((t=>{t.isLeaf&&e.numLeaves++;const i=t.level;t.renderData&&(e.numLoadedPerLevel[i]=(e.numLoadedPerLevel[i]||0)+1),t.visible&&(e.numVisible++,t.rendered&&(e.numRenderedPerLevel[i]=(e.numRenderedPerLevel[i]||0)+1,e.numRendered++))})),e}get usedMemory(){var e;return this.tilingScheme?(null==this._usedMemory&&(this._usedMemory=this._recalculateUsedMemory()),null!==(e=this._usedMemory)&&void 0!==e?e:0):0}_recalculateUsedMemory(){return this.tilingScheme?Math.round(this._allTiles.reduce(((e,t)=>e+t.usedMemory),0)):null}getUsedMemoryForLayerView(e){let t=0;const i=this._layerClassFromLayerView(e),n=this._getLayerIdxByUID(i,e.uid);return null!=n&&this._allTiles.forAll((e=>t+=e.getUsedMemoryForLayer(i,n))),t}getTile(e){if(null==e||null==this._rootTiles)return null;const t=e.split("/").map((e=>+e));if(0===t[0])return this._rootTiles.find((e=>e.lij[1]===t[1]&&e.lij[2]===t[2]));const i=t[0],n=t[1]>>i,r=t[2]>>i;let s;if(this._rootTiles.some((e=>e.lij[1]===n&&e.lij[2]===r&&(s=e,!0))),s){let e=1<<t[0]-1;for(;s.lij[0]<t[0];){let i=t[1]&e?2:0;if((t[2]&e)>0&&i++,!s.children[i])return null;s=s.children[i],e>>=1}return(0,np.wu)(s.lij[0]===t[0]&&s.lij[1]===t[1]&&s.lij[2]===t[2],"not the right tile?"),s}return null}get renderPatchBorders(){return this._renderer.renderPatchBorders}set renderPatchBorders(e){this._renderer.renderPatchBorders=e}get visualizeNormals(){return this._renderer.visualizeNormals}set visualizeNormals(e){this._renderer.visualizeNormals=e}get renderingDisabled(){return this._renderer.renderingDisabled}set renderingDisabled(e){this._renderer.renderingDisabled=e}get test(){}checkAllTilesWaterproofness(){if(!np.V0)return;const e=this._rootTiles;if(null==e)return;const t=e=>{var t;return(null===e||void 0===e||null===(t=e.renderData)||void 0===t||null===(t=t.geometry)||void 0===t||null===(t=t.indices)||void 0===t?void 0:t.length)>0},i=(e,i)=>{t(e)&&console.error("Tile[",e.lij,"] has geometry although parent[",i.lij,"] has geom")},n=e=>{var r,s,a;if(e.intersectsClippingArea)if(e.renderData&&!e.renderData.geometryState&&console.error("Tile[",e.lij,"] has renderData but not geometryState"),e.renderData&&!e.renderData.geometry&&console.error("Tile[",e.lij,"] has renderData but not geometryInfo"),!(null!==(r=e.renderData)&&void 0!==r&&r.geometry)||(null!==(s=null===(a=e.renderData.geometry.indices)||void 0===a?void 0:a.length)&&void 0!==s?s:0)>0||console.error("Tile[",e.lij,"] has renderData but no indices - geometryInfo: ",e.renderData.geometry),t(e)){e.checkGeometryWaterproofness();for(const t of e.children)i(t,e)}else if(e.isLeaf)console.error("Tile[",e.lij,"] has no geometry and no children, from root to leaf");else for(const t of e.children)n(t)},r=e=>{var t,i;const n=null===(t=null===(i=e.parent)||void 0===i?void 0:i.visible)||void 0===t||t,s=e.visible;e.computeVisibility();const a=e.visible;if(s!==a&&n&&console.error(" Tile[",e.lij,"] has out of date visibility: ",s," instead of ",a),!e.isLeaf)for(const o of e.children)r(o)};for(const s of e)n(s),r(s)}get isGlobal(){return this._isGlobal}get isGeographic(){return this._isGeographic}get isWebMercator(){return this._isWebMercator}get isWebMercatorOnPlateCarree(){return this._isWebMercatorOnPlateCarree}isEastEndWrap(e){return this._isGlobal&&e[2]===this.lijEastEnd(e[0])-1}isWestEndWrap(e){return this._isGlobal&&0===e[2]}lijEastEnd(e){return 1<<e+(this._isGeographic?1:0)}wrapEastWest(e){const t=this.lijEastEnd(e[0]),i=e[2];if(0<=i&&i<t)return e;if(!this._isGlobal)return null;const n=(i+(i<0?t:0))%t;return[e[0],e[1],n]}enableInternalChecks(e){(0,np.qA)(e)}enableWaterproofnessChecks(e){(0,np.HK)(e)}};tf._tileMemcacheKey="TerrainTileMemcache",(0,n._)([(0,b.Cb)()],tf.prototype,"_renderer",void 0),(0,n._)([(0,b.Cb)({constructOnly:!0})],tf.prototype,"_scaleRangeQueries",void 0),(0,n._)([(0,b.Cb)({constructOnly:!0})],tf.prototype,"view",void 0),(0,n._)([(0,b.Cb)({constructOnly:!0})],tf.prototype,"overlayManager",void 0),(0,n._)([(0,b.Cb)()],tf.prototype,"_hasPendingUpdates",void 0),(0,n._)([(0,b.Cb)()],tf.prototype,"_asyncWorkItems",void 0),(0,n._)([(0,b.Cb)()],tf.prototype,"_allTilesDirty",void 0),(0,n._)([(0,b.Cb)()],tf.prototype,"_allTilesSorted",void 0),(0,n._)([(0,b.Cb)()],tf.prototype,"_viewChanged",void 0),(0,n._)([(0,b.Cb)({type:Number})],tf.prototype,"heading",void 0),(0,n._)([(0,b.Cb)()],tf.prototype,"_splitLimits",void 0),(0,n._)([(0,b.Cb)({readOnly:!0})],tf.prototype,"_watchUpdatingTracking",void 0),(0,n._)([(0,b.Cb)()],tf.prototype,"_frameTask",void 0),(0,n._)([(0,b.Cb)({readOnly:!0})],tf.prototype,"snapLevel",null),(0,n._)([(0,b.Cb)({readOnly:!0})],tf.prototype,"lodSnapping",null),(0,n._)([(0,b.Cb)()],tf.prototype,"_userClippingExtent",null),(0,n._)([(0,b.Cb)()],tf.prototype,"_rootTilesExtent",void 0),(0,n._)([(0,b.Cb)({readOnly:!0})],tf.prototype,"extent",null),(0,n._)([(0,b.Cb)({readOnly:!0})],tf.prototype,"groundExtent",null),(0,n._)([(0,b.Cb)({readOnly:!0})],tf.prototype,"_tilingSchemeExtent",null),(0,n._)([(0,b.Cb)({readOnly:!0})],tf.prototype,"updating",null),(0,n._)([(0,b.Cb)({readOnly:!0})],tf.prototype,"running",null),(0,n._)([(0,b.Cb)(Ju.q)],tf.prototype,"updatingProgress",void 0),(0,n._)([(0,b.Cb)({readOnly:!0})],tf.prototype,"updatingProgressValue",null),(0,n._)([(0,b.Cb)()],tf.prototype,"_maxNumUpdating",void 0),(0,n._)([(0,b.Cb)()],tf.prototype,"baseOpacity",null),(0,n._)([(0,b.Cb)()],tf.prototype,"hasCompositeBlendMode",void 0),(0,n._)([(0,b.Cb)({readOnly:!0})],tf.prototype,"viewingMode",null),(0,n._)([(0,b.Cb)()],tf.prototype,"maxTextureScale",void 0),(0,n._)([(0,b.Cb)({readOnly:!0})],tf.prototype,"ready",null),(0,n._)([(0,b.Cb)({value:mm.z.FRONT_TO_BACK})],tf.prototype,"renderOrder",null),(0,n._)([(0,b.Cb)({readOnly:!0})],tf.prototype,"rootTiles",null),(0,n._)([(0,b.Cb)()],tf.prototype,"_rootTiles",void 0),(0,n._)([(0,b.Cb)({readOnly:!0})],tf.prototype,"spatialReference",null),(0,n._)([(0,b.Cb)({type:ld.Z})],tf.prototype,"backgroundColor",null),(0,n._)([(0,b.Cb)({value:!1})],tf.prototype,"slicePlaneEnabled",null),(0,n._)([(0,b.Cb)({readOnly:!0})],tf.prototype,"tilingScheme",void 0),(0,n._)([(0,b.Cb)({readOnly:!0})],tf.prototype,"tilingSchemeLocked",null),(0,n._)([(0,b.Cb)({readOnly:!0})],tf.prototype,"tilingSchemeLogic",void 0),(0,n._)([(0,b.Cb)()],tf.prototype,"wireframe",null),(0,n._)([(0,b.Cb)({value:!1})],tf.prototype,"suspended",null),(0,n._)([(0,b.Cb)()],tf.prototype,"fadeDuration",null),(0,n._)([(0,b.Cb)()],tf.prototype,"visibleElevationBounds",void 0),(0,n._)([(0,b.Cb)()],tf.prototype,"rootTileElevationBounds",void 0),(0,n._)([(0,b.Cb)()],tf.prototype,"_layerViewsDirty",void 0),(0,n._)([(0,b.Cb)()],tf.prototype,"renderPatchBorders",null),(0,n._)([(0,b.Cb)()],tf.prototype,"visualizeNormals",null),(0,n._)([(0,b.Cb)()],tf.prototype,"renderingDisabled",null),tf=ef=(0,n._)([(0,C.j)("esri.views.3d.terrain.TerrainSurface")],tf);const nf=tf,rf=(0,R.Ue)(),sf=(0,bn.c)(),af=(0,L.Ue)();new pl.Z;const of=new Yu.c("ground"),lf={spatialReference:null,extent:null,scale:0};function hf(e,t,i){for(const s of e){var n,r;if(!s.containsPointXY(t,i))continue;let e=s;for(;e&&!e.renderData;){const n=(t>e.extentMidX?1:0)+(i<e.extentMidY?2:0);e=e.children[n]}return ip(t,i,null!==(n=null===(r=e)||void 0===r||null===(r=r.renderData)||void 0===r?void 0:r.geometryState.samplerData)&&void 0!==n?n:null)}return null}class cf{constructor(e){this.capacity=e,this._head=0,this._tail=0,this._data=new Array(e)}push(e){const t=this._tail;if(!(t<this.capacity))throw new Error("Queue full");this._data[t]=e,this._tail=t+1}pushAll(e){const t=e.length;if(0===t)return;const i=this._tail;if(!(i+t<=this.capacity))throw new Error("Queue full");for(let n=0;n<t;++n)this._data[i+n]=e[n];this._tail=i+t}pop(){const e=this._head;if(e<this._tail){const t=this._data[e];return this._head=e+1,t}}get empty(){return this._head>=this._tail}get full(){return this._tail>=this._data.length}}function df(e,t){!e.isLeaf||e.level<W.qC||mf(e,(e=>{t&&uf(e);const i=_f(e);if(e.maxLevelDeltaNeighborCount++,i){let t=e.parent;for(;t;){const e=_f(t);if(t.unmergableChildCount++,!e)break;t=t.parent}}}))}function uf(e){if(e.hasPendingUpdate(kp.SPLIT))return;let t=e.parent;for(;null!==(i=t)&&void 0!==i&&i.resetPendingUpdate(kp.MERGE);){var i;t=t.parent}e.resetPendingUpdate(kp.MERGE),e.isLeaf&&e.setPendingUpdate(kp.SPLIT),e.level<W.qC||mf(e,(e=>{uf(e)}))}function pf(e){e.level<W.qC||mf(e,(e=>{if(e.maxLevelDeltaNeighborCount--,0===e.maxLevelDeltaNeighborCount&&0===e.unmergableChildCount){let t=e.parent;for(;t&&(t.unmergableChildCount--,_f(t));)t=t.parent}}))}function _f(e){return 0===e.maxLevelDeltaNeighborCount&&0===e.unmergableChildCount}function mf(e,t){if(e.level<W.qC)return;const i=e.level-W.qC,n=e.lij[1]>>W.qC,r=e.lij[2]>>W.qC,s=e=>e.isLeaf||e.level===i;for(let a=0;a<4;++a){const o=e.findNeighborTile(np.OC[a],s);if(!o||o.level!==i)continue;const l=o.lij;l[1]===n&&l[2]===r||t(o)}}var gf=i(78976),ff=i(78485),vf=i(97882),yf=i(79100),bf=i(19962),wf=i(78289);class Cf{constructor(e,t,i,n){this.operation=e,this.geometry=t,this.states=i,this.sync=n}}let xf=class extends T.default{constructor(e){super(e),this._residentGeomRecords=new Map,this._dirtyGeomRecords=new Map,this.dirty=!1}commitLayer(e,t){const i=this._dirtyGeomRecords.get(e);i&&(i.forEach(((i,n)=>{const r=this._ensureGeomRecord(e,n);i.forEach(((e,i)=>{let{geometry:s,operation:a,states:o}=e,l=!1;if(a===wf.T.UPDATE){const e=r.get(i);if(e){if(o&wf.$.TRANSFORMATION){const t=this.model.getObject(n);this.model.updateRenderGeometryTransformation(t,s,e)&&(l=!0)}l||t.updates.push({renderGeometry:e,updateType:o})}else(0,vi.hu)(!1,"ModelDirtySet.commitLayer: invalid update")}if(a===wf.T.REMOVE||l){const e=r.get(i);e?(t.removes.push(e),r.delete(i)):a===wf.T.REMOVE&&(0,vi.hu)(!1,"ModelDirtySet.commitLayer: invalid remove")}if(a===wf.T.ADD||l){const e=this.model.getObject(n);if(null!=e){const n=this.model.getRenderGeometry(e,s);t.adds.push(n),r.set(i,n)}}})),0===r.size&&this._residentGeomRecords.get(e).delete(n)})),0===this._residentGeomRecords.get(e).size&&this._residentGeomRecords.delete(e),this._dirtyGeomRecords.delete(e),this.dirty=this._hasDirtyGeometryRecords)}commitSyncUpdates(e,t){const i=this._dirtyGeomRecords.get(e);i&&i.forEach(((i,n)=>{const r=this._ensureGeomRecord(e,n);i.forEach(((e,i)=>{let{geometry:s,operation:a,states:o,sync:l}=e,h=!1;if(a===wf.T.UPDATE&&l){const e=r.get(i);if(e){if(o&wf.$.TRANSFORMATION){const t=this.model.getObject(n);this.model.updateRenderGeometryTransformation(t,s,e)&&(h=!0)}h||t.updates.push({renderGeometry:e,updateType:o})}else(0,vi.hu)(!1,"ModelDirtySet.commitSyncUpdates: invalid update")}}))}))}getResidentRenderGeometries(e,t){const i=this._residentGeomRecords.get(e);i&&i.forEach((e=>e.forEach((e=>t.push(e)))))}_objectStateChanged(e,t){for(const i of t.geometries)this._updateOrCreateDirtyRecord(t,i,null,wf.T.UPDATE,e)}visibilityChanged(e){this._objectStateChanged(wf.$.VISIBILITY,e)}highlightChanged(e){this._objectStateChanged(wf.$.HIGHLIGHT,e)}occlusionChanged(e){this._objectStateChanged(wf.$.OCCLUDEE,e)}attributesChanged(e){let{object:t,geometry:i,sync:n}=e;this._updateOrCreateDirtyRecord(t,i,null,wf.T.UPDATE,wf.$.GEOMETRY,n)}layerAdded(e){e.objects.forAll((t=>this._layerObjectAdded(e,t)))}layerRemoved(e){e.objects.forAll((t=>this._layerObjectRemoved(e,t)))}layerObjectAdded(e){this._layerObjectAdded(e.layer,e.object)}_layerObjectAdded(e,t){const i=e.id;for(const n of t.geometries)this._geometryAdded(t,n,i)}layerObjectRemoved(e){this._layerObjectRemoved(e.layer,e.object)}layerObjectsAdded(e){for(const t of e.objects)this._layerObjectAdded(e.layer,t)}layerObjectsRemoved(e){for(const t of e.objects)this._layerObjectRemoved(e.layer,t)}_layerObjectRemoved(e,t){const i=e.id;for(const n of t.geometries)this._geometryRemoved(t,n,i)}transformationChanged(e){const t=this._getParentLayerId(e),i=e.id;this._ensureGeomRecord(t,i).forEach((i=>{this._updateOrCreateDirtyRecord(e,i.geometry,t,wf.T.UPDATE,wf.$.TRANSFORMATION)}))}shaderTransformationChanged(e){const t=this._getParentLayerId(e),i=e.id;this._ensureGeomRecord(t,i).forEach((t=>{t.objectShaderTransformationChanged(e.shaderTransformation)}))}geometryAdded(e){this._geometryAdded(e.object,e.geometry)}_geometryAdded(e,t){let i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null;this._updateOrCreateDirtyRecord(e,t,i,wf.T.ADD)}geometryRemoved(e){this._geometryRemoved(e.object,e.geometry)}_geometryRemoved(e,t){let i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null;this._updateOrCreateDirtyRecord(e,t,i,wf.T.REMOVE)}_updateOrCreateDirtyRecord(e,t,i,n){var r;let s=arguments.length>4&&void 0!==arguments[4]?arguments[4]:wf.$.NONE,a=arguments.length>5&&void 0!==arguments[5]&&arguments[5];i=null!==(r=i)&&void 0!==r?r:this._getParentLayerId(e);const o=e.id,l=t.id,h=this._ensureDirtyRecord(i,o),c=h.get(l);let d=!1;if(c){const e=c.operation;e===wf.T.REMOVE&&n===wf.T.ADD&&c.states!==wf.$.NONE?c.operation=wf.T.UPDATE:e===wf.T.REMOVE&&n===wf.T.ADD||e===wf.T.ADD&&n===wf.T.REMOVE?(h.delete(l),d=!0):e!==wf.T.UPDATE||n!==wf.T.REMOVE&&n!==wf.T.UPDATE?((0,vi.hu)((e===wf.T.REMOVE||e===wf.T.ADD)&&n===wf.T.UPDATE,"ModelDirtySet.objectGeometryAdded: inconsistent state"),c.states|=s):(c.operation=n,c.states|=s),c.sync=c.sync||a}else h.set(l,new Cf(n,t,s,a));this.dirty=!d||this._hasDirtyGeometryRecords}_ensureGeomRecord(e,t){let i=this._residentGeomRecords.get(e);i||(i=new Map,this._residentGeomRecords.set(e,i));let n=i.get(t);return n||(n=new Map,i.set(t,n)),n}get _hasDirtyGeometryRecords(){for(const e of this._dirtyGeomRecords.values())for(const t of e.values())if(t.size>0)return!0;return!1}_ensureDirtyRecord(e,t){let i=this._dirtyGeomRecords.get(e);i||(i=new Map,this._dirtyGeomRecords.set(e,i));let n=i.get(t);return n||(n=new Map,i.set(t,n)),n}_getParentLayerId(e){return e.parentLayer?e.parentLayer.id:eh.J}formatDebugInfo(){const e=["ADD","UPD",void 0,"REM"];let t="";return this._dirtyGeomRecords.forEach(((i,n)=>{i.forEach(((i,r)=>{t.length>0&&(t+="\n"),t+=n+"."+r;const s=[];i.forEach((e=>{const t=e.operation;s[t]||(s[t]=[]),s[t].push(e.geometry.id)}));for(let n=0;n<s.length;n++)if(s[n]){t+=" "+e[n-1]+": ";for(let e=0;e<s[n].length;e++)t+=s[n][e]+", "}}))})),t}get test(){}};(0,n._)([(0,b.Cb)({constructOnly:!0})],xf.prototype,"model",void 0),(0,n._)([(0,b.Cb)()],xf.prototype,"dirty",void 0),xf=(0,n._)([(0,C.j)("esri.views.3d.webgl-engine.lib.ModelDirtySet")],xf);const Tf=xf;var Sf=i(39077);let Pf=class extends T.default{constructor(){super(...arguments),this.dirtySet=new Tf({model:this}),this._content=new Map,this._originFactory=new bf.C(null)}getObject(e){return this._content.get(e)}add(e){const t=e.id;(0,vi.hu)(!this._content.has(t),"Model/Stage already contains object to be added"),this._content.set(t,e),(0,vf.e)(e)&&this.dirtySet.layerAdded(e)}remove(e){return!!this._content.has(e.id)&&(this._content.delete(e.id),(0,vf.e)(e)&&this.dirtySet.layerRemoved(e),!0)}addMany(e){for(const t of e)t&&((0,vi.hu)(!this._content.has(t.id),"Model/Stage already contains object to be added"),this._content.set(t.id,t))}removeMany(e){for(const t of e)t&&((0,vi.hu)(this._content.has(t.id),"Model/Stage doesn't contain object to be removed"),this._content.delete(t.id))}has(e){return this._content.has(e.id)}forEachOfType(e,t){this._content.forEach((i=>{i.type===e&&t(i)}))}getRenderGeometry(e,t){const i=new Sf.z(t,{castShadow:e.castShadow,objectShaderTransformation:e.shaderTransformation});i.transformation=e.getCombinedStaticTransformation(t,Mf);const{localOrigin:n}=t;return i.localOrigin=null!=n?n:this._originFactory.getOrigin((0,bn.g)(i.boundingSphere)),i}updateRenderGeometryTransformation(e,t,i){if(null==e)return!1;i.transformation=e.getCombinedStaticTransformation(t,Mf);const n=this._originFactory.getOrigin((0,bn.g)(i.boundingSphere));return i.localOrigin!==n}getStats(){const e={},t=Array.from(this._content.values());for(let i=0;i<yf.U.COUNT;++i)e[i]=t.filter((e=>e.type===i)).length;return{contentTypes:e,dirtySet:this.dirtySet.formatDebugInfo()}}get test(){}};(0,n._)([(0,b.Cb)({constructOnly:!0})],Pf.prototype,"dirtySet",void 0),Pf=(0,n._)([(0,C.j)("esri.views.3d.webgl-engine.parts.Model")],Pf);const Mf=(0,Mt.Ue)();var Rf=i(18722),Af=i(39406),Of=i(11186),Ef=i(92770),Df=i(49420),If=i(89414);class Lf{constructor(e){this._totalCount=e,this._componentCountCache=-1,this._indexRanges=[0,e]}allVisible(){return this.componentCount===this._totalCount}allInvisible(){return 0===this._indexRanges.length}isVisible(e){if(e<0||e>=this._totalCount)return!1;if(this.allVisible())return!0;{const t=this._indexRanges;let i=0,n=t.length/2;if(e<t[2*i]||e>t[2*n]+t[2*n+1])return!1;for(;n-i>0;){const r=Math.floor(.5*(i+n)),s=t[2*r];if(e<s){if(n-i==1)return!1;n=r}else{if(e<s+t[2*r+1])return!0;if(n-i==1)return!1;i=r+1}}return!1}}get componentCount(){if(-1===this._componentCountCache){const e=this._indexRanges;let t=0;for(let i=0;i<e.length;i+=2)t+=e[i+1];this._componentCountCache=t}return this._componentCountCache}reset(e){"all"===e||e.length===this._totalCount?this._indexRanges=[0,this._totalCount]:this._indexRanges=function(e){const t=new Array;if(0===e.length)return t;let i=e[0],n=1;for(let r=1;r<e.length;r++){const s=e[r];i+n===s?n+=1:(t.push(i),t.push(n),i=s,n=1)}return t.push(i),t.push(n),t}(e),this._componentCountCache=-1}forEachComponent(e){const t=this._indexRanges;for(let i=0;i<t.length;i+=2){const n=t[i],r=n+t[i+1];for(let t=n;t<r;t++)if(!e(t))return!1}return!0}forEachComponentRange(e){const t=this._indexRanges;for(let i=0;i<t.length;i+=2){const n=t[i];if(!e(n,n+t[i+1]))return!1}return!0}computeOffsetRanges(e){const t=new Array(this._indexRanges.length),i=this._indexRanges;for(let n=0;n<i.length;n+=2){const r=i[n],s=r+i[n+1],a=e[r],o=e[s];t[n]=a,t[n+1]=o-a}return t}}class Nf{constructor(e,t){this.offsets=t,this.pickability=null,this.highlightCounts=null,this.verticalOffsets=null,this.cachedGeometryRanges=null,this.cachedHighlightRanges=null,this.cachedDefaultRanges=null;const i=this.count;this.visibility=new Lf(i),this.materialDataBuffer=e.getBuffer(i),this.materialDataIndices=new Uint16Array(i);for(let n=0;n<i;n++)this.materialDataIndices[n]=this.materialDataBuffer.acquireIndex()}destroy(){for(let e=0;e<this.count;e++)this.materialDataBuffer.releaseIndex(this.materialDataIndices[e])}get count(){return this.offsets.length-1}get geometryRanges(){return null==this.cachedGeometryRanges&&(this.cachedGeometryRanges=this.visibility.computeOffsetRanges(this.offsets)),this.cachedGeometryRanges}get highlightRanges(){return null==this.highlightCounts?null:(this._updateCachedHighlightRanges(),this.cachedHighlightRanges)}get defaultShadowMapRanges(){return null==this.highlightCounts?this.geometryRanges:(this._updateCachedHighlightRanges(),this.cachedDefaultRanges)}highlightsDirty(){this.cachedHighlightRanges=null,this.cachedDefaultRanges=null}visibilityDirty(){this.cachedGeometryRanges=null,this.highlightsDirty()}_updateCachedHighlightRanges(){if((null==this.cachedHighlightRanges||null==this.cachedDefaultRanges)&&null!=this.highlightCounts){const{highlightRanges:e,defaultRanges:t}=function(e,t,i){const n=[],r=[];let s=i.length,a=i.length;return t.forEachComponent((t=>(e[t]>0?(s!==t-1&&(n.length&&n.push(i[s+1]-n[n.length-1]),n.push(i[t])),s=t):(a!==t-1&&(r.length&&r.push(i[a+1]-r[r.length-1]),r.push(i[t])),a=t),!0))),n.length&&n.push(i[s+1]-n[n.length-1]),r.length&&r.push(i[a+1]-r[r.length-1]),{highlightRanges:n,defaultRanges:r}}(this.highlightCounts,this.visibility,this.offsets);this.cachedHighlightRanges=e,this.cachedDefaultRanges=t}}}class Uf{constructor(e,t,i,n,r,s){this.transform=e,this.toMapSpace=t,this.obb=i,this.components=n,this.renderable=r,this.intersectionGeometry=s,this.visible=!1,this.offsetObb=null}destroy(){this.intersectionGeometry=(0,p.SC)(this.intersectionGeometry),this.renderable=(0,p.SC)(this.renderable),this.components=(0,p.SC)(this.components)}}function Hf(e,t){return new(function(e){return e<128?Uint8Array:e<32768?Uint16Array:e<1<<31?Uint32Array:Array}(e))(t)}class Ff{constructor(e,t){var i,n,r;this.elementCount=e,this.model=t,this._elementIndexMap=null,this._bspNodes=[],this._generatedBVH=!1,this.localMode=t.localMode,this.planetCenterZ=t.planetCenterZ,this.geometryMinZ=t.geometryMinZ,this.planetCenter=(0,R.al)(0,0,this.planetCenterZ),this.maxBspNodeDepth=null!==(i=t.maxBspNodeDepth)&&void 0!==i?i:8,this.minElementCountForBVH=null!==(n=t.minElementCountForBVH)&&void 0!==n?n:15,this.minBspNodeElementCount=null!==(r=t.minBspNodeElementCount)&&void 0!==r?r:5}get elementIndexMap(){return this._ensureBVH(),this._elementIndexMap}get _skipBVH(){return this.elementCount<this.minElementCountForBVH||this.geometryMinZ<.5*this.planetCenterZ}_ensureBVH(){this._generatedBVH||this._skipBVH||0===this._bspNodes.length&&this._generateBsp()}intersectRay(e,t,i){this.elementCount<1||(this._skipBVH?this._intersectRayWithoutBVH(i):this._intersectRayWithBVH(e,t,i))}_intersectRayWithoutBVH(e){this._intersectRange(0,this.elementCount)}_intersectRange(e,t){this.model.intersectRange(e,t)}_intersectRayWithBVH(e,t,i){this._ensureBVH(),i?this._intersectGeometryWithBVHVerticalRay(e):this._intersectGeometryWithBVHGeneralRay(e,t)}_intersectGeometryWithBVHVerticalRay(e){let t=e[0],i=e[1];if(!this.localMode){const{geometryMinZ:n,planetCenterZ:r}=this,s=(n-r)/(e[2]-r);t=e[0]*s,i=e[1]*s}const{_bspNodes:n}=this;let r=0;for(;r>=0;){const e=n[r],{d:s,dim:a,minIndexIndex:o,minMidIndexIndex:l,maxMidIndexIndex:h,maxIndexIndex:c,aabb2D:d}=e;if(t<d[0]||t>d[2]||i<d[1]||i>d[3])break;if(-1===a||-1===e.child0&&-1===e.child1){this._intersectRange(o,c);break}{this._intersectRange(l,h);const n=(0===a?t:i)-s;if(n<0){if(-1===e.child0){this._intersectRange(o,l);break}r=e.child0}else{if(!(n>0))break;if(-1===e.child1){this._intersectRange(h,c);break}r=e.child1}}}}_intersectGeometryWithBVHGeneralRay(e,t){let i=e[0],n=e[1],r=t[0],s=t[1];const{geometryMinZ:a}=this;if(!this.localMode){let o=0,l=1;const h=Math.min(.5*this.planetCenterZ,a),c=e[2],d=t[2];if(c<h&&d<h)return;if(c<h&&(o=(h-c)/(d-c)),d<h&&(l=(h-c)/(d-c)),o>l)return;const u=(1-o)*e[0]+o*t[0],p=(1-o)*e[1]+o*t[1],_=(1-o)*e[2]+o*t[2],m=(1-l)*e[0]+l*t[0],g=(1-l)*e[1]+l*t[1],f=(1-l)*e[2]+l*t[2],{planetCenterZ:v}=this,y=a-v,b=y/(_-v);i=u*b,n=p*b;const w=y/(f-v);r=m*w,s=g*w}const o=r-i,l=s-n,h=this._bspNodes;let c=1;{const{aabb2D:e}=h[0],t=(e,t,i,n)=>{if(Math.abs(t)<1e-5*Math.max(n-i,1))return!1;const r=t>0,s=r?n:i,a=e+c*t;return(r?a<s:a>s)&&(c=Math.max((s-e)/t,c),!0)},r=()=>t(i,o,e[0],e[2]),s=()=>t(n,l,e[1],e[3]);Math.abs(o)>=Math.abs(l)?r()||s():s()||r()}const d=[0,0,c];let u=0;for(;u<d.length;){const e=d[u];let t=d[u+1],r=d[u+2];if(u+=3,t>r)continue;const s=h[e],{minIndexIndex:a,maxIndexIndex:p}=s,{child0:_,child1:m,minMidIndexIndex:g,maxMidIndexIndex:f,aabb2D:v,d:y,dim:b}=s;{const e=i+t*o,n=i+r*o,s=Math.min(e,n),a=Math.max(e,n),l=v[0],h=v[2];if(a<l||h<s)continue;if(s<l){const e=(l-i)/o;o>0?t=Math.max(t,e):r=Math.min(r,e)}if(h<a){const e=(h-i)/o;o>0?r=Math.min(r,e):t=Math.max(t,e)}}{const e=n+t*l,i=n+r*l,s=Math.min(e,i),a=Math.max(e,i),o=v[1],h=v[3];if(a<o||h<s)continue;if(s<o){const e=(o-n)/l;l>0?t=Math.max(t,e):r=Math.min(r,e)}if(h<a){const e=(h-n)/l;l>0?r=Math.min(r,e):t=Math.max(t,e)}}if(-1===_&&-1===m)this._intersectRange(a,p);else{const e=0===b?i:n,s=0===b?o:l,h=e+t*s,u=e+r*s,v=Math.min(h,u),w=Math.max(h,u),C=(0,me.uZ)((y-e)/s,0,c);a<g&&v<=y&&(-1!==_?(d.push(_),d.push(s>=0?t:Math.max(t,C)),d.push(s>=0?Math.min(r,C):r)):this._intersectRange(a,g)),this._intersectRange(g,f),f<p&&y<=w&&(-1!==m?(d.push(m),d.push(s>=0?Math.max(t,C):t),d.push(s>=0?r:Math.min(r,C))):this._intersectRange(f,p))}}}_generateBsp(){const{elementCount:e}=this;if(e<1)return;const t=Hf(e,e);this._elementIndexMap=t;for(let u=0;u<e;++u)t[u]=u;const i=this.model.getAabbs2D();let n=0;const r=this._bspNodes;r.length=0;const{localMode:s}=this;let a=!1;if(!s){const{planetCenterZ:e,geometryMinZ:t}=this;a=e>=0||t<.5*e}const o=[],l=(e,t,i,n,r)=>{o.push(e),o.push(t),o.push(i),o.push(n<0?-1:(r?0:1)+2*n)},{maxBspNodeDepth:h,minBspNodeElementCount:c}=this,d=(e,n,o,d,u)=>{const p=r.length;if(p>0&&(a||o>=h||n-e<c))return;const _=[0,0,0,0];!function(e,t,i,n,r){let s=1/0,a=1/0,o=-1/0,l=-1/0;for(let h=t;h<i;++h){const e=4*n[h];s=Math.min(s,r[e+0]),a=Math.min(a,r[e+1]),o=Math.max(o,r[e+2]),l=Math.max(l,r[e+3])}e[0]=s,e[1]=a,e[2]=o,e[3]=l}(_,e,n,t,i);const{d:m,dim:g}=s?function(e){const t=e[0],i=e[1],n=e[2],r=e[3];let s,a;return n-t>=r-i?(a=.5*(t+n),s=0):(a=.5*(i+r),s=1),{d:a,dim:s}}(_):function(e){const t=e[0],i=e[1],n=e[2],r=e[3];let s,a;return n-t>=r-i?(s=0,a=.5*(t+n)):(s=1,a=.5*(i+r)),{dim:s,d:a}}(_),{rangeMidStart:f,rangeMidEnd:v}=function(e,t,i,n,r,s){let a=e;{let e=t;for(;a<e;){const t=r[a];Vf(t,i,n,s)<0?++a:(--e,r[a]=r[e],r[e]=t)}}const o=a;let l=a,h=t;for(;l<h;){const e=r[h-1];Vf(e,i,n,s)>0?--h:(r[h-1]=r[l],r[l]=e,++l)}return{rangeMidStart:o,rangeMidEnd:h}}(e,n,g,m,t,i),y=o===h-1,b=!y&&f>=e+c,w=!y&&n>=v+c;if(b||w||0===p){const t=new qf(e,f,v,n,g,m,_);if(b&&l(e,f,o+1,p,!0),w&&l(v,n,o+1,p,!1),r.push(t),-1!==d){const e=r[d];u?e.child0=p:e.child1=p}}};for(l(0,e,0,-1,!1);n<o.length;){const e=o[n],t=o[n+1],i=o[n+2],r=o[n+3];n+=4;const s=r>>1;d(e,t,i,s,r-(s<<1)==0)}this._generatedBVH=!0}}function Vf(e,t,i,n){const r=4*e,s=n[r+0+t];return n[r+2+t]<i?-1:s>i?1:0}class qf{constructor(e,t,i,n,r,s,a){this.minIndexIndex=e,this.minMidIndexIndex=t,this.maxMidIndexIndex=i,this.maxIndexIndex=n,this.dim=r,this.d=s,this.aabb2D=a,this.child0=-1,this.child1=-1}}class zf{constructor(e,t,i,n,r,s,a,o,l){this.componentIndex=e,this.vertexData=t,this.vertexStride=i,this.indexData=n,this.startTriangleNumber=r,this.endTriangleNumber=s,this.geometryMinZ=a,this.planetCenterZ=o,this.localMode=l,this.maxBspNodeDepth=8,this.minElementCountForBVH=20,this.minBspNodeElementCount=10,this.rayDirection=(0,R.Ue)(),this.ray0=(0,R.Ue)(),this.isVerticalRay=!1,this._triangleHitCallback=Gf,this.totalElevationOffset=0,this.normalRequired=!1,this._bvh=new Ff(s-r,this)}getAabbs2D(){return this.localMode?function(e,t,i,n,r){const s=t-e,a=new Float64Array(4*s);for(let o=0;o<s;++o){const t=3*(o+e),s=r*i[t+0],l=n[s+0],h=n[s+1],c=r*i[t+1],d=n[c+0],u=n[c+1],p=r*i[t+2],_=n[p+0],m=n[p+1],g=4*o;a[g+0]=Math.min(l,d,_),a[g+1]=Math.min(h,u,m),a[g+2]=Math.max(l,d,_),a[g+3]=Math.max(h,u,m)}return a}(this.startTriangleNumber,this.endTriangleNumber,this.indexData,this.vertexData,this.vertexStride):function(e,t,i,n,r,s,a){const o=s-a,l=t-e,h=new Float64Array(4*l);for(let c=0;c<l;++c){const t=3*(c+e),s=r*i[t+0],l=n[s+0],d=n[s+1],u=o/(n[s+2]-a),p=l*u,_=d*u,m=r*i[t+1],g=n[m+0],f=n[m+1],v=o/(n[m+2]-a),y=g*v,b=f*v,w=r*i[t+2],C=n[w+0],x=n[w+1],T=o/(n[w+2]-a),S=C*T,P=x*T,M=4*c;h[M+0]=Math.min(p,y,S),h[M+1]=Math.min(_,b,P),h[M+2]=Math.max(p,y,S),h[M+3]=Math.max(_,b,P)}return h}(this.startTriangleNumber,this.endTriangleNumber,this.indexData,this.vertexData,this.vertexStride,this.geometryMinZ,this.planetCenterZ)}get numTriangles(){return this.endTriangleNumber-this.startTriangleNumber}intersectRay(e,t,i,n,r,s){(0,Ge.c)(this.ray0,e),(0,Ge.z)(this.rayDirection,t,e),this.isVerticalRay=i,this.totalElevationOffset=n,this.normalRequired=s,this._triangleHitCallback=r,this._bvh.intersectRay(e,t,i),this._triangleHitCallback=Gf}intersectRange(e,t){const i=this._bvh.elementIndexMap;Bf(this.ray0,this.rayDirection,e,t,this.indexData,this.vertexData,this.vertexStride,this.totalElevationOffset,this.planetCenterZ,this.normalRequired,this._triangleHitCallback,i,this.startTriangleNumber)}getTriangleElevationOffset(e){return this.totalElevationOffset}}function Bf(e,t,i,n,r,s,a,o,l,h,c){let d=arguments.length>11&&void 0!==arguments[11]?arguments[11]:null,u=arguments.length>12&&void 0!==arguments[12]?arguments[12]:0;0!==o?(0,um.ko)(e,t,i,n,r,s,a,o,l,h,c,d,u):(0,um.ET)(e,t,i,n,r,s,a,h,c,d,u)}function Gf(){}function kf(e,t,i,n){if(i>=t)return e;null==e&&(e=function(){let e=!(arguments.length>0&&void 0!==arguments[0])||arguments[0];return{isVisibleBit:!e,data:new Uint32Array(0)}}());const r=e.isVisibleBit;let s=e.data;const a=jf(s),o=i/a|0,l=i-a*o,h=(t-1)/a|0,c=s,d=n===r;if(!(i<c.length*a)&&d){const e=o+1,t=Math.ceil(c.length*Ld._x),i=h+1;let n=Math.max(e,t);n=Math.min(n,i),s=new Uint32Array(n),s.set(c)}return o<s.length&&(s[o]=function(e,t,i){return e&~(1<<t)|(i?1:0)<<t}(s[o],l,d)),e.data=s,e}function Zf(e,t){if(null==e)return!0;const{isVisibleBit:i,data:n}=e,r=jf(n);return t<n.length*r?function(e,t,i,n){const r=i/n|0,s=i-r*n;return function(e,t){return!!(e&1<<t)}(t[r],s)===e}(i,n,t,r):!e.isVisibleBit}function jf(e){return 8*e.BYTES_PER_ELEMENT}class Wf{constructor(e,t,i,n,r,s,a,o){this.vertexData=e,this.vertexStride=t,this.indexData=i,this._components=n,this._componentAabbs3D=r,this.geometryMinZ=s,this.planetCenterZ=a,this.localMode=o,this.maxBspNodeDepth=6,this.minElementCountForBVH=10,this.minBspNodeElementCount=3,this._ray0=Jf,this._ray1=Kf,this._invDir=(0,R.Ue)(),this._componentVerticalOffsets=null,this._verticalOffset=null,this._tolerance=0,this._intersectionOptions=ev,this._callback=$f,this.rayDirectionC=(0,R.Ue)(),this._componentIndexMap=null,this._bvh=new Ff(n.count,this),this.componentIntersectionData=new Array(n.count)}get numComponents(){return this._components.count}get minZGlobal(){return this.geometryMinZ-this.planetCenterZ}getAabbs2D(){return this.localMode?this.getAabbs2DLocal():this.getAabbs2DGlobal()}getAabbs2DGlobal(){const{numComponents:e,planetCenterZ:t,minZGlobal:i}=this,n=new Float64Array(4*e),r=this._componentAabbs3D;for(let s=0;s<e;++s){const e=6*s,a=r[e+0],o=r[e+1],l=r[e+2],h=r[e+3],c=r[e+4],d=i/(l-t),u=i/(r[e+5]-t),p=Math.min(a*d,a*u),_=Math.min(o*d,o*u),m=Math.max(h*d,h*u),g=Math.max(c*d,c*u),f=4*s;n[f+0]=p,n[f+1]=_,n[f+2]=m,n[f+3]=g}return n}getAabbs2DLocal(){const{numComponents:e}=this,t=new Float64Array(4*e),i=this._componentAabbs3D;for(let n=0;n<e;++n){const e=6*n,r=i[e+0],s=i[e+1],a=i[e+3],o=i[e+4],l=4*n;t[l+0]=r,t[l+1]=s,t[l+2]=a,t[l+3]=o}return t}intersectRay(e,t,i,n,r,s,a){const{isVerticalRay:o}=a;this._ray0=e,this._ray1=t,this._componentVerticalOffsets=i,this._verticalOffset=n,this._tolerance=s,this._intersectionOptions=a,this._componentIndexMap=this._bvh.elementIndexMap,(0,um.Ue)(e,t,this._invDir),this._callback=r,this._bvh.intersectRay(e,t,o),this._callback=$f}intersectRange(e,t){const i=this._componentIndexMap,n=this._components,r=n.pickability,s=n.visibility;for(let a=e;a<t;++a){const e=i?i[a]:a;Zf(r,e)&&s.isVisible(e)&&this._intersectComponent(e)}}getComponentTriangleCount(e){const t=this._components.offsets,i=t[e]/3;return t[e+1]/3-i}getComponentAabb3D(e,t){const i=this._componentAabbs3D,n=6*e;return t[0]=i[n],t[1]=i[n+1],t[2]=i[n+2],t[3]=i[n+3],t[4]=i[n+4],t[5]=i[n+5],t}_intersectComponent(e){var t,i;if(!Zf(this._components.pickability,e))return;const n=this.getComponentAabb3D(e,Xf);let r=!1;const{localMode:s,_componentVerticalOffsets:a,_verticalOffset:o,_ray0:l,_ray1:h,_invDir:c,planetCenterZ:d,_tolerance:u,rayDirectionC:p,componentIntersectionData:_}=this,{isVerticalRay:m}=this._intersectionOptions,g=this._components.offsets,f=(0,Ge.c)(Qf,l),v=(0,Ge.c)(Yf,h),y=null!==(t=null===a||void 0===a?void 0:a[e])&&void 0!==t?t:0,b=y+(null!==(i=null===o||void 0===o?void 0:o.offset)&&void 0!==i?i:0);if(0!==b&&(s?(f[2]=l[2]-b,v[2]=h[2]-b,r=!0):null!=o&&(o.componentOffset=y)),null==o||r||0===b||o.applyToAabb(n),!(0,um.Tw)(n,f,c,u))return;(0,Ge.z)(p,v,f);const w=g[e]/3,C=g[e+1]/3,x=C-w,T=(t,i,n)=>{this._callback(t,i,e,n)},{vertexData:S,vertexStride:P,indexData:M,_intersectionOptions:R}=this,{normalRequired:A}=R;if(x>tv){let t=_[e];null==t&&(t=new zf(e,S,P,M,w,C,this.geometryMinZ,d,s),_[e]=t),t.intersectRay(f,v,m,r?0:b,T,A)}else Bf(f,p,w,C,M,S,P,r?0:b,d,A,T)}}const Xf=(0,Pp.Ue)(),Qf=(0,R.Ue)(),Yf=(0,R.Ue)(),Jf=(0,R.Ue)(),Kf=(0,R.Ue)(),$f=()=>{},ev=new um.sT,tv=40;class iv{constructor(e,t,i){this.viewingMode=e,this.positionData=t,this._components=i,this.verticalOffset=null,this.componentVerticalOffsets=null,this._planetCenter=(0,R.Ue)(),this._componentBvh=null,this._aabb=[0,0,0,0,0,0],this._indices=t.indices?(0,Af.mi)(t.indices):(0,Af.KF)(t.positions.length/3),this._positions=t.positions}destroy(){this._positions=null,this._indices=null,this._perComponentAabbs=null,this._componentBvh=null}getComponentAabb(e,t){const i=this._ensureComponentAabbs(),n=6*e;return t[0]=i[n],t[1]=i[n+1],t[2]=i[n+2],t[3]=i[n+3],t[4]=i[n+4],t[5]=i[n+5],t}getComponentAabbs(){return this._ensureComponentAabbs()}_ensureComponentAabbs(){return this._perComponentAabbs||(this._perComponentAabbs=this._computePerComponentAabbs()),this._perComponentAabbs}getComponentPositions(e,t){t.indices=this._indices,t.data=this._positions,t.stride=3,t.startIndex=this._components.offsets[e],t.endIndex=this._components.offsets[e+1]}intersect(e,t,i,n,r,s,a,o){this.verticalOffset=n,this.componentVerticalOffsets=r;const{position:l}=s,h=(0,Ge.z)(nv,e,l),c=(0,Ge.z)(rv,t,l),d=(0,St.U_)(sv,s.rotationScale);(0,Ge.t)(h,h,d),(0,Ge.t)(c,c,d);const u=(0,St.p4)(ov,d);if(this.viewingMode===te.JY.Global){const e=this._planetCenter;(0,Ge.k)(e,l),(0,Ge.t)(e,e,d)}this._intersectComponents(h,c,r,n,((e,t,i,n)=>{o(i,e,n?(0,Ge.t)(av,n,u):null,t)}),i,a)}_computePerComponentAabbs(){const e=this._aabb,t=.5*(e[0]+e[3]),i=.5*(e[1]+e[4]),n=.5*(e[2]+e[5]),r=this._components.count,s=(0,gi.xx)(6*r),a=this._indices,o=this._positions,l=this._components.offsets;let h=0,c=1/0,d=1/0,u=1/0,p=-1/0,_=-1/0,m=-1/0;for(let g=0;g<r;g++){const e=l[g],r=l[g+1];let f=1/0,v=1/0,y=1/0,b=-1/0,w=-1/0,C=-1/0;if(e<r)for(let t=e;t<r;t++){const e=3*a[t],i=o[e],n=o[e+1],r=o[e+2];f=Math.min(f,i),v=Math.min(v,n),y=Math.min(y,r),b=Math.max(b,i),w=Math.max(w,n),C=Math.max(C,r)}else f=t,v=i,y=n,b=t,w=i,C=n;s[h++]=f,s[h++]=v,s[h++]=y,s[h++]=b,s[h++]=w,s[h++]=C,c=Math.min(c,f),d=Math.min(d,v),u=Math.min(u,y),p=Math.max(p,b),_=Math.max(_,w),m=Math.max(m,C)}return this._aabb[0]=c,this._aabb[1]=d,this._aabb[2]=u,this._aabb[3]=p,this._aabb[4]=_,this._aabb[5]=m,s}_intersectComponents(e,t,i,n,r,s,a){let o=this._componentBvh;null==o&&(o=new Wf(this._positions,3,this._indices,this._components,this._ensureComponentAabbs(),this.geometryMinZ,this.planetCenterZ,this.localMode),this._componentBvh=o),o.intersectRay(e,t,i,n,r,s,a)}get geometryMinZ(){return this._aabb[2]}get planetCenterZ(){return this._planetCenter[2]}get numTriangles(){return this._indices.length/3}get localMode(){return this.viewingMode===te.JY.Local}get positions(){return this._positions}get indices(){return this._indices}get aabb(){return this._ensureComponentAabbs(),this._aabb}}const nv=(0,R.Ue)(),rv=(0,R.Ue)(),sv=(0,pr.Ue)(),av=(0,R.Ue)(),ov=(0,pr.Ue)();class lv{constructor(e,t,i){this.material=e,this.geometry=t,this.meta=i}destroy(){this.material.dispose(),this.geometry.dispose()}}class hv{constructor(e,t,i,n){this.vao=e,this.primitiveType=t,this.parameters=i,this.indexed=n}dispose(){this.vao.dispose()}}class cv{constructor(){this.near=Number.MAX_VALUE,this.far=-Number.MAX_VALUE}}function dv(e){return e?uv(e,1/0,-1/0):function(e,t){return{near:e,far:t}}(1/0,-1/0)}function uv(e,t,i){return e.near=t,e.far=i,e}function pv(e,t){null!=t&&(e.near=Math.min(e.near,t.near),e.far=Math.max(e.far,t.far))}function _v(e,t){return e.near<=t&&t<=e.far}const mv={near:0,far:0};function gv(e,t){const i=dv(),{eye:n,frustum:r,viewForward:s}=e;t.forAll((e=>{const t=null!=e.offsetObb?e.offsetObb:e.obb,a=(0,Ge.m)((0,Ge.z)(Ev,t.center,n),s),o=t.projectedRadius(s);if(_v(i,a-o)&&_v(i,a+o))return;const l=function(e,t){let i=0;for(let n=0;n<Rv;n++){const r=e.intersectPlane(t[n]);if(r>0)return-1;0===r&&(i|=1<<n)}return i}(t,r);if(-1===l)return;if(0===l)return vv.far=a+o,vv.near=a-o,void pv(i,vv);const h=fv.pushNew();h.near=a-o,h.far=a+o,h.mask=l,h.object=e}));for(let a=0;a<fv.length;a++){const e=fv.data[a];if(_v(i,e.near)&&_v(i,e.far))continue;vv.far=e.far,vv.near=1/0;const t=Pv(null!=e.object.offsetObb?e.object.offsetObb:e.object.obb,n,wv,(t=>{let i=Cv;for(let n=0;n<Rv&&t.length>0;n++){if(!(e.mask&1<<n))continue;xv(r[n],t,i);const s=t;t=i,i=s}for(let e=0;e<t.length;e+=3){(0,Ge.s)(yv,t.data[e],t.data[e+1],t.data[e+2]);const i=(0,Ge.m)((0,Ge.z)(yv,yv,n),s);vv.near=Math.min(vv.near,i)}}));0===t&&(vv.near=0),pv(i,vv)}return fv.length=0,i}const fv=new pl.Z({allocator:e=>e||{near:1/0,far:-1/0,mask:0,object:null},deallocator:e=>(e.object=null,e)}),vv=dv(),yv=(0,R.Ue)(),bv=(0,R.Ue)(),wv=new pl.Z({deallocator:null}),Cv=new pl.Z({deallocator:null});function xv(e,t,i){i.length=0;const n=t.length-3;Tv(yv,t,n);const r=(0,jr.jH)(e,yv);r<=0&&(i.push(yv[0]),i.push(yv[1]),i.push(yv[2]));let s=0,a=r;for(;s<n;s+=3){Tv(bv,t,s);const n=(0,jr.jH)(e,bv);a*n<0&&((0,Ge.o)(yv,bv,yv,n/(n-a)),Sv(i,yv)),n<=0&&Sv(i,bv),a=n,(0,Ge.c)(yv,bv)}a*r<0&&(Tv(bv,t,n),(0,Ge.o)(yv,bv,yv,r/(r-a)),Sv(i,yv))}function Tv(e,t,i){return(0,Ge.s)(e,t.data[i],t.data[i+1],t.data[i+2])}function Sv(e,t){e.push(t[0]),e.push(t[1]),e.push(t[2])}function Pv(e,t,i,n){(0,Hr.Kx)(Ov,e.quaternion),(0,Ge.z)(Ev,t,e.center),(0,Ge.u)(Ev,Ev,Ov);const r=e.halfSize,s=8*((Ev[0]<-r[0]?-1:Ev[0]>r[0]?1:0)+3*(Ev[1]<-r[1]?-1:Ev[1]>r[1]?1:0)+9*(Ev[2]<-r[2]?-1:Ev[2]>r[2]?1:0)+13),a=Mv[s];if(0===a)return a;(0,St.en)(Av,e.quaternion),(0,St.bA)(Av,Av,e.halfSize);const o=(t,i)=>{const n=Mv[s+i+1];return(0,Ge.s)(t,((1&n)<<1)-1,(2&n)-1,((4&n)>>1)-1),(0,Ge.t)(t,t,Av),(0,Ge.g)(t,e.center,t)};return i.length=0,Sv(i,o(Dv,0)),Sv(i,o(Iv,1)),Sv(i,o(Ev,2)),Sv(i,o(Lv,3)),n(i),1===a||(i.length=0,Sv(i,Dv),Sv(i,Lv),Sv(i,o(Ev,4)),Sv(i,o(Nv,5)),n(i),2===a||(i.length=0,Sv(i,Dv),Sv(i,Nv),Sv(i,o(Ev,6)),Sv(i,Iv),n(i))),a}const Mv=(()=>{const e=new Array(216);let t=0;const i=i=>{for(let n=0;n<i.length;n++)e[t+n]=i[n];t+=8};return i([3,0,6,2,3,1,5,4]),i([2,0,2,3,1,5,4,0]),i([3,1,0,2,3,7,5,4]),i([2,0,1,3,2,6,4,0]),i([1,0,1,3,2,0,0,0]),i([2,1,5,7,3,2,0,0]),i([3,2,0,1,3,7,6,4]),i([2,2,0,1,3,7,6,0]),i([3,3,0,1,5,7,6,2]),i([2,0,1,5,4,6,2,0]),i([1,0,1,5,4,0,0,0]),i([2,1,3,7,5,4,0,0]),i([1,0,2,6,4,0,0,0]),i([0,0,0,0,0,0,0,0]),i([1,1,3,7,5,0,0,0]),i([2,2,3,7,6,4,0,0]),i([1,2,3,7,6,0,0,0]),i([2,3,1,5,7,6,2,0]),i([3,4,0,1,5,7,6,2]),i([2,5,7,6,4,0,1,0]),i([3,5,0,1,3,7,6,4]),i([2,4,5,7,6,2,0,0]),i([1,4,5,7,6,0,0,0]),i([2,5,1,3,7,6,4,0]),i([3,6,0,2,3,7,5,4]),i([2,6,2,3,7,5,4,0]),i([3,7,6,2,3,1,5,4]),e})(),Rv=4;const Av=(0,pr.Ue)(),Ov=(0,Fr.Ue)(),Ev=(0,R.Ue)(),Dv=(0,R.Ue)(),Iv=(0,R.Ue)(),Lv=(0,R.Ue)(),Nv=(0,R.Ue)();class Uv{constructor(e){this._objects=e}submit(e,t){this._objects.preSubmit(t),this._objects.visibleObjects.forAll((i=>i.renderable.material.submit(e,t,i)))}queryShadowCasterDepthRange(e){return this._objects.visibleObjects.length?gv(e,this._objects.visibleObjects):null}}var Hv=i(92911);class Fv{constructor(){this.externalColor=(0,Ye.Ue)(),this.externalColorMixMode=Df.a9.Multiply,this.castShadows=!0,this.pickable=!0,this.elevationOffset=0}}var Vv=i(46987),qv=i(9028),zv=i(37107),Bv=i(67009),Gv=i(79762),kv=i(99905),Zv=i(45412);const jv=()=>u.Z.getLogger("esri.views.3d.webgl-engine.collections.Component.ComponentObjectCollection");class Wv{constructor(e,t){this._renderManager=e,this._viewingMode=t,this._elevationRangeCacheVerticalOffset=NaN,this._elevationRangeCacheMin=NaN,this._elevationRangeCacheMax=NaN,this._visible=new pl.Z,this._hidden=new pl.Z,this._renderSubmit=new Uv(this),this._renderManager.register(this._renderSubmit),this._hasObjectAndLayerId=(0,d.Z)("enable-feature:objectAndLayerId-rendering"),this._componentBufferManager=new kv.g(e.rctx,2+(this._hasObjectAndLayerId?1:0))}destroy(){(0,vi.hu)(0===this._hidden.length&&0===this._visible.length,"ObjectCollection should be empty upon disposal"),this._componentBufferManager.destroy(),this._visible.forAll((e=>e.destroy())),this._hidden.forAll((e=>e.destroy())),this._visible.clear(),this._hidden.clear()}createObject(e){const t=e.geometry,i=new Nf(this._componentBufferManager,(0,Af.mi)(t.componentOffsets)),n=this._createRenderable(e,i),r=new iv(this._viewingMode,t.positionData,i),s=new Uf(e.transform,e.toMapSpace,e.obb.clone(),i,n,r);return(s.visible?this._visible:this._hidden).push(s),s}destroyObject(e){const t=e;(t.visible?this._visible:this._hidden).removeUnordered(t),t.destroy(),this._notifyDirty()}setObjectVisibility(e,t){const i=e;t!==i.visible&&(t?(this._hidden.removeUnordered(i),this._visible.push(i)):(this._visible.removeUnordered(i),this._hidden.push(i)),i.visible=t,this._notifyDirty())}preSubmit(e){const t=e.camera.eye;this.visibleObjects.forAll((e=>e.renderable.meta.cameraDepthSquared=(0,Ge.a)(t,e.obb.center)))}getMaterial(e){return e.renderable.material}updateMaterial(e,t){const i=e.renderable.material;t(i),i.dirty&&this._notifyDirty()}setAllComponentVisibilities(e,t){const i=e;i.components.visibility.reset(t),i.components.visibilityDirty(),this._notifyDirty()}forEachVisibleComponent(e,t){return e.components.visibility.forEachComponent(t)}getComponentCount(e){const t=e,i=t.components.visibility.componentCount;return{visible:i,invisible:t.components.count-i}}setComponentData(e,t){var i;const n=e,r=n.renderable.material,s=n.components,a=s.materialDataBuffer,o=s.materialDataIndices,l=new Fv,h=a.textureBuffer,c=new Uint8Array(4),d=new Uint32Array(c.buffer);let u=0,p=0,_=0,m=s.verticalOffsets,g=1/0,f=-1/0,v=!1,y=!1,b=0;for(let w=0;w<s.count;w++){t(w,l),u+=+(l.externalColor[3]<1),p+=+(l.externalColorMixMode===Df.a9.Replace&&1===l.externalColor[3]),_+=+l.castShadows,(0,Df.HB)(l.externalColor,l.externalColorMixMode,c),c[2]=254&c[2]|+l.castShadows,h.setData(o[w],0,c[0],c[1],c[2],c[3]),v||(v=w>0&&b!==d[0]),b=d[0],y||(y=0!==l.elevationOffset),y&&null==m&&(m=new Array(w).fill(0)),null!=m&&(m[w]=l.elevationOffset),g=Math.min(g,l.elevationOffset),f=Math.max(f,l.elevationOffset),(0,zv.nO)(l.elevationOffset,c),h.setData(o[w],1,c[0],c[1],c[2],c[3]);const e=l.objectAndLayerIdColor;null!=e&&h.setData(o[w],2,e[0],e[1],e[2],e[3]),l.pickable!==Zf(s.pickability,w)&&(s.pickability=kf(s.pickability,s.count,w,l.pickable))}s.verticalOffsets=y?m:null,n.offsetObb=y?(0,If.gI)(n.obb,g,f,this._viewingMode,null!==(i=n.offsetObb)&&void 0!==i?i:n.obb.clone()):null,v||y||this._hasObjectAndLayerId?(r.componentParameters=new Vv.Qu,r.componentParameters.castShadows=Qv(_,s.count),r.componentParameters.transparent=Qv(u,s.count),r.componentParameters.opaqueOverride=Qv(p,s.count),r.componentParameters.texture=h,h.updateTexture()):(r.componentParameters=new Vv.zO,r.componentParameters.castShadows=l.castShadows?Vv.ws.All:Vv.ws.None,r.componentParameters.externalColor=l.externalColor,r.componentParameters.externalColorMixMode=l.externalColorMixMode),this._elevationRangeCacheVerticalOffset=NaN,this._notifyDirty()}getComponentAabb(e,t,i){let n=arguments.length>3&&void 0!==arguments[3]&&arguments[3];e.intersectionGeometry.getComponentAabb(t,i);const r=e,s=r.components.verticalOffsets;if(n||null==s)return i;const a=s[t];if(this._viewingMode===te.JY.Local||0===a)return i[2]+=a,i[5]+=a,i;const o=(0,Jr.iO)(a);return o.localOrigin=r.transform.position,o.applyToAabb(i)}getComponentObb(e){return e.obb}getObjectTransform(e){return e.transform}getComponentPositions(e,t,i){return e.intersectionGeometry.getComponentPositions(t,i)}expandRangeWithComponentObjectElevationRange(e,t,i,n){Number.isNaN(this._elevationRangeCacheVerticalOffset)||this._elevationRangeCacheVerticalOffset!==t||n.expandElevationRangeValues(this._elevationRangeCacheMin,this._elevationRangeCacheMax);const r=e,s=r.components,a=s.count,o=s.verticalOffsets,l=r.intersectionGeometry,h=this._viewingMode===te.JY.Local,c=l.getComponentAabbs(),d=Yv;let u=1/0,p=-1/0;for(let m=0;m<a;m++){var _;const e=6*m,s=null!==(_=null===o||void 0===o?void 0:o[m])&&void 0!==_?_:0;let a=1/0,l=-1/0;if(h)a=c[e+2]+s+t,l=c[e+5]+s+t;else{if(d[0]=c[e],d[1]=c[e+1],d[2]=c[e+2],d[3]=c[e+3],d[4]=c[e+4],d[5]=c[e+5],0!==s){const e=(0,Jr.iO)(s);e.localOrigin=r.transform.position,e.applyToAabb(d)}const a=Math.max(Math.abs(d[3]),Math.abs(d[0])),o=Math.max(Math.abs(d[4]),Math.abs(d[1])),l=t+d[5]+i;n.expandElevationRangeValues(t+d[2],Math.sqrt(a*a+o*o+l*l)-i)}n.expandElevationRangeValues(a,l),u=Math.min(u,a),p=Math.max(p,l)}this._elevationRangeCacheVerticalOffset=t,this._elevationRangeCacheMin=u,this._elevationRangeCacheMax=p}intersect(e,t,i,n,r,s,a){const o=e,{transform:l}=o,{position:h}=l;return null!=r&&(r.localOrigin=h),o.intersectionGeometry.intersect(t,i,n,r,o.components.verticalOffsets,l,s,a)}addEdges(e,t,i,n,r){const s=e,{indices:a,positions:o}=s.intersectionGeometry,l=s.components.offsets;return t.addComponentObject(s,o,a,l,i,n,r)}async extractEdgeInformation(e,t,i){const n=e,r=n.components.visibility;if(r.allInvisible())return{buffer:Gv.n_.createBuffer(0),origin:[0,0,0]};const{indices:s,positions:a}=n.intersectionGeometry,o=n.components.offsets,l=Bv.tf.createBuffer(a.length/3);(0,Ef.c)(l.position.typedBuffer,a,l.position.typedBufferStride,3),(0,Of.c)(l.position,l.position,n.transform.rotationScale),this._setComponentIndices(l.componentIndex,s,o);const h=l.count,c=this._computeVisibilityIndices(s,r,o,h);return{origin:(0,R.d9)(n.transform.position),buffer:await t.extractComponentsEdgeLocations({indices:c,indicesLength:c.length,skipDeduplicate:!0,data:l,writerSettings:{reducedPrecision:!1,variants:0}},i)}}_setComponentIndices(e,t,i){let n=0;for(let r=0;r<i.length-1;r++){const s=i[r],a=i[r+1];for(let i=s;i<a;i++){const r=t?t[i]:i;e.set(r,n)}n++}}_computeVisibilityIndices(e,t,i,n){if(e&&t.allVisible())return e;let r=0;t.forEachComponentRange(((e,t)=>(r+=i[t]-i[e],!0)));const s=(0,Rf.kJ)(e)?new Array(r):2===(null===e||void 0===e?void 0:e.BYTES_PER_ELEMENT)||n<=65536?new Uint16Array(r):new Uint32Array(r);let a=0;return t.forEachComponentRange(((t,n)=>{const r=i[t],o=i[n];for(let i=r;i<o;i++)s[a++]=e?e[i]:i;return!0})),s}addComponentHighlight(e,t){const i=e.components;null==i.highlightCounts&&(i.highlightCounts=new Uint32Array(i.count+1)),0===i.highlightCounts[t]++&&(i.highlightsDirty(),this._notifyDirty()),i.highlightCounts[i.count]++}removeComponentHighlight(e,t){const i=e.components;if(null==i.highlightCounts)return void jv().warn("Removing non-existing highlight.");const n=i.highlightCounts[t],r=i.highlightCounts[i.count];if(0!==n){if(n>1)return i.highlightCounts[t]=n-1,void(i.highlightCounts[i.count]=r-1);i.highlightCounts[t]=0,i.highlightsDirty(),this._notifyDirty(),1===r?i.highlightCounts=null:i.highlightCounts[i.count]=r-1}else jv().warn("Removing non-existing highlight.")}clearHighlights(e){const t=e.components;null!=t.highlightCounts&&(t.highlightCounts=null,t.highlightsDirty(),this._notifyDirty())}getObjectGPUMemoryUsage(e){return e.renderable.meta.gpuMemoryEstimate}get visibleObjects(){return this._visible}_createRenderable(e,t){const i=this._renderManager.rctx,n=e.geometry,r=n.vertices.layoutParameters,s=ci.f.createVertex(i,st.l1.STATIC_DRAW,n.vertices.data),a=n.indices?ci.f.createIndex(i,st.l1.STATIC_DRAW,n.indices):null,o=(0,si.K)((0,Hv.N)(r)),l=new Uint16Array(n.vertices.count);for(let _=0;_<t.count;_++){const e=t.offsets[_],i=t.offsets[_+1],r=t.materialDataIndices[_];if(null!=n.indices)for(let t=e;t<i;t++)l[n.indices[t]]=r;else for(let t=e;t<i;t++)l[t]=r}const h=ci.f.createVertex(i,st.l1.STATIC_DRAW,l.buffer),c=new Vv.Un(e.transform,e.toMapSpace),d=new Zv.U(i,qv.V,{data:o,componentIndices:Xv},{data:s,componentIndices:h},a),u=new hv(d,st.MX.TRIANGLES,r,null!=a),p={cameraDepthSquared:.5,gpuMemoryEstimate:s.usedMemory+h.usedMemory+(null!=a?a.usedMemory:0)};return new lv(c,u,p)}_notifyDirty(){this._renderManager.notifyDirty()}}const Xv=(0,si.K)((0,ai.U$)().u16(hi.T.COMPONENTINDEX));function Qv(e,t){return e===t?Vv.ws.All:0===e?Vv.ws.None:Vv.ws.Some}const Yv=(0,Pp.Ue)();var Jv=i(51992),Kv=i(31239),$v=i(90765);class ey extends it.A{initializeProgram(e){return new rt.$(e.rctx,ey.shader.get().build(),nt.i)}initializePipeline(){return(0,at.sm)({blending:(0,at.wK)(st.zi.SRC_ALPHA,st.zi.ONE,st.zi.ONE_MINUS_SRC_ALPHA,st.zi.ONE_MINUS_SRC_ALPHA),colorWrite:at.BK})}}ey.shader=new tt.J($v.H,(()=>i.e(14958).then(i.bind(i,14958))));var ty=i(56384);class iy extends it.A{initializeProgram(e){return new rt.$(e.rctx,iy.shader.get().build(),nt.i)}initializePipeline(){return(0,at.sm)({colorWrite:at.BK})}}iy.shader=new tt.J(ty.a,(()=>i.e(61507).then(i.bind(i,61507))));var ny=i(69012);class ry extends it.A{initializeProgram(e){return new rt.$(e.rctx,ry.shader.get().build(),nt.i)}initializePipeline(){return(0,at.sm)({colorWrite:at.BK})}}ry.shader=new tt.J(ny.a,(()=>i.e(72771).then(i.bind(i,72771))));class sy extends et.K{constructor(){super(...arguments),this.color=(0,Ye.al)(1,0,1,1),this.haloColor=(0,Ye.al)(1,0,1,1),this.haloOpacity=1,this.haloOpacityOccluded=.25,this.fillOpacity=.2,this.fillOpacityOccluded=.05,this.coverageRounding=(0,Ke.al)(1,1)}}let ay=class extends Kv.Z{constructor(e){super(e),this.produces="highlight-color",this.consumes={required:["highlight-color","highlights"]},this._passParameters=new sy,this._downsampleDrawParameters=new ny.H,this._blurDrawParameters=new ty.H,this._blurColorFormat=(0,d.Z)("mac")?ut.q.RGBA:ut.q.RGBA4,this._grid={coverage:null,vao:null,verticalCellCount:0,horizontalCellCount:0,viewportWidth:0,viewportHeight:0},this._blurTechnique=e.techniques.acquire(iy),this._downsampleTechnique=e.techniques.acquire(ry),this._applyTechnique=e.techniques.acquire(ey)}initialize(){this.addHandles([(0,g.watch)((()=>this.view.highlightOptions.color),(e=>{this._passParameters.color=(0,je.O)(null!==e&&void 0!==e?e:hd),this.view.highlightOptions.haloColor||(this._passParameters.haloColor=this._passParameters.color),this.requestRender(dp.Xx.UPDATE)}),g.syncAndInitial),(0,g.watch)((()=>this.view.highlightOptions.haloColor),(e=>{this._passParameters.haloColor=null!=e?(0,je.O)(e):this._passParameters.color,this.requestRender(dp.Xx.UPDATE)}),g.syncAndInitial),(0,g.watch)((()=>this.view.highlightOptions.haloOpacity),(e=>{this._passParameters.haloOpacity=null!==e&&void 0!==e?e:1,this._passParameters.haloOpacityOccluded=.25*this._passParameters.haloOpacity,this.requestRender(dp.Xx.UPDATE)}),g.syncAndInitial),(0,g.watch)((()=>this.view.highlightOptions.fillOpacity),(e=>{this._passParameters.fillOpacity=null!==e&&void 0!==e?e:.25,this._passParameters.fillOpacityOccluded=.25*this._passParameters.fillOpacity,this.requestRender(dp.Xx.UPDATE)}),g.syncAndInitial)])}destroy(){this._blurTechnique.release(),this._downsampleTechnique.release(),this._applyTechnique.release(),this._grid.coverage=(0,p.RY)(this._grid.coverage),this._grid.vao=(0,p.M2)(this._grid.vao)}render(e){var t,i,n;if(this.bindParameters.decorations===dp.Iq.OFF)return e.find((e=>{let{name:t}=e;return"highlight-color"===t}));if(!(this._blurTechnique.compiled&&this._downsampleTechnique.compiled&&this._applyTechnique.compiled))return this.requestRender(dp.Xx.UPDATE),e.find((e=>{let{name:t}=e;return"highlight-color"===t}));const r=e.find((e=>{let{name:t}=e;return"highlights"===t})).getTexture(),s=this.bindParameters.camera,a=s.fullWidth,o=s.fullHeight,l=s.pixelRatio,h=Math.ceil(a/l),c=Math.ceil(o/l),d=this.renderingContext;this._gridUpdateResources(r),this._gridComputeCoverage(r,this.bindParameters),this._passParameters.highlightTexture=r,this._passParameters.coverageTexture=null===(t=this._grid.coverage)||void 0===t?void 0:t.getTexture();const{width:u,height:p}=r.descriptor;(0,Xe.t8)(this._passParameters.coverageRounding,u/(Math.ceil(u/ny.g)*ny.g),p/(Math.ceil(p/ny.g)*ny.g));const _=this._grid.vao;d.bindVAO(_);const m=this.fboCache.acquire(h,c,"highlight blur",this._blurColorFormat);d.unbindTexture(null===(i=m.fbo)||void 0===i?void 0:i.colorTexture),d.bindFramebuffer(m.fbo),d.setClearColor(0,0,0,0),d.clear(st.lk.COLOR_BUFFER_BIT),d.setViewport(0,0,h,c),this._blurDrawParameters.blurInputTexture=r,(0,Xe.t8)(this._blurDrawParameters.blurSize,1/h,0);const g=d.bindTechnique(this._blurTechnique,this.bindParameters,this._passParameters,this._blurDrawParameters);d.drawArrays(this._blurTechnique.primitiveType,0,(0,ui._V)(_,"geometry"));const f=this.fboCache.acquire(h,c,"highlight blur",this._blurColorFormat);d.unbindTexture(null===(n=f.fbo)||void 0===n?void 0:n.colorTexture),d.bindFramebuffer(f.fbo),d.setClearColor(0,0,0,0),d.clear(st.lk.COLOR_BUFFER_BIT),this._blurDrawParameters.blurInputTexture=m.getTexture(),(0,Xe.t8)(this._blurDrawParameters.blurSize,0,1/c),g.bindDraw(this._blurDrawParameters,this.bindParameters,this._passParameters),d.drawArrays(this._blurTechnique.primitiveType,0,(0,ui._V)(_,"geometry"));const v=e.find((e=>{let{name:t}=e;return"highlight-color"===t}));return d.bindFramebuffer(v.fbo),d.setViewport4fv(s.fullViewport),this._passParameters.blurTexture=f.getTexture(),d.bindTechnique(this._applyTechnique,this.bindParameters,this._passParameters),d.drawArrays(this._applyTechnique.primitiveType,0,(0,ui._V)(_,"geometry")),m.release(),f.release(),v}_gridUpdateResources(e){var t;const i=this.renderingContext,n=this._grid,r=Math.ceil(e.descriptor.height/ny.g),s=Math.ceil(e.descriptor.width/ny.g);if(n.vao&&n.verticalCellCount===r&&n.horizontalCellCount===s)return;n.verticalCellCount=r,n.horizontalCellCount=s;const a=r+1,o=s+1,l=1/r,h=1/s,c=new Float32Array(24*a*o);let d=0;for(let u=0;u<a;u++)for(let e=0;e<o;e++)c[d++]=(e-.5)*h*2-1,c[d++]=(u-.5)*l*2-1,c[d++]=e*h,c[d++]=u*l,c[d++]=(e+.5)*h*2-1,c[d++]=(u-.5)*l*2-1,c[d++]=e*h,c[d++]=u*l,c[d++]=(e-.5)*h*2-1,c[d++]=(u+.5)*l*2-1,c[d++]=e*h,c[d++]=u*l,c[d++]=(e-.5)*h*2-1,c[d++]=(u+.5)*l*2-1,c[d++]=e*h,c[d++]=u*l,c[d++]=(e+.5)*h*2-1,c[d++]=(u-.5)*l*2-1,c[d++]=e*h,c[d++]=u*l,c[d++]=(e+.5)*h*2-1,c[d++]=(u+.5)*l*2-1,c[d++]=e*h,c[d++]=u*l;null!==(t=n.vao)&&void 0!==t&&t.dispose(),n.vao=new li.U(i,nt.i,{geometry:pt.Bn},{geometry:ci.f.createVertex(i,st.l1.STATIC_DRAW,c)})}_gridComputeCoverage(e,t){var i,n;const r=this.renderingContext,s=this._grid,a=e.descriptor,o=Math.ceil(a.width/ny.g),l=Math.ceil(a.height/ny.g);this._downsampleDrawParameters.input=e,null!==(i=s.coverage)&&void 0!==i&&i.release(),s.coverage=this.fboCache.acquire(o,l,"highlight coverage",ut.q.RG),r.unbindTexture(null===(n=s.coverage.fbo)||void 0===n?void 0:n.colorTexture),r.bindFramebuffer(s.coverage.fbo),r.bindTechnique(this._downsampleTechnique,t,this._passParameters,this._downsampleDrawParameters),r.setViewport(0,0,o,l),r.screen.draw()}get test(){}};(0,n._)([(0,b.Cb)()],ay.prototype,"produces",void 0),(0,n._)([(0,b.Cb)()],ay.prototype,"consumes",void 0),(0,n._)([(0,b.Cb)({constructOnly:!0})],ay.prototype,"techniques",void 0),ay=(0,n._)([(0,C.j)("esri.views.3d.webgl-engine.effects.highlight.Highlight")],ay);var oy=i(93511);class ly extends ht.m{constructor(){super(...arguments),this.receiveShadows=!0}}(0,n._)([(0,ht.o)()],ly.prototype,"receiveShadows",void 0);var hy=i(38727);class cy extends oy.nj{constructor(){super(...arguments),this.shadowColor=(0,Ye.al)(1,0,1,1),this.shadowOpacity=.2,this.occludedShadowOpacity=.1,this.opacityElevation=1,this.dayNightTerminator=1}}class dy extends it.A{constructor(e){super(e,new ly,(()=>this.destroy()))}initializeProgram(e){return new rt.$(e.rctx,dy.shader.get().build(this.configuration),nt.i)}initializePipeline(){return(0,at.sm)({blending:(0,at.wK)(st.zi.SRC_ALPHA,st.zi.ONE,st.zi.ONE_MINUS_SRC_ALPHA,st.zi.ONE_MINUS_SRC_ALPHA),colorWrite:at.BK,depthTest:null,depthWrite:null})}get primitiveType(){return st.MX.TRIANGLE_STRIP}}dy.shader=new tt.J(hy.S,(()=>i.e(39245).then(i.bind(i,39245))));let uy=class extends Kv.Z{constructor(e){super(e),this.produces="composite-color",this.consumes={required:["composite-color","highlights"]},this._passParameters=new cy,this._maxOpacity=1,this._shadowDifference=.2,this._technique=e.techniques.acquire(dy)}initialize(){this.addHandles([(0,g.watch)((()=>this.view.highlightOptions.shadowOpacity),(e=>{this._passParameters.shadowOpacity=null!==e&&void 0!==e?e:.4,this._updateOccludedShadowOpacity(),this._updateMaxOpacity()}),g.syncAndInitial),(0,g.watch)((()=>this.view.highlightOptions.shadowDifference),(e=>{this._shadowDifference=null!==e&&void 0!==e?e:.2,this._updateOccludedShadowOpacity(),this._updateMaxOpacity()}),g.syncAndInitial),(0,g.watch)((()=>this.view.highlightOptions.shadowColor),(e=>{this._passParameters.shadowColor=(0,je.O)(null!==e&&void 0!==e?e:cd),this._updateMaxOpacity()}),g.syncAndInitial)])}destroy(){this._technique.release()}_updateOccludedShadowOpacity(){this._passParameters.occludedShadowOpacity=this._passParameters.shadowOpacity*(1-this._shadowDifference)}_updateMaxOpacity(){const e=Math.max(this._passParameters.shadowOpacity,this._passParameters.occludedShadowOpacity);this._maxOpacity=e*this._passParameters.shadowColor[3]}render(e){var t;const i=e.find((e=>{let{name:t}=e;return"composite-color"===t})),n=this.bindParameters;if(!n.shadowHighlightsVisible||!n.depth||!this._ensureIfVisible(n.camera,n.lighting.mainLight.direction))return i;if(!this._technique.compiled)return this.requestRender(dp.Xx.UPDATE),i;this._passParameters.highlight=null===(t=e.find((e=>{let{name:t}=e;return"highlights"===t})))||void 0===t?void 0:t.getTexture(),this._passParameters.origin=n.camera.center;const r=this.renderingContext;return r.bindFramebuffer(i.fbo),r.bindTechnique(this._technique,n,this._passParameters),r.screen.draw(),i}_ensureIfVisible(e,t){this._passParameters.opacityElevation=1-(0,me.CW)(4e4,5e4,e.relativeElevation);const i=this.viewingMode===te.JY.Global?(0,Ge.n)(py,e.center):(0,Ge.s)(py,0,0,1),n=(0,Ge.m)(i,t);return this._passParameters.dayNightTerminator=(0,me.CW)(0,1,(0,me.uZ)(30*n,0,1)),this._maxOpacity*this._passParameters.opacityElevation*this._passParameters.dayNightTerminator>=.001953125}};(0,n._)([(0,b.Cb)()],uy.prototype,"produces",void 0),(0,n._)([(0,b.Cb)()],uy.prototype,"consumes",void 0),(0,n._)([(0,b.Cb)({constructOnly:!0})],uy.prototype,"viewingMode",void 0),(0,n._)([(0,b.Cb)({constructOnly:!0})],uy.prototype,"techniques",void 0),uy=(0,n._)([(0,C.j)("esri.views.3d.webgl-engine.effects.highlight.ShadowHighlight")],uy);const py=(0,R.Ue)();var _y=i(38330),my=i(19388);class gy extends it.A{initializeProgram(e){return new rt.$(e.rctx,gy.shader.get().build(),nt.i)}initializePipeline(){return(0,at.sm)({blending:(0,at.if)(st.zi.ONE,st.zi.ONE_MINUS_SRC_ALPHA),depthTest:null,depthWrite:null,colorWrite:at.BK})}}gy.shader=new tt.J(my.a,(()=>i.e(54545).then(i.bind(i,54545))));var fy=i(4583);let vy=class extends Kv.Z{constructor(e){super(e),this.produces="magnifier-color",this.consumes={required:["magnifier-color"]},this._imageSources=null,this._imageLoadTask=null,this._passParameters=new my.M,this._vao=null,this._technique=null,this._magnifier=null,this._tmpScreenPoint=(0,v.s1)(),this._tmpRenderPoint=(0,v.gX)()}initialize(){this.addHandles([(0,g.watch)((()=>this.view.magnifier),(e=>this._update(e)),g.syncAndInitial)])}_update(e){if(e===this._magnifier)return;this.removeAllHandles(),this._magnifier=e;const t=()=>{const e=this._validMagnifier;e?(this._loadResources(e),this.produces="magnifier-color"):this.produces="disabled",this.requestRender()};this._magnifier&&this.addHandles((0,g.watch)((()=>{var e;return null===(e=this._magnifier)||void 0===e?void 0:e.version}),t)),t()}get _validMagnifier(){var e,t,i;return null!==(e=this._magnifier)&&void 0!==e&&e.visible&&null!==(t=this._magnifier)&&void 0!==t&&t.position&&(null===(i=this._magnifier)||void 0===i?void 0:i.size)>0?this._magnifier:null}get _factor(){var e;return(null===(e=this._magnifier)||void 0===e?void 0:e.factor)||1}destroy(){this._magnifier=null,null!=this._imageLoadTask&&(this._imageLoadTask.task.abort(),this._imageLoadTask=null),this._disposeTextures(),this._vao=(0,p.M2)(this._vao)}_disposeTextures(){this._passParameters.mask=(0,p.M2)(this._passParameters.mask),this._passParameters.overlay=(0,p.M2)(this._passParameters.overlay),this._passParameters.input=(0,p.M2)(this._passParameters.input)}render(e){var t,i,n;const r=this._validMagnifier,s=e.find((e=>{let{name:t}=e;return"magnifier-color"===t}));if(null==r)return s;if(null==this._imageSources)return this.requestRender(dp.Xx.UPDATE),s;const a=this.renderingContext,o=this.camera.pixelRatio,l=Math.ceil(o*r.size);if(null!==(t=this._vao)&&void 0!==t||(this._vao=(0,_t.o)(a,pt.QI,nt.i,0,1)),null!==(i=this._technique)&&void 0!==i||(this._technique=this.techniques.acquire(gy)),this._ensureTextureResources(a,l),null===(n=this._technique)||void 0===n||!n.compiled||!this._passParameters.input)return this.requestRender(dp.Xx.UPDATE),s;const h=Math.ceil(1/this._factor*l),c=this._passParameters.input;c.resize(h,h),(0,v.md)(r.position,this._tmpScreenPoint);const d=this.camera.screenToRender(this._tmpScreenPoint,this._tmpRenderPoint),u=this.camera.fullWidth,p=this.camera.fullHeight,_=.5*h,m=.5*h;d[0]=(0,me.uZ)(d[0],_,u-_-1),d[1]=(0,me.uZ)(d[1],m,p-m-1);const g=Math.floor(d[0]-_),f=Math.floor(d[1]-m);return a.bindFramebuffer(s.fbo),this._technique.program.bindTexture("textureInput",c),a.gl.copyTexImage2D(c.descriptor.target,0,c.descriptor.pixelFormat,g,f,h,h,0),this._passParameters.magnifier=r,a.bindTechnique(this._technique,this.bindParameters,this._passParameters),a.bindVAO(this._vao),a.drawArrays(st.MX.TRIANGLE_STRIP,0,4),s}_loadResources(e){var t,i,n;const{maskUrl:r,overlayUrl:s}=e;(null===(t=this._imageLoadTask)||void 0===t?void 0:t.maskUrl)===r&&(null===(i=this._imageLoadTask)||void 0===i?void 0:i.overlayUrl)===s||(null!==(n=this._imageLoadTask)&&void 0!==n&&n.task.abort(),this._imageLoadTask=this._imageSources=null),this._imageSources||this._imageLoadTask||(this._imageLoadTask={maskUrl:r,overlayUrl:s,task:(0,oe.vr)((async e=>{const t=null==r||null==s?(0,fy.e)(e):null,i=null!=r?(0,_y.t)(r,{signal:e}):t.then((e=>e.mask)),n=null!=s?(0,_y.t)(s,{signal:e}):t.then((e=>e.overlay));this._imageSources={mask:await i,overlay:await n}}))})}_ensureTextureResources(e,t){if(null==this._imageSources||this._passParameters.size===t&&this._passParameters.input&&this._passParameters.mask&&this._passParameters.overlay)return;this._disposeTextures(),this._imageSources.overlay.width=this._imageSources.mask.width=t,this._imageSources.overlay.height=this._imageSources.mask.height=t;const i=new Vt.X;i.internalFormat=st.VI.RGBA,i.wrapMode=st.e8.CLAMP_TO_EDGE,i.flipped=!0,i.preMultiplyAlpha=!(0,iu.zd)(this._imageSources.overlay.src)||!e.driverTest.svgPremultipliesAlpha.result,this._passParameters.overlay=new di.x(e,i,this._imageSources.overlay),i.pixelFormat=i.internalFormat=st.VI.ALPHA,i.preMultiplyAlpha=!1,this._passParameters.mask=new di.x(e,i,this._imageSources.mask),i.pixelFormat=i.internalFormat=st.VI.RGBA,i.flipped=!1,this._passParameters.input=new di.x(e,i)}};(0,n._)([(0,b.Cb)()],vy.prototype,"produces",void 0),(0,n._)([(0,b.Cb)()],vy.prototype,"consumes",void 0),(0,n._)([(0,b.Cb)()],vy.prototype,"_imageSources",void 0),(0,n._)([(0,b.Cb)()],vy.prototype,"_imageLoadTask",void 0),(0,n._)([(0,b.Cb)({constructOnly:!0})],vy.prototype,"techniques",void 0),vy=(0,n._)([(0,C.j)("esri.views.3d.webgl-engine.effects.magnifier.MagnifierRenderNode")],vy);var yy=i(98757);class by extends it.A{initializeProgram(e){return new rt.$(e.rctx,by.shader.get().build(),nt.i)}initializePipeline(){return(0,at.sm)({colorWrite:at.BK})}}by.shader=new tt.J(yy.B,(()=>i.e(61738).then(i.bind(i,61738))));var wy=i(40051);class Cy extends it.A{initializeProgram(e){return new rt.$(e.rctx,Cy.shader.get().build(),nt.i)}initializePipeline(){return(0,at.sm)({colorWrite:at.BK})}}Cy.shader=new tt.J(wy.B,(()=>i.e(79063).then(i.bind(i,79063))));var xy=i(82396);class Ty extends it.A{initializeProgram(e){return new rt.$(e.rctx,Ty.shader.get().build(),nt.i)}initializePipeline(){return(0,at.sm)({colorWrite:at.BK})}}Ty.shader=new tt.J(xy.E,(()=>i.e(53953).then(i.bind(i,53953))));class Sy extends et.K{}let Py=class extends Kv.Z{constructor(e){super(e),this.produces="disabled",this.consumes={required:["aa-color","composite-color"]},this._areaTexture=null,this._searchTexture=null,this._smaaParameters=new Sy,this._edgeTechnique=e.techniques.acquire(Ty),this._blendTechnique=e.techniques.acquire(by),this._blurTechnique=e.techniques.acquire(Cy)}initialize(){this.addHandles([(0,g.watch)((()=>this.isEnabled()),(e=>e?this.enable():this.disable()),g.syncAndInitial)])}async enable(){if(this.produces="aa-color",this._abortController||this._areaTexture&&this._searchTexture)return;this._abortController=new AbortController;const e=this._abortController.signal;try{const t=await i.e(75224).then(i.bind(i,75224));await this._loadTextures(t,e),this.requestRender(dp.Xx.UPDATE)}catch{}this._abortController=null}async _loadTextures(e,t){(0,m.k_)(t);const[i,n]=await Promise.allSettled([(0,_y.t)(e.areaTexture,{signal:t}),(0,_y.t)(e.searchTexure,{signal:t})]);if((0,m.k_)(t),"fulfilled"!==i.status||"fulfilled"!==n.status)return;const r=this.renderingContext;this._areaTexture=My(r,st.cw.LINEAR,st.VI.RGB,i.value),this._searchTexture=My(r,st.cw.NEAREST,st.VI.LUMINANCE,n.value)}disable(){this.produces="disabled"}destroy(){this._searchTexture=(0,p.M2)(this._searchTexture),this._areaTexture=(0,p.M2)(this._areaTexture),this._blurTechnique.release(),this._blendTechnique.release(),this._edgeTechnique.release()}render(e){var t,i;const n=e.find((e=>{let{name:t}=e;return"aa-color"===t}));if(!(this._edgeTechnique.compiled&&this._blendTechnique.compiled&&this._blurTechnique.compiled&&this._areaTexture&&this._searchTexture))return this.requestRender(dp.Xx.UPDATE),n;const r=e.find((e=>{let{name:t}=e;return"composite-color"===t})),s=r.fbo.width,a=r.fbo.height,o=this.renderingContext;o.setViewport(0,0,s,a);const l=this.fboCache.acquire(s,a,"smaa edges",ut.q.RG);o.unbindTexture(null===(t=l.fbo)||void 0===t?void 0:t.colorTexture),o.bindFramebuffer(l.fbo),o.setClearColor(0,0,0,1),o.clear(st.lk.COLOR_BUFFER_BIT),this._smaaParameters.color=r.getTexture(),o.bindTechnique(this._edgeTechnique,null,this._smaaParameters),o.screen.draw();const h=this.fboCache.acquire(s,a,"smaa blend");return o.unbindTexture(null===(i=h.fbo)||void 0===i?void 0:i.colorTexture),o.bindFramebuffer(h.fbo),o.setClearColor(0,0,1,1),o.clear(st.lk.COLOR_BUFFER_BIT),this._smaaParameters.inputTexture=l.getTexture(),this._smaaParameters.areaTexture=this._areaTexture,this._smaaParameters.searchTexture=this._searchTexture,o.bindTechnique(this._blendTechnique,null,this._smaaParameters),o.screen.draw(),l.release(),o.bindFramebuffer(n.fbo),o.setClearColor(0,1,0,1),o.clear(st.lk.COLOR_BUFFER_BIT),this._smaaParameters.inputTexture=h.getTexture(),o.bindTechnique(this._blurTechnique,null,this._smaaParameters),o.screen.draw(),h.release(),n}};function My(e,t,i,n){const r=new Vt.X;return r.pixelFormat=i,r.wrapMode=st.e8.CLAMP_TO_EDGE,r.width=n.width,r.height=n.height,r.samplingMode=t,new di.x(e,r,n)}(0,n._)([(0,b.Cb)()],Py.prototype,"produces",void 0),(0,n._)([(0,b.Cb)()],Py.prototype,"consumes",void 0),(0,n._)([(0,b.Cb)({constructOnly:!0})],Py.prototype,"isEnabled",void 0),(0,n._)([(0,b.Cb)({constructOnly:!0})],Py.prototype,"techniques",void 0),(0,n._)([(0,b.Cb)()],Py.prototype,"_abortController",void 0),Py=(0,n._)([(0,C.j)("esri.views.3d.webgl-engine.effects.smaa.SMAA")],Py);var Ry,Ay=i(14472),Oy=i(4170);!function(e){e[e.None=0]="None",e[e.Alpha=1]="Alpha",e[e.PremultipliedAlpha=2]="PremultipliedAlpha",e[e.COUNT=3]="COUNT"}(Ry||(Ry={}));class Ey extends ht.m{constructor(){super(...arguments),this.alphaMode=Ry.None,this.hasOpacityFactor=!1,this.isDepthBlit=!1}}(0,n._)([(0,ht.o)({count:Ry.COUNT})],Ey.prototype,"alphaMode",void 0),(0,n._)([(0,ht.o)()],Ey.prototype,"hasOpacityFactor",void 0),(0,n._)([(0,ht.o)()],Ey.prototype,"isDepthBlit",void 0);class Dy extends it.A{initializeProgram(e){return new rt.$(e.rctx,Dy.shader.get().build(this.configuration),nt.i)}initializePipeline(){switch(this.configuration.alphaMode){case Ry.None:return(0,at.sm)({colorWrite:at.BK});case Ry.Alpha:return(0,at.sm)({blending:(0,at.wK)(st.zi.SRC_ALPHA,st.zi.ONE,st.zi.ONE_MINUS_SRC_ALPHA,st.zi.ONE_MINUS_SRC_ALPHA),colorWrite:at.BK});case Ry.PremultipliedAlpha:case Ry.COUNT:return(0,at.sm)({blending:(0,at.if)(st.zi.ONE,st.zi.ONE_MINUS_SRC_ALPHA),colorWrite:at.BK})}}}Dy.shader=new tt.J(Oy.a,(()=>i.e(44016).then(i.bind(i,44016))));var Iy=i(67273);class Ly extends it.A{initializeProgram(e){return new rt.$(e.rctx,Ly.shader.get().build(),nt.i)}initializePipeline(){return(0,at.sm)({colorWrite:{r:!1,g:!0,b:!1,a:!1}})}}Ly.shader=new tt.J(Iy.a,(()=>i.e(58323).then(i.bind(i,58323))));var Ny=i(90829);class Uy extends it.A{initializeProgram(e){return new rt.$(e.rctx,Uy.shader.get().build(),nt.i)}initializePipeline(){return(0,at.sm)({blending:(0,at.wK)(st.zi.SRC_ALPHA,st.zi.ONE,st.zi.ONE_MINUS_SRC_ALPHA,st.zi.ONE_MINUS_SRC_ALPHA),colorWrite:at.BK})}}Uy.shader=new tt.J(Ny.a,(()=>i.e(19409).then(i.bind(i,19409))));class Hy{constructor(e,t){this._rctx=e,this._techniques=t,this._configuration=new Ey,this._passParameters=new Oy.C,this._oitParameters=new Ny.O,this._hudParameters=new Iy.H}compositeOIT(e,t,i,n){this._oitParameters.colorTexture=t,this._oitParameters.alphaTexture=i,this._oitParameters.frontFaceTexture=n;const r=this._techniques.acquire(Uy);this._rctx.bindTechnique(r,e,this._oitParameters),this._rctx.screen.draw(),r.release()}compositeHUD(e,t){this._hudParameters.texture=t;const i=this._techniques.acquire(Ly);this._rctx.bindTechnique(i,e,this._hudParameters),this._rctx.screen.draw(),i.release()}composite(e,t){let i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:Ry.None,n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:1;this._configuration.alphaMode=i,this._configuration.hasOpacityFactor=1!==n,this._passParameters.texture=t,this._passParameters.opacity=n;const r=this._techniques.acquire(Dy,this._configuration);this._rctx.bindTechnique(r,e,this._passParameters),this._rctx.screen.draw(),r.release()}blitDepthToLinearDepth(e,t){this._configuration.isDepthBlit=!0,this.composite(e,t),this._configuration.isDepthBlit=!1}}var Fy=i(46228),Vy=i(78329);const qy=100,zy=500,By=500,Gy=.1;function ky(e,t,i){return(0,Fy.v)(t,e)*(i[1]-i[0])+i[0]}function Zy(e,t,i){let n=0;if(!t.some((e=>!!e.materialReference&&(n+=e.numGeometries,n>=1e4))))return nb.compute(e,t);const r=dv();return i.forAll((t=>pv(r,function(e,t){if(!t.visible)return;const i=dv(),n=t.getSpatialQueryAccelerator();return n?function(e,t,i){const n=t.eye,r=t.viewForward,s=t.frustum,a=e=>e.visible,o=i.objectCount;if(o<zy)uv(tb,t.near,Math.min(e.near,t.far)),i.forEachInDepthRange(n,r,Vy.Z.DepthOrder.FRONT_TO_BACK,tb,((i,n)=>{jy(e,t,i),tb.far=e.near,n.setRange(tb)}),s,a),uv(tb,Math.max(e.far,t.near),t.far),i.forEachInDepthRange(n,r,Vy.Z.DepthOrder.BACK_TO_FRONT,tb,((i,n)=>{jy(e,t,i),tb.near=e.far,n.setRange(tb)}),s,a);else{const n=Math.max(Math.min(o,By),Math.ceil(o*Gy)),l=i.findClosest(r,Vy.Z.DepthOrder.FRONT_TO_BACK,s,a,n),h=i.findClosest(r,Vy.Z.DepthOrder.BACK_TO_FRONT,s,a,n);l&&h&&(Xy(e,t,l.boundingVolumeWorldSpace.bounds),Xy(e,t,h.boundingVolumeWorldSpace.bounds))}}(i,e,n):function(e,t,i){ib.clear(),i.forAll((e=>{e.visible&&0!==e.geometries.length&&ib.add(e)})),ib.empty||(ib.sort(t),uv(tb,t.near,Math.min(e.near,t.far)),ib.forEachInDepthRange(tb,Vy.Z.DepthOrder.FRONT_TO_BACK,((i,n)=>{n<e.near&&jy(e,t,i)})),uv(tb,Math.max(e.far,t.near),t.far),ib.forEachInDepthRange(tb,Vy.Z.DepthOrder.BACK_TO_FRONT,((t,i,n)=>{e.far=Math.max(e.far,n)})))}(i,e,t.objects),i}(e,t)))),r}function jy(e,t,i){if(!i.visible)return;if(!(0,ih.hr)(t.frustum,i.boundingVolumeWorldSpace.bounds))return;const n=i.transformation,r=eb;i.geometries.forEach((i=>{(0,Pt.Jp)(r,n,i.transformation);const s=(0,fe.u1)(r);Wy(e,t,i.boundingInfo,r,s)}))}function Wy(e,t,i,n,r){if(null==i)return;(0,Ge.h)((0,bn.g)($y),i.center,n);const{eye:s,viewForward:a}=t,o=a[0]*($y[0]-s[0])+a[1]*($y[1]-s[1])+a[2]*($y[2]-s[2]);if($y[3]=i.radius*r,!(o-$y[3]>e.near&&o+$y[3]<e.far)&&(0,ih.hr)(t.frustum,$y))if(i.radius>qy&&i.getChildren())for(const l of i.getChildren())Wy(e,t,l,n,r);else rb.unionDepthRangeWithAABB(e,t.viewProjectionMatrix,n,i.bbMin,i.bbMax)}function Xy(e,t,i){const n=t.eye,r=t.viewForward,s=(i[0]-n[0])*r[0]+(i[1]-n[1])*r[1]+(i[2]-n[2])*r[2];e.near=Math.min(e.near,s-i[3]),e.far=Math.max(e.far,s+i[3])}function Qy(e,t,i){let n=[e,t,i];for(let r=0;r<4;++r){const e=n;n=[];for(let t=0;t<e.length;++t){const i=e[t],s=e[(t+1)%e.length];Yy(s,r)?(Yy(i,r)||n.push(Jy(i,s,r)),n.push(s)):Yy(i,r)&&n.push(Jy(i,s,r))}}return n}function Yy(e,t){return 0===t?e[0]>=-e[3]:1===t?e[1]>=-e[3]:2===t?e[0]<=e[3]:3===t?e[1]<=e[3]:void(0,vi.hu)(!1)}function Jy(e,t,i){let n=0;return 0===i?n=(-e[3]-e[0])/(t[0]-e[0]+t[3]-e[3]):1===i?n=(-e[3]-e[1])/(t[1]-e[1]+t[3]-e[3]):2===i?n=(e[3]-e[0])/(t[0]-e[0]-t[3]+e[3]):3===i&&(n=(e[3]-e[1])/(t[1]-e[1]-t[3]+e[3])),(0,Qe.l)((0,Ye.Ue)(),e,t,n)}const Ky=[[0,1,3],[2,3,1],[1,5,2],[6,2,5],[5,4,6],[7,6,4],[4,0,7],[3,7,0],[3,2,7],[6,7,2],[4,5,0],[1,0,5]],$y=(0,bn.c)(),eb=(0,Mt.Ue)(),tb=dv(),ib=new class{constructor(){this._items=new pl.Z({allocator:e=>e||{object:null,distance:0,near:0,far:0},deallocator:e=>(e.object=null,e.distance=0,e.near=0,e.far=0,e)})}get length(){return this._items.length}get empty(){return 0===this._items.length}clear(){this._items.clear()}add(e){this._items.pushNew().object=e}sort(e){const t=e.eye,i=e.viewForward;this._items.forAll((e=>{const n=e.object.boundingVolumeWorldSpace.bounds,r=(n[0]-t[0])*i[0]+(n[1]-t[1])*i[1]+(n[2]-t[2])*i[2];e.distance=r,e.near=r-n[3],e.far=r+n[3]})),this._items.sort(((e,t)=>e.distance-t.distance))}forEachInDepthRange(e,t,i){if(t===Vy.Z.DepthOrder.FRONT_TO_BACK)for(let n=0;n<this._items.length;++n){const t=this._items.data[n];t.far<e.near||t.near>e.far||i(t.object,t.near,t.far)}else for(let n=this._items.length-1;n>=0;--n){const t=this._items.data[n];t.far<e.near||t.near>e.far||i(t.object,t.near,t.far)}}},nb=new class{constructor(){this._view=(0,Mt.Ue)(),this._viewProj=(0,Mt.Ue)(),this._frustum=(0,ih.Ue)(),this._geometries=new Array,this._near=[],this._far=[],this._nearCandidates=[],this._farCandidates=[],this._looseRange={near:0,far:0}}compute(e,t){this._reset(),(0,Pt.JG)(this._view,e.viewMatrix),(0,Pt.Jp)(this._viewProj,e.projectionMatrix,this._view),(0,ih.JG)(this._frustum,e.frustum);const i=this._view,n=i[2],r=i[6],s=i[10],a=i[14];t.forAll((e=>{e.materialReference&&e.forEachGeometry&&e.forEachGeometry((e=>{if(!e.visible||!e.castShadow)return;const t=e.boundingSphere,i=n*t[0]+r*t[1]+s*t[2]+a,o=i-t[3],l=i+t[3];this._geometries.push(e),this._near.push(-l),this._far.push(-o)}))}));const o=new cv;if(0===this._geometries.length)return o;for(let d=0;d<this._geometries.length;++d)this._near[d]>o.far&&(o.far=this._near[d]),this._near[d]>2&&this._far[d]<o.near&&(o.near=this._far[d]);const l=this._looseRange;l.near=Math.max(.5*o.near,2),l.far=2*o.far;let h=0,c=0;for(let d=0;d<this._geometries.length;++d)this._near[d]<o.near&&(this._near[d]>=l.near?o.near=this._near[d]:this._nearCandidates[h++]=d),this._far[d]>o.far&&(this._far[d]<=l.far?o.far=this._far[d]:this._farCandidates[c++]=d);if(0===this._nearCandidates.length&&0===this._farCandidates.length)return o;this._nearCandidates.sort(((e,t)=>this._near[e]<this._near[t]?-1:this._near[e]>this._near[t]?1:0)),this._farCandidates.sort(((e,t)=>this._far[e]<this._far[t]?1:this._far[e]>this._far[t]?-1:0));for(let d=0;d<this._nearCandidates.length;++d){const e=this._nearCandidates[d];if(this._near[e]<o.near){const t=this._geometries[e],i=t.boundingInfo;this._includeNearBoundingInfoRec(i,t.shaderTransformation,o)}}for(let d=0;d<this._farCandidates.length;++d){const e=this._farCandidates[d];if(this._far[e]>o.far){const t=this._geometries[e],i=t.boundingInfo;this._includeFarBoundingInfoRec(i,t.shaderTransformation,o)}}return this._reset(),o}_reset(){this._geometries.length=0,this._near.length=0,this._far.length=0,this._nearCandidates.length=0,this._farCandidates.length=0}_includeNearBoundingInfoRec(e,t,i){if(null==e)return;const n=e.center;(0,Ge.h)((0,bn.g)($y),n,t);const r=(0,fe.u1)(t),s=$y[0],a=$y[1],o=$y[2],l=e.radius*r,h=this._frustum;if(h[0][0]*s+h[0][1]*a+h[0][2]*o+h[0][3]>l||h[1][0]*s+h[1][1]*a+h[1][2]*o+h[1][3]>l||h[2][0]*s+h[2][1]*a+h[2][2]*o+h[2][3]>l||h[3][0]*s+h[3][1]*a+h[3][2]*o+h[3][3]>l)return;const c=this._view[2]*s+this._view[6]*a+this._view[10]*o+this._view[14],d=c+l;if(!(-(c-l)<2||-d>=i.near))if(-d>this._looseRange.near)i.near=-d;else{if(l>qy){const n=e.getChildren();if(void 0!==n){for(const e of n)this._includeNearBoundingInfoRec(e,t,i);return}}rb.unionDepthRangeWithAABB(i,this._viewProj,t,e.bbMin,e.bbMax)}}_includeFarBoundingInfoRec(e,t,i){if(null==e)return;let n=e.radius;const r=e.center;(0,Ge.h)((0,bn.g)($y),r,t);const s=(0,fe.u1)(t),a=$y[0],o=$y[1],l=$y[2];n*=s;const h=this._frustum;if(h[0][0]*a+h[0][1]*o+h[0][2]*l+h[0][3]>n||h[1][0]*a+h[1][1]*o+h[1][2]*l+h[1][3]>n||h[2][0]*a+h[2][1]*o+h[2][2]*l+h[2][3]>n||h[3][0]*a+h[3][1]*o+h[3][2]*l+h[3][3]>n)return;const c=this._view[2]*a+this._view[6]*o+this._view[10]*l+this._view[14]-n;if(!(-c<=i.far))if(-c<this._looseRange.far)i.far=-c;else{if(n>qy){const n=e.getChildren();if(void 0!==n){for(const e of n)this._includeFarBoundingInfoRec(e,t,i);return}}rb.unionDepthRangeWithAABB(i,this._viewProj,t,e.bbMin,e.bbMax)}}},rb=new class{constructor(){this._modelViewProj=(0,Mt.Ue)(),this._clipPosition=[(0,Ye.Ue)(),(0,Ye.Ue)(),(0,Ye.Ue)(),(0,Ye.Ue)(),(0,Ye.Ue)(),(0,Ye.Ue)(),(0,Ye.Ue)(),(0,Ye.Ue)()]}unionDepthRangeWithAABB(e,t,i,n,r){const s=this._modelViewProj;(0,Pt.Jp)(s,t,i);let a=!1;for(let o=0;o<8;++o){const e=this._clipPosition[o],t=0===o||3===o||4===o||7===o?n[0]:r[0],i=0===o||1===o||4===o||5===o?n[1]:r[1],a=o<4?n[2]:r[2];e[0]=s[0]*t+s[4]*i+s[8]*a+s[12],e[1]=s[1]*t+s[5]*i+s[9]*a+s[13],e[2]=s[2]*t+s[6]*i+s[10]*a+s[14],e[3]=s[3]*t+s[7]*i+s[11]*a+s[15]}for(let o=0;o<12;++o){const t=Qy(this._clipPosition[Ky[o][0]],this._clipPosition[Ky[o][1]],this._clipPosition[Ky[o][2]]);let i=!0;for(let e=0;e<t.length;++e)if(t[e][3]>=2){i=!1;break}if(!i){a=!0;for(let i=0;i<t.length;++i){const n=t[i][3];Number.isFinite(n)&&(e.near=Math.min(n,e.near),e.far=Math.max(n,e.far))}}}return a}};var sb=i(53252),ab=i(59447);class ob{constructor(){this.declaredClass="esri.views.3d.webgl-engine.lib.ObjectAndLayerIdRenderHelper",this.colorZero=new Rm.mc(new ArrayBuffer(4)),this._layerToOidToColor=new ab.r,this._colorToUID=new Map,this._layerUidToGraphicsUidToObjectId=new ab.r,this._layerUidToId=new Map,this._layerUidToPopupEnabled=new Map}setUidToObjectAndLayerId(e,t,i,n,r){let s=arguments.length>5&&void 0!==arguments[5]?arguments[5]:null,a=arguments.length>6&&void 0!==arguments[6]?arguments[6]:null,o=arguments.length>7&&void 0!==arguments[7]?arguments[7]:null;e&&t&&i&&n&&(this._layerUidToId.set(n,i),this._layerUidToPopupEnabled.set(n,r),r&&this._layerUidToGraphicsUidToObjectId.set(n,t,{objectId:e,attributeNodeId:s,attributeIndex:a,subLayerId:o}))}getObjectAndLayerIdColor(e){const t=this.getObjectAndLayerIdColorArray(e);return(0,Ye.al)(t.get(0,1),t.get(0,2),t.get(0,3),255)}getObjectAndLayerIdColorArray(e){var t;if(!e.layerUid||!e.graphicUid)return this.colorZero;const i=this._layerUidToPopupEnabled.get(e.layerUid);if(void 0===i)return this.colorZero;if(!1===i)return this.colorZero;const n=null===(t=this._layerUidToGraphicsUidToObjectId.get(e.layerUid,e.graphicUid))||void 0===t?void 0:t.objectId;if(!n)return this.colorZero;let r=this._layerToOidToColor.get(e.layerUid,n);if(!r){for(;!r;){const e=Math.floor(16777214*Math.random())+1;this._colorToUID.has(e)||(r=e)}if(r>16777215)throw new Error("Object ID Overflow");this._layerToOidToColor.set(e.layerUid,n,r),this._colorToUID.set(r,e)}const s=new ArrayBuffer(4);return new DataView(s).setUint32(0,r,!1),new Rm.mc(s)}getColorToObjectAndLayerIdMapping(){const e=new Map;for(const[t,i]of this._colorToUID.entries()){const n=this._layerUidToGraphicsUidToObjectId.get(i.layerUid,i.graphicUid),r=this._layerUidToId.get(i.layerUid);n&&r&&e.set(t,n.attributeNodeId?{type:"object-and-layer-and-i3s-id",oid:n.objectId,lid:r,attrId:n.attributeNodeId,attrIdx:n.attributeIndex,subLayerId:n.subLayerId}:{type:"object-and-layer-id",oid:n.objectId,lid:r})}return e}}var lb,hb;i(75505),i(86741),i(51370),i(37998);!function(e){e.OPAQUE="opaque-color",e.TRANSPARENT="transparent-color",e.COMPOSITE="composite-color",e.FINAL="final-color"}(lb||(lb={})),function(e){e.ANTIALIASING="aa-color",e.HIGHLIGHTS="highlight-color",e.MAGNIFIER="magnifier-color"}(hb||(hb={}));class cb{constructor(e,t){this.key=e,this.free=t,this.incarnation=0,this._refCount=1}retain(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:1;this._refCount+=e}release(){return 0===this._refCount?(console.log("Releasing already released FBO attachment in ".concat((new Error).stack)),!0):(--this._refCount,0===this._refCount&&(this.free(),!0))}}var db;!function(e){e[e.FBO=0]="FBO",e[e.DEPTH=1]="DEPTH",e[e.COLOR=2]="COLOR"}(db||(db={}));class ub extends cb{constructor(e,t,i){super(e,i),this.attachment=t,this.name=""}dispose(){this.attachment.dispose()}get usedMemory(){return this.attachment.usedMemory}}class pb extends ub{constructor(e,t,i){super(e,t,i),this.attachment=t,this.type=db.COLOR}}class _b extends ub{constructor(){super(...arguments),this.type=db.DEPTH}}var mb=i(46888);class gb extends cb{constructor(e,t,i,n,r,s){super(e,s),this.type=db.FBO,this._colors=new Map,this._name="composite-color",this.acquireDepth=null,this.acquireColor=null,this._name=t,this.fbo=i,this.acquireDepth=n,this.acquireColor=r}dispose(){var e;null===(e=this.fbo)||void 0===e||e.dispose()}get usedMemory(){var e;return(null===(e=this.fbo)||void 0===e?void 0:e.usedMemory)||0}get name(){return this._name}setName(e){this._name=e}getTexture(){var e,t;let i=arguments.length>0&&void 0!==arguments[0]?arguments[0]:st.VY.COLOR_ATTACHMENT0;return i===st.Lu?null===(e=this.fbo)||void 0===e?void 0:e.depthStencilTexture:null===(t=this.fbo)||void 0===t?void 0:t.getColorTexture(i)}getAttachment(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:st.VY.COLOR_ATTACHMENT0;return e===st.Lu?this._depth:this._colors.get(e)}attachDepth(e){var t;return null!==e&&void 0!==e&&e.retain(),this.detachDepth(),e&&null!==(t=this.fbo)&&void 0!==t&&t.attachDepthStencil(e.attachment),this._depth=e,this}detachDepth(){var e,t;null!==(e=this.fbo)&&void 0!==e&&e.detachDepthStencilTexture(),null!==(t=this.fbo)&&void 0!==t&&t.detachDepthStencilBuffer(),this._depth=(0,p.RY)(this._depth)}obtainDepthTexture(){var e;const t=this._depth;return function(e){return(null===e||void 0===e?void 0:e.attachment.type)===mb.B.Texture}(t)?(null!==(e=this.fbo)&&void 0!==e&&e.detachDepthStencilTexture(),this._depth=null,t):null}attachColor(e,t){var i;return e.retain(),this.detachColor(t),null!==(i=this.fbo)&&void 0!==i&&i.attachColorTexture(e.attachment,t),this._colors.set(t,e),this}detachColor(e){var t;null===(t=this.fbo)||void 0===t||t.detachColorTexture(e);const i=this._colors.get(e);this._colors.delete(e),null===i||void 0===i||i.release()}detachAll(){this._colors.forEach(((e,t)=>this.detachColor(t))),this.detachDepth()}}class fb{constructor(e,t){this._last=new pl.Z,this._incarnation=0,this._cache=new ju.N(e,t)}destroy(){var e;null!==(e=this._last)&&void 0!==e&&e.forAll((e=>e.dispose())),this._last=null,this._cache.destroy()}set interactive(e){var t;e&&!this._last?this._last=new pl.Z:e||(null!==(t=this._last)&&void 0!==t&&t.forAll((e=>e.dispose())),this._last=null)}clean(){var e;null===(e=this._last)||void 0===e||e.filterInPlace((e=>!(e.incarnation<this._incarnation)||(this._cache.put(e.key,e),!1)))}frame(){++this._incarnation}pop(e){if(this._last){const t=this._last.find((t=>t.key===e));if(t)return this._last.removeUnordered(t),t}return this._cache.pop(e)}put(e){e.incarnation=this._incarnation,this._last?this._last.push(e):this._cache.put(e.key,e)}get usedMemory(){var e,t;return null!==(e=null===(t=this._last)||void 0===t?void 0:t.reduce(((e,t)=>e+t.usedMemory),0))&&void 0!==e?e:0}}var vb=i(15880);class yb{constructor(e){this.rctx=e,this._acquired=new Set,this._cache=new fb(e.newCache,"FBOCache"),this._depthCache=new fb(e.newCache,"DepthAttachmentCache"),this._colorCache=new fb(e.newCache,"ColorAttachmentCache")}destroy(){this._cache.destroy(),this._depthCache.destroy(),this._colorCache.destroy()}clean(){this._cache.clean(),this._colorCache.clean(),this._depthCache.clean()}frameStart(){this._cache.frame(),this._colorCache.frame(),this._depthCache.frame(),this.debugCallback&&this.debugCallback()}frameEnd(){const e=this.debugCallback;e&&this._acquired.forEach((t=>t.type===db.FBO&&e(t.name,t.fbo)))}get usedMemory(){return Array.from(this._acquired.values()).reduce(((e,t)=>{var i,n;return e+("getTexture"in t?null!==(i=null===(n=t.getTexture())||void 0===n?void 0:n.usedMemory)&&void 0!==i?i:0:t.usedMemory)}),this._cache.usedMemory+this._colorCache.usedMemory+this._depthCache.usedMemory)}set interactive(e){this._cache.interactive=this._colorCache.interactive=this._depthCache.interactive=e}acquire(e,t,i){let n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:ut.q.RGBA;const r=wb(n,e,t);let s=this._cache.pop(r);if(s){s.retain(),s.setName(i);const e=this.rctx.getBoundFramebufferObject();this.rctx.bindFramebuffer(s.fbo),this.rctx.setDrawBuffers([st.VY.COLOR_ATTACHMENT0]),this.rctx.bindFramebuffer(e)}else s=new gb(r,i,new Ft.X(this.rctx,{...Ab[n],width:e,height:t}),(e=>{var t;null!==(t=e)&&void 0!==t||(e=ut.m.DEPTH_STENCIL_TEXTURE);const i=this._acquireDepth(e,s.fbo.width,s.fbo.height,"".concat(s.name," depth"));return s.attachDepth(i),i.release(),s}),((i,n)=>{var r;null!==(r=n)&&void 0!==r||(n=ut.q.RGBA);const a=this._acquireColor(n,e,t,"".concat(s.name," color ").concat(i));return s.attachColor(a,i),a.release(),s}),(()=>{this.debugCallback&&this.debugCallback(s.name,s.fbo),this._acquired.delete(s),s.detachAll(),this._cache.put(s)}));return this._trackHandle(s)}acquireDepth(e,t,i,n){return this._acquireDepth(e,t,i,n)}_acquireDepth(e,t,i,n){const r=wb(e,t,i),s=this._depthCache.pop(r);if(s)return s.retain(),s.name=n,this._trackHandle(s);const a=e===ut.m.DEPTH_STENCIL_TEXTURE?new _b(r,new di.x(this.rctx,{...Eb[e],width:t,height:i}),(()=>{this._acquired.delete(a),this._depthCache.put(a)})):new _b(r,new vb.r(this.rctx,{...Eb[e],width:t,height:i}),(()=>{this._acquired.delete(a),this._depthCache.put(a)}));return a.name=n,this._trackHandle(a)}_acquireColor(e,t,i,n){const r=wb(e,t,i),s=this._colorCache.pop(r);if(s)return s.retain(),s.name=n,this._trackHandle(s);const a=new pb(r,new di.x(this.rctx,{...Ab[e],width:t,height:i}),(()=>{this._acquired.delete(a),this._colorCache.put(a)}));return a.name=n,this._trackHandle(a)}_trackHandle(e){return this._acquired.add(e),e}}const bb=new gb("default","default",null,(()=>bb),(()=>bb),(()=>{}));function wb(e,t,i){return"".concat(e,"x").concat(t,"x").concat(i)}const Cb=new Vt.X;Cb.pixelFormat=st.VI.RED,Cb.internalFormat=st.lP.R8,Cb.wrapMode=st.e8.CLAMP_TO_EDGE;const xb=new Vt.X;xb.pixelFormat=st.VI.RG,xb.internalFormat=st.lP.RG8,xb.wrapMode=st.e8.CLAMP_TO_EDGE;const Tb=new Vt.X;Tb.internalFormat=st.lP.RGBA4,Tb.dataType=st.Br.UNSIGNED_SHORT_4_4_4_4,Tb.wrapMode=st.e8.CLAMP_TO_EDGE;const Sb=new Vt.X;Sb.wrapMode=st.e8.CLAMP_TO_EDGE;const Pb=new Vt.X;Pb.wrapMode=st.e8.CLAMP_TO_EDGE,Pb.samplingMode=st.cw.LINEAR_MIPMAP_LINEAR,Pb.hasMipmap=!0,Pb.maxAnisotropy=8;const Mb=new Vt.X;Mb.pixelFormat=st.VI.RED,Mb.dataType=st.Br.HALF_FLOAT,Mb.internalFormat=st.lP.R16F,Mb.samplingMode=st.cw.NEAREST;const Rb=new Vt.X;Rb.dataType=st.Br.HALF_FLOAT,Rb.internalFormat=st.lP.RGBA16F,Rb.samplingMode=st.cw.NEAREST;const Ab={[ut.q.RED]:Cb,[ut.q.RG]:xb,[ut.q.RGBA4]:Tb,[ut.q.RGBA]:Sb,[ut.q.RGBA_MIPMAP]:Pb,[ut.q.R16F]:Mb,[ut.q.RGBA16F]:Rb},Ob=new Vt.X;Ob.pixelFormat=st.VI.DEPTH_STENCIL,Ob.dataType=st.Br.UNSIGNED_INT_24_8,Ob.samplingMode=st.cw.NEAREST,Ob.wrapMode=st.e8.CLAMP_TO_EDGE;const Eb={[ut.m.DEPTH_STENCIL_TEXTURE]:Ob,[ut.m.DEPTH16_BUFFER]:new og.Y(st.Tg.DEPTH_COMPONENT16,4)};var Db,Ib=i(74779),Lb=i(25920);!function(e){e[e.FrontToBack=0]="FrontToBack",e[e.BackToFront=1]="BackToFront"}(Db||(Db={}));class Nb{constructor(e,t){let i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:Db.FrontToBack;this._rctx=e,this._techniques=t,this._sorting=i,this._draws=new pl.Z({initialSize:32,allocator:e=>e||{material:null,geometry:null,geometryRanges:null,bindDrawParams:null,depthSquaredHint:0,indexType:0}}),this._previouslyBoundDraw=new Map}submitDraw(e,t,i,n){var r;const s=this._draws.pushNew();s.geometry=t,s.geometryRanges=i,s.material=e,s.depthSquaredHint=n,s.indexType=null!==(r=t.indexed?t.vao.indexBuffer.indexType:null)&&void 0!==r?r:0}prepare(e,t){return this._draws.map((i=>i.material.prepareTechnique(this._techniques,e,t,i.geometry.parameters)))}dispatch(e,t,i){const n=this._rctx;this._previouslyBoundDraw.clear();let r=null;const s=this._draws.length;for(let a=0;a<s;a++){const s=i[a];s===r&&s.configuration.transparencyPassType===Lb.A.NONE||(n.bindTechnique(s,t,e),r=s);const o=this._draws.data[a],l=o.geometry;n.bindVAO(l.vao),this._previouslyBoundDraw.get(s)!==o.material&&(s.program.bindDraw(o.material,t,e),this._previouslyBoundDraw.set(s,o.material));const h=o.geometryRanges,c=h.length;if(0!==o.indexType){const e=Ub.get(o.indexType);for(let t=0;t<c;t+=2){const i=h[t],r=h[t+1];n.drawElements(l.primitiveType,r,o.indexType,i*e)}}else for(let e=0;e<c;e+=2){const t=h[e],i=h[e+1];n.drawArrays(l.primitiveType,t,i)}}}prepareSubmit(){this._draws.clear()}finishSubmit(){const e=this._sorting===Db.FrontToBack?1:-1;this._draws.sort(((t,i)=>{const n=e*(t.depthSquaredHint-i.depthSquaredHint);return 0!==n?n:t.geometry.vao.byteSize-i.geometry.vao.byteSize}))}get count(){return this._draws.length}}const Ub=new Map;Ub.set(st.g.UNSIGNED_BYTE,1),Ub.set(st.g.UNSIGNED_SHORT,2),Ub.set(st.g.UNSIGNED_INT,4);var Hb=i(75104);let Fb=class extends $i.P6{constructor(){super({}),this._passes=null,this.produces=new Map([[en.r.OPAQUE_MATERIAL,e=>this._produces(e)],[en.r.TRANSPARENT_MATERIAL,e=>!!(this._passes&&this._passes.materialTransparent.count>0)&&this._produces(e)],[en.r.INTEGRATED_MESH,e=>this._produces(e)]]),this._materialPassParameters=new Ib.SP,this._shadowPassParameters=new Ib.kF,this._highlightPassParameters=new Ib.T5,this._viewshedPassParameters=new Ib.vF,this._systems=new Set}initializeRenderContext(e){this._context=e;const t=e.renderContext.rctx,i=e.techniques;this._passes={materialOpaque:new Nb(t,i),materialTransparent:new Nb(t,i,Db.BackToFront),materialIntegratedMesh:new Nb(t,i),shadowMap:new Nb(t,i),highlight:new Nb(t,i),highlightIntegratedMesh:new Nb(t,i),highlightShadowMap:new Nb(t,i),viewshedShadowMap:new Nb(t,i),defaultShadowMap:new Nb(t,i)}}get rctx(){return this._context.renderContext.rctx}uninitializeRenderContext(){}dispose(){this._context=null,this._systems.clear()}register(e){this._systems.add(e)}_produces(e){return 0!==this._systems.size&&null!==this._passes&&(e===l_.H_.Highlight?this._passes.highlight.count>0||this._passes.highlightIntegratedMesh.count>0:e!==l_.H_.ShadowHighlight||this._passes.highlight.count>0)}prepareRender(e){if(0!==this._systems.size&&null!==this._passes){for(const e of Object.values(this._passes))e.prepareSubmit();this._systems.forEach((t=>t.submit(this._passes,e.bindParameters)));for(const e of Object.values(this._passes))e.finishSubmit();this._context.techniques.frameUpdate()}}prepareTechniques(e){if(0===this._systems.size)return null;const t=e.output===l_.H_.Shadow||e.output===l_.H_.ShadowHighlight||e.output===l_.H_.ShadowExcludeHighlight?this._shadowPassParameters:e.output===l_.H_.ViewshedShadow?this._viewshedPassParameters:e.output===l_.H_.Highlight?this._highlightPassParameters:this._materialPassParameters,i=e.bindParameters;return this._updateParameters(i.camera,t,i.slot===en.r.TRANSPARENT_MATERIAL),this._materialPassParameters.output=e.output,this._invoke(e,((t,i)=>t.prepare(i,e.bindParameters)))}renderNode(e,t){this._invoke(e,((i,n)=>i.dispatch(n,e.bindParameters,t)))}_invoke(e,t){if(null===this._passes)return null;switch(e.bindParameters.slot){case en.r.OPAQUE_MATERIAL:switch(e.output){case l_.H_.Color:case l_.H_.Depth:case l_.H_.Normal:case l_.H_.ObjectAndLayerIdColor:return t(this._passes.materialOpaque,this._materialPassParameters);case l_.H_.Highlight:return t(this._passes.highlight,this._highlightPassParameters);case l_.H_.Shadow:return t(this._passes.shadowMap,this._shadowPassParameters);case l_.H_.ShadowHighlight:return t(this._passes.highlightShadowMap,this._shadowPassParameters);case l_.H_.ShadowExcludeHighlight:return t(this._passes.defaultShadowMap,this._shadowPassParameters);case l_.H_.ViewshedShadow:return t(this._passes.viewshedShadowMap,this._viewshedPassParameters)}break;case en.r.TRANSPARENT_MATERIAL:switch(e.output){case l_.H_.Color:case l_.H_.Depth:case l_.H_.Normal:case l_.H_.ObjectAndLayerIdColor:return t(this._passes.materialTransparent,this._materialPassParameters)}break;case en.r.INTEGRATED_MESH:switch(e.output){case l_.H_.Color:case l_.H_.Depth:case l_.H_.Normal:case l_.H_.ObjectAndLayerIdColor:return t(this._passes.materialIntegratedMesh,this._materialPassParameters);case l_.H_.Highlight:return t(this._passes.highlightIntegratedMesh,this._highlightPassParameters)}}return null}notifyDirty(){this._context.requestRender()}queryDepthRange(e){const t=new cv;return this._systems.forEach((i=>pv(t,i.queryShadowCasterDepthRange(e)))),t}_updateParameters(e,t,i){const n=e.viewInverseTransposeMatrix;(0,Ge.s)(Vb,n[3],n[7],n[11]),zb.set(Vb),(0,Ge.c)(t.transformWorldFromViewTH,zb.high),(0,Ge.c)(t.transformWorldFromViewTL,zb.low),(0,Ge.c)(t.slicePlaneLocalOrigin,Vb),(0,St.xO)(t.transformViewFromCameraRelativeRS,e.viewMatrix),(0,Pt.JG)(t.transformProjFromView,e.projectionMatrix),t.identifier===Ib.o9.Material&&(this._materialPassParameters.transparent=i,(0,St.p4)(qb,t.transformViewFromCameraRelativeRS),(0,St.U_)(t.transformNormalViewFromGlobal,qb))}};Fb=(0,n._)([(0,C.j)("esri.views.3d.webgl-engine.core.renderPasses.RenderPassManager")],Fb);const Vb=(0,R.Ue)(),qb=(0,pr.Ue)(),zb=new Hb.I;var Bb=i(83866),Gb=i(41287);function kb(e){return e.name}var Zb=i(37825);class jb{constructor(e){this._context=e,this._nodes=new pl.Z}destroy(){this._nodes.forEach((e=>e.destroy())),this._nodes.clear()}add(e){this._nodes.push(e),Zb.CM&&console.log("Registered render nodes: ".concat(this._nodes.map((e=>{let{declaredClass:t}=e;return t})).join(", ")))}remove(e){this._nodes.remove(e),Zb.CM&&console.log("Registered render nodes: ".concat(this._nodes.map((e=>{let{declaredClass:t}=e;return t})).join(", ")))}produces(e){return this._nodes.some((t=>{let{produces:i}=t;return i===e}))}require(e){const t=this._nodes;for(var i=arguments.length,n=new Array(i>1?i-1:0),r=1;r<i;r++)n[r-1]=arguments[r];return n.reduce(((i,n)=>i+t.reduce(((t,i)=>{let{consumes:r,produces:s}=i;return t+(r.required.includes(e)&&s===n?1:0)}),0)),0)}optional(e){const t=this._nodes;for(var i=arguments.length,n=new Array(i>1?i-1:0),r=1;r<i;r++)n[r-1]=arguments[r];return n.reduce(((i,n)=>i+t.reduce(((t,i)=>{var r;let{consumes:s,produces:a}=i;return t+(null!==(r=s.optional)&&void 0!==r&&r.includes(e)&&a===n?1:0)}),0)),0)}updateAnimation(){return this._nodes.reduce(((e,t)=>t.updateAnimation()||e),!1)}render(e,t){let i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:()=>{};const n=kb(e)?e.name:e,r=this._nodes.filter((e=>{let{produces:t}=e;return t===n}));return 0===r.length||(r.forEach((r=>{const s=kb(e)?[e]:[];for(const e of r.consumes.required){if(e===n)continue;const r=t.get(e);if(!r)return void(i&&i(s));s.push(r)}if(r.consumes.optional)for(const e of r.consumes.optional){if(e===n)continue;const i=t.get(e);i&&s.push(i)}try{const i=r.doRender(s,this._context);i&&i!==e&&(kb(e)?(e.release(),e=i,t.set(n,e)):e=i)}catch(re){u.Z.getLogger(r).errorOnce(re)}i&&i(s)})),this._context.rctx.enforceState()),kb(e)?e:bb}}class Wb{constructor(e){this._context=e,this._renderPlugins=new pl.Z,this._materialRenderers=new Map,this._slots=new Array,this._renderVersion=(0,Od.t)(0);for(let t=0;t<en.r.MAX_SLOTS;++t)this._slots[t]=[]}destroy(){this._renderPlugins.forEach((e=>e.destroy())),this._renderPlugins.clear(),this._materialRenderers.clear()}get plugins(){return this._renderPlugins}add(e,t){const i=()=>{if(null!==t&&void 0!==t&&t.aborted)throw e.uninitializeRenderContext(),(0,m.zE)();this._renderPlugins.push(e),e.materialReference&&this._materialRenderers.set(e.materialReference,e),e.produces.forEach(((t,i)=>{this._slots[i].push(e)})),this._context.requestRender(),this._renderVersion.value++},n=e.initializeRenderContext(this._context,t);if((0,m.y8)(n))return n.then(i);i()}remove(e){if(null!=e.materialReference&&this._materialRenderers.delete(e.materialReference),null!=this._renderPlugins.removeUnordered(e)){for(let t=0;t<this._slots.length;++t)this._slots[t]=this._slots[t].filter((t=>t!==e));e.uninitializeRenderContext(),this._context.requestRender(),this._renderVersion.value++}}prepareRender(){this._renderPlugins.forAll((e=>{e.prepareRender&&e.prepareRender(this._context.renderContext)}))}updateAnimation(e){let t=!1;return this._renderPlugins.forAll((i=>{i.updateAnimation&&(t=i.updateAnimation(e)||t)})),t}renderFeatureChanged(){this._renderPlugins.forAll((e=>{e.renderFeatureChanged&&e.renderFeatureChanged()}))}prepare(){for(var e=arguments.length,t=new Array(e),i=0;i<e;i++)t[i]=arguments[i];for(const n of t)this._context.renderContext.bindParameters.slot=n,this._slots[n].forEach((e=>{const t=e.produces.get(n);(null===t||void 0===t?void 0:t(l_.H_.Color))&&((0,$i.QA)(e)&&e.prepareTechnique(this._context.renderContext),(0,$i.bV)(e)&&e.prepareTechniques(this._context.renderContext))}))}_getRenderables(){var e;const t=this._context.renderContext.bindParameters.slot,i=null!==(e=this._context.renderContext.output)&&void 0!==e?e:l_.H_.Color,n=new Map;return this._slots[t].forEach((e=>{const r=e.produces.get(t);if(null!==r&&void 0!==r&&r(i)&&(!e.isDecoration||this._context.renderContext.bindParameters.decorations!==dp.Iq.OFF))if((0,$i.QA)(e)){const t=e.prepareTechnique(this._context.renderContext);null!=t&&n.set(e,t)}else if((0,$i.bV)(e)){const t=e.prepareTechniques(this._context.renderContext);null!=t&&n.set(e,t)}else n.set(e,null)})),n}render(e){for(var t=arguments.length,i=new Array(t>1?t-1:0),n=1;n<t;n++)i[n-1]=arguments[n];for(const r of i)this._context.renderContext.bindParameters.slot=r,this._getRenderables().forEach(((t,i)=>i.renderNode(this._context.renderContext,t,e)))}queryDepthRange(e){const t=new cv;return this._renderPlugins.forAll((i=>{var n;const r=null===(n=i.queryDepthRange)||void 0===n?void 0:n.call(i,e);pv(t,r)})),t}get updating(){return this._renderVersion.value>=0&&this._renderPlugins.some((e=>e.running))}produces(e){for(var t=arguments.length,i=new Array(t>1?t-1:0),n=1;n<t;n++)i[n-1]=arguments[n];for(const r of i)if(this._slots[r].some((t=>{const i=t.produces.get(r);return!!i&&i(e)})))return!0;return!1}consumes(e){return this._renderPlugins.some((t=>t.consumes().required.includes(e)))}getMaterialRenderer(e){return this._materialRenderers.get(e)}removeEmptyMaterialRenderers(){this._renderPlugins.filterInPlace((e=>!e.materialReference||0!==e.numGeometries||(this._materialRenderers.delete(e.materialReference),e.destroy(),!1)))}get hasDecorations(){return this._renderPlugins.some((e=>e.isDecoration))}get hasOccludees(){return this._renderPlugins.some((e=>e.hasOccludees))}get renderOccludedFlags(){return this._renderPlugins.reduce(((e,t)=>e|t.renderOccludedFlags),pp.yD.None)}get usedMemory(){return this._renderPlugins.reduce(((e,t)=>{var i;return null!==t.materialReference?e:e+(null!==(i=t.usedMemory)&&void 0!==i?i:0)}),0)}get test(){}}class Xb{constructor(e){this.techniques=e,this._blitConfiguration=new Ey,this._blitParameters=new Oy.C}render(e,t,i,n,r){e.bindFramebuffer(i.fbo);const s=this.techniques.acquire(Dy,this._blitConfiguration);return e.setClearColor(0,0,0,1),e.clear(st.lk.COLOR_BUFFER_BIT),null!==s&&void 0!==s&&s.compiled?(this._blitParameters.texture=t.getTexture(),e.bindTechnique(s,n,this._blitParameters),e.screen.draw(),s.release(),i):(r(dp.Xx.UPDATE),i)}}class Qb{constructor(){this._step=tw,this._dilation=1,this._firstIdleTime=(0,Ri.HA)(0)}frame(e,t){if(t?0===this._firstIdleTime&&(this._firstIdleTime=(0,Ri.HA)(performance.now())):this._firstIdleTime=(0,Ri.HA)(0),(0,d.Z)("disable-feature:high-quality-idle"))this._dilation=1;else{const e=t?performance.now()-this._firstIdleTime:0;if(e>=Jb+Kb)return this._step=(0,Ri.HA)(1/0),void(this._dilation=1);this._dilation=e>=Jb?$b:1}const i=(0,me.uZ)(e/Yb,tw,iw);this._step===1/0?this._step=(0,Ri.HA)(i):this._step=(0,Ri.HA)(this._step*ew+i*(1-ew))}get value(){return this._step}get timeDilation(){return this._dilation}clear(){this._step=this._firstIdleTime=(0,Ri.HA)(0)}}const Yb=.5,Jb=(0,Ri.HA)(12e4),Kb=(0,Ri.HA)(1e4),$b=10,ew=.9,tw=(0,Ri.HA)(1e3),iw=(0,Ri.HA)(1e3/30);var nw=i(47180);class rw{constructor(e,t){this._fbos=e,this.compositingHelper=t,this._width=4,this._height=4,this._clearColor=(0,Ye.Ue)()}dispose(){this._color=(0,p.RY)(this._color),this.releaseBuffers()}get framebuffer(){return this.color.attachDepth(this.depth),this.color.fbo}get colorTexture(){return this.color.getTexture()}get depthTexture(){return this.depth.attachment}initializeFrame(e,t,i){this._fbos.interactive=i===Ea.YE.Default;const n=this._fbos.rctx;this._width=e.fullWidth,this._height=e.fullHeight,(0,Ft.d)(this,n.parameters.maxTextureSize);const r=this._color;return this._color=null,this.releaseBuffers(),(0,Qe.c)(this._clearColor,t),r}releaseBuffers(){var e;null!==(e=this._color)&&void 0!==e&&e.detachDepth(),this._depth=(0,p.RY)(this._depth)}renderHUDVisibility(e,t,i){var n,r,s;return(null===(n=e)||void 0===n||null===(n=n.fbo)||void 0===n?void 0:n.width)===this._width&&(null===(r=e)||void 0===r||null===(r=r.fbo)||void 0===r?void 0:r.height)===this._height||(null!==(s=e)&&void 0!==s&&s.release(),e=this._fbos.acquire(this._width,this._height,"hud visibility",ut.q.RGBA4)),e.attachDepth(i||this.depth),this._fbos.rctx.bindFramebuffer(e.fbo),this._fbos.rctx.clearFramebuffer(sw),t(),e.detachDepth(),e}compositeToHUDVisibility(e,t){var i;this._fbos.rctx.bindFramebuffer(null===(i=e.hudVisibility)||void 0===i?void 0:i.fbo),this.compositingHelper.compositeHUD(e,t)}renderOITPass(e,t,i){let n,r;const{_width:s,_height:a}=this;switch(t){case Lb.A.ColorAlpha:n=this._fbos.acquire(s,a,i?"oit hud color alpha":"oit color alpha",ut.q.RGBA16F),n.acquireColor(st.VY.COLOR_ATTACHMENT1,ut.q.R16F),r=[0,0,0,1];break;case Lb.A.FrontFace:n=this._fbos.acquire(s,a,i?"oit hud front":"oit front"),r=[0,0,0,0]}return i?n.acquireDepth(ut.m.DEPTH16_BUFFER):n.attachDepth(this.depth),this._fbos.rctx.bindFramebuffer(n.fbo),this._fbos.rctx.clearFramebuffer(r,i,i),e(),n.detachDepth(),n}compositeToFramebuffer(e,t,i,n){this.bindFbo(),this.compositingHelper.composite(e,t,i,n)}compositeOIT(e,t,i,n){n?(this._fbos.rctx.bindFramebuffer(n.fbo),this._fbos.rctx.setClearColor(0,0,0,1e-13),this._fbos.rctx.clear(st.lk.COLOR_BUFFER_BIT)):this.bindFbo(),this.compositingHelper.compositeOIT(e,t.getTexture(),t.getTexture(st.VY.COLOR_ATTACHMENT1),i.getTexture())}renderDepthDetached(e){this._bindTarget(this.color),e(),this._bindTarget(this.color,this.depth)}renderToCachedFBO(e,t,i,n){var r,s,a;let o=arguments.length>4&&void 0!==arguments[4]?arguments[4]:ut.q.RGBA,l=arguments.length>5&&void 0!==arguments[5]?arguments[5]:ut.m.DEPTH16_BUFFER,h=arguments.length>6&&void 0!==arguments[6]?arguments[6]:this._width,c=arguments.length>7&&void 0!==arguments[7]?arguments[7]:this._height,d=arguments.length>8&&void 0!==arguments[8]?arguments[8]:null;return(null===(r=e)||void 0===r||null===(r=r.fbo)||void 0===r?void 0:r.width)===h&&(null===(s=e)||void 0===s||null===(s=s.fbo)||void 0===s?void 0:s.height)===c||(e=(0,p.RY)(e)),e=null!==(a=e)&&void 0!==a?a:this._fbos.acquire(h,c,t,o),null!==d&&void 0!==d&&d.forEach((t=>e.acquireColor(t.attachment,t.format))),null!=l&&e.acquireDepth(l),this._fbos.rctx.bindFramebuffer(e.fbo),this._fbos.rctx.clearFramebuffer(n,!0,!0),i(),e}renderToTargets(e,t,i,n){let r=arguments.length>4&&void 0!==arguments[4]&&arguments[4],s=arguments.length>5&&void 0!==arguments[5]&&arguments[5];this._bindTarget(t,i),this._fbos.rctx.clearFramebuffer(n,r,s),e(),t.detachDepth()}bindFbo(){const e=null==this._color;if(this._bindTarget(this.color,this.depth),e){const e=this._fbos.rctx;e.setClearStencil(0),e.setClearColor(this._clearColor[0],this._clearColor[1],this._clearColor[2],this._clearColor[3]),e.clear(st.lk.COLOR_BUFFER_BIT|st.lk.DEPTH_BUFFER_BIT|st.lk.STENCIL_BUFFER_BIT)}}_bindTarget(e,t){e.attachDepth(t),this._fbos.rctx.bindFramebuffer(e.fbo)}get width(){return this._width}get height(){return this._height}get color(){return this._ensureColor()}_ensureColor(){return this._color||(this._color=this._fbos.acquire(this._width,this._height,"composite-color")),this._color}updateColor(e){const t=this._ensureColor();t.attachDepth(this.depth),this._color=e(t)}get depth(){return this._depth||(this._depth=this._fbos.acquireDepth(ut.m.DEPTH_STENCIL_TEXTURE,this._width,this._height,"depth")),this._depth}}const sw=[0,1,0,1];var aw=i(46293);class ow{constructor(){this._inputs=new Map}set(e,t){this._inputs.set(e,t)}get(e){return this._inputs.get(e)}has(e){return this._inputs.has(e)}release(e){var t;(null===(t=this._inputs.get(e))||void 0===t?void 0:t.release())&&this._inputs.delete(e)}}var lw=i(89822),hw=i(78041);class cw extends it.A{constructor(e,t){super(e,t,(()=>this.destroy()))}initializeProgram(e){return new rt.$(e.rctx,cw.shader.get().build(this.configuration),nt.i)}initializePipeline(){return(0,at.sm)({blending:hw.wu,colorWrite:at.BK,depthTest:null,depthWrite:null})}get primitiveType(){return st.MX.TRIANGLE_STRIP}}cw.shader=new tt.J(lw.a,(()=>i.e(87075).then(i.bind(i,87075))));var dw=i(79485);const uw=1/512;let pw=class extends T.default{constructor(e,t,i,n){super({}),this._techniques=e,this._rctx=t,this._data=i,this._requestRender=n,this._passParameters=new lw.S(this._data),this._techniqueConfig=new dw.l,this._enabled=!1,this._vao=(0,_t.o)(t)}normalizeCtorArgs(){return{}}dispose(){this._stop(),this._vao=(0,p.M2)(this._vao),this._techniques.release(this._technique),this._technique=null}get _visualizeShadowCastTechnique(){return this._technique=this._techniques.releaseAndAcquire(cw,this._techniqueConfig,this._technique),this._technique}render(e){if(!this._showVisualization)return;this._passParameters.sampleScale=1/this._data.computedSamples;const t=this._visualizeShadowCastTechnique;this._rctx.bindVAO(this._vao),this._rctx.bindTechnique(t,e,this._passParameters),this._rctx.drawArrays(t.primitiveType,0,(0,ui._V)(this._vao,"geometry"))}setOptions(e){void 0!==e.enabled&&this._setEnabled(e.enabled),void 0!==e.color&&this._setColor(e.color),void 0!==e.threshold&&(this._threshold=e.threshold),void 0!==e.visualization&&(this._visualization=e.visualization),void 0!==e.bandSize&&(this._bandSize=e.bandSize),void 0!==e.bandsEnabled&&(this._bandsEnabled=e.bandsEnabled)}get opacityFromElevation(){return this._passParameters.opacityFromElevation}set opacityFromElevation(e){this._passParameters.opacityFromElevation!==e&&(this._passParameters.opacityFromElevation=e,this.notifyChange("opacityFromElevation"))}get _showVisualization(){return this._enabled&&this._data.computedSamples>0&&this.opacityFromElevation>uw}get _threshold(){return this._passParameters.threshold}set _threshold(e){this._threshold!==e&&(this._passParameters.threshold=e,this._requestRenderIfRunning())}get _visualization(){return this._techniqueConfig.visualization}set _visualization(e){e!==this._visualization&&(this._techniqueConfig.visualization=e,this._techniques.release(this._technique),this._technique=null,this._requestRenderIfRunning())}get _bandSize(){return this._passParameters.bandSize}set _bandSize(e){e!==this._bandSize&&(this._passParameters.bandSize=e,this._requestRenderIfRunning())}get _bandsEnabled(){return this._techniqueConfig.bandsEnabled}set _bandsEnabled(e){e!==this._bandsEnabled&&(this._techniqueConfig.bandsEnabled=e,this._techniques.release(this._technique),this._technique=null,this._requestRenderIfRunning())}_setColor(e){const t=this._passParameters.color;(0,Qe.a)(e,t)||((0,Qe.c)(this._passParameters.color,e),this._requestRenderIfRunning())}_setEnabled(e){e!==this._enabled&&(e?this._start():this._stop())}_requestRenderIfRunning(){this._enabled&&this._requestRender()}_start(){this._enabled=!0,this._requestRender()}_stop(){this._enabled=!1,this._requestRender()}};(0,n._)([(0,b.Cb)()],pw.prototype,"opacityFromElevation",null),pw=(0,n._)([(0,C.j)("esri.views.3d.webgl-engine.lib.ShadowCastRenderer")],pw);var _w=i(471),mw=i(13378);class gw extends it.A{constructor(e){super(e,new ly,(()=>this.destroy()))}initializeProgram(e){return new rt.$(e.rctx,gw.shader.get().build(this.configuration),nt.i)}initializePipeline(){return(0,at.sm)({blending:(0,at.wK)(st.zi.ONE,st.zi.ONE,st.zi.ONE,st.zi.ONE),colorWrite:at.BK,depthTest:null,depthWrite:null})}get primitiveType(){return st.MX.TRIANGLE_STRIP}}gw.shader=new tt.J(mw.a,(()=>i.e(85383).then(i.bind(i,85383))));let fw=class extends T.default{constructor(e,t,i,n,r,s){super({}),this.fbos=e,this._stage=i,this._prepareForShadowMapPass=n,this._renderToShadowMap=r,this._requestRender=s,this._progress=0,this._sampleCount=0,this._passParameters=new oy.nj,this._cachedLightDirections=[],this._depthRange=mv,this._previewing=!1,this._cameraForcedForScreenshot=!1,this._shadowAccumulatorKey="shadowAccumulator",this._rctx=e.rctx,this._bindParameters=new zt.p(new _w.l(e,i.viewingMode),null),this._bindParameters.shadowMap.enabled=!0,this._vao=(0,_t.o)(this._rctx),this._accumulationRenderer=new pw(t,this._rctx,this,s);const a=this._stage.view.resourceController.scheduler;this.addHandles([a.registerTask(Bt.T8.SHADOW_ACCUMULATOR,this),(0,g.watch)((()=>i.renderView),(e=>{this.removeHandles(yw),null!=e&&this.addHandles(e.events.on("force-camera-for-screenshot",(()=>this._cameraForcedForScreenshot=!0)),yw)}),g.syncAndInitial),(0,g.watch)((()=>this._previewing),(()=>this._requestRenderIfEnabled()),g.sync)],this._shadowAccumulatorKey)}normalizeCtorArgs(){return{}}dispose(){this._disable(),this.removeHandles(this._shadowAccumulatorKey),this._accumulationRenderer=(0,p.M2)(this._accumulationRenderer),this._bindParameters.shadowMap.dispose(),this._fbo=(0,p.M2)(this._fbo),this._vao=(0,p.M2)(this._vao),this._accumulationTechniqueCached=(0,p.RY)(this._accumulationTechniqueCached),this._cachedLightDirections.length=0,this._sampleCount=0}get computedSamples(){return this._progress}get shadowCastTexture(){var e;return null===(e=this._fbo)||void 0===e?void 0:e.colorTexture}get isAccumulating(){return this._isPreviewing||this._isRefining}get _accumulationTechnique(){if(null==this._accumulationTechniqueCached){const e={rctx:this._rctx,viewingMode:this._stage.viewingMode};this._accumulationTechniqueCached=new gw(e)}return this._accumulationTechniqueCached}get _isRefining(){return this._isActive&&!this._isDoneAccumulating&&!this._previewing}get _isPreviewing(){return this._isActive&&this._previewing}get _isActive(){return null!=this._fbo&&this._sampleCount>0}get canAccumulate(){return null!=this._bindParameters.depth&&this._depthRange!==mv&&this._opacityFromElevation>uw}get _isDoneAccumulating(){return this._progress>=this._sampleCount}get _lightDirections(){return this._cachedLightDirections}set _lightDirections(e){const t=this._cachedLightDirections;if((0,Ld.fS)(t,e,Ge.G))return;const i=Math.min(mw.S,e.length);t.length=i,this._sampleCount=i;for(let r=0;r<i;++r){var n;t[r]=(0,Ge.c)(null!==(n=t[r])&&void 0!==n?n:(0,R.Ue)(),e[r])}this._invalidate()}get _opacityFromElevation(){return this._accumulationRenderer.opacityFromElevation}set _opacityFromElevation(e){this._accumulationRenderer.opacityFromElevation=e}get running(){return this._isRefining&&this.canAccumulate&&this._progress>0}runTask(e){for(this._prepareForShadowMapPass(this._bindParameters);!e.done&&!this._isDoneAccumulating;)this._accumulateShadow(),e.madeProgress();this._requestRender()}renderAccumulation(e,t,i,n){if(this._depthRange=t,this._updateCamera(i),this._bindParameters.contentCamera=n,this._bindParameters.depth=e,this._passParameters.origin=this._bindParameters.camera.center,this.notifyChange("canAccumulate"),!this.isAccumulating||!this.canAccumulate)return!1;(this._previewing||0===this._progress||this._cameraForcedForScreenshot)&&this._clear();const r=this._cameraForcedForScreenshot?this._sampleCount:Math.min(vw,this._sampleCount-this._progress);for(let s=0;s<r;++s)this._accumulateShadow();return this._cameraForcedForScreenshot=!1,this._requestRender(),r>0}render(e){this._accumulationRenderer.render(e)}setOptions(e){if(void 0!==e.enabled){const t=null!=this._fbo;e.enabled!==t&&(e.enabled?this._enable():this._disable())}void 0!==e.previewing&&(this._previewing=e.previewing),void 0!==e.lightDirections&&(this._lightDirections=e.lightDirections),this._accumulationRenderer.setOptions(e)}readAccumulatedShadow(e,t){return!this._isActive||!this._fbo||this._progress<1||e<0||e>=this._fbo.width||t<0||t>=this._fbo.height?0:(this._fbo.readPixels(e,t,1,1,st.VI.RGBA,st.Br.UNSIGNED_BYTE,bw),bw[0]/this._progress)}_enable(){this._progress=0;const e=new Vt.X;e.pixelFormat=st.VI.RED,e.internalFormat=st.lP.R8,e.wrapMode=st.e8.CLAMP_TO_EDGE,this._fbo=new Ft.X(this._rctx,e),this._requestRender()}_disable(){this._fbo=(0,p.M2)(this._fbo),this._requestRender()}_invalidate(){this._progress=0,this._requestRenderIfEnabled()}_clear(){this._rctx.bindFramebuffer(this._fbo),this._rctx.setClearColor(0,0,0,0),this._rctx.clear(st.lk.COLOR_BUFFER_BIT),this._progress=0}_accumulateShadow(){this._renderToShadowMap(this._bindParameters,this._lightDirections[this._progress++],this._depthRange);const e=this._accumulationTechnique;this._rctx.bindFramebuffer(this._fbo),this._rctx.bindTechnique(e,this._bindParameters,this._passParameters),this._rctx.bindVAO(this._vao),this._rctx.drawArrays(e.primitiveType,0,(0,ui._V)(this._vao,"geometry"))}_updateCamera(e){const t=this._fbo;if(null==t)return;const i=this._bindParameters.camera;e.equals(i)||i.copyFrom(e),t.resize(e.fullWidth,e.fullHeight),this._opacityFromElevation=1-(0,me.CW)(4e4,5e4,e.relativeElevation)}_requestRenderIfEnabled(){this._fbo&&this._requestRender()}get test(){}};(0,n._)([(0,b.Cb)()],fw.prototype,"_progress",void 0),(0,n._)([(0,b.Cb)()],fw.prototype,"_sampleCount",void 0),(0,n._)([(0,b.Cb)()],fw.prototype,"_fbo",void 0),(0,n._)([(0,b.Cb)()],fw.prototype,"_depthRange",void 0),(0,n._)([(0,b.Cb)()],fw.prototype,"_previewing",void 0),(0,n._)([(0,b.Cb)()],fw.prototype,"_accumulationRenderer",void 0),(0,n._)([(0,b.Cb)()],fw.prototype,"_isRefining",null),(0,n._)([(0,b.Cb)()],fw.prototype,"_isActive",null),(0,n._)([(0,b.Cb)()],fw.prototype,"canAccumulate",null),(0,n._)([(0,b.Cb)()],fw.prototype,"_isDoneAccumulating",null),(0,n._)([(0,b.Cb)()],fw.prototype,"_opacityFromElevation",null),(0,n._)([(0,b.Cb)()],fw.prototype,"running",null),fw=(0,n._)([(0,C.j)("esri.views.3d.webgl-engine.lib.ShadowAccumulator")],fw);const vw=6,yw="renderView",bw=new Uint8Array(4),ww=(0,N.a)();class Cw{constructor(){this._plane=(0,N.a)()}get isEnabled(){return!(0,N.d)(this.plane,ww)}get plane(){return this._plane}set plane(e){(0,N.c)(e||ww,this._plane)}}var xw,Tw=i(58206),Sw=i(77958),Pw=i(41139),Mw=i(90941),Rw=i(40235);class Aw{constructor(e,t){this._timer=e,this._queryPool=new Array,this._queryResults=new Map,this._currentQuery=null,t.forEach((e=>{const t=this._timer.createQuery(),i=this._timer.createQuery();this._queryPool.push(t,i),this._queryResults.set(e,null)}))}start(){Rw.P9||(this._currentQuery=this._queryPool.pop(),null!=this._currentQuery&&(this._timer.disjoint(),this._timer.beginTimeElapsed(this._currentQuery)))}stop(e){if(this._timer.disjoint()||null==this._currentQuery||!this._queryResults.has(e))return this.abort(),null;this._timer.endTimeElapsed();const t=this._queryResults.get(e);if(null==t)return this._queryResults.set(e,this._currentQuery),this._currentQuery=null,null;if(!this._timer.resultAvailable(t))return this._queryPool.unshift(this._currentQuery),this._currentQuery=null,null;const i=this._timer.getResult(t)/1e6;return this._queryPool.unshift(t),this._queryResults.set(e,this._currentQuery),this._currentQuery=null,i}abort(){null!=this._currentQuery&&(this._timer.deleteQuery(this._currentQuery),this._queryPool.unshift(this._timer.createQuery()),this._currentQuery=null)}dispose(){null!=this._currentQuery&&this._timer.deleteQuery(this._currentQuery),this._queryPool.forEach((e=>{this._timer.deleteQuery(e)})),this._queryResults.forEach((e=>{null!=e&&this._timer.deleteQuery(e)}))}}!function(e){e.OVERLAY="overlay",e.PREPARE="prepare",e.SHADOW_MAP="shadow map",e.DEPTH="depth",e.ACCUMULATED_SHADOWS="accumulated shadows",e.OBJECT_AND_LAYER_ID_COLOR="object/layer id color",e.NORMALS="normals",e.SSAO="SSAO",e.OPAQUE_EDGES="opaque edges",e.VOXEL="voxel",e.TRANSPARENT="transparent",e.TRANSPARENT_EDGES="transparent edges",e.HUD_VISIBILITY="HUD visibility",e.TRANSPARENT_TERRAIN="transparent terrain",e.OPAQUE_ENVIRONMENT="opaque environment",e.TRANSPARENT_ENVIRONMENT="transparent environment",e.LASER_LINES="laser lines",e.VIEWSHED="viewshed",e.OCCLUDED="occluded",e.HUD="HUD",e.HUD_OCCLUDED="HUD occluded",e.FINISH="finish"}(xw||(xw={}));const Ow=Object.values(lb).concat(Object.values(hb)).concat(Object.values(xw)),Ew="Total";class Dw{constructor(e){this._rctx=e,this._startTimeStampCPU=(0,Ri.HA)(0),this._lastTimeStampCPU=(0,Ri.HA)(0),this._totalCPUTime=new Mw.Z(Ew),this._cpuTimeSamplers=new Map(Ow.map((e=>[e,new Mw.Z(e)]))),this._enableGPUTimer=0,this._totalGPUTime=new Mw.Z("GPU"),this._gpuTimeSamplers=new Map(Ow.map((e=>[e,new Mw.Z(e)]))),this._totalTime=(0,Ri.HA)(0),this._totalFrameCount=0}get totalCPUTimeSampler(){return this._totalCPUTime}get cpuTimeSamplers(){return Array.from(this._cpuTimeSamplers.values())}get totalGPUTimeSampler(){return this._totalGPUTime}get gpuTimeSamplers(){return Array.from(this._gpuTimeSamplers.values())}get gpuSamplingEnabled(){return null!=this._gpuTimerPool}get totalTime(){return this._totalTime}get totalFrameCount(){return this._totalFrameCount}get elapsedTime(){return(0,Ri.HA)(performance.now()-this._startTimeStampCPU)}enableGPUPerformanceInfo(){if(null==this._gpuTimerPool){const e=[...Ow,Ew];this._gpuTimerPool=function(e,t){const i=e.capabilities.disjointTimerQuery;return null==i?null:new Aw(i,t)}(this._rctx,e)}if(null==this._gpuTimerPool)return{hasGPUTimerSupport:!1,remove:()=>{}};++this._enableGPUTimer;let e=!1;return{hasGPUTimerSupport:!0,remove:()=>{e||(e=!0,--this._enableGPUTimer,0===this._enableGPUTimer&&(this._gpuTimerPool=(0,p.M2)(this._gpuTimerPool)))}}}startFrame(){this._startTimeStampCPU=this._lastTimeStampCPU=(0,Ri.HA)(performance.now()),this._gpuTimerPool&&this._gpuTimerPool.start()}advance(e){const t=(0,Ri.HA)(performance.now());if(this._cpuTimeSamplers.get(e).record(t-this._lastTimeStampCPU),this._lastTimeStampCPU=t,this._gpuTimerPool){const t=this._gpuTimerPool.stop(e);this._gpuTimeSamplers.get(e).record(t),this._gpuTimerPool.start()}}finishFrame(){if(this._gpuTimerPool){const e=this._gpuTimerPool.stop(xw.FINISH);this._gpuTimeSamplers.get(xw.FINISH).record(e),this._rctx.gl.flush()}const e=(0,Ri.HA)(performance.now()-this._startTimeStampCPU);this._totalTime=(0,Ri.HA)(this._totalTime+e),this._totalCPUTime.record(e),this._gpuTimerPool&&this._totalGPUTime.record(this.gpuTimeSamplers.reduce(((e,t)=>e+(t.last||0)),0)),++this._totalFrameCount}}class Iw{constructor(e,t,i,n,r,s){this._stage=e,this._techniques=i,this._rctx=n,this._compositingHelper=r,this._requestRender=s,this._pluginsHas={hudElements:!1,water:!1},this._hasOverlayWater=!1,this.renderOverlay=e=>{},this._isRendering=!1,this._inGlobeView=!1,this._backgroundColor=(0,Ye.al)(0,0,0,1),this._sliceHelper=new Cw,this._blit=null,this._state=(0,Od.t)(Ia.n.IDLE),this._highQualityTransparencyEnabled=!0,this._terrainTransparency=Gg.Opaque,this._ssrEnabled=!1,this._hasAnimations=!1,this._animationTimestep=new Qb,this._loadEdgeViewTask=null,this._edgeViewCallbacks=[],this._reprojectionMatrixVersion=(0,Od.t)(0),this._renderHiddenTransparentEdges=()=>{},this._pluginInput=new ow,this._releaseNormals=e=>{e.some((e=>{let{name:t}=e;return"normals"===t}))&&this._pluginInput.release("normals")},this._debugNeedsDepth=!1,this.fboCache=new yb(n),this._renderStateFeatures=(0,Od.t)((0,Da.n)(!(0,d.Z)("disable-feature:high-quality-idle"),e.view.qualityProfile)),this._offscreen=new rw(this.fboCache,this._compositingHelper),this.performanceInfo=new Dw(this._rctx),this._shadowMap=new _w.l(this.fboCache,e.viewingMode),this._viewshed=new Tw.U({fboCache:this.fboCache,view:e.view},((e,t,i)=>{t.setGLViewport(this._rctx);const{camera:n,contentCamera:r}=e;this._ensureBindParametersCamera(t,t),this._renderAllGeometry(i),this._ensureBindParametersCamera(n,r),e.camera.setGLViewport(this._rctx)})),this._shadowAccumulator=new fw(this.fboCache,i,e,(e=>{const t=this.shadowsEnabled;this._shadowMap.enabled=!0,this._ensureBindParametersCamera(e.camera,e.contentCamera),this._plugins.prepareRender(),this._shadowMap.enabled=t}),((e,t,i)=>{const n=this._stage.view.qualitySettings.maximumPixelRatio;e.shadowMap.start(e.camera,t,i,!0,n),this._renderShadowCascades(l_.H_.Shadow,e.shadowMap),e.shadowMap.finish(),e.camera.setGLViewport(this._rctx),this._ensureBindParametersCamera(e.camera,e.contentCamera)}),s),this._renderContext=new aw.V1(this._rctx,this._offscreen,this._shadowMap,this._sliceHelper),this._nodes=new jb(this._renderContext),this._plugins=new Wb({renderContext:this._renderContext,techniques:i,materials:t,requestRender:s,controller:e,fbos:this.fboCache,isFeatureEnabled:e=>this.isFeatureEnabled(e)}),this.renderPassManager=new Fb,this._plugins.add(this.renderPassManager),this._plugins.add(this._viewshed),this._handles=[(0,g.watch)((()=>this._stage.view.state.camera),(()=>s()),g.syncAndInitial),(0,g.watch)((()=>_l.h.EDGES_SHOW_HIDDEN_TRANSPARENT_EDGES),(e=>{this._renderHiddenTransparentEdges=e?()=>this._renderEdges(Sw.i.TRANSPARENT):()=>{},s()}),g.initial),(0,g.watch)((()=>{var e;return null===(e=this._stage.view.environment.background)||void 0===e?void 0:e.color}),(e=>{const t=e?(0,je.O)(e):Ye.AG;(0,Qe.s)(this._backgroundColor,t[0]*t[3],t[1]*t[3],t[2]*t[3],t[3]),s()}),g.syncAndInitial),(0,g.watch)((()=>this._stage.view.state.camera.relativeElevation),(e=>{this._inGlobeView=(null!==e&&void 0!==e?e:1/0)>=Gb.o}),g.syncAndInitial)]}destroy(){this._handles.forEach((e=>e.remove())),this._gpuTimerHandle=(0,p.hw)(this._gpuTimerHandle),this._nodes.destroy(),this._offscreen.dispose(),this._shadowMap.dispose(),this._shadowAccumulator.dispose(),this._loadEdgeViewTask=(0,p.IM)(this._loadEdgeViewTask),this._edgeView=(0,p.SC)(this._edgeView),this.renderPassManager.dispose(),this._releaseFBOs(),this._disposeOffscreenBuffers(),this.fboCache.destroy(),this._plugins.destroy(),nw.j.prune()}get _bindParameters(){return this._renderContext.bindParameters}updateRenderFeatures(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null,t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:!(0,d.Z)("disable-feature:high-quality-idle");this._renderStateFeatures.value=(0,Da.n)(t,e),this._plugins.renderFeatureChanged(),this._requestRender()}isFeatureEnabled(e){var t;let i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:this._state.value;return null!==(t=this._renderStateFeatures.value.get(i,e))&&void 0!==t&&t}setFeatureEnabled(e,t,i){this._renderStateFeatures.mutate((n=>n.set(t,e,i))),this._requestRender()}get _highQualityTransparency(){return this._highQualityTransparencyEnabled||this.isFeatureEnabled(Da.Y.HighQualityTransparency)}get hasReflections(){return(this._pluginsHas.water||this._hasOverlayWater)&&(this._ssrEnabled||this.isFeatureEnabled(Da.Y.WaterReflection))}get hasDecorations(){return this._plugins.hasDecorations||this._nodes.produces("magnifier-color")}get hasHighlights(){return this._plugins.produces(l_.H_.Highlight,en.r.OPAQUE_MATERIAL,en.r.TRANSPARENT_MATERIAL,en.r.DRAPED_MATERIAL)}get hasLaserlines(){return this._plugins.produces(this._renderContext.output,en.r.LASERLINES,en.r.LASERLINES_CONTRAST_CONTROL)}get hasSSAO(){return(this._stage.view.qualitySettings.ambientOcclusion||this.isFeatureEnabled(Da.Y.SSAO))&&!this._inGlobeView}get hasSMAA(){return this._stage.view.qualitySettings.antialiasingEnabled||this.isFeatureEnabled(Da.Y.Antialiasing)}get fullResolutionAtmosphere(){return this._stage.view.qualitySettings.highResolutionAtmosphere||this.isFeatureEnabled(Da.Y.HighResolutionAtmosphere)}_releaseFBOs(){this._bindParameters.ssr.lastFrameColor=(0,p.RY)(this._bindParameters.ssr.lastFrameColor),this._bindParameters.multipassTerrain.depth=(0,p.RY)(this._bindParameters.multipassTerrain.depth),this._bindParameters.multipassGeometry.depth=(0,p.RY)(this._bindParameters.multipassGeometry.depth)}_disposeOffscreenBuffers(){this._offscreen.dispose(),this._disposeBindBuffers()}_disposeBindBuffers(){this._shadowMap.disposeOffscreenBuffers(),this._viewshed.viewshedShadowMap.disposeOffscreenBuffers(),this._bindParameters.depth=(0,p.RY)(this._bindParameters.depth),this._bindParameters.hudVisibility=(0,p.RY)(this._bindParameters.hudVisibility)}get updating(){return null!=this._edgeView&&this._edgeView.updating||this._shadowAccumulator.running||this._plugins.updating||!this.isCameraFinal}loadEdgeView(){return this._loadEdgeViewTask||(this._loadEdgeViewTask=(0,oe.vr)((async e=>{const{EdgeView:t}=await i.e(2731).then(i.bind(i,2731));(0,m.k_)(e);const n=this._edgeView=new t({rctx:this._rctx,renderSR:this._stage.view.renderSpatialReference,viewingMode:this._stage.viewingMode,techniques:this._techniques,setNeedsRender:()=>this._requestRender(),schedule:Gw(this._stage.view.resourceController)});return this._handles.push((0,g.watch)((()=>n.updating),(()=>this._requestRender()),g.sync)),this._requestRender(),this._edgeViewCallbacks.forEach((e=>e(n))),this._edgeViewCallbacks.length=0,n}))),this._loadEdgeViewTask.promise}withEdgeView(e){this.loadEdgeView(),null==this._edgeView?this._edgeViewCallbacks.push(e):e(this._edgeView)}get edgeView(){return this._edgeView}get isCameraFinal(){return this._reprojectionMatrixVersion.value>=0&&(0,Pt.fS)(this._bindParameters.ssr.reprojectionMatrix,Mt.Wd)}set _reprojectionMatrix(e){(0,Ld.Vx)(this._bindParameters.ssr.reprojectionMatrix,e)&&this._reprojectionMatrixVersion.value++}get shadowsEnabled(){var e;return!(null===(e=this._shadowMap)||void 0===e||!e.enabled)}setParameters(e){var t;const{_shadowMap:i,_bindParameters:n}=this;if(void 0!==(null===(t=e.qualitySettings)||void 0===t?void 0:t.reflections)&&this._ssrEnabled!==e.qualitySettings.reflections&&(this._ssrEnabled=e.qualitySettings.reflections,this._requestRender()),void 0!==e.shadowMap&&this._shadowMap.enabled!==e.shadowMap&&(this._shadowMap.enabled=e.shadowMap,this._requestRender()),void 0!==e.shadowMapMaxCascades&&i.maxCascades!==e.shadowMapMaxCascades&&(i.maxCascades=e.shadowMapMaxCascades,this._requestRender()),null!=e.environment){null!=e.environment.weather&&(this._bindParameters.weather=e.environment.weather,this._bindParameters.weatherVisible=!!e.weatherVisible);const t="virtual"!==e.environment.lighting.type;n.enableFillLights!==t&&(n.enableFillLights=t,this._requestRender())}void 0!==e.highQualityTransparency&&this._highQualityTransparencyEnabled!==e.highQualityTransparency&&(this._highQualityTransparencyEnabled=e.highQualityTransparency,this._requestRender()),void 0!==e.hasOverlayWater&&this._hasOverlayWater!==e.hasOverlayWater&&(this._hasOverlayWater=e.hasOverlayWater,this._requestRender()),void 0!==e.slicePlane&&this._sliceHelper.plane!==e.slicePlane&&(this._sliceHelper.plane=e.slicePlane,this._requestRender()),void 0!==e.terrainTransparency&&this._terrainTransparency!==e.terrainTransparency&&(this._terrainTransparency=e.terrainTransparency,this._requestRender()),void 0!==e.shadowCast&&this._shadowAccumulator.setOptions(e.shadowCast)}get hasSlicePlane(){return!!this._sliceHelper.plane}get plugins(){return this._plugins}get _hasOITSupport(){return this._rctx.driverTest.floatBufferBlend.result}get _oitEnabled(){return this._highQualityTransparency&&this._hasOITSupport}modify(e,t){this._isRendering&&console.warn("Renderer.modify called while rendering");const{adds:i,removes:n,updates:r}=e;if(0===i.length&&0===n.length&&0===r.length)return;const s=(0,Ea.q9)(e);let a=!1;s.forEach(((i,n)=>{if(t.done)return;let r=this._plugins.getMaterialRenderer(n);if(null==r&&i.adds.length>0){const e=new Pw.A({material:n});e.initializeRenderContext(this._plugins._context),r=e,this._plugins.add(r)}r&&(r.modify(i),0===r.numGeometries&&(a=!0)),i.removes.forEach((t=>e.removes.removeUnordered(t))),i.adds.forEach((t=>e.adds.removeUnordered(t))),i.updates.forEach((t=>e.updates.removeUnordered(t))),t.madeProgress()})),a&&this._plugins.removeEmptyMaterialRenderers(),this._updateHasFlags(),this._requestRender()}_updateHasFlags(){const e=this._pluginsHas;e.hudElements=this._plugins.produces(l_.H_.Color,en.r.LINE_CALLOUTS_HUD_DEPTH,en.r.HUD_MATERIAL,en.r.LABEL_MATERIAL),e.water=this._plugins.produces(l_.H_.Normal,en.r.DRAPED_WATER),this._bindParameters.hasOccludees=this._plugins.hasOccludees}updateAnimation(e){const t=this._hasAnimations;return this._hasAnimations=this._plugins.updateAnimation(e),this._hasAnimations=this._nodes.updateAnimation()||this._hasAnimations,this._hasAnimations!==t&&(this._gpuTimerHandle=t?(0,p.hw)(this._gpuTimerHandle):this.performanceInfo.enableGPUPerformanceInfo()),this._hasAnimations}get animationTimestep(){return this._animationTimestep.value}get animationTimeDilation(){return this._animationTimestep.timeDilation}resetAnimation(){this._animationTimestep.clear()}tick(){this.fboCache.clean()}render(e,t){var i,n,r,s;let a=arguments.length>2&&void 0!==arguments[2]?arguments[2]:Ea.YE.Default,o=arguments.length>3&&void 0!==arguments[3]?arguments[3]:dp.Iq.ON;this._isRendering=!0,this.performanceInfo.startFrame(),this.fboCache.frameStart(),this._disposeBindBuffers();const l=this._offscreen,{camera:h,contentCamera:c,mode:d,alignPixelEnabled:u}=e;this._state.value=d,this._bindParameters.overlay=this.renderOverlay(t),this._bindParameters.overlay&&this.performanceInfo.advance(xw.OVERLAY),this._renderContext.time=t,this._bindParameters.transparencyPassType=Lb.A.NONE,this._bindParameters.alignPixelEnabled=u,this._bindParameters.decorations=o,this._bindParameters.mainColor=this._bindParameters.mainDepth=null,this._bindParameters.viewshedEnabled=this._viewshed.enabled;const _=this._nodes.produces("magnifier-color"),m=this._nodes.produces("final-color"),g=(0,N.a)(this._sliceHelper.plane);o===dp.Iq.OFF&&(this._sliceHelper.plane=null),h.setGLViewport(this._rctx);const f=l.initializeFrame(h,this._backgroundColor,a);this.hasReflections?this._bindParameters.ssr.lastFrameColor=f:null===f||void 0===f||f.release(),this._ensureBindParametersCamera(h,c),this._plugins.prepareRender(),this._bindParameters.shadowHighlightsVisible=this._needsShadowHighlight&&o===dp.Iq.ON;const v=this._plugins.produces(l_.H_.Color,en.r.OPAQUE_TERRAIN)&&(this._terrainTransparency===Gg.Semitransparent||this._terrainTransparency===Gg.TransparentWithDraped),y=this._highQualityTransparency&&v,b=this._plugins.produces(l_.H_.Color,...Fw);this._prepareShaders(y,b),this.performanceInfo.advance(xw.PREPARE);const w=this._computeDepthRange(h);this._renderShadowMap(h,this._bindParameters.lighting.mainLight.direction,w),this._ensureBindParametersCamera(h,c);let C=this._renderNormals();if(this._pluginInput.set("normals",C),C){var x;let e=null;this._needsDepth&&(e=C.getAttachment(st.Lu),null!==(x=e)&&void 0!==x&&x.retain()),this._pluginInput.set("ssao",this._renderSSAO()),this._renderNoSSAOGeometryDepth(e),C=null}else this._renderAllGeometryDepth();this._renderShadowAccumulation(w,h,c),this._ensureBindParametersSSR(t),this._renderContext.output=l_.H_.Color,l.bindFbo(),this._bindParameters.mainColor=l.colorTexture,this._bindParameters.mainDepth=l.depthTexture;const T=this.plugins.produces(l_.H_.Color,...Hw);T&&this._renderOpaqueGeometry(),this._offscreen.updateColor((e=>this._renderNodes(lb.OPAQUE,e,T))),null!==(i=(n=this.fboCache).debugCallback)&&void 0!==i&&i.call(n,"opaque-color",this._offscreen.color.fbo),this._renderPlugins(en.r.OPAQUE_ENVIRONMENT,xw.OPAQUE_ENVIRONMENT),this._renderMultipassTerrainDepth(y),this._setMultipassTerrain(y),this._renderEdges(Sw.i.OPAQUE),l.bindFbo(),this._renderPlugins(en.r.VOXEL,xw.VOXEL),this._renderHiddenTransparentEdges(),b&&(this._oitEnabled?this._renderOITPass(Lw.Geometry):this._renderTransparentMaterial()),this._offscreen.updateColor((e=>this._renderNodes(lb.TRANSPARENT,e,b))),null!==(r=(s=this.fboCache).debugCallback)&&void 0!==r&&r.call(s,"transparent-color",this._offscreen.color.fbo),this._renderMultipassGeometryDepth(y),this._renderHUDVisibility(),y||this._plugins.render(this._pluginInput,en.r.LINE_CALLOUTS);const S=a===Ea.YE.ObjectAndLayerID?this._renderObjectAndLayerIdColor():null;this._renderEdges(Sw.i.TRANSPARENT);const P=v?this._renderTransparentTerrain():null;P&&(this.performanceInfo.advance(xw.TRANSPARENT_TERRAIN),this._bindParameters.hudVisibility&&(y?this._renderLineCallouts(Bb.U.Occluded):l.compositeToHUDVisibility(this._bindParameters,P.getTexture()),this._renderHUD(Bb.U.Occluded,l.color))),this._setTerrainCulling(!1),P&&(l.compositeToFramebuffer(this._bindParameters,P.getTexture(),Ry.PremultipliedAlpha,1),P.release(),y&&(this._renderEdges(Sw.i.OPAQUE),b&&(this._oitEnabled?this._renderOITPass(Lw.Geometry):this._renderTransparentMaterial(),this.performanceInfo.advance(xw.TRANSPARENT)),this._renderEdges(Sw.i.TRANSPARENT))),this._bindParameters.ssao=(0,p.RY)(this._bindParameters.ssao),y&&this._renderLineCallouts(Bb.U.NotOccluded),this._setMultipassEnabled(!1),this._renderTransparentEnvironment(),this._renderViewshed(),this._renderLaserlines(),this._renderOccluded(),this._pluginInput.set("highlights",this._renderHighlightPrepass()),this._offscreen.updateColor((e=>this._renderNodes(lb.COMPOSITE,e)));const M=this._nodes.produces("aa-color"),R=!(a!==Ea.YE.Default||m||_&&o===dp.Iq.ON&&a===Ea.YE.Default),A=this._pluginInput.get("composite-color"),O=R?bb:this.fboCache.acquire(A.fbo.width,A.fbo.height,"aa-color"),E=M?this._renderNodes(hb.ANTIALIASING,O):this._blitToDefault(A,O,!1);this._pluginInput.set(hb.ANTIALIASING,E),this._renderHUD(Bb.U.NotOccluded,E);const D=this._renderNodes(hb.HIGHLIGHTS,E);let I=this._renderNodes(hb.MAGNIFIER,D);return _&&o===dp.Iq.ON&&a===Ea.YE.Default&&!m&&(I=this._blitToDefault(I)),m?(I.attachDepth(l.depth),this._blitToDefault(this._renderNodes(lb.FINAL,I)),I.detachDepth()):this._pluginInput.set(lb.FINAL,I),this._pluginInput.release("highlights"),this.onPostRender&&this.onPostRender(),this._releaseFBOs(),this._offscreen.releaseBuffers(),this._renderContext.lastFrameCamera.copyFrom(this._bindParameters.camera),this._sliceHelper.plane=g,this._isRendering=!1,this.fboCache.frameEnd(),this.performanceInfo.finishFrame(),a!==Ea.YE.Default&&(this._releaseFBOs(),this._disposeOffscreenBuffers()),{screen:this._pluginInput.get("final-color"),oid:S}}_prepareShaders(e,t){this._renderContext.output=l_.H_.Color,this._prepareOpaqueGeometry(),this._setMultipassTerrain(e),this._plugins.prepare(en.r.TRANSPARENT_TERRAIN),this._setMultipassTerrain(!1),e||this._plugins.prepare(en.r.LINE_CALLOUTS),t&&this._prepareTransparencySlots(),this._plugins.prepare(en.r.VIEWSHED,en.r.TRANSPARENT_DEPTH_WRITE_DISABLED_MATERIAL,en.r.TRANSPARENT_ENVIRONMENT,en.r.LASERLINES),this._rctx.gl.flush()}_renderObjectAndLayerIdColor(){if(!(0,d.Z)("enable-feature:objectAndLayerId-rendering"))return;const e=this._renderContext.output,t=this.fboCache.acquire(this._offscreen.width,this._offscreen.height,"oid");return t.acquireDepth(ut.m.DEPTH_STENCIL_TEXTURE),this._rctx.bindFramebuffer(t.fbo),this.fboCache.rctx.clearFramebuffer([0,0,0,0],!0,!0),this._renderAllGeometry(l_.H_.ObjectAndLayerIdColor),this._rctx.bindFramebuffer(t.fbo),this.fboCache.rctx.clearFramebuffer(void 0,!0,!0),this._bindParameters.hudRenderStyle=Bb.U.NotOccluded,this._plugins.render(this._pluginInput,en.r.HUD_MATERIAL),this._renderContext.output=e,this.performanceInfo.advance(xw.OBJECT_AND_LAYER_ID_COLOR),t}finish(e){this._hasAnimations||this._animationTimestep.clear();const t=this.performanceInfo.gpuSamplingEnabled,i=e===dp.Xx.BACKGROUND;if(i||t){const e=i?this.performanceInfo.elapsedTime:0,n=t?this.performanceInfo.totalGPUTimeSampler.last:this._rctx.gl.getError(),r=Math.max(e,n);this._animationTimestep.frame(r,i)}}readDepthPixels(e,t){var i;if(!this._bindParameters.mainDepth)return;const{width:n,height:r}=this._offscreen,s=this.fboCache.acquire(n,r,"linear-depth");this._rctx.bindFramebuffer(s.fbo),this._bindParameters.camera.setGLViewport(this._rctx),this._rctx.clearFramebuffer([0,0,0,0],!0,!0),this._compositingHelper.blitDepthToLinearDepth(this._bindParameters,this._bindParameters.mainDepth),null!==(i=s.fbo)&&void 0!==i&&i.readPixels(e[0],e[1],e[2],e[3],st.VI.RGBA,st.Br.UNSIGNED_BYTE,t),s.release()}readHUDVisibility(e,t,i,n,r){var s;null===(s=this._bindParameters.hudVisibility)||void 0===s||null===(s=s.fbo)||void 0===s||s.readPixels(e,t,i,n,st.VI.RGBA,st.Br.UNSIGNED_BYTE,r)}readAccumulatedShadow(e){return this._shadowAccumulator.readAccumulatedShadow(e[0],e[1])}_setMultipassTerrain(e){this._setMultipassEnabled(e),this._setTerrainCulling(e)}_setMultipassEnabled(e){this._bindParameters.multipassEnabled=e}_setTerrainCulling(e){this._bindParameters.multipassTerrain.cullAboveGround=e}_renderEdges(e){const t=this._edgeView;if(null===t||void 0===t||!t.shouldRender())return;const{width:i,height:n,depth:r}=this._offscreen,s=this.fboCache.acquire(i,n,"edges"),a=this._bindParameters.multipassGeometry.depth;this._offscreen.renderToTargets((()=>t.render(this._bindParameters,e)),s,null!==a&&void 0!==a?a:r,Uw),this._offscreen.compositeToFramebuffer(this._bindParameters,s.getTexture(),Ry.Alpha,1),s.release(),this.performanceInfo.advance(e===Sw.i.OPAQUE?xw.OPAQUE_EDGES:xw.TRANSPARENT_EDGES)}_renderShadowMap(e,t,i){const n=this._shadowMap;n.enabled&&(n.start(e,t,i,this.isFeatureEnabled(Da.Y.HighResolutionShadows),this._stage.view.qualitySettings.maximumPixelRatio),this._needsShadowHighlight?(this._renderShadowCascades(l_.H_.ShadowHighlight,this._shadowMap),n.moveSnapshot(_w.i.Highlight),this._renderShadowCascades(l_.H_.ShadowExcludeHighlight,this._shadowMap),n.copySnapshot(_w.i.ExcludeHighlight),this._renderShadowCascades(l_.H_.ShadowHighlight,this._shadowMap)):this._renderShadowCascades(l_.H_.Shadow),n.finish(),e.setGLViewport(this._rctx),this.performanceInfo.advance(xw.SHADOW_MAP))}_renderShadowCascades(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:this._shadowMap;for(const i of t.cascades)i.camera.setGLViewport(this._rctx),this._ensureBindParametersCamera(i.camera,i.camera),this._renderAllGeometry(e)}get _needsDepth(){return this._plugins.consumes(l_.H_.Depth)||this.hasReflections||this._needsShadowHighlight||this._needsShadowCast||this._debugNeedsDepth}_renderNoSSAOGeometryDepth(e){if(!this._needsDepth||!e)return void(this._bindParameters.depth=(0,p.RY)(this._bindParameters.depth));const{width:t,height:i}=this._offscreen,n=this.fboCache.acquire(t,i,"depth");n.attachDepth(e),e.release(),this._rctx.bindFramebuffer(n.fbo),this._rctx.clearFramebuffer(void 0,!1,!0),this._renderGeometryExcludedFromSSAO(l_.H_.Depth),(0,p.RY)(this._bindParameters.depth),this._bindParameters.depth=n.obtainDepthTexture(),n.release(),this.performanceInfo.advance(xw.DEPTH)}_renderAllGeometryDepth(){if(!this._needsDepth)return void(this._bindParameters.depth=(0,p.RY)(this._bindParameters.depth));const{width:e,height:t}=this._offscreen,i=this.fboCache.acquire(e,t,"depth").acquireDepth(ut.m.DEPTH_STENCIL_TEXTURE);this._rctx.bindFramebuffer(i.fbo),this._rctx.clearFramebuffer(void 0,!0,!0),this._renderAllGeometry(l_.H_.Depth),(0,p.RY)(this._bindParameters.depth),this._bindParameters.depth=i.obtainDepthTexture(),i.release(),this.performanceInfo.advance(xw.DEPTH)}_renderMultipassTerrainDepth(e){if(!e)return void(this._bindParameters.multipassTerrain.depth=(0,p.RY)(this._bindParameters.multipassTerrain.depth));const t=this._renderContext.output;this._renderContext.output=l_.H_.Depth;const{width:i,height:n}=this._offscreen,r=this.fboCache.acquire(i,n,"terrain depth").acquireDepth(ut.m.DEPTH_STENCIL_TEXTURE);this._rctx.bindFramebuffer(r.fbo),this._rctx.clearFramebuffer(void 0,!0,!0),this._renderTransparentTerrain(),(0,p.RY)(this._bindParameters.multipassTerrain.depth),this._bindParameters.multipassTerrain.depth=r.obtainDepthTexture(),this._renderContext.output=t,r.release()}_renderMultipassGeometryDepth(e){if(!e)return void(this._bindParameters.multipassGeometry.depth=(0,p.RY)(this._bindParameters.multipassGeometry.depth));const t=this._renderContext.output,{width:i,height:n}=this._offscreen,r=this.fboCache.acquire(i,n,"geometry depth").acquireDepth(ut.m.DEPTH_STENCIL_TEXTURE);this._rctx.bindFramebuffer(r.fbo),this._rctx.clearFramebuffer(void 0,!0,!0),this._renderOpaqueGeometryAndTransparentMaterial(l_.H_.Depth),this._renderContext.output=t,(0,p.RY)(this._bindParameters.multipassGeometry.depth),this._bindParameters.multipassGeometry.depth=r.obtainDepthTexture(),r.release()}get _needsDepthRange(){return this._shadowMap.enabled||this._needsShadowCast}_computeDepthRange(e){if(!this._needsDepthRange)return mv;const t=Zy(e,this._plugins.plugins,this._stage.layers);return pv(t,this._plugins.queryDepthRange(e)),t.near=Math.max(e.near,t.near),t.far=Math.min(e.far,t.far),t}_renderNormals(){const e=this._nodes.require("normals","final-color","composite-color","opaque-color","transparent-color"),t=(this.hasSSAO?1:0)+(this.hasLaserlines?1:0)+e;if(0===t)return;const i=this._offscreen.renderToCachedFBO(null,"normals",(()=>this._renderGeometryForSSAO(l_.H_.Normal)),[0,0,0,0],ut.q.RGBA,ut.m.DEPTH_STENCIL_TEXTURE),n=this._nodes.optional("normals","final-color","composite-color","opaque-color","transparent-color")+(this._viewshedEnabled?1:0);return i.retain(t+n-1),this.performanceInfo.advance(xw.NORMALS),i}_renderSSAO(){const e=this._pluginInput.get("normals");if(!this.hasSSAO||!e)return void(null===e||void 0===e||e.detachDepth());const t=this._nodes.render("ssao",this._pluginInput);return this._bindParameters.ssao=t,e.detachDepth(),this._pluginInput.release("normals"),this.performanceInfo.advance(xw.SSAO),t}_renderAllGeometry(e){this._renderContext.output=e,this._plugins.prepare(en.r.TRANSPARENT_TERRAIN),this._renderOpaqueGeometryAndTransparentMaterial(e),this._renderTransparentTerrain()}_renderOpaqueGeometryAndTransparentMaterial(e){this._renderContext.output=e,this._plugins.prepare(en.r.TRANSPARENT_MATERIAL,en.r.TRANSPARENT_NO_SSAO_DEPTH),this._renderOpaqueGeometry(),this._renderTransparentMaterial()}_renderGeometryForSSAO(e){this._renderContext.output=e,this._plugins.render(this._pluginInput,en.r.INTEGRATED_MESH,en.r.OPAQUE_TERRAIN,en.r.OPAQUE_MATERIAL,en.r.TRANSPARENT_MATERIAL),this._renderTransparentTerrain()}_renderGeometryExcludedFromSSAO(e){this._renderContext.output=e,this._plugins.render(this._pluginInput,en.r.OPAQUE_NO_SSAO_DEPTH,en.r.TRANSPARENT_NO_SSAO_DEPTH)}_prepareOpaqueGeometry(){this._plugins.prepare(...Hw,en.r.OPAQUE_ENVIRONMENT)}_renderOpaqueGeometry(){this._plugins.render(this._pluginInput,...Hw)}_renderTransparentMaterial(){this._plugins.render(this._pluginInput,...Fw)}_renderTransparentTerrain(){const e=this._renderContext.output;if(!this._plugins.produces(e,en.r.TRANSPARENT_TERRAIN))return;const t=()=>this._plugins.render(this._pluginInput,en.r.TRANSPARENT_TERRAIN);if(e!==l_.H_.Color)return void t();const{width:i,height:n,depth:r}=this._offscreen,s=this.fboCache.acquire(i,n,"transparent terrain");return this._offscreen.renderToTargets(t,s,r,[0,0,0,0]),s}_renderHUDVisibility(){this._plugins.produces(this._renderContext.output,en.r.OCCLUSION_PIXELS)?(this._bindParameters.hudVisibility=this._offscreen.renderHUDVisibility(this._bindParameters.hudVisibility,(()=>this._plugins.render(this._pluginInput,en.r.OCCLUSION_PIXELS)),this._bindParameters.multipassGeometry.depth),this._offscreen.bindFbo(),this.performanceInfo.advance(xw.HUD_VISIBILITY)):this._bindParameters.hudVisibility=(0,p.RY)(this._bindParameters.hudVisibility)}_renderLineCallouts(e){if(this._bindParameters.hudRenderStyle=e,e===Bb.U.Occluded){const e=()=>this._plugins.render(this._pluginInput,en.r.LINE_CALLOUTS),{width:t,height:i,color:n}=this._offscreen,r=this.fboCache.acquireDepth(ut.m.DEPTH16_BUFFER,t,i,"line callouts");this._offscreen.renderToTargets(e,n,r,void 0,!0,!0),r.release()}else this._plugins.render(this._pluginInput,en.r.LINE_CALLOUTS)}_renderLaserlines(){if(this.hasLaserlines){if(this._plugins.render(this._pluginInput,en.r.LASERLINES),this._plugins.produces(this._renderContext.output,en.r.LASERLINES_CONTRAST_CONTROL)){const e=this._offscreen,{width:t,height:i,depth:n}=e,r=this.fboCache.acquire(t,i,"laser lines"),s=()=>this._plugins.render(this._pluginInput,en.r.LASERLINES_CONTRAST_CONTROL);e.renderToTargets(s,r,n,Uw),e.compositeToFramebuffer(this._bindParameters,r.getTexture(),Ry.PremultipliedAlpha,1),r.release()}this._pluginInput.release("normals"),this.performanceInfo.advance(xw.LASER_LINES)}}_renderHUD(e,t){if(this._pluginsHas.hudElements){if(this._oitEnabled){const i=this._renderOITPass(Lw.HUD,e);this._rctx.bindFramebuffer(t.fbo),this._compositingHelper.composite(this._bindParameters,i.getTexture(),Ry.PremultipliedAlpha),i.release()}else if(e===Bb.U.Occluded){this._renderContext.output=l_.H_.Color;const t=()=>this._renderHUDElements(e),{width:i,height:n,color:r}=this._offscreen,s=this.fboCache.acquireDepth(ut.m.DEPTH16_BUFFER,i,n,"hud");this._offscreen.renderToTargets(t,r,s,void 0,!0,!0),s.release()}else this._renderContext.output=l_.H_.Color,t.acquireDepth(ut.m.DEPTH16_BUFFER),this._rctx.bindFramebuffer(t.fbo),this._renderHUDElements(e),t.detachDepth();this.performanceInfo.advance(e===Bb.U.Occluded?xw.HUD_OCCLUDED:xw.HUD)}}_renderHUDElements(e){this._bindParameters.hudRenderStyle=e,this._plugins.prepare(en.r.LINE_CALLOUTS_HUD_DEPTH,en.r.HUD_MATERIAL,en.r.LABEL_MATERIAL),this._plugins.render(this._pluginInput,en.r.LINE_CALLOUTS_HUD_DEPTH,en.r.HUD_MATERIAL,en.r.LABEL_MATERIAL)}get _needsShadowHighlight(){return this._shadowMap.enabled&&this._plugins.produces(l_.H_.ShadowHighlight,en.r.OPAQUE_MATERIAL)}_renderHighlightPrepass(){if(!this.hasHighlights)return;const e=this._offscreen.renderToCachedFBO(null,"highlights",(()=>{this._renderAllGeometry(l_.H_.Highlight),this._rctx.clear(st.lk.DEPTH_BUFFER_BIT),this._renderHUDElements(Bb.U.Both)}),[0,0,0,0],ut.q.RGBA4,ut.m.DEPTH_STENCIL_TEXTURE);return e.detachDepth(),e}get _needsShadowCast(){return this._shadowAccumulator.isAccumulating}_renderShadowAccumulation(e,t,i){this._needsShadowCast&&this._bindParameters.depth&&this._shadowAccumulator.renderAccumulation(this._bindParameters.depth,e,t,i)&&this.performanceInfo.advance(xw.ACCUMULATED_SHADOWS)}_prepareTransparencySlots(){this._renderContext.output=l_.H_.Color,this._bindParameters.transparencyPassType=Lb.A.ColorAlpha,this._plugins.prepare(...Fw),this._bindParameters.transparencyPassType=Lb.A.FrontFace,this._plugins.prepare(...Fw),this._bindParameters.transparencyPassType=Lb.A.NONE,this._techniques.acquire(Uy).release()}_renderOITPass(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:Bb.U.Both;const i=e===Lw.HUD,n=i?this.fboCache.acquire(this._offscreen.width,this._offscreen.height,"oit hud composite"):null,r=i?()=>this._renderHUDElements(t):()=>this._renderTransparentMaterial(),s=this._renderContext.output;this._renderContext.output=l_.H_.Color,this._bindParameters.transparencyPassType=Lb.A.ColorAlpha;const a=this._offscreen.renderOITPass(r,Lb.A.ColorAlpha,i);this._bindParameters.transparencyPassType=Lb.A.FrontFace;const o=this._offscreen.renderOITPass(r,Lb.A.FrontFace,i);return this._offscreen.compositeOIT(this._bindParameters,a,o,n),null!==n&&void 0!==n&&n.detachDepth(),o.release(),a.release(),this._bindParameters.transparencyPassType=Lb.A.NONE,this._renderContext.output=s,n}_renderOccluded(){let e=0;Vw.clear(),this._plugins.plugins.forAll((t=>{t.materialReference&&t.queryRenderOccludedState(pp.yD.OccludeAndTransparentStencil)&&(e|=pp.yD.OccludeAndTransparentStencil,Vw.push(t))}));const t=this._offscreen,i=(i,n,r,s,a)=>{if(!(e&n))return;const{width:o,height:l,depth:h}=t,c=this.fboCache.acquire(o,l,"tmp color");t.renderToTargets(r,c,h,[0,0,0,0],s,a),t.compositeToFramebuffer(this._bindParameters,c.getTexture(),Ry.PremultipliedAlpha,i),c.release()},n=(e,t)=>{this._bindParameters.slot=e,t.forAll((e=>{if((0,$i.QA)(e)){const t=e.prepareTechnique(this._renderContext);t&&e.renderNode(this._renderContext,t)}}))};0!==Vw.length&&(n(en.r.OCCLUDER_MATERIAL,Vw),i(.5,pp.yD.OccludeAndTransparentStencil,(()=>n(en.r.TRANSPARENT_OCCLUDER_MATERIAL,Vw)),!1,!1));const r=Vw.length>0;Vw.clear(),this._plugins.plugins.forAll((t=>{if(!t.materialReference)return;const i=t.queryRenderOccludedState(pp.yD.OccludeAndTransparent),n=t.queryRenderOccludedState(pp.yD.Transparent),r=t.queryRenderOccludedState(pp.yD.Opaque);(i||n||r)&&(e|=i?pp.yD.OccludeAndTransparent:n?pp.yD.Transparent:pp.yD.Opaque,Vw.push(t))}));const s=this._plugins.renderOccludedFlags;if(e|=s,!e)return;const a=e=>{this._renderContext.renderOccludedMask=e,s>pp.yD.Occlude&&this._plugins.render(this._pluginInput,en.r.OCCLUDED_TERRAIN),n(en.r.OPAQUE_MATERIAL,Vw),n(en.r.TRANSPARENT_MATERIAL,Vw),n(en.r.TRANSPARENT_DEPTH_WRITE_DISABLED_MATERIAL,Vw),this._renderContext.renderOccludedMask=aw.C9};this._renderContext.output=l_.H_.Color,i(.5,pp.yD.OccludeAndTransparent,(()=>a(pp.yD.OccludeAndTransparent)),!0,dp.hU.OutlineVisualElementMask),i(.5,pp.yD.Transparent,(()=>a(pp.yD.Transparent)),!0,dp.hU.OutlineVisualElementMask),i(1,pp.yD.Opaque,(()=>a(pp.yD.Opaque)),!0,dp.hU.OutlineVisualElementMask),(r||Vw.length>0)&&this.performanceInfo.advance(xw.OCCLUDED),Vw.clear()}_renderTransparentEnvironment(){this._shadowAccumulator.render(this._bindParameters),this._offscreen.bindFbo(),this._plugins.render(this._pluginInput,en.r.TRANSPARENT_DEPTH_WRITE_DISABLED_MATERIAL,en.r.TRANSPARENT_ENVIRONMENT),this.performanceInfo.advance(xw.TRANSPARENT_ENVIRONMENT)}_renderViewshed(){this._viewshedEnabled&&(this._viewshed.renderHighQuality=this.isFeatureEnabled(Da.Y.HighResolutionViewshed),this._plugins.render(this._pluginInput,en.r.VIEWSHED),this._pluginInput.release("normals"),this.performanceInfo.advance(xw.VIEWSHED))}_renderPlugins(e,t){this._plugins.produces(this._renderContext.output,e)&&(this._plugins.render(this._pluginInput,e),this.performanceInfo.advance(t))}_renderNodes(e,t){let i=arguments.length>2&&void 0!==arguments[2]&&arguments[2];if(!this._nodes.produces(e))return i&&this.performanceInfo.advance(e),t;t.setName(e),this._pluginInput.set(e,t);const n=this._nodes.render(t,this._pluginInput,this._releaseNormals);return this.performanceInfo.advance(e),n}_blitToDefault(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:bb,i=!(arguments.length>2&&void 0!==arguments[2])||arguments[2];this._blit||(this._blit=new Xb(this._techniques));const n=this._blit.render(this._rctx,e,t,this._bindParameters,this._requestRender);return this._pluginInput.set(e.name,n),i&&e.release(),n}_ensureBindParametersCamera(e,t){this._bindParameters.camera=e,this._bindParameters.contentCamera=t}_ensureBindParametersSSR(e){if(this._bindParameters.ssr.lastFrameColor){null==this._ssrEnableTime&&(this._ssrEnableTime=e),this._renderContext.lastFrameCamera.equals(this._bindParameters.camera)?this._reprojectionMatrix=Mt.Wd:((0,Pt.U_)(zw,this._bindParameters.camera.viewMatrix),(0,Pt.U_)(qw,this._bindParameters.camera.projectionMatrix),(0,Pt.Jp)(Bw,zw,qw),(0,Pt.Jp)(Bw,this._renderContext.lastFrameCamera.viewMatrix,Bw),(0,Pt.Jp)(Bw,this._renderContext.lastFrameCamera.projectionMatrix,Bw),this._reprojectionMatrix=Bw);const t=this._stage.view.qualitySettings.fadeDuration;this._bindParameters.ssr.fadeFactor=t>0?Math.min(t,e-this._ssrEnableTime)/t:1,this._bindParameters.ssr.fadeFactor<1&&this._requestRender()}else this._reprojectionMatrix=Mt.Wd,this._ssrEnableTime=null}addRenderNode(e){this._nodes.add(e),this._requestRender()}removeRenderNode(e){this._nodes.remove(e),this._requestRender()}get usedMemory(){var e,t;return{fbos:this.fboCache.usedMemory,plugins:this._plugins.usedMemory,edges:null!==(e=null===(t=this.edgeView)||void 0===t?void 0:t.usedMemory)&&void 0!==e?e:0}}get _viewshedEnabled(){return this._viewshed.enabled&&this._plugins.produces(this._renderContext.output,en.r.VIEWSHED)}get test(){}}var Lw,Nw;(0,n._)([(0,b.Cb)({readOnly:!0})],Iw.prototype,"fullResolutionAtmosphere",null),(0,n._)([(0,b.Cb)()],Iw.prototype,"_edgeView",void 0),(0,n._)([(0,b.Cb)()],Iw.prototype,"updating",null),function(e){e[e.Geometry=0]="Geometry",e[e.HUD=1]="HUD"}(Lw||(Lw={})),function(e){e[e.Color=0]="Color",e[e.LinearDepth=1]="LinearDepth",e[e.ShadowMap=2]="ShadowMap",e[e.HudVisibility=3]="HudVisibility",e[e.ViewshedShadowMap=4]="ViewshedShadowMap"}(Nw||(Nw={}));const Uw=[0,0,0,0],Hw=[en.r.INTEGRATED_MESH,en.r.OPAQUE_TERRAIN,en.r.OPAQUE_MATERIAL,en.r.OPAQUE_NO_SSAO_DEPTH],Fw=[en.r.TRANSPARENT_MATERIAL,en.r.TRANSPARENT_NO_SSAO_DEPTH],Vw=new pl.Z,qw=(0,Mt.Ue)(),zw=(0,Mt.Ue)(),Bw=(0,Mt.Ue)();function Gw(e){return t=>e.immediate.schedule(t)}class kw{constructor(e){this._rctx=e,this._vao=function(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:pt.QI,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:nt.i;const n=new Float32Array([-1,-1,3,-1,-1,3]);return new li.U(e,i,{geometry:t},{geometry:ci.f.createVertex(e,st.l1.STATIC_DRAW,n)})}(e)}destroy(){this._vao=(0,p.M2)(this._vao)}draw(){null!=this._vao&&(this._rctx.bindVAO(this._vao),this._rctx.drawArrays(st.MX.TRIANGLES,0,3))}get test(){}}var Zw=i(25580),jw=i(85377);class Ww extends jw.x{constructor(e,t,i){super(e,t),this.gl=e,this.newCache=i,this._appleAmdDriverHelper=null,this._refCount=1,this.screen=new kw(this)}destroy(){--this._refCount>0||this.dispose()}ref(){++this._refCount}dispose(){var e;super.dispose(),null!==(e=this._appleAmdDriverHelper)&&void 0!==e&&e.dispose(),this.screen.destroy()}bindTechnique(e,t,i,n,r){return this.useProgram(e.program),this.setPipelineState(e.getPipeline(!!r)),e.program.bindPass(i,t),n&&e.program.bindDraw(n,t,i),e.program}runAppleAmdDriverHelper(){var e;this.driverTest.drawArraysRequiresIndicesTypeReset.result&&(null!==(e=this._appleAmdDriverHelper)&&void 0!==e||(this._appleAmdDriverHelper=new Zw.E(this)),this._appleAmdDriverHelper.run())}get test(){}}function Xw(e){return!!e.frameUpdate}var Qw=i(5195),Yw=i(25049);let Jw=class extends T.default{constructor(e,t,i){super({}),this._stage=e,this._techniques=t,this._rctx=i,this._textures=new Map,this._loadingCount=0,this._frameUpdates=new Map,this.events=new G.Z,this._frameTask=e.view.resourceController.scheduler.registerTask(Bt.T8.TEXTURE_UNLOAD)}normalizeCtorArgs(){return{}}destroy(){this._frameTask.remove(),this._stage.forEachOfType(yf.U.Texture,(e=>e.unload()))}get updating(){return this._loadingCount>0||this._frameTask.updating}get textureTechnique(){return null==this._textureTechnique&&(this._textureTechnique=this._techniques.acquire(Qw.K,new Yw.V)),this._textureTechnique}acquire(e){var t;const i=this._textures.get(e);return i?(i.ref(),null!==(t=i.loadingPromise)&&void 0!==t?t:i):this._createNewRef(e)}update(){let e=!1;this._frameUpdates.forEach((t=>{const i=t.texture.frameUpdate(t.previousToken);i>=0&&i!==t.previousToken&&(t.previousToken=i,e=!0)})),e&&this.events.emit("changed",dp.Xx.BACKGROUND)}_createNewRef(e){const t=this._stage.getObject(e);if(null==t)return(0,vi.hu)(void 0!==t),null;const i=t.events.on("unloaded",(()=>{i.remove(),this._onTextureUnloaded(e)})),n=new Kw(e,(()=>{this._frameTask.schedule((()=>{n.isUnreferenced&&t.unload()}))}));return this._textures.set(e,n),n.ref(),t.glTexture?(this._updateGLTexture(n,t.glTexture),Xw(t)&&this._frameUpdates.set(e,{texture:t,previousToken:-1}),n):(this._loadingCount++,n.loadingPromise=this._stage.schedule((()=>{const i=t.load(this._rctx),r=i=>(this._loadingCount--,n.loadingPromise=null,this._updateGLTexture(n,i),Xw(t)&&this._frameUpdates.set(e,{texture:t,previousToken:-1}),n);return(0,m.y8)(i)?i.then(r,(e=>(this._loadingCount--,n.loadingPromise=null,(0,m.D_)(e)||u.Z.getLogger(this).error(e),null))):r(i)})),n.loadingPromise)}_updateGLTexture(e,t){e.glTexture=t,this.events.emit("changed",dp.Xx.UPDATE)}_onTextureUnloaded(e){this._textures.delete(e),this._frameUpdates.delete(e)}};(0,n._)([(0,b.Cb)()],Jw.prototype,"_loadingCount",void 0),(0,n._)([(0,b.Cb)()],Jw.prototype,"_frameTask",void 0),(0,n._)([(0,b.Cb)()],Jw.prototype,"updating",null),Jw=(0,n._)([(0,C.j)("esri.views.3d.webgl-engine.lib.TextureRepository")],Jw);class Kw{constructor(e,t){this.id=e,this._release=t,this._refCount=0}get isUnreferenced(){return 0===this._refCount}ref(){++this._refCount}release(){--this._refCount,this._refCount>0||(0!==this._refCount?(u.Z.getLogger("esri.views.3d.webgl-engine.lib.TextureRepository.RefCountedTextureImpl").error("Cannot dereference texture that has no references!"),this._refCount=0):this._release())}}var $w=i(2522),eC=i(91398);var tC=i(5921);let iC=class extends T.default{constructor(){super(...arguments),this._passParameters=new nC,this._resourcesTask=null}get passParameters(){return this._passParameters}destroy(){this._resourcesTask=(0,p.IM)(this._resourcesTask),this._passParameters.waveNormal=(0,p.M2)(this._passParameters.waveNormal),this._passParameters.wavePerturbation=(0,p.M2)(this._passParameters.wavePerturbation)}get updating(){return!!this._resourcesTask&&!this._resourcesTask.finished}ensureResources(e){return this._resourcesTask||(this._resourcesTask=(0,oe.vr)((async t=>{await Promise.allSettled([this._loadImageResource(e,(0,Fi.V)("esri/images/materials/water/normals.jpg"),(e=>this._passParameters.waveNormal=e),t),this._loadImageResource(e,(0,Fi.V)("esri/images/materials/water/perturbation.jpg"),(e=>this._passParameters.wavePerturbation=e),t)])}))),this._resourcesTask.finished?dp.Rw.LOADED:dp.Rw.LOADING}async _loadImageResource(e,t,i,n){try{const r=await(0,_y.t)(t,{signal:n});(0,m.k_)(n);const s=new Vt.X(r.width,r.height);s.pixelFormat=st.VI.RGB,s.samplingMode=st.cw.LINEAR_MIPMAP_LINEAR,s.hasMipmap=!0,s.maxAnisotropy=8,i(new di.x(e,s,r))}catch(r){u.Z.getLogger(this).error("Failed to load water material normal texture.",r)}}};(0,n._)([(0,b.Cb)()],iC.prototype,"_resourcesTask",void 0),(0,n._)([(0,b.Cb)({type:Boolean,readOnly:!0})],iC.prototype,"updating",null),iC=(0,n._)([(0,C.j)("esri.views.3d.webgl-engine.materials.internal.WaterTextureRepository")],iC);class nC extends et.K{}const rC=new Map;function sC(){return rC}var aC=i(7796),oC=i(51e3);class lC{constructor(e,t,i){this.parameters=e,this.frameHasDecorations=t,this.fbos=i}}class hC{constructor(e,t,i){this._rctx=e,this._renderFunctions=t,this._forceCameraHook=i,this.supersample=!0,this._screenshotQueue=new Array}destroy(){this._rctx=null}async takeScreenshot(e){await this._renderFunctions.prepareOverlay(),this._renderFunctions.requestRenderScene(dp.Xx.BACKGROUND);const t=(0,m.hh)();return this._screenshotQueue.push({settings:e,resolver:t}),t.promise}update(e,t){for(const i of this._screenshotQueue){if(null==this._rctx){i.resolver.reject();continue}const n={...i.settings,pixelRatio:i.settings.pixelRatio*e.parameters.camera.pixelRatio},r=this._renderScreenshot(e,n,t);i.resolver(r)}this._screenshotQueue.length=0}_renderScreenshotOverlay(e,t,i){e.width=t.width,e.height=t.height;const n=e.getContext("2d"),r=i.pixelRatio;return n.save(),n.translate(0,t.height),n.scale(1,-1),i.region&&n.translate(-i.region.x,-i.region.y),n.scale(r,r),t=this._renderFunctions.renderOverlay(e,i.disableDecorations?dp.Iq.OFF:dp.Iq.ON,t),n.restore(),t}_readbackScreenshot(e,t){return e.resample?this._readbackScreenshotResampled({...e,resample:e.resample},t):this._readbackScreenshotImmediate(e,t)}_readbackScreenshotResampled(e,t){const{framebufferWidth:i,framebufferHeight:n,region:r,resample:s}=e,a=this._ensureScreenshotEncodeCanvas();let o=(0,oC.r7)(i,n,a);this._rctx.gl.readPixels(0,0,i,n,st.VI.RGBA,st.g.UNSIGNED_BYTE,new Uint8Array(o.data.buffer)),t(),o=this._renderScreenshotOverlay(a,o,{...e,region:void 0});const l=(0,oC.r7)(r.width,r.height,a);return(0,aC.TT)(o,l,!0,s.region.x,n-(s.region.y+s.region.height),s.region.width,s.region.height)}_readbackScreenshotImmediate(e,t){const{framebufferHeight:i,region:n}=e,r=this._ensureScreenshotEncodeCanvas(),s=(0,oC.r7)(n.width,n.height,r);return this._rctx.gl.readPixels(n.x,i-(n.y+n.height),n.width,n.height,st.VI.RGBA,st.g.UNSIGNED_BYTE,new Uint8Array(s.data.buffer)),t(),this._renderScreenshotOverlay(r,s,e)}_renderScreenshot(e,t,i){var n;const r=e.parameters.camera,s={width:t.framebufferWidth,height:t.framebufferHeight};(0,Ft.d)(s,Math.min(this._rctx.parameters.maxTextureSize,this._rctx.parameters.maxRenderbufferSize));let a=!1;const o=t.disableDecorations&&e.frameHasDecorations,l=s.width!==r.fullWidth||s.height!==r.fullHeight,h=t.ignorePadding&&r.pixelRatio!==t.pixelRatio,c=l||o||h||t.objectAndLayerIdColor;let d=null,u=null;if(c){const e=r.clone();if(t.ignorePadding){const i=(0,Ye.d9)(e.padding);for(let n=0;n<4;n++)i[n]=Math.round(i[n]/e.pixelRatio*t.pixelRatio);e.padding=i}e.fullWidth=s.width,e.fullHeight=s.height,e.pixelRatio=t.pixelRatio;const n=r.fovX-e.fovX,o=r.fovY-e.fovY;n<0&&n<o?e.fovX=r.fovX:o<0&&o<n&&(e.fovY=r.fovY);const l={camera:e,contentCamera:e,mode:Ia.n.IDLE,alignPixelEnabled:!0,contentPixelRatio:e.pixelRatio};this._forceCameraHook(l),a=!0;const h=this._renderFunctions.renderScene(l,i,t.objectAndLayerIdColor?Ea.YE.ObjectAndLayerID:Ea.YE.Screenshot,t.disableDecorations?dp.Iq.OFF:dp.Iq.ON);u=h.screen,d=h.oid}this._rctx.bindFramebuffer(null===(n=u)||void 0===n?void 0:n.fbo);const p=this._readbackScreenshot(t,(()=>{var e;this._rctx.bindFramebuffer(null),null===(e=u)||void 0===e||e.release()}));let _=null;if(t.objectAndLayerIdColor){var m;const e=()=>{var e;this._rctx.bindFramebuffer(null),null===(e=d)||void 0===e||e.release()};this._rctx.bindFramebuffer(null===(m=d)||void 0===m?void 0:m.fbo),_=this._readbackScreenshot(t,e),this._rctx.bindFramebuffer(null)}if(c&&!this._rctx.contextAttributes.alpha)for(let g=3;g<p.data.length;g+=4)p.data[g]=255;if(_&&!this._rctx.contextAttributes.alpha)for(let g=3;g<_.data.length;g+=4)_.data[g]=255;return a&&this._forceCameraHook(e.parameters),[p,_]}_ensureScreenshotEncodeCanvas(){return this._screenshotEncodeCanvas||(this._screenshotEncodeCanvas=document.createElement("canvas")),this._screenshotEncodeCanvas}}const cC=!1;var dC=i(83826);let uC=class extends T.default{constructor(e){super({}),this.events=new G.Z,this.waterTextures=new iC,this.objectAndLayerIdRenderHelper=(0,d.Z)("enable-feature:objectAndLayerId-rendering")?new ob:null,this._needsUpdate=!0,this._needsRender=!0,this._idleSuspend=!0,this._needsWaterReflectionUpdate=!1,this._lastAnimationUpdate=0,this._container=e.container,this._viewingMode=e.viewingMode;try{this._initializeContext(e)}catch(re){return void console.error("Failed to initialize context",re)}const{memoryController:t}=e.view.resourceController;this.stippleTextures=(0,tC.kW)(this._rctx,t),this.markerTextures=function(e,t){return new eC.t((t=>(0,$w.LM)(t,e)),(e=>e),t)}(this._rctx,t),this._techniques=new Jv.M({rctx:this._rctx,viewingMode:e.viewingMode,stippleTextures:this.stippleTextures,waterTextures:this.waterTextures,markerTextures:this.markerTextures}),this._textures=new Jw(e,this._techniques,this._rctx),this.addHandles(this._textures.events.on("changed",(e=>this.requestRender(e)))),this._materials=new sb.h(this._textures,this._techniques,(()=>this.requestRender()),(()=>this.requestRender())),this._compositingHelper=new Hy(this._rctx,this._techniques),this.renderer=new Iw(e,this._materials,this._techniques,this._rctx,this._compositingHelper,(e=>this.requestRender(e))),this.addHandles([(0,g.watch)((()=>e.view.ready),(t=>{t&&this._createRenderNodes(e.view,e.viewingMode)}),g.initial),(0,g.watch)((()=>{var e;return null===(e=this.waterTextures)||void 0===e?void 0:e.updating}),(()=>this.requestRender()),g.initial),(0,g.watch)((()=>e.view.qualityProfile),(e=>{var t;return null===(t=this.renderer)||void 0===t?void 0:t.updateRenderFeatures(e)}),g.syncAndInitial)]);const i={renderScene:(e,t,i,n)=>this.renderer.render(e,t,i,n),requestRenderScene:e=>this.requestRender(e),prepareOverlay:()=>e.options.screenshot.prepareOverlay(),renderOverlay:(t,i,n)=>e.options.screenshot.renderOverlay(t,i,n)};this._screenshotManager=new hC(this._rctx,i,(e=>this.events.emit("force-camera-for-screenshot",e))),this._registerFrameTask(e)}normalizeCtorArgs(){return{}}destroy(){this._container.contains(this._canvas)&&this._container.removeChild(this._canvas),this._frameTask=(0,p.hw)(this._frameTask),this._techniques=(0,p.SC)(this._techniques),this._componentObjects=(0,p.SC)(this._componentObjects),this._screenshotManager=(0,p.SC)(this._screenshotManager),(0,p.SC)(this.renderer),this._textures=(0,p.SC)(this._textures),(0,p.SC)(this.waterTextures),(0,p.SC)(this.markerTextures),(0,p.SC)(this.stippleTextures),this._canvas=null,this._container=null,this._rctx=(0,p.SC)(this._rctx)}_createRenderNodes(e,t){new Ay.K({view:e,isEnabled:()=>this.renderer.hasSSAO,techniques:this._techniques}),new Py({view:e,isEnabled:()=>this.renderer.hasSMAA,techniques:this._techniques}),new vy({view:e,techniques:this._techniques}),new ay({view:e,techniques:this._techniques}),new uy({view:e,viewingMode:t,techniques:this._techniques})}requestRender(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:dp.Xx.UPDATE;this._needsRender=!0,e===dp.Xx.UPDATE&&(this._needsUpdate=!0)}get updating(){return this._needsUpdate||this._needsWaterReflectionUpdate||this.renderer.updating||this._textures.updating||this.waterTextures.updating}get textures(){return this._textures}get compositingHelper(){return this._compositingHelper}setIdleSuspend(e){this._idleSuspend!==e&&(this._idleSuspend=e,this.requestRender())}get renderingContext(){return this._rctx}get capabilities(){return this._rctx.capabilities}get canvas(){return this._canvas}takeScreenshot(e){return this._screenshotManager.takeScreenshot(e).then((e=>e[0]))}takeScreenshotWithOID(e){return e.objectAndLayerIdColor=!0,this._screenshotManager.takeScreenshot(e)}getAlpha(){return!!this._rctx.contextAttributes.alpha}getMinimalDepthForArea(e,t,i,n,r){let s=arguments.length>5&&void 0!==arguments[5]?arguments[5]:r;const a=n.constrainWindowSize(t,i,r*n.pixelRatio,s*n.pixelRatio),o=this._ensureDepthBuffer(a);this.renderer.readDepthPixels(a,o);let l=Number.MAX_VALUE;for(let h=0;h<a[2]*a[3];h++){const e=ky(4*h,o,n.nearFar);l>e&&e!==n.nearFar[0]&&e!==n.nearFar[1]&&(l=e)}if(e){const r=e.pickDepth(t*n.pixelRatio,i*n.pixelRatio,n);null!=r&&l>r&&r!==n.nearFar[0]&&r!==n.nearFar[1]&&(l=r)}return l===Number.MAX_VALUE?void 0:l}_ensureDepthBuffer(e){const t=4*e[2]*e[3];return(null==this._tmpDepthBuffer||this._tmpDepthBuffer.byteLength<t)&&(this._tmpDepthBuffer=new Uint8Array(t)),this._tmpDepthBuffer}async reloadShaders(){mp(),await this._techniques.reloadAll(),this.requestRender()}_registerFrameTask(e){const t=e.view.state;let i=!1,n=dp.Xx.BACKGROUND,r=!1;const s={preRender:r=>{let{time:s}=r;i=this.updating,n=this._needsUpdate?dp.Xx.UPDATE:dp.Xx.BACKGROUND,e.commitSyncLayers();const a=(0,Ri.HA)(s-this._lastAnimationUpdate);if(a>this.renderer.animationTimestep||null!=t.forcedAnimationTime||i||this._needsRender){const e=(0,Ri.HA)(a/this.renderer.animationTimeDilation),i=new pp._o(t.camera,e,t.forcedAnimationTime);this.renderer.updateAnimation(i)&&this.requestRender(dp.Xx.BACKGROUND),this._lastAnimationUpdate=s}},render:e=>{let{time:i}=e;if((this._needsRender||!this._idleSuspend||!this.renderer.isCameraFinal||this._needsWaterReflectionUpdate)&&t.camera.fullWidth>0&&t.camera.fullHeight>0){const e=this._needsUpdate&&this._idleSuspend&&this.renderer.isCameraFinal;this._needsRender=!1,this._needsUpdate=!1,this._needsWaterReflectionUpdate=!1,this.renderer.render(t,i),r=!0,e&&this.renderer.hasReflections&&(this.requestRender(dp.Xx.BACKGROUND),this._needsWaterReflectionUpdate=!0)}},update:e=>{let{time:i}=e;const n=this.renderer.hasSlicePlane||this.renderer.hasDecorations||this.renderer.hasHighlights,r=new lC(t,n,this.renderer.fboCache);this._textures.update(),this._screenshotManager.update(r,i)},finish:()=>{r&&(this.renderer.finish(t.mode===Ia.n.IDLE?n:dp.Xx.UPDATE),r=!1)}};this._frameTask=(0,f.A)(s)}_initializeContext(e){var t,i;const n=e.options;this._canvas=n.canvas,this._canvas||(this._canvas=document.createElement("canvas")),this._canvas.setAttribute("style","width: 100%; height:100%; display:block;");const r={alpha:n.alpha||!1,premultipliedAlpha:!0,antialias:!1,depth:!0,stencil:null===(t=n.stencil)||void 0===t||t,powerPreference:"high-performance",preserveDrawingBuffer:null!==(i=n.preserveDrawingBuffer)&&void 0!==i&&i},s=(0,dC.k)(this._canvas,r);null!=s?(this._rctx=function(e,t){const i={disabledExtensions:t.options.deactivatedWebGLExtensions||{},debugWebGLExtensions:t.options.debugWebGLExtensions||{},maxAnisotropy:8},n=(e,i)=>t.view.resourceController.memoryController.newCache(e,i);if(cC){let t=pC.get(e);return t?(t.configure(i),t.newCache=n,t.ref(),t):(t=new Ww(e,i,n),pC.set(e,t),t.ref(),t)}return new Ww(e,i,n)}(s,e),this._loadShaderOnlyExtensions(),!n.alpha&&this._rctx.contextAttributes.alpha&&u.Z.getLogger(this).error("WebGL context has alpha channel even though no alpha channel was requested"),!this._rctx.contextAttributes.alpha&&(0,d.Z)("safari")>=11&&(this._container.style.backgroundColor="black"),this._container.appendChild(this._canvas)):u.Z.getLogger(this).error("A WebGL2 context could not be created.")}_loadShaderOnlyExtensions(){this._rctx.capabilities.enable("textureFloatLinear")}getObjectAndLayerIdColor(e){return null!=this.objectAndLayerIdRenderHelper?this.objectAndLayerIdRenderHelper.getObjectAndLayerIdColor(e):null}get componentObjectCollection(){return null==this._componentObjects&&(this._componentObjects=new Wv(this.renderer.renderPassManager,this._viewingMode)),this._componentObjects}set componentObjectCollection(e){this._componentObjects=e}};(0,n._)([(0,b.Cb)({type:Boolean,readOnly:!0})],uC.prototype,"updating",null),(0,n._)([(0,b.Cb)()],uC.prototype,"_rctx",void 0),(0,n._)([(0,b.Cb)()],uC.prototype,"_container",void 0),(0,n._)([(0,b.Cb)()],uC.prototype,"_canvas",void 0),(0,n._)([(0,b.Cb)()],uC.prototype,"stippleTextures",void 0),(0,n._)([(0,b.Cb)()],uC.prototype,"markerTextures",void 0),(0,n._)([(0,b.Cb)()],uC.prototype,"waterTextures",void 0),(0,n._)([(0,b.Cb)({readOnly:!0})],uC.prototype,"objectAndLayerIdRenderHelper",void 0),(0,n._)([(0,b.Cb)()],uC.prototype,"_textures",void 0),(0,n._)([(0,b.Cb)({readOnly:!0})],uC.prototype,"renderer",void 0),(0,n._)([(0,b.Cb)()],uC.prototype,"_screenshotManager",void 0),(0,n._)([(0,b.Cb)()],uC.prototype,"componentObjectCollection",null),(0,n._)([(0,b.Cb)()],uC.prototype,"_componentObjects",void 0),(0,n._)([(0,b.Cb)()],uC.prototype,"_needsUpdate",void 0),(0,n._)([(0,b.Cb)()],uC.prototype,"_needsWaterReflectionUpdate",void 0),uC=(0,n._)([(0,C.j)("esri.views.3d.webgl-engine.parts.RenderView")],uC);const pC=sC();let _C=class extends T.default{constructor(e){super(e),this._model=new Pf,this._layers=new pl.Z,this._asyncChangeSet=new gf.as,this._syncChangeSet=new gf.as,this._layerSyncSet=new Set}initialize(){this._set("renderView",new uC(this)),this._frameTask=this.view.resourceController.scheduler.registerTask(Bt.T8.STAGE,this),this.addHandles(this._frameTask)}destroy(){this.renderView.destroy()}get viewingMode(){return this.view.state.viewingMode}get updating(){return this.running||this.renderView.updating||this._frameTask.updating}get renderer(){var e;return null===(e=this.renderView)||void 0===e?void 0:e.renderer}add(e){this._model.add(e),(0,vf.e)(e)&&this._addLayer(e),this.renderView.requestRender()}remove(e){null!=e&&!this.destroyed&&this._model.remove(e)&&((0,vf.e)(e)&&this._removeLayer(e),this.renderView.requestRender())}addMany(e){null!=e&&(this._model.addMany(e),this.renderView.requestRender())}removeMany(e){var t,i;null!=e&&(null!==(t=this._model)&&void 0!==t&&t.removeMany(e),null===(i=this.renderView)||void 0===i||i.requestRender())}forEachOfType(e,t){this._model.forEachOfType(e,t)}handleEvent(e,t){this.destroyed||(this._model.dirtySet[e](t),this.renderView.requestRender())}get running(){return this._model.dirtySet.dirty||!this._asyncChangeSet.empty}runTask(e){if(this._frameTask.processQueue(e),this._commit(e),!e.hasProgressed)return Gt.J}_commit(e){const t=this._model.dirtySet;this._asyncChangeSet.empty||e.done||(this.renderer.modify(this._asyncChangeSet,e),this.renderView.requestRender(),e.madeProgress()),this._layers.forAll((i=>{if(e.done)return;const n=this._layerSyncSet.has(i.id)||i.updatePolicy===ff.j.SYNC,r=n?this._syncChangeSet:this._asyncChangeSet;t.commitLayer(i.id,r),this._layerSyncSet.delete(i.id),r.empty||(this.renderer.modify(r,n?Bt.G5:e),this.renderView.requestRender(),e.madeProgress())})),this._syncChangeSet.empty||(this.renderer.modify(this._syncChangeSet,Bt.G5),this.renderView.requestRender(),e.madeProgress()),this._layers.forAll((i=>{e.done||this._layerSyncSet.has(i.id)||i.updatePolicy!==ff.j.ASYNC||(t.commitLayer(i.id,this._asyncChangeSet),this._asyncChangeSet.empty||(this.renderer.modify(this._asyncChangeSet,e),this.renderView.requestRender(),e.madeProgress()))})),this._layerSyncSet.clear(),this.notifyChange("running")}commitSyncLayers(){const e=this._model.dirtySet;this._layers.forAll((t=>{this._layerSyncSet.has(t.id)||t.updatePolicy===ff.j.SYNC?(e.commitLayer(t.id,this._syncChangeSet),this._layerSyncSet.delete(t.id)):e.commitSyncUpdates(t.id,this._syncChangeSet)}));for(const t of this._layerSyncSet)e.commitLayer(t,this._syncChangeSet);this._layerSyncSet.clear(),this._syncChangeSet.empty||(this.renderer.modify(this._syncChangeSet,Bt.G5),this.renderView.requestRender())}_commitLayer(e){this._model.dirtySet.commitLayer(e.id,this._syncChangeSet),this._layerSyncSet.delete(e.id),this._syncChangeSet.empty||(this.renderer.modify(this._syncChangeSet,Bt.G5),this.renderView.requestRender())}schedule(e,t){return this._frameTask.schedule(e,t)}reschedule(e,t){return this._frameTask.reschedule(e,t)}syncLayer(e){this._layerSyncSet.add(e),this.renderView.requestRender()}getObject(e){return this._model.getObject(e)}get layers(){return this._layers}_addLayer(e){this._layers.includes(e)||this._layers.push(e)}_removeLayer(e){this._commitLayer(e),null!=this._layers.removeUnordered(e)&&(this._model.dirtySet.getResidentRenderGeometries(e.id,this._syncChangeSet.removes),this.renderer.modify(this._syncChangeSet,Bt.G5))}addRenderPlugin(e,t){const i=this.renderer.plugins.add(e,t),n=()=>{Qc(e)&&this.view.sceneIntersectionHelper.addIntersectionHandler(e)};if((0,m.y8)(i))return i.then(n);n()}removeRenderPlugin(e){this.destroyed||(Qc(e)&&this.view.sceneIntersectionHelper.removeIntersectionHandler(e),this.renderer.plugins.remove(e))}get performanceInfo(){return this._model.getStats()}get test(){}};_C.DebugSettings={endFrameContentValidation:!1},(0,n._)([(0,b.Cb)({constructOnly:!0})],_C.prototype,"view",void 0),(0,n._)([(0,b.Cb)({constructOnly:!0})],_C.prototype,"options",void 0),(0,n._)([(0,b.Cb)({readOnly:!0})],_C.prototype,"viewingMode",null),(0,n._)([(0,b.Cb)({constructOnly:!0})],_C.prototype,"container",void 0),(0,n._)([(0,b.Cb)({readOnly:!0})],_C.prototype,"updating",null),(0,n._)([(0,b.Cb)({constructOnly:!0})],_C.prototype,"_model",void 0),(0,n._)([(0,b.Cb)()],_C.prototype,"renderView",void 0),(0,n._)([(0,b.Cb)({readOnly:!0})],_C.prototype,"renderer",null),(0,n._)([(0,b.Cb)({readOnly:!0})],_C.prototype,"running",null),_C=(0,n._)([(0,C.j)("esri.views.3d.webgl-engine.Stage")],_C);var mC=i(69787),gC=i(72612),fC=i(92028),vC=i(87770),yC=i(33006);let bC=class extends yC.Z{constructor(e){super(e),this.components=["attribution","zoom","navigation-toggle","compass"]}};(0,n._)([(0,b.Cb)()],bC.prototype,"components",void 0),bC=(0,n._)([(0,C.j)("esri.views.ui.3d.DefaultUI3D")],bC);const wC=bC;let CC=class extends((0,q.g)((0,K.u)((0,z.f)($.Z)))){constructor(e){var t;super(e),t=this,this._userClippingArea=null,this._clippingArea=null,this._initialDefaultSpatialReference=null,this._createGraphicsViewController=null,this._resolveWhenReady=[],this._propertiesPool=new Oa.L({slicePlane:N.B},this),this._resourceController=function(e){return new jd({view:e})}(this),this._defaultToMapOptions={include:new Set},this._defaultHitTestOptions={exclude:new Set},this.deconflictor=new Jl({view:this}),this.labeler=new $l.S({view:this,deconflictor:this.deconflictor.labels}),this.sharedSymbolResources=null,this.analyses=new V.J,this.basemapTerrain=null,this.elevationProvider=null,this.canvas=null,this.constraints=new Me,this.environment=new qe,this.environmentManager=new cn,this.floors=new a.Z,this.fullOpacity=1,this.graphicsView=null,this.analysisViewManager=new pe({view:this}),this.groundView=null,this.map=null,this.screenSizePerspectiveEnabled=!0,this.state=new Nc,this.spatialReference=null,this.alphaCompositingEnabled=!1,this.preserveDrawingBufferEnabled=!1,this.supersampleScreenshotsEnabled=!0,this.type="3d",this.ui=new wC,this._numUpdating=0,this._lastUpdateTime=0,this.updatingProgress=.5,this.highlightOptions=new ud,(0,y.j2)();const i=function(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null;null!=e&&e.type===_.y.MOVE||(t._updatingChanged(),t.map&&t.map.allLayers.forEach((async e=>{try{await e.when()}catch{}t._updatingChanged()})))};this.addHandles([(0,g.on)((()=>{var e;return null===(e=this.map)||void 0===e?void 0:e.allLayers}),"after-changes",(e=>i(e)),{onListenerAdd:()=>i(),onListenerRemove:()=>i(),sync:!0}),this.allLayerViews.on("after-changes",(e=>this._updateUpdatingMonitors(e))),(0,g.watch)((()=>this.map),(e=>{e&&"load"in e&&e.load&&e.load().catch((()=>{}))}))]),this.inputManager=new dl({view:this}),this.stateManager=new La({view:this})}initialize(){this.groundView=new J({view:this}),this._updateUpdatingMonitors();const e=()=>this._updateDefaultToMapOptions();this.addHandles((0,g.on)((()=>{var e;return null===(e=this.map)||void 0===e?void 0:e.allLayers}),"after-changes",e,{onListenerAdd:e,onListenerRemove:e})),this.updatingHandles.add((()=>this.qualitySettings.memoryLimit),(e=>{this.resourceController&&(this.resourceController.memoryController.maxMemory=e)}),g.initial),this.updatingHandles.add((()=>this.qualitySettings.additionalCacheMemory),(e=>{this.resourceController&&(this.resourceController.memoryController.additionalCacheMemory=e)}),g.initial),this.updatingHandles.add((()=>{var e;return null!==(e=this.qualitySettings.frameRate)&&void 0!==e?e:0}),(e=>(0,f.bP)(e>0?1e3/Math.ceil(e):0)),g.initial),this.updatingHandles.add((()=>{var e;return null===(e=this.map)||void 0===e?void 0:e.ground}),e,g.syncAndInitial),this.updatingHandles.add((()=>{var e;return null===(e=this.map)||void 0===e||null===(e=e.ground)||void 0===e?void 0:e.opacity}),(()=>this._updateDefaultHitTestOptions()),g.syncAndInitial),this.addHandles((0,g.watch)((()=>this.spatialReference),(()=>this.notifyChange("clippingArea")),g.sync))}destroy(){var e;this.destroyed||(this.updatingHandles.removeAll(),this.invalidate(),this.activeTool=null,this.layerViewManager.clear(),this._exitSurface(),this._disposeGraphicsView(),this.sharedSymbolResources=(0,p.SC)(this.sharedSymbolResources),this._set("labeler",(0,p.SC)(this.labeler)),this._set("deconflictor",(0,p.SC)(this.deconflictor)),this._resourceController=(0,p.SC)(this._resourceController),this._set("stateManager",(0,p.SC)(this.stateManager)),this._set("inputManager",(0,p.SC)(this.inputManager)),this.state.destroy(),this._propertiesPool.destroy(),this.removeHandles("updatingMonitors"),this._set("environmentManager",(0,p.SC)(this.environmentManager)),this._set("environment",(0,p.SC)(this.environment)),this.groundView=(0,p.SC)(this.groundView),this._exitBasemapTerrain(),null===(e=this._stage)||void 0===e||e.destroy())}get renderSpatialReference(){return this.renderCoordsHelper&&this.renderCoordsHelper.spatialReference}get basemapSpatialReference(){var e;return null===(e=this.basemapTerrain)||void 0===e?void 0:e.spatialReference}get animation(){var e;return null===(e=this.state)||void 0===e?void 0:e.animation}get camera(){var e;return null===(e=this.stateManager)||void 0===e?void 0:e.camera}set camera(e){this.stateManager&&(this.stateManager.camera=e)}get contentCamera(){var e;return null===(e=this.stateManager)||void 0===e?void 0:e.contentCamera}set contentCamera(e){this.stateManager&&(this.stateManager.contentCamera=e)}installContentCameraReset(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{sticky:!1};return this.stateManager.installContentCameraReset(e)}get center(){var e;return null===(e=this.stateManager)||void 0===e?void 0:e.center}set center(e){this.stateManager&&(this.stateManager.center=e)}get clippingArea(){if("global"===this.viewingMode)return null;const e=this.map;let t=this._userClippingArea||(0,p.aF)(e,"clippingArea");return!this._userClippingArea&&!(0,p.aF)(e,"clippingEnabled")||null==t?(this._clippingArea=null,null):t instanceof da.Z?this.spatialReference&&(t=xC(t,this.spatialReference),null==t)?(u.Z.getLogger(this).error("#clippingArea","setting clippingArea with incompatible SpatialReference"),this._clippingArea):(t=t.clone(),null==t.intersection(this._groundAndLayersExtent)&&(t.xmin=t.xmax,t.ymin=t.ymax),t.zmin=void 0,t.zmax=void 0,t.equals(this._clippingArea)||(this._clippingArea=t),this._clippingArea):(u.Z.getLogger(this).error("#clippingArea","only clippingArea geometries of type Extent are supported"),this._clippingArea)}set clippingArea(e){this.ready&&"global"===this.viewingMode&&null!=e?u.Z.getLogger(this).error("#clippingArea=","Clipping area is only supported in local viewingMode"):this._userClippingArea=e}get renderDataExtent(){if(this.state.viewingMode===te.JY.Global)return null;const e=this.renderSpatialReference,t=this.dataExtent;return null==t||null==e||t.spatialReference.equals(e)?t:xC(t,e)}get tileInfo(){var e;return null===(e=this.basemapTerrain)||void 0===e||null===(e=e.tilingScheme)||void 0===e?void 0:e.toTileInfo()}get dataExtent(){let e=this._groundAndLayersExtent;const t=this.spatialReference||k.Z.WGS84,i=xC(this.clippingArea,t);null!=i&&(e=null!=e?e.intersection(i):i);const n=this._get("dataExtent");return null!=e&&e.equals(n)?n:e}get _groundAndLayersExtent(){var e,t;const i=this.spatialReference||k.Z.WGS84;let n;const r=e=>{const t=xC(e,i);null!=t&&(null!=n?n.union(t):n=t.clone())},s=this.basemapTerrain;if(null!==s&&void 0!==s&&s.spatialReference){const e=s.groundExtent;r(new da.Z({xmin:e[0],ymin:e[1],zmin:0,xmax:e[2],ymax:e[3],zmax:0,spatialReference:s.spatialReference}))}if(this.map){const e=e=>{null==e.fullExtent||"graphics"===e.type&&e.internal||r(e.fullExtent)};this.map.allLayers.forEach((t=>e(t)))}if(null==n)return null;n.hasZ?(n.zmin=Math.min(0,null!==(e=n.zmin)&&void 0!==e?e:0),n.zmax=Math.max(0,null!==(t=n.zmax)&&void 0!==t?t:0)):(n.zmin=0,n.zmax=0);const a=this._get("_groundAndLayersExtent");return n.equals(a)?a:n}castEnvironment(e){var t,i;return e?e instanceof qe?e:e instanceof Ue.Z?null!==(t=null===(i=this.environment)||void 0===i?void 0:i.cloneWithWebsceneEnvironment(e))&&void 0!==t?t:qe.fromWebsceneEnvironment(e):(0,x.se)(qe,e):new qe}get extent(){var e;return null===(e=this.stateManager)||void 0===e?void 0:e.extent}set extent(e){this.stateManager&&(this.stateManager.extent=e)}get screenCenter(){var e;return null===(e=this.stateManager)||void 0===e?void 0:e.screenCenter}get frustum(){var e;return null===(e=this.stateManager)||void 0===e?void 0:e.frustum}get initialExtentRequired(){return this.stateManager&&!this.stateManager.hasInitialView}get _defaultsFromMapSettings(){return{required:{tileInfo:!1,heightModelInfo:!0,extent:!1}}}get interacting(){var e,t;return this.navigating||null!==(e=null===(t=this.toolViewManager)||void 0===t?void 0:t.interacting)&&void 0!==e&&e}get stationary(){return!this.animation&&!this.resizing&&(null==this.state||this.state.stationary)}get navigating(){var e,t;return null!==(e=null===(t=this.state)||void 0===t?void 0:t.navigating)&&void 0!==e&&e}get padding(){var e;return null===(e=this.stateManager)||void 0===e?void 0:e.padding}set padding(e){this.stateManager&&(this.stateManager.padding=e)}set qualityProfile(e){ad.isValidProfile(e)&&(ad.apply(e,this.qualitySettings),this._set("qualityProfile",e))}get qualityProfile(){return this._get("qualityProfile")||ad.getDefaultProfile()}set slicePlane(e){if(null!=this._stage&&this._stage.renderer.setParameters({slicePlane:e}),null==e)return void this._set("slicePlane",null);const t=this._propertiesPool.get("slicePlane");(0,N.c)(e,t),this._set("slicePlane",t)}get typeSpecificPreconditionsReady(){var e;return!!this.viewingMode&&!(null===(e=this.stateManager)||void 0===e||!e.preinit(this.spatialReference))}get resolution(){return null!=this.spatialReference?(0,H.dp)(this.scale,this.spatialReference):0}get scale(){var e;return null===(e=this.stateManager)||void 0===e?void 0:e.scale}set scale(e){this.stateManager&&(this.stateManager.scale=e)}get terrainScale(){var e;return null===(e=this.stateManager)||void 0===e?void 0:e.terrainScale}get heightModelInfo(){const e=this.getDefaultHeightModelInfo();return null!=e?O.Z.deriveUnitFromSR(e,this.spatialReference):null}get updating(){var e,t,i;if(this.destroyed)return!1;let n=0,r=this.layerViewManager.updating,s=r?this.layerViewManager.updatingRemaining:0;this.allLayerViews.forEach((e=>{if(e.isFulfilled()){if(e.updating){if(r=!0,e.suspended||(0,np.wP)(e))return;++s,n+=e.updatingProgress}}else++s}));for(const o of this._updatingObjects)if(null!=o&&o.updating){const e=.1;s+=e,n+=.5*e}for(const o of this._updatingObjectsWithProgress)null!=o&&o.updating&&(++s,n+=o.updatingProgress);const a=!this.stateManager.test.updatingIgnoreRenderState&&this.state.updating;if(r=!!(r||s>0||this.updatingHandles.updating||!this.ready||!this.stationary||a||this._createGraphicsViewController||null!==(e=this.inputManager)&&void 0!==e&&e.updating||null!==(t=this.map)&&void 0!==t&&null!==(t=t.allLayers)&&void 0!==t&&t.some((e=>!e.isFulfilled()))||null!==(i=this.textures)&&void 0!==i&&i.updating),r?(this._numUpdating=Math.max(s,this._numUpdating),n+=this._numUpdating-s):this._numUpdating=0,this._numUpdating>0?n/=this._numUpdating:n=r?0:1,this._get("updatingProgress")!==n){const e=performance.now();if(n<1){const t=Math.min((e-this._lastUpdateTime)/2e3,1);n=this.updatingProgress*(1-t)+n*t}this._set("updatingProgress",n),this._lastUpdateTime=r&&n<1?e:0}return r}get _updatingObjects(){return[this.graphicsView,this.basemapView,this._resourceController,this._stage,this.featureTiles,this.pointsOfInterest,this.environmentManager,this.overlay,this._featureTreeDebugger,this.toolViewManager,this.analysisViewManager]}get _updatingObjectsWithProgress(){return[this.deconflictor,this.labeler,this.basemapTerrain]}get viewingMode(){var e;const t=this._predeterminedViewingMode;if(null!=t)return(0,te.M7)(t);const i=this.spatialReference;return i?null!=(null===(e=this.defaultsFromMap)||void 0===e?void 0:e.viewingMode)&&i.equals(this.defaultsFromMap.spatialReference)?(0,te.M7)(this.defaultsFromMap.viewingMode):(0,fC.D)(i,te.JY.Global)?"global":"local":"global"}set viewingMode(e){this.ready?u.Z.getLogger(this).error("#viewingMode","viewingMode cannot be set once view is ready"):this._overrideIfSome("viewingMode",e)}get viewpoint(){var e;return null===(e=this.stateManager)||void 0===e?void 0:e.viewpoint}set viewpoint(e){this.stateManager&&(this.stateManager.viewpoint=e)}get zoom(){return this.stateManager.zoom}set zoom(e){this.stateManager&&(this.stateManager.zoom=e)}get resourceController(){return this._resourceController}get quality(){var e,t;return null!==(e=null===(t=this._resourceController)||void 0===t||null===(t=t.memoryController)||void 0===t?void 0:t.memoryFactor)&&void 0!==e?e:1}get resolutionScale(){return Math.sqrt(Math.min(1,this.quality/.75))}get performanceInfo(){return new Yd(this)}on(e,t,i,n){return this.viewEvents.on(e,t,i,n)||super.on(e,t)}hasEventListener(e){return super.hasEventListener(e)||this.viewEvents.hasHandler(e)}toMap(e,t){if(!this.ready)return u.Z.getLogger(this).error("#toMap()","Scene view cannot be used before it is ready"),null;const i=(0,gC.Rw)(e)?(0,gC.s6)(this,e):e;return(0,Vc.qL)(this,i,t,this._defaultToMapOptions)}toScreen(e){var t;if(!this.ready)return u.Z.getLogger(this).error("#toScreen()","Scene view cannot be used before it is ready"),null;const i=null!==(t=null==e.z?(0,od.KO)(this.elevationProvider,e):null)&&void 0!==t?t:0;return(0,I.K)(e,TC,this.renderSpatialReference,i),this.state.camera.projectToScreen(TC,SC),(0,v.vW)(SC[0],SC[1])}pixelSizeAt(e){return this.ready?e?((0,I.K)(e,TC,this.renderSpatialReference),this.state.camera.computeScreenPixelSizeAt(TC)):0:(u.Z.getLogger(this).error("#pixelSizeAt()","Scene view cannot be used before it is ready"),null)}overlayPixelSizeInMapUnits(e){const t=this.basemapTerrain.overlayManager;return t?t.overlayPixelSizeInMapUnits(e,(()=>this.pixelSizeAt(e))):1}hitTest(e,t){if(!this.ready)return u.Z.getLogger(this).error("#hitTest()","Scene view cannot be used before it is ready"),null;const i=(0,gC.Rw)(e)?(0,gC.s6)(this,e):e;return(0,Vc.wX)(this,i,t,this._defaultHitTestOptions)}async popupHitTest(e){return bd(this,e)}goTo(e,t){return this.updatingHandles.addPromise(this.stateManager.goTo(e,t))}async whenAnalysisView(e){if(null==e.parent)throw new l.Z("view:no-analysisview-for-analysis","The analysis has not been added to view.analyses",{analysis:e});switch(e.parent.type){case"line-of-sight":case"dimension":return(await this.whenLayerView(e.parent)).whenAnalysisView();default:return this.analysisViewManager.whenAnalysisView(e)}}whenLayerView(e){return super.whenLayerView(e)}async takeScreenshot(e){const t=this._completeSettings(e);await this.whenReady();const i=await this._stage.renderView.takeScreenshot(t);return(0,aC.cv)(i,t,this._pixelFormat())}async _takeScreenshot(e){const t=this._completeSettings(e);await this.whenReady();const i=await this._stage.renderView.takeScreenshot(t);return(0,aC.v8)(i,this._pixelFormat())}async _takeScreenshotWithObjectAndLayerId(e){const t=this._completeSettings(e);await this.whenReady();const i=await this._stage.renderView.takeScreenshotWithOID(t);return[(0,aC.v8)(i[0],this._pixelFormat()),(0,aC.v8)(i[1],this._pixelFormat())]}_completeSettings(e){const t=(0,aC.uz)(e,this);return t.pixelRatio/=this.state.pixelRatio,(0,aC.$3)(t,this.supersampleScreenshotsEnabled,this.padding)}_pixelFormat(){return{flipY:!0,premultipliedAlpha:this._stage.renderView.getAlpha()}}get test(){}async takeScreenshotWithObjectAndLayerId(e){if(!(0,d.Z)("enable-feature:objectAndLayerId-rendering"))throw new Error("has enable-feature:objectAndLayerId-rendering must be true");const t=this._completeSettings(e);await this.whenReady();const i=await this._stage.renderView.takeScreenshotWithOID(t),n=(0,aC.cv)(i[0],t,this._pixelFormat()),r=this._completeSettings(e);return r.format="png",[n,(0,aC.cv)(i[1],r,this._pixelFormat())]}getColorToObjectAndLayerIdMapping(){if(null==this._stage.renderView.objectAndLayerIdRenderHelper)throw new Error("has enable-feature:objectAndLayerId-rendering must be true");return this._stage.renderView.objectAndLayerIdRenderHelper.getColorToObjectAndLayerIdMapping()}addUpdatingPromise(e){return this.updatingHandles.addPromise(e)}importLayerView(e){return ae(e)}hasLayerViewModule(e){return se(e)}forceDOMReadyCycle(){this.forceReadyCycle()}getDefaultSpatialReference(){var e,t,i;return this.map&&"initialViewProperties"in this.map&&(null===(e=this.map.initialViewProperties)||void 0===e?void 0:e.spatialReference)||(null===(t=this.defaultsFromMap)||void 0===t?void 0:t.spatialReference)||(null===(i=this.defaultsFromMap)||void 0===i?void 0:i.ready)&&this._initialDefaultSpatialReference||null}async validate(){let e=(0,vC.B)(this.type);const t=(0,d.Z)("safari");if(t&&t<9&&(e=new l.Z("sceneview:browser-not-supported","This browser is not supported by SceneView (Safari < 9)",{type:"safari",requiredVersion:9,detectedVersion:t})),null!=e)throw u.Z.getLogger(this).warn("#validate()",e.message),e}get _predeterminedViewingMode(){var e,t;const i=this._isOverridden("viewingMode")?this._get("viewingMode"):null!==(e=this.map&&"initialViewProperties"in this.map?null===(t=this.map.initialViewProperties)||void 0===t?void 0:t.viewingMode:null)&&void 0!==e?e:null;return null!=i?(0,te.wg)(i):null}getSpatialReferenceSupport(e,t){const i=this._predeterminedViewingMode;if(null!=i)return this._validateSpatialReferenceForViewingMode(e,t,i)?{constraints:this._makeSpatialReferenceConstraints(e,t,i)}:null;const n=this._validateSpatialReferenceForViewingMode(e,t,te.JY.Local),r=this._validateSpatialReferenceForViewingMode(e,t,te.JY.Global);return n||r?n&&r?{constraints:this._makeSpatialReferenceConstraints(e,t,null)}:n?{constraints:this._makeSpatialReferenceConstraints(e,t,te.JY.Local)}:{constraints:this._makeSpatialReferenceConstraints(e,t,te.JY.Global)}:null}_validateSpatialReferenceForViewingMode(e,t,i){return!!(0,fC.D)(e,i)&&(null==t||!!(0,F.Am)(t)||(!(0,F.iC)(t)||null!=(0,np.E_)(t,e,i))&&(!(0,F.Tv)(t)||i!==te.JY.Global))}_makeSpatialReferenceConstraints(e,t,i){if(null==t)return[{spatialReference:e,viewingMode:i}];const{isWebMercator:n,isWGS84:r}=e;return(0,F.Am)(t)&&(n||r)?r&&i!==te.JY.Local&&null!==(0,np.er)(t.tileInfo,t.fullExtent,e,te.JY.Global)?[{spatialReference:n?k.Z.WGS84:k.Z.WebMercator,viewingMode:i}]:[{spatialReference:e,viewingMode:i},{spatialReference:k.Z.WebMercator,viewingMode:i}]:(0,F.iC)(t)||(0,F.Tv)(t)||!n&&!r?(0,F.iC)(t)&&n&&i!==te.JY.Global?[{spatialReference:e,viewingMode:i},{spatialReference:k.Z.WGS84,viewingMode:te.JY.Local}]:[{spatialReference:e,viewingMode:i}]:[{spatialReference:e,viewingMode:i},{spatialReference:n?k.Z.WGS84:k.Z.WebMercator,viewingMode:i}]}_validateSpatialReference(e){const t=null!=this.getSpatialReferenceSupport(e),i=this._predeterminedViewingMode;return t||(null!=i?u.Z.getLogger(this).warnOnce("Spatial reference defined on view not supported in ".concat((0,te.M7)(i)," viewing mode.")):e.isGeographic&&u.Z.getLogger(this).warnOnce("Spatial reference is geographic but not supported.")),t}whenReady(){return new Promise((e=>{this.ready?e(this):this._resolveWhenReady.push(e)}))}trackGraphicState(e){if(!e.graphic)return u.Z.getLogger(this).error("trackGraphicState","GraphicState.graphic must not be null or undefined to start tracking"),null;const t=this.getViewForGraphic(e.graphic);let i=null,n=!1;const r=t=>{var r;!n&&null!=t&&"processor"in t&&"graphics-3d"===(null===(r=t.processor)||void 0===r?void 0:r.type)&&t.processor.graphicsCore&&(i=t.processor.graphicsCore.trackGraphicState(e))};return null!=t?r(t):this.whenViewForGraphic(e.graphic,{waitForLayer:!0}).then((e=>r(e)),(()=>{})).catch((()=>{})),(0,c.kB)((()=>{n=!0,null!=i&&(i.remove(),i=null)}))}highlight(e){if(Array.isArray(e))return(0,c.AL)(e.map((e=>this.highlight(e))));if(a.Z.isCollection(e))return(0,c.AL)(e.toArray().map((e=>this.highlight(e))));const t=this.getViewForGraphic(e);return t&&"highlight"in t?t.highlight(e):(0,c.kB)()}maskOccludee(e){if(!e)return u.Z.getLogger(this).error("maskOccludee","GraphicState.graphic must not be null or undefined to mask an occludee"),null;const t=this.getViewForGraphic(e);let i=null,n=!1;const r=t=>{!n&&null!=t&&(0,mC._1)(t)&&(i=t.maskOccludee(e))};return null!=t?r(t):this.whenViewForGraphic(e,{waitForLayer:!0}).then((e=>r(e)),(()=>{})).catch((()=>{})),(0,c.kB)((()=>{n=!0,null!=i&&(i.remove(),i=null)}))}getViewForGraphic(e){return e.layer===this.graphics?this.graphicsView:e.layer?this.allLayerViews.find((t=>t.layer===e.layer)):null}graphicChanged(e){null!=this.graphicsView&&this.graphicsView.graphicChanged(e)}async whenViewForGraphic(e,t){if(e.layer===this)return await(0,g.whenOnce)((()=>this.graphicsView)),this.graphicsView;if(!e.layer||!this.map)throw new l.Z("no-view-for-graphic");return t&&t.waitForLayer&&!this.map.allLayers.includes(e.layer)?new Promise(((t,i)=>{const n=this.map.allLayers.on("change",(r=>{r.added.includes(e.layer)&&(n.remove(),this.whenLayerView(e.layer).then(t,i))}))})):this.whenLayerView(e.layer)}_initBasemapTerrain(){this._set("basemapTerrain",new nf({view:this})),this._set("elevationProvider",new td({view:this})),this.elevationProvider.register("ground",this.basemapTerrain)}_exitBasemapTerrain(){this.basemapTerrain&&(this.elevationProvider.unregister(this.basemapTerrain),this.elevationProvider.destroy(),this._set("elevationProvider",null),this.basemapTerrain.destroy(),this._set("basemapTerrain",null))}_initGlobe(){this._initCoordinateSystem(),this.state.createInitialCamera(),this._initBasemapTerrain(),this._set("pointsOfInterest",new qu({view:this})),this._set("featureTiles",new Ac({renderCoordsHelper:this.renderCoordsHelper,cameraOnSurface:this.pointsOfInterest.cameraOnSurface,focus:this.pointsOfInterest.focus,tilingSchemeOwner:this.basemapTerrain,viewState:this.state,scheduler:this._resourceController.scheduler,terrain:this.basemapTerrain}));const e=()=>{var e;const t=null===(e=this.basemapTerrain)||void 0===e?void 0:e.extent;if(this.clippingArea||t)if(t&&this.basemapTerrain.spatialReference){const e=null!=this.basemapTerrain.extent&&null!=this.basemapTerrain.spatialReference?(0,E.project)((0,L.HH)(this.basemapTerrain.extent,this.basemapTerrain.spatialReference),this.spatialReference):null;null!=this.clippingArea?this.featureTiles.filterExtent=this.clippingArea.intersection(e):this.featureTiles.filterExtent=e}else this.featureTiles.filterExtent=this.clippingArea;else this.featureTiles.filterExtent=null};this.addHandles([this.updatingHandles.add((()=>_l.h.FEATURE_TILE_TREE_SHOW_TILES),(e=>{e&&this.featureTiles&&!this._featureTreeDebugger?this.updatingHandles.addPromise(i.e(76077).then(i.bind(i,76077))).then((e=>{let{FeatureTileTree3DDebugger:t}=e;!this._featureTreeDebugger&&_l.h.FEATURE_TILE_TREE_SHOW_TILES&&(this._featureTreeDebugger=new t({view:this}))})):e||!this._featureTreeDebugger||_l.h.FEATURE_TILE_TREE_SHOW_TILES||(this._featureTreeDebugger.destroy(),this._featureTreeDebugger=null)}),g.syncAndInitial),this.updatingHandles.add((()=>this.clippingArea),e,g.syncAndInitial),this.updatingHandles.add((()=>this.basemapTerrain.extent),e,g.syncAndInitial)],"feature-tiles"),this.stateManager.init()}_exitGlobe(){this.state&&(this.stateManager.exit(),this.removeHandles("render-coords-helper"),this.removeHandles("feature-tiles"),this.featureTiles.destroy(),this._set("featureTiles",null),this.pointsOfInterest.destroy(),this._set("pointsOfInterest",null),this._exitBasemapTerrain(),this.state.exit(),this._exitCoordinateSystem())}_initCoordinateSystem(){if(this.spatialReference){const e=this.spatialReference;this.mapCoordsHelper&&this.mapCoordsHelper.spatialReference.equals(e)||this._set("mapCoordsHelper",new fd(this.map,e));const t=this.state.isGlobal,i=(0,U.E2)(t,e);i!==this.renderSpatialReference&&(this._set("renderCoordsHelper",Ad.Z.create(this.state.viewingMode,i)),t||this.addHandles((0,g.watch)((()=>{var e;return null===(e=this.basemapTerrain)||void 0===e?void 0:e.extent}),(e=>{const t=this.renderCoordsHelper.spatialReference;null==e||0===e[0]&&0===e[1]&&0===e[2]&&0===e[3]||!(0,D.d)(e,this.basemapTerrain.spatialReference,PC,t)||(this.renderCoordsHelper.extent=PC)}),g.sync),"render-coords-helper"),this.sceneIntersectionHelper&&this.sceneIntersectionHelper.setTolerance(Dr.jb/this.renderCoordsHelper.unitInMeters))}else this._set("mapCoordsHelper",null),this._set("renderCoordsHelper",null)}_exitCoordinateSystem(){this.mapCoordsHelper&&(this.removeHandles("render-coords-helper"),this._set("renderCoordsHelper",null),this._set("mapCoordsHelper",null))}_updatingChanged(){this.notifyChange("updating")}_updateUpdatingMonitors(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null;null!=e&&e.type===_.y.MOVE||(this.removeHandles("updatingMonitors"),this.allLayerViews.forEach((e=>{e.destroyed||(this.addHandles((0,g.watch)((()=>[e.updating,e.updatingProgress]),(()=>this._updatingChanged()),g.sync),"updatingMonitors"),e.when((()=>this._updatingChanged()),(()=>this._updatingChanged())))})),this._updatingChanged())}async _prepareScreenshotOverlay(){this.overlay&&await this.overlay.prepare()}_renderScreenshotOverlay(e,t,i){if(!this.overlay||!this.overlay.hasVisibleItems)return i;const n=e.getContext("2d");return n.putImageData(i,0,0),this.overlay.renderCanvas(e,{disableDecorations:t===dp.Iq.OFF}),n.getImageData(0,0,i.width,i.height)}_initStage(){const e={deactivatedWebGLExtensions:this.deactivatedWebGLExtensions,debugWebGLExtensions:this.debugWebGLExtensions,alpha:this.alphaCompositingEnabled,preserveDrawingBuffer:this.preserveDrawingBufferEnabled,canvas:this.renderCanvas,screenshot:{prepareOverlay:()=>this._prepareScreenshotOverlay(),renderOverlay:(e,t,i)=>this._renderScreenshotOverlay(e,t,i)}},t=new Bc(this.state.viewingMode,(e=>this._stage.layers.forAll(e)),this);this._set("sceneIntersectionHelper",t);const i=(0,o.L7)(this.surface);this._stage=new _C({view:this,options:e,container:i}),this._stage.renderer.setParameters({slicePlane:this.slicePlane}),this.addHandles([this.updatingHandles.add((()=>this.qualitySettings.highQualityTransparency),(e=>this._stage.renderer.setParameters({highQualityTransparency:e})),g.initial),this.on("pointer-move",(()=>{var e;return null===(e=this._stage)||void 0===e?void 0:e.renderer.resetAnimation()})),(0,h.on)(this._stage.renderView.canvas,"webglcontextlost",(e=>{this.fatalError=new l.Z("webgl-context-lost",e.statusMessage)}))],"stage"),this.renderCoordsHelper&&this.sceneIntersectionHelper.setTolerance(Dr.jb/this.renderCoordsHelper.unitInMeters),this._set("canvas",this._stage.renderView.canvas)}_exitStage(){this._set("sceneIntersectionHelper",null),this._stage=(0,p.SC)(this._stage),this.removeHandles("stage"),this._set("canvas",null)}_initSurface(e){this._exitSurface(),this.state.init(e,this.spatialReference),this._initStage(),this._initGlobe(),this.sharedSymbolResources=new lu({view:this,viewingMode:e,resourceController:this._resourceController,pointsOfInterest:this.pointsOfInterest,viewState:this.state})}_exitSurface(){this.sharedSymbolResources&&(this.sharedSymbolResources.objectResourceCache.destroy(),this.sharedSymbolResources.destroy(),this.sharedSymbolResources=null,this._exitGlobe(),this._exitStage())}_createGraphicsViewIfNeeded(){if(this.graphicsView||this._createGraphicsViewController)return;if(0===this.graphics.length)return;this.removeHandles("graphics-view"),this._createGraphicsViewController=new AbortController;const e=()=>{this._createGraphicsViewController=null,this._updatingChanged()};this._createGraphicsViewAsync(this._createGraphicsViewController.signal).then(e,e),this._updatingChanged()}async _createGraphicsViewAsync(e){const t=(await Promise.all([i.e(50489),i.e(76913)]).then(i.bind(i,73364))).default;(0,m.k_)(e),await(0,g.whenOnce)((()=>{var e;return null===(e=this.basemapTerrain)||void 0===e?void 0:e.ready}),e),this._set("graphicsView",new t({view:this}))}_disposeGraphicsView(){this._createGraphicsViewController&&(this._createGraphicsViewController.abort(),this._createGraphicsViewController=null),this.removeHandles("graphics-view"),null!=this.graphicsView&&(this.removeHandles(this.graphicsView.processor.layer.id),this.graphicsView.destroy(),this._set("graphicsView",null))}_startup(){const e=(0,te.wg)(this.viewingMode);e===te.JY.Global&&(this._clippingArea=null),this._initSurface(e),this._set("ready",!0),this.addHandles((0,g.on)((()=>this.graphics),"after-changes",(()=>this._createGraphicsViewIfNeeded())),"graphics-view"),this._createGraphicsViewIfNeeded();const t=this.map&&"initialViewProperties"in this.map?this.map.initialViewProperties:null,i=null===t||void 0===t?void 0:t.environment;i&&M(this.environment,i),this.timeExtent=null===t||void 0===t?void 0:t.timeExtent,this.labeler.setup(),this.environmentManager.connectView(this),this.inputManager.connect(),this._set("textures",new nu(this._stage,this.resourceController.scheduler));const n=this._resolveWhenReady;this._resolveWhenReady=[],n.forEach((e=>e(this)))}_teardown(){this._initialDefaultSpatialReference=null,this.inputManager.disconnect(),this.environmentManager.disconnectView(),this.labeler.dispose(),this._disposeGraphicsView(),this.removeHandles("graphics-view"),this._set("textures",(0,p.SC)(this.textures)),this._exitSurface(),this._set("ready",!1)}_updateDefaultToMapOptions(){if(this._defaultToMapOptions.include.clear(),this.map){this.map.ground&&this._defaultToMapOptions.include.add(Jr.xX);for(const e of this.map.allLayers.items)(0,F.nx)(e.type)&&this._defaultToMapOptions.include.add(e.uid)}}_updateDefaultHitTestOptions(){if(this._defaultHitTestOptions.exclude.clear(),this.map){this.map.ground&&this.map.ground.opacity<1&&this._defaultHitTestOptions.exclude.add(Jr.xX);for(const e of this.map.allLayers.items)(0,F.nx)(e.type)&&e.opacity<1&&this._defaultHitTestOptions.exclude.add(e.uid)}}};function xC(e,t){return null!=e&&(0,E.canProjectWithoutEngine)(e.spatialReference,t)?(0,E.project)(e,t):null}CC.type="3d",(0,n._)([(0,b.Cb)()],CC.prototype,"_userClippingArea",void 0),(0,n._)([(0,b.Cb)()],CC.prototype,"_resourceController",void 0),(0,n._)([(0,b.Cb)()],CC.prototype,"_stage",void 0),(0,n._)([(0,b.Cb)({readOnly:!0})],CC.prototype,"deconflictor",void 0),(0,n._)([(0,b.Cb)({readOnly:!0})],CC.prototype,"labeler",void 0),(0,n._)([(0,b.Cb)((0,A.z)(V.J,"analyses"))],CC.prototype,"analyses",void 0),(0,n._)([(0,b.Cb)({type:ee.Z,readOnly:!0})],CC.prototype,"animation",null),(0,n._)([(0,b.Cb)({readOnly:!0})],CC.prototype,"basemapTerrain",void 0),(0,n._)([(0,b.Cb)({readOnly:!0})],CC.prototype,"elevationProvider",void 0),(0,n._)([(0,b.Cb)()],CC.prototype,"camera",null),(0,n._)([(0,b.Cb)({type:r.Z})],CC.prototype,"contentCamera",null),(0,n._)([(0,b.Cb)({readOnly:!0})],CC.prototype,"canvas",void 0),(0,n._)([(0,b.Cb)({type:ua.Z})],CC.prototype,"center",null),(0,n._)([(0,b.Cb)({type:da.Z})],CC.prototype,"clippingArea",null),(0,n._)([(0,b.Cb)({type:Me})],CC.prototype,"constraints",void 0),(0,n._)([(0,b.Cb)({type:da.Z,readOnly:!0})],CC.prototype,"renderDataExtent",null),(0,n._)([(0,b.Cb)({readOnly:!0})],CC.prototype,"tileInfo",null),(0,n._)([(0,b.Cb)({type:da.Z,readOnly:!0})],CC.prototype,"dataExtent",null),(0,n._)([(0,b.Cb)({type:da.Z,readOnly:!0})],CC.prototype,"_groundAndLayersExtent",null),(0,n._)([(0,b.Cb)({type:qe})],CC.prototype,"environment",void 0),(0,n._)([(0,w.p)("environment")],CC.prototype,"castEnvironment",null),(0,n._)([(0,b.Cb)({readOnly:!0})],CC.prototype,"environmentManager",void 0),(0,n._)([(0,b.Cb)({type:da.Z})],CC.prototype,"extent",null),(0,n._)([(0,b.Cb)()],CC.prototype,"floors",void 0),(0,n._)([(0,b.Cb)()],CC.prototype,"screenCenter",null),(0,n._)([(0,b.Cb)()],CC.prototype,"frustum",null),(0,n._)([(0,b.Cb)({type:Number,readOnly:!0})],CC.prototype,"fullOpacity",void 0),(0,n._)([(0,b.Cb)({readOnly:!0})],CC.prototype,"graphicsView",void 0),(0,n._)([(0,b.Cb)({readOnly:!0})],CC.prototype,"analysisViewManager",void 0),(0,n._)([(0,b.Cb)()],CC.prototype,"groundView",void 0),(0,n._)([(0,b.Cb)({type:Boolean})],CC.prototype,"initialExtentRequired",null),(0,n._)([(0,b.Cb)()],CC.prototype,"_defaultsFromMapSettings",null),(0,n._)([(0,b.Cb)()],CC.prototype,"interacting",null),(0,n._)([(0,b.Cb)()],CC.prototype,"stationary",null),(0,n._)([(0,b.Cb)()],CC.prototype,"navigating",null),(0,n._)([(0,b.Cb)()],CC.prototype,"map",void 0),(0,n._)([(0,b.Cb)({readOnly:!0})],CC.prototype,"mapCoordsHelper",void 0),(0,n._)([(0,b.Cb)()],CC.prototype,"padding",null),(0,n._)([(0,b.Cb)({type:qu,readOnly:!0})],CC.prototype,"pointsOfInterest",void 0),(0,n._)([(0,b.Cb)({type:Ac,readOnly:!0})],CC.prototype,"featureTiles",void 0),(0,n._)([(0,b.Cb)()],CC.prototype,"_featureTreeDebugger",void 0),(0,n._)([(0,b.Cb)({type:Boolean})],CC.prototype,"screenSizePerspectiveEnabled",void 0),(0,n._)([(0,b.Cb)({constructOnly:!0})],CC.prototype,"deactivatedWebGLExtensions",void 0),(0,n._)([(0,b.Cb)({constructOnly:!0})],CC.prototype,"debugWebGLExtensions",void 0),(0,n._)([(0,b.Cb)({constructOnly:!0})],CC.prototype,"renderCanvas",void 0),(0,n._)([(0,b.Cb)({constructOnly:!0})],CC.prototype,"state",void 0),(0,n._)([(0,b.Cb)({readOnly:!0})],CC.prototype,"inputManager",void 0),(0,n._)([(0,b.Cb)({readOnly:!0})],CC.prototype,"stateManager",void 0),(0,n._)([(0,b.Cb)({type:["low","medium","high"]})],CC.prototype,"qualityProfile",null),(0,n._)([(0,b.Cb)({type:Rd,get(){let e=this._get("qualitySettings");return e||(e=new Rd,ad.apply(this.qualityProfile,e)),e}})],CC.prototype,"qualitySettings",void 0),(0,n._)([(0,b.Cb)()],CC.prototype,"slicePlane",null),(0,n._)([(0,b.Cb)({readOnly:!0})],CC.prototype,"typeSpecificPreconditionsReady",null),(0,n._)([(0,b.Cb)({readOnly:!0})],CC.prototype,"renderCoordsHelper",void 0),(0,n._)([(0,b.Cb)({readOnly:!0})],CC.prototype,"sceneIntersectionHelper",void 0),(0,n._)([(0,b.Cb)({type:Number,dependsOn:["scale","spatialReference"],readOnly:!0})],CC.prototype,"resolution",null),(0,n._)([(0,b.Cb)({type:Number})],CC.prototype,"scale",null),(0,n._)([(0,b.Cb)()],CC.prototype,"heightModelInfo",null),(0,n._)([(0,b.Cb)()],CC.prototype,"spatialReference",void 0),(0,n._)([(0,b.Cb)({type:Boolean,constructOnly:!0})],CC.prototype,"alphaCompositingEnabled",void 0),(0,n._)([(0,b.Cb)({constructOnly:!0})],CC.prototype,"preserveDrawingBufferEnabled",void 0),(0,n._)([(0,b.Cb)({type:Boolean})],CC.prototype,"supersampleScreenshotsEnabled",void 0),(0,n._)([(0,b.Cb)({readOnly:!0})],CC.prototype,"type",void 0),(0,n._)([(0,b.Cb)(),(0,w.p)((e=>e instanceof yC.Z?e:(0,x.TJ)(wC,e)))],CC.prototype,"ui",void 0),(0,n._)([(0,b.Cb)({type:Boolean,readOnly:!0,dependsOn:["graphicsView.updating","basemapView.updating","basemapTerrain.updating","layerViewManager.updating","layerViewManager.updatingRemaining","_resourceController.updating","_stage.updating","featureTiles.updating","pointsOfInterest.updating","environmentManager.updating","overlay.updating","updatingHandles.updating","featureTreeDebugger.updating","labeler.updating","deconflictor.updating","ready","stationary","inputManager.updating","toolViewManager.updating","analysisViewManager.updating","state.updating","textures.updating"]})],CC.prototype,"updating",null),(0,n._)([(0,b.Cb)()],CC.prototype,"_updatingObjects",null),(0,n._)([(0,b.Cb)()],CC.prototype,"_updatingObjectsWithProgress",null),(0,n._)([(0,b.Cb)({type:Number,readOnly:!0,dependsOn:["updating"]})],CC.prototype,"updatingProgress",void 0),(0,n._)([(0,b.Cb)({type:["global","local"]})],CC.prototype,"viewingMode",null),(0,n._)([(0,b.Cb)({type:s.Z})],CC.prototype,"viewpoint",null),(0,n._)([(0,b.Cb)({type:Number})],CC.prototype,"zoom",null),(0,n._)([(0,b.Cb)({type:ud})],CC.prototype,"highlightOptions",void 0),(0,n._)([(0,b.Cb)({readOnly:!0})],CC.prototype,"quality",null),(0,n._)([(0,b.Cb)({readOnly:!0})],CC.prototype,"resolutionScale",null),(0,n._)([(0,b.Cb)()],CC.prototype,"textures",void 0),CC=(0,n._)([(0,C.j)("esri.views.SceneView")],CC);const TC=(0,R.Ue)(),SC=(0,v.s1)(),PC=(0,L.Ue)(),MC=CC},4583:(e,t,i)=>{i.d(t,{e:()=>s});var n=i(66978),r=i(38330);async function s(e){const t=i.e(83581).then(i.bind(i,83581)),s=i.e(78938).then(i.bind(i,78938)),a=(0,r.t)((await t).default,{signal:e}),o=(0,r.t)((await s).default,{signal:e}),l={mask:await a,overlay:await o};return(0,n.k_)(e),l}},78738:(e,t,i)=>{i.d(t,{J:()=>n});class n{constructor(e){this._gain=e,this.lastValue=void 0,this.filteredDelta=void 0}update(e){if(this.hasLastValue()){const t=this.computeDelta(e);this._updateDelta(t)}this.lastValue=e}reset(){this.lastValue=void 0,this.filteredDelta=void 0}hasLastValue(){return void 0!==this.lastValue}hasFilteredDelta(){return void 0!==this.filteredDelta}computeDelta(e){return void 0===this.lastValue?NaN:e-this.lastValue}_updateDelta(e){void 0!==this.filteredDelta?this.filteredDelta=(1-this._gain)*this.filteredDelta+this._gain*e:this.filteredDelta=e}}},99742:(e,t,i)=>{i.d(t,{X:()=>n});class n{constructor(e,t,i){this._initialVelocity=e,this._stopVelocity=t,this._friction=i,this._duration=Math.abs(Math.log(Math.abs(this._initialVelocity)/this._stopVelocity)/Math.log(1-this._friction))}get duration(){return this._duration}isFinished(e){return e>this.duration}get friction(){return this._friction}value(e){return this.valueFromInitialVelocity(this._initialVelocity,e)}valueDelta(e,t){const i=this.value(e);return this.value(e+t)-i}valueFromInitialVelocity(e,t){t=Math.min(t,this.duration);const i=1-this.friction;return e*(i**t-1)/Math.log(i)}}},82332:(e,t,i)=>{i.d(t,{s:()=>a});var n=i(16889),r=i(78738),s=i(99742);class a{constructor(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:2.5,t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:.01,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:.95,n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:12;this._minimumInitialVelocity=e,this._stopVelocity=t,this._friction=i,this._maxVelocity=n,this.enabled=!0,this.value=new r.J(.8),this.time=new r.J(.3)}add(e,t){if(this.enabled&&null!=t){if(this.time.hasLastValue()){if(this.time.computeDelta(t)<.01)return;if(this.value.hasFilteredDelta()){const t=this.value.computeDelta(e);this.value.filteredDelta*t<0&&this.value.reset()}}this.time.update(t),this.value.update(e)}}reset(){this.value.reset(),this.time.reset()}evaluateMomentum(){if(!this.enabled||!this.value.hasFilteredDelta()||!this.time.hasFilteredDelta())return null;let e=this.value.filteredDelta/this.time.filteredDelta;return e=(0,n.uZ)(e,-this._maxVelocity,this._maxVelocity),Math.abs(e)<this._minimumInitialVelocity?null:this.createMomentum(e,this._stopVelocity,this._friction)}createMomentum(e,t,i){return new s.X(e,t,i)}}},87022:(e,t,i)=>{i.d(t,{G:()=>l});var n=i(32035),r=i(12400),s=i(78738),a=i(99742);class o extends a.X{constructor(e,t,i,n,r){super(e,t,i),this._sceneVelocity=n,this.direction=r}value(e){return super.valueFromInitialVelocity(this._sceneVelocity,e)}}class l{constructor(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:300,t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:12,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:.84;this._minimumInitialVelocity=e,this._stopVelocity=t,this._friction=i,this.enabled=!0,this._time=new s.J(.6),this._screen=[new s.J(.4),new s.J(.4)],this._scene=[new s.J(.6),new s.J(.6),new s.J(.6)],this._tmpDirection=(0,r.Ue)()}add(e,t,i){if(this.enabled){if(this._time.hasLastValue()&&this._time.computeDelta(i)<.015)return;this._screen[0].update(e[0]),this._screen[1].update(e[1]),this._scene[0].update(t[0]),this._scene[1].update(t[1]),this._scene[2].update(t[2]),this._time.update(i)}}reset(){this._screen[0].reset(),this._screen[1].reset(),this._scene[0].reset(),this._scene[1].reset(),this._scene[2].reset(),this._time.reset()}evaluateMomentum(){if(!this.enabled||!this._screen[0].hasFilteredDelta()||!this._time.hasFilteredDelta())return null;const e=this._screen[0].filteredDelta,t=this._screen[1].filteredDelta,i=null==e||null==t?0:Math.sqrt(e*e+t*t),n=this._time.filteredDelta,r=null==n||null==i?0:i/n;return Math.abs(r)<this._minimumInitialVelocity?null:this.createMomentum(r,this._stopVelocity,this._friction)}createMomentum(e,t,i){var r,s,a;(0,n.s)(this._tmpDirection,null!==(r=this._scene[0].filteredDelta)&&void 0!==r?r:0,null!==(s=this._scene[1].filteredDelta)&&void 0!==s?s:0,null!==(a=this._scene[2].filteredDelta)&&void 0!==a?a:0);const l=(0,n.l)(this._tmpDirection);l>0&&(0,n.j)(this._tmpDirection,this._tmpDirection,1/l);const h=this._time.filteredDelta;return new o(e,t,i,null==h?0:l/h,this._tmpDirection)}}},19475:(e,t,i)=>{i.d(t,{y:()=>r});var n=i(82332);class r extends n.s{constructor(){super(arguments.length>0&&void 0!==arguments[0]?arguments[0]:3,arguments.length>1&&void 0!==arguments[1]?arguments[1]:.01,arguments.length>2&&void 0!==arguments[2]?arguments[2]:.95,arguments.length>3&&void 0!==arguments[3]?arguments[3]:12)}add(e,t){const i=this.value.lastValue;if(null!=i){let t=e-i;for(;t>Math.PI;)t-=2*Math.PI;for(;t<-Math.PI;)t+=2*Math.PI;e=i+t}super.add(e,t)}}},62124:(e,t,i)=>{i.d(t,{D:()=>a});var n=i(99742),r=i(82332);class s extends n.X{constructor(e,t,i){super(e,t,i)}value(e){const t=super.value(e);return Math.exp(t)}valueDelta(e,t){const i=super.value(e),n=super.value(e+t)-i;return Math.exp(n)}}class a extends r.s{constructor(){super(arguments.length>0&&void 0!==arguments[0]?arguments[0]:2.5,arguments.length>1&&void 0!==arguments[1]?arguments[1]:.01,arguments.length>2&&void 0!==arguments[2]?arguments[2]:.95,arguments.length>3&&void 0!==arguments[3]?arguments[3]:12)}add(e,t){super.add(Math.log(e),t)}createMomentum(e,t,i){return new s(e,t,i)}}},4914:(e,t,i)=>{i.d(t,{Cr:()=>w,FN:()=>y,KY:()=>v,Sx:()=>d,Uy:()=>p,Z1:()=>_,_e:()=>g,qj:()=>b,un:()=>f,xI:()=>m});var n,r=i(47898),s=i(68860),a=i(32035),o=i(12400),l=i(5986),h=i(92975),c=i(25003);function d(e){return u(e,n.Horizontal)}function u(e,t){const{hasZ:i,spatialReference:a}=e,o=(0,c.m)(a);let l=0;const h=(0,s.j5)(o);if(null==h)return null;const d=t===n.Direct?y:b;for(const n of e.paths){if(n.length<2)continue;const e=n.length-1;for(let t=0;t<e;++t){const e=n[t];x[0]=e[0],x[1]=e[1],x[2]=i?e[2]:0;const r=n[t+1];T[0]=r[0],T[1]=r[1],T[2]=i?r[2]:0;const s=d(x,T,a);if(null==s)return null;l+=s.value}}return(0,r.yG)(l,h)}function p(e,t){const{spatialReference:i}=e;return(0,h.fS)(i,t.spatialReference)?(x[0]=e.x,x[1]=e.y,x[2]=e.hasZ?e.z:0,T[0]=t.x,T[1]=t.y,T[2]=t.hasZ?t.z:0,function(e,t,i){const n=C(e,t,i);return null!=n?{direct:(0,r.yG)(n.direct,n.unit),horizontal:(0,r.yG)(n.horizontal,n.unit),vertical:(0,r.yG)(n.vertical,n.unit)}:null}(x,T,i)):null}function _(e,t){const{spatialReference:i}=e;return(0,h.fS)(i,t.spatialReference)?(x[0]=e.x,x[1]=e.y,x[2]=e.hasZ?e.z:0,T[0]=t.x,T[1]=t.y,T[2]=t.hasZ?t.z:0,y(x,T,i)):null}function m(e,t){const{spatialReference:i}=e;return(0,h.fS)(i,t.spatialReference)?(x[0]=e.x,x[1]=e.y,x[2]=e.hasZ?e.z:0,T[0]=t.x,T[1]=t.y,T[2]=t.hasZ?t.z:0,b(x,T,i)):null}function g(e,t){const{spatialReference:i}=e;return(0,h.fS)(i,t.spatialReference)?(x[0]=e.x,x[1]=e.y,x[2]=e.hasZ?e.z:0,T[0]=t.x,T[1]=t.y,T[2]=t.hasZ?t.z:0,w(x,T,i)):null}function f(e){return null!=e?v(e.hasZ?e.z:0,e.spatialReference):null}function v(e,t){const i=(0,s.y)(t);return null!=i?(0,r.yG)(null!==e&&void 0!==e?e:0,i):null}function y(e,t,i){const s=C(e,t,i,n.Direct);return null!=s?(0,r.yG)(s.direct,s.unit):null}function b(e,t,i){const s=C(e,t,i,n.Horizontal);return null!=s?(0,r.yG)(s.horizontal,s.unit):null}function w(e,t,i){const s=C(e,t,i,n.Vertical);return null!=s?(0,r.yG)(s.verticalSigned,s.unit):null}function C(e,t,i,r){const o=(0,c.m)(i),h=(0,s.j5)(o);if(null==h)return null;const d=t[2]-e[2];if(r===n.Vertical)return{verticalSigned:d,unit:h};if(!(0,l.S)(e,i,S,o)||!(0,l.S)(t,i,P,o))return null;if(r===n.Direct)return{direct:(0,a.p)(P,S),unit:h};if((0,a.s)(M,e[0],e[1],t[2]),!(0,l.S)(M,i,M,o))return null;const u=(0,a.p)(M,P);return r===n.Horizontal?{horizontal:u,unit:h}:{direct:(0,a.p)(P,S),horizontal:u,vertical:Math.abs(d),unit:h}}!function(e){e[e.Direct=0]="Direct",e[e.Horizontal=1]="Horizontal",e[e.Vertical=2]="Vertical"}(n||(n={}));const x=(0,o.Ue)(),T=(0,o.Ue)(),S=(0,o.Ue)(),P=(0,o.Ue)(),M=(0,o.Ue)()},74923:(e,t,i)=>{async function n(e,t){var i;if("2d"===e.type)return e.hitTest(t);const n=await e.hitTest(t);if(0===n.results.length)return n;const s=n.results[0],a=(null!==(i=s.distance)&&void 0!==i?i:0)*(1+r),o=n.results.findIndex((e=>{var t;return(null!==(t=e.distance)&&void 0!==t?t:0)>a}));return-1!==o&&(n.results=n.results.slice(0,o)),s&&n.ground.distance>a&&(n.ground.mapPoint=null),n}i.d(t,{HV:()=>o,ZV:()=>n,qm:()=>a});const r=.05;function s(e){return"graphic"===(null===e||void 0===e?void 0:e.type)}function a(e){var t;return null!==(t=e.find(s))&&void 0!==t?t:null}function o(e){return e.filter(s)}},25003:(e,t,i)=>{i.d(t,{m:()=>a});var n=i(83448),r=i(29691),s=i(92975);function a(e){return(0,s.N$)(e)?(0,s.oR)(e)||(0,s.sS)(e)||(0,s.yW)(e)||(0,n.fY)(e)?r.wY:e:(0,r.rS)(e)}},21147:(e,t,i)=>{i.d(t,{Z:()=>w});var n=i(27366),r=i(46784),s=i(84652),a=i(32718),o=i(49861),l=(i(93169),i(69912)),h=i(3389),c=i(50902),d=i(23548),u=i(18814),p=i(67808),_=i(2581),m=i(13910);const g={base:_.Z,key:"type",typeMap:{color:m.Z}};const f={types:g,json:{read:function(e){return(t,i,n)=>{if(!t)return t;for(const r in e.typeMap)if(t.type===r){const i=new e.typeMap[r];return i.read(t,n),i}}}(g),write:{overridePolicy:(e,t,i)=>({enabled:!(null!==i&&void 0!==i&&i.isPresentation)})}}};var v;const y=(e,t,i)=>({enabled:!(null!==i&&void 0!==i&&i.isPresentation)});let b=v=class extends r.wq{constructor(e){super(e),this.lighting=new u.Z,this.background=null,this.atmosphereEnabled=!0,this.starsEnabled=!0}set weather(e){(0,c.b8)(null===e||void 0===e?void 0:e.type,a.Z.getLogger(this))&&this._set("weather",e)}clone(){return new v(this.cloneConstructProperties())}cloneConstructProperties(){return{lighting:this.lighting&&"virtual"===this.lighting.type?p.Z.prototype.clone.call(this.lighting):u.Z.prototype.clone.call(this.lighting),background:(0,s.d9)(this.background),atmosphereEnabled:this.atmosphereEnabled,starsEnabled:this.starsEnabled,weather:this.weather.clone()}}};(0,n._)([(0,o.Cb)({types:d.j,nonNullable:!0,json:{write:!0}})],b.prototype,"lighting",void 0),(0,n._)([(0,o.Cb)(f)],b.prototype,"background",void 0),(0,n._)([(0,o.Cb)({type:Boolean,nonNullable:!0,json:{write:{overridePolicy:y}}})],b.prototype,"atmosphereEnabled",void 0),(0,n._)([(0,o.Cb)({type:Boolean,nonNullable:!0,json:{write:{overridePolicy:y}}})],b.prototype,"starsEnabled",void 0),(0,n._)([(0,o.Cb)({types:c.Hr,nonNullable:!0,json:{write:!0},value:new h.Z})],b.prototype,"weather",null),b=v=(0,n._)([(0,l.j)("esri.webscene.Environment")],b);const w=b},18814:(e,t,i)=>{i.d(t,{Z:()=>d});var n,r=i(27366),s=i(46784),a=i(49861),o=(i(93169),i(32718),i(84936),i(38511)),l=i(69912),h=i(31201);let c=n=class extends s.wq{constructor(e){super(e),this.type="sun",this.date=null,this.directShadowsEnabled=!1,this.displayUTCOffset=null}readDate(e,t){return null!=t.datetime&&new Date(t.datetime)||null}writeDate(e,t,i){t[i]=e.getTime()}readDirectShadowsEnabled(e,t){return!!t.directShadows}writedirectShadowsEnabled(e,t,i){e&&(t[i]=e)}writeDisplayUTCOffset(e,t){null!=e&&(t.displayUTCOffset=e)}clone(){return new n(this.cloneConstructProperties())}cloneConstructProperties(){const e={directShadowsEnabled:this.directShadowsEnabled,displayUTCOffset:null!=this.displayUTCOffset?this.displayUTCOffset:null};return null!=this.date&&(e.date=new Date(this.date.getTime())),e}};(0,r._)([(0,a.Cb)({readOnly:!0,type:["sun"],json:{write:!0}})],c.prototype,"type",void 0),(0,r._)([(0,a.Cb)({type:Date,json:{type:Number,write:{target:"datetime"}}})],c.prototype,"date",void 0),(0,r._)([(0,o.r)("date",["datetime"])],c.prototype,"readDate",null),(0,r._)([(0,h.c)("date")],c.prototype,"writeDate",null),(0,r._)([(0,a.Cb)({type:Boolean,json:{default:!1,write:{target:"directShadows"}}})],c.prototype,"directShadowsEnabled",void 0),(0,r._)([(0,o.r)("directShadowsEnabled",["directShadows"])],c.prototype,"readDirectShadowsEnabled",null),(0,r._)([(0,h.c)("directShadowsEnabled")],c.prototype,"writedirectShadowsEnabled",null),(0,r._)([(0,a.Cb)({type:Number,json:{write:!0}})],c.prototype,"displayUTCOffset",void 0),(0,r._)([(0,h.c)("displayUTCOffset")],c.prototype,"writeDisplayUTCOffset",null),c=n=(0,r._)([(0,l.j)("esri.webscene.SunLighting")],c);const d=c},67808:(e,t,i)=>{i.d(t,{Z:()=>h});var n,r=i(27366),s=i(46784),a=i(49861),o=(i(93169),i(32718),i(84936),i(69912));let l=n=class extends s.wq{constructor(e){super(e),this.type="virtual",this.directShadowsEnabled=!1}clone(){return new n(this.cloneConstructProperties())}cloneConstructProperties(){return{directShadowsEnabled:this.directShadowsEnabled}}};(0,r._)([(0,a.Cb)({readOnly:!0,type:["virtual"],json:{write:!0}})],l.prototype,"type",void 0),(0,r._)([(0,a.Cb)({type:Boolean,json:{default:!1,name:"directShadows",write:!0}})],l.prototype,"directShadowsEnabled",void 0),l=n=(0,r._)([(0,o.j)("esri.webscene.VirtualLighting")],l);const h=l},2581:(e,t,i)=>{i.d(t,{Z:()=>l});var n=i(27366),r=i(46784),s=i(49861),a=(i(93169),i(32718),i(84936),i(69912));let o=class extends r.wq{constructor(e){super(e)}clone(){throw new Error("Subclasses of Background should implement their own clone method.")}};(0,n._)([(0,s.Cb)({readOnly:!0,json:{read:!1}})],o.prototype,"type",void 0),o=(0,n._)([(0,a.j)("esri.webscene.background.Background")],o);const l=o},13910:(e,t,i)=>{i.d(t,{Z:()=>p});var n,r=i(27366),s=i(51995),a=i(49861),o=(i(93169),i(32718),i(84936),i(27135)),l=i(69912),h=i(70271),c=i(2581);const d={...h.a,nonNullable:!0};let u=n=class extends c.Z{constructor(e){super(e),this.type="color",this.color=new s.Z([0,0,0,1])}clone(){return new n(this.cloneProperties())}cloneProperties(){return{color:this.color.clone()}}};(0,r._)([(0,o.J)({color:"color"},{readOnly:!0})],u.prototype,"type",void 0),(0,r._)([(0,a.Cb)(d)],u.prototype,"color",void 0),u=n=(0,r._)([(0,l.j)("esri.webscene.background.ColorBackground")],u);const p=u},23548:(e,t,i)=>{i.d(t,{j:()=>s});var n=i(18814),r=i(67808);const s={key:"type",defaultKeyValue:"sun",base:null,typeMap:{sun:n.Z,virtual:r.Z}}}}]);
//# sourceMappingURL=2434.b7f4631e.chunk.js.map