"use strict";(self.webpackChunknorthwind=self.webpackChunknorthwind||[]).push([[86834,54537],{3182:(e,t,r)=>{r.d(t,{S6:()=>o,u_:()=>s});var n=r(80457);class s{constructor(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null,t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},r=arguments.length>2?arguments[2]:void 0,n=arguments.length>3?arguments[3]:void 0;this.geometry=e,this.attributes=t,this.centroid=r,this.objectId=n,this.displayId=0,this.geohashX=0,this.geohashY=0}static fromJSON(e,t){const r=e.geometry?n.Z.fromJSON(e.geometry):null,o=e.centroid?n.Z.fromJSON(e.centroid):null,i=e.attributes[t];return new s(r,e.attributes,o,i)}weakClone(){const e=new s(this.geometry,this.attributes,this.centroid,this.objectId);return e.displayId=this.displayId,e.geohashX=this.geohashX,e.geohashY=this.geohashY,e}clone(){var e,t;const r=null===(e=this.geometry)||void 0===e?void 0:e.clone(),n=new s(r,{...this.attributes},null===(t=this.centroid)||void 0===t?void 0:t.clone(),this.objectId);return n.displayId=this.displayId,n.geohashX=this.geohashX,n.geohashY=this.geohashY,n}}function o(e){var t;return!(null===(t=e.geometry)||void 0===t||null===(t=t.coords)||void 0===t||!t.length)}},6908:(e,t,r)=>{r.d(t,{Z:()=>n});class n{constructor(){this.objectIdFieldName=null,this.globalIdFieldName=null,this.geohashFieldName=null,this.geometryProperties=null,this.geometryType=null,this.spatialReference=null,this.hasZ=!1,this.hasM=!1,this.features=[],this.fields=[],this.transform=null,this.exceededTransferLimit=!1,this.uniqueIdField=null,this.queryGeometryType=null,this.queryGeometry=null}weakClone(){const e=new n;return e.objectIdFieldName=this.objectIdFieldName,e.globalIdFieldName=this.globalIdFieldName,e.geohashFieldName=this.geohashFieldName,e.geometryProperties=this.geometryProperties,e.geometryType=this.geometryType,e.spatialReference=this.spatialReference,e.hasZ=this.hasZ,e.hasM=this.hasM,e.features=this.features,e.fields=this.fields,e.transform=this.transform,e.exceededTransferLimit=this.exceededTransferLimit,e.uniqueIdField=this.uniqueIdField,e.queryGeometry=this.queryGeometry,e.queryGeometryType=this.queryGeometryType,e}}},80457:(e,t,r)=>{r.d(t,{Z:()=>n});class n{constructor(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[],t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[],r=arguments.length>2&&void 0!==arguments[2]&&arguments[2];this.lengths=null!==e&&void 0!==e?e:[],this.coords=null!==t&&void 0!==t?t:[],this.hasIndeterminateRingOrder=r}static fromJSON(e){return new n(e.lengths,e.coords,e.hasIndeterminateRingOrder)}static fromRect(e){const[t,r,s,o]=e,i=s-t,a=o-r;return new n([5],[t,r,i,0,0,a,-i,0,0,-a])}get isPoint(){return 0===this.lengths.length}get maxLength(){return Math.max(...this.lengths)}get size(){return this.lengths.reduce(((e,t)=>e+t))}forEachVertex(e){let t=0;this.lengths.length||e(this.coords[0],this.coords[1]);for(let r=0;r<this.lengths.length;r++){const n=this.lengths[r];for(let r=0;r<n;r++)e(this.coords[2*(r+t)],this.coords[2*(r+t)+1]);t+=n}}deltaDecode(){const e=this.clone(),{coords:t,lengths:r}=e;let n=0;for(const s of r){for(let e=1;e<s;e++)t[2*(n+e)]+=t[2*(n+e)-2],t[2*(n+e)+1]+=t[2*(n+e)-1];n+=s}return e}clone(e){if(0===this.lengths.length)return new n([],[this.coords[0],this.coords[1]]);const t=2*(0===this.lengths.length?1:this.lengths.reduce(((e,t)=>e+t))),r=this.coords.slice(0,t);return e?(e.set(r),new n(this.lengths,e,this.hasIndeterminateRingOrder)):new n(Array.from(this.lengths),Array.from(r),this.hasIndeterminateRingOrder)}}},97463:(e,t,r)=>{r.r(t),r.d(t,{createConnection:()=>R});var n=r(27366),s=(r(59486),r(76200)),o=r(10064),i=r(32718),a=r(66978),c=r(35995),l=(r(93169),r(84936),r(69912)),u=r(49861),d=r(93501),h=r(91505);let g=class extends h.Z.EventedAccessor{destroy(){this.emit("destroy")}get connectionError(){return this.errorString?new o.Z("stream-connection",this.errorString):null}onFeature(e){this.emit("data-received",e)}onMessage(e){this.emit("message-received",e)}};(0,n._)([(0,u.Cb)({readOnly:!0})],g.prototype,"connectionError",null),g=(0,n._)([(0,l.j)("esri.layers.support.StreamConnection")],g);const f=g;var y,m;(m=y||(y={}))[m.CONNECTING=0]="CONNECTING",m[m.OPEN=1]="OPEN",m[m.CLOSING=2]="CLOSING",m[m.CLOSED=3]="CLOSED";let p=class extends f{constructor(e){super({}),this._outstandingMessages=[],this.errorString=null;const{geometryType:t,spatialReference:r,sourceSpatialReference:n}=e;this._config=e,this._featureZScaler=(0,d.k)(t,n,r),this._open()}normalizeCtorArgs(){return{}}async _open(){await this._tryCreateWebSocket(),this.destroyed||await this._handshake()}destroy(){super.destroy(),null!=this._websocket&&(this._websocket.onopen=null,this._websocket.onclose=null,this._websocket.onerror=null,this._websocket.onmessage=null,this._websocket.close()),this._websocket=null}get connectionStatus(){if(null==this._websocket)return"disconnected";switch(this._websocket.readyState){case y.CONNECTING:case y.OPEN:return"connected";case y.CLOSING:case y.CLOSED:return"disconnected"}}sendMessageToSocket(e){null!=this._websocket?this._websocket.send(JSON.stringify(e)):this._outstandingMessages.push(e)}sendMessageToClient(e){this._onMessage(e)}updateCustomParameters(e){this._config.customParameters=e,null!=this._websocket&&this._websocket.close()}async _tryCreateWebSocket(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:this._config.source.path,t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1e3,r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;try{var n;if(this.destroyed)return;const t=(0,c.fl)(e,null!==(n=this._config.customParameters)&&void 0!==n?n:{});this._websocket=await this._createWebSocket(t),this.notifyChange("connectionStatus")}catch(g){const s=t/1e3;return this._config.maxReconnectionAttempts&&r>=this._config.maxReconnectionAttempts?(i.Z.getLogger(this).error(new o.Z("websocket-connection","Exceeded maxReconnectionAttempts attempts. No further attempts will be made")),void this.destroy()):(i.Z.getLogger(this).error(new o.Z("websocket-connection","Failed to connect. Attempting to reconnect in ".concat(s,"s"),g)),await(0,a.e4)(t),this._tryCreateWebSocket(e,Math.min(1.5*t,1e3*this._config.maxReconnectionInterval),r+1))}}_setWebSocketJSONParseHandler(e){e.onmessage=e=>{try{const t=JSON.parse(e.data);this._onMessage(t)}catch(t){return void i.Z.getLogger(this).error(new o.Z("websocket-connection","Failed to parse message, invalid JSON",{error:t}))}}}_createWebSocket(e){return new Promise(((t,r)=>{const n=new WebSocket(e);n.onopen=()=>{if(n.onopen=null,this.destroyed)return n.onclose=null,void n.close();n.onclose=e=>this._onClose(e),n.onerror=e=>this._onError(e),this._setWebSocketJSONParseHandler(n),t(n)},n.onclose=e=>{n.onopen=n.onclose=null,r(e)}}))}async _handshake(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:1e4;const t=this._websocket;if(null==t)return;const r=(0,a.hh)(),n=t.onmessage,{filter:s,outFields:c,spatialReference:l}=this._config;return r.timeout(e),t.onmessage=e=>{var a;let u=null;try{u=JSON.parse(e.data)}catch(y){}u&&"object"==typeof u||(i.Z.getLogger(this).error(new o.Z("websocket-connection","Protocol violation. Handshake failed - malformed message",e.data)),r.reject(),this.destroy()),(null===(a=u.spatialReference)||void 0===a?void 0:a.wkid)!==(null===l||void 0===l?void 0:l.wkid)&&(i.Z.getLogger(this).error(new o.Z("websocket-connection","Protocol violation. Handshake failed - expected wkid of ".concat(l.wkid),e.data)),r.reject(),this.destroy()),"json"!==u.format&&(i.Z.getLogger(this).error(new o.Z("websocket-connection","Protocol violation. Handshake failed - format is not set",e.data)),r.reject(),this.destroy()),s&&u.filter!==s&&i.Z.getLogger(this).error(new o.Z("websocket-connection","Tried to set filter, but server doesn't support it")),c&&u.outFields!==c&&i.Z.getLogger(this).error(new o.Z("websocket-connection","Tried to set outFields, but server doesn't support it")),t.onmessage=n;for(const r of this._outstandingMessages)t.send(JSON.stringify(r));this._outstandingMessages=[],r.resolve()},t.send(JSON.stringify({filter:s,outFields:c,format:"json",spatialReference:{wkid:l.wkid}})),r.promise}_onMessage(e){if(this.onMessage(e),"type"in e)switch(e.type){case"features":case"featureResult":for(const t of e.features)null!=this._featureZScaler&&this._featureZScaler(t.geometry),this.onFeature(t)}}_onError(e){const t="Encountered an error over WebSocket connection";this._set("errorString",t),i.Z.getLogger(this).error("websocket-connection",t)}_onClose(e){this._websocket=null,this.notifyChange("connectionStatus"),1e3!==e.code&&i.Z.getLogger(this).error("websocket-connection","WebSocket closed unexpectedly with error code ".concat(e.code)),this.destroyed||this._open()}};(0,n._)([(0,u.Cb)()],p.prototype,"connectionStatus",null),(0,n._)([(0,u.Cb)()],p.prototype,"errorString",void 0),p=(0,n._)([(0,l.j)("esri.layers.graphics.sources.connections.WebSocketConnection")],p);var w=r(5192),_=r(21149),S=r(77981),v=r(78952);const b={maxQueryDepth:5,maxRecordCountFactor:3};let k=class extends p{constructor(e){super({...b,...e}),this._buddyServicesQuery=null,this._relatedFeatures=null}async _open(){const e=await this._fetchServiceDefinition(this._config.source);e.timeInfo.trackIdField||i.Z.getLogger(this).warn("GeoEvent service was configured without a TrackIdField. This may result in certain functionality being disabled. The purgeOptions.maxObservations property will have no effect.");const t=this._fetchWebSocketUrl(e.streamUrls,this._config.spatialReference);this._buddyServicesQuery||(this._buddyServicesQuery=this._queryBuddyServices()),await this._buddyServicesQuery,await this._tryCreateWebSocket(t);const{filter:r,outFields:n}=this._config;this.destroyed||this._setFilter(r,n)}_onMessage(e){if("attributes"in e){let r;try{r=this._enrich(e),null!=this._featureZScaler&&this._featureZScaler(r.geometry)}catch(t){return void i.Z.getLogger(this).error(new o.Z("geoevent-connection","Failed to parse message",t))}this.onFeature(r)}else this.onMessage(e)}async _fetchServiceDefinition(e){const t={f:"json",...this._config.customParameters},r=(0,s.Z)(e.path,{query:t,responseType:"json"}),n=(await r).data;return this._serviceDefinition=n,n}_fetchWebSocketUrl(e,t){const r=e[0],{urls:n,token:s}=r,o=this._inferWebSocketBaseUrl(n);return(0,c.fl)("".concat(o,"/subscribe"),{outSR:""+t.wkid,token:s})}_inferWebSocketBaseUrl(e){if(1===e.length)return e[0];for(const t of e)if(t.includes("wss"))return t;return i.Z.getLogger(this).error(new o.Z("geoevent-connection","Unable to infer WebSocket url",e)),null}async _setFilter(e,t){const r=this._websocket;if(null==r||null==e&&null==t)return;const n=JSON.stringify({filter:this._serializeFilter(e,t)});let s=!1;const c=(0,a.hh)();return r.onmessage=e=>{const t=JSON.parse(e.data);t.filter&&(t.error&&(i.Z.getLogger(this).error(new o.Z("geoevent-connection","Failed to set service filter",t.error)),this._set("errorString","Could not set service filter - ".concat(t.error)),c.reject(t.error)),this._setWebSocketJSONParseHandler(r),s=!0,c.resolve())},r.send(n),setTimeout((()=>{s||(this.destroyed||this._websocket!==r||i.Z.getLogger(this).error(new o.Z("geoevent-connection","Server timed out when setting filter")),c.reject())}),1e4),c.promise}_serializeFilter(e,t){const r={};if(null==e&&null==t)return r;if(null!==e&&void 0!==e&&e.geometry)try{const t=(0,S.im)(e.geometry);if("extent"!==t.type)throw new o.Z("Expected extent but found type ".concat(t.type));r.geometry=JSON.stringify(t.shiftCentralMeridian())}catch(n){i.Z.getLogger(this).error(new o.Z("geoevent-connection","Encountered an error when setting connection geometryDefinition",n))}return null!==e&&void 0!==e&&e.where&&"1 = 1"!==e.where&&"1=1"!==e.where&&(r.where=e.where),null!=t&&(r.outFields=t.join(",")),r}_enrich(e){if(!this._relatedFeatures)return e;const t=this._serviceDefinition.relatedFeatures.joinField,r=e.attributes[t],n=this._relatedFeatures.get(r);if(!n)return i.Z.getLogger(this).warn("geoevent-connection","Feature join failed. Is the join field configured correctly?",e),e;const{attributes:s,geometry:a}=n;for(const o in s)e.attributes[o]=s[o];return a&&(e.geometry=a),e.geometry||e.centroid||i.Z.getLogger(this).error(new o.Z("geoevent-connection","Found malformed feature - no geometry found",e)),e}async _queryBuddyServices(){try{const{relatedFeatures:e,keepLatestArchive:t}=this._serviceDefinition,r=this._queryRelatedFeatures(e),n=this._queryArchive(t);await r;const s=await n;if(!s)return;for(const o of s.features)this.onFeature(this._enrich(o))}catch(m){i.Z.getLogger(this).error(new o.Z("geoevent-connection","Encountered an error when querying buddy services",{error:m}))}}async _queryRelatedFeatures(e){if(!e)return;const t=await this._queryBuddy(e.featuresUrl);this._addRelatedFeatures(t)}async _queryArchive(e){if(e)return this._queryBuddy(e.featuresUrl)}async _queryBuddy(e){var t,n,s;const o=new((await Promise.resolve().then(r.bind(r,64326))).default)({url:e}),{capabilities:i}=await o.load(),a=i.query.supportsMaxRecordCountFactor,c=i.query.supportsPagination,l=i.query.supportsCentroid,u=this._config.maxRecordCountFactor,d=o.capabilities.query.maxRecordCount,h=a?d*u:d,g=new _.Z;if(g.outFields=null!==(t=this._config.outFields)&&void 0!==t?t:["*"],g.where=null!==(n=null===(s=this._config.filter)||void 0===s?void 0:s.where)&&void 0!==n?n:"1=1",g.returnGeometry=!0,g.returnExceededLimitFeatures=!0,g.outSpatialReference=v.Z.fromJSON(this._config.spatialReference),l&&(g.returnCentroid=!0),a&&(g.maxRecordCountFactor=u),c)return g.num=h,o.destroy(),this._queryPages(e,g);const f=await(0,w.JT)(e,g,this._config.sourceSpatialReference);return o.destroy(),f.data}async _queryPages(e,t){var r;let n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:[],s=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0;t.start=null!=t.num?s*t.num:null;const{data:o}=await(0,w.JT)(e,t,this._config.sourceSpatialReference);return o.exceededTransferLimit&&s<(null!==(r=this._config.maxQueryDepth)&&void 0!==r?r:0)?(o.features.forEach((e=>n.push(e))),this._queryPages(e,t,n,s+1)):(n.forEach((e=>o.features.push(e))),o)}_addRelatedFeatures(e){const t=new Map,r=e.features,n=this._serviceDefinition.relatedFeatures.joinField;for(const s of r){const e=s.attributes[n];t.set(e,s)}this._relatedFeatures=t}};k=(0,n._)([(0,l.j)("esri.layers.graphics.sources.connections.GeoEventConnection")],k);const F=k;let x=class extends f{constructor(e){super({}),this.connectionStatus="connected",this.errorString=null;const{geometryType:t,spatialReference:r,sourceSpatialReference:n}=e;this._featureZScaler=(0,d.k)(t,n,r)}normalizeCtorArgs(){return{}}updateCustomParameters(e){}sendMessageToSocket(e){}sendMessageToClient(e){if("type"in e)switch(e.type){case"features":case"featureResult":for(const t of e.features)null!=this._featureZScaler&&this._featureZScaler(t.geometry),this.onFeature(t)}this.onMessage(e)}};function O(e,t){if(null==e&&null==t)return null;const r={};return null!=t&&(r.geometry=t),null!=e&&(r.where=e),r}function R(e,t,r,n,s,o,i,a,c){const l={source:e,sourceSpatialReference:t,spatialReference:r,geometryType:n,filter:O(s,o),maxReconnectionAttempts:i,maxReconnectionInterval:a,customParameters:c};return e?e.path.startsWith("wss://")||e.path.startsWith("ws://")?new p(l):new F(l):new x(l)}(0,n._)([(0,u.Cb)()],x.prototype,"connectionStatus",void 0),(0,n._)([(0,u.Cb)()],x.prototype,"errorString",void 0),x=(0,n._)([(0,l.j)("esri.layers.support.ClientSideConnection")],x)},22585:(e,t,r)=>{function n(e){const t={};for(const r in e){if("declaredClass"===r)continue;const s=e[r];if(null!=s&&"function"!=typeof s)if(Array.isArray(s)){t[r]=[];for(let e=0;e<s.length;e++)t[r][e]=n(s[e])}else"object"==typeof s?s.toJSON&&(t[r]=JSON.stringify(s)):t[r]=s}return t}r.d(t,{A:()=>n})},5192:(e,t,r)=>{r.d(t,{Ev:()=>m,JT:()=>g,Vn:()=>_,Vr:()=>w,hH:()=>p,n7:()=>y,qp:()=>f});var n=r(76200),s=r(35995),o=r(77981),i=r(91340),a=r(92975),c=r(22585),l=r(27607),u=r(68620);const d="Layer does not support extent calculation.";function h(e,t){var r;const n=e.geometry,s=e.toJSON();delete s.compactGeometryEnabled,delete s.defaultSpatialReferenceEnabled;const i=s;let c,l,u;if(null!=n&&(l=n.spatialReference,u=(0,a.B9)(l),i.geometryType=(0,o.Ji)(n),i.geometry=function(e,t){if(t&&"extent"===e.type)return"".concat(e.xmin,",").concat(e.ymin,",").concat(e.xmax,",").concat(e.ymax);if(t&&"point"===e.type)return"".concat(e.x,",").concat(e.y);const r=e.toJSON();return delete r.spatialReference,JSON.stringify(r)}(n,e.compactGeometryEnabled),i.inSR=u),s.groupByFieldsForStatistics&&(i.groupByFieldsForStatistics=s.groupByFieldsForStatistics.join(",")),s.objectIds&&(i.objectIds=s.objectIds.join(",")),s.orderByFields&&(i.orderByFields=s.orderByFields.join(",")),!s.outFields||!s.returnDistinctValues&&(null!==t&&void 0!==t&&t.returnCountOnly||null!==t&&void 0!==t&&t.returnExtentOnly||null!==t&&void 0!==t&&t.returnIdsOnly)?delete i.outFields:s.outFields.includes("*")?i.outFields="*":i.outFields=s.outFields.join(","),s.outSR?(i.outSR=(0,a.B9)(s.outSR),c=e.outSpatialReference):n&&(s.returnGeometry||s.returnCentroid)&&(i.outSR=i.inSR,c=l),s.returnGeometry&&delete s.returnGeometry,s.outStatistics&&(i.outStatistics=JSON.stringify(s.outStatistics)),s.fullText&&(i.fullText=JSON.stringify(s.fullText)),s.pixelSize&&(i.pixelSize=JSON.stringify(s.pixelSize)),s.quantizationParameters&&(e.defaultSpatialReferenceEnabled&&null!=l&&null!=(null===(r=e.quantizationParameters)||void 0===r?void 0:r.extent)&&l.equals(e.quantizationParameters.extent.spatialReference)&&delete s.quantizationParameters.extent.spatialReference,i.quantizationParameters=JSON.stringify(s.quantizationParameters)),s.parameterValues&&(i.parameterValues=JSON.stringify(s.parameterValues)),s.rangeValues&&(i.rangeValues=JSON.stringify(s.rangeValues)),s.dynamicDataSource&&(i.layer=JSON.stringify({source:s.dynamicDataSource}),delete s.dynamicDataSource),s.timeExtent){const e=s.timeExtent,{start:t,end:r}=e;null==t&&null==r||(i.time=t===r?t:"".concat(null!==t&&void 0!==t?t:"null",",").concat(null!==r&&void 0!==r?r:"null")),delete s.timeExtent}return e.defaultSpatialReferenceEnabled&&null!=l&&null!=c&&l.equals(c)&&(i.defaultSR=i.inSR,delete i.inSR,delete i.outSR),i}async function g(e,t,r,n){const s=null!=t.timeExtent&&t.timeExtent.isEmpty?{data:{features:[]}}:await _(e,t,"json",n);return(0,u.p)(t,r,s.data),s}async function f(e,t,r,n){if(null!=t.timeExtent&&t.timeExtent.isEmpty)return{data:r.createFeatureResult()};const s=await y(e,t,n),o=s;return o.data=(0,l.C)(s.data,r),o}function y(e,t,r){return _(e,t,"pbf",r)}function m(e,t,r){return null!=t.timeExtent&&t.timeExtent.isEmpty?Promise.resolve({data:{objectIds:[]}}):_(e,t,"json",r,{returnIdsOnly:!0})}function p(e,t,r){return null!=t.timeExtent&&t.timeExtent.isEmpty?Promise.resolve({data:{count:0}}):_(e,t,"json",r,{returnIdsOnly:!0,returnCountOnly:!0})}async function w(e,t,r){if(null!=t.timeExtent&&t.timeExtent.isEmpty)return{data:{count:0,extent:null}};const n=await _(e,t,"json",r,{returnExtentOnly:!0,returnCountOnly:!0}),s=n.data;if(s.hasOwnProperty("extent"))return n;if(s.features)throw new Error(d);if(s.hasOwnProperty("count"))throw new Error(d);return n}async function _(e,t,r){let o=arguments.length>3&&void 0!==arguments[3]?arguments[3]:{},a=arguments.length>4&&void 0!==arguments[4]?arguments[4]:{};const l="string"==typeof e?(0,s.mN)(e):e,u=t.geometry?[t.geometry]:[],d=await(0,i.aX)(u,null,{signal:o.signal}),g=null===d||void 0===d?void 0:d[0];null!=g&&((t=t.clone()).geometry=g);const f=(0,c.A)({...l.query,f:r,...a,...h(t,a)});return(0,n.Z)((0,s.v_)(l.path,(y=a,null==t.formatOf3DObjects||y.returnCountOnly||y.returnExtentOnly||y.returnIdsOnly?"query":"query3d")),{...o,responseType:"pbf"===r?"array-buffer":"json",query:{...f,...o.query}});var y}}}]);
//# sourceMappingURL=86834.a7a3fdca.chunk.js.map